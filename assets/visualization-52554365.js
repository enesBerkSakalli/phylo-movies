var Dy=Object.defineProperty;var By=(n,e,t)=>e in n?Dy(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var m=(n,e,t)=>(By(n,typeof e!="symbol"?e+"":e,t),t);import{e as oc,g as Ly,m as tr,b as Le,_ as k,n as W,x as X,c as Mt,o as ai,i as me,t as Ve,E as ne,d as Ke,r as ns,f as zr,u as np,a as is,h as ip,B as Uy,s as $y,j as zy,k as rp,q as tt,v as Vy,w as Wy,y as Vi,z as sp,A as op,C as Hy,D as pr,V as jy,F as Xy,G as Yy,H as qy,I as Ky,J as Zy,K as Gy,P as Qy,p as rs}from"./dataService-18a31086.js";/**
 * @license
 * Copyright 2017 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */let Jy;function eb(n){return(e,t)=>oc(e,t,{get(){return(this.renderRoot??Jy??(Jy=document.createDocumentFragment())).querySelectorAll(n)}})}/**
 * @license
 * Copyright 2017 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */function ap(n){return(e,t)=>oc(e,t,{async get(){var i;return await this.updateComplete,((i=this.renderRoot)==null?void 0:i.querySelector(n))??null}})}/**
 * @license
 * Copyright 2017 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */function tb(n){return(e,t)=>{const{slot:i}=n??{},r="slot"+(i?`[name=${i}]`:":not([name])");return oc(e,t,{get(){var o;const s=(o=this.renderRoot)==null?void 0:o.querySelector(r);return(s==null?void 0:s.assignedNodes(n))??[]}})}}/**
 * @license
 * Copyright 2022 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */const nb=!1;const Tu=n=>{let e;const t=new Set,i=(c,u)=>{const d=typeof c=="function"?c(e):c;if(!Object.is(d,e)){const h=e;e=u??(typeof d!="object"||d===null)?d:Object.assign({},e,d),t.forEach(f=>f(e,h))}},r=()=>e,a={setState:i,getState:r,getInitialState:()=>l,subscribe:c=>(t.add(c),()=>t.delete(c))},l=e=n(i,r,a);return a},ib=n=>n?Tu(n):Tu;var lp={exports:{}},q={};/**
 * @license React
 * react.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var ac=Symbol.for("react.transitional.element"),rb=Symbol.for("react.portal"),sb=Symbol.for("react.fragment"),ob=Symbol.for("react.strict_mode"),ab=Symbol.for("react.profiler"),lb=Symbol.for("react.consumer"),cb=Symbol.for("react.context"),ub=Symbol.for("react.forward_ref"),db=Symbol.for("react.suspense"),hb=Symbol.for("react.memo"),cp=Symbol.for("react.lazy"),Su=Symbol.iterator;function fb(n){return n===null||typeof n!="object"?null:(n=Su&&n[Su]||n["@@iterator"],typeof n=="function"?n:null)}var up={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},dp=Object.assign,hp={};function li(n,e,t){this.props=n,this.context=e,this.refs=hp,this.updater=t||up}li.prototype.isReactComponent={};li.prototype.setState=function(n,e){if(typeof n!="object"&&typeof n!="function"&&n!=null)throw Error("takes an object of state variables to update or a function which returns an object of state variables.");this.updater.enqueueSetState(this,n,e,"setState")};li.prototype.forceUpdate=function(n){this.updater.enqueueForceUpdate(this,n,"forceUpdate")};function fp(){}fp.prototype=li.prototype;function lc(n,e,t){this.props=n,this.context=e,this.refs=hp,this.updater=t||up}var cc=lc.prototype=new fp;cc.constructor=lc;dp(cc,li.prototype);cc.isPureReactComponent=!0;var Eu=Array.isArray,ce={H:null,A:null,T:null,S:null,V:null},pp=Object.prototype.hasOwnProperty;function uc(n,e,t,i,r,s){return t=s.ref,{$$typeof:ac,type:n,key:e,ref:t!==void 0?t:null,props:s}}function pb(n,e){return uc(n.type,e,void 0,void 0,void 0,n.props)}function dc(n){return typeof n=="object"&&n!==null&&n.$$typeof===ac}function gb(n){var e={"=":"=0",":":"=2"};return"$"+n.replace(/[=:]/g,function(t){return e[t]})}var Au=/\/+/g;function Oo(n,e){return typeof n=="object"&&n!==null&&n.key!=null?gb(""+n.key):e.toString(36)}function Cu(){}function mb(n){switch(n.status){case"fulfilled":return n.value;case"rejected":throw n.reason;default:switch(typeof n.status=="string"?n.then(Cu,Cu):(n.status="pending",n.then(function(e){n.status==="pending"&&(n.status="fulfilled",n.value=e)},function(e){n.status==="pending"&&(n.status="rejected",n.reason=e)})),n.status){case"fulfilled":return n.value;case"rejected":throw n.reason}}throw n}function Fn(n,e,t,i,r){var s=typeof n;(s==="undefined"||s==="boolean")&&(n=null);var o=!1;if(n===null)o=!0;else switch(s){case"bigint":case"string":case"number":o=!0;break;case"object":switch(n.$$typeof){case ac:case rb:o=!0;break;case cp:return o=n._init,Fn(o(n._payload),e,t,i,r)}}if(o)return r=r(n),o=i===""?"."+Oo(n,0):i,Eu(r)?(t="",o!=null&&(t=o.replace(Au,"$&/")+"/"),Fn(r,e,t,"",function(c){return c})):r!=null&&(dc(r)&&(r=pb(r,t+(r.key==null||n&&n.key===r.key?"":(""+r.key).replace(Au,"$&/")+"/")+o)),e.push(r)),1;o=0;var a=i===""?".":i+":";if(Eu(n))for(var l=0;l<n.length;l++)i=n[l],s=a+Oo(i,l),o+=Fn(i,e,t,s,r);else if(l=fb(n),typeof l=="function")for(n=l.call(n),l=0;!(i=n.next()).done;)i=i.value,s=a+Oo(i,l++),o+=Fn(i,e,t,s,r);else if(s==="object"){if(typeof n.then=="function")return Fn(mb(n),e,t,i,r);throw e=String(n),Error("Objects are not valid as a React child (found: "+(e==="[object Object]"?"object with keys {"+Object.keys(n).join(", ")+"}":e)+"). If you meant to render a collection of children, use an array instead.")}return o}function gr(n,e,t){if(n==null)return n;var i=[],r=0;return Fn(n,i,"","",function(s){return e.call(t,s,r++)}),i}function _b(n){if(n._status===-1){var e=n._result;e=e(),e.then(function(t){(n._status===0||n._status===-1)&&(n._status=1,n._result=t)},function(t){(n._status===0||n._status===-1)&&(n._status=2,n._result=t)}),n._status===-1&&(n._status=0,n._result=e)}if(n._status===1)return n._result.default;throw n._result}var Iu=typeof reportError=="function"?reportError:function(n){if(typeof window=="object"&&typeof window.ErrorEvent=="function"){var e=new window.ErrorEvent("error",{bubbles:!0,cancelable:!0,message:typeof n=="object"&&n!==null&&typeof n.message=="string"?String(n.message):String(n),error:n});if(!window.dispatchEvent(e))return}else if(typeof process=="object"&&typeof process.emit=="function"){process.emit("uncaughtException",n);return}console.error(n)};function yb(){}q.Children={map:gr,forEach:function(n,e,t){gr(n,function(){e.apply(this,arguments)},t)},count:function(n){var e=0;return gr(n,function(){e++}),e},toArray:function(n){return gr(n,function(e){return e})||[]},only:function(n){if(!dc(n))throw Error("React.Children.only expected to receive a single React element child.");return n}};q.Component=li;q.Fragment=sb;q.Profiler=ab;q.PureComponent=lc;q.StrictMode=ob;q.Suspense=db;q.__CLIENT_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE=ce;q.__COMPILER_RUNTIME={__proto__:null,c:function(n){return ce.H.useMemoCache(n)}};q.cache=function(n){return function(){return n.apply(null,arguments)}};q.cloneElement=function(n,e,t){if(n==null)throw Error("The argument must be a React element, but you passed "+n+".");var i=dp({},n.props),r=n.key,s=void 0;if(e!=null)for(o in e.ref!==void 0&&(s=void 0),e.key!==void 0&&(r=""+e.key),e)!pp.call(e,o)||o==="key"||o==="__self"||o==="__source"||o==="ref"&&e.ref===void 0||(i[o]=e[o]);var o=arguments.length-2;if(o===1)i.children=t;else if(1<o){for(var a=Array(o),l=0;l<o;l++)a[l]=arguments[l+2];i.children=a}return uc(n.type,r,void 0,void 0,s,i)};q.createContext=function(n){return n={$$typeof:cb,_currentValue:n,_currentValue2:n,_threadCount:0,Provider:null,Consumer:null},n.Provider=n,n.Consumer={$$typeof:lb,_context:n},n};q.createElement=function(n,e,t){var i,r={},s=null;if(e!=null)for(i in e.key!==void 0&&(s=""+e.key),e)pp.call(e,i)&&i!=="key"&&i!=="__self"&&i!=="__source"&&(r[i]=e[i]);var o=arguments.length-2;if(o===1)r.children=t;else if(1<o){for(var a=Array(o),l=0;l<o;l++)a[l]=arguments[l+2];r.children=a}if(n&&n.defaultProps)for(i in o=n.defaultProps,o)r[i]===void 0&&(r[i]=o[i]);return uc(n,s,void 0,void 0,null,r)};q.createRef=function(){return{current:null}};q.forwardRef=function(n){return{$$typeof:ub,render:n}};q.isValidElement=dc;q.lazy=function(n){return{$$typeof:cp,_payload:{_status:-1,_result:n},_init:_b}};q.memo=function(n,e){return{$$typeof:hb,type:n,compare:e===void 0?null:e}};q.startTransition=function(n){var e=ce.T,t={};ce.T=t;try{var i=n(),r=ce.S;r!==null&&r(t,i),typeof i=="object"&&i!==null&&typeof i.then=="function"&&i.then(yb,Iu)}catch(s){Iu(s)}finally{ce.T=e}};q.unstable_useCacheRefresh=function(){return ce.H.useCacheRefresh()};q.use=function(n){return ce.H.use(n)};q.useActionState=function(n,e,t){return ce.H.useActionState(n,e,t)};q.useCallback=function(n,e){return ce.H.useCallback(n,e)};q.useContext=function(n){return ce.H.useContext(n)};q.useDebugValue=function(){};q.useDeferredValue=function(n,e){return ce.H.useDeferredValue(n,e)};q.useEffect=function(n,e,t){var i=ce.H;if(typeof t=="function")throw Error("useEffect CRUD overload is not enabled in this build of React.");return i.useEffect(n,e)};q.useId=function(){return ce.H.useId()};q.useImperativeHandle=function(n,e,t){return ce.H.useImperativeHandle(n,e,t)};q.useInsertionEffect=function(n,e){return ce.H.useInsertionEffect(n,e)};q.useLayoutEffect=function(n,e){return ce.H.useLayoutEffect(n,e)};q.useMemo=function(n,e){return ce.H.useMemo(n,e)};q.useOptimistic=function(n,e){return ce.H.useOptimistic(n,e)};q.useReducer=function(n,e,t){return ce.H.useReducer(n,e,t)};q.useRef=function(n){return ce.H.useRef(n)};q.useState=function(n){return ce.H.useState(n)};q.useSyncExternalStore=function(n,e,t){return ce.H.useSyncExternalStore(n,e,t)};q.useTransition=function(){return ce.H.useTransition()};q.version="19.1.1";lp.exports=q;var bb=lp.exports;const mr=Ly(bb),vb=n=>n;function xb(n,e=vb){const t=mr.useSyncExternalStore(n.subscribe,mr.useCallback(()=>e(n.getState()),[n,e]),mr.useCallback(()=>e(n.getInitialState()),[n,e]));return mr.useDebugValue(t),t}const Ru=n=>{const e=ib(n),t=i=>xb(e,i);return Object.assign(t,e),t},wb=n=>n?Ru(n):Ru;class Tb{constructor(e,t,i,r){this.treeMetadata=e,this.pairInterpolationRanges=r}get fullTreeIndices(){return this.pairInterpolationRanges.map(e=>e[0])}getSourceTreeIndex(e){return this.treeMetadata[e].source_tree_global_index+1}getTreeIndexForDistanceIndex(e){return this.pairInterpolationRanges[e][0]}}function Sb(n,e){if(!n||!Array.isArray(n)||e<0)return 0;if(n[e]!==void 0){const t=n[e];return typeof t=="object"?t.value:t}return 0}function gp(n){return!n||!Array.isArray(n)||n.length===0?1:Math.max(...n.map(e=>typeof e=="object"?e.value:e))}function Eb(n,e){return e===0?0:Math.max(0,Math.min(100,n/e*100))}function Pu(n,e=3){return typeof n!="number"||isNaN(n)?"0.000":n.toFixed(e)}function mp(n,e){let t=[];if(!Array.isArray(e)){for(let i=0;i<n.length;i++){const r=Pa(n[i]);t.push({value:r,index:i})}return t}for(let i=0;i<e.length;i++){const r=e[i],s=Pa(n[r]);t.push({value:s,index:r})}return t}function Pa(n){let e=0;return n.children&&n.children.forEach(t=>{let i=Pa(t);e<i&&(e=i)}),e=e+(parseFloat(n.length)||0),e}class Ab{constructor(){this.monophyleticColoringEnabled=!0,this.currentActiveChangeEdges=new Set,this.marked=[]}refreshColorCategories(){const e=M.getState();e.treeController&&e.treeController.renderAllElements&&e.treeController.renderAllElements()}getBranchColorWithHighlights(e,t={}){const i=this._isComponentMarked(e);return this._isActiveChangeEdgeHighlighted(e,this.currentActiveChangeEdges)?re.activeChangeEdgeColor:i?re.markedColor:this._getBaseBranchColor(e)}getBranchColor(e){return this._getBaseBranchColor(e)}getNodeColor(e,t=[],i={}){const r=this._resolveActiveEdgeSet(t),s=this._isNodeMarked(e),o=this._nodeOrParentMatchesActiveEdge(e,r);return s?re.markedColor:o?re.activeChangeEdgeColor:this._getBaseNodeColor(e)}updateMarkedSubtrees(e){Array.isArray(e)?this.marked=e:e instanceof Set?this.marked=[e]:this.marked=[]}updateActiveChangeEdge(e){this.currentActiveChangeEdges=new Set(e)}setMonophyleticColoring(e){this.monophyleticColoringEnabled=e}isMonophyleticColoringEnabled(){return this.monophyleticColoringEnabled}isDownstreamOfAnyActiveChangeEdge(e){return!this.currentActiveChangeEdges||this.currentActiveChangeEdges.size===0?!1:this._isDownstreamOfAnyActiveChangeEdge(e,[this.currentActiveChangeEdges])}isNodeDownstreamOfAnyActiveChangeEdge(e){return!this.currentActiveChangeEdges||this.currentActiveChangeEdges.size===0?!1:this._isNodeDownstreamOfAnyActiveChangeEdge(e,[this.currentActiveChangeEdges])}hasActiveChangeEdges(){return this.currentActiveChangeEdges&&this.currentActiveChangeEdges.size>0}isActiveChangeEdge(e){return this._isActiveChangeEdgeHighlighted(e,this.currentActiveChangeEdges)}_getBaseBranchColor(e){if(!e.target.children||e.target.children.length===0){const s=e.target.data.name;return re[s]||re.defaultColor}if(!this.monophyleticColoringEnabled)return re.defaultColor;const t=this._getSubtreeLeaves(e.target);if(t.length===0)return re.defaultColor;const i=t.map(s=>re[s]||re.defaultColor),r=[...new Set(i)];return r.length===1&&r[0]!==re.defaultColor?r[0]:re.defaultColor}_getBaseNodeColor(e){if(!e.children||e.children.length===0)return re[e.data.name]||re.defaultColor;if(!this.monophyleticColoringEnabled)return re.defaultColor;const t=this._getSubtreeLeaves(e);if(t.length===0)return re.defaultColor;const i=t.map(s=>re[s]||re.defaultColor),r=[...new Set(i)];return r.length===1&&r[0]!==re.defaultColor?r[0]:re.defaultColor}_getSubtreeLeaves(e){if(!e)return[];if(!e.children||e.children.length===0)return[e.data.name];const t=[];return e.children.forEach(i=>{t.push(...this._getSubtreeLeaves(i))}),t}_isActiveChangeEdgeHighlighted(e,t){var i,r;return!t||!((r=(i=e.target)==null?void 0:i.data)!=null&&r.split_indices)?!1:this._splitsEqual(e.target.data.split_indices,t)}_isNodeActiveChangeEdge(e,t){var i;return!t||!((i=e==null?void 0:e.data)!=null&&i.split_indices)?!1:this._splitsEqual(e.data.split_indices,t)}_nodeOrParentMatchesActiveEdge(e,t){var i;if(!t)return!1;if(this._isNodeActiveChangeEdge(e,t))return!0;if(Array.isArray(e==null?void 0:e.children)&&e.children.length>0){for(const r of e.children)if((i=r==null?void 0:r.data)!=null&&i.split_indices&&this._splitsEqual(r.data.split_indices,t))return!0}return!1}_resolveActiveEdgeSet(e){return e instanceof Set?e:Array.isArray(e)&&e.length>0&&typeof e[0]=="number"?new Set(e):this.currentActiveChangeEdges||null}_splitsEqual(e,t){if(!Array.isArray(e)||!(t instanceof Set)||e.length!==t.size)return!1;for(const i of e)if(!t.has(i))return!1;return!0}_isDownstreamOfAnyActiveChangeEdge(e,t){const i=new Set(e.target.data.split_indices);for(const r of t){const s=new Set(r),o=[...i].every(l=>s.has(l));if(i.size<=s.size&&o)return!0}return!1}_isComponentMarked(e){var i,r;if(!((r=(i=e.target)==null?void 0:i.data)!=null&&r.split_indices)||!this.marked)return!1;const t=new Set(e.target.data.split_indices);for(const s of this.marked){const o=s instanceof Set?s:new Set(s),a=[...t].every(c=>o.has(c));if(t.size<=o.size&&a)return!0}return!1}_isNodeDownstreamOfAnyActiveChangeEdge(e,t){var r;if(!t||t.length===0||!((r=e.data)!=null&&r.split_indices))return!1;const i=new Set(e.data.split_indices);for(const s of t){const o=new Set(s),a=[...i].every(c=>o.has(c));if(i.size<=o.size&&a)return!0}return!1}_isNodeMarked(e){var i;if(!((i=e.data)!=null&&i.split_indices)||!this.marked)return!1;const t=new Set(e.data.split_indices);for(const r of this.marked){const s=new Set(r),o=[...t].every(l=>s.has(l));if(t.size<=s.size&&o)return!0}return!1}destroy(){}}function Mu(n,e){let t=e-n,i=e-n-Math.sign(t)*2*Math.PI;return Math.abs(t)<Math.abs(i)?t:i}const _r=(n,e=0,t=1)=>Math.max(e,Math.min(t,n)),_p=n=>n**2*3-n**3*2,re={defaultColor:"#000000",markedColor:"#ff5722",strokeColor:"#000000",activeChangeEdgeColor:"#2196f3",dimmedColor:"#cccccc"},Cb={contourWidthOffset:2,labelOffsets:{DEFAULT:20,WITH_EXTENSIONS:40,EXTENSION:5}},M=wb((n,e)=>({movieData:null,treeList:[],treeMetadata:[],pairSolutions:{},activeChangeEdgeTracking:[],transitionResolver:null,colorManager:null,gui:null,treeController:null,currentTreeIndex:0,previousTreeIndex:-1,navigationDirection:"forward",segmentProgress:0,currentSegmentIndex:0,totalSegments:0,treeInSegment:1,treesInSegment:1,timelineProgress:0,playing:!1,renderInProgress:!1,subscriptionPaused:!1,syncMSAEnabled:!0,animationProgress:0,animationStartTime:null,animationSpeed:1,fontSize:"2.6em",strokeWidth:3,branchTransformation:"none",monophyleticColoringEnabled:!0,activeChangeEdgesEnabled:!0,markedComponentsEnabled:!0,dimmingEnabled:!1,cameraMode:"orthographic",msaWindowSize:1e3,msaStepSize:50,msaColumnCount:0,styleConfig:{...Cb},autoFitOnTreeChange:!0,trailsEnabled:!1,trailLength:12,trailOpacity:.5,trailThickness:.5,taxaGrouping:null,barOptionValue:"rfd",stickyChartPosition:void 0,initialize:t=>{var x,y,S,I,F,D,B;console.log("[Store] Initializing with movieData - window_size:",t==null?void 0:t.window_size,"window_step_size:",t==null?void 0:t.window_step_size),console.log("[Store] MSA data - window_size:",(x=t==null?void 0:t.msa)==null?void 0:x.window_size,"step_size:",(y=t==null?void 0:t.msa)==null?void 0:y.step_size),console.log("Store: movieData.pair_interpolation_ranges:",(S=t.pair_interpolation_ranges)==null?void 0:S.length,"items");const i=new Tb(t.tree_metadata,(I=t.distances)==null?void 0:I.robinson_foulds,t.tree_pair_solutions||{},t.pair_interpolation_ranges||[],!0),r=i.fullTreeIndices,s=mp(t.interpolated_trees,r),o=gp(s),a=r.length,l=new Ab([]),c=e().monophyleticColoringEnabled!==void 0?e().monophyleticColoringEnabled:!0;l.setMonophyleticColoring(c);let u=0;try{const U=(F=t==null?void 0:t.msa)==null?void 0:F.sequences;if(console.log("[Store] MSA sequences:",U?Object.keys(U):"none"),U&&typeof U=="object"){const O=Object.values(U)[0];typeof O=="string"&&(u=O.length,console.log("[Store] MSA column count:",u))}}catch(U){console.error("[Store] Error getting MSA column count:",U)}const d=t.window_size||((D=t.msa)==null?void 0:D.window_size)||1e3,h=t.window_step_size||((B=t.msa)==null?void 0:B.step_size)||50;console.log("[Store] Setting MSA params - windowSize:",d,"stepSize:",h,"columnCount:",u),n({movieData:{...t,scaleList:s,maxScale:o,fullTreeIndices:r,numberOfFullTrees:a},treeList:t.interpolated_trees,treeMetadata:t.tree_metadata,pairSolutions:t.tree_pair_solutions||{},activeChangeEdgeTracking:t.split_change_tracking||[],transitionResolver:i,colorManager:l,currentTreeIndex:0,previousTreeIndex:-1,playing:!1,msaColumnCount:u,msaWindowSize:d,msaStepSize:h});const{getActualHighlightData:f,updateColorManagerMarkedSubtrees:p,updateColorManagerActiveChangeEdge:g,getCurrentActiveChangeEdge:_}=e(),b=f(),w=_();p(b),g(w)},play:()=>{const{playing:t,animationProgress:i,treeList:r,animationSpeed:s}=e();if(t)return;const o=r.length,a=i>=1?0:i,l=a*(o-1)/s*1e3,c=performance.now()-l;n({playing:!0,animationStartTime:c,animationProgress:a})},stop:()=>{n({playing:!1,animationStartTime:null})},setAnimationSpeed:t=>n({animationSpeed:t}),updateAnimationProgress:t=>{const{animationStartTime:i,animationSpeed:r,treeList:s,playing:o}=e();if(!o||!i||!s.length)return!1;const a=(t-i)/1e3,l=s.length,c=a*r/(l-1),u=Math.min(c,1),d=u*(l-1),h=Math.round(d);return n({animationProgress:u,currentTreeIndex:_r(h,0,l-1)}),c>=1},getAnimationInterpolationData:()=>{const{animationProgress:t,treeList:i,playing:r}=e();if(!r||!i.length)return null;const s=i.length,o=t*(s-1),a=Math.floor(o),l=Math.min(a+1,s-1),c=o-a,u=_p(c);return{exactTreeIndex:o,fromTreeIndex:a,toTreeIndex:l,segmentProgress:c,easedProgress:u,progress:t}},setNavigationDirection:t=>n({navigationDirection:t}),setSegmentProgress:t=>n({segmentProgress:_r(t,0,1)}),updateTimelineState:t=>n({currentSegmentIndex:t.currentSegmentIndex||0,totalSegments:t.totalSegments||0,treeInSegment:t.treeInSegment||1,treesInSegment:t.treesInSegment||1,timelineProgress:_r(t.timelineProgress||0,0,1)}),goToPosition:(t,i)=>{console.log("[Store] goToPosition called with position:",t,"direction:",i);const{treeList:r,currentTreeIndex:s,renderInProgress:o}=e();if(console.log("[Store] goToPosition - treeList:",r==null?void 0:r.length,"currentTreeIndex:",s,"renderInProgress:",o),o){console.log("[Store] goToPosition skipped - renderInProgress:",o);return}if(!r||r.length===0){console.log("[Store] goToPosition skipped - no treeList");return}const a=_r(t,0,r.length-1);if(console.log("[Store] goToPosition - currentTreeIndex:",s,"newIndex:",a,"treeList.length:",r.length),a!==s){let l=i;l||(l=a>s?"forward":"backward"),console.log("[Store] goToPosition - updating from",s,"to",a,"direction:",l);const c=r.length,u=c>1?a/(c-1):0;n({previousTreeIndex:s,currentTreeIndex:a,navigationDirection:l,segmentProgress:0,animationProgress:u})}},forward:()=>{const{currentTreeIndex:t,treeList:i,goToPosition:r,renderInProgress:s}=e();if(s)return;const o=t+1;o<i.length?r(o):n({playing:!1})},backward:()=>{const{currentTreeIndex:t,goToPosition:i,renderInProgress:r}=e();r||i(t-1)},setFontSize:t=>{let i=t;typeof i=="number"?i=`${i}em`:typeof i=="string"&&!i.match(/(em|px|pt|rem)$/)&&(i=`${i}em`),n({fontSize:i})},setStrokeWidth:t=>{const i=Number(t);n({strokeWidth:i})},setMonophyleticColoring:t=>{n({monophyleticColoringEnabled:t});const{colorManager:i}=e();i&&i.setMonophyleticColoring(t)},setActiveChangeEdgesEnabled:t=>{n({activeChangeEdgesEnabled:t});const{updateColorManagerActiveChangeEdge:i,getCurrentActiveChangeEdge:r}=e();if(!t)i([]);else{const s=r();i(s)}},setMarkedComponentsEnabled:t=>{n({markedComponentsEnabled:t});const{updateColorManagerMarkedSubtrees:i,getActualHighlightData:r}=e();if(!t)i([]);else{const s=r();i(s)}},setDimmingEnabled:t=>n({dimmingEnabled:t}),setTrailsEnabled:t=>n({trailsEnabled:!!t}),setTrailLength:t=>n({trailLength:Math.max(2,Math.min(50,Math.round(Number(t)||12)))}),setTrailOpacity:t=>n({trailOpacity:Math.max(0,Math.min(1,Number(t)||.5))}),setTrailThickness:t=>n({trailThickness:Math.max(.1,Math.min(5,Number(t)||.5))}),toggleAutoFitOnTreeChange:()=>n(t=>({autoFitOnTreeChange:!t.autoFitOnTreeChange})),setAutoFitOnTreeChange:t=>n({autoFitOnTreeChange:!!t}),applyThemeColors:(t="system")=>{try{const i=typeof window<"u"&&window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,r=t==="dark"||t==="system"&&i;Object.assign(re,{defaultColor:r?"#9AA4AE":"#000000",strokeColor:r?"#9AA4AE":"#000000",dimmedColor:r?"#555555":"#cccccc"});const{colorManager:o,treeController:a}=e();o&&o.refreshColorCategories&&o.refreshColorCategories(),a&&a.renderAllElements&&a.renderAllElements()}catch(i){console.warn("[store] applyThemeColors failed:",i)}},setBranchTransformation:t=>n({branchTransformation:t}),setCameraMode:t=>{(t==="orthographic"||t==="orbit")&&n({cameraMode:t})},toggleCameraMode:()=>{const{cameraMode:t}=e(),i=t==="orthographic"?"orbit":"orthographic";return n({cameraMode:i}),i},setMsaWindowSize:t=>n({msaWindowSize:t}),setMsaStepSize:t=>n({msaStepSize:t}),setSyncMSAEnabled:t=>n({syncMSAEnabled:t}),setStyleConfig:t=>n(i=>({styleConfig:{...i.styleConfig,...t}})),setBarOption:t=>n({barOptionValue:t}),setStickyChartPosition:t=>n({stickyChartPosition:t}),clearStickyChartPosition:()=>n({stickyChartPosition:void 0}),setRenderInProgress:t=>n({renderInProgress:t}),setSubscriptionPaused:t=>n({subscriptionPaused:t}),setTreeController:t=>{const{treeController:i}=e();if(i&&i!==t&&typeof i.destroy=="function"&&i.destroy(),n({treeController:t}),t){const{getActualHighlightData:r,updateColorManagerMarkedSubtrees:s,getCurrentActiveChangeEdge:o,updateColorManagerActiveChangeEdge:a,markedComponentsEnabled:l,activeChangeEdgesEnabled:c}=e();console.log("[Store] Applying initial ColorManager state to new tree controller");try{if(l){const u=r();s(u)}if(c){const u=o();a(u)}t.renderAllElements&&setTimeout(()=>t.renderAllElements(),100)}catch(u){console.error("[Store] Error applying initial ColorManager state:",u)}}},setGui:t=>{const{gui:i}=e();i&&i!==t&&typeof i.destroy=="function"&&i.destroy(),n({gui:t})},getColorManager:()=>{const{colorManager:t}=e();return t},updateColorManagerMarkedSubtrees:t=>{const{colorManager:i}=e();let r=[];console.log("Updating ColorManager with marked subtrees:",t),r=t.map(s=>new Set(s)),console.log("Converted marked subtrees for ColorManager:",r),i.updateMarkedSubtrees(r)},updateColorManagerActiveChangeEdge:t=>{const{colorManager:i}=e();i.updateActiveChangeEdge(t)},updateHighlightingColor:(t,i)=>{re[t]=i;const{colorManager:r}=e();r&&r.refreshColorCategories&&r.refreshColorCategories();const{treeController:s}=e();s&&s.renderAllElements()},setActiveChangeEdgeColor:t=>{const{updateHighlightingColor:i}=e();i("activeChangeEdgeColor",t)},setMarkedColor:t=>{const{updateHighlightingColor:i}=e();i("markedColor",t)},setDimmedColor:t=>{const{updateHighlightingColor:i}=e();i("dimmedColor",t)},updateTaxaColors:t=>{Object.assign(re,t);const{colorManager:i}=e();i&&i.refreshColorCategories&&i.refreshColorCategories();const{treeController:r}=e();r&&r.renderAllElements()},setTaxaGrouping:t=>n({taxaGrouping:t}),getLineChartProps:()=>{var o,a,l,c,u;const t=e(),i=(a=(o=t.movieData)==null?void 0:o.distances)==null?void 0:a.robinson_foulds,r=(c=(l=t.movieData)==null?void 0:l.distances)==null?void 0:c.weighted_robinson_foulds,s=(u=t.movieData)==null?void 0:u.scaleList;return{barOptionValue:t.barOptionValue,currentTreeIndex:t.currentTreeIndex,robinsonFouldsDistances:i,weightedRobinsonFouldsDistances:r,scaleList:s,transitionResolver:t.transitionResolver}},getActualHighlightData:()=>{var _,b,w;const{currentTreeIndex:t,transitionResolver:i,pairSolutions:r,activeChangeEdgeTracking:s,movieData:o}=e(),a=(i==null?void 0:i.fullTreeIndices)||(o==null?void 0:o.fullTreeIndices)||[];if(Array.isArray(a)&&a.includes(t)||(_=i==null?void 0:i.isFullTree)!=null&&_.call(i,t))return[];const c=t,u=s==null?void 0:s[c];if(!Array.isArray(u)||u.length===0)return[];const d=(w=(b=o==null?void 0:o.tree_metadata)==null?void 0:b[c])==null?void 0:w.tree_pair_key,h=d?r==null?void 0:r[d]:null,f=(h==null?void 0:h.jumping_subtree_solutions)||{};if(!h)return[];const p=`[${u.join(", ")}]`,g=f[p];return Array.from(g.flat())},updateColorManagerForCurrentIndex:()=>{const{markedComponentsEnabled:t,activeChangeEdgesEnabled:i,getActualHighlightData:r,getCurrentActiveChangeEdge:s,updateColorManagerMarkedSubtrees:o,updateColorManagerActiveChangeEdge:a}=e();if(t){const l=r();o(l)}else o([]);if(i){const l=s();a(l)}else a([])},getCurrentActiveChangeEdge:()=>{const{currentTreeIndex:t,activeChangeEdgeTracking:i}=e();return(i==null?void 0:i[t])||[]},setupColorManagerSubscription:()=>{const t=M;let i=t.getState().currentTreeIndex;return t.subscribe(r=>{const s=r.currentTreeIndex;s!==i&&(r.updateColorManagerForCurrentIndex(),i=s)})}}));M.getState().setupColorManagerSubscription();const Ib=["#EE7733","#0077BB","#33BBEE","#009988","#CC3311","#EE3377","#BBBBBB"],Rb=["#EE7733","#0077BB","#33BBEE","#009988","#CC3311","#EE3377","#6E6E6E"],Pb=["#CC6677","#332288","#DDCC77","#117733","#88CCEE","#882255","#44AA99","#999933","#AA4499"],Mb=["#CC6677","#332288","#BBAA33","#117733","#88CCEE","#882255","#44AA99","#8A8A33","#AA4499"],kb=["#EE7733","#0077BB","#33BBEE","#009988","#CC3311","#EE3377","#BBBBBB","#000000"],Ob=["#EE7733","#0077BB","#33BBEE","#009988","#CC3311","#EE3377","#6E6E6E","#000000"],Nb=["#E69F00","#56B4E9","#009E73","#F0E442","#0072B2","#D55E00","#CC79A7","#999999"],Fb=["#E69F00","#56B4E9","#009E73","#B59F00","#0072B2","#D55E00","#CC79A7","#666666"],Db=["#E69F00","#56B4E9","#009E73","#F0E442","#0072B2","#D55E00","#CC79A7","#000000"],yp=["#E69F00","#56B4E9","#009E73","#B3A800","#0072B2","#D55E00","#CC79A7","#000000"],Bb=["#6750A4","#0061A4","#006E2C","#B3261E","#9C4500","#8E3A80","#006874","#605D62"],Lb=["#648FFF","#785EF0","#DC267F","#FE6100","#FFB000","#61D836","#009473","#C4C4C4"],Ub=["#648FFF","#785EF0","#DC267F","#FE6100","#D99000","#3DBA1E","#007E61","#6F6F6F"],$b=["#E3F2FD","#BBDEFB","#90CAF9","#64B5F6","#42A5F5","#2196F3","#1E88E5","#1976D2","#1565C0","#0D47A1"],zb=["#BBD9FF","#90BDF9","#6CA9F4","#4D9AF2","#2E8AEF","#1976D2","#1565C0","#1152A6","#0E468F","#0A3A79"],Vb=["#E7F0FA","#CFE2F3","#B7D3ED","#9EC5E6","#86B7DF","#6EA9D9","#559BD2","#3D8DCB","#257FC5","#0D71BE"],Wb=["#B7D3ED","#9EC5E6","#86B7DF","#6EA9D9","#559BD2","#3D8DCB","#257FC5","#0D71BE"],Hb=["#440154","#482777","#3e4989","#31688e","#26828e","#1f9e89","#35b779","#6ece58","#b5de2b","#fde725"],jb=["#440154","#482777","#3e4989","#31688e","#26828e","#1f9e89","#35b779","#6ece58"],Xb=["#00204D","#002D6C","#16406C","#3B496C","#555068","#6C5B5D","#7F6850","#958B43","#B1B338","#FFEA46"],Yb=["#00204D","#002D6C","#16406C","#3B496C","#555068","#6C5B5D","#7F6850","#958B43"],qb=["#30123B","#4662D7","#36AAF9","#1AE4B6","#72FE5E","#C7EF34","#FBCA36","#F66B19","#CA2B1F","#7A0403"],Kb=["#30123B","#4662D7","#36AAF9","#1AE4B6","#72FE5E","#F66B19","#CA2B1F","#7A0403"],Zb=["#3B4CC0","#6788EE","#9ABBFF","#C9DDFF","#F0F0F0","#FFDDAA","#FF9A56","#E65F2B","#B40426"],Gb=["#3B4CC0","#5F80E6","#8FB3F7","#B5CFFF","#D9D9D9","#FFC27A","#FF8A40","#D55224","#B40426"],Qb=["#762A83","#9970AB","#C2A5CF","#E7D4E8","#F7F7F7","#D9F0D3","#ACD39E","#5AAE61","#1B7837"],Jb=["#762A83","#8E66A2","#B896C6","#D7BEDC","#D9D9D9","#BEE5B8","#93C98E","#4C9D58","#1B7837"],ev=["#FF6B6B","#4ECDC4","#45B7D1","#FFA07A","#98D8C8","#6C5CE7","#FDCB6E","#55A3FF","#FD79A8","#A29BFE","#00B894","#FF7675"],tv=["#E95A5A","#3FB8B0","#349CC0","#E26D5A","#63B7A8","#5A4DD1","#D99A00","#2979FF","#E06398","#6F6AF2","#00A07F","#E95F5E"],nv=["#FF0000","#0000FF","#00AA00","#FF00FF","#00FFFF","#FFAA00","#AA00FF","#000000"],hc={BlueShadesWhiteBG:zb,OkabeItoWhiteBG:yp,WongWhiteBG:Fb,TolBrightWhiteBG:Rb,TolMutedWhiteBG:Mb,TolVibrantWhiteBG:Ob,IBMColorBlindWhiteBG:Ub,PhyloOptimizedWhiteBG:tv,BlueShades:$b,TolBright:Ib,TolMuted:Pb,TolVibrant:kb,WongPalette:Nb,OkabeIto:Db,MaterialVibrant:Bb,IBMColorBlind:Lb,PhyloOptimized:ev,HighContrast:nv},iv={BlueSequentialWhiteBG:Wb,ViridisWhiteBG:jb,CividisWhiteBG:Yb,TurboWhiteBG:Kb,BlueSequential:Vb,Viridis:Hb,Cividis:Xb,Turbo:qb},rv={CoolWarmWhiteBG:Gb,PurpleGreenWhiteBG:Jb,CoolWarm:Zb,PurpleGreen:Qb},sv={...hc,...iv,...rv};function ov(n){return sv[n]||yp}function av(n){return{BlueShadesWhiteBG:{type:"categorical",colorBlindSafe:!0,maxColors:10,description:"Blue tints/tones tuned for white background"},OkabeItoWhiteBG:{type:"categorical",colorBlindSafe:!0,maxColors:8,description:"Okabe-Ito tuned for white background"},WongWhiteBG:{type:"categorical",colorBlindSafe:!0,maxColors:8,description:"Wong palette tuned for white background"},TolBrightWhiteBG:{type:"categorical",colorBlindSafe:!0,maxColors:7,description:"Tol Bright tuned for white background"},TolMutedWhiteBG:{type:"categorical",colorBlindSafe:!0,maxColors:9,description:"Tol Muted tuned for white background"},TolVibrantWhiteBG:{type:"categorical",colorBlindSafe:!0,maxColors:8,description:"Tol Vibrant tuned for white background"},IBMColorBlindWhiteBG:{type:"categorical",colorBlindSafe:!0,maxColors:8,description:"IBM accessible palette tuned for white background"},PhyloOptimizedWhiteBG:{type:"categorical",colorBlindSafe:!1,maxColors:12,description:"Tree-optimized palette tuned for white background"},BlueShades:{type:"categorical",colorBlindSafe:!0,maxColors:10,description:"Blue tints/tones (single-hue categorical)"},TolBright:{type:"categorical",colorBlindSafe:!0,maxColors:7,description:"Bright, color-blind friendly"},TolMuted:{type:"categorical",colorBlindSafe:!0,maxColors:9,description:"Muted, color-blind friendly"},TolVibrant:{type:"categorical",colorBlindSafe:!0,maxColors:8,description:"Vibrant, color-blind friendly"},WongPalette:{type:"categorical",colorBlindSafe:!0,maxColors:8,description:"Nature-optimized for accessibility"},OkabeIto:{type:"categorical",colorBlindSafe:!0,maxColors:8,description:"Universal design standard"},MaterialVibrant:{type:"categorical",colorBlindSafe:!1,maxColors:8,description:"Material Design 3 colors"},IBMColorBlind:{type:"categorical",colorBlindSafe:!0,maxColors:8,description:"IBM accessible design"},PhyloOptimized:{type:"categorical",colorBlindSafe:!1,maxColors:12,description:"Optimized for tree visualization"},HighContrast:{type:"categorical",colorBlindSafe:!1,maxColors:8,description:"Maximum contrast"},BlueSequentialWhiteBG:{type:"sequential",colorBlindSafe:!0,maxColors:8,description:"Blue ramp clipped for white background"},ViridisWhiteBG:{type:"sequential",colorBlindSafe:!0,maxColors:8,description:"Viridis clipped for white background"},CividisWhiteBG:{type:"sequential",colorBlindSafe:!0,maxColors:8,description:"Cividis clipped for white background"},TurboWhiteBG:{type:"sequential",colorBlindSafe:!1,maxColors:8,description:"Turbo clipped for white background"},BlueSequential:{type:"sequential",colorBlindSafe:!0,maxColors:10,description:"Perceptual lightâ†’dark blue ramp"},Viridis:{type:"sequential",colorBlindSafe:!0,maxColors:10,description:"Scientific standard, perceptually uniform"},Cividis:{type:"sequential",colorBlindSafe:!0,maxColors:10,description:"Color-blind optimized Viridis"},Turbo:{type:"sequential",colorBlindSafe:!1,maxColors:10,description:"Rainbow-like, perceptually uniform"},CoolWarmWhiteBG:{type:"diverging",colorBlindSafe:!1,maxColors:9,description:"Cool-Warm tuned for white background"},PurpleGreenWhiteBG:{type:"diverging",colorBlindSafe:!0,maxColors:9,description:"Purple-Green tuned for white background"},CoolWarm:{type:"diverging",colorBlindSafe:!1,maxColors:9,description:"Blue to red diverging"},PurpleGreen:{type:"diverging",colorBlindSafe:!0,maxColors:9,description:"Color-blind safe diverging"}}[n]||{type:"unknown",colorBlindSafe:!1,maxColors:0,description:"Unknown palette"}}function ku(n){return{prefix:"first",suffix:"last",middle:"nth-2","first-letter":"first-letter"}[n]||n}function bp(n,e,t){if(!n)return null;if(e==="first-letter"||t==="first-letter")return n.charAt(0).toUpperCase();if(!e&&t!=="first-letter"){const i=vp([n]);if(i)e=i;else return null}return lv(n,e,t)}function lv(n,e,t,i=1){if(t&&t.startsWith("between-")){const s=t.split("-");if(s.length>=6){const o=s[1],a=parseInt(s[2])||1,l=s[4],c=parseInt(s[5])||1;return cv(n,o,a,l,c)}return null}const r=n.split(e);if(r.length<=1)return null;if(t==="first")return r[0];if(t==="last")return r.slice(0,-1).join(e);if(t&&t.startsWith("nth-")){const s=parseInt(t.split("-")[1])||i;return s===1?r[0]:s>=2&&s<=r.length?r[s-1]:null}return null}function cv(n,e,t,i,r){let s=-1,o=0;for(let l=0;l<n.length;l++)if(n[l]===e&&(o++,o===t)){s=l;break}if(s===-1)return null;let a=-1;o=0;for(let l=s+1;l<n.length;l++)if(n[l]===i&&(o++,o===r)){a=l;break}return a===-1?n.substring(s+1):n.substring(s+1,a)}function vp(n){const e=["-","_","."," ","|",":"];let t=null,i=0;return e.forEach(r=>{const s=n.filter(a=>a.includes(r)),o=s.length/n.length*100;o>=20&&s.length>=2&&o>i&&(t=r,i=o)}),t}function uv(n,e,t){const i=new Map;let r=e;return!e&&t!=="first-letter"&&(r=vp(n),!r)?{groups:[],separator:null,analyzed:!0}:(n.forEach(o=>{const a=bp(o,r,t);a&&(i.has(a)||i.set(a,[]),i.get(a).push(o))}),{groups:Array.from(i.entries()).map(([o,a])=>({name:o,count:a.length,members:a})),separator:r,analyzed:!e})}function dv(n,e,t){const i={};if(n.mode==="taxa")for(const[r,s]of n.taxaColorMap)i[r]=s;else n.mode==="groups"?e.forEach(r=>{const s=bp(r,n.separator,n.strategyType),o=n.groupColorMap.get(s);o?i[r]=o:i[r]=t[r]||t.defaultColor||"#000000"}):n.mode==="csv"&&e.forEach(r=>{var a;const s=(a=n.csvTaxaMap)==null?void 0:a.get(r),o=s?n.groupColorMap.get(s):null;o?i[r]=o:i[r]=t[r]||t.defaultColor||"#000000"});return i}class hv{static createColorInput(e,t,i){const r=document.createElement("div");r.className="tc-color-input";const s=document.createElement("label");s.className="tc-color-input-label",typeof e=="string"?s.textContent=e:s.appendChild(e);const o=document.createElement("div");o.className="tc-swatch-container";const a=document.createElement("div");a.className="tc-swatch",a.style.backgroundColor=t||"#000000";const l=this._createColorPickerPopover(c=>{a.style.backgroundColor=c,i(c)},t);return a.addEventListener("click",c=>{c.stopPropagation(),document.querySelectorAll(".tc-popover.visible").forEach(u=>u.classList.remove("visible")),l.classList.toggle("visible")}),o.appendChild(a),o.appendChild(l),r.appendChild(s),r.appendChild(o),document.addEventListener("click",()=>l.classList.remove("visible"),{once:!0}),r}static _createColorPickerPopover(e,t){const i=document.createElement("div");i.className="tc-popover",i.addEventListener("click",c=>c.stopPropagation());const r=document.createElement("h4");r.className="tc-popover-title",r.textContent="Quick Colors",i.appendChild(r);const s=document.createElement("div");s.className="tc-popover-grid",new Set([].concat(...Object.values(hc).slice(0,4).map(c=>c.slice(0,5)))).forEach(c=>{const u=document.createElement("button");u.className="tc-popover-swatch",u.style.backgroundColor=c,u.addEventListener("click",()=>{e(c),i.classList.remove("visible")}),s.appendChild(u)}),i.appendChild(s);const a=document.createElement("h4");a.className="tc-popover-title",a.textContent="Custom Color",i.appendChild(a);const l=document.createElement("input");return l.type="color",l.className="tc-popover-input",l.value=t||"#000000",l.addEventListener("input",c=>e(c.target.value)),i.appendChild(l),i}}class Ee{static async createColorAssignmentWindow(e){const t=document.createElement("div");t.className="tc-container";let i=window.WinBox;if(!i)try{const s=document.createElement("script");s.src="/node_modules/winbox/dist/winbox.bundle.min.js",document.head.appendChild(s),await new Promise((o,a)=>{s.onload=o,s.onerror=a}),i=window.WinBox}catch(s){throw new Error(`Failed to load WinBox bundle: ${s.message}`)}if(typeof i!="function")throw new Error(`WinBox is not available as a constructor. Type: ${typeof i}. Available on window: ${typeof window.WinBox}`);const r=new i({id:"taxa-coloring-modal",title:"Taxa Color Assignment",width:"800px",height:"85%",x:"center",y:"center",mount:t,onclose:e,class:["no-full","tc-winbox"]});return{windowContent:t,colorWin:r}}static createColorSchemeSelector({onSchemeChange:e}){const t=document.createElement("div");t.className="tc-section";const i=document.createElement("div");i.className="tc-collapsible-header";const r=document.createElement("h3");r.className="tc-section-title",r.textContent="Apply a Color Scheme";const s=document.createElement("md-filled-tonal-button");s.setAttribute("aria-label","Toggle color scheme section"),s.setAttribute("title","Show or hide color scheme options"),s.className="tc-collapse-toggle";const o=document.createElement("md-icon");o.setAttribute("slot","icon"),o.textContent="expand_less",s.appendChild(o);const a=document.createTextNode("Show Color Schemes");s.appendChild(a),i.appendChild(r),i.appendChild(s);const l=document.createElement("div");l.className="tc-collapsible-content";const c=document.createElement("div");c.className="tc-scheme-grid",Object.entries(hc).forEach(([d,h])=>{const f=av(d),p=document.createElement("button");p.className="tc-scheme-button",p.title=f.description;const g=document.createElement("div");g.className="tc-scheme-gradient",g.style.background=`linear-gradient(to right, ${h.join(", ")})`;const _=document.createElement("div");_.style.display="flex",_.style.alignItems="center",_.style.gap="4px";const b=document.createElement("span");if(b.className="tc-scheme-name",b.textContent=d,_.appendChild(b),f.colorBlindSafe){const w=document.createElement("span");w.textContent="ðŸ‘",w.title="Color-blind safe",w.style.fontSize="12px",_.appendChild(w)}p.appendChild(g),p.appendChild(_),p.addEventListener("click",()=>e(d)),c.appendChild(p)}),l.appendChild(c);let u=!0;return l.classList.add("tc-collapsed"),o.textContent="palette",s.addEventListener("click",()=>{u=!u,l.classList.toggle("tc-collapsed",u),o.textContent=u?"palette":"expand_less";const d=s.childNodes[1];d.textContent=u?"Show Color Schemes":"Hide Color Schemes"}),t.appendChild(i),t.appendChild(l),t}static createColorInputGrid(){const e=document.createElement("div");return e.className="tc-color-input-grid",e}static createColorInput(e,t,i){return hv.createColorInput(e,t,i)}static createCSVUploadSection(e){const t=document.createElement("div");t.className="tc-csv-upload-surface",t.style.position="relative",t.addEventListener("dragover",c=>{c.preventDefault(),t.classList.add("drag-over")}),t.addEventListener("dragleave",()=>{t.classList.remove("drag-over")}),t.addEventListener("drop",c=>{c.preventDefault(),t.classList.remove("drag-over");const u=c.dataTransfer.files[0];u&&(u.type==="text/csv"||u.name.endsWith(".csv"))?e(u):u&&alert("Please upload a CSV file")});const i=document.createElement("md-elevation");t.appendChild(i);const r=document.createElement("md-icon");r.className="tc-csv-upload-icon",r.textContent="upload_file",t.appendChild(r);const s=document.createElement("div");s.className="tc-csv-upload-text",s.textContent="Drag and drop a CSV file here, or click to browse",t.appendChild(s);const o=document.createElement("input");o.type="file",o.accept=".csv",o.className="tc-csv-file-input",o.addEventListener("change",c=>{const u=c.target.files[0];u&&e(u)}),t.appendChild(o);const a=document.createElement("md-filled-button"),l=document.createElement("md-icon");return l.setAttribute("slot","icon"),l.textContent="folder_open",a.appendChild(l),a.appendChild(document.createTextNode("Browse Files")),a.addEventListener("click",()=>o.click()),t.appendChild(a),t}static createCSVPreviewSection(e,t){const i=document.createElement("div");if(i.className="tc-csv-preview-section",e){const d=document.createElement("md-list");d.style.marginBottom="16px";const h=document.createElement("md-list-item");h.setAttribute("type","text");const f=document.createElement("md-icon");f.setAttribute("slot","start"),f.textContent=e.isValid?"check_circle":"warning",f.style.color=e.isValid?"var(--md-sys-color-primary, #006a6a)":"var(--md-sys-color-error, #ba1a1a)",h.appendChild(f);const p=document.createElement("div");p.setAttribute("slot","headline"),p.textContent=e.isValid?"CSV Loaded Successfully":"CSV Loaded with Warnings",h.appendChild(p);const g=document.createElement("div");g.setAttribute("slot","supporting-text"),g.textContent=`${t.length} groups â€¢ ${e.matched.length} matched taxa (${e.matchPercentage}%)`,h.appendChild(g),d.appendChild(h),i.appendChild(d)}const r=document.createElement("div");r.className="tc-csv-preview-list",r.style.position="relative";const s=document.createElement("md-elevation");r.appendChild(s);const o=document.createElement("md-list");o.style.maxHeight="300px",o.style.overflowY="auto";const a=document.createElement("md-list-item");a.setAttribute("type","text"),a.style.fontWeight="500";const l=document.createElement("div");l.setAttribute("slot","headline"),l.textContent="Group Preview",a.appendChild(l);const c=document.createElement("div");c.setAttribute("slot","supporting-text"),c.textContent="Group Name â€¢ Taxa Count â€¢ Sample Members",a.appendChild(c),o.appendChild(a);const u=document.createElement("md-divider");if(o.appendChild(u),t.slice(0,5).forEach((d,h)=>{const f=document.createElement("md-list-item");f.setAttribute("type","text");const p=document.createElement("div");p.setAttribute("slot","headline"),p.textContent=d.name,f.appendChild(p);const g=document.createElement("div");g.setAttribute("slot","supporting-text");const _=d.members.slice(0,3).join(", ")+(d.members.length>3?"...":"");g.textContent=`${d.count} taxa â€¢ ${_}`,f.appendChild(g);const b=document.createElement("div");b.setAttribute("slot","trailing-supporting-text"),b.textContent=d.count.toString(),b.style.minWidth="30px",b.style.textAlign="end",f.appendChild(b),o.appendChild(f),h<4&&h<t.length-1&&o.appendChild(document.createElement("md-divider"))}),t.length>5){o.appendChild(document.createElement("md-divider"));const d=document.createElement("md-list-item");d.setAttribute("type","text");const h=document.createElement("div");h.setAttribute("slot","headline"),h.style.textAlign="center",h.style.fontStyle="italic",h.textContent=`... and ${t.length-5} more groups`,d.appendChild(h),o.appendChild(d)}return r.appendChild(o),i.appendChild(r),i}static createGroupColorSection(e,t,i){const r=document.createElement("div");r.className="tc-section";const s=document.createElement("h3");s.className="tc-section-title",s.textContent=e,r.appendChild(s);const o=Ee.createColorInputGrid();return t.forEach(a=>{const l=i.groupColorMap.get(a.name)||i.getRandomColor();i.groupColorMap.has(a.name)||i.groupColorMap.set(a.name,l);const c=Ee.createColorInput(`${a.name} (${a.count})`,l,u=>i.groupColorMap.set(a.name,u));o.appendChild(c)}),r.appendChild(o),r}static createTaxaColorSection(e,t){const i=document.createElement("div");i.className="tc-section";const r=document.createElement("h3");r.className="tc-section-title",r.textContent=`Individual Colors (${e.length})`,i.appendChild(r);const s=Ee.createColorInputGrid();return e.forEach(o=>{let a=t.taxaColorMap.get(o);a||(a="#000000",t.taxaColorMap.set(o,a));const l=Ee.createColorInput(o,a,c=>t.taxaColorMap.set(o,c));s.appendChild(l)}),i.appendChild(s),i}static createCSVColorSection(e,t){const i=`CSV Group Colors (${e.length})`;return this.createGroupColorSection(i,e,t)}static createColumnSelector({groupingColumns:e,columnGroups:t,selectedColumn:i,onColumnChange:r}){const s=document.createElement("div");s.className="tc-section";const o=document.createElement("h3");o.className="tc-section-title",o.textContent="Select Grouping Column",s.appendChild(o);const a=document.createElement("md-chip-set");return a.style.display="flex",a.style.flexWrap="wrap",a.style.gap="8px",e.forEach(l=>{var d;const c=document.createElement("md-filter-chip"),u=((d=t[l.name])==null?void 0:d.length)||0;c.setAttribute("label",`${l.displayName} (${u} groups)`),i===l.name&&c.setAttribute("selected",""),c.addEventListener("click",()=>r(l.name)),a.appendChild(c)}),s.appendChild(a),s}static createModeSelector({currentMode:e,onModeChange:t}){const i=document.createElement("div");return i.className="tc-mode-selector",[{key:"taxa",label:"Individual Taxa",icon:"palette"},{key:"groups",label:"Group by Pattern",icon:"group_work"},{key:"csv",label:"Import CSV",icon:"upload_file"}].forEach(({key:s,label:o,icon:a})=>{const l=e===s?"md-filled-button":"md-outlined-button",c=document.createElement(l),u=document.createElement("md-icon");u.setAttribute("slot","icon"),u.textContent=a,c.appendChild(u);const d=document.createTextNode(o);c.appendChild(d),c.addEventListener("click",()=>t(s)),i.appendChild(c)}),i}static createGroupingStrategySelector({taxaNames:e,cachedSeparators:t,selectedStrategy:i,selectedSeparator:r,onStrategyChange:s,onCacheSeparators:o}){const a=document.createElement("div");a.className="tc-section";const l=document.createElement("h3");l.className="tc-section-title",l.textContent="Pattern Detection Settings",a.appendChild(l);const c=document.createElement("div");c.style.marginBottom="16px";const u=document.createElement("h4");u.className="tc-subsection-title",u.textContent="Grouping Strategy:",c.appendChild(u);const d=document.createElement("md-chip-set");d.style.display="flex",d.style.flexWrap="wrap",d.style.gap="8px";const h=[{value:"prefix",label:"Prefix",description:"Before separator"},{value:"suffix",label:"Suffix",description:"After separator"},{value:"middle",label:"Middle",description:"Middle part"},{value:"first-letter",label:"First Letter",description:"First character"}];let f=null;h.forEach(y=>{const S=document.createElement("md-filter-chip");S.setAttribute("label",`${y.label}`),y.value===i&&(S.setAttribute("selected",""),f=S),S.addEventListener("click",()=>{f&&f.removeAttribute("selected"),S.setAttribute("selected",""),f=S,s(y.value,r)}),d.appendChild(S)}),c.appendChild(d),a.appendChild(c);const p=document.createElement("div"),g=document.createElement("h4");g.className="tc-subsection-title",g.textContent="Separator Character:",p.appendChild(g);const _=document.createElement("md-chip-set");_.style.display="flex",_.style.flexWrap="wrap",_.style.gap="8px";const b=document.createElement("md-filter-chip");b.setAttribute("label","Auto-detect"),r||b.setAttribute("selected",""),b.addEventListener("click",()=>{_.querySelectorAll("md-filter-chip").forEach(y=>y.removeAttribute("selected")),b.setAttribute("selected",""),s(i,null)}),_.appendChild(b);const w=["_","-",".","|"," "];return[...new Set([...w,...t||[]])].forEach(y=>{const S=document.createElement("md-filter-chip"),I=y===" "?"Space":y;S.setAttribute("label",I),y===r&&S.setAttribute("selected",""),S.addEventListener("click",()=>{_.querySelectorAll("md-filter-chip").forEach(F=>F.removeAttribute("selected")),S.setAttribute("selected",""),s(i,y)}),_.appendChild(S)}),p.appendChild(_),a.appendChild(p),a}}class fv{constructor(e={}){this.originalColorMap=e,this.taxaColorMap=new Map(Object.entries(e)),this.groupColorMap=new Map}applyColorScheme(e,t,i){const r=ov(e),s=i?this._orderPaletteForMaxDistance(r,t.length):r;t.forEach((o,a)=>{const l=s[a%s.length],c=i?o.name:o;(i?this.groupColorMap:this.taxaColorMap).set(c,l)})}_orderPaletteForMaxDistance(e,t,i="#ffffff"){const r=Array.from(new Set(e)),s=r.map(f=>this._hexToLab(f)),o=this._hexToLab(i),a=r.length;if(a===0)return[];let l=0,c=-1/0;for(let f=0;f<a;f++){const p=this._labDistance(s[f],o);p>c&&(c=p,l=f)}const u=[l],d=new Set(Array.from({length:a},(f,p)=>p).filter(f=>f!==l)),h=Math.min(t,a);for(;u.length<h&&d.size>0;){let f=null,p=-1/0;for(const g of d){const _=Math.min(...u.map(b=>this._labDistance(s[g],s[b])));_>p&&(p=_,f=g)}u.push(f),d.delete(f)}if(t>a)for(;u.length<a&&d.size>0;){let f=null,p=-1/0;for(const g of d){const _=Math.min(...u.map(b=>this._labDistance(s[g],s[b])));_>p&&(p=_,f=g)}u.push(f),d.delete(f)}return u.map(f=>r[f])}_hexToLab(e){const{r:t,g:i,b:r}=this._hexToRgb(e),{x:s,y:o,z:a}=this._rgbToXyz(t,i,r);return this._xyzToLab(s,o,a)}_hexToRgb(e){let t=e.replace("#","");t.length===3&&(t=t.split("").map(r=>r+r).join(""));const i=parseInt(t,16);return{r:i>>16&255,g:i>>8&255,b:i&255}}_rgbToXyz(e,t,i){let[r,s,o]=[e,t,i].map(u=>u/255);[r,s,o]=[r,s,o].map(u=>u<=.04045?u/12.92:Math.pow((u+.055)/1.055,2.4));const a=r*.4124564+s*.3575761+o*.1804375,l=r*.2126729+s*.7151522+o*.072175,c=r*.0193339+s*.119192+o*.9503041;return{x:a,y:l,z:c}}_xyzToLab(e,t,i){let a=this._fxyz(e/.95047),l=this._fxyz(t/1),c=this._fxyz(i/1.08883);const u=116*l-16,d=500*(a-l),h=200*(l-c);return{L:u,a:d,b:h}}_fxyz(e){const t=.20689655172413793;return e>Math.pow(t,3)?Math.cbrt(e):e/(3*t*t)+4/29}_labDistance(e,t){const i=e.L-t.L,r=e.a-t.a,s=e.b-t.b;return Math.sqrt(i*i+r*r+s*s)}getRandomColor(){return`hsl(${Math.floor(Math.random()*360)}, 70%, 60%)`}reset(){this.taxaColorMap=new Map(Object.entries(this.originalColorMap)),this.groupColorMap.clear()}}function pv(n){var e;try{if(!n||n.trim()==="")return{success:!1,error:"CSV file is empty"};const t=n.split(/\r?\n/).filter(h=>h.trim());if(t.length<2)return{success:!1,error:"CSV must contain header and at least one data row"};const r=Ou(t[0]).map(h=>h.trim()),o=r.map(h=>h.toLowerCase()).findIndex(h=>h==="taxon"||h==="taxa"||h==="name"||h==="species"||h==="id");if(o===-1)return{success:!1,error:"CSV must have a taxon/taxa/name/species/id column"};const a=[];if(r.forEach((h,f)=>{f!==o&&h.trim()!==""&&a.push({index:f,name:h,displayName:h.charAt(0).toUpperCase()+h.slice(1)})}),a.length===0)return{success:!1,error:"CSV must have at least one grouping column besides the taxon column"};const l=new Map,c={},u=[];a.forEach(h=>{c[h.name]=new Map});for(let h=1;h<t.length;h++){const f=t[h].trim();if(!f)continue;const p=Ou(f);if(p.length<=o){u.push(`Line ${h+1}: Missing taxon value`);continue}const g=(e=p[o])==null?void 0:e.trim();if(!g){u.push(`Line ${h+1}: Empty taxon value`);continue}const _={};a.forEach(b=>{var w;if(p.length>b.index){const x=((w=p[b.index])==null?void 0:w.trim())||"Unassigned";_[b.name]=x,c[b.name].set(g,x)}}),l.set(g,_)}if(l.size===0)return{success:!1,error:"No valid taxa data found in CSV"};const d={};return a.forEach(h=>{const f=new Map;for(const[p,g]of c[h.name])f.has(g)||f.set(g,[]),f.get(g).push(p);d[h.name]=Array.from(f.entries()).map(([p,g])=>({name:p,count:g.length,members:g}))}),{success:!0,data:{taxaData:l,groupingColumns:a,allGroupings:c,columnGroups:d,totalTaxa:l.size,warnings:u.length>0?u:null}}}catch(t){return{success:!1,error:`Failed to parse CSV: ${t.message}`}}}function Ou(n){const e=[];let t="",i=!1;for(let r=0;r<n.length;r++){const s=n[r],o=n[r+1];s==='"'?i&&o==='"'?(t+='"',r++):i=!i:s===","&&!i?(e.push(t),t=""):t+=s}return e.push(t),e}function xp(n,e){const t=new Set(e),i=[],r=[];for(const[s]of n)t.has(s)?i.push(s):r.push(s);return{isValid:i.length>0,matched:i,unmatched:r,matchPercentage:Math.round(i.length/n.size*100)}}async function gv(n,e){try{const t=await n.text(),i=pv(t);if(!i.success){alert(`Failed to parse CSV: ${i.error}`);return}e.csvData=i.data;const r=i.data.groupingColumns[0].name;e.selectedCSVColumn=r;const s=i.data.allGroupings[r],o=xp(s,e.taxaNames);if(!o.isValid){alert("No matching taxa found in CSV file");return}wp(r,e),e.csvValidation=o,i.data.warnings&&console.warn("CSV parsing warnings:",i.data.warnings),e.updateContent()}catch(t){alert(`Failed to read CSV file: ${t.message}`)}}function wp(n,e){e.csvData&&(e.selectedCSVColumn=n,e.csvGroups=e.csvData.columnGroups[n]||[],e.csvTaxaMap=e.csvData.allGroupings[n]||new Map,e.csvValidation=xp(e.csvTaxaMap,e.taxaNames))}/**
 * @license
 * Copyright 2023 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const mv=tr(Le);class Ft extends mv{get rippleDisabled(){return this.disabled||this.softDisabled}constructor(){super(),this.disabled=!1,this.softDisabled=!1,this.alwaysFocusable=!1,this.label="",this.hasIcon=!1,this.addEventListener("click",this.handleClick.bind(this))}focus(e){this.disabled&&!this.alwaysFocusable||super.focus(e)}render(){return X`
      <div class="container ${Mt(this.getContainerClasses())}">
        ${this.renderContainerContent()}
      </div>
    `}updated(e){e.has("disabled")&&e.get("disabled")!==void 0&&this.dispatchEvent(new Event("update-focus",{bubbles:!0}))}getContainerClasses(){return{disabled:this.disabled||this.softDisabled,"has-icon":this.hasIcon}}renderContainerContent(){return X`
      ${this.renderOutline()}
      <md-focus-ring part="focus-ring" for=${this.primaryId}></md-focus-ring>
      <md-ripple
        for=${this.primaryId}
        ?disabled=${this.rippleDisabled}></md-ripple>
      ${this.renderPrimaryAction(this.renderPrimaryContent())}
    `}renderOutline(){return X`<span class="outline"></span>`}renderLeadingIcon(){return X`<slot name="icon" @slotchange=${this.handleIconChange}></slot>`}renderPrimaryContent(){return X`
      <span class="leading icon" aria-hidden="true">
        ${this.renderLeadingIcon()}
      </span>
      <span class="label">
        <span class="label-text" id="label">
          ${this.label?this.label:X`<slot></slot>`}
        </span>
      </span>
      <span class="touch"></span>
    `}handleIconChange(e){const t=e.target;this.hasIcon=t.assignedElements({flatten:!0}).length>0}handleClick(e){if(this.softDisabled||this.disabled&&this.alwaysFocusable){e.stopImmediatePropagation(),e.preventDefault();return}}}Ft.shadowRootOptions={...Le.shadowRootOptions,delegatesFocus:!0};k([W({type:Boolean,reflect:!0})],Ft.prototype,"disabled",void 0);k([W({type:Boolean,attribute:"soft-disabled",reflect:!0})],Ft.prototype,"softDisabled",void 0);k([W({type:Boolean,attribute:"always-focusable"})],Ft.prototype,"alwaysFocusable",void 0);k([W()],Ft.prototype,"label",void 0);k([W({type:Boolean,reflect:!0,attribute:"has-icon"})],Ft.prototype,"hasIcon",void 0);/**
 * @license
 * Copyright 2023 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */class Tp extends Le{get chips(){return this.childElements.filter(e=>e instanceof Ft)}constructor(){super(),this.internals=this.attachInternals(),this.addEventListener("focusin",this.updateTabIndices.bind(this)),this.addEventListener("update-focus",this.updateTabIndices.bind(this)),this.addEventListener("keydown",this.handleKeyDown.bind(this)),this.internals.role="toolbar"}render(){return X`<slot @slotchange=${this.updateTabIndices}></slot>`}handleKeyDown(e){const t=e.key==="ArrowLeft",i=e.key==="ArrowRight",r=e.key==="Home",s=e.key==="End";if(!t&&!i&&!r&&!s)return;const{chips:o}=this;if(o.length<2)return;if(e.preventDefault(),r||s){const h=r?0:o.length-1;o[h].focus({trailing:s}),this.updateTabIndices();return}const l=getComputedStyle(this).direction==="rtl"?t:i,c=o.find(h=>h.matches(":focus-within"));if(!c){(l?o[0]:o[o.length-1]).focus({trailing:!l}),this.updateTabIndices();return}const u=o.indexOf(c);let d=l?u+1:u-1;for(;d!==u;){d>=o.length?d=0:d<0&&(d=o.length-1);const h=o[d];if(h.disabled&&!h.alwaysFocusable){l?d++:d--;continue}h.focus({trailing:!l}),this.updateTabIndices();break}}updateTabIndices(){const{chips:e}=this;let t;for(const i of e){const r=i.alwaysFocusable||!i.disabled;if(i.matches(":focus-within")&&r){t=i;continue}r&&!t&&(t=i),i.tabIndex=-1}t&&(t.tabIndex=0)}}k([ai()],Tp.prototype,"childElements",void 0);/**
 * @license
 * Copyright 2024 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const _v=me`:host{display:flex;flex-wrap:wrap;gap:8px}
`;/**
 * @license
 * Copyright 2023 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */let Ma=class extends Tp{};Ma.styles=[_v];Ma=k([Ve("md-chip-set")],Ma);/**
 * @license
 * Copyright 2024 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const fc=me`.elevated{--md-elevation-level: var(--_elevated-container-elevation);--md-elevation-shadow-color: var(--_elevated-container-shadow-color)}.elevated::before{background:var(--_elevated-container-color)}.elevated:hover{--md-elevation-level: var(--_elevated-hover-container-elevation)}.elevated:focus-within{--md-elevation-level: var(--_elevated-focus-container-elevation)}.elevated:active{--md-elevation-level: var(--_elevated-pressed-container-elevation)}.elevated.disabled{--md-elevation-level: var(--_elevated-disabled-container-elevation)}.elevated.disabled::before{background:var(--_elevated-disabled-container-color);opacity:var(--_elevated-disabled-container-opacity)}@media(forced-colors: active){.elevated md-elevation{border:1px solid CanvasText}.elevated.disabled md-elevation{border-color:GrayText}}
`;/**
 * @license
 * Copyright 2023 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const yr="aria-label-remove";class yv extends Ft{get ariaLabelRemove(){if(this.hasAttribute(yr))return this.getAttribute(yr);const{ariaLabel:e}=this;return e||this.label?`Remove ${e||this.label}`:null}set ariaLabelRemove(e){const t=this.ariaLabelRemove;e!==t&&(e===null?this.removeAttribute(yr):this.setAttribute(yr,e),this.requestUpdate())}constructor(){super(),this.handleTrailingActionFocus=this.handleTrailingActionFocus.bind(this),this.addEventListener("keydown",this.handleKeyDown.bind(this))}focus(e){if((this.alwaysFocusable||!this.disabled)&&(e!=null&&e.trailing)&&this.trailingAction){this.trailingAction.focus(e);return}super.focus(e)}renderContainerContent(){return X`
      ${super.renderContainerContent()}
      ${this.renderTrailingAction(this.handleTrailingActionFocus)}
    `}handleKeyDown(e){var c,u;const t=e.key==="ArrowLeft",i=e.key==="ArrowRight";if(!t&&!i||!this.primaryAction||!this.trailingAction)return;const s=getComputedStyle(this).direction==="rtl"?t:i,o=(c=this.primaryAction)==null?void 0:c.matches(":focus-within"),a=(u=this.trailingAction)==null?void 0:u.matches(":focus-within");if(s&&a||!s&&o)return;e.preventDefault(),e.stopPropagation(),(s?this.trailingAction:this.primaryAction).focus()}handleTrailingActionFocus(){const{primaryAction:e,trailingAction:t}=this;!e||!t||(e.tabIndex=-1,t.addEventListener("focusout",()=>{e.tabIndex=0},{once:!0}))}}/**
 * @license
 * Copyright 2023 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */function bv({ariaLabel:n,disabled:e,focusListener:t,tabbable:i=!1}){return X`
    <span id="remove-label" hidden aria-hidden="true">Remove</span>
    <button
      class="trailing action"
      aria-label=${n||ne}
      aria-labelledby=${n?ne:"remove-label label"}
      tabindex=${i?ne:-1}
      @click=${vv}
      @focus=${t}>
      <md-focus-ring part="trailing-focus-ring"></md-focus-ring>
      <md-ripple ?disabled=${e}></md-ripple>
      <span class="trailing icon" aria-hidden="true">
        <slot name="remove-trailing-icon">
          <svg viewBox="0 96 960 960">
            <path
              d="m249 849-42-42 231-231-231-231 42-42 231 231 231-231 42 42-231 231 231 231-42 42-231-231-231 231Z" />
          </svg>
        </slot>
      </span>
      <span class="touch"></span>
    </button>
  `}function vv(n){this.disabled||this.softDisabled||(n.stopPropagation(),!this.dispatchEvent(new Event("remove",{cancelable:!0})))||this.remove()}/**
 * @license
 * Copyright 2023 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */class xn extends yv{constructor(){super(...arguments),this.elevated=!1,this.removable=!1,this.selected=!1,this.hasSelectedIcon=!1}get primaryId(){return"button"}getContainerClasses(){return{...super.getContainerClasses(),elevated:this.elevated,selected:this.selected,"has-trailing":this.removable,"has-icon":this.hasIcon||this.selected}}renderPrimaryAction(e){const{ariaLabel:t}=this;return X`
      <button
        class="primary action"
        id="button"
        aria-label=${t||ne}
        aria-pressed=${this.selected}
        aria-disabled=${this.softDisabled||ne}
        ?disabled=${this.disabled&&!this.alwaysFocusable}
        @click=${this.handleClickOnChild}
        >${e}</button
      >
    `}renderLeadingIcon(){return this.selected?X`
      <slot name="selected-icon">
        <svg class="checkmark" viewBox="0 0 18 18" aria-hidden="true">
          <path
            d="M6.75012 12.1274L3.62262 8.99988L2.55762 10.0574L6.75012 14.2499L15.7501 5.24988L14.6926 4.19238L6.75012 12.1274Z" />
        </svg>
      </slot>
    `:super.renderLeadingIcon()}renderTrailingAction(e){return this.removable?bv({focusListener:e,ariaLabel:this.ariaLabelRemove,disabled:this.disabled||this.softDisabled}):ne}renderOutline(){return this.elevated?X`<md-elevation part="elevation"></md-elevation>`:super.renderOutline()}handleClickOnChild(e){if(this.disabled||this.softDisabled)return;const t=this.selected;if(this.selected=!this.selected,!ns(this,e)){this.selected=t;return}}}k([W({type:Boolean})],xn.prototype,"elevated",void 0);k([W({type:Boolean})],xn.prototype,"removable",void 0);k([W({type:Boolean,reflect:!0})],xn.prototype,"selected",void 0);k([W({type:Boolean,reflect:!0,attribute:"has-selected-icon"})],xn.prototype,"hasSelectedIcon",void 0);k([Ke(".primary.action")],xn.prototype,"primaryAction",void 0);k([Ke(".trailing.action")],xn.prototype,"trailingAction",void 0);/**
 * @license
 * Copyright 2024 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const xv=me`:host{--_container-height: var(--md-filter-chip-container-height, 32px);--_disabled-label-text-color: var(--md-filter-chip-disabled-label-text-color, var(--md-sys-color-on-surface, #1d1b20));--_disabled-label-text-opacity: var(--md-filter-chip-disabled-label-text-opacity, 0.38);--_elevated-container-elevation: var(--md-filter-chip-elevated-container-elevation, 1);--_elevated-container-shadow-color: var(--md-filter-chip-elevated-container-shadow-color, var(--md-sys-color-shadow, #000));--_elevated-disabled-container-color: var(--md-filter-chip-elevated-disabled-container-color, var(--md-sys-color-on-surface, #1d1b20));--_elevated-disabled-container-elevation: var(--md-filter-chip-elevated-disabled-container-elevation, 0);--_elevated-disabled-container-opacity: var(--md-filter-chip-elevated-disabled-container-opacity, 0.12);--_elevated-focus-container-elevation: var(--md-filter-chip-elevated-focus-container-elevation, 1);--_elevated-hover-container-elevation: var(--md-filter-chip-elevated-hover-container-elevation, 2);--_elevated-pressed-container-elevation: var(--md-filter-chip-elevated-pressed-container-elevation, 1);--_elevated-selected-container-color: var(--md-filter-chip-elevated-selected-container-color, var(--md-sys-color-secondary-container, #e8def8));--_label-text-font: var(--md-filter-chip-label-text-font, var(--md-sys-typescale-label-large-font, var(--md-ref-typeface-plain, Roboto)));--_label-text-line-height: var(--md-filter-chip-label-text-line-height, var(--md-sys-typescale-label-large-line-height, 1.25rem));--_label-text-size: var(--md-filter-chip-label-text-size, var(--md-sys-typescale-label-large-size, 0.875rem));--_label-text-weight: var(--md-filter-chip-label-text-weight, var(--md-sys-typescale-label-large-weight, var(--md-ref-typeface-weight-medium, 500)));--_selected-focus-label-text-color: var(--md-filter-chip-selected-focus-label-text-color, var(--md-sys-color-on-secondary-container, #1d192b));--_selected-hover-label-text-color: var(--md-filter-chip-selected-hover-label-text-color, var(--md-sys-color-on-secondary-container, #1d192b));--_selected-hover-state-layer-color: var(--md-filter-chip-selected-hover-state-layer-color, var(--md-sys-color-on-secondary-container, #1d192b));--_selected-hover-state-layer-opacity: var(--md-filter-chip-selected-hover-state-layer-opacity, 0.08);--_selected-label-text-color: var(--md-filter-chip-selected-label-text-color, var(--md-sys-color-on-secondary-container, #1d192b));--_selected-pressed-label-text-color: var(--md-filter-chip-selected-pressed-label-text-color, var(--md-sys-color-on-secondary-container, #1d192b));--_selected-pressed-state-layer-color: var(--md-filter-chip-selected-pressed-state-layer-color, var(--md-sys-color-on-surface-variant, #49454f));--_selected-pressed-state-layer-opacity: var(--md-filter-chip-selected-pressed-state-layer-opacity, 0.12);--_elevated-container-color: var(--md-filter-chip-elevated-container-color, var(--md-sys-color-surface-container-low, #f7f2fa));--_disabled-outline-color: var(--md-filter-chip-disabled-outline-color, var(--md-sys-color-on-surface, #1d1b20));--_disabled-outline-opacity: var(--md-filter-chip-disabled-outline-opacity, 0.12);--_disabled-selected-container-color: var(--md-filter-chip-disabled-selected-container-color, var(--md-sys-color-on-surface, #1d1b20));--_disabled-selected-container-opacity: var(--md-filter-chip-disabled-selected-container-opacity, 0.12);--_focus-outline-color: var(--md-filter-chip-focus-outline-color, var(--md-sys-color-on-surface-variant, #49454f));--_outline-color: var(--md-filter-chip-outline-color, var(--md-sys-color-outline, #79747e));--_outline-width: var(--md-filter-chip-outline-width, 1px);--_selected-container-color: var(--md-filter-chip-selected-container-color, var(--md-sys-color-secondary-container, #e8def8));--_selected-outline-width: var(--md-filter-chip-selected-outline-width, 0px);--_focus-label-text-color: var(--md-filter-chip-focus-label-text-color, var(--md-sys-color-on-surface-variant, #49454f));--_hover-label-text-color: var(--md-filter-chip-hover-label-text-color, var(--md-sys-color-on-surface-variant, #49454f));--_hover-state-layer-color: var(--md-filter-chip-hover-state-layer-color, var(--md-sys-color-on-surface-variant, #49454f));--_hover-state-layer-opacity: var(--md-filter-chip-hover-state-layer-opacity, 0.08);--_label-text-color: var(--md-filter-chip-label-text-color, var(--md-sys-color-on-surface-variant, #49454f));--_pressed-label-text-color: var(--md-filter-chip-pressed-label-text-color, var(--md-sys-color-on-surface-variant, #49454f));--_pressed-state-layer-color: var(--md-filter-chip-pressed-state-layer-color, var(--md-sys-color-on-secondary-container, #1d192b));--_pressed-state-layer-opacity: var(--md-filter-chip-pressed-state-layer-opacity, 0.12);--_icon-size: var(--md-filter-chip-icon-size, 18px);--_disabled-leading-icon-color: var(--md-filter-chip-disabled-leading-icon-color, var(--md-sys-color-on-surface, #1d1b20));--_disabled-leading-icon-opacity: var(--md-filter-chip-disabled-leading-icon-opacity, 0.38);--_selected-focus-leading-icon-color: var(--md-filter-chip-selected-focus-leading-icon-color, var(--md-sys-color-on-secondary-container, #1d192b));--_selected-hover-leading-icon-color: var(--md-filter-chip-selected-hover-leading-icon-color, var(--md-sys-color-on-secondary-container, #1d192b));--_selected-leading-icon-color: var(--md-filter-chip-selected-leading-icon-color, var(--md-sys-color-on-secondary-container, #1d192b));--_selected-pressed-leading-icon-color: var(--md-filter-chip-selected-pressed-leading-icon-color, var(--md-sys-color-on-secondary-container, #1d192b));--_focus-leading-icon-color: var(--md-filter-chip-focus-leading-icon-color, var(--md-sys-color-primary, #6750a4));--_hover-leading-icon-color: var(--md-filter-chip-hover-leading-icon-color, var(--md-sys-color-primary, #6750a4));--_leading-icon-color: var(--md-filter-chip-leading-icon-color, var(--md-sys-color-primary, #6750a4));--_pressed-leading-icon-color: var(--md-filter-chip-pressed-leading-icon-color, var(--md-sys-color-primary, #6750a4));--_disabled-trailing-icon-color: var(--md-filter-chip-disabled-trailing-icon-color, var(--md-sys-color-on-surface, #1d1b20));--_disabled-trailing-icon-opacity: var(--md-filter-chip-disabled-trailing-icon-opacity, 0.38);--_selected-focus-trailing-icon-color: var(--md-filter-chip-selected-focus-trailing-icon-color, var(--md-sys-color-on-secondary-container, #1d192b));--_selected-hover-trailing-icon-color: var(--md-filter-chip-selected-hover-trailing-icon-color, var(--md-sys-color-on-secondary-container, #1d192b));--_selected-pressed-trailing-icon-color: var(--md-filter-chip-selected-pressed-trailing-icon-color, var(--md-sys-color-on-secondary-container, #1d192b));--_selected-trailing-icon-color: var(--md-filter-chip-selected-trailing-icon-color, var(--md-sys-color-on-secondary-container, #1d192b));--_focus-trailing-icon-color: var(--md-filter-chip-focus-trailing-icon-color, var(--md-sys-color-on-surface-variant, #49454f));--_hover-trailing-icon-color: var(--md-filter-chip-hover-trailing-icon-color, var(--md-sys-color-on-surface-variant, #49454f));--_pressed-trailing-icon-color: var(--md-filter-chip-pressed-trailing-icon-color, var(--md-sys-color-on-surface-variant, #49454f));--_trailing-icon-color: var(--md-filter-chip-trailing-icon-color, var(--md-sys-color-on-surface-variant, #49454f));--_container-shape-start-start: var(--md-filter-chip-container-shape-start-start, var(--md-filter-chip-container-shape, var(--md-sys-shape-corner-small, 8px)));--_container-shape-start-end: var(--md-filter-chip-container-shape-start-end, var(--md-filter-chip-container-shape, var(--md-sys-shape-corner-small, 8px)));--_container-shape-end-end: var(--md-filter-chip-container-shape-end-end, var(--md-filter-chip-container-shape, var(--md-sys-shape-corner-small, 8px)));--_container-shape-end-start: var(--md-filter-chip-container-shape-end-start, var(--md-filter-chip-container-shape, var(--md-sys-shape-corner-small, 8px)));--_leading-space: var(--md-filter-chip-leading-space, 16px);--_trailing-space: var(--md-filter-chip-trailing-space, 16px);--_icon-label-space: var(--md-filter-chip-icon-label-space, 8px);--_with-leading-icon-leading-space: var(--md-filter-chip-with-leading-icon-leading-space, 8px);--_with-trailing-icon-trailing-space: var(--md-filter-chip-with-trailing-icon-trailing-space, 8px)}.selected.elevated::before{background:var(--_elevated-selected-container-color)}.checkmark{height:var(--_icon-size);width:var(--_icon-size)}.disabled .checkmark{opacity:var(--_disabled-leading-icon-opacity)}@media(forced-colors: active){.disabled .checkmark{opacity:1}}
`;/**
 * @license
 * Copyright 2024 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const wv=me`.selected{--md-ripple-hover-color: var(--_selected-hover-state-layer-color);--md-ripple-hover-opacity: var(--_selected-hover-state-layer-opacity);--md-ripple-pressed-color: var(--_selected-pressed-state-layer-color);--md-ripple-pressed-opacity: var(--_selected-pressed-state-layer-opacity)}:where(.selected)::before{background:var(--_selected-container-color)}:where(.selected) .outline{border-width:var(--_selected-outline-width)}:where(.selected.disabled)::before{background:var(--_disabled-selected-container-color);opacity:var(--_disabled-selected-container-opacity)}:where(.selected) .label{color:var(--_selected-label-text-color)}:where(.selected:hover) .label{color:var(--_selected-hover-label-text-color)}:where(.selected:focus) .label{color:var(--_selected-focus-label-text-color)}:where(.selected:active) .label{color:var(--_selected-pressed-label-text-color)}:where(.selected) .leading.icon{color:var(--_selected-leading-icon-color)}:where(.selected:hover) .leading.icon{color:var(--_selected-hover-leading-icon-color)}:where(.selected:focus) .leading.icon{color:var(--_selected-focus-leading-icon-color)}:where(.selected:active) .leading.icon{color:var(--_selected-pressed-leading-icon-color)}@media(forced-colors: active){:where(.selected:not(.elevated))::before{border:1px solid CanvasText}:where(.selected) .outline{border-width:1px}}
`;/**
 * @license
 * Copyright 2024 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const pc=me`:host{border-start-start-radius:var(--_container-shape-start-start);border-start-end-radius:var(--_container-shape-start-end);border-end-start-radius:var(--_container-shape-end-start);border-end-end-radius:var(--_container-shape-end-end);display:inline-flex;height:var(--_container-height);cursor:pointer;-webkit-tap-highlight-color:rgba(0,0,0,0);--md-ripple-hover-color: var(--_hover-state-layer-color);--md-ripple-hover-opacity: var(--_hover-state-layer-opacity);--md-ripple-pressed-color: var(--_pressed-state-layer-color);--md-ripple-pressed-opacity: var(--_pressed-state-layer-opacity)}:host(:is([disabled],[soft-disabled])){pointer-events:none}:host([touch-target=wrapper]){margin:max(0px,(48px - var(--_container-height))/2) 0}md-focus-ring{--md-focus-ring-shape-start-start: var(--_container-shape-start-start);--md-focus-ring-shape-start-end: var(--_container-shape-start-end);--md-focus-ring-shape-end-end: var(--_container-shape-end-end);--md-focus-ring-shape-end-start: var(--_container-shape-end-start)}.container{border-radius:inherit;box-sizing:border-box;display:flex;height:100%;position:relative;width:100%}.container::before{border-radius:inherit;content:"";inset:0;pointer-events:none;position:absolute}.container:not(.disabled){cursor:pointer}.container.disabled{pointer-events:none}.cell{display:flex}.action{align-items:baseline;appearance:none;background:none;border:none;border-radius:inherit;display:flex;outline:none;padding:0;position:relative;text-decoration:none}.primary.action{min-width:0;padding-inline-start:var(--_leading-space);padding-inline-end:var(--_trailing-space)}.has-icon .primary.action{padding-inline-start:var(--_with-leading-icon-leading-space)}.touch{height:48px;inset:50% 0 0;position:absolute;transform:translateY(-50%);width:100%}:host([touch-target=none]) .touch{display:none}.outline{border:var(--_outline-width) solid var(--_outline-color);border-radius:inherit;inset:0;pointer-events:none;position:absolute}:where(:focus) .outline{border-color:var(--_focus-outline-color)}:where(.disabled) .outline{border-color:var(--_disabled-outline-color);opacity:var(--_disabled-outline-opacity)}md-ripple{border-radius:inherit}.label,.icon,.touch{z-index:1}.label{align-items:center;color:var(--_label-text-color);display:flex;font-family:var(--_label-text-font);font-size:var(--_label-text-size);font-weight:var(--_label-text-weight);height:100%;line-height:var(--_label-text-line-height);overflow:hidden;user-select:none}.label-text{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}:where(:hover) .label{color:var(--_hover-label-text-color)}:where(:focus) .label{color:var(--_focus-label-text-color)}:where(:active) .label{color:var(--_pressed-label-text-color)}:where(.disabled) .label{color:var(--_disabled-label-text-color);opacity:var(--_disabled-label-text-opacity)}.icon{align-self:center;display:flex;fill:currentColor;position:relative}.icon ::slotted(:first-child){font-size:var(--_icon-size);height:var(--_icon-size);width:var(--_icon-size)}.leading.icon{color:var(--_leading-icon-color)}.leading.icon ::slotted(*),.leading.icon svg{margin-inline-end:var(--_icon-label-space)}:where(:hover) .leading.icon{color:var(--_hover-leading-icon-color)}:where(:focus) .leading.icon{color:var(--_focus-leading-icon-color)}:where(:active) .leading.icon{color:var(--_pressed-leading-icon-color)}:where(.disabled) .leading.icon{color:var(--_disabled-leading-icon-color);opacity:var(--_disabled-leading-icon-opacity)}@media(forced-colors: active){:where(.disabled) :is(.label,.outline,.leading.icon){color:GrayText;opacity:1}}a,button{text-transform:inherit}a,button:not(:disabled,[aria-disabled=true]){cursor:inherit}
`;/**
 * @license
 * Copyright 2024 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const Tv=me`.trailing.action{align-items:center;justify-content:center;padding-inline-start:var(--_icon-label-space);padding-inline-end:var(--_with-trailing-icon-trailing-space)}.trailing.action :is(md-ripple,md-focus-ring){border-radius:50%;height:calc(1.3333333333*var(--_icon-size));width:calc(1.3333333333*var(--_icon-size))}.trailing.action md-focus-ring{inset:unset}.has-trailing .primary.action{padding-inline-end:0}.trailing.icon{color:var(--_trailing-icon-color);height:var(--_icon-size);width:var(--_icon-size)}:where(:hover) .trailing.icon{color:var(--_hover-trailing-icon-color)}:where(:focus) .trailing.icon{color:var(--_focus-trailing-icon-color)}:where(:active) .trailing.icon{color:var(--_pressed-trailing-icon-color)}:where(.disabled) .trailing.icon{color:var(--_disabled-trailing-icon-color);opacity:var(--_disabled-trailing-icon-opacity)}:where(.selected) .trailing.icon{color:var(--_selected-trailing-icon-color)}:where(.selected:hover) .trailing.icon{color:var(--_selected-hover-trailing-icon-color)}:where(.selected:focus) .trailing.icon{color:var(--_selected-focus-trailing-icon-color)}:where(.selected:active) .trailing.icon{color:var(--_selected-pressed-trailing-icon-color)}@media(forced-colors: active){.trailing.icon{color:ButtonText}:where(.disabled) .trailing.icon{color:GrayText;opacity:1}}
`;/**
 * @license
 * Copyright 2023 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */let ka=class extends xn{};ka.styles=[pc,fc,Tv,wv,xv];ka=k([Ve("md-filter-chip")],ka);/**
 * @license
 * Copyright 2023 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */function Sp(n,e=Dt){const t=gc(n,e);return t&&(t.tabIndex=0,t.focus()),t}function Ep(n,e=Dt){const t=Ap(n,e);return t&&(t.tabIndex=0,t.focus()),t}function Ai(n,e=Dt){for(let t=0;t<n.length;t++){const i=n[t];if(i.tabIndex===0&&e(i))return{item:i,index:t}}return null}function gc(n,e=Dt){for(const t of n)if(e(t))return t;return null}function Ap(n,e=Dt){for(let t=n.length-1;t>=0;t--){const i=n[t];if(e(i))return i}return null}function Sv(n,e,t=Dt,i=!0){for(let r=1;r<n.length;r++){const s=(r+e)%n.length;if(s<e&&!i)return null;const o=n[s];if(t(o))return o}return n[e]?n[e]:null}function Ev(n,e,t=Dt,i=!0){for(let r=1;r<n.length;r++){const s=(e-r+n.length)%n.length;if(s>e&&!i)return null;const o=n[s];if(t(o))return o}return n[e]?n[e]:null}function Nu(n,e,t=Dt,i=!0){if(e){const r=Sv(n,e.index,t,i);return r&&(r.tabIndex=0,r.focus()),r}else return Sp(n,t)}function Fu(n,e,t=Dt,i=!0){if(e){const r=Ev(n,e.index,t,i);return r&&(r.tabIndex=0,r.focus()),r}else return Ep(n,t)}function Av(){return new Event("request-activation",{bubbles:!0,composed:!0})}function Dt(n){return!n.disabled}/**
 * @license
 * Copyright 2023 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const Pe={ArrowDown:"ArrowDown",ArrowLeft:"ArrowLeft",ArrowUp:"ArrowUp",ArrowRight:"ArrowRight",Home:"Home",End:"End"};class Cp{constructor(e){this.handleKeydown=u=>{const d=u.key;if(u.defaultPrevented||!this.isNavigableKey(d))return;const h=this.items;if(!h.length)return;const f=Ai(h,this.isActivatable);u.preventDefault();const p=this.isRtl(),g=p?Pe.ArrowRight:Pe.ArrowLeft,_=p?Pe.ArrowLeft:Pe.ArrowRight;let b=null;switch(d){case Pe.ArrowDown:case _:b=Nu(h,f,this.isActivatable,this.wrapNavigation());break;case Pe.ArrowUp:case g:b=Fu(h,f,this.isActivatable,this.wrapNavigation());break;case Pe.Home:b=Sp(h,this.isActivatable);break;case Pe.End:b=Ep(h,this.isActivatable);break}b&&f&&f.item!==b&&(f.item.tabIndex=-1)},this.onDeactivateItems=()=>{const u=this.items;for(const d of u)this.deactivateItem(d)},this.onRequestActivation=u=>{this.onDeactivateItems();const d=u.target;this.activateItem(d),d.focus()},this.onSlotchange=()=>{const u=this.items;let d=!1;for(const f of u){if(!f.disabled&&f.tabIndex>-1&&!d){d=!0,f.tabIndex=0;continue}f.tabIndex=-1}if(d)return;const h=gc(u,this.isActivatable);h&&(h.tabIndex=0)};const{isItem:t,getPossibleItems:i,isRtl:r,deactivateItem:s,activateItem:o,isNavigableKey:a,isActivatable:l,wrapNavigation:c}=e;this.isItem=t,this.getPossibleItems=i,this.isRtl=r,this.deactivateItem=s,this.activateItem=o,this.isNavigableKey=a,this.isActivatable=l,this.wrapNavigation=c??(()=>!0)}get items(){const e=this.getPossibleItems(),t=[];for(const i of e){if(this.isItem(i)){t.push(i);continue}const s=i.item;s&&this.isItem(s)&&t.push(s)}return t}activateNextItem(){const e=this.items,t=Ai(e,this.isActivatable);return t&&(t.item.tabIndex=-1),Nu(e,t,this.isActivatable,this.wrapNavigation())}activatePreviousItem(){const e=this.items,t=Ai(e,this.isActivatable);return t&&(t.item.tabIndex=-1),Fu(e,t,this.isActivatable,this.wrapNavigation())}}/**
 * @license
 * Copyright 2021 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const Cv=new Set(Object.values(Pe));class Ip extends Le{get items(){return this.listController.items}constructor(){super(),this.listController=new Cp({isItem:e=>e.hasAttribute("md-list-item"),getPossibleItems:()=>this.slotItems,isRtl:()=>getComputedStyle(this).direction==="rtl",deactivateItem:e=>{e.tabIndex=-1},activateItem:e=>{e.tabIndex=0},isNavigableKey:e=>Cv.has(e),isActivatable:e=>!e.disabled&&e.type!=="text"}),this.internals=this.attachInternals(),this.internals.role="list",this.addEventListener("keydown",this.listController.handleKeydown)}render(){return X`
      <slot
        @deactivate-items=${this.listController.onDeactivateItems}
        @request-activation=${this.listController.onRequestActivation}
        @slotchange=${this.listController.onSlotchange}>
      </slot>
    `}activateNextItem(){return this.listController.activateNextItem()}activatePreviousItem(){return this.listController.activatePreviousItem()}}k([ai({flatten:!0})],Ip.prototype,"slotItems",void 0);/**
 * @license
 * Copyright 2024 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const Iv=me`:host{background:var(--md-list-container-color, var(--md-sys-color-surface, #fef7ff));color:unset;display:flex;flex-direction:column;outline:none;padding:8px 0;position:relative}
`;/**
 * @license
 * Copyright 2021 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */let Oa=class extends Ip{};Oa.styles=[Iv];Oa=k([Ve("md-list")],Oa);/**
 * @license
 * Copyright 2023 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */class mc extends Le{constructor(){super(...arguments),this.multiline=!1}render(){return X`
      <slot name="container"></slot>
      <slot class="non-text" name="start"></slot>
      <div class="text">
        <slot name="overline" @slotchange=${this.handleTextSlotChange}></slot>
        <slot
          class="default-slot"
          @slotchange=${this.handleTextSlotChange}></slot>
        <slot name="headline" @slotchange=${this.handleTextSlotChange}></slot>
        <slot
          name="supporting-text"
          @slotchange=${this.handleTextSlotChange}></slot>
      </div>
      <slot class="non-text" name="trailing-supporting-text"></slot>
      <slot class="non-text" name="end"></slot>
    `}handleTextSlotChange(){let e=!1,t=0;for(const i of this.textSlots)if(Rv(i)&&(t+=1),t>1){e=!0;break}this.multiline=e}}k([W({type:Boolean,reflect:!0})],mc.prototype,"multiline",void 0);k([eb(".text slot")],mc.prototype,"textSlots",void 0);function Rv(n){var e;for(const t of n.assignedNodes({flatten:!0})){const i=t.nodeType===Node.ELEMENT_NODE,r=t.nodeType===Node.TEXT_NODE&&((e=t.textContent)==null?void 0:e.match(/\S/));if(i||r)return!0}return!1}/**
 * @license
 * Copyright 2024 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const Pv=me`:host{color:var(--md-sys-color-on-surface, #1d1b20);font-family:var(--md-sys-typescale-body-large-font, var(--md-ref-typeface-plain, Roboto));font-size:var(--md-sys-typescale-body-large-size, 1rem);font-weight:var(--md-sys-typescale-body-large-weight, var(--md-ref-typeface-weight-regular, 400));line-height:var(--md-sys-typescale-body-large-line-height, 1.5rem);align-items:center;box-sizing:border-box;display:flex;gap:16px;min-height:56px;overflow:hidden;padding:12px 16px;position:relative;text-overflow:ellipsis}:host([multiline]){min-height:72px}[name=overline]{color:var(--md-sys-color-on-surface-variant, #49454f);font-family:var(--md-sys-typescale-label-small-font, var(--md-ref-typeface-plain, Roboto));font-size:var(--md-sys-typescale-label-small-size, 0.6875rem);font-weight:var(--md-sys-typescale-label-small-weight, var(--md-ref-typeface-weight-medium, 500));line-height:var(--md-sys-typescale-label-small-line-height, 1rem)}[name=supporting-text]{color:var(--md-sys-color-on-surface-variant, #49454f);font-family:var(--md-sys-typescale-body-medium-font, var(--md-ref-typeface-plain, Roboto));font-size:var(--md-sys-typescale-body-medium-size, 0.875rem);font-weight:var(--md-sys-typescale-body-medium-weight, var(--md-ref-typeface-weight-regular, 400));line-height:var(--md-sys-typescale-body-medium-line-height, 1.25rem)}[name=trailing-supporting-text]{color:var(--md-sys-color-on-surface-variant, #49454f);font-family:var(--md-sys-typescale-label-small-font, var(--md-ref-typeface-plain, Roboto));font-size:var(--md-sys-typescale-label-small-size, 0.6875rem);font-weight:var(--md-sys-typescale-label-small-weight, var(--md-ref-typeface-weight-medium, 500));line-height:var(--md-sys-typescale-label-small-line-height, 1rem)}[name=container]::slotted(*){inset:0;position:absolute}.default-slot{display:inline}.default-slot,.text ::slotted(*){overflow:hidden;text-overflow:ellipsis}.text{display:flex;flex:1;flex-direction:column;overflow:hidden}
`;/**
 * @license
 * Copyright 2023 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */let Na=class extends mc{};Na.styles=[Pv];Na=k([Ve("md-item")],Na);/**
 * @license
 * Copyright 2022 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const Mv=tr(Le);class Jt extends Mv{constructor(){super(...arguments),this.disabled=!1,this.type="text",this.isListItem=!0,this.href="",this.target=""}get isDisabled(){return this.disabled&&this.type!=="link"}willUpdate(e){this.href&&(this.type="link"),super.willUpdate(e)}render(){return this.renderListItem(X`
      <md-item>
        <div slot="container">
          ${this.renderRipple()} ${this.renderFocusRing()}
        </div>
        <slot name="start" slot="start"></slot>
        <slot name="end" slot="end"></slot>
        ${this.renderBody()}
      </md-item>
    `)}renderListItem(e){const t=this.type==="link";let i;switch(this.type){case"link":i=zr`a`;break;case"button":i=zr`button`;break;default:case"text":i=zr`li`;break}const r=this.type!=="text",s=t&&this.target?this.target:ne;return np`
      <${i}
        id="item"
        tabindex="${this.isDisabled||!r?-1:0}"
        ?disabled=${this.isDisabled}
        role="listitem"
        aria-selected=${this.ariaSelected||ne}
        aria-checked=${this.ariaChecked||ne}
        aria-expanded=${this.ariaExpanded||ne}
        aria-haspopup=${this.ariaHasPopup||ne}
        class="list-item ${Mt(this.getRenderClasses())}"
        href=${this.href||ne}
        target=${s}
        @focus=${this.onFocus}
      >${e}</${i}>
    `}renderRipple(){return this.type==="text"?ne:X` <md-ripple
      part="ripple"
      for="item"
      ?disabled=${this.isDisabled}></md-ripple>`}renderFocusRing(){return this.type==="text"?ne:X` <md-focus-ring
      @visibility-changed=${this.onFocusRingVisibilityChanged}
      part="focus-ring"
      for="item"
      inward></md-focus-ring>`}onFocusRingVisibilityChanged(e){}getRenderClasses(){return{disabled:this.isDisabled}}renderBody(){return X`
      <slot></slot>
      <slot name="overline" slot="overline"></slot>
      <slot name="headline" slot="headline"></slot>
      <slot name="supporting-text" slot="supporting-text"></slot>
      <slot
        name="trailing-supporting-text"
        slot="trailing-supporting-text"></slot>
    `}onFocus(){this.tabIndex===-1&&this.dispatchEvent(Av())}focus(){var e;(e=this.listItemRoot)==null||e.focus()}click(){if(!this.listItemRoot){super.click();return}this.listItemRoot.click()}}Jt.shadowRootOptions={...Le.shadowRootOptions,delegatesFocus:!0};k([W({type:Boolean,reflect:!0})],Jt.prototype,"disabled",void 0);k([W({reflect:!0})],Jt.prototype,"type",void 0);k([W({type:Boolean,attribute:"md-list-item",reflect:!0})],Jt.prototype,"isListItem",void 0);k([W()],Jt.prototype,"href",void 0);k([W()],Jt.prototype,"target",void 0);k([Ke(".list-item")],Jt.prototype,"listItemRoot",void 0);/**
 * @license
 * Copyright 2024 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const kv=me`:host{display:flex;-webkit-tap-highlight-color:rgba(0,0,0,0);--md-ripple-hover-color: var(--md-list-item-hover-state-layer-color, var(--md-sys-color-on-surface, #1d1b20));--md-ripple-hover-opacity: var(--md-list-item-hover-state-layer-opacity, 0.08);--md-ripple-pressed-color: var(--md-list-item-pressed-state-layer-color, var(--md-sys-color-on-surface, #1d1b20));--md-ripple-pressed-opacity: var(--md-list-item-pressed-state-layer-opacity, 0.12)}:host(:is([type=button]:not([disabled]),[type=link])){cursor:pointer}md-focus-ring{z-index:1;--md-focus-ring-shape: 8px}a,button,li{background:none;border:none;cursor:inherit;padding:0;margin:0;text-align:unset;text-decoration:none}.list-item{border-radius:inherit;display:flex;flex:1;max-width:inherit;min-width:inherit;outline:none;-webkit-tap-highlight-color:rgba(0,0,0,0);width:100%}.list-item.interactive{cursor:pointer}.list-item.disabled{opacity:var(--md-list-item-disabled-opacity, 0.3);pointer-events:none}[slot=container]{pointer-events:none}md-ripple{border-radius:inherit}md-item{border-radius:inherit;flex:1;height:100%;color:var(--md-list-item-label-text-color, var(--md-sys-color-on-surface, #1d1b20));font-family:var(--md-list-item-label-text-font, var(--md-sys-typescale-body-large-font, var(--md-ref-typeface-plain, Roboto)));font-size:var(--md-list-item-label-text-size, var(--md-sys-typescale-body-large-size, 1rem));line-height:var(--md-list-item-label-text-line-height, var(--md-sys-typescale-body-large-line-height, 1.5rem));font-weight:var(--md-list-item-label-text-weight, var(--md-sys-typescale-body-large-weight, var(--md-ref-typeface-weight-regular, 400)));min-height:var(--md-list-item-one-line-container-height, 56px);padding-top:var(--md-list-item-top-space, 12px);padding-bottom:var(--md-list-item-bottom-space, 12px);padding-inline-start:var(--md-list-item-leading-space, 16px);padding-inline-end:var(--md-list-item-trailing-space, 16px)}md-item[multiline]{min-height:var(--md-list-item-two-line-container-height, 72px)}[slot=supporting-text]{color:var(--md-list-item-supporting-text-color, var(--md-sys-color-on-surface-variant, #49454f));font-family:var(--md-list-item-supporting-text-font, var(--md-sys-typescale-body-medium-font, var(--md-ref-typeface-plain, Roboto)));font-size:var(--md-list-item-supporting-text-size, var(--md-sys-typescale-body-medium-size, 0.875rem));line-height:var(--md-list-item-supporting-text-line-height, var(--md-sys-typescale-body-medium-line-height, 1.25rem));font-weight:var(--md-list-item-supporting-text-weight, var(--md-sys-typescale-body-medium-weight, var(--md-ref-typeface-weight-regular, 400)))}[slot=trailing-supporting-text]{color:var(--md-list-item-trailing-supporting-text-color, var(--md-sys-color-on-surface-variant, #49454f));font-family:var(--md-list-item-trailing-supporting-text-font, var(--md-sys-typescale-label-small-font, var(--md-ref-typeface-plain, Roboto)));font-size:var(--md-list-item-trailing-supporting-text-size, var(--md-sys-typescale-label-small-size, 0.6875rem));line-height:var(--md-list-item-trailing-supporting-text-line-height, var(--md-sys-typescale-label-small-line-height, 1rem));font-weight:var(--md-list-item-trailing-supporting-text-weight, var(--md-sys-typescale-label-small-weight, var(--md-ref-typeface-weight-medium, 500)))}:is([slot=start],[slot=end])::slotted(*){fill:currentColor}[slot=start]{color:var(--md-list-item-leading-icon-color, var(--md-sys-color-on-surface-variant, #49454f))}[slot=end]{color:var(--md-list-item-trailing-icon-color, var(--md-sys-color-on-surface-variant, #49454f))}@media(forced-colors: active){.disabled slot{color:GrayText}.list-item.disabled{color:GrayText;opacity:1}}
`;/**
 * @license
 * Copyright 2022 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */let Fa=class extends Jt{};Fa.styles=[kv];Fa=k([Ve("md-list-item")],Fa);/**
 * @license
 * Copyright 2023 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */class fo extends Le{constructor(){super(...arguments),this.inset=!1,this.insetStart=!1,this.insetEnd=!1}}k([W({type:Boolean,reflect:!0})],fo.prototype,"inset",void 0);k([W({type:Boolean,reflect:!0,attribute:"inset-start"})],fo.prototype,"insetStart",void 0);k([W({type:Boolean,reflect:!0,attribute:"inset-end"})],fo.prototype,"insetEnd",void 0);/**
 * @license
 * Copyright 2024 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const Ov=me`:host{box-sizing:border-box;color:var(--md-divider-color, var(--md-sys-color-outline-variant, #cac4d0));display:flex;height:var(--md-divider-thickness, 1px);width:100%}:host([inset]),:host([inset-start]){padding-inline-start:16px}:host([inset]),:host([inset-end]){padding-inline-end:16px}:host::before{background:currentColor;content:"";height:100%;width:100%}@media(forced-colors: active){:host::before{background:CanvasText}}
`;/**
 * @license
 * Copyright 2023 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */let Da=class extends fo{};Da.styles=[Ov];Da=k([Ve("md-divider")],Da);const Ct=class Ct{constructor(e,t,i){Ct.currentInstance&&(Ct.currentInstance.close(),Ct.currentInstance=null),Ct.currentInstance=this,this.taxaNames=e||[],this.onComplete=i||(()=>{}),this.currentMode="taxa",this.selectedSeparator=null,this.selectedStrategy="prefix",this.colorManager=new fv(t),this.currentGroups=[],this.cachedSeparators=null,this.csvGroups=[],this.csvTaxaMap=new Map,this.csvData=null,this.selectedCSVColumn=null,this.createWindow()}async createWindow(){try{const{windowContent:e,colorWin:t}=await Ee.createColorAssignmentWindow(()=>this.handleClose());this.winBoxInstance=t,this.container=e,this.render()}catch(e){console.error("Failed to create taxa coloring window:",e),alert(`Failed to open taxa coloring window: ${e.message}`)}}render(){this.container.innerHTML="",this.container.className="tc-container";const e=document.createElement("header");e.className="tc-header";const t=document.createElement("h1");t.className="tc-title",t.textContent="Taxa Color Assignment",e.appendChild(t),this.contentArea=document.createElement("main"),this.contentArea.className="tc-content";const i=document.createElement("footer");i.className="tc-actions",this.renderActions(i),this.container.append(e,this.contentArea,i),this.updateContent()}updateContent(){this.contentArea.innerHTML="";const e=Ee.createModeSelector({currentMode:this.currentMode,onModeChange:t=>{this.currentMode=t,this.updateContent()}});this.contentArea.appendChild(e),this.currentMode==="taxa"?this.renderTaxaLayout():this.currentMode==="groups"?this.renderGroupsLayout():this.currentMode==="csv"&&this.renderCSVLayout()}renderTaxaLayout(){if(!this.taxaNames.length){this.renderEmptyState("No taxa available for coloring.");return}const e=document.createDocumentFragment(),t=Ee.createColorSchemeSelector({onSchemeChange:r=>this.applyColorScheme(r,this.taxaNames,!1)});e.appendChild(t);const i=Ee.createTaxaColorSection(this.taxaNames,this.colorManager);e.appendChild(i),this.contentArea.appendChild(e)}renderGroupsLayout(){const e=document.createDocumentFragment(),t=Ee.createGroupingStrategySelector({taxaNames:this.taxaNames,cachedSeparators:this.cachedSeparators,selectedStrategy:this.selectedStrategy,selectedSeparator:this.selectedSeparator,onStrategyChange:(i,r)=>{this.selectedStrategy=i,this.selectedSeparator=r,this.updateGroups()},onCacheSeparators:i=>{this.cachedSeparators=i}});if(e.appendChild(t),!this.currentGroups.length)this.renderEmptyState("No groups found with current settings.");else{const i=Ee.createColorSchemeSelector({onSchemeChange:a=>this.applyColorScheme(a,this.currentGroups,!0)}),r=document.createElement("div");r.className="tc-section";const s=document.createElement("h3");s.className="tc-section-title",s.textContent=`Group Colors (${this.currentGroups.length})`,r.appendChild(s);const o=Ee.createColorInputGrid();this.currentGroups.forEach(a=>{const l=this.colorManager.groupColorMap.get(a.name)||this.colorManager.getRandomColor();this.colorManager.groupColorMap.has(a.name)||this.colorManager.groupColorMap.set(a.name,l);const c=Ee.createColorInput(`${a.name} (${a.count})`,l,u=>this.colorManager.groupColorMap.set(a.name,u));o.appendChild(c)}),r.appendChild(o),e.append(i,r)}this.contentArea.appendChild(e)}renderCSVLayout(){const e=document.createDocumentFragment(),t=Ee.createCSVUploadSection(i=>this.handleCSVFile(i));if(e.appendChild(t),this.csvData&&this.csvGroups.length>0){if(this.csvData.groupingColumns.length>1){const o=Ee.createColumnSelector({groupingColumns:this.csvData.groupingColumns,columnGroups:this.csvData.columnGroups,selectedColumn:this.selectedCSVColumn,onColumnChange:a=>{this.updateCSVGroups(a),this.updateContent()}});e.appendChild(o)}const i=Ee.createCSVPreviewSection(this.csvValidation,this.csvGroups);e.appendChild(i);const r=Ee.createColorSchemeSelector({onSchemeChange:o=>this.applyColorScheme(o,this.csvGroups,!0)});e.appendChild(r);const s=Ee.createCSVColorSection(this.csvGroups,this.colorManager);e.appendChild(s)}this.contentArea.appendChild(e)}async handleCSVFile(e){await gv(e,this)}updateGroups(){if(!this.selectedStrategy){this.currentGroups=[],this.updateContent();return}const e=ku(this.selectedStrategy),t=uv(this.taxaNames,this.selectedSeparator,e);t.groups?(this.currentGroups=t.groups,t.analyzed&&t.separator&&(this.selectedSeparator=t.separator)):this.currentGroups=t,this.updateContent()}updateCSVGroups(e){wp(e,this)}renderEmptyState(e){const t=document.createElement("div");t.className="tc-empty-state";const i=document.createElement("md-icon");i.className="tc-empty-state-icon",i.textContent="info";const r=document.createElement("p");r.className="tc-empty-state-message",r.textContent=e,t.appendChild(i),t.appendChild(r),this.contentArea.appendChild(t)}renderActions(e){e.innerHTML="";const t=document.createElement("md-outlined-button");t.textContent="Reset",t.addEventListener("click",()=>this.reset());const i=document.createElement("md-filled-button");i.textContent="Apply",i.addEventListener("click",()=>this.apply()),e.appendChild(t),e.appendChild(i)}reset(){this.colorManager.reset(),this.updateContent()}applyColorScheme(e,t,i){this.colorManager.applyColorScheme(e,t,i),this.updateContent()}apply(){const e={mode:this.currentMode,taxaColorMap:this.colorManager.taxaColorMap,groupColorMap:this.colorManager.groupColorMap,separator:this.selectedSeparator,strategyType:ku(this.selectedStrategy),csvTaxaMap:this.csvTaxaMap,csvGroups:this.csvGroups,csvColumn:this.selectedCSVColumn};this.onComplete(e),this.winBoxInstance.close()}handleClose(){Ct.currentInstance===this&&(Ct.currentInstance=null)}close(){this.winBoxInstance&&this.winBoxInstance.close(),this.handleClose()}};m(Ct,"currentInstance",null);let Ba=Ct;function Du(n){const e=document.getElementById("taxaLegend");if(!e)return;if(e.innerHTML="",!n||n.mode==="taxa"){e.style.display="none";return}const t=n.groupColorMap||{},i=Object.keys(t);if(!i.length){e.style.display="none";return}e.style.display="flex";const r=document.createDocumentFragment();i.forEach(s=>{const o=t[s]||"#666",a=document.createElement("div");a.className="taxa-legend-chip",a.innerHTML=`<span class="swatch" style="background:${o}"></span><span class="label" title="${s}">${s}</span>`,r.appendChild(a)}),e.appendChild(r)}try{const n=M;let e=n.getState().taxaGrouping;Du(e),n.subscribe(t=>{t.taxaGrouping!==e&&(e=t.taxaGrouping,Du(t.taxaGrouping))})}catch{}function Vr(n,e){return n==null||e==null?NaN:n<e?-1:n>e?1:n>=e?0:NaN}function Nv(n,e){return n==null||e==null?NaN:e<n?-1:e>n?1:e>=n?0:NaN}function Rp(n){let e,t,i;n.length!==2?(e=Vr,t=(a,l)=>Vr(n(a),l),i=(a,l)=>n(a)-l):(e=n===Vr||n===Nv?n:Fv,t=n,i=n);function r(a,l,c=0,u=a.length){if(c<u){if(e(l,l)!==0)return u;do{const d=c+u>>>1;t(a[d],l)<0?c=d+1:u=d}while(c<u)}return c}function s(a,l,c=0,u=a.length){if(c<u){if(e(l,l)!==0)return u;do{const d=c+u>>>1;t(a[d],l)<=0?c=d+1:u=d}while(c<u)}return c}function o(a,l,c=0,u=a.length){const d=r(a,l,c,u-1);return d>c&&i(a[d-1],l)>-i(a[d],l)?d-1:d}return{left:r,center:o,right:s}}function Fv(){return 0}function Dv(n){return n===null?NaN:+n}const Bv=Rp(Vr),Lv=Bv.right;Rp(Dv).center;const Uv=Lv;function $v(n,e){let t,i;if(e===void 0)for(const r of n)r!=null&&(t===void 0?r>=r&&(t=i=r):(t>r&&(t=r),i<r&&(i=r)));else{let r=-1;for(let s of n)(s=e(s,++r,n))!=null&&(t===void 0?s>=s&&(t=i=s):(t>s&&(t=s),i<s&&(i=s)))}return[t,i]}const zv=Math.sqrt(50),Vv=Math.sqrt(10),Wv=Math.sqrt(2);function ss(n,e,t){const i=(e-n)/Math.max(0,t),r=Math.floor(Math.log10(i)),s=i/Math.pow(10,r),o=s>=zv?10:s>=Vv?5:s>=Wv?2:1;let a,l,c;return r<0?(c=Math.pow(10,-r)/o,a=Math.round(n*c),l=Math.round(e*c),a/c<n&&++a,l/c>e&&--l,c=-c):(c=Math.pow(10,r)*o,a=Math.round(n/c),l=Math.round(e/c),a*c<n&&++a,l*c>e&&--l),l<a&&.5<=t&&t<2?ss(n,e,t*2):[a,l,c]}function Hv(n,e,t){if(e=+e,n=+n,t=+t,!(t>0))return[];if(n===e)return[n];const i=e<n,[r,s,o]=i?ss(e,n,t):ss(n,e,t);if(!(s>=r))return[];const a=s-r+1,l=new Array(a);if(i)if(o<0)for(let c=0;c<a;++c)l[c]=(s-c)/-o;else for(let c=0;c<a;++c)l[c]=(s-c)*o;else if(o<0)for(let c=0;c<a;++c)l[c]=(r+c)/-o;else for(let c=0;c<a;++c)l[c]=(r+c)*o;return l}function La(n,e,t){return e=+e,n=+n,t=+t,ss(n,e,t)[2]}function jv(n,e,t){e=+e,n=+n,t=+t;const i=e<n,r=i?La(e,n,t):La(n,e,t);return(i?-1:1)*(r<0?1/-r:r)}function Xv(n,e){let t;if(e===void 0)for(const i of n)i!=null&&(t<i||t===void 0&&i>=i)&&(t=i);else{let i=-1;for(let r of n)(r=e(r,++i,n))!=null&&(t<r||t===void 0&&r>=r)&&(t=r)}return t}function Yv(n,e,t){n=+n,e=+e,t=(r=arguments.length)<2?(e=n,n=0,1):r<3?1:+t;for(var i=-1,r=Math.max(0,Math.ceil((e-n)/t))|0,s=new Array(r);++i<r;)s[i]=n+i*t;return s}function qv(n){return n}var No=1,Fo=2,Ua=3,mi=4,Bu=1e-6;function Kv(n){return"translate("+n+",0)"}function Zv(n){return"translate(0,"+n+")"}function Gv(n){return e=>+n(e)}function Qv(n,e){return e=Math.max(0,n.bandwidth()-e*2)/2,n.round()&&(e=Math.round(e)),t=>+n(t)+e}function Jv(){return!this.__axis}function Pp(n,e){var t=[],i=null,r=null,s=6,o=6,a=3,l=typeof window<"u"&&window.devicePixelRatio>1?0:.5,c=n===No||n===mi?-1:1,u=n===mi||n===Fo?"x":"y",d=n===No||n===Ua?Kv:Zv;function h(f){var p=i??(e.ticks?e.ticks.apply(e,t):e.domain()),g=r??(e.tickFormat?e.tickFormat.apply(e,t):qv),_=Math.max(s,0)+a,b=e.range(),w=+b[0]+l,x=+b[b.length-1]+l,y=(e.bandwidth?Qv:Gv)(e.copy(),l),S=f.selection?f.selection():f,I=S.selectAll(".domain").data([null]),F=S.selectAll(".tick").data(p,e).order(),D=F.exit(),B=F.enter().append("g").attr("class","tick"),U=F.select("line"),O=F.select("text");I=I.merge(I.enter().insert("path",".tick").attr("class","domain").attr("stroke","currentColor")),F=F.merge(B),U=U.merge(B.append("line").attr("stroke","currentColor").attr(u+"2",c*s)),O=O.merge(B.append("text").attr("fill","currentColor").attr(u,c*_).attr("dy",n===No?"0em":n===Ua?"0.71em":"0.32em")),f!==S&&(I=I.transition(f),F=F.transition(f),U=U.transition(f),O=O.transition(f),D=D.transition(f).attr("opacity",Bu).attr("transform",function(H){return isFinite(H=y(H))?d(H+l):this.getAttribute("transform")}),B.attr("opacity",Bu).attr("transform",function(H){var $=this.parentNode.__axis;return d(($&&isFinite($=$(H))?$:y(H))+l)})),D.remove(),I.attr("d",n===mi||n===Fo?o?"M"+c*o+","+w+"H"+l+"V"+x+"H"+c*o:"M"+l+","+w+"V"+x:o?"M"+w+","+c*o+"V"+l+"H"+x+"V"+c*o:"M"+w+","+l+"H"+x),F.attr("opacity",1).attr("transform",function(H){return d(y(H)+l)}),U.attr(u+"2",c*s),O.attr(u,c*_).text(g),S.filter(Jv).attr("fill","none").attr("font-size",10).attr("font-family","sans-serif").attr("text-anchor",n===Fo?"start":n===mi?"end":"middle"),S.each(function(){this.__axis=y})}return h.scale=function(f){return arguments.length?(e=f,h):e},h.ticks=function(){return t=Array.from(arguments),h},h.tickArguments=function(f){return arguments.length?(t=f==null?[]:Array.from(f),h):t.slice()},h.tickValues=function(f){return arguments.length?(i=f==null?null:Array.from(f),h):i&&i.slice()},h.tickFormat=function(f){return arguments.length?(r=f,h):r},h.tickSize=function(f){return arguments.length?(s=o=+f,h):s},h.tickSizeInner=function(f){return arguments.length?(s=+f,h):s},h.tickSizeOuter=function(f){return arguments.length?(o=+f,h):o},h.tickPadding=function(f){return arguments.length?(a=+f,h):a},h.offset=function(f){return arguments.length?(l=+f,h):l},h}function Lu(n){return Pp(Ua,n)}function Uu(n){return Pp(mi,n)}var e0={value:()=>{}};function _c(){for(var n=0,e=arguments.length,t={},i;n<e;++n){if(!(i=arguments[n]+"")||i in t||/[\s.]/.test(i))throw new Error("illegal type: "+i);t[i]=[]}return new Wr(t)}function Wr(n){this._=n}function t0(n,e){return n.trim().split(/^|\s+/).map(function(t){var i="",r=t.indexOf(".");if(r>=0&&(i=t.slice(r+1),t=t.slice(0,r)),t&&!e.hasOwnProperty(t))throw new Error("unknown type: "+t);return{type:t,name:i}})}Wr.prototype=_c.prototype={constructor:Wr,on:function(n,e){var t=this._,i=t0(n+"",t),r,s=-1,o=i.length;if(arguments.length<2){for(;++s<o;)if((r=(n=i[s]).type)&&(r=n0(t[r],n.name)))return r;return}if(e!=null&&typeof e!="function")throw new Error("invalid callback: "+e);for(;++s<o;)if(r=(n=i[s]).type)t[r]=$u(t[r],n.name,e);else if(e==null)for(r in t)t[r]=$u(t[r],n.name,null);return this},copy:function(){var n={},e=this._;for(var t in e)n[t]=e[t].slice();return new Wr(n)},call:function(n,e){if((r=arguments.length-2)>0)for(var t=new Array(r),i=0,r,s;i<r;++i)t[i]=arguments[i+2];if(!this._.hasOwnProperty(n))throw new Error("unknown type: "+n);for(s=this._[n],i=0,r=s.length;i<r;++i)s[i].value.apply(e,t)},apply:function(n,e,t){if(!this._.hasOwnProperty(n))throw new Error("unknown type: "+n);for(var i=this._[n],r=0,s=i.length;r<s;++r)i[r].value.apply(e,t)}};function n0(n,e){for(var t=0,i=n.length,r;t<i;++t)if((r=n[t]).name===e)return r.value}function $u(n,e,t){for(var i=0,r=n.length;i<r;++i)if(n[i].name===e){n[i]=e0,n=n.slice(0,i).concat(n.slice(i+1));break}return t!=null&&n.push({name:e,value:t}),n}var $a="http://www.w3.org/1999/xhtml";const zu={svg:"http://www.w3.org/2000/svg",xhtml:$a,xlink:"http://www.w3.org/1999/xlink",xml:"http://www.w3.org/XML/1998/namespace",xmlns:"http://www.w3.org/2000/xmlns/"};function po(n){var e=n+="",t=e.indexOf(":");return t>=0&&(e=n.slice(0,t))!=="xmlns"&&(n=n.slice(t+1)),zu.hasOwnProperty(e)?{space:zu[e],local:n}:n}function i0(n){return function(){var e=this.ownerDocument,t=this.namespaceURI;return t===$a&&e.documentElement.namespaceURI===$a?e.createElement(n):e.createElementNS(t,n)}}function r0(n){return function(){return this.ownerDocument.createElementNS(n.space,n.local)}}function Mp(n){var e=po(n);return(e.local?r0:i0)(e)}function s0(){}function yc(n){return n==null?s0:function(){return this.querySelector(n)}}function o0(n){typeof n!="function"&&(n=yc(n));for(var e=this._groups,t=e.length,i=new Array(t),r=0;r<t;++r)for(var s=e[r],o=s.length,a=i[r]=new Array(o),l,c,u=0;u<o;++u)(l=s[u])&&(c=n.call(l,l.__data__,u,s))&&("__data__"in l&&(c.__data__=l.__data__),a[u]=c);return new Ye(i,this._parents)}function a0(n){return n==null?[]:Array.isArray(n)?n:Array.from(n)}function l0(){return[]}function kp(n){return n==null?l0:function(){return this.querySelectorAll(n)}}function c0(n){return function(){return a0(n.apply(this,arguments))}}function u0(n){typeof n=="function"?n=c0(n):n=kp(n);for(var e=this._groups,t=e.length,i=[],r=[],s=0;s<t;++s)for(var o=e[s],a=o.length,l,c=0;c<a;++c)(l=o[c])&&(i.push(n.call(l,l.__data__,c,o)),r.push(l));return new Ye(i,r)}function Op(n){return function(){return this.matches(n)}}function Np(n){return function(e){return e.matches(n)}}var d0=Array.prototype.find;function h0(n){return function(){return d0.call(this.children,n)}}function f0(){return this.firstElementChild}function p0(n){return this.select(n==null?f0:h0(typeof n=="function"?n:Np(n)))}var g0=Array.prototype.filter;function m0(){return Array.from(this.children)}function _0(n){return function(){return g0.call(this.children,n)}}function y0(n){return this.selectAll(n==null?m0:_0(typeof n=="function"?n:Np(n)))}function b0(n){typeof n!="function"&&(n=Op(n));for(var e=this._groups,t=e.length,i=new Array(t),r=0;r<t;++r)for(var s=e[r],o=s.length,a=i[r]=[],l,c=0;c<o;++c)(l=s[c])&&n.call(l,l.__data__,c,s)&&a.push(l);return new Ye(i,this._parents)}function Fp(n){return new Array(n.length)}function v0(){return new Ye(this._enter||this._groups.map(Fp),this._parents)}function os(n,e){this.ownerDocument=n.ownerDocument,this.namespaceURI=n.namespaceURI,this._next=null,this._parent=n,this.__data__=e}os.prototype={constructor:os,appendChild:function(n){return this._parent.insertBefore(n,this._next)},insertBefore:function(n,e){return this._parent.insertBefore(n,e)},querySelector:function(n){return this._parent.querySelector(n)},querySelectorAll:function(n){return this._parent.querySelectorAll(n)}};function x0(n){return function(){return n}}function w0(n,e,t,i,r,s){for(var o=0,a,l=e.length,c=s.length;o<c;++o)(a=e[o])?(a.__data__=s[o],i[o]=a):t[o]=new os(n,s[o]);for(;o<l;++o)(a=e[o])&&(r[o]=a)}function T0(n,e,t,i,r,s,o){var a,l,c=new Map,u=e.length,d=s.length,h=new Array(u),f;for(a=0;a<u;++a)(l=e[a])&&(h[a]=f=o.call(l,l.__data__,a,e)+"",c.has(f)?r[a]=l:c.set(f,l));for(a=0;a<d;++a)f=o.call(n,s[a],a,s)+"",(l=c.get(f))?(i[a]=l,l.__data__=s[a],c.delete(f)):t[a]=new os(n,s[a]);for(a=0;a<u;++a)(l=e[a])&&c.get(h[a])===l&&(r[a]=l)}function S0(n){return n.__data__}function E0(n,e){if(!arguments.length)return Array.from(this,S0);var t=e?T0:w0,i=this._parents,r=this._groups;typeof n!="function"&&(n=x0(n));for(var s=r.length,o=new Array(s),a=new Array(s),l=new Array(s),c=0;c<s;++c){var u=i[c],d=r[c],h=d.length,f=A0(n.call(u,u&&u.__data__,c,i)),p=f.length,g=a[c]=new Array(p),_=o[c]=new Array(p),b=l[c]=new Array(h);t(u,d,g,_,b,f,e);for(var w=0,x=0,y,S;w<p;++w)if(y=g[w]){for(w>=x&&(x=w+1);!(S=_[x])&&++x<p;);y._next=S||null}}return o=new Ye(o,i),o._enter=a,o._exit=l,o}function A0(n){return typeof n=="object"&&"length"in n?n:Array.from(n)}function C0(){return new Ye(this._exit||this._groups.map(Fp),this._parents)}function I0(n,e,t){var i=this.enter(),r=this,s=this.exit();return typeof n=="function"?(i=n(i),i&&(i=i.selection())):i=i.append(n+""),e!=null&&(r=e(r),r&&(r=r.selection())),t==null?s.remove():t(s),i&&r?i.merge(r).order():r}function R0(n){for(var e=n.selection?n.selection():n,t=this._groups,i=e._groups,r=t.length,s=i.length,o=Math.min(r,s),a=new Array(r),l=0;l<o;++l)for(var c=t[l],u=i[l],d=c.length,h=a[l]=new Array(d),f,p=0;p<d;++p)(f=c[p]||u[p])&&(h[p]=f);for(;l<r;++l)a[l]=t[l];return new Ye(a,this._parents)}function P0(){for(var n=this._groups,e=-1,t=n.length;++e<t;)for(var i=n[e],r=i.length-1,s=i[r],o;--r>=0;)(o=i[r])&&(s&&o.compareDocumentPosition(s)^4&&s.parentNode.insertBefore(o,s),s=o);return this}function M0(n){n||(n=k0);function e(d,h){return d&&h?n(d.__data__,h.__data__):!d-!h}for(var t=this._groups,i=t.length,r=new Array(i),s=0;s<i;++s){for(var o=t[s],a=o.length,l=r[s]=new Array(a),c,u=0;u<a;++u)(c=o[u])&&(l[u]=c);l.sort(e)}return new Ye(r,this._parents).order()}function k0(n,e){return n<e?-1:n>e?1:n>=e?0:NaN}function O0(){var n=arguments[0];return arguments[0]=this,n.apply(null,arguments),this}function N0(){return Array.from(this)}function F0(){for(var n=this._groups,e=0,t=n.length;e<t;++e)for(var i=n[e],r=0,s=i.length;r<s;++r){var o=i[r];if(o)return o}return null}function D0(){let n=0;for(const e of this)++n;return n}function B0(){return!this.node()}function L0(n){for(var e=this._groups,t=0,i=e.length;t<i;++t)for(var r=e[t],s=0,o=r.length,a;s<o;++s)(a=r[s])&&n.call(a,a.__data__,s,r);return this}function U0(n){return function(){this.removeAttribute(n)}}function $0(n){return function(){this.removeAttributeNS(n.space,n.local)}}function z0(n,e){return function(){this.setAttribute(n,e)}}function V0(n,e){return function(){this.setAttributeNS(n.space,n.local,e)}}function W0(n,e){return function(){var t=e.apply(this,arguments);t==null?this.removeAttribute(n):this.setAttribute(n,t)}}function H0(n,e){return function(){var t=e.apply(this,arguments);t==null?this.removeAttributeNS(n.space,n.local):this.setAttributeNS(n.space,n.local,t)}}function j0(n,e){var t=po(n);if(arguments.length<2){var i=this.node();return t.local?i.getAttributeNS(t.space,t.local):i.getAttribute(t)}return this.each((e==null?t.local?$0:U0:typeof e=="function"?t.local?H0:W0:t.local?V0:z0)(t,e))}function Dp(n){return n.ownerDocument&&n.ownerDocument.defaultView||n.document&&n||n.defaultView}function X0(n){return function(){this.style.removeProperty(n)}}function Y0(n,e,t){return function(){this.style.setProperty(n,e,t)}}function q0(n,e,t){return function(){var i=e.apply(this,arguments);i==null?this.style.removeProperty(n):this.style.setProperty(n,i,t)}}function K0(n,e,t){return arguments.length>1?this.each((e==null?X0:typeof e=="function"?q0:Y0)(n,e,t??"")):Kn(this.node(),n)}function Kn(n,e){return n.style.getPropertyValue(e)||Dp(n).getComputedStyle(n,null).getPropertyValue(e)}function Z0(n){return function(){delete this[n]}}function G0(n,e){return function(){this[n]=e}}function Q0(n,e){return function(){var t=e.apply(this,arguments);t==null?delete this[n]:this[n]=t}}function J0(n,e){return arguments.length>1?this.each((e==null?Z0:typeof e=="function"?Q0:G0)(n,e)):this.node()[n]}function Bp(n){return n.trim().split(/^|\s+/)}function bc(n){return n.classList||new Lp(n)}function Lp(n){this._node=n,this._names=Bp(n.getAttribute("class")||"")}Lp.prototype={add:function(n){var e=this._names.indexOf(n);e<0&&(this._names.push(n),this._node.setAttribute("class",this._names.join(" ")))},remove:function(n){var e=this._names.indexOf(n);e>=0&&(this._names.splice(e,1),this._node.setAttribute("class",this._names.join(" ")))},contains:function(n){return this._names.indexOf(n)>=0}};function Up(n,e){for(var t=bc(n),i=-1,r=e.length;++i<r;)t.add(e[i])}function $p(n,e){for(var t=bc(n),i=-1,r=e.length;++i<r;)t.remove(e[i])}function ex(n){return function(){Up(this,n)}}function tx(n){return function(){$p(this,n)}}function nx(n,e){return function(){(e.apply(this,arguments)?Up:$p)(this,n)}}function ix(n,e){var t=Bp(n+"");if(arguments.length<2){for(var i=bc(this.node()),r=-1,s=t.length;++r<s;)if(!i.contains(t[r]))return!1;return!0}return this.each((typeof e=="function"?nx:e?ex:tx)(t,e))}function rx(){this.textContent=""}function sx(n){return function(){this.textContent=n}}function ox(n){return function(){var e=n.apply(this,arguments);this.textContent=e??""}}function ax(n){return arguments.length?this.each(n==null?rx:(typeof n=="function"?ox:sx)(n)):this.node().textContent}function lx(){this.innerHTML=""}function cx(n){return function(){this.innerHTML=n}}function ux(n){return function(){var e=n.apply(this,arguments);this.innerHTML=e??""}}function dx(n){return arguments.length?this.each(n==null?lx:(typeof n=="function"?ux:cx)(n)):this.node().innerHTML}function hx(){this.nextSibling&&this.parentNode.appendChild(this)}function fx(){return this.each(hx)}function px(){this.previousSibling&&this.parentNode.insertBefore(this,this.parentNode.firstChild)}function gx(){return this.each(px)}function mx(n){var e=typeof n=="function"?n:Mp(n);return this.select(function(){return this.appendChild(e.apply(this,arguments))})}function _x(){return null}function yx(n,e){var t=typeof n=="function"?n:Mp(n),i=e==null?_x:typeof e=="function"?e:yc(e);return this.select(function(){return this.insertBefore(t.apply(this,arguments),i.apply(this,arguments)||null)})}function bx(){var n=this.parentNode;n&&n.removeChild(this)}function vx(){return this.each(bx)}function xx(){var n=this.cloneNode(!1),e=this.parentNode;return e?e.insertBefore(n,this.nextSibling):n}function wx(){var n=this.cloneNode(!0),e=this.parentNode;return e?e.insertBefore(n,this.nextSibling):n}function Tx(n){return this.select(n?wx:xx)}function Sx(n){return arguments.length?this.property("__data__",n):this.node().__data__}function Ex(n){return function(e){n.call(this,e,this.__data__)}}function Ax(n){return n.trim().split(/^|\s+/).map(function(e){var t="",i=e.indexOf(".");return i>=0&&(t=e.slice(i+1),e=e.slice(0,i)),{type:e,name:t}})}function Cx(n){return function(){var e=this.__on;if(e){for(var t=0,i=-1,r=e.length,s;t<r;++t)s=e[t],(!n.type||s.type===n.type)&&s.name===n.name?this.removeEventListener(s.type,s.listener,s.options):e[++i]=s;++i?e.length=i:delete this.__on}}}function Ix(n,e,t){return function(){var i=this.__on,r,s=Ex(e);if(i){for(var o=0,a=i.length;o<a;++o)if((r=i[o]).type===n.type&&r.name===n.name){this.removeEventListener(r.type,r.listener,r.options),this.addEventListener(r.type,r.listener=s,r.options=t),r.value=e;return}}this.addEventListener(n.type,s,t),r={type:n.type,name:n.name,value:e,listener:s,options:t},i?i.push(r):this.__on=[r]}}function Rx(n,e,t){var i=Ax(n+""),r,s=i.length,o;if(arguments.length<2){var a=this.node().__on;if(a){for(var l=0,c=a.length,u;l<c;++l)for(r=0,u=a[l];r<s;++r)if((o=i[r]).type===u.type&&o.name===u.name)return u.value}return}for(a=e?Ix:Cx,r=0;r<s;++r)this.each(a(i[r],e,t));return this}function zp(n,e,t){var i=Dp(n),r=i.CustomEvent;typeof r=="function"?r=new r(e,t):(r=i.document.createEvent("Event"),t?(r.initEvent(e,t.bubbles,t.cancelable),r.detail=t.detail):r.initEvent(e,!1,!1)),n.dispatchEvent(r)}function Px(n,e){return function(){return zp(this,n,e)}}function Mx(n,e){return function(){return zp(this,n,e.apply(this,arguments))}}function kx(n,e){return this.each((typeof e=="function"?Mx:Px)(n,e))}function*Ox(){for(var n=this._groups,e=0,t=n.length;e<t;++e)for(var i=n[e],r=0,s=i.length,o;r<s;++r)(o=i[r])&&(yield o)}var Vp=[null];function Ye(n,e){this._groups=n,this._parents=e}function nr(){return new Ye([[document.documentElement]],Vp)}function Nx(){return this}Ye.prototype=nr.prototype={constructor:Ye,select:o0,selectAll:u0,selectChild:p0,selectChildren:y0,filter:b0,data:E0,enter:v0,exit:C0,join:I0,merge:R0,selection:Nx,order:P0,sort:M0,call:O0,nodes:N0,node:F0,size:D0,empty:B0,each:L0,attr:j0,style:K0,property:J0,classed:ix,text:ax,html:dx,raise:fx,lower:gx,append:mx,insert:yx,remove:vx,clone:Tx,datum:Sx,on:Rx,dispatch:kx,[Symbol.iterator]:Ox};function be(n){return typeof n=="string"?new Ye([[document.querySelector(n)]],[document.documentElement]):new Ye([[n]],Vp)}function Fx(n){let e;for(;e=n.sourceEvent;)n=e;return n}function Vu(n,e){if(n=Fx(n),e===void 0&&(e=n.currentTarget),e){var t=e.ownerSVGElement||e;if(t.createSVGPoint){var i=t.createSVGPoint();return i.x=n.clientX,i.y=n.clientY,i=i.matrixTransform(e.getScreenCTM().inverse()),[i.x,i.y]}if(e.getBoundingClientRect){var r=e.getBoundingClientRect();return[n.clientX-r.left-e.clientLeft,n.clientY-r.top-e.clientTop]}}return[n.pageX,n.pageY]}const Dx={passive:!1},Wi={capture:!0,passive:!1};function Do(n){n.stopImmediatePropagation()}function Hn(n){n.preventDefault(),n.stopImmediatePropagation()}function Bx(n){var e=n.document.documentElement,t=be(n).on("dragstart.drag",Hn,Wi);"onselectstart"in e?t.on("selectstart.drag",Hn,Wi):(e.__noselect=e.style.MozUserSelect,e.style.MozUserSelect="none")}function Lx(n,e){var t=n.document.documentElement,i=be(n).on("dragstart.drag",null);e&&(i.on("click.drag",Hn,Wi),setTimeout(function(){i.on("click.drag",null)},0)),"onselectstart"in t?i.on("selectstart.drag",null):(t.style.MozUserSelect=t.__noselect,delete t.__noselect)}const br=n=>()=>n;function za(n,{sourceEvent:e,subject:t,target:i,identifier:r,active:s,x:o,y:a,dx:l,dy:c,dispatch:u}){Object.defineProperties(this,{type:{value:n,enumerable:!0,configurable:!0},sourceEvent:{value:e,enumerable:!0,configurable:!0},subject:{value:t,enumerable:!0,configurable:!0},target:{value:i,enumerable:!0,configurable:!0},identifier:{value:r,enumerable:!0,configurable:!0},active:{value:s,enumerable:!0,configurable:!0},x:{value:o,enumerable:!0,configurable:!0},y:{value:a,enumerable:!0,configurable:!0},dx:{value:l,enumerable:!0,configurable:!0},dy:{value:c,enumerable:!0,configurable:!0},_:{value:u}})}za.prototype.on=function(){var n=this._.on.apply(this._,arguments);return n===this._?this:n};function Ux(n){return!n.ctrlKey&&!n.button}function $x(){return this.parentNode}function zx(n,e){return e??{x:n.x,y:n.y}}function Vx(){return navigator.maxTouchPoints||"ontouchstart"in this}function Wx(){var n=Ux,e=$x,t=zx,i=Vx,r={},s=_c("start","drag","end"),o=0,a,l,c,u,d=0;function h(y){y.on("mousedown.drag",f).filter(i).on("touchstart.drag",_).on("touchmove.drag",b,Dx).on("touchend.drag touchcancel.drag",w).style("touch-action","none").style("-webkit-tap-highlight-color","rgba(0,0,0,0)")}function f(y,S){if(!(u||!n.call(this,y,S))){var I=x(this,e.call(this,y,S),y,S,"mouse");I&&(be(y.view).on("mousemove.drag",p,Wi).on("mouseup.drag",g,Wi),Bx(y.view),Do(y),c=!1,a=y.clientX,l=y.clientY,I("start",y))}}function p(y){if(Hn(y),!c){var S=y.clientX-a,I=y.clientY-l;c=S*S+I*I>d}r.mouse("drag",y)}function g(y){be(y.view).on("mousemove.drag mouseup.drag",null),Lx(y.view,c),Hn(y),r.mouse("end",y)}function _(y,S){if(n.call(this,y,S)){var I=y.changedTouches,F=e.call(this,y,S),D=I.length,B,U;for(B=0;B<D;++B)(U=x(this,F,y,S,I[B].identifier,I[B]))&&(Do(y),U("start",y,I[B]))}}function b(y){var S=y.changedTouches,I=S.length,F,D;for(F=0;F<I;++F)(D=r[S[F].identifier])&&(Hn(y),D("drag",y,S[F]))}function w(y){var S=y.changedTouches,I=S.length,F,D;for(u&&clearTimeout(u),u=setTimeout(function(){u=null},500),F=0;F<I;++F)(D=r[S[F].identifier])&&(Do(y),D("end",y,S[F]))}function x(y,S,I,F,D,B){var U=s.copy(),O=Vu(B||I,S),H,$,z;if((z=t.call(y,new za("beforestart",{sourceEvent:I,target:h,identifier:D,active:o,x:O[0],y:O[1],dx:0,dy:0,dispatch:U}),F))!=null)return H=z.x-O[0]||0,$=z.y-O[1]||0,function te(de,Ue,xe){var ke=O,En;switch(de){case"start":r[D]=te,En=o++;break;case"end":delete r[D],--o;case"drag":O=Vu(xe||Ue,S),En=o;break}U.call(de,y,new za(de,{sourceEvent:Ue,subject:z,target:h,identifier:D,active:En,x:O[0]+H,y:O[1]+$,dx:O[0]-ke[0],dy:O[1]-ke[1],dispatch:U}),F)}}return h.filter=function(y){return arguments.length?(n=typeof y=="function"?y:br(!!y),h):n},h.container=function(y){return arguments.length?(e=typeof y=="function"?y:br(y),h):e},h.subject=function(y){return arguments.length?(t=typeof y=="function"?y:br(y),h):t},h.touchable=function(y){return arguments.length?(i=typeof y=="function"?y:br(!!y),h):i},h.on=function(){var y=s.on.apply(s,arguments);return y===s?h:y},h.clickDistance=function(y){return arguments.length?(d=(y=+y)*y,h):Math.sqrt(d)},h}function vc(n,e,t){n.prototype=e.prototype=t,t.constructor=n}function Wp(n,e){var t=Object.create(n.prototype);for(var i in e)t[i]=e[i];return t}function ir(){}var Hi=.7,as=1/Hi,jn="\\s*([+-]?\\d+)\\s*",ji="\\s*([+-]?(?:\\d*\\.)?\\d+(?:[eE][+-]?\\d+)?)\\s*",xt="\\s*([+-]?(?:\\d*\\.)?\\d+(?:[eE][+-]?\\d+)?)%\\s*",Hx=/^#([0-9a-f]{3,8})$/,jx=new RegExp(`^rgb\\(${jn},${jn},${jn}\\)$`),Xx=new RegExp(`^rgb\\(${xt},${xt},${xt}\\)$`),Yx=new RegExp(`^rgba\\(${jn},${jn},${jn},${ji}\\)$`),qx=new RegExp(`^rgba\\(${xt},${xt},${xt},${ji}\\)$`),Kx=new RegExp(`^hsl\\(${ji},${xt},${xt}\\)$`),Zx=new RegExp(`^hsla\\(${ji},${xt},${xt},${ji}\\)$`),Wu={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074};vc(ir,mn,{copy(n){return Object.assign(new this.constructor,this,n)},displayable(){return this.rgb().displayable()},hex:Hu,formatHex:Hu,formatHex8:Gx,formatHsl:Qx,formatRgb:ju,toString:ju});function Hu(){return this.rgb().formatHex()}function Gx(){return this.rgb().formatHex8()}function Qx(){return Hp(this).formatHsl()}function ju(){return this.rgb().formatRgb()}function mn(n){var e,t;return n=(n+"").trim().toLowerCase(),(e=Hx.exec(n))?(t=e[1].length,e=parseInt(e[1],16),t===6?Xu(e):t===3?new ze(e>>8&15|e>>4&240,e>>4&15|e&240,(e&15)<<4|e&15,1):t===8?vr(e>>24&255,e>>16&255,e>>8&255,(e&255)/255):t===4?vr(e>>12&15|e>>8&240,e>>8&15|e>>4&240,e>>4&15|e&240,((e&15)<<4|e&15)/255):null):(e=jx.exec(n))?new ze(e[1],e[2],e[3],1):(e=Xx.exec(n))?new ze(e[1]*255/100,e[2]*255/100,e[3]*255/100,1):(e=Yx.exec(n))?vr(e[1],e[2],e[3],e[4]):(e=qx.exec(n))?vr(e[1]*255/100,e[2]*255/100,e[3]*255/100,e[4]):(e=Kx.exec(n))?Ku(e[1],e[2]/100,e[3]/100,1):(e=Zx.exec(n))?Ku(e[1],e[2]/100,e[3]/100,e[4]):Wu.hasOwnProperty(n)?Xu(Wu[n]):n==="transparent"?new ze(NaN,NaN,NaN,0):null}function Xu(n){return new ze(n>>16&255,n>>8&255,n&255,1)}function vr(n,e,t,i){return i<=0&&(n=e=t=NaN),new ze(n,e,t,i)}function Jx(n){return n instanceof ir||(n=mn(n)),n?(n=n.rgb(),new ze(n.r,n.g,n.b,n.opacity)):new ze}function Va(n,e,t,i){return arguments.length===1?Jx(n):new ze(n,e,t,i??1)}function ze(n,e,t,i){this.r=+n,this.g=+e,this.b=+t,this.opacity=+i}vc(ze,Va,Wp(ir,{brighter(n){return n=n==null?as:Math.pow(as,n),new ze(this.r*n,this.g*n,this.b*n,this.opacity)},darker(n){return n=n==null?Hi:Math.pow(Hi,n),new ze(this.r*n,this.g*n,this.b*n,this.opacity)},rgb(){return this},clamp(){return new ze(dn(this.r),dn(this.g),dn(this.b),ls(this.opacity))},displayable(){return-.5<=this.r&&this.r<255.5&&-.5<=this.g&&this.g<255.5&&-.5<=this.b&&this.b<255.5&&0<=this.opacity&&this.opacity<=1},hex:Yu,formatHex:Yu,formatHex8:ew,formatRgb:qu,toString:qu}));function Yu(){return`#${ln(this.r)}${ln(this.g)}${ln(this.b)}`}function ew(){return`#${ln(this.r)}${ln(this.g)}${ln(this.b)}${ln((isNaN(this.opacity)?1:this.opacity)*255)}`}function qu(){const n=ls(this.opacity);return`${n===1?"rgb(":"rgba("}${dn(this.r)}, ${dn(this.g)}, ${dn(this.b)}${n===1?")":`, ${n})`}`}function ls(n){return isNaN(n)?1:Math.max(0,Math.min(1,n))}function dn(n){return Math.max(0,Math.min(255,Math.round(n)||0))}function ln(n){return n=dn(n),(n<16?"0":"")+n.toString(16)}function Ku(n,e,t,i){return i<=0?n=e=t=NaN:t<=0||t>=1?n=e=NaN:e<=0&&(n=NaN),new ct(n,e,t,i)}function Hp(n){if(n instanceof ct)return new ct(n.h,n.s,n.l,n.opacity);if(n instanceof ir||(n=mn(n)),!n)return new ct;if(n instanceof ct)return n;n=n.rgb();var e=n.r/255,t=n.g/255,i=n.b/255,r=Math.min(e,t,i),s=Math.max(e,t,i),o=NaN,a=s-r,l=(s+r)/2;return a?(e===s?o=(t-i)/a+(t<i)*6:t===s?o=(i-e)/a+2:o=(e-t)/a+4,a/=l<.5?s+r:2-s-r,o*=60):a=l>0&&l<1?0:o,new ct(o,a,l,n.opacity)}function tw(n,e,t,i){return arguments.length===1?Hp(n):new ct(n,e,t,i??1)}function ct(n,e,t,i){this.h=+n,this.s=+e,this.l=+t,this.opacity=+i}vc(ct,tw,Wp(ir,{brighter(n){return n=n==null?as:Math.pow(as,n),new ct(this.h,this.s,this.l*n,this.opacity)},darker(n){return n=n==null?Hi:Math.pow(Hi,n),new ct(this.h,this.s,this.l*n,this.opacity)},rgb(){var n=this.h%360+(this.h<0)*360,e=isNaN(n)||isNaN(this.s)?0:this.s,t=this.l,i=t+(t<.5?t:1-t)*e,r=2*t-i;return new ze(Bo(n>=240?n-240:n+120,r,i),Bo(n,r,i),Bo(n<120?n+240:n-120,r,i),this.opacity)},clamp(){return new ct(Zu(this.h),xr(this.s),xr(this.l),ls(this.opacity))},displayable(){return(0<=this.s&&this.s<=1||isNaN(this.s))&&0<=this.l&&this.l<=1&&0<=this.opacity&&this.opacity<=1},formatHsl(){const n=ls(this.opacity);return`${n===1?"hsl(":"hsla("}${Zu(this.h)}, ${xr(this.s)*100}%, ${xr(this.l)*100}%${n===1?")":`, ${n})`}`}}));function Zu(n){return n=(n||0)%360,n<0?n+360:n}function xr(n){return Math.max(0,Math.min(1,n||0))}function Bo(n,e,t){return(n<60?e+(t-e)*n/60:n<180?t:n<240?e+(t-e)*(240-n)/60:e)*255}const xc=n=>()=>n;function nw(n,e){return function(t){return n+t*e}}function iw(n,e,t){return n=Math.pow(n,t),e=Math.pow(e,t)-n,t=1/t,function(i){return Math.pow(n+i*e,t)}}function rw(n){return(n=+n)==1?jp:function(e,t){return t-e?iw(e,t,n):xc(isNaN(e)?t:e)}}function jp(n,e){var t=e-n;return t?nw(n,t):xc(isNaN(n)?e:n)}const cs=function n(e){var t=rw(e);function i(r,s){var o=t((r=Va(r)).r,(s=Va(s)).r),a=t(r.g,s.g),l=t(r.b,s.b),c=jp(r.opacity,s.opacity);return function(u){return r.r=o(u),r.g=a(u),r.b=l(u),r.opacity=c(u),r+""}}return i.gamma=n,i}(1);function sw(n,e){e||(e=[]);var t=n?Math.min(e.length,n.length):0,i=e.slice(),r;return function(s){for(r=0;r<t;++r)i[r]=n[r]*(1-s)+e[r]*s;return i}}function ow(n){return ArrayBuffer.isView(n)&&!(n instanceof DataView)}function aw(n,e){var t=e?e.length:0,i=n?Math.min(t,n.length):0,r=new Array(i),s=new Array(t),o;for(o=0;o<i;++o)r[o]=wc(n[o],e[o]);for(;o<t;++o)s[o]=e[o];return function(a){for(o=0;o<i;++o)s[o]=r[o](a);return s}}function lw(n,e){var t=new Date;return n=+n,e=+e,function(i){return t.setTime(n*(1-i)+e*i),t}}function at(n,e){return n=+n,e=+e,function(t){return n*(1-t)+e*t}}function cw(n,e){var t={},i={},r;(n===null||typeof n!="object")&&(n={}),(e===null||typeof e!="object")&&(e={});for(r in e)r in n?t[r]=wc(n[r],e[r]):i[r]=e[r];return function(s){for(r in t)i[r]=t[r](s);return i}}var Wa=/[-+]?(?:\d+\.?\d*|\.?\d+)(?:[eE][-+]?\d+)?/g,Lo=new RegExp(Wa.source,"g");function uw(n){return function(){return n}}function dw(n){return function(e){return n(e)+""}}function Xp(n,e){var t=Wa.lastIndex=Lo.lastIndex=0,i,r,s,o=-1,a=[],l=[];for(n=n+"",e=e+"";(i=Wa.exec(n))&&(r=Lo.exec(e));)(s=r.index)>t&&(s=e.slice(t,s),a[o]?a[o]+=s:a[++o]=s),(i=i[0])===(r=r[0])?a[o]?a[o]+=r:a[++o]=r:(a[++o]=null,l.push({i:o,x:at(i,r)})),t=Lo.lastIndex;return t<e.length&&(s=e.slice(t),a[o]?a[o]+=s:a[++o]=s),a.length<2?l[0]?dw(l[0].x):uw(e):(e=l.length,function(c){for(var u=0,d;u<e;++u)a[(d=l[u]).i]=d.x(c);return a.join("")})}function wc(n,e){var t=typeof e,i;return e==null||t==="boolean"?xc(e):(t==="number"?at:t==="string"?(i=mn(e))?(e=i,cs):Xp:e instanceof mn?cs:e instanceof Date?lw:ow(e)?sw:Array.isArray(e)?aw:typeof e.valueOf!="function"&&typeof e.toString!="function"||isNaN(e)?cw:at)(n,e)}function hw(n,e){return n=+n,e=+e,function(t){return Math.round(n*(1-t)+e*t)}}var Gu=180/Math.PI,Ha={translateX:0,translateY:0,rotate:0,skewX:0,scaleX:1,scaleY:1};function Yp(n,e,t,i,r,s){var o,a,l;return(o=Math.sqrt(n*n+e*e))&&(n/=o,e/=o),(l=n*t+e*i)&&(t-=n*l,i-=e*l),(a=Math.sqrt(t*t+i*i))&&(t/=a,i/=a,l/=a),n*i<e*t&&(n=-n,e=-e,l=-l,o=-o),{translateX:r,translateY:s,rotate:Math.atan2(e,n)*Gu,skewX:Math.atan(l)*Gu,scaleX:o,scaleY:a}}var wr;function fw(n){const e=new(typeof DOMMatrix=="function"?DOMMatrix:WebKitCSSMatrix)(n+"");return e.isIdentity?Ha:Yp(e.a,e.b,e.c,e.d,e.e,e.f)}function pw(n){return n==null||(wr||(wr=document.createElementNS("http://www.w3.org/2000/svg","g")),wr.setAttribute("transform",n),!(n=wr.transform.baseVal.consolidate()))?Ha:(n=n.matrix,Yp(n.a,n.b,n.c,n.d,n.e,n.f))}function qp(n,e,t,i){function r(c){return c.length?c.pop()+" ":""}function s(c,u,d,h,f,p){if(c!==d||u!==h){var g=f.push("translate(",null,e,null,t);p.push({i:g-4,x:at(c,d)},{i:g-2,x:at(u,h)})}else(d||h)&&f.push("translate("+d+e+h+t)}function o(c,u,d,h){c!==u?(c-u>180?u+=360:u-c>180&&(c+=360),h.push({i:d.push(r(d)+"rotate(",null,i)-2,x:at(c,u)})):u&&d.push(r(d)+"rotate("+u+i)}function a(c,u,d,h){c!==u?h.push({i:d.push(r(d)+"skewX(",null,i)-2,x:at(c,u)}):u&&d.push(r(d)+"skewX("+u+i)}function l(c,u,d,h,f,p){if(c!==d||u!==h){var g=f.push(r(f)+"scale(",null,",",null,")");p.push({i:g-4,x:at(c,d)},{i:g-2,x:at(u,h)})}else(d!==1||h!==1)&&f.push(r(f)+"scale("+d+","+h+")")}return function(c,u){var d=[],h=[];return c=n(c),u=n(u),s(c.translateX,c.translateY,u.translateX,u.translateY,d,h),o(c.rotate,u.rotate,d,h),a(c.skewX,u.skewX,d,h),l(c.scaleX,c.scaleY,u.scaleX,u.scaleY,d,h),c=u=null,function(f){for(var p=-1,g=h.length,_;++p<g;)d[(_=h[p]).i]=_.x(f);return d.join("")}}}var gw=qp(fw,"px, ","px)","deg)"),mw=qp(pw,", ",")",")"),Zn=0,_i=0,di=0,Kp=1e3,us,yi,ds=0,_n=0,go=0,Xi=typeof performance=="object"&&performance.now?performance:Date,Zp=typeof window=="object"&&window.requestAnimationFrame?window.requestAnimationFrame.bind(window):function(n){setTimeout(n,17)};function Tc(){return _n||(Zp(_w),_n=Xi.now()+go)}function _w(){_n=0}function hs(){this._call=this._time=this._next=null}hs.prototype=Gp.prototype={constructor:hs,restart:function(n,e,t){if(typeof n!="function")throw new TypeError("callback is not a function");t=(t==null?Tc():+t)+(e==null?0:+e),!this._next&&yi!==this&&(yi?yi._next=this:us=this,yi=this),this._call=n,this._time=t,ja()},stop:function(){this._call&&(this._call=null,this._time=1/0,ja())}};function Gp(n,e,t){var i=new hs;return i.restart(n,e,t),i}function yw(){Tc(),++Zn;for(var n=us,e;n;)(e=_n-n._time)>=0&&n._call.call(void 0,e),n=n._next;--Zn}function Qu(){_n=(ds=Xi.now())+go,Zn=_i=0;try{yw()}finally{Zn=0,vw(),_n=0}}function bw(){var n=Xi.now(),e=n-ds;e>Kp&&(go-=e,ds=n)}function vw(){for(var n,e=us,t,i=1/0;e;)e._call?(i>e._time&&(i=e._time),n=e,e=e._next):(t=e._next,e._next=null,e=n?n._next=t:us=t);yi=n,ja(i)}function ja(n){if(!Zn){_i&&(_i=clearTimeout(_i));var e=n-_n;e>24?(n<1/0&&(_i=setTimeout(Qu,n-Xi.now()-go)),di&&(di=clearInterval(di))):(di||(ds=Xi.now(),di=setInterval(bw,Kp)),Zn=1,Zp(Qu))}}function Ju(n,e,t){var i=new hs;return e=e==null?0:+e,i.restart(r=>{i.stop(),n(r+e)},e,t),i}var xw=_c("start","end","cancel","interrupt"),ww=[],Qp=0,ed=1,Xa=2,Hr=3,td=4,Ya=5,jr=6;function mo(n,e,t,i,r,s){var o=n.__transition;if(!o)n.__transition={};else if(t in o)return;Tw(n,t,{name:e,index:i,group:r,on:xw,tween:ww,time:s.time,delay:s.delay,duration:s.duration,ease:s.ease,timer:null,state:Qp})}function Sc(n,e){var t=ft(n,e);if(t.state>Qp)throw new Error("too late; already scheduled");return t}function St(n,e){var t=ft(n,e);if(t.state>Hr)throw new Error("too late; already running");return t}function ft(n,e){var t=n.__transition;if(!t||!(t=t[e]))throw new Error("transition not found");return t}function Tw(n,e,t){var i=n.__transition,r;i[e]=t,t.timer=Gp(s,0,t.time);function s(c){t.state=ed,t.timer.restart(o,t.delay,t.time),t.delay<=c&&o(c-t.delay)}function o(c){var u,d,h,f;if(t.state!==ed)return l();for(u in i)if(f=i[u],f.name===t.name){if(f.state===Hr)return Ju(o);f.state===td?(f.state=jr,f.timer.stop(),f.on.call("interrupt",n,n.__data__,f.index,f.group),delete i[u]):+u<e&&(f.state=jr,f.timer.stop(),f.on.call("cancel",n,n.__data__,f.index,f.group),delete i[u])}if(Ju(function(){t.state===Hr&&(t.state=td,t.timer.restart(a,t.delay,t.time),a(c))}),t.state=Xa,t.on.call("start",n,n.__data__,t.index,t.group),t.state===Xa){for(t.state=Hr,r=new Array(h=t.tween.length),u=0,d=-1;u<h;++u)(f=t.tween[u].value.call(n,n.__data__,t.index,t.group))&&(r[++d]=f);r.length=d+1}}function a(c){for(var u=c<t.duration?t.ease.call(null,c/t.duration):(t.timer.restart(l),t.state=Ya,1),d=-1,h=r.length;++d<h;)r[d].call(n,u);t.state===Ya&&(t.on.call("end",n,n.__data__,t.index,t.group),l())}function l(){t.state=jr,t.timer.stop(),delete i[e];for(var c in i)return;delete n.__transition}}function Sw(n,e){var t=n.__transition,i,r,s=!0,o;if(t){e=e==null?null:e+"";for(o in t){if((i=t[o]).name!==e){s=!1;continue}r=i.state>Xa&&i.state<Ya,i.state=jr,i.timer.stop(),i.on.call(r?"interrupt":"cancel",n,n.__data__,i.index,i.group),delete t[o]}s&&delete n.__transition}}function Ew(n){return this.each(function(){Sw(this,n)})}function Aw(n,e){var t,i;return function(){var r=St(this,n),s=r.tween;if(s!==t){i=t=s;for(var o=0,a=i.length;o<a;++o)if(i[o].name===e){i=i.slice(),i.splice(o,1);break}}r.tween=i}}function Cw(n,e,t){var i,r;if(typeof t!="function")throw new Error;return function(){var s=St(this,n),o=s.tween;if(o!==i){r=(i=o).slice();for(var a={name:e,value:t},l=0,c=r.length;l<c;++l)if(r[l].name===e){r[l]=a;break}l===c&&r.push(a)}s.tween=r}}function Iw(n,e){var t=this._id;if(n+="",arguments.length<2){for(var i=ft(this.node(),t).tween,r=0,s=i.length,o;r<s;++r)if((o=i[r]).name===n)return o.value;return null}return this.each((e==null?Aw:Cw)(t,n,e))}function Ec(n,e,t){var i=n._id;return n.each(function(){var r=St(this,i);(r.value||(r.value={}))[e]=t.apply(this,arguments)}),function(r){return ft(r,i).value[e]}}function Jp(n,e){var t;return(typeof e=="number"?at:e instanceof mn?cs:(t=mn(e))?(e=t,cs):Xp)(n,e)}function Rw(n){return function(){this.removeAttribute(n)}}function Pw(n){return function(){this.removeAttributeNS(n.space,n.local)}}function Mw(n,e,t){var i,r=t+"",s;return function(){var o=this.getAttribute(n);return o===r?null:o===i?s:s=e(i=o,t)}}function kw(n,e,t){var i,r=t+"",s;return function(){var o=this.getAttributeNS(n.space,n.local);return o===r?null:o===i?s:s=e(i=o,t)}}function Ow(n,e,t){var i,r,s;return function(){var o,a=t(this),l;return a==null?void this.removeAttribute(n):(o=this.getAttribute(n),l=a+"",o===l?null:o===i&&l===r?s:(r=l,s=e(i=o,a)))}}function Nw(n,e,t){var i,r,s;return function(){var o,a=t(this),l;return a==null?void this.removeAttributeNS(n.space,n.local):(o=this.getAttributeNS(n.space,n.local),l=a+"",o===l?null:o===i&&l===r?s:(r=l,s=e(i=o,a)))}}function Fw(n,e){var t=po(n),i=t==="transform"?mw:Jp;return this.attrTween(n,typeof e=="function"?(t.local?Nw:Ow)(t,i,Ec(this,"attr."+n,e)):e==null?(t.local?Pw:Rw)(t):(t.local?kw:Mw)(t,i,e))}function Dw(n,e){return function(t){this.setAttribute(n,e.call(this,t))}}function Bw(n,e){return function(t){this.setAttributeNS(n.space,n.local,e.call(this,t))}}function Lw(n,e){var t,i;function r(){var s=e.apply(this,arguments);return s!==i&&(t=(i=s)&&Bw(n,s)),t}return r._value=e,r}function Uw(n,e){var t,i;function r(){var s=e.apply(this,arguments);return s!==i&&(t=(i=s)&&Dw(n,s)),t}return r._value=e,r}function $w(n,e){var t="attr."+n;if(arguments.length<2)return(t=this.tween(t))&&t._value;if(e==null)return this.tween(t,null);if(typeof e!="function")throw new Error;var i=po(n);return this.tween(t,(i.local?Lw:Uw)(i,e))}function zw(n,e){return function(){Sc(this,n).delay=+e.apply(this,arguments)}}function Vw(n,e){return e=+e,function(){Sc(this,n).delay=e}}function Ww(n){var e=this._id;return arguments.length?this.each((typeof n=="function"?zw:Vw)(e,n)):ft(this.node(),e).delay}function Hw(n,e){return function(){St(this,n).duration=+e.apply(this,arguments)}}function jw(n,e){return e=+e,function(){St(this,n).duration=e}}function Xw(n){var e=this._id;return arguments.length?this.each((typeof n=="function"?Hw:jw)(e,n)):ft(this.node(),e).duration}function Yw(n,e){if(typeof e!="function")throw new Error;return function(){St(this,n).ease=e}}function qw(n){var e=this._id;return arguments.length?this.each(Yw(e,n)):ft(this.node(),e).ease}function Kw(n,e){return function(){var t=e.apply(this,arguments);if(typeof t!="function")throw new Error;St(this,n).ease=t}}function Zw(n){if(typeof n!="function")throw new Error;return this.each(Kw(this._id,n))}function Gw(n){typeof n!="function"&&(n=Op(n));for(var e=this._groups,t=e.length,i=new Array(t),r=0;r<t;++r)for(var s=e[r],o=s.length,a=i[r]=[],l,c=0;c<o;++c)(l=s[c])&&n.call(l,l.__data__,c,s)&&a.push(l);return new kt(i,this._parents,this._name,this._id)}function Qw(n){if(n._id!==this._id)throw new Error;for(var e=this._groups,t=n._groups,i=e.length,r=t.length,s=Math.min(i,r),o=new Array(i),a=0;a<s;++a)for(var l=e[a],c=t[a],u=l.length,d=o[a]=new Array(u),h,f=0;f<u;++f)(h=l[f]||c[f])&&(d[f]=h);for(;a<i;++a)o[a]=e[a];return new kt(o,this._parents,this._name,this._id)}function Jw(n){return(n+"").trim().split(/^|\s+/).every(function(e){var t=e.indexOf(".");return t>=0&&(e=e.slice(0,t)),!e||e==="start"})}function eT(n,e,t){var i,r,s=Jw(e)?Sc:St;return function(){var o=s(this,n),a=o.on;a!==i&&(r=(i=a).copy()).on(e,t),o.on=r}}function tT(n,e){var t=this._id;return arguments.length<2?ft(this.node(),t).on.on(n):this.each(eT(t,n,e))}function nT(n){return function(){var e=this.parentNode;for(var t in this.__transition)if(+t!==n)return;e&&e.removeChild(this)}}function iT(){return this.on("end.remove",nT(this._id))}function rT(n){var e=this._name,t=this._id;typeof n!="function"&&(n=yc(n));for(var i=this._groups,r=i.length,s=new Array(r),o=0;o<r;++o)for(var a=i[o],l=a.length,c=s[o]=new Array(l),u,d,h=0;h<l;++h)(u=a[h])&&(d=n.call(u,u.__data__,h,a))&&("__data__"in u&&(d.__data__=u.__data__),c[h]=d,mo(c[h],e,t,h,c,ft(u,t)));return new kt(s,this._parents,e,t)}function sT(n){var e=this._name,t=this._id;typeof n!="function"&&(n=kp(n));for(var i=this._groups,r=i.length,s=[],o=[],a=0;a<r;++a)for(var l=i[a],c=l.length,u,d=0;d<c;++d)if(u=l[d]){for(var h=n.call(u,u.__data__,d,l),f,p=ft(u,t),g=0,_=h.length;g<_;++g)(f=h[g])&&mo(f,e,t,g,h,p);s.push(h),o.push(u)}return new kt(s,o,e,t)}var oT=nr.prototype.constructor;function aT(){return new oT(this._groups,this._parents)}function lT(n,e){var t,i,r;return function(){var s=Kn(this,n),o=(this.style.removeProperty(n),Kn(this,n));return s===o?null:s===t&&o===i?r:r=e(t=s,i=o)}}function eg(n){return function(){this.style.removeProperty(n)}}function cT(n,e,t){var i,r=t+"",s;return function(){var o=Kn(this,n);return o===r?null:o===i?s:s=e(i=o,t)}}function uT(n,e,t){var i,r,s;return function(){var o=Kn(this,n),a=t(this),l=a+"";return a==null&&(l=a=(this.style.removeProperty(n),Kn(this,n))),o===l?null:o===i&&l===r?s:(r=l,s=e(i=o,a))}}function dT(n,e){var t,i,r,s="style."+e,o="end."+s,a;return function(){var l=St(this,n),c=l.on,u=l.value[s]==null?a||(a=eg(e)):void 0;(c!==t||r!==u)&&(i=(t=c).copy()).on(o,r=u),l.on=i}}function hT(n,e,t){var i=(n+="")=="transform"?gw:Jp;return e==null?this.styleTween(n,lT(n,i)).on("end.style."+n,eg(n)):typeof e=="function"?this.styleTween(n,uT(n,i,Ec(this,"style."+n,e))).each(dT(this._id,n)):this.styleTween(n,cT(n,i,e),t).on("end.style."+n,null)}function fT(n,e,t){return function(i){this.style.setProperty(n,e.call(this,i),t)}}function pT(n,e,t){var i,r;function s(){var o=e.apply(this,arguments);return o!==r&&(i=(r=o)&&fT(n,o,t)),i}return s._value=e,s}function gT(n,e,t){var i="style."+(n+="");if(arguments.length<2)return(i=this.tween(i))&&i._value;if(e==null)return this.tween(i,null);if(typeof e!="function")throw new Error;return this.tween(i,pT(n,e,t??""))}function mT(n){return function(){this.textContent=n}}function _T(n){return function(){var e=n(this);this.textContent=e??""}}function yT(n){return this.tween("text",typeof n=="function"?_T(Ec(this,"text",n)):mT(n==null?"":n+""))}function bT(n){return function(e){this.textContent=n.call(this,e)}}function vT(n){var e,t;function i(){var r=n.apply(this,arguments);return r!==t&&(e=(t=r)&&bT(r)),e}return i._value=n,i}function xT(n){var e="text";if(arguments.length<1)return(e=this.tween(e))&&e._value;if(n==null)return this.tween(e,null);if(typeof n!="function")throw new Error;return this.tween(e,vT(n))}function wT(){for(var n=this._name,e=this._id,t=tg(),i=this._groups,r=i.length,s=0;s<r;++s)for(var o=i[s],a=o.length,l,c=0;c<a;++c)if(l=o[c]){var u=ft(l,e);mo(l,n,t,c,o,{time:u.time+u.delay+u.duration,delay:0,duration:u.duration,ease:u.ease})}return new kt(i,this._parents,n,t)}function TT(){var n,e,t=this,i=t._id,r=t.size();return new Promise(function(s,o){var a={value:o},l={value:function(){--r===0&&s()}};t.each(function(){var c=St(this,i),u=c.on;u!==n&&(e=(n=u).copy(),e._.cancel.push(a),e._.interrupt.push(a),e._.end.push(l)),c.on=e}),r===0&&s()})}var ST=0;function kt(n,e,t,i){this._groups=n,this._parents=e,this._name=t,this._id=i}function tg(){return++ST}var Et=nr.prototype;kt.prototype={constructor:kt,select:rT,selectAll:sT,selectChild:Et.selectChild,selectChildren:Et.selectChildren,filter:Gw,merge:Qw,selection:aT,transition:wT,call:Et.call,nodes:Et.nodes,node:Et.node,size:Et.size,empty:Et.empty,each:Et.each,on:tT,attr:Fw,attrTween:$w,style:hT,styleTween:gT,text:yT,textTween:xT,remove:iT,tween:Iw,delay:Ww,duration:Xw,ease:qw,easeVarying:Zw,end:TT,[Symbol.iterator]:Et[Symbol.iterator]};function ET(n){return((n*=2)<=1?n*n*n:(n-=2)*n*n+2)/2}var AT={time:null,delay:0,duration:250,ease:ET};function CT(n,e){for(var t;!(t=n.__transition)||!(t=t[e]);)if(!(n=n.parentNode))throw new Error(`transition ${e} not found`);return t}function IT(n){var e,t;n instanceof kt?(e=n._id,n=n._name):(e=tg(),(t=AT).time=Tc(),n=n==null?null:n+"");for(var i=this._groups,r=i.length,s=0;s<r;++s)for(var o=i[s],a=o.length,l,c=0;c<a;++c)(l=o[c])&&mo(l,n,e,c,o,t||CT(l,e));return new kt(i,this._parents,n,e)}nr.prototype.interrupt=Ew;nr.prototype.transition=IT;const qa=Math.PI,Ka=2*qa,sn=1e-6,RT=Ka-sn;function ng(n){this._+=n[0];for(let e=1,t=n.length;e<t;++e)this._+=arguments[e]+n[e]}function PT(n){let e=Math.floor(n);if(!(e>=0))throw new Error(`invalid digits: ${n}`);if(e>15)return ng;const t=10**e;return function(i){this._+=i[0];for(let r=1,s=i.length;r<s;++r)this._+=Math.round(arguments[r]*t)/t+i[r]}}class MT{constructor(e){this._x0=this._y0=this._x1=this._y1=null,this._="",this._append=e==null?ng:PT(e)}moveTo(e,t){this._append`M${this._x0=this._x1=+e},${this._y0=this._y1=+t}`}closePath(){this._x1!==null&&(this._x1=this._x0,this._y1=this._y0,this._append`Z`)}lineTo(e,t){this._append`L${this._x1=+e},${this._y1=+t}`}quadraticCurveTo(e,t,i,r){this._append`Q${+e},${+t},${this._x1=+i},${this._y1=+r}`}bezierCurveTo(e,t,i,r,s,o){this._append`C${+e},${+t},${+i},${+r},${this._x1=+s},${this._y1=+o}`}arcTo(e,t,i,r,s){if(e=+e,t=+t,i=+i,r=+r,s=+s,s<0)throw new Error(`negative radius: ${s}`);let o=this._x1,a=this._y1,l=i-e,c=r-t,u=o-e,d=a-t,h=u*u+d*d;if(this._x1===null)this._append`M${this._x1=e},${this._y1=t}`;else if(h>sn)if(!(Math.abs(d*l-c*u)>sn)||!s)this._append`L${this._x1=e},${this._y1=t}`;else{let f=i-o,p=r-a,g=l*l+c*c,_=f*f+p*p,b=Math.sqrt(g),w=Math.sqrt(h),x=s*Math.tan((qa-Math.acos((g+h-_)/(2*b*w)))/2),y=x/w,S=x/b;Math.abs(y-1)>sn&&this._append`L${e+y*u},${t+y*d}`,this._append`A${s},${s},0,0,${+(d*f>u*p)},${this._x1=e+S*l},${this._y1=t+S*c}`}}arc(e,t,i,r,s,o){if(e=+e,t=+t,i=+i,o=!!o,i<0)throw new Error(`negative radius: ${i}`);let a=i*Math.cos(r),l=i*Math.sin(r),c=e+a,u=t+l,d=1^o,h=o?r-s:s-r;this._x1===null?this._append`M${c},${u}`:(Math.abs(this._x1-c)>sn||Math.abs(this._y1-u)>sn)&&this._append`L${c},${u}`,i&&(h<0&&(h=h%Ka+Ka),h>RT?this._append`A${i},${i},0,1,${d},${e-a},${t-l}A${i},${i},0,1,${d},${this._x1=c},${this._y1=u}`:h>sn&&this._append`A${i},${i},0,${+(h>=qa)},${d},${this._x1=e+i*Math.cos(s)},${this._y1=t+i*Math.sin(s)}`)}rect(e,t,i,r){this._append`M${this._x0=this._x1=+e},${this._y0=this._y1=+t}h${i=+i}v${+r}h${-i}Z`}toString(){return this._}}function kT(n){return Math.abs(n=Math.round(n))>=1e21?n.toLocaleString("en").replace(/,/g,""):n.toString(10)}function fs(n,e){if((t=(n=e?n.toExponential(e-1):n.toExponential()).indexOf("e"))<0)return null;var t,i=n.slice(0,t);return[i.length>1?i[0]+i.slice(2):i,+n.slice(t+1)]}function Gn(n){return n=fs(Math.abs(n)),n?n[1]:NaN}function OT(n,e){return function(t,i){for(var r=t.length,s=[],o=0,a=n[0],l=0;r>0&&a>0&&(l+a+1>i&&(a=Math.max(1,i-l)),s.push(t.substring(r-=a,r+a)),!((l+=a+1)>i));)a=n[o=(o+1)%n.length];return s.reverse().join(e)}}function NT(n){return function(e){return e.replace(/[0-9]/g,function(t){return n[+t]})}}var FT=/^(?:(.)?([<>=^]))?([+\-( ])?([$#])?(0)?(\d+)?(,)?(\.\d+)?(~)?([a-z%])?$/i;function ps(n){if(!(e=FT.exec(n)))throw new Error("invalid format: "+n);var e;return new Ac({fill:e[1],align:e[2],sign:e[3],symbol:e[4],zero:e[5],width:e[6],comma:e[7],precision:e[8]&&e[8].slice(1),trim:e[9],type:e[10]})}ps.prototype=Ac.prototype;function Ac(n){this.fill=n.fill===void 0?" ":n.fill+"",this.align=n.align===void 0?">":n.align+"",this.sign=n.sign===void 0?"-":n.sign+"",this.symbol=n.symbol===void 0?"":n.symbol+"",this.zero=!!n.zero,this.width=n.width===void 0?void 0:+n.width,this.comma=!!n.comma,this.precision=n.precision===void 0?void 0:+n.precision,this.trim=!!n.trim,this.type=n.type===void 0?"":n.type+""}Ac.prototype.toString=function(){return this.fill+this.align+this.sign+this.symbol+(this.zero?"0":"")+(this.width===void 0?"":Math.max(1,this.width|0))+(this.comma?",":"")+(this.precision===void 0?"":"."+Math.max(0,this.precision|0))+(this.trim?"~":"")+this.type};function DT(n){e:for(var e=n.length,t=1,i=-1,r;t<e;++t)switch(n[t]){case".":i=r=t;break;case"0":i===0&&(i=t),r=t;break;default:if(!+n[t])break e;i>0&&(i=0);break}return i>0?n.slice(0,i)+n.slice(r+1):n}var ig;function BT(n,e){var t=fs(n,e);if(!t)return n+"";var i=t[0],r=t[1],s=r-(ig=Math.max(-8,Math.min(8,Math.floor(r/3)))*3)+1,o=i.length;return s===o?i:s>o?i+new Array(s-o+1).join("0"):s>0?i.slice(0,s)+"."+i.slice(s):"0."+new Array(1-s).join("0")+fs(n,Math.max(0,e+s-1))[0]}function nd(n,e){var t=fs(n,e);if(!t)return n+"";var i=t[0],r=t[1];return r<0?"0."+new Array(-r).join("0")+i:i.length>r+1?i.slice(0,r+1)+"."+i.slice(r+1):i+new Array(r-i.length+2).join("0")}const id={"%":(n,e)=>(n*100).toFixed(e),b:n=>Math.round(n).toString(2),c:n=>n+"",d:kT,e:(n,e)=>n.toExponential(e),f:(n,e)=>n.toFixed(e),g:(n,e)=>n.toPrecision(e),o:n=>Math.round(n).toString(8),p:(n,e)=>nd(n*100,e),r:nd,s:BT,X:n=>Math.round(n).toString(16).toUpperCase(),x:n=>Math.round(n).toString(16)};function rd(n){return n}var sd=Array.prototype.map,od=["y","z","a","f","p","n","Âµ","m","","k","M","G","T","P","E","Z","Y"];function LT(n){var e=n.grouping===void 0||n.thousands===void 0?rd:OT(sd.call(n.grouping,Number),n.thousands+""),t=n.currency===void 0?"":n.currency[0]+"",i=n.currency===void 0?"":n.currency[1]+"",r=n.decimal===void 0?".":n.decimal+"",s=n.numerals===void 0?rd:NT(sd.call(n.numerals,String)),o=n.percent===void 0?"%":n.percent+"",a=n.minus===void 0?"âˆ’":n.minus+"",l=n.nan===void 0?"NaN":n.nan+"";function c(d){d=ps(d);var h=d.fill,f=d.align,p=d.sign,g=d.symbol,_=d.zero,b=d.width,w=d.comma,x=d.precision,y=d.trim,S=d.type;S==="n"?(w=!0,S="g"):id[S]||(x===void 0&&(x=12),y=!0,S="g"),(_||h==="0"&&f==="=")&&(_=!0,h="0",f="=");var I=g==="$"?t:g==="#"&&/[boxX]/.test(S)?"0"+S.toLowerCase():"",F=g==="$"?i:/[%p]/.test(S)?o:"",D=id[S],B=/[defgprs%]/.test(S);x=x===void 0?6:/[gprs]/.test(S)?Math.max(1,Math.min(21,x)):Math.max(0,Math.min(20,x));function U(O){var H=I,$=F,z,te,de;if(S==="c")$=D(O)+$,O="";else{O=+O;var Ue=O<0||1/O<0;if(O=isNaN(O)?l:D(Math.abs(O),x),y&&(O=DT(O)),Ue&&+O==0&&p!=="+"&&(Ue=!1),H=(Ue?p==="("?p:a:p==="-"||p==="("?"":p)+H,$=(S==="s"?od[8+ig/3]:"")+$+(Ue&&p==="("?")":""),B){for(z=-1,te=O.length;++z<te;)if(de=O.charCodeAt(z),48>de||de>57){$=(de===46?r+O.slice(z+1):O.slice(z))+$,O=O.slice(0,z);break}}}w&&!_&&(O=e(O,1/0));var xe=H.length+O.length+$.length,ke=xe<b?new Array(b-xe+1).join(h):"";switch(w&&_&&(O=e(ke+O,ke.length?b-$.length:1/0),ke=""),f){case"<":O=H+O+$+ke;break;case"=":O=H+ke+O+$;break;case"^":O=ke.slice(0,xe=ke.length>>1)+H+O+$+ke.slice(xe);break;default:O=ke+H+O+$;break}return s(O)}return U.toString=function(){return d+""},U}function u(d,h){var f=c((d=ps(d),d.type="f",d)),p=Math.max(-8,Math.min(8,Math.floor(Gn(h)/3)))*3,g=Math.pow(10,-p),_=od[8+p/3];return function(b){return f(g*b)+_}}return{format:c,formatPrefix:u}}var Tr,rg,sg;UT({thousands:",",grouping:[3],currency:["$",""]});function UT(n){return Tr=LT(n),rg=Tr.format,sg=Tr.formatPrefix,Tr}function $T(n){return Math.max(0,-Gn(Math.abs(n)))}function zT(n,e){return Math.max(0,Math.max(-8,Math.min(8,Math.floor(Gn(e)/3)))*3-Gn(Math.abs(n)))}function VT(n,e){return n=Math.abs(n),e=Math.abs(e)-n,Math.max(0,Gn(e)-Gn(n))+1}function WT(n){var e=0,t=n.children,i=t&&t.length;if(!i)e=1;else for(;--i>=0;)e+=t[i].value;n.value=e}function HT(){return this.eachAfter(WT)}function jT(n,e){let t=-1;for(const i of this)n.call(e,i,++t,this);return this}function XT(n,e){for(var t=this,i=[t],r,s,o=-1;t=i.pop();)if(n.call(e,t,++o,this),r=t.children)for(s=r.length-1;s>=0;--s)i.push(r[s]);return this}function YT(n,e){for(var t=this,i=[t],r=[],s,o,a,l=-1;t=i.pop();)if(r.push(t),s=t.children)for(o=0,a=s.length;o<a;++o)i.push(s[o]);for(;t=r.pop();)n.call(e,t,++l,this);return this}function qT(n,e){let t=-1;for(const i of this)if(n.call(e,i,++t,this))return i}function KT(n){return this.eachAfter(function(e){for(var t=+n(e.data)||0,i=e.children,r=i&&i.length;--r>=0;)t+=i[r].value;e.value=t})}function ZT(n){return this.eachBefore(function(e){e.children&&e.children.sort(n)})}function GT(n){for(var e=this,t=QT(e,n),i=[e];e!==t;)e=e.parent,i.push(e);for(var r=i.length;n!==t;)i.splice(r,0,n),n=n.parent;return i}function QT(n,e){if(n===e)return n;var t=n.ancestors(),i=e.ancestors(),r=null;for(n=t.pop(),e=i.pop();n===e;)r=n,n=t.pop(),e=i.pop();return r}function JT(){for(var n=this,e=[n];n=n.parent;)e.push(n);return e}function eS(){return Array.from(this)}function tS(){var n=[];return this.eachBefore(function(e){e.children||n.push(e)}),n}function nS(){var n=this,e=[];return n.each(function(t){t!==n&&e.push({source:t.parent,target:t})}),e}function*iS(){var n=this,e,t=[n],i,r,s;do for(e=t.reverse(),t=[];n=e.pop();)if(yield n,i=n.children)for(r=0,s=i.length;r<s;++r)t.push(i[r]);while(t.length)}function Cc(n,e){n instanceof Map?(n=[void 0,n],e===void 0&&(e=oS)):e===void 0&&(e=sS);for(var t=new gs(n),i,r=[t],s,o,a,l;i=r.pop();)if((o=e(i.data))&&(l=(o=Array.from(o)).length))for(i.children=o,a=l-1;a>=0;--a)r.push(s=o[a]=new gs(o[a])),s.parent=i,s.depth=i.depth+1;return t.eachBefore(lS)}function rS(){return Cc(this).eachBefore(aS)}function sS(n){return n.children}function oS(n){return Array.isArray(n)?n[1]:null}function aS(n){n.data.value!==void 0&&(n.value=n.data.value),n.data=n.data.data}function lS(n){var e=0;do n.height=e;while((n=n.parent)&&n.height<++e)}function gs(n){this.data=n,this.depth=this.height=0,this.parent=null}gs.prototype=Cc.prototype={constructor:gs,count:HT,each:jT,eachAfter:YT,eachBefore:XT,find:qT,sum:KT,sort:ZT,path:GT,ancestors:JT,descendants:eS,leaves:tS,links:nS,copy:rS,[Symbol.iterator]:iS};function cS(n,e){switch(arguments.length){case 0:break;case 1:this.range(n);break;default:this.range(e).domain(n);break}return this}function uS(n){return function(){return n}}function dS(n){return+n}var ad=[0,1];function Bn(n){return n}function Za(n,e){return(e-=n=+n)?function(t){return(t-n)/e}:uS(isNaN(e)?NaN:.5)}function hS(n,e){var t;return n>e&&(t=n,n=e,e=t),function(i){return Math.max(n,Math.min(e,i))}}function fS(n,e,t){var i=n[0],r=n[1],s=e[0],o=e[1];return r<i?(i=Za(r,i),s=t(o,s)):(i=Za(i,r),s=t(s,o)),function(a){return s(i(a))}}function pS(n,e,t){var i=Math.min(n.length,e.length)-1,r=new Array(i),s=new Array(i),o=-1;for(n[i]<n[0]&&(n=n.slice().reverse(),e=e.slice().reverse());++o<i;)r[o]=Za(n[o],n[o+1]),s[o]=t(e[o],e[o+1]);return function(a){var l=Uv(n,a,1,i)-1;return s[l](r[l](a))}}function gS(n,e){return e.domain(n.domain()).range(n.range()).interpolate(n.interpolate()).clamp(n.clamp()).unknown(n.unknown())}function mS(){var n=ad,e=ad,t=wc,i,r,s,o=Bn,a,l,c;function u(){var h=Math.min(n.length,e.length);return o!==Bn&&(o=hS(n[0],n[h-1])),a=h>2?pS:fS,l=c=null,d}function d(h){return h==null||isNaN(h=+h)?s:(l||(l=a(n.map(i),e,t)))(i(o(h)))}return d.invert=function(h){return o(r((c||(c=a(e,n.map(i),at)))(h)))},d.domain=function(h){return arguments.length?(n=Array.from(h,dS),u()):n.slice()},d.range=function(h){return arguments.length?(e=Array.from(h),u()):e.slice()},d.rangeRound=function(h){return e=Array.from(h),t=hw,u()},d.clamp=function(h){return arguments.length?(o=h?!0:Bn,u()):o!==Bn},d.interpolate=function(h){return arguments.length?(t=h,u()):t},d.unknown=function(h){return arguments.length?(s=h,d):s},function(h,f){return i=h,r=f,u()}}function _S(){return mS()(Bn,Bn)}function yS(n,e,t,i){var r=jv(n,e,t),s;switch(i=ps(i??",f"),i.type){case"s":{var o=Math.max(Math.abs(n),Math.abs(e));return i.precision==null&&!isNaN(s=zT(r,o))&&(i.precision=s),sg(i,o)}case"":case"e":case"g":case"p":case"r":{i.precision==null&&!isNaN(s=VT(r,Math.max(Math.abs(n),Math.abs(e))))&&(i.precision=s-(i.type==="e"));break}case"f":case"%":{i.precision==null&&!isNaN(s=$T(r))&&(i.precision=s-(i.type==="%")*2);break}}return rg(i)}function bS(n){var e=n.domain;return n.ticks=function(t){var i=e();return Hv(i[0],i[i.length-1],t??10)},n.tickFormat=function(t,i){var r=e();return yS(r[0],r[r.length-1],t??10,i)},n.nice=function(t){t==null&&(t=10);var i=e(),r=0,s=i.length-1,o=i[r],a=i[s],l,c,u=10;for(a<o&&(c=o,o=a,a=c,c=r,r=s,s=c);u-- >0;){if(c=La(o,a,t),c===l)return i[r]=o,i[s]=a,e(i);if(c>0)o=Math.floor(o/c)*c,a=Math.ceil(a/c)*c;else if(c<0)o=Math.ceil(o*c)/c,a=Math.floor(a*c)/c;else break;l=c}return n},n}function Ga(){var n=_S();return n.copy=function(){return gS(n,Ga())},cS.apply(n,arguments),bS(n)}function Ae(n){return function(){return n}}function og(n){let e=3;return n.digits=function(t){if(!arguments.length)return e;if(t==null)e=null;else{const i=Math.floor(t);if(!(i>=0))throw new RangeError(`invalid digits: ${t}`);e=i}return n},()=>new MT(e)}function ag(n){return typeof n=="object"&&"length"in n?n:Array.from(n)}function lg(n){this._context=n}lg.prototype={areaStart:function(){this._line=0},areaEnd:function(){this._line=NaN},lineStart:function(){this._point=0},lineEnd:function(){(this._line||this._line!==0&&this._point===1)&&this._context.closePath(),this._line=1-this._line},point:function(n,e){switch(n=+n,e=+e,this._point){case 0:this._point=1,this._line?this._context.lineTo(n,e):this._context.moveTo(n,e);break;case 1:this._point=2;default:this._context.lineTo(n,e);break}}};function cg(n){return new lg(n)}function ug(n){return n[0]}function dg(n){return n[1]}function hg(n,e){var t=Ae(!0),i=null,r=cg,s=null,o=og(a);n=typeof n=="function"?n:n===void 0?ug:Ae(n),e=typeof e=="function"?e:e===void 0?dg:Ae(e);function a(l){var c,u=(l=ag(l)).length,d,h=!1,f;for(i==null&&(s=r(f=o())),c=0;c<=u;++c)!(c<u&&t(d=l[c],c,l))===h&&((h=!h)?s.lineStart():s.lineEnd()),h&&s.point(+n(d,c,l),+e(d,c,l));if(f)return s=null,f+""||null}return a.x=function(l){return arguments.length?(n=typeof l=="function"?l:Ae(+l),a):n},a.y=function(l){return arguments.length?(e=typeof l=="function"?l:Ae(+l),a):e},a.defined=function(l){return arguments.length?(t=typeof l=="function"?l:Ae(!!l),a):t},a.curve=function(l){return arguments.length?(r=l,i!=null&&(s=r(i)),a):r},a.context=function(l){return arguments.length?(l==null?i=s=null:s=r(i=l),a):i},a}function vS(n,e,t){var i=null,r=Ae(!0),s=null,o=cg,a=null,l=og(c);n=typeof n=="function"?n:n===void 0?ug:Ae(+n),e=typeof e=="function"?e:Ae(e===void 0?0:+e),t=typeof t=="function"?t:t===void 0?dg:Ae(+t);function c(d){var h,f,p,g=(d=ag(d)).length,_,b=!1,w,x=new Array(g),y=new Array(g);for(s==null&&(a=o(w=l())),h=0;h<=g;++h){if(!(h<g&&r(_=d[h],h,d))===b)if(b=!b)f=h,a.areaStart(),a.lineStart();else{for(a.lineEnd(),a.lineStart(),p=h-1;p>=f;--p)a.point(x[p],y[p]);a.lineEnd(),a.areaEnd()}b&&(x[h]=+n(_,h,d),y[h]=+e(_,h,d),a.point(i?+i(_,h,d):x[h],t?+t(_,h,d):y[h]))}if(w)return a=null,w+""||null}function u(){return hg().defined(r).curve(o).context(s)}return c.x=function(d){return arguments.length?(n=typeof d=="function"?d:Ae(+d),i=null,c):n},c.x0=function(d){return arguments.length?(n=typeof d=="function"?d:Ae(+d),c):n},c.x1=function(d){return arguments.length?(i=d==null?null:typeof d=="function"?d:Ae(+d),c):i},c.y=function(d){return arguments.length?(e=typeof d=="function"?d:Ae(+d),t=null,c):e},c.y0=function(d){return arguments.length?(e=typeof d=="function"?d:Ae(+d),c):e},c.y1=function(d){return arguments.length?(t=d==null?null:typeof d=="function"?d:Ae(+d),c):t},c.lineX0=c.lineY0=function(){return u().x(n).y(e)},c.lineY1=function(){return u().x(n).y(t)},c.lineX1=function(){return u().x(i).y(e)},c.defined=function(d){return arguments.length?(r=typeof d=="function"?d:Ae(!!d),c):r},c.curve=function(d){return arguments.length?(o=d,s!=null&&(a=o(s)),c):o},c.context=function(d){return arguments.length?(d==null?s=a=null:a=o(s=d),c):s},c}function ld(n){return n<0?-1:1}function cd(n,e,t){var i=n._x1-n._x0,r=e-n._x1,s=(n._y1-n._y0)/(i||r<0&&-0),o=(t-n._y1)/(r||i<0&&-0),a=(s*r+o*i)/(i+r);return(ld(s)+ld(o))*Math.min(Math.abs(s),Math.abs(o),.5*Math.abs(a))||0}function ud(n,e){var t=n._x1-n._x0;return t?(3*(n._y1-n._y0)/t-e)/2:e}function Uo(n,e,t){var i=n._x0,r=n._y0,s=n._x1,o=n._y1,a=(s-i)/3;n._context.bezierCurveTo(i+a,r+a*e,s-a,o-a*t,s,o)}function ms(n){this._context=n}ms.prototype={areaStart:function(){this._line=0},areaEnd:function(){this._line=NaN},lineStart:function(){this._x0=this._x1=this._y0=this._y1=this._t0=NaN,this._point=0},lineEnd:function(){switch(this._point){case 2:this._context.lineTo(this._x1,this._y1);break;case 3:Uo(this,this._t0,ud(this,this._t0));break}(this._line||this._line!==0&&this._point===1)&&this._context.closePath(),this._line=1-this._line},point:function(n,e){var t=NaN;if(n=+n,e=+e,!(n===this._x1&&e===this._y1)){switch(this._point){case 0:this._point=1,this._line?this._context.lineTo(n,e):this._context.moveTo(n,e);break;case 1:this._point=2;break;case 2:this._point=3,Uo(this,ud(this,t=cd(this,n,e)),t);break;default:Uo(this,this._t0,t=cd(this,n,e));break}this._x0=this._x1,this._x1=n,this._y0=this._y1,this._y1=e,this._t0=t}}};Object.create(ms.prototype).point=function(n,e){ms.prototype.point.call(this,e,n)};function dd(n){return new ms(n)}function bi(n,e,t){this.k=n,this.x=e,this.y=t}bi.prototype={constructor:bi,scale:function(n){return n===1?this:new bi(this.k*n,this.x,this.y)},translate:function(n,e){return n===0&e===0?this:new bi(this.k,this.x+this.k*n,this.y+this.k*e)},apply:function(n){return[n[0]*this.k+this.x,n[1]*this.k+this.y]},applyX:function(n){return n*this.k+this.x},applyY:function(n){return n*this.k+this.y},invert:function(n){return[(n[0]-this.x)/this.k,(n[1]-this.y)/this.k]},invertX:function(n){return(n-this.x)/this.k},invertY:function(n){return(n-this.y)/this.k},rescaleX:function(n){return n.copy().domain(n.range().map(this.invertX,this).map(n.invert,n))},rescaleY:function(n){return n.copy().domain(n.range().map(this.invertY,this).map(n.invert,n))},toString:function(){return"translate("+this.x+","+this.y+") scale("+this.k+")"}};bi.prototype;function Ci(n,e=new WeakMap){if(!n||typeof n!="object")return n;if(e.has(n))return e.get(n);const t={};e.set(n,t);for(const i in n)if(n.hasOwnProperty(i)&&i!=="parent"){const r=n[i];Array.isArray(r)?t[i]=r.map(s=>Ci(s,e)):r&&typeof r=="object"?t[i]=Ci(r,e):t[i]=r}return t}function hd(n,e="none"){if(!n)return n;if(e==="none")return Ci(n);if(e==="ignore"){const i=Ci(n);return fg(i),i}const t=Ci(n);return pg(t,e),t}function fg(n){n&&(n.length!==void 0&&n.length!==null&&n.length!==0&&(n.length=1),n.branch_length!==void 0&&n.branch_length!==null&&n.branch_length!==0&&(n.branch_length=1),n.children&&Array.isArray(n.children)&&n.children.forEach(e=>{fg(e)}))}function pg(n,e){n&&(n.length!==void 0&&n.length!==null&&(n.length=fd(n.length,e)),n.branch_length!==void 0&&n.branch_length!==null&&(n.branch_length=fd(n.branch_length,e)),n.children&&Array.isArray(n.children)&&n.children.forEach(t=>{pg(t,e)}))}function fd(n,e){if(n<=0)switch(e){case"log":return .001;default:return Math.max(.001,n)}let t;switch(e){case"none":t=n;break;case"log":t=Math.log10(n*1e3+1)*.1;break;case"sqrt":t=Math.sqrt(n);break;case"power2":t=Math.pow(n,2);break;case"linear-scale":t=n*2;break;default:console.warn(`[branchTransformUtils] Unknown transformation type: ${e}`),t=n}return!isFinite(t)||isNaN(t)||t<=0?(console.warn(`[branchTransformUtils] Transformation produced invalid result: ${t}, using fallback`),Math.max(.001,n)):t}function _s(n){return n&&n.data&&Array.isArray(n.data.split_indices)?`node-${n.data.split_indices.join("-")}`:`node-${n&&n.data&&n.data.name?n.data.name.toString().replace(/[^a-zA-Z0-9-_]/g,"_"):"unknown"}`}function xS(n){return n&&n.data&&Array.isArray(n.data.split_indices)?`label-${n.data.split_indices.join("-")}`:`label-${n&&n.data&&n.data.name?n.data.name.toString().replace(/[^a-zA-Z0-9-_]/g,"_"):"unknown"}`}const pd=n=>n&&n.data&&Array.isArray(n.data.split_indices)?n.data.split_indices.join("-"):"unknown";function gd(n){if(!n||!n.source||!n.target)throw new Error("Invalid link object");const e=pd(n.source),t=pd(n.target);return e==="unknown"||n.source.parent===null?`link-root-${t}`:`link-to-${t}`}function wS(n){return n&&n.data&&Array.isArray(n.data.split_indices)?`ext-${n.data.split_indices.join("-")}`:`ext-${n&&n.data&&n.data.name?n.data.name.toString().replace(/[^a-zA-Z0-9-_]/g,"_"):"unknown"}`}class TS{constructor(e){this.root=Cc(e),this.containerWidth=0,this.containerHeight=0,this.margin=0,this.scale=0,this.preserveRadius=!1,this.previousNodeRadii=new Map}indexLeafNodes(e,t=0){const i=this;return"children"in e||(e.index=t,t++),e.children&&e.children.forEach(function(r){t=i.indexLeafNodes(r,t)}),t}calcRadius(e,t=0){e.parent||(e.data.length=0);let i=e.data.length;const r=_s(e);this.preserveRadius&&this.previousNodeRadii.has(r)?e.radius=this.previousNodeRadii.get(r):(e.radius=i+t,this.previousNodeRadii.set(r,e.radius)),e.children&&e.children.forEach(s=>{this.calcRadius(s,e.radius)})}setRadiusPreservation(e){this.preserveRadius=e}calcAngle(e,t,i){const r=this;if(!e.children)e.angle=t/i*e.index;else{const s=[];e.children.forEach(o=>{s.push(r.calcAngle(o,t,i))}),e.angle=0,s.forEach(o=>{e.angle=e.angle+o}),e.angle=e.angle/s.length,e.children.forEach(o=>{o.parent_angle=e.angle})}return e.angle}setDimension(e,t){this.originalWidth=e,this.originalHeight=t,this.containerWidth=e,this.containerHeight=t}setMargin(e){this.margin=e,this.containerWidth=(this.originalWidth||this.containerWidth)-this.margin,this.containerHeight=(this.originalHeight||this.containerHeight)-this.margin}generateCoordinates(e){e.each(function(t){t.x=t.radius*Math.cos(t.angle),t.y=t.radius*Math.sin(t.angle)})}getMaxRadius(e){let t=0;return e.leaves().forEach(function(i){i.radius>t&&(t=i.radius)}),t}scaleRadius(e,t){e.each(function(i){i.radius=i.radius*t})}getMinContainerDimension(e,t){return Math.min(e,t)}constructRadialTreeWithUniformScaling(e){this.calcRadius(this.root,0),this.indexLeafNodes(this.root),this.calcAngle(this.root,Math.PI*2,this.root.leaves().length);const i=this.getMinContainerDimension(this.containerWidth,this.containerHeight)/(2*e);return this.scaleRadius(this.root,i),this.generateCoordinates(this.root),this.scale=i,this.root}constructRadialTree(e=!1){if(this.calcRadius(this.root,0),this.indexLeafNodes(this.root),this.calcAngle(this.root,Math.PI*2,this.root.leaves().length),!e){const t=this.getMinContainerDimension(this.containerWidth,this.containerHeight),i=this.getMaxRadius(this.root);this.scale=this.calculateContainerScale(t,i,2),this.scaleRadius(this.root,this.scale)}return this.generateCoordinates(this.root),this.root}calculateContainerScale(e,t,i){const s=this.containerWidth<600||this.containerHeight<600?i*.8:i;return e/s/t}}class gg{constructor(){this._scalingState={branchTransformation:void 0,calculationTransformation:"none"},this.webglContainer=be("#webgl-container"),this.startRenderLoop()}initializeUniformScaling(e="none"){const{treeList:t,transitionResolver:i}=M.getState(),r=(i==null?void 0:i.fullTreeIndices)||Array.from({length:t.length},(o,a)=>a),s=e!=="none"?t.map(o=>hd(o,e)):t;this.globalScaleList=mp(s,r),this.maxGlobalScale=gp(this.globalScaleList),this.uniformScalingEnabled=!0,this._scalingState.calculationTransformation=e}_recalculateUniformScalingForTransformation(e){this._scalingState.calculationTransformation!==e&&(console.log(`[WebGL Controller] Recalculating uniform scaling for transformation change: ${this._scalingState.calculationTransformation} â†’ ${e}`),this.initializeUniformScaling(e))}startRenderLoop(){}calculateLayout(e,t={}){const{treeIndex:i,cacheFunction:r,updateController:s=!1}=t,{branchTransformation:o}=M.getState();this._scalingState.branchTransformation!==void 0&&this._scalingState.branchTransformation!==o&&this.uniformScalingEnabled&&this._recalculateUniformScalingForTransformation(o),this._scalingState.branchTransformation=o;const c=this.webglContainer.node().getBoundingClientRect(),u=c.width,d=c.height,h=hd(e,o),f=new TS(h);f.setDimension(u,d),f.setMargin(40);let p,g;return this.uniformScalingEnabled&&this.globalScaleList&&this.maxGlobalScale?g=f.constructRadialTreeWithUniformScaling(this.maxGlobalScale):g=f.constructRadialTree(),p={tree:g,max_radius:f.getMaxRadius(g),width:u,height:d,margin:f.margin,scale:f.scale},s&&r&&i!==void 0&&r(i,p),p}updateLayout(e,t=0,i=null){return this.calculateLayout(e,{treeIndex:t,cacheFunction:i,updateController:!0})}startAnimation(){const{play:e}=M.getState();e(),this._animationLoop()}stopAnimation(){const{stop:e}=M.getState();e()}async _animationLoop(){}_getConsistentRadii(e,t=null,i=null){const r=e.width-e.margin*2,s=e.height-e.margin*2,o=Math.min(r,s)/2,{styleConfig:a}=M.getState(),l=(a==null?void 0:a.labelOffsets)||{DEFAULT:20,EXTENSION:5},c=o+(l.EXTENSION??5),u=c+(l.DEFAULT??20);return{extensionRadius:c,labelRadius:u,transformation:i||M.getState().branchTransformation}}destroy(){}}class SS{constructor(){this.isNavigating=!1}async execute(e){if(this.isNavigating){console.log("[NavigationController] Navigation locked, ignoring request.");return}this.isNavigating=!0;try{await e.execute()}catch(t){throw console.error("[NavigationController] Error during navigation execution:",t),t}finally{this.isNavigating=!1}}isLocked(){return this.isNavigating}forceUnlock(){console.warn("[NavigationController] Force unlocking navigation - this should only be used in emergencies"),this.isNavigating=!1}clearStickyPosition(){M.getState().clearStickyChartPosition()}setStickyPosition(e){M.getState().setStickyChartPosition(e)}getStickyPosition(){return M.getState().stickyChartPosition}getChartTreeIndex(e){const{currentTreeIndex:t,transitionResolver:i}=M.getState();return e==="scale"?t:i?i.getSourceTreeIndex(t):t}getChartNavigationCallbacks(){return{onGoToPosition:async e=>{console.log("[NavigationController] onGoToPosition called with idx:",e);const{goToPosition:t}=M.getState();console.log("[NavigationController] Calling store.goToPosition with:",e),t(e),console.log("[NavigationController] goToPosition completed")},onHandleDrag:async e=>{const{goToPosition:t}=M.getState();t(e)},onGoToFullTreeDataIndex:async e=>{const{setStickyChartPosition:t,goToPosition:i}=M.getState();t(e),i(e)}}}}class ES{constructor(e,t,i){this.svg=e,this.config=t,this.containerId=i,this.indicatorGroup=null}validatePosition(e,t){return Math.max(0,Math.min(t-1,e))}updateIndicatorPosition(e,t,i,r){const{xScale:s,yScale:o}=t,[a,l]=o.range(),c=Math.abs(l-a),u=this.validatePosition(e,i.length);let d=this.svg.select("#indicator-modal-group"),h=!1;return d.empty()&&(h=!0,d=this._createIndicatorGroup(c),this.indicatorGroup=d),this._updateIndicatorElements(d,u,i,t,c),(h||!d.property("__hasDrag"))&&(this._addDragBehavior(d,i,t,r),d.property("__hasDrag",!0)),d}_createIndicatorGroup(e){const t=this.svg.append("g").attr("id","indicator-modal-group").style("cursor","grab");return t.append("rect").attr("class","indicator-touch-target").attr("y",0).attr("width",30).attr("height",e).attr("fill","transparent"),t.append("line").attr("class","indicator-line").attr("y1",0).attr("y2",e).attr("stroke","var(--md-sys-color-secondary, #FF4500)").attr("stroke-width",2).attr("stroke-dasharray","5,5"),t.append("circle").attr("class","indicator-handle").attr("cy",e/2).attr("r",8).attr("fill","var(--md-sys-color-secondary, #FF4500)").attr("stroke","var(--md-sys-color-outline, #23242b)").attr("stroke-width",1.5),t.append("text").attr("class","handle-value").attr("y",e/2-15).attr("text-anchor","middle").attr("fill","var(--md-sys-color-primary, blue)").attr("font-weight","900").attr("font-size","16px").style("pointer-events","none"),t.append("text").attr("class","current-position-label").attr("y",e+17).attr("text-anchor","middle").attr("fill","var(--md-sys-color-secondary, #FF4500)").attr("font-weight","bold").attr("font-size","13px").style("pointer-events","none"),t}_updateIndicatorElements(e,t,i,r){const{xScale:s}=r,o=this.config.xAccessor,a=this.config.yAccessor,l=s(o(i[t],t));e.select(".indicator-touch-target").attr("x",l-15),e.select(".indicator-line").attr("x1",l).attr("x2",l),e.select(".indicator-handle").attr("cx",l),e.select(".handle-value").attr("x",l).text(Number.parseFloat(a(i[t])).toFixed(3)),e.select(".current-position-label").attr("x",l).text(`${t+1}`)}_addDragBehavior(e,t,i,r){const{xScale:s,yScale:o}=i,a=Wx().on("start",function(l){be(this).selectAll(".indicator-line").attr("stroke-width",3),be(this).selectAll(".indicator-handle").attr("r",10),be(this).style("cursor","grabbing"),be(this).classed("dragging",!0)}).on("drag",l=>{const c=l.x;let u=0,d=1/0;t.forEach((f,p)=>{const g=this.config.xAccessor,_=s(g(f,p)),b=Math.abs(c-_);b<d&&(d=b,u=p)}),u=this.validatePosition(u,t.length);const h=Math.abs(o.range()[1]-o.range()[0]);this._updateIndicatorElements(e,u,t,i,h),r(u)}).on("end",function(){be(this).selectAll(".indicator-line").attr("stroke-width",2),be(this).selectAll(".indicator-handle").attr("r",8),be(this).style("cursor","grab"),be(this).classed("dragging",!1)});e.call(a)}removeIndicator(){this.svg.select("#indicator-modal-group").remove(),this.indicatorGroup=null}getIndicatorGroup(){return this.indicatorGroup}hasIndicator(){return!this.svg.select("#indicator-modal-group").empty()}destroy(){this.removeIndicator(),this.svg=null,this.config=null,this.containerId=null,this.indicatorGroup=null}}function AS(n){const e=document.getElementById(n);if(!e)return{containerWidth:600,containerHeight:300,width:500,height:200,margin:{top:20,right:30,bottom:60,left:100}};let t=e.clientWidth||600;const i=e.clientHeight||300,r=e.closest(".movie-player-bar")!==null;r&&(t=Math.max(200,t));const s=r?{top:4,right:4,bottom:20,left:30}:{top:Math.max(20,i*.06),right:Math.max(30,t*.06),bottom:Math.max(60,i*.15),left:Math.max(100,t*.2)};console.log("[chartGenerator] Using margins:",s);const o={containerWidth:t,containerHeight:i,width:Math.max(100,t-s.left-s.right),height:Math.max(40,i-s.top-s.bottom),margin:s};return console.log("[chartGenerator] Final dimensions:",o),o}function CS(n,e,t,i){const r=n.map((g,_)=>i.xAccessor(g,_)),s=n.map(g=>i.yAccessor(g)),o=$v(r),a=Xv(s),l=Ga().domain(o).range([0,e]).nice(),c=Ga().domain([0,a*1.1]).range([t,0]).nice(),u=Math.floor(e/80),d=Math.min(Math.max(u,3),12),h=Math.max(1,o[1]-o[0]),f=Math.ceil(h/d),p=Yv(o[0],o[1]+1,f);return{xScale:l,yScale:c,actualTicks:p}}function IS(n,e){const{width:t,height:i,margin:r}=e;be(`#${n}`).select("svg").remove();const s=be(`#${n}`).append("svg").attr("width","100%").attr("height","100%").attr("viewBox",`0 0 ${t+r.left+r.right} ${i+r.top+r.bottom}`).attr("preserveAspectRatio","xMidYMid meet").style("font-family","Heebo, sans-serif");return s.append("defs").append("clipPath").attr("id",`clip-${n}`).append("rect").attr("width",t).attr("height",i),s.append("g").attr("transform",`translate(${r.left},${r.top})`)}function RS(n,e,t,i){const{xScale:r,yScale:s,actualTicks:o}=e,{width:a,height:l,margin:c}=t,d=n.node().closest(".movie-player-bar")!==null,h=n.append("g").attr("class","x axis").attr("transform",`translate(0, ${l})`).call(Lu(r).tickValues(o)).selectAll("text").style("font-size",d?"var(--md-sys-typescale-label-small-size, 9px)":"var(--md-sys-typescale-label-medium-size, 12px)").style("fill","var(--md-sys-color-on-surface-variant, rgba(255,255,255,0.8))").style("font-family","var(--md-sys-typescale-label-medium-font, Heebo, sans-serif)").attr("transform","rotate(-45)").style("text-anchor","end").attr("dx","-0.4em").attr("dy","0.7em");return n.append("g").attr("class","y axis").call(Uu(s).ticks(d?3:5)).selectAll("text").style("font-size",d?"var(--md-sys-typescale-label-small-size, 9px)":"var(--md-sys-typescale-label-medium-size, 12px)").style("fill","var(--md-sys-color-on-surface-variant, rgba(255,255,255,0.8))").style("font-family","var(--md-sys-typescale-label-medium-font, Heebo, sans-serif)"),n.selectAll(".axis path, .axis line").style("stroke","var(--md-sys-color-outline-variant, rgba(255,255,255,0.3))"),n.append("g").attr("class","grid x-grid").attr("transform",`translate(0, ${l})`).call(Lu(r).tickValues(o).tickSize(-l).tickFormat("")).selectAll(".tick line").style("stroke","var(--md-sys-color-outline, rgba(255,255,255,0.1))").style("stroke-dasharray","var(--md-sys-spacing-xsmall, 3), var(--md-sys-spacing-xsmall, 3)"),n.append("g").attr("class","grid y-grid").call(Uu(s).ticks(5).tickSize(-a).tickFormat("")).selectAll(".tick line").style("stroke","var(--md-sys-color-outline, rgba(255,255,255,0.1))").style("stroke-dasharray","var(--md-sys-spacing-xsmall, 3), var(--md-sys-spacing-xsmall, 3)"),n.selectAll(".grid path").style("display","none"),n.append("text").attr("class","x-label").attr("text-anchor","middle").attr("x",a/2).attr("y",l+c.bottom-10).text(i.xLabel).style("font-size","var(--md-sys-typescale-title-small-size, 14px)").style("fill","var(--md-sys-color-on-surface, rgba(255,255,255,0.9))").style("font-family","var(--md-sys-typescale-title-small-font, Heebo, sans-serif)"),n.append("text").attr("class","y-label").attr("text-anchor","middle").attr("transform","rotate(-90)").attr("x",-l/2).attr("y",-c.left+15).text(i.yLabel).style("font-size","var(--md-sys-typescale-title-small-size, 14px)").style("fill","var(--md-sys-color-on-surface, rgba(255,255,255,0.9))").style("font-family","var(--md-sys-typescale-title-small-font, Heebo, sans-serif)"),h}function PS(n,e,t,i,r){const{xScale:s,yScale:o}=t,a=vS().x((d,h)=>s(i.xAccessor(d,h))).y0(o(0)).y1(d=>o(i.yAccessor(d))).curve(dd),l=n.append("path").datum(e).attr("class","area").attr("fill","var(--md-sys-color-primary-container, rgba(67,144,225,0.1))").attr("d",a).attr("clip-path",`url(#clip-${r})`),c=hg().x((d,h)=>s(i.xAccessor(d,h))).y(d=>o(i.yAccessor(d))).curve(dd),u=n.append("path").datum(e).attr("class","line").attr("fill","none").attr("stroke","var(--md-sys-color-primary, #4390e1)").attr("stroke-width",2.5).attr("d",c).style("filter","var(--md-sys-elevation-level1, drop-shadow(0px 1px 3px rgba(0,0,0,0.3)))").attr("clip-path",`url(#clip-${r})`);return{chartArea:l,chartLine:u}}function MS(n,e,t,i,r,s=null){console.log("chartGenerator: updateIndicatorPosition called with position:",n);const o=be(`#${r}`).select("svg").select("g");let a=o.property("__indicator");a?console.log("chartGenerator: Using existing ChartIndicator instance"):(console.log("chartGenerator: Creating new ChartIndicator instance"),a=new ES(o,t,r),o.property("__indicator",a)),console.log("chartGenerator: Calling indicator.updateIndicatorPosition");const l=a.updateIndicatorPosition(n,e,i,s);return console.log("chartGenerator: indicator.updateIndicatorPosition completed"),l}function kS(n,e,t,i=null){const r=AS(t);be(`#${t}`).select("svg").remove(),be(`#${t}`).selectAll(".chart-tooltip").remove();const s=document.getElementById(t);s&&(s.classList.add("loading"),setTimeout(()=>s.classList.remove("loading"),100));const o=IS(t,r);let{xScale:a,yScale:l,actualTicks:c}=CS(n,r.width,r.height,e);return PS(o,n,{xScale:a,yScale:l},e,t),RS(o,{xScale:a,yScale:l,actualTicks:c},r,e),{updatePositionChartIndex:u=>{console.log("chartGenerator: updatePositionChartIndex called with:",u);const d=MS(u,{xScale:a,yScale:l},e,n,t,i);return console.log("chartGenerator: updateIndicatorPosition completed"),d},destroy:()=>{const u=document.getElementById(t);u&&(be(u).select("svg").remove(),be(u).selectAll(".chart-tooltip").remove())}}}function mg(n,e,t,i=null){return kS(e,t,n,i)}function OS(n,e,t){const i="chart-modal-"+Date.now(),r=document.createElement("div");r.id=i,r.style.cssText=`
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 800px;
    height: 600px;
    background: white;
    border: 1px solid #ccc;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    z-index: 1000;
    padding: 20px;
    box-sizing: border-box;
  `;const s=document.createElement("button");s.textContent="Ã—",s.style.cssText=`
    position: absolute;
    top: 10px;
    right: 15px;
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
  `,s.onclick=()=>r.remove(),r.appendChild(s);const o=document.createElement("h3");o.textContent=t.title||"Chart",o.style.marginTop="0",r.appendChild(o);const a=document.createElement("div");return a.id=i+"-chart",a.style.cssText="width: 100%; height: calc(100% - 60px);",r.appendChild(a),document.body.appendChild(r),setTimeout(()=>{mg(a.id,n,t,e.goToPosition)},100),r}function NS({data:n,config:e,services:t,chartState:i,callbacks:r,containerId:s}){console.log("*** lineChartManager: renderOrUpdateLineChart called ***");const{robinsonFouldsDistances:o,weightedRobinsonFouldsDistances:a,scaleList:l}=n,{barOptionValue:c,currentTreeIndex:u}=e,{transitionResolver:d}=t;let h,f,p,g,_,b,w;c==="rfd"?(h=o,f="Transition Index",p="Relative RFD",g=1,_=(S,I)=>I+1,b=S=>S,w=(S,I)=>`Transition ${I+1}<br>RFD: ${S.toFixed(3)}`):c==="w-rfd"?(h=a,f="Transition Index",p="Weighted RFD",g=Math.max(...a),_=(S,I)=>I+1,b=S=>S,w=(S,I)=>`Transition ${I+1}<br>Weighted RFD: ${S.toFixed(3)}`):c==="scale"&&(h=l.map(S=>S.value),f="Sequence Index",p="Scale",g=Math.max(...l.map(S=>S.value)),_=(S,I)=>I+1,b=S=>S,w=(S,I)=>`Sequence ${I+1}<br>Scale: ${S.toFixed(3)}`);const y=mg(s,h,{xLabel:f,yLabel:p,yMax:g,xAccessor:_,yAccessor:b,tooltipFormatter:w},S=>{r.onGoToPosition(d.getTreeIndexForDistanceIndex(S))});return i.instance={updatePosition:S=>{const{barOptionValue:I,transitionResolver:F}=M.getState();console.log("=== lineChartManager: updatePosition START ==="),console.log("position:",S,"current barOptionValue:",I);let D;I==="rfd"||I==="w-rfd"?D=F.getSourceTreeIndex(S):D=S,y!=null&&y.updatePositionChartIndex?(console.log("Calling chartResult.updatePositionChartIndex with chartIndex:",D),y.updatePositionChartIndex(D)):console.error("chartResult.updatePositionChartIndex is missing!"),console.log("=== lineChartManager: updatePosition END ===")},destroy:()=>{y&&typeof y.destroy=="function"&&y.destroy()}},i.type=c,i}function _o(n=M.getState()){var a;const e=n.currentTreeIndex||0,t=n.transitionResolver,i=(t==null?void 0:t.fullTreeIndices)||[],r=t?t.getSourceTreeIndex(e):0,s=i.indexOf(e),o=s>=0?i[s]??-1:-1;return{sequenceIndex:e,distanceIndex:r,fullTreeIndex:s,fullTreeSeqIndex:o,totalSequenceLength:((a=n.treeList)==null?void 0:a.length)||0,totalFullTrees:i.length}}function Ii(n=M.getState()){const{fullTreeIndex:e}=_o(n);if(e>=0)return e;const t=n.currentTreeIndex||0,i=n.transitionResolver,r=(i==null?void 0:i.fullTreeIndices)||[];let s=0;for(let o=r.length-1;o>=0;o--)if(r[o]<=t){s=o;break}return s}function FS(n){const e=document.querySelector('.winbox[data-chart="true"]');e&&e.remove();const{barOptionValue:t,currentTreeIndex:i,robinsonFouldsDistances:r,weightedRobinsonFouldsDistances:s,scaleList:o,transitionResolver:a,onGoToFullTreeDataIndex:l,onGoToPosition:c}=n;let u,d,h,f,p;if(t==="rfd"?(u=r,d="Transition Index",h="Relative RFD",f=1,p="Relative Robinson-Foulds Distance"):t==="w-rfd"?(u=s,d="Transition Index",h="Weighted RFD",f=s&&s.length>0?Math.max(...s):0,p="Weighted Robinson-Foulds Distance"):t==="scale"?(u=o.map(b=>b.value),d="Sequence Index",h="Scale",f=o.length>0?Math.max(...o.map(b=>b.value)):0,p="Scale Value"):(u=[],d="Index",h="Value",f=0,p="Chart"),!u||u.length===0){alert(`No data for ${t} chart.`);return}OS(u,{getCurrentPosition:()=>{const b=M.getState();return t==="scale"?b.getNearestAnchorChartIndex():_o(b).distanceIndex},goToPosition:b=>{const{clearStickyChartPosition:w,goToPosition:x}=M.getState();if(w(),t==="scale"){const y=a.fullTreeIndices||[],S=y[Math.max(0,Math.min(y.length-1,b))]??0;x(S)}else x(a.getTreeIndexForDistanceIndex(b))},barOptionValue:t,robinsonFouldsDistances:r,weightedRobinsonFouldsDistances:s,scaleList:o,transitionResolver:a},{xLabel:d,yLabel:h,yMax:f,title:p,xAccessor:(b,w)=>w+1,yAccessor:b=>b,tooltipFormatter:(b,w)=>`<div class='tooltip-title'>Position ${w+1}</div><div class='tooltip-value'>Value: ${typeof b=="number"?b.toFixed(4):b}</div>`})}class DS{constructor(e,t){console.log("ChartController: constructor called"),this.currentDistanceChartState=null,this.currentDistanceChart=null,this.lastChartType=null,this.gui=e,this.navigationController=t,M.subscribe(i=>i.barOptionValue,i=>{this.updateChart()}),M.subscribe(i=>i.currentTreeIndex,(i,r)=>{if(i!==r){console.log("*** TIMELINE MOVED: currentTreeIndex =",i);try{this.updateIndicatorPosition(i)}catch(s){console.error("ChartController: Error in updateIndicatorPosition:",s)}}}),console.log("ChartController: Scheduling initial chart update"),setTimeout(()=>this.updateChart(),0)}async updateChart(){var f;const t=M.getState().getLineChartProps();this.currentDistanceChartState=this.currentDistanceChartState||{instance:null,type:null};const{barOptionValue:i,currentTreeIndex:r,robinsonFouldsDistances:s,weightedRobinsonFouldsDistances:o,scaleList:a,transitionResolver:l}=t,c={robinsonFouldsDistances:s,weightedRobinsonFouldsDistances:o,scaleList:a},u={barOptionValue:i,currentTreeIndex:r},d={transitionResolver:l};this.currentDistanceChartState.instance&&this.currentDistanceChartState.instance.destroy&&this.currentDistanceChartState.instance.destroy(),this.currentDistanceChartState=NS({data:c,config:u,services:d,chartState:this.currentDistanceChartState,callbacks:this.navigationController.getChartNavigationCallbacks(),containerId:"lineChart"}),this.currentDistanceChart=this.currentDistanceChartState.instance,this.lastChartType=this.currentDistanceChartState.type,console.log("ChartController: Chart updated, currentDistanceChart is:",this.currentDistanceChart),console.log("ChartController: Chart has updatePosition method:",!!((f=this.currentDistanceChart)!=null&&f.updatePosition));const h=M.getState().currentTreeIndex;this.updateIndicatorPosition(h)}updateIndicatorPosition(e){var i;const t=(i=this.currentDistanceChartState)==null?void 0:i.instance;if(console.log("ChartController: updateIndicatorPosition called",{currentTreeIndex:e,hasChart:!!t,hasUpdateMethod:!!(t!=null&&t.updatePosition)}),!t){console.warn("ChartController: No current distance chart state instance");return}if(!t.updatePosition){console.warn("ChartController: Chart has no updatePosition method");return}console.log("ChartController: Calling chart.updatePosition with currentTreeIndex:",e),t.updatePosition(e),console.log("ChartController: chart.updatePosition completed")}async displayCurrentChartInModal(){const{stop:e,barOptionValue:t,currentTreeIndex:i,movieData:r,transitionResolver:s}=M.getState();e(),FS({barOptionValue:t,currentTreeIndex:i,robinsonFouldsDistances:r.distances.robinson_foulds,weightedRobinsonFouldsDistances:r.distances.weighted_robinson_foulds,scaleList:r.scaleList,transitionResolver:s,onGoToFullTreeDataIndex:this.navigationController.getChartNavigationCallbacks().onGoToFullTreeDataIndex,onGoToPosition:this.navigationController.getChartNavigationCallbacks().onGoToPosition})}setBarOptionValue(e){M.getState().setBarOption(e)}getBarOptionValue(){return M.getState().barOptionValue}getCurrentChart(){return this.currentDistanceChart}getChartState(){return this.currentDistanceChartState}resetChartState(){this.currentDistanceChartState=null,this.currentDistanceChart=null,this.lastChartType=null}isChartDataReady(){return M.getState().movieData!==null}handleResize(){}}class BS{constructor(e){this.gui=e,this.elements={currentScaleText:document.getElementById("currentScaleText"),maxScaleText:document.getElementById("maxScaleText"),scaleProgressBar:document.querySelector(".scale-progress-bar")},Object.entries(this.elements).forEach(([t,i])=>{i||console.warn(`[UIController] Element not found: ${t}`)})}update(){const{movieData:e}=M.getState(),t=e.maxScale,i=e.scaleList,{currentTreeIndex:r,transitionResolver:s}=M.getState(),o=s.getSourceTreeIndex(r),a=Sb(i,o);if(this.elements.currentScaleText&&(this.elements.currentScaleText.innerText=Pu(a)),this.elements.maxScaleText&&(this.elements.maxScaleText.innerText=Pu(t)),this.elements.scaleProgressBar){const l=Eb(a,t);this.elements.scaleProgressBar.style.height=`${l}%`}}destroy(){this.elements={},this.gui=null}}function ys(n,e,t,i){if(n<0){console.warn("[calculateWindow] Invalid currentFullTreeDataIdx:",n);const c=t&&t>0?t:100;return{startPosition:1,midPosition:1,endPosition:Math.max(1,c)}}(!e||e<=0)&&(console.warn("[calculateWindow] Invalid msaStepSize:",e),e=1),(!t||t<=0)&&(console.warn("[calculateWindow] Invalid msaWindowSize:",t),t=100);let r=1+n*e,s=Math.floor(t/2),o=Math.floor((t-1)/2),a=r-s,l=r+o;return a=Math.max(1,a),l=Math.min(i,l),r=Math.max(1,Math.min(i,r)),{startPosition:a,midPosition:r,endPosition:l}}const K={UNIT_DURATION_MS:1e3,MIN_ZOOM_MS:100,ZOOM_PERCENTAGE_UI:.3,TIMELINE_HEIGHT:"35px",MAX_ZOOM_FACTOR:2,SCRUB_THROTTLE_MS:16,SCRUB_END_TIMEOUT_MS:500,DEFAULT_TREE_INDEX:0,DEFAULT_SEGMENT_INDEX:-1,DEFAULT_PROGRESS:0,MIN_PROGRESS:0,MAX_PROGRESS:1,DEFAULT_TREE_IN_SEGMENT:1,DEFAULT_TREES_IN_SEGMENT:1,INDEX_OFFSET_UI:1,MAX_TOOLTIP_LEAVES:5,DURATION_COMPLEXITY_WEIGHT:.6,EDGE_COMPLEXITY_WEIGHT:.4,DEFAULT_COMPLEXITY:.5,DEFAULT_MAX_EDGES:15,FALLBACK_MAX_EDGES:10},md={DOWN_PHASE:"Down",COLLAPSE_PHASE:"Collapse",REORDER_PHASE:"Reorder",PRE_SNAP_PHASE:"Pre-Snap",SNAP_PHASE:"Snap",ORIGINAL:"Original"},LS={movieTimelineCount:"movieTimelineCount",currentPositionInfo:"currentPositionInfo",interpolationStatus:"interpolationStatus",zoomInBtn:"zoomInBtn",zoomOutBtn:"zoomOutBtn",fitToWindowBtn:"fitToWindowBtn",scrollToStartBtn:"scrollToStartBtn",scrollToEndBtn:"scrollToEndBtn",hudPositionInfo:"hudPositionInfo",hudSegmentInfo:"hudSegmentInfo",hudWindowStart:"hudWindowStart",hudWindowMid:"hudWindowMid",hudWindowEnd:"hudWindowEnd"};class $e{static progressToTime(e,t){return this.clampProgress(e)*t}static timeToProgress(e,t){return!t||t===0?K.DEFAULT_PROGRESS:this.clampProgress(e/t)}static clampProgress(e){return Math.max(K.MIN_PROGRESS,Math.min(K.MAX_PROGRESS,e))}static findSegmentForTreeIndex(e,t){var i,r,s,o,a;if(!e||e.length===0)return{segmentIndex:K.DEFAULT_SEGMENT_INDEX,timeInSegment:K.DEFAULT_PROGRESS,segment:null};for(let l=0;l<e.length;l++){const c=e[l];if(c.isFullTree){if(((r=(i=c.interpolationData)==null?void 0:i[0])==null?void 0:r.originalIndex)===t)return{segmentIndex:l,timeInSegment:0,segment:c}}else if(c.hasInterpolation&&((s=c.interpolationData)==null?void 0:s.length)>1){const u=c.interpolationData;for(let d=0;d<u.length;d++)if(u[d].originalIndex===t){const h=d*K.UNIT_DURATION_MS;return{segmentIndex:l,timeInSegment:h,segment:c}}}else if(((a=(o=c.interpolationData)==null?void 0:o[0])==null?void 0:a.originalIndex)===t)return{segmentIndex:l,timeInSegment:K.DEFAULT_PROGRESS,segment:c}}return{segmentIndex:K.DEFAULT_SEGMENT_INDEX,timeInSegment:K.DEFAULT_PROGRESS,segment:null}}static getTargetTreeForTime(e,t,i,r="nearest"){var u,d;let s=0,o=e.length-1,a=0,l=0;for(let h=0;h<e.length;h++){const f=i[h],p=s+f;if(h===e.length-1&&t>=p){o=h;break}if(t<p){o=h;break}if(t===p&&f===0){o=h;break}s=p}s=0;for(let h=0;h<o;h++)s+=i[h];if(a=s,l=i[o],o>=0&&o<e.length&&l>=0){const h=e[o];if(h.isFullTree)return{treeIndex:h.interpolationData[0].originalIndex,segmentIndex:o,segmentProgress:.5};const p=(Math.max(a+this.EPSILON_MS,Math.min(t,a+l-this.EPSILON_MS))-a)/l;if(h.hasInterpolation&&h.interpolationData.length>1){const g=p*(h.interpolationData.length-1);let _;r==="forward"?_=Math.ceil(g-1e-8):r==="backward"?_=Math.floor(g+1e-8):_=Math.round(g);const b=Math.max(0,Math.min(_,h.interpolationData.length-1));return{treeIndex:h.interpolationData[b].originalIndex,segmentIndex:o,segmentProgress:this.clampProgress(p)}}else return{treeIndex:h.interpolationData[0].originalIndex,segmentIndex:o,segmentProgress:K.DEFAULT_PROGRESS}}const c=e[Math.max(0,Math.min(o,e.length-1))];return{treeIndex:((d=(u=c==null?void 0:c.interpolationData)==null?void 0:u[0])==null?void 0:d.originalIndex)||K.DEFAULT_TREE_INDEX,segmentIndex:Math.max(0,Math.min(o,e.length-1)),segmentProgress:K.DEFAULT_PROGRESS}}static clampTimeForFinalization(e,t,i,r="nearest"){try{if(!(e!=null&&e.length)||!(i!=null&&i.length))return t;const s=(()=>{const h=new Array(i.length);let f=0;for(let p=0;p<i.length;p++)f+=i[p],h[p]=f;return h})();let o=0,a=s.length-1,l=-1;for(;o<=a;){const h=o+a>>1;t<s[h]?(l=h,a=h-1):o=h+1}l<0&&(l=0);const c=l===0?0:s[l-1],u=s[l],d=e[l];if(d!=null&&d.isFullTree){if(r==="forward"&&l<e.length-1){const h=s[l+1];return Math.min(h-this.EPSILON_MS,u+this.EPSILON_MS)}return r==="backward"?Math.max(0,c-this.EPSILON_MS):c+Math.max(1,Math.floor((u-c)/2))}return Math.max(c+this.EPSILON_MS,Math.min(t,u-this.EPSILON_MS))}catch{return t}}static calculateTreePositionInSegment(e,t){var r;if(!e||!e.hasInterpolation||!((r=e.interpolationData)!=null&&r.length))return{treeInSegment:K.DEFAULT_TREE_IN_SEGMENT,treesInSegment:K.DEFAULT_TREES_IN_SEGMENT};const i=e.interpolationData.length;if(i>1){const s=e.interpolationData.findIndex(a=>a.originalIndex===t);return{treeInSegment:s!==-1?s+K.INDEX_OFFSET_UI:K.DEFAULT_TREE_IN_SEGMENT,treesInSegment:i}}return{treeInSegment:K.DEFAULT_TREE_IN_SEGMENT,treesInSegment:K.DEFAULT_TREES_IN_SEGMENT}}static calculateTimeForSegment(e,t,i=K.DEFAULT_PROGRESS,r=null){const s=r||this.calculateSegmentDurations(e);let o=0;for(let u=0;u<t&&u<s.length;u++)o+=s[u];const a=e==null?void 0:e[t],l=(s==null?void 0:s[t])??0;let c=i;return a&&!a.isFullTree&&(c=Math.max(this.EPSILON_MS,Math.min(i,l-this.EPSILON_MS))),o+=c,o}static calculateSegmentDurations(e){return e!=null&&e.length?e.map(t=>{var i;return t.isFullTree?0:t.hasInterpolation&&((i=t.interpolationData)==null?void 0:i.length)>1?t.interpolationData.length*K.UNIT_DURATION_MS:K.UNIT_DURATION_MS}):[]}static getInterpolationDataForProgress(e,t,i){if(!t||!i||!i.interpolated_trees)return null;const r=this.clampProgress(e),s=t.length,o=r*(s-1),a=Math.floor(o),l=Math.min(a+1,s-1),c=o-a;return{fromTree:i.interpolated_trees[a],toTree:i.interpolated_trees[l],timeFactor:c,fromIndex:a,toIndex:l}}}m($e,"EPSILON_MS",1);class _d{static createSegments(e){const t=e&&typeof e.getTreeMetadata=="function",i=t?e.getTreeMetadata():e.tree_metadata,r=t?e.getTrees().interpolatedTrees:e.interpolated_trees;let s;return s=e.split_change_timeline,this._createSegmentsFromSplitChangeTimeline(s,i,r,e.split_change_tracking,e.tree_pair_solutions)}static _createSegmentsFromSplitChangeTimeline(e,t,i,r,s){var a,l;const o=[];if(console.log("[TimelineDataProcessor] timeline:",e,"type:",typeof e,"isArray:",Array.isArray(e)),!e||!Array.isArray(e))return console.warn("[TimelineDataProcessor] split_change_timeline is not available or not an array, falling back to empty segments"),o;for(const c of e)if(c.type==="original"){const d=c.global_index,h=c.tree_index;if(d>=0&&d<i.length){const f=t[d];o.push({index:o.length,metadata:f,tree:i[d],activeChangeEdge:null,phase:(f==null?void 0:f.phase)||md.ORIGINAL,activeChangeEdgeTracker:null,treePairKey:null,stepInPair:null,treeName:c.name||`Anchor Tree ${h+1}`,hasInterpolation:!1,isFullTree:!0,treeInfo:null,subtreeMoveCount:0,interpolationData:[{metadata:f,tree:i[d],originalIndex:d}]})}}else if(c.type==="split_event"){const u=c.step_range_global,d=[];for(let h=u[0];h<=u[1];h++){const f=h-1;f>=0&&f<i.length&&d.push({metadata:t[f],tree:i[f],originalIndex:f})}if(d.length>0){const h=d[0];let f=0;if(h.metadata&&r&&s){const p=h.originalIndex,g=r[p],_=h.metadata.tree_pair_key;if(g&&_&&s[_]){const b=s[_].jumping_subtree_solutions,w=`[${g.join(", ")}]`,x=b==null?void 0:b[w];x&&(f=Array.from(x.flat()).length)}}f===0&&(f=c.split?c.split.length:0),o.push({index:o.length,metadata:h.metadata,tree:h.tree,activeChangeEdge:c.split||[],phase:((a=h.metadata)==null?void 0:a.phase)||md.ORIGINAL,activeChangeEdgeTracker:c.split||[],treePairKey:c.pair_key,stepInPair:(l=c.step_range_local)==null?void 0:l[0],treeName:`Transition ${c.pair_key}`,hasInterpolation:!0,isFullTree:!1,treeInfo:null,subtreeMoveCount:f,interpolationData:d})}}return o}static createTimelineData(e){const t=$e.calculateSegmentDurations(e),i=(()=>{const a=new Array(t.length);let l=0;for(let c=0;c<t.length;c++)l+=t[c],a[c]=l;return a})(),r=t.reduce((a,l)=>a+l,0);let s=1/0,o=-1/0;for(const a of e){const l=typeof a.subtreeMoveCount=="number"?a.subtreeMoveCount:0;a.isFullTree||(s=Math.min(s,l),o=Math.max(o,l))}return{totalDuration:r,segmentDurations:t,cumulativeDurations:i,minSubtreeMoves:s,maxSubtreeMoves:o}}}class US{constructor(){this.elements=this._queryElements()}_formatTransitionText(e,t=0){const i=t!=null?Math.round(t*100):0;let r="";if(console.log("[TimelineUI] _formatTransitionText called with treePairKey:",e,"transitionProgress:",t,"percent:",i),typeof e=="string"){const o=e.match(/pair_(\d+)_(\d+)/);if(o){const a=parseInt(o[1],10)+1,l=parseInt(o[2],10)+1;r=`Tree ${a} â†’ ${l}`}}const s=r?`${r} (${i}%)`:`Interpolation: ${i}%`;return{fromTo:r,percent:i,formattedText:s}}_createVisualIndicator(e,t,i="â—",r="â—‹"){if(t<=1)return"";const s=Math.max(1,Math.min(e,t));let o="";for(let a=1;a<=t;a++)o+=a<=s?i:r;return o}_createMaterialProgressBar(e,t){if(t<=1)return null;const i=Math.max(1,Math.min(e,t)),r=(i-1)/(t-1),s=document.createElement("md-linear-progress");return s.value=r,s.setAttribute("aria-label",`Step ${i} of ${t}`),s.style.cssText=`
            width: 80px;
            height: 6px;
            --md-linear-progress-track-height: 6px;
            --md-linear-progress-active-indicator-height: 6px;
            --md-linear-progress-track-shape: 6px;
            vertical-align: middle;
            margin-inline: 6px;
        `,s}_createTimelineProgressBar(e){const t=Math.max(0,Math.min(1,e)),i=document.createElement("md-linear-progress");return i.value=t,i.setAttribute("aria-label",`Timeline progress ${Math.round(t*100)}%`),i.style.cssText=`
            width: 80px;
            height: 6px;
            --md-linear-progress-track-height: 6px;
            --md-linear-progress-active-indicator-height: 6px;
            --md-linear-progress-track-shape: 6px;
            vertical-align: middle;
            margin-inline: 6px;
        `,i}_queryElements(){const e={};return Object.entries(LS).forEach(([t,i])=>{e[t]=document.getElementById(i)}),e}refreshElements(){return this.elements=this._queryElements(),this.validateElements()}updateMetrics(e,t=null){if(this.elements.movieTimelineCount||this.refreshElements(),this.elements.movieTimelineCount){const i=t!==null?`${e} trees (${t} segments)`:`${e} trees`;this.elements.movieTimelineCount.textContent=i}}updatePositionDisplay({progress:e,currentTree:t,totalTrees:i,treeInSegment:r,treesInSegment:s}){let a=`${Math.round(e*100)}%`;const l=c=>{if(c)if(c.innerHTML="",t!==null&&i!==null&&i>1){const u=this._createTimelineProgressBar(e);if(u){const d=document.createElement("span");d.style.cssText="display: inline-flex; align-items: center; gap: 8px;",d.appendChild(u);const h=document.createElement("span");h.textContent=a,d.appendChild(h),c.appendChild(d)}else c.textContent=a}else c.textContent=a};this.elements.currentPositionInfo||this.refreshElements(),l(this.elements.currentPositionInfo),l(this.elements.hudPositionInfo)}updateSegmentInfo(e,t,i){var o;let r="";if(e!=null&&e.isFullTree){const a=((o=i.getNearestAnchorChartIndex)==null?void 0:o.bind(i))||null,l=typeof a=="function"?a()+1:null;r=l?`Original tree ${l}`:"Original tree"}else if(e!=null&&e.hasInterpolation){const{formattedText:a}=this._formatTransitionText(e.treePairKey,t);r=a}else r="Interpolation: 0%";const s=document.getElementById("segmentInfo");s&&(s.textContent=r),this.elements.hudSegmentInfo&&(this.elements.hudSegmentInfo.textContent=r)}updateTransitionIndicator(e,t,i){if(!this.elements.transitionIndicator&&(this.refreshElements(),!this.elements.transitionIndicator))return;const r=this.elements.tiLine1,s=this.elements.tiLine2;if(e!=null&&e.hasInterpolation&&r&&s){const{fromTo:o,percent:a}=this._formatTransitionText(e.treePairKey,i);r.textContent=o?`${o} â€¢ ${a}%`:`Interpolation â€¢ ${a}%`;const l=Array.isArray(t)?t.length:0;s.textContent=l>0?`Changing: ${l} leaves`:"Changing: none",this.elements.transitionIndicator.style.display="block"}else this.elements.transitionIndicator&&(this.elements.transitionIndicator.style.display="none")}clear(){["movieTimelineCount","currentPositionInfo"].forEach(t=>{const i=this.elements[t];i&&(i.textContent="")})}setupButtonHandlers(e){const t={zoomInBtn:e.zoomIn,zoomOutBtn:e.zoomOut,fitToWindowBtn:e.fitToWindow,scrollToStartBtn:e.scrollToStart,scrollToEndBtn:e.scrollToEnd};Object.entries(t).forEach(([i,r])=>{const s=this.elements[i];s&&r&&s.addEventListener("click",r)})}validateElements(){return["movieTimelineCount","currentPositionInfo"].filter(t=>!this.elements[t])}}class $S{constructor(e,t){this.movieData=e,this.timeline=t,this.ui=new US}_getLeafNamesByIndices(e){var r;const t=(r=this.movieData)==null?void 0:r.sorted_leaves;if(!t||!Array.isArray(t))return[];const i=[];for(const s of e)Number.isInteger(s)&&s>=0&&s<t.length&&i.push(t[s]);return i}setupControls(){this.ui.setupButtonHandlers({zoomIn:()=>{var e;return(e=this.timeline)==null?void 0:e.zoomIn(K.ZOOM_PERCENTAGE_UI)},zoomOut:()=>{var e;return(e=this.timeline)==null?void 0:e.zoomOut(K.ZOOM_PERCENTAGE_UI)},fitToWindow:()=>{var e;return(e=this.timeline)==null?void 0:e.fit()},scrollToStart:()=>{var e;return(e=this.timeline)==null?void 0:e.moveTo(K.DEFAULT_PROGRESS)},scrollToEnd:()=>{var i,r;const e=(i=this.timeline)==null?void 0:i.getTotalDuration(),t=(r=this.timeline)==null?void 0:r.getVisibleTimeRange();if(e!==void 0&&t){const s=t.max-t.min;this.timeline.moveTo(e-s)}}})}updateDisplay(e,t){const i=M.getState(),{totalSequenceLength:r}=_o(i);this.ui.updatePositionDisplay({progress:i.timelineProgress,currentTree:i.currentTreeIndex+K.INDEX_OFFSET_UI,totalTrees:r,treeInSegment:i.treeInSegment,treesInSegment:i.treesInSegment}),this.ui.updateSegmentInfo(e,t,i),e!=null&&e.isFullTree&&this._updateMSAWindowChip()}_updateMSAWindowChip(){const{transitionResolver:e,msaWindowSize:t,msaStepSize:i,msaColumnCount:r,syncMSAEnabled:s}=M.getState();if(!s||!e||r<=0)return;const o=Ii();if(o<0)return;const{startPosition:a,midPosition:l,endPosition:c}=ys(o,i,t,r),u=document.getElementById("windowStart"),d=document.getElementById("windowMid"),h=document.getElementById("windowEnd");u&&d&&h&&(u.textContent=String(a),d.textContent=String(l),h.textContent=String(c),u.setAttribute("aria-label",`Window start: position ${a}`),d.setAttribute("aria-label",`Window center: position ${l}`),h.setAttribute("aria-label",`Window end: position ${c}`));const f=document.getElementById("hudWindowStart"),p=document.getElementById("hudWindowMid"),g=document.getElementById("hudWindowEnd");f&&p&&g&&(f.textContent=String(a),p.textContent=String(l),g.textContent=String(c),f.setAttribute("aria-label",`Window start: position ${a}`),p.setAttribute("aria-label",`Window center: position ${l}`),g.setAttribute("aria-label",`Window end: position ${c}`))}updateMetrics(e,t){this.ui.updateMetrics(e,t)}destroy(){var e;(e=this.ui)==null||e.clear(),this.ui=null}}class zS{constructor(e,t,i=null){this.treeController=e,this.transitionResolver=t,this.timelineManager=i,this.currentProgress=0,this.lastInterpolationState=null}async updatePosition(e){const t=$e.clampProgress(e);await this._performScrubUpdate(t)}async endScrubbing(e=null){e!==null&&Math.abs($e.clampProgress(e)-this.currentProgress)>1e-6&&await this._performScrubUpdate($e.clampProgress(e)),this.lastInterpolationState=null}async startScrubbing(e){this.currentProgress=$e.clampProgress(e??0),this.lastInterpolationState=null}async _performScrubUpdate(e){this.currentProgress=e;try{const t=await this._getInterpolationData(e);if(!t)return;const i=M.getState().navigationDirection;M.getState().setNavigationDirection(i),await this._renderScrubFrame(t,i),this.lastInterpolationState={progress:e,interpolationData:t,direction:i,timestamp:this.lastUpdateTime}}catch{}}async _renderScrubFrame(e,t){const{fromTree:i,toTree:r,timeFactor:s,fromIndex:o,toIndex:a}=e,l=M.getState(),{updateColorManagerMarkedSubtrees:c,updateColorManagerActiveChangeEdge:u,getActualHighlightData:d,getCurrentActiveChangeEdge:h,markedComponentsEnabled:f,activeChangeEdgesEnabled:p}=l,g=s<.5?o:a,_=l.currentTreeIndex;if(l.currentTreeIndex=g,f){const x=d();c(x)}else c([]);if(p){const x=h();u(x)}else u([]);const w={...{scrubMode:!0,direction:t},fromTreeIndex:o,toTreeIndex:a};try{await this.treeController.renderScrubFrame(i,r,s,w)}finally{l.currentTreeIndex=_}}async _getInterpolationData(e){var a,l,c,u,d,h,f;const t=M.getState(),{treeList:i,movieData:r}=t,s=(a=this.timelineManager)==null?void 0:a.segments,o=(c=(l=this.timelineManager)==null?void 0:l.timelineData)==null?void 0:c.totalDuration;if(s&&Number.isFinite(o)&&o>0){const p=$e.progressToTime(e,o),g=((d=(u=this.timelineManager)==null?void 0:u.timelineData)==null?void 0:d.segmentDurations)||$e.calculateSegmentDurations(s);let _=0,b=s.length-1;for(let $=0;$<s.length;$++){const z=g[$],te=_+z;if($===s.length-1&&p>=te){b=$;break}if(p<te){b=$;break}if(p===te&&z===0){b=$;break}_=te}const w=s[b],x=_,y=g[b]||1;if(w!=null&&w.isFullTree||!(w!=null&&w.hasInterpolation)||!Array.isArray(w==null?void 0:w.interpolationData)){const $=((f=(h=w==null?void 0:w.interpolationData)==null?void 0:h[0])==null?void 0:f.originalIndex)??0;return{fromTree:r.interpolated_trees[$],toTree:r.interpolated_trees[$],timeFactor:0,fromIndex:$,toIndex:$}}const S=w.interpolationData.length;if(S<=1){const $=w.interpolationData[0].originalIndex;return{fromTree:r.interpolated_trees[$],toTree:r.interpolated_trees[$],timeFactor:0,fromIndex:$,toIndex:$}}const F=Math.max(0,Math.min(1,(p-x)/y))*(S-1),D=Math.floor(F),B=Math.min(D+1,S-1),U=F-D,O=w.interpolationData[D].originalIndex,H=w.interpolationData[B].originalIndex;return{fromTree:r.interpolated_trees[O],toTree:r.interpolated_trees[H],timeFactor:U,fromIndex:O,toIndex:H}}return $e.getInterpolationDataForProgress(e,i,r)}_detectNavigationDirection(e){if(!this.lastInterpolationState)return"forward";const t=this.lastInterpolationState.progress;return e>t?"forward":e<t?"backward":"none"}destroy(){this.isActive&&this.endScrubbing(),this.lastInterpolationState=null,this.treeController=null,this.transitionResolver=null}}class Qa{static getStyles(){return`
      .timeline-tooltip .tt-header {
        display: flex;
        align-items: center;
        gap: 8px;
        color: var(--md-sys-color-on-surface);
        font-weight: var(--md-sys-typescale-title-small-weight, 600);
        font-size: var(--md-sys-typescale-title-small-size, 1rem);
        margin-bottom: 6px;
      }
      .timeline-tooltip .tt-sub {
        color: var(--md-sys-color-on-surface-variant);
        font-size: var(--md-sys-typescale-label-medium-size, 0.85rem);
        margin-bottom: 4px;
      }
      .timeline-tooltip .tt-row {
        display: flex;
        align-items: baseline;
        gap: 6px;
      }
      .timeline-tooltip .tt-label {
        color: var(--md-sys-color-on-surface-variant);
        font-size: 0.85rem;
        min-width: 90px;
      }
      .timeline-tooltip .tt-value {
        color: var(--md-sys-color-on-surface);
        font-weight: 500;
      }
      .timeline-tooltip .tt-divider {
        height: 1px;
        background: var(--md-sys-color-outline-variant);
        margin: 8px 0;
      }
      .timeline-tooltip .tt-hint {
        color: var(--md-sys-color-on-surface-variant);
        font-size: 0.8rem;
        opacity: 0.8;
      }
      .timeline-tooltip .material-icons {
        font-size: 18px;
        color: var(--md-sys-color-primary);
      }
    `}static injectStyles(){if(document.getElementById(this.STYLE_ID))return;const e=document.createElement("style");e.id=this.STYLE_ID,e.textContent=this.getStyles(),document.head.appendChild(e)}static getElementStyles(){return`
      position: fixed;
      pointer-events: none;
      display: none;
      z-index: 10000;
      min-width: 260px;
      max-width: 420px;
      max-height: 60vh;
      overflow-y: auto;
      padding: 10px 12px;
      border-radius: var(--md-sys-shape-corner-medium, 12px);
      background: var(--md-sys-color-surface-container, #fff);
      box-shadow: var(--md-sys-elevation-level2, 0 2px 6px rgba(0,0,0,0.15));
      color: var(--md-sys-color-on-surface);
      font-family: var(--md-sys-typescale-body-medium-font, Roboto, sans-serif);
      font-size: var(--md-sys-typescale-body-large-size, 1rem);
      line-height: var(--md-sys-typescale-body-large-line-height, 1.5);
    `}static removeStyles(){const e=document.getElementById(this.STYLE_ID);e&&e.remove()}}m(Qa,"STYLE_ID","timeline-tooltip-styles");class VS{constructor(){this.el=null,this.visible=!1}_ensureCreated(){if(this.el)return;Qa.injectStyles();const e=document.createElement("div");e.className="timeline-tooltip md-elevation-2",e.style.cssText=Qa.getElementStyles(),document.body.appendChild(e),this.el=e}show(e,t,i){this._ensureCreated(),this.el.innerHTML=e,this.el.style.display="block",this.visible=!0,this.updatePosition(t,i)}hide(){this.el&&(this.el.style.display="none",this.visible=!1,this.el.parentNode&&this.el.parentNode.removeChild(this.el),this.el=null)}updatePosition(e,t){if(!this.visible||!this.el)return;const i=12;let r=e+12,s=t+12;const o=this.el.getBoundingClientRect(),a=window.innerWidth,l=window.innerHeight;r+o.width+i>a&&(r=a-o.width-i),s+o.height+i>l&&(s=l-o.height-i),r<i&&(r=i),s<i&&(s=i),this.el.style.left=`${r}px`,this.el.style.top=`${s}px`}}function WS(n,e,t,i,r){var d;const s=!!n.isFullTree,o=!s&&typeof(n==null?void 0:n.subtreeMoveCount)=="number"?n.subtreeMoveCount:0,a=n.hasInterpolation&&Array.isArray(n.interpolationData)?n.interpolationData.length:1;let l="",c=null;if(!s&&Array.isArray(n.interpolationData))for(const h of n.interpolationData){const f=h==null?void 0:h.originalIndex;if(typeof f=="number"&&((d=i.activeChangeEdgeTracking)!=null&&d[f])){c=i.activeChangeEdgeTracking[f];break}}const u=s?"Anchor (nonâ€‘scrubbable) â€” Click to jump â€¢ â†/â†’ to step":"Drag to scrub â€¢ Click segment to jump";return`
    <div class="tt-header">
      <span class="material-icons">${s?"anchor":"timeline"}</span>
      <span>${s?"Anchor Point â€” Stable Tree":"Transition Segment"}</span>
    </div>
    <div class="tt-divider"></div>
    <div class="tt-row"><span class="tt-label">Segment:</span><span class="tt-value">${e+1} / ${t}</span></div>
    ${s?"":`<div class="tt-row"><span class="tt-label">Active splits:</span><span class="tt-value">${c?`[${c.join(", ")}]`:"â€”"}</span></div>`}
    ${s?"":`<div class="tt-row"><span class="tt-label">Steps:</span><span class="tt-value">${a} step${a!==1?"s":""}</span></div>`}
    ${s?"":`<div class="tt-row"><span class="tt-label">Subtree changes:</span><span class="tt-value">${o}</span></div>`}
    ${l}
    <div class="tt-divider"></div>
    <div class="tt-hint">${u}</div>
  `}function bs(n,e){if(!n)throw new Error(e||"loader assertion failed.")}const Ic=!!(typeof process!="object"||String(process)!=="[object process]"||process.browser),yd=typeof process<"u"&&process.version&&/v([0-9]*)/.exec(process.version);yd&&parseFloat(yd[1]);const Sr=globalThis,Cn=globalThis.process||{},HS=globalThis.navigator||{};function _g(n){var i,r;if(typeof window<"u"&&((i=window.process)==null?void 0:i.type)==="renderer"||typeof process<"u"&&((r=process.versions)!=null&&r.electron))return!0;const e=typeof navigator<"u"&&navigator.userAgent,t=n||e;return!!(t&&t.indexOf("Electron")>=0)}function wn(){return!(typeof process=="object"&&String(process)==="[object process]"&&!(process!=null&&process.browser))||_g()}function jS(n){return!n&&!wn()?"Node":_g(n)?"Electron":(n||HS.userAgent||"").indexOf("Edge")>-1?"Edge":globalThis.chrome?"Chrome":globalThis.safari?"Safari":globalThis.mozInnerScreenX?"Firefox":"Unknown"}const yg="4.1.0";function XS(n){try{const e=window[n],t="__storage_test__";return e.setItem(t,t),e.removeItem(t),e}catch{return null}}class YS{constructor(e,t,i="sessionStorage"){this.storage=XS(i),this.id=e,this.config=t,this._loadConfiguration()}getConfiguration(){return this.config}setConfiguration(e){if(Object.assign(this.config,e),this.storage){const t=JSON.stringify(this.config);this.storage.setItem(this.id,t)}}_loadConfiguration(){let e={};if(this.storage){const t=this.storage.getItem(this.id);e=t?JSON.parse(t):{}}return Object.assign(this.config,e),this}}function qS(n){let e;return n<10?e=`${n.toFixed(2)}ms`:n<100?e=`${n.toFixed(1)}ms`:n<1e3?e=`${n.toFixed(0)}ms`:e=`${(n/1e3).toFixed(2)}s`,e}function KS(n,e=8){const t=Math.max(e-n.length,0);return`${" ".repeat(t)}${n}`}var vs;(function(n){n[n.BLACK=30]="BLACK",n[n.RED=31]="RED",n[n.GREEN=32]="GREEN",n[n.YELLOW=33]="YELLOW",n[n.BLUE=34]="BLUE",n[n.MAGENTA=35]="MAGENTA",n[n.CYAN=36]="CYAN",n[n.WHITE=37]="WHITE",n[n.BRIGHT_BLACK=90]="BRIGHT_BLACK",n[n.BRIGHT_RED=91]="BRIGHT_RED",n[n.BRIGHT_GREEN=92]="BRIGHT_GREEN",n[n.BRIGHT_YELLOW=93]="BRIGHT_YELLOW",n[n.BRIGHT_BLUE=94]="BRIGHT_BLUE",n[n.BRIGHT_MAGENTA=95]="BRIGHT_MAGENTA",n[n.BRIGHT_CYAN=96]="BRIGHT_CYAN",n[n.BRIGHT_WHITE=97]="BRIGHT_WHITE"})(vs||(vs={}));const ZS=10;function bd(n){return typeof n!="string"?n:(n=n.toUpperCase(),vs[n]||vs.WHITE)}function GS(n,e,t){return!wn&&typeof n=="string"&&(e&&(n=`\x1B[${bd(e)}m${n}\x1B[39m`),t&&(n=`\x1B[${bd(t)+ZS}m${n}\x1B[49m`)),n}function QS(n,e=["constructor"]){const t=Object.getPrototypeOf(n),i=Object.getOwnPropertyNames(t),r=n;for(const s of i){const o=r[s];typeof o=="function"&&(e.find(a=>s===a)||(r[s]=o.bind(n)))}}function Rc(n,e){if(!n)throw new Error(e||"Assertion failed")}function In(){var e,t,i;let n;if(wn()&&Sr.performance)n=(t=(e=Sr==null?void 0:Sr.performance)==null?void 0:e.now)==null?void 0:t.call(e);else if("hrtime"in Cn){const r=(i=Cn==null?void 0:Cn.hrtime)==null?void 0:i.call(Cn);n=r[0]*1e3+r[1]/1e6}else n=Date.now();return n}const Rn={debug:wn()&&console.debug||console.log,log:console.log,info:console.info,warn:console.warn,error:console.error},JS={enabled:!0,level:0};function Pn(){}const vd={},xd={once:!0};class rr{constructor({id:e}={id:""}){this.VERSION=yg,this._startTs=In(),this._deltaTs=In(),this.userData={},this.LOG_THROTTLE_TIMEOUT=0,this.id=e,this.userData={},this._storage=new YS(`__probe-${this.id}__`,JS),this.timeStamp(`${this.id} started`),QS(this),Object.seal(this)}set level(e){this.setLevel(e)}get level(){return this.getLevel()}isEnabled(){return this._storage.config.enabled}getLevel(){return this._storage.config.level}getTotal(){return Number((In()-this._startTs).toPrecision(10))}getDelta(){return Number((In()-this._deltaTs).toPrecision(10))}set priority(e){this.level=e}get priority(){return this.level}getPriority(){return this.level}enable(e=!0){return this._storage.setConfiguration({enabled:e}),this}setLevel(e){return this._storage.setConfiguration({level:e}),this}get(e){return this._storage.config[e]}set(e,t){this._storage.setConfiguration({[e]:t})}settings(){console.table?console.table(this._storage.config):console.log(this._storage.config)}assert(e,t){if(!e)throw new Error(t||"Assertion failed")}warn(e){return this._getLogFunction(0,e,Rn.warn,arguments,xd)}error(e){return this._getLogFunction(0,e,Rn.error,arguments)}deprecated(e,t){return this.warn(`\`${e}\` is deprecated and will be removed in a later version. Use \`${t}\` instead`)}removed(e,t){return this.error(`\`${e}\` has been removed. Use \`${t}\` instead`)}probe(e,t){return this._getLogFunction(e,t,Rn.log,arguments,{time:!0,once:!0})}log(e,t){return this._getLogFunction(e,t,Rn.debug,arguments)}info(e,t){return this._getLogFunction(e,t,console.info,arguments)}once(e,t){return this._getLogFunction(e,t,Rn.debug||Rn.info,arguments,xd)}table(e,t,i){return t?this._getLogFunction(e,t,console.table||Pn,i&&[i],{tag:t1(t)}):Pn}time(e,t){return this._getLogFunction(e,t,console.time?console.time:console.info)}timeEnd(e,t){return this._getLogFunction(e,t,console.timeEnd?console.timeEnd:console.info)}timeStamp(e,t){return this._getLogFunction(e,t,console.timeStamp||Pn)}group(e,t,i={collapsed:!1}){const r=wd({logLevel:e,message:t,opts:i}),{collapsed:s}=i;return r.method=(s?console.groupCollapsed:console.group)||console.info,this._getLogFunction(r)}groupCollapsed(e,t,i={}){return this.group(e,t,Object.assign({},i,{collapsed:!0}))}groupEnd(e){return this._getLogFunction(e,"",console.groupEnd||Pn)}withGroup(e,t,i){this.group(e,t)();try{i()}finally{this.groupEnd(e)()}}trace(){console.trace&&console.trace()}_shouldLog(e){return this.isEnabled()&&this.getLevel()>=bg(e)}_getLogFunction(e,t,i,r,s){if(this._shouldLog(e)){s=wd({logLevel:e,message:t,args:r,opts:s}),i=i||s.method,Rc(i),s.total=this.getTotal(),s.delta=this.getDelta(),this._deltaTs=In();const o=s.tag||s.message;if(s.once&&o)if(!vd[o])vd[o]=In();else return Pn;return t=e1(this.id,s.message,s),i.bind(console,t,...s.args)}return Pn}}rr.VERSION=yg;function bg(n){if(!n)return 0;let e;switch(typeof n){case"number":e=n;break;case"object":e=n.logLevel||n.priority||0;break;default:return 0}return Rc(Number.isFinite(e)&&e>=0),e}function wd(n){const{logLevel:e,message:t}=n;n.logLevel=bg(e);const i=n.args?Array.from(n.args):[];for(;i.length&&i.shift()!==t;);switch(typeof e){case"string":case"function":t!==void 0&&i.unshift(t),n.message=e;break;case"object":Object.assign(n,e);break}typeof n.message=="function"&&(n.message=n.message());const r=typeof n.message;return Rc(r==="string"||r==="object"),Object.assign(n,{args:i},n.opts)}function e1(n,e,t){if(typeof e=="string"){const i=t.time?KS(qS(t.total)):"";e=t.time?`${n}: ${i}  ${e}`:`${n}: ${e}`,e=GS(e,t.color,t.background)}return e}function t1(n){for(const e in n)for(const t in n[e])return t||"untitled";return"empty"}const $o="4.3.3",n1=$o[0]>="0"&&$o[0]<="9"?`v${$o}`:"";function i1(){const n=new rr({id:"loaders.gl"});return globalThis.loaders=globalThis.loaders||{},globalThis.loaders.log=n,globalThis.loaders.version=n1,globalThis.probe=globalThis.probe||{},globalThis.probe.loaders=n,n}const r1=i1();function s1(n,e){return vg(n||{},e)}function vg(n,e,t=0){if(t>3)return e;const i={...n};for(const[r,s]of Object.entries(e))s&&typeof s=="object"&&!Array.isArray(s)?i[r]=vg(i[r]||{},e[r],t+1):i[r]=e[r];return i}const o1="latest";function a1(){var n;return(n=globalThis._loadersgl_)!=null&&n.version||(globalThis._loadersgl_=globalThis._loadersgl_||{},globalThis._loadersgl_.version="4.3.3"),globalThis._loadersgl_.version}const l1=a1();function Gt(n,e){if(!n)throw new Error(e||"loaders.gl assertion failed.")}const hn=typeof process!="object"||String(process)!=="[object process]"||process.browser,c1=typeof window<"u"&&typeof window.orientation<"u",Td=typeof process<"u"&&process.version&&/v([0-9]*)/.exec(process.version);Td&&parseFloat(Td[1]);class u1{constructor(e,t){m(this,"name");m(this,"workerThread");m(this,"isRunning",!0);m(this,"result");m(this,"_resolve",()=>{});m(this,"_reject",()=>{});this.name=e,this.workerThread=t,this.result=new Promise((i,r)=>{this._resolve=i,this._reject=r})}postMessage(e,t){this.workerThread.postMessage({source:"loaders.gl",type:e,payload:t})}done(e){Gt(this.isRunning),this.isRunning=!1,this._resolve(e)}error(e){Gt(this.isRunning),this.isRunning=!1,this._reject(e)}}class zo{terminate(){}}const Vo=new Map;function d1(n){Gt(n.source&&!n.url||!n.source&&n.url);let e=Vo.get(n.source||n.url);return e||(n.url&&(e=h1(n.url),Vo.set(n.url,e)),n.source&&(e=xg(n.source),Vo.set(n.source,e))),Gt(e),e}function h1(n){if(!n.startsWith("http"))return n;const e=f1(n);return xg(e)}function xg(n){const e=new Blob([n],{type:"application/javascript"});return URL.createObjectURL(e)}function f1(n){return`try {
  importScripts('${n}');
} catch (error) {
  console.error(error);
  throw error;
}`}function wg(n,e=!0,t){const i=t||new Set;if(n){if(Sd(n))i.add(n);else if(Sd(n.buffer))i.add(n.buffer);else if(!ArrayBuffer.isView(n)){if(e&&typeof n=="object")for(const r in n)wg(n[r],e,i)}}return t===void 0?Array.from(i):[]}function Sd(n){return n?n instanceof ArrayBuffer||typeof MessagePort<"u"&&n instanceof MessagePort||typeof ImageBitmap<"u"&&n instanceof ImageBitmap||typeof OffscreenCanvas<"u"&&n instanceof OffscreenCanvas:!1}const Wo=()=>{};class Ja{constructor(e){m(this,"name");m(this,"source");m(this,"url");m(this,"terminated",!1);m(this,"worker");m(this,"onMessage");m(this,"onError");m(this,"_loadableURL","");const{name:t,source:i,url:r}=e;Gt(i||r),this.name=t,this.source=i,this.url=r,this.onMessage=Wo,this.onError=s=>console.log(s),this.worker=hn?this._createBrowserWorker():this._createNodeWorker()}static isSupported(){return typeof Worker<"u"&&hn||typeof zo<"u"&&!hn}destroy(){this.onMessage=Wo,this.onError=Wo,this.worker.terminate(),this.terminated=!0}get isRunning(){return!!this.onMessage}postMessage(e,t){t=t||wg(e),this.worker.postMessage(e,t)}_getErrorFromErrorEvent(e){let t="Failed to load ";return t+=`worker ${this.name} from ${this.url}. `,e.message&&(t+=`${e.message} in `),e.lineno&&(t+=`:${e.lineno}:${e.colno}`),new Error(t)}_createBrowserWorker(){this._loadableURL=d1({source:this.source,url:this.url});const e=new Worker(this._loadableURL,{name:this.name});return e.onmessage=t=>{t.data?this.onMessage(t.data):this.onError(new Error("No data received"))},e.onerror=t=>{this.onError(this._getErrorFromErrorEvent(t)),this.terminated=!0},e.onmessageerror=t=>console.error(t),e}_createNodeWorker(){let e;if(this.url){const i=this.url.includes(":/")||this.url.startsWith("/")?this.url:`./${this.url}`;e=new zo(i,{eval:!1})}else if(this.source)e=new zo(this.source,{eval:!0});else throw new Error("no worker");return e.on("message",t=>{this.onMessage(t)}),e.on("error",t=>{this.onError(t)}),e.on("exit",t=>{}),e}}class p1{constructor(e){m(this,"name","unnamed");m(this,"source");m(this,"url");m(this,"maxConcurrency",1);m(this,"maxMobileConcurrency",1);m(this,"onDebug",()=>{});m(this,"reuseWorkers",!0);m(this,"props",{});m(this,"jobQueue",[]);m(this,"idleQueue",[]);m(this,"count",0);m(this,"isDestroyed",!1);this.source=e.source,this.url=e.url,this.setProps(e)}static isSupported(){return Ja.isSupported()}destroy(){this.idleQueue.forEach(e=>e.destroy()),this.isDestroyed=!0}setProps(e){this.props={...this.props,...e},e.name!==void 0&&(this.name=e.name),e.maxConcurrency!==void 0&&(this.maxConcurrency=e.maxConcurrency),e.maxMobileConcurrency!==void 0&&(this.maxMobileConcurrency=e.maxMobileConcurrency),e.reuseWorkers!==void 0&&(this.reuseWorkers=e.reuseWorkers),e.onDebug!==void 0&&(this.onDebug=e.onDebug)}async startJob(e,t=(r,s,o)=>r.done(o),i=(r,s)=>r.error(s)){const r=new Promise(s=>(this.jobQueue.push({name:e,onMessage:t,onError:i,onStart:s}),this));return this._startQueuedJob(),await r}async _startQueuedJob(){if(!this.jobQueue.length)return;const e=this._getAvailableWorker();if(!e)return;const t=this.jobQueue.shift();if(t){this.onDebug({message:"Starting job",name:t.name,workerThread:e,backlog:this.jobQueue.length});const i=new u1(t.name,e);e.onMessage=r=>t.onMessage(i,r.type,r.payload),e.onError=r=>t.onError(i,r),t.onStart(i);try{await i.result}catch(r){console.error(`Worker exception: ${r}`)}finally{this.returnWorkerToQueue(e)}}}returnWorkerToQueue(e){!hn||this.isDestroyed||!this.reuseWorkers||this.count>this._getMaxConcurrency()?(e.destroy(),this.count--):this.idleQueue.push(e),this.isDestroyed||this._startQueuedJob()}_getAvailableWorker(){if(this.idleQueue.length>0)return this.idleQueue.shift()||null;if(this.count<this._getMaxConcurrency()){this.count++;const e=`${this.name.toLowerCase()} (#${this.count} of ${this.maxConcurrency})`;return new Ja({name:e,source:this.source,url:this.url})}return null}_getMaxConcurrency(){return c1?this.maxMobileConcurrency:this.maxConcurrency}}const g1={maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:!0,onDebug:()=>{}},Wt=class Wt{constructor(e){m(this,"props");m(this,"workerPools",new Map);this.props={...g1},this.setProps(e),this.workerPools=new Map}static isSupported(){return Ja.isSupported()}static getWorkerFarm(e={}){return Wt._workerFarm=Wt._workerFarm||new Wt({}),Wt._workerFarm.setProps(e),Wt._workerFarm}destroy(){for(const e of this.workerPools.values())e.destroy();this.workerPools=new Map}setProps(e){this.props={...this.props,...e};for(const t of this.workerPools.values())t.setProps(this._getWorkerPoolProps())}getWorkerPool(e){const{name:t,source:i,url:r}=e;let s=this.workerPools.get(t);return s||(s=new p1({name:t,source:i,url:r}),s.setProps(this._getWorkerPoolProps()),this.workerPools.set(t,s)),s}_getWorkerPoolProps(){return{maxConcurrency:this.props.maxConcurrency,maxMobileConcurrency:this.props.maxMobileConcurrency,reuseWorkers:this.props.reuseWorkers,onDebug:this.props.onDebug}}};m(Wt,"_workerFarm");let xs=Wt;function m1(n,e={}){const t=e[n.id]||{},i=hn?`${n.id}-worker.js`:`${n.id}-worker-node.js`;let r=t.workerUrl;if(!r&&n.id==="compression"&&(r=e.workerUrl),e._workerType==="test"&&(hn?r=`modules/${n.module}/dist/${i}`:r=`modules/${n.module}/src/workers/${n.id}-worker-node.ts`),!r){let s=n.version;s==="latest"&&(s=o1);const o=s?`@${s}`:"";r=`https://unpkg.com/@loaders.gl/${n.module}${o}/dist/${i}`}return Gt(r),r}function _1(n,e=l1){Gt(n,"no worker provided");const t=n.version;return!(!e||!t)}function y1(n,e){return!xs.isSupported()||!hn&&!(e!=null&&e._nodeWorkers)?!1:n.worker&&(e==null?void 0:e.worker)}async function b1(n,e,t,i,r){const s=n.id,o=m1(n,t),l=xs.getWorkerFarm(t).getWorkerPool({name:s,url:o});t=JSON.parse(JSON.stringify(t)),i=JSON.parse(JSON.stringify(i||{}));const c=await l.startJob("process-on-worker",v1.bind(null,r));return c.postMessage("process",{input:e,options:t,context:i}),await(await c.result).result}async function v1(n,e,t,i){switch(t){case"done":e.done(i);break;case"error":e.error(new Error(i.error));break;case"process":const{id:r,input:s,options:o}=i;try{const a=await n(s,o);e.postMessage("done",{id:r,result:a})}catch(a){const l=a instanceof Error?a.message:"unknown error";e.postMessage("error",{id:r,error:l})}break;default:console.warn(`parse-with-worker unknown message ${t}`)}}function x1(n,e,t){if(t=t||n.byteLength,n.byteLength<t||e.byteLength<t)return!1;const i=new Uint8Array(n),r=new Uint8Array(e);for(let s=0;s<i.length;++s)if(i[s]!==r[s])return!1;return!0}function w1(...n){return T1(n)}function T1(n){const e=n.map(s=>s instanceof ArrayBuffer?new Uint8Array(s):s),t=e.reduce((s,o)=>s+o.byteLength,0),i=new Uint8Array(t);let r=0;for(const s of e)i.set(s,r),r+=s.byteLength;return i.buffer}async function S1(n){const e=[];for await(const t of n)e.push(t);return w1(...e)}function Ed(){let n;if(typeof window<"u"&&window.performance)n=window.performance.now();else if(typeof process<"u"&&process.hrtime){const e=process.hrtime();n=e[0]*1e3+e[1]/1e6}else n=Date.now();return n}class Ad{constructor(e,t){this.sampleSize=1,this.time=0,this.count=0,this.samples=0,this.lastTiming=0,this.lastSampleTime=0,this.lastSampleCount=0,this._count=0,this._time=0,this._samples=0,this._startTime=0,this._timerPending=!1,this.name=e,this.type=t,this.reset()}reset(){return this.time=0,this.count=0,this.samples=0,this.lastTiming=0,this.lastSampleTime=0,this.lastSampleCount=0,this._count=0,this._time=0,this._samples=0,this._startTime=0,this._timerPending=!1,this}setSampleSize(e){return this.sampleSize=e,this}incrementCount(){return this.addCount(1),this}decrementCount(){return this.subtractCount(1),this}addCount(e){return this._count+=e,this._samples++,this._checkSampling(),this}subtractCount(e){return this._count-=e,this._samples++,this._checkSampling(),this}addTime(e){return this._time+=e,this.lastTiming=e,this._samples++,this._checkSampling(),this}timeStart(){return this._startTime=Ed(),this._timerPending=!0,this}timeEnd(){return this._timerPending?(this.addTime(Ed()-this._startTime),this._timerPending=!1,this._checkSampling(),this):this}getSampleAverageCount(){return this.sampleSize>0?this.lastSampleCount/this.sampleSize:0}getSampleAverageTime(){return this.sampleSize>0?this.lastSampleTime/this.sampleSize:0}getSampleHz(){return this.lastSampleTime>0?this.sampleSize/(this.lastSampleTime/1e3):0}getAverageCount(){return this.samples>0?this.count/this.samples:0}getAverageTime(){return this.samples>0?this.time/this.samples:0}getHz(){return this.time>0?this.samples/(this.time/1e3):0}_checkSampling(){this._samples===this.sampleSize&&(this.lastSampleTime=this._time,this.lastSampleCount=this._count,this.count+=this._count,this.time+=this._time,this.samples+=this._samples,this._time=0,this._count=0,this._samples=0)}}class yo{constructor(e){this.stats={},this.id=e.id,this.stats={},this._initializeStats(e.stats),Object.seal(this)}get(e,t="count"){return this._getOrCreate({name:e,type:t})}get size(){return Object.keys(this.stats).length}reset(){for(const e of Object.values(this.stats))e.reset();return this}forEach(e){for(const t of Object.values(this.stats))e(t)}getTable(){const e={};return this.forEach(t=>{e[t.name]={time:t.time||0,count:t.count||0,average:t.getAverageTime()||0,hz:t.getHz()||0}}),e}_initializeStats(e=[]){e.forEach(t=>this._getOrCreate(t))}_getOrCreate(e){const{name:t,type:i}=e;let r=this.stats[t];return r||(e instanceof Ad?r=e:r=new Ad(t,i),this.stats[t]=r),r}}let E1="";const Cd={};function A1(n){for(const e in Cd)if(n.startsWith(e)){const t=Cd[e];n=n.replace(e,t)}return!n.startsWith("http://")&&!n.startsWith("https://")&&(n=`${E1}${n}`),n}function C1(n){return n&&typeof n=="object"&&n.isBuffer}function Tg(n){if(C1(n))return n;if(n instanceof ArrayBuffer)return n;if(ArrayBuffer.isView(n))return n.byteOffset===0&&n.byteLength===n.buffer.byteLength?n.buffer:n.buffer.slice(n.byteOffset,n.byteOffset+n.byteLength);if(typeof n=="string"){const e=n;return new TextEncoder().encode(e).buffer}if(n&&typeof n=="object"&&n._toArrayBuffer)return n._toArrayBuffer();throw new Error("toArrayBuffer")}function Sg(n){const e=n?n.lastIndexOf("/"):-1;return e>=0?n.substr(e+1):""}function I1(n){const e=n?n.lastIndexOf("/"):-1;return e>=0?n.substr(0,e):""}const R1=n=>typeof n=="boolean",Ri=n=>typeof n=="function",sr=n=>n!==null&&typeof n=="object",Id=n=>sr(n)&&n.constructor==={}.constructor,P1=n=>!!n&&typeof n[Symbol.iterator]=="function",M1=n=>n&&typeof n[Symbol.asyncIterator]=="function",Tn=n=>typeof Response<"u"&&n instanceof Response||n&&n.arrayBuffer&&n.text&&n.json,Sn=n=>typeof Blob<"u"&&n instanceof Blob,k1=n=>n&&typeof n=="object"&&n.isBuffer,O1=n=>typeof ReadableStream<"u"&&n instanceof ReadableStream||sr(n)&&Ri(n.tee)&&Ri(n.cancel)&&Ri(n.getReader),N1=n=>sr(n)&&Ri(n.read)&&Ri(n.pipe)&&R1(n.readable),Eg=n=>O1(n)||N1(n);class F1 extends Error{constructor(t,i){super(t);m(this,"reason");m(this,"url");m(this,"response");this.reason=i.reason,this.url=i.url,this.response=i.response}}const D1=/^data:([-\w.]+\/[-\w.+]+)(;|,)/,B1=/^([-\w.]+\/[-\w.+]+)/;function Rd(n,e){return n.toLowerCase()===e.toLowerCase()}function L1(n){const e=B1.exec(n);return e?e[1]:n}function Pd(n){const e=D1.exec(n);return e?e[1]:""}const Ag=/\?.*/;function U1(n){const e=n.match(Ag);return e&&e[0]}function Pc(n){return n.replace(Ag,"")}function $1(n){if(n.length<50)return n;const e=n.slice(n.length-15);return`${n.substr(0,32)}...${e}`}function bo(n){return Tn(n)?n.url:Sn(n)?n.name||"":typeof n=="string"?n:""}function Mc(n){if(Tn(n)){const e=n,t=e.headers.get("content-type")||"",i=Pc(e.url);return L1(t)||Pd(i)}return Sn(n)?n.type||"":typeof n=="string"?Pd(n):""}function z1(n){return Tn(n)?n.headers["content-length"]||-1:Sn(n)?n.size:typeof n=="string"?n.length:n instanceof ArrayBuffer||ArrayBuffer.isView(n)?n.byteLength:-1}async function Cg(n){if(Tn(n))return n;const e={},t=z1(n);t>=0&&(e["content-length"]=String(t));const i=bo(n),r=Mc(n);r&&(e["content-type"]=r);const s=await H1(n);s&&(e["x-first-bytes"]=s),typeof n=="string"&&(n=new TextEncoder().encode(n));const o=new Response(n,{headers:e});return Object.defineProperty(o,"url",{value:i}),o}async function V1(n){if(!n.ok)throw await W1(n)}async function W1(n){const e=$1(n.url);let t=`Failed to fetch resource (${n.status}) ${n.statusText}: ${e}`;t=t.length>100?`${t.slice(0,100)}...`:t;const i={reason:n.statusText,url:n.url,response:n};try{const r=n.headers.get("Content-Type");i.reason=!n.bodyUsed&&(r!=null&&r.includes("application/json"))?await n.json():await n.text()}catch{}return new F1(t,i)}async function H1(n){if(typeof n=="string")return`data:,${n.slice(0,5)}`;if(n instanceof Blob){const t=n.slice(0,5);return await new Promise(i=>{const r=new FileReader;r.onload=s=>{var o;return i((o=s==null?void 0:s.target)==null?void 0:o.result)},r.readAsDataURL(t)})}if(n instanceof ArrayBuffer){const t=n.slice(0,5);return`data:base64,${j1(t)}`}return null}function j1(n){let e="";const t=new Uint8Array(n);for(let i=0;i<t.byteLength;i++)e+=String.fromCharCode(t[i]);return btoa(e)}function X1(n){return!Y1(n)&&!q1(n)}function Y1(n){return n.startsWith("http:")||n.startsWith("https:")}function q1(n){return n.startsWith("data:")}async function Md(n,e){var t,i;if(typeof n=="string"){const r=A1(n);return X1(r)&&(t=globalThis.loaders)!=null&&t.fetchNode?(i=globalThis.loaders)==null?void 0:i.fetchNode(r,e):await fetch(r,e)}return await Cg(n)}const kd=new rr({id:"loaders.gl"});class K1{log(){return()=>{}}info(){return()=>{}}warn(){return()=>{}}error(){return()=>{}}}class Z1{constructor(){m(this,"console");this.console=console}log(...e){return this.console.log.bind(this.console,...e)}info(...e){return this.console.info.bind(this.console,...e)}warn(...e){return this.console.warn.bind(this.console,...e)}error(...e){return this.console.error.bind(this.console,...e)}}const Ig={fetch:null,mimeType:void 0,nothrow:!1,log:new Z1,useLocalLibraries:!1,CDN:"https://unpkg.com/@loaders.gl",worker:!0,maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:Ic,_nodeWorkers:!1,_workerType:"",limit:0,_limitMB:0,batchSize:"auto",batchDebounceMs:0,metadata:!1,transforms:[]},G1={throws:"nothrow",dataType:"(no longer used)",uri:"baseUri",method:"fetch.method",headers:"fetch.headers",body:"fetch.body",mode:"fetch.mode",credentials:"fetch.credentials",cache:"fetch.cache",redirect:"fetch.redirect",referrer:"fetch.referrer",referrerPolicy:"fetch.referrerPolicy",integrity:"fetch.integrity",keepalive:"fetch.keepalive",signal:"fetch.signal"};function Rg(){globalThis.loaders=globalThis.loaders||{};const{loaders:n}=globalThis;return n._state||(n._state={}),n._state}function Pg(){const n=Rg();return n.globalOptions=n.globalOptions||{...Ig},n.globalOptions}function Q1(n,e,t,i){return t=t||[],t=Array.isArray(t)?t:[t],J1(n,t),tE(e,n,i)}function J1(n,e){Od(n,null,Ig,G1,e);for(const t of e){const i=n&&n[t.id]||{},r=t.options&&t.options[t.id]||{},s=t.deprecatedOptions&&t.deprecatedOptions[t.id]||{};Od(i,t.id,r,s,e)}}function Od(n,e,t,i,r){const s=e||"Top level",o=e?`${e}.`:"";for(const a in n){const l=!e&&sr(n[a]),c=a==="baseUri"&&!e,u=a==="workerUrl"&&e;if(!(a in t)&&!c&&!u){if(a in i)kd.warn(`${s} loader option '${o}${a}' no longer supported, use '${i[a]}'`)();else if(!l){const d=eE(a,r);kd.warn(`${s} loader option '${o}${a}' not recognized. ${d}`)()}}}}function eE(n,e){const t=n.toLowerCase();let i="";for(const r of e)for(const s in r.options){if(n===s)return`Did you mean '${r.id}.${s}'?`;const o=s.toLowerCase();(t.startsWith(o)||o.startsWith(t))&&(i=i||`Did you mean '${r.id}.${s}'?`)}return i}function tE(n,e,t){const r={...n.options||{}};return nE(r,t),r.log===null&&(r.log=new K1),Nd(r,Pg()),Nd(r,e),r}function Nd(n,e){for(const t in e)if(t in e){const i=e[t];Id(i)&&Id(n[t])?n[t]={...n[t],...e[t]}:n[t]=e[t]}}function nE(n,e){e&&!("baseUri"in n)&&(n.baseUri=e)}function kc(n){return n?(Array.isArray(n)&&(n=n[0]),Array.isArray(n==null?void 0:n.extensions)):!1}function Oc(n){bs(n,"null loader"),bs(kc(n),"invalid loader");let e;return Array.isArray(n)&&(e=n[1],n=n[0],n={...n,options:{...n.options,...e}}),(n!=null&&n.parseTextSync||n!=null&&n.parseText)&&(n.text=!0),n.text||(n.binary=!0),n}const Mg=()=>{const n=Rg();return n.loaderRegistry=n.loaderRegistry||[],n.loaderRegistry};function iE(n){const e=Mg();n=Array.isArray(n)?n:[n];for(const t of n){const i=Oc(t);e.find(r=>i===r)||e.unshift(i)}}function rE(){return Mg()}const sE=/\.([^.]+)$/;async function oE(n,e=[],t,i){if(!kg(n))return null;let r=Fd(n,e,{...t,nothrow:!0},i);if(r)return r;if(Sn(n)&&(n=await n.slice(0,10).arrayBuffer(),r=Fd(n,e,t,i)),!r&&!(t!=null&&t.nothrow))throw new Error(Og(n));return r}function Fd(n,e=[],t,i){if(!kg(n))return null;if(e&&!Array.isArray(e))return Oc(e);let r=[];e&&(r=r.concat(e)),t!=null&&t.ignoreRegisteredLoaders||r.push(...rE()),lE(r);const s=aE(n,r,t,i);if(!s&&!(t!=null&&t.nothrow))throw new Error(Og(n));return s}function aE(n,e,t,i){const r=bo(n),s=Mc(n),o=Pc(r)||(i==null?void 0:i.url);let a=null,l="";return t!=null&&t.mimeType&&(a=Ho(e,t==null?void 0:t.mimeType),l=`match forced by supplied MIME type ${t==null?void 0:t.mimeType}`),a=a||cE(e,o),l=l||(a?`matched url ${o}`:""),a=a||Ho(e,s),l=l||(a?`matched MIME type ${s}`:""),a=a||dE(e,n),l=l||(a?`matched initial data ${Ng(n)}`:""),t!=null&&t.fallbackMimeType&&(a=a||Ho(e,t==null?void 0:t.fallbackMimeType),l=l||(a?`matched fallback MIME type ${s}`:"")),l&&r1.log(1,`selectLoader selected ${a==null?void 0:a.name}: ${l}.`),a}function kg(n){return!(n instanceof Response&&n.status===204)}function Og(n){const e=bo(n),t=Mc(n);let i="No valid loader found (";i+=e?`${Sg(e)}, `:"no url provided, ",i+=`MIME type: ${t?`"${t}"`:"not provided"}, `;const r=n?Ng(n):"";return i+=r?` first bytes: "${r}"`:"first bytes: not available",i+=")",i}function lE(n){for(const e of n)Oc(e)}function cE(n,e){const t=e&&sE.exec(e),i=t&&t[1];return i?uE(n,i):null}function uE(n,e){e=e.toLowerCase();for(const t of n)for(const i of t.extensions)if(i.toLowerCase()===e)return t;return null}function Ho(n,e){var t;for(const i of n)if((t=i.mimeTypes)!=null&&t.some(r=>Rd(e,r))||Rd(e,`application/x.${i.id}`))return i;return null}function dE(n,e){if(!e)return null;for(const t of n)if(typeof e=="string"){if(hE(e,t))return t}else if(ArrayBuffer.isView(e)){if(Dd(e.buffer,e.byteOffset,t))return t}else if(e instanceof ArrayBuffer&&Dd(e,0,t))return t;return null}function hE(n,e){return e.testText?e.testText(n):(Array.isArray(e.tests)?e.tests:[e.tests]).some(i=>n.startsWith(i))}function Dd(n,e,t){return(Array.isArray(t.tests)?t.tests:[t.tests]).some(r=>fE(n,e,t,r))}function fE(n,e,t,i){if(i instanceof ArrayBuffer)return x1(i,n,i.byteLength);switch(typeof i){case"function":return i(n);case"string":const r=el(n,e,i.length);return i===r;default:return!1}}function Ng(n,e=5){return typeof n=="string"?n.slice(0,e):ArrayBuffer.isView(n)?el(n.buffer,n.byteOffset,e):n instanceof ArrayBuffer?el(n,0,e):""}function el(n,e,t){if(n.byteLength<e+t)return"";const i=new DataView(n);let r="";for(let s=0;s<t;s++)r+=String.fromCharCode(i.getUint8(e+s));return r}const pE=256*1024;function*gE(n,e){const t=(e==null?void 0:e.chunkSize)||pE;let i=0;const r=new TextEncoder;for(;i<n.length;){const s=Math.min(n.length-i,t),o=n.slice(i,i+s);i+=s,yield r.encode(o)}}const mE=256*1024;function*_E(n,e={}){const{chunkSize:t=mE}=e;let i=0;for(;i<n.byteLength;){const r=Math.min(n.byteLength-i,t),s=new ArrayBuffer(r),o=new Uint8Array(n,i,r);new Uint8Array(s).set(o),i+=r,yield s}}const yE=1024*1024;async function*bE(n,e){const t=(e==null?void 0:e.chunkSize)||yE;let i=0;for(;i<n.size;){const r=i+t,s=await n.slice(i,r).arrayBuffer();i=r,yield s}}function Bd(n,e){return Ic?vE(n,e):xE(n)}async function*vE(n,e){const t=n.getReader();let i;try{for(;;){const r=i||t.read();e!=null&&e._streamReadAhead&&(i=t.read());const{done:s,value:o}=await r;if(s)return;yield Tg(o)}}catch{t.releaseLock()}}async function*xE(n,e){for await(const t of n)yield Tg(t)}function wE(n,e){if(typeof n=="string")return gE(n,e);if(n instanceof ArrayBuffer)return _E(n,e);if(Sn(n))return bE(n,e);if(Eg(n))return Bd(n,e);if(Tn(n))return Bd(n.body,e);throw new Error("makeIterator")}const Fg="Cannot convert supplied data type";function TE(n,e,t){if(e.text&&typeof n=="string")return n;if(k1(n)&&(n=n.buffer),n instanceof ArrayBuffer){const i=n;return e.text&&!e.binary?new TextDecoder("utf8").decode(i):i}if(ArrayBuffer.isView(n)){if(e.text&&!e.binary)return new TextDecoder("utf8").decode(n);let i=n.buffer;const r=n.byteLength||n.length;return(n.byteOffset!==0||r!==i.byteLength)&&(i=i.slice(n.byteOffset,n.byteOffset+r)),i}throw new Error(Fg)}async function SE(n,e,t){const i=n instanceof ArrayBuffer||ArrayBuffer.isView(n);if(typeof n=="string"||i)return TE(n,e);if(Sn(n)&&(n=await Cg(n)),Tn(n)){const r=n;return await V1(r),e.binary?await r.arrayBuffer():await r.text()}if(Eg(n)&&(n=wE(n,t)),P1(n)||M1(n))return S1(n);throw new Error(Fg)}function Dg(n,e){const t=Pg(),i=n||t;return typeof i.fetch=="function"?i.fetch:sr(i.fetch)?r=>Md(r,i.fetch):e!=null&&e.fetch?e==null?void 0:e.fetch:Md}function EE(n,e,t){if(t)return t;const i={fetch:Dg(e,n),...n};if(i.url){const r=Pc(i.url);i.baseUrl=r,i.queryString=U1(i.url),i.filename=Sg(r),i.baseUrl=I1(r)}return Array.isArray(i.loaders)||(i.loaders=null),i}function AE(n,e){if(n&&!Array.isArray(n))return n;let t;if(n&&(t=Array.isArray(n)?n:[n]),e&&e.loaders){const i=Array.isArray(e.loaders)?e.loaders:[e.loaders];t=t?[...t,...i]:i}return t&&t.length?t:void 0}async function ws(n,e,t,i){e&&!Array.isArray(e)&&!kc(e)&&(i=void 0,t=e,e=void 0),n=await n,t=t||{};const r=bo(n),o=AE(e,i),a=await oE(n,o,t);return a?(t=Q1(t,a,o,r),i=EE({url:r,_parse:ws,loaders:o},t,i||null),await CE(a,n,t,i)):null}async function CE(n,e,t,i){if(_1(n),t=s1(n.options,t),Tn(e)){const s=e,{ok:o,redirected:a,status:l,statusText:c,type:u,url:d}=s,h=Object.fromEntries(s.headers.entries());i.response={headers:h,ok:o,redirected:a,status:l,statusText:c,type:u,url:d}}e=await SE(e,n,t);const r=n;if(r.parseTextSync&&typeof e=="string")return r.parseTextSync(e,t,i);if(y1(n,t))return await b1(n,e,t,i,ws);if(r.parseText&&typeof e=="string")return await r.parseText(e,t,i);if(r.parse)return await r.parse(e,t,i);throw Gt(!r.parseSync),new Error(`${n.id} loader - no parser found and worker is disabled`)}async function Ts(n,e,t,i){let r,s;!Array.isArray(e)&&!kc(e)?(r=[],s=e):(r=e,s=t);const o=Dg(s);let a=n;return typeof n=="string"&&(a=await o(n)),Sn(n)&&(a=await o(n)),Array.isArray(r)?await ws(a,r,s):await ws(a,r,s)}const IE="4.3.3";var tp;const RE=(tp=globalThis.loaders)==null?void 0:tp.parseImageNode,tl=typeof Image<"u",nl=typeof ImageBitmap<"u",PE=!!RE,il=Ic?!0:PE;function ME(n){switch(n){case"auto":return nl||tl||il;case"imagebitmap":return nl;case"image":return tl;case"data":return il;default:throw new Error(`@loaders.gl/images: image ${n} not supported in this environment`)}}function kE(){if(nl)return"imagebitmap";if(tl)return"image";if(il)return"data";throw new Error("Install '@loaders.gl/polyfills' to parse images under Node.js")}function OE(n){const e=FE(n);if(!e)throw new Error("Not an image");return e}function NE(n){switch(OE(n)){case"data":return n;case"image":case"imagebitmap":const e=document.createElement("canvas"),t=e.getContext("2d");if(!t)throw new Error("getImageData");return e.width=n.width,e.height=n.height,t.drawImage(n,0,0),t.getImageData(0,0,n.width,n.height);default:throw new Error("getImageData")}}function FE(n){return typeof ImageBitmap<"u"&&n instanceof ImageBitmap?"imagebitmap":typeof Image<"u"&&n instanceof Image?"image":n&&typeof n=="object"&&n.data&&n.width&&n.height?"data":null}const DE=/^data:image\/svg\+xml/,BE=/\.svg((\?|#).*)?$/;function Nc(n){return n&&(DE.test(n)||BE.test(n))}function LE(n,e){if(Nc(e)){let i=new TextDecoder().decode(n);try{typeof unescape=="function"&&typeof encodeURIComponent=="function"&&(i=unescape(encodeURIComponent(i)))}catch(s){throw new Error(s.message)}return`data:image/svg+xml;base64,${btoa(i)}`}return Bg(n,e)}function Bg(n,e){if(Nc(e))throw new Error("SVG cannot be parsed directly to imagebitmap");return new Blob([new Uint8Array(n)])}async function Lg(n,e,t){const i=LE(n,t),r=self.URL||self.webkitURL,s=typeof i!="string"&&r.createObjectURL(i);try{return await UE(s||i,e)}finally{s&&r.revokeObjectURL(s)}}async function UE(n,e){const t=new Image;return t.src=n,e.image&&e.image.decode&&t.decode?(await t.decode(),t):await new Promise((i,r)=>{try{t.onload=()=>i(t),t.onerror=s=>{const o=s instanceof Error?s.message:"error";r(new Error(o))}}catch(s){r(s)}})}const $E={};let Ld=!0;async function zE(n,e,t){let i;Nc(t)?i=await Lg(n,e,t):i=Bg(n,t);const r=e&&e.imagebitmap;return await VE(i,r)}async function VE(n,e=null){if((WE(e)||!Ld)&&(e=null),e)try{return await createImageBitmap(n,e)}catch(t){console.warn(t),Ld=!1}return await createImageBitmap(n)}function WE(n){for(const e in n||$E)return!1;return!0}function HE(n){return!qE(n,"ftyp",4)||!(n[8]&96)?null:jE(n)}function jE(n){switch(XE(n,8,12).replace("\0"," ").trim()){case"avif":case"avis":return{extension:"avif",mimeType:"image/avif"};default:return null}}function XE(n,e,t){return String.fromCharCode(...n.slice(e,t))}function YE(n){return[...n].map(e=>e.charCodeAt(0))}function qE(n,e,t=0){const i=YE(e);for(let r=0;r<i.length;++r)if(i[r]!==n[r+t])return!1;return!0}const bt=!1,Pi=!0;function Ug(n){const e=or(n);return ZE(e)||JE(e)||GE(e)||QE(e)||KE(e)}function KE(n){const e=new Uint8Array(n instanceof DataView?n.buffer:n),t=HE(e);return t?{mimeType:t.mimeType,width:0,height:0}:null}function ZE(n){const e=or(n);return e.byteLength>=24&&e.getUint32(0,bt)===2303741511?{mimeType:"image/png",width:e.getUint32(16,bt),height:e.getUint32(20,bt)}:null}function GE(n){const e=or(n);return e.byteLength>=10&&e.getUint32(0,bt)===1195984440?{mimeType:"image/gif",width:e.getUint16(6,Pi),height:e.getUint16(8,Pi)}:null}function QE(n){const e=or(n);return e.byteLength>=14&&e.getUint16(0,bt)===16973&&e.getUint32(2,Pi)===e.byteLength?{mimeType:"image/bmp",width:e.getUint32(18,Pi),height:e.getUint32(22,Pi)}:null}function JE(n){const e=or(n);if(!(e.byteLength>=3&&e.getUint16(0,bt)===65496&&e.getUint8(2)===255))return null;const{tableMarkers:i,sofMarkers:r}=eA();let s=2;for(;s+9<e.byteLength;){const o=e.getUint16(s,bt);if(r.has(o))return{mimeType:"image/jpeg",height:e.getUint16(s+5,bt),width:e.getUint16(s+7,bt)};if(!i.has(o))return null;s+=2,s+=e.getUint16(s,bt)}return null}function eA(){const n=new Set([65499,65476,65484,65501,65534]);for(let t=65504;t<65520;++t)n.add(t);return{tableMarkers:n,sofMarkers:new Set([65472,65473,65474,65475,65477,65478,65479,65481,65482,65483,65485,65486,65487,65502])}}function or(n){if(n instanceof DataView)return n;if(ArrayBuffer.isView(n))return new DataView(n.buffer);if(n instanceof ArrayBuffer)return new DataView(n);throw new Error("toDataView")}async function tA(n,e){var r;const{mimeType:t}=Ug(n)||{},i=(r=globalThis.loaders)==null?void 0:r.parseImageNode;return bs(i),await i(n,t)}async function nA(n,e,t){e=e||{};const r=(e.image||{}).type||"auto",{url:s}=t||{},o=iA(r);let a;switch(o){case"imagebitmap":a=await zE(n,e,s);break;case"image":a=await Lg(n,e,s);break;case"data":a=await tA(n);break;default:bs(!1)}return r==="data"&&(a=NE(a)),a}function iA(n){switch(n){case"auto":case"data":return kE();default:return ME(n),n}}const rA=["png","jpg","jpeg","gif","webp","bmp","ico","svg","avif"],sA=["image/png","image/jpeg","image/gif","image/webp","image/avif","image/bmp","image/vnd.microsoft.icon","image/svg+xml"],oA={image:{type:"auto",decode:!0}},aA={dataType:null,batchType:null,id:"image",module:"images",name:"Images",version:IE,mimeTypes:sA,extensions:rA,parse:nA,tests:[n=>!!Ug(new DataView(n))],options:oA},lA=new rr({id:"deck"}),Q=lA;let rl={};function cA(n){rl=n}function De(n,e,t,i){Q.level>0&&rl[n]&&rl[n].call(null,e,t,i)}function uA(n){const e=n[0],t=n[n.length-1];return e==="{"&&t==="}"||e==="["&&t==="]"}const dA={dataType:null,batchType:null,id:"JSON",name:"JSON",module:"",version:"",options:{},extensions:["json","geojson"],mimeTypes:["application/json","application/geo+json"],testText:uA,parseTextSync:JSON.parse};function hA(){const n="9.1.14",e=globalThis.deck&&globalThis.deck.VERSION;if(e&&e!==n)throw new Error(`deck.gl - multiple versions detected: ${e} vs ${n}`);return e||(Q.log(1,`deck.gl ${n}`)(),globalThis.deck={...globalThis.deck,VERSION:n,version:n,log:Q,_registerLoggers:cA},iE([dA,[aA,{imagebitmap:{premultiplyAlpha:"none"}}]])),n}const fA=hA();function Fc(n,e){if(!n)throw new Error(e||"shadertools: assertion failed.")}const jo={number:{type:"number",validate(n,e){return Number.isFinite(n)&&typeof e=="object"&&(e.max===void 0||n<=e.max)&&(e.min===void 0||n>=e.min)}},array:{type:"array",validate(n,e){return Array.isArray(n)||ArrayBuffer.isView(n)}}};function pA(n){const e={};for(const[t,i]of Object.entries(n))e[t]=gA(i);return e}function gA(n){let e=Ud(n);if(e!=="object")return{value:n,...jo[e],type:e};if(typeof n=="object")return n?n.type!==void 0?{...n,...jo[n.type],type:n.type}:n.value===void 0?{type:"object",value:n}:(e=Ud(n.value),{...n,...jo[e],type:e}):{type:"object",value:null};throw new Error("props")}function Ud(n){return Array.isArray(n)||ArrayBuffer.isView(n)?"array":typeof n}const mA=`#ifdef MODULE_LOGDEPTH
  logdepth_adjustPosition(gl_Position);
#endif
`,_A=`#ifdef MODULE_MATERIAL
  fragColor = material_filterColor(fragColor);
#endif

#ifdef MODULE_LIGHTING
  fragColor = lighting_filterColor(fragColor);
#endif

#ifdef MODULE_FOG
  fragColor = fog_filterColor(fragColor);
#endif

#ifdef MODULE_PICKING
  fragColor = picking_filterHighlightColor(fragColor);
  fragColor = picking_filterPickingColor(fragColor);
#endif

#ifdef MODULE_LOGDEPTH
  logdepth_setFragDepth();
#endif
`,yA={vertex:mA,fragment:_A},$d=/void\s+main\s*\([^)]*\)\s*\{\n?/,zd=/}\n?[^{}]*$/,Xo=[],Xr="__LUMA_INJECT_DECLARATIONS__";function bA(n){const e={vertex:{},fragment:{}};for(const t in n){let i=n[t];const r=vA(t);typeof i=="string"&&(i={order:0,injection:i}),e[r][t]=i}return e}function vA(n){const e=n.slice(0,2);switch(e){case"vs":return"vertex";case"fs":return"fragment";default:throw new Error(e)}}function Ss(n,e,t,i=!1){const r=e==="vertex";for(const s in t){const o=t[s];o.sort((l,c)=>l.order-c.order),Xo.length=o.length;for(let l=0,c=o.length;l<c;++l)Xo[l]=o[l].injection;const a=`${Xo.join(`
`)}
`;switch(s){case"vs:#decl":r&&(n=n.replace(Xr,a));break;case"vs:#main-start":r&&(n=n.replace($d,l=>l+a));break;case"vs:#main-end":r&&(n=n.replace(zd,l=>a+l));break;case"fs:#decl":r||(n=n.replace(Xr,a));break;case"fs:#main-start":r||(n=n.replace($d,l=>l+a));break;case"fs:#main-end":r||(n=n.replace(zd,l=>a+l));break;default:n=n.replace(s,l=>l+a)}}return n=n.replace(Xr,""),i&&(n=n.replace(/\}\s*$/,s=>s+yA[e])),n}function Es(n){n.map(e=>xA(e))}function xA(n){if(n.instance)return;Es(n.dependencies||[]);const{propTypes:e={},deprecations:t=[],inject:i={}}=n,r={normalizedInjections:bA(i),parsedDeprecations:wA(t)};e&&(r.propValidators=pA(e)),n.instance=r;let s={};e&&(s=Object.entries(e).reduce((o,[a,l])=>{const c=l==null?void 0:l.value;return c&&(o[a]=c),o},{})),n.defaultUniforms={...n.defaultUniforms,...s}}function $g(n,e,t){var i;(i=n.deprecations)==null||i.forEach(r=>{var s;(s=r.regex)!=null&&s.test(e)&&(r.deprecated?t.deprecated(r.old,r.new)():t.removed(r.old,r.new)())})}function wA(n){return n.forEach(e=>{switch(e.type){case"function":e.regex=new RegExp(`\\b${e.old}\\(`);break;default:e.regex=new RegExp(`${e.type} ${e.old};`)}}),n}function Dc(n){Es(n);const e={},t={};zg({modules:n,level:0,moduleMap:e,moduleDepth:t});const i=Object.keys(t).sort((r,s)=>t[s]-t[r]).map(r=>e[r]);return Es(i),i}function zg(n){const{modules:e,level:t,moduleMap:i,moduleDepth:r}=n;if(t>=5)throw new Error("Possible loop in shader dependency graph");for(const s of e)i[s.name]=s,(r[s.name]===void 0||r[s.name]<t)&&(r[s.name]=t);for(const s of e)s.dependencies&&zg({modules:s.dependencies,level:t+1,moduleMap:i,moduleDepth:r})}function TA(n){switch(n==null?void 0:n.gpu.toLowerCase()){case"apple":return`#define APPLE_GPU
// Apple optimizes away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
#define LUMA_FP32_TAN_PRECISION_WORKAROUND 1
// Intel GPU doesn't have full 32 bits precision in same cases, causes overflow
#define LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND 1
`;case"nvidia":return`#define NVIDIA_GPU
// Nvidia optimizes away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
`;case"intel":return`#define INTEL_GPU
// Intel optimizes away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
// Intel's built-in 'tan' function doesn't have acceptable precision
#define LUMA_FP32_TAN_PRECISION_WORKAROUND 1
// Intel GPU doesn't have full 32 bits precision in same cases, causes overflow
#define LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND 1
`;case"amd":return`#define AMD_GPU
`;default:return`#define DEFAULT_GPU
// Prevent driver from optimizing away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
// Headless Chrome's software shader 'tan' function doesn't have acceptable precision
#define LUMA_FP32_TAN_PRECISION_WORKAROUND 1
// If the GPU doesn't have full 32 bits precision, will causes overflow
#define LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND 1
`}}function SA(n,e){var i;if(Number(((i=n.match(/^#version[ \t]+(\d+)/m))==null?void 0:i[1])||100)!==300)throw new Error("luma.gl v9 only supports GLSL 3.00 shader sources");switch(e){case"vertex":return n=Vd(n,EA),n;case"fragment":return n=Vd(n,AA),n;default:throw new Error(e)}}const Vg=[[/^(#version[ \t]+(100|300[ \t]+es))?[ \t]*\n/,`#version 300 es
`],[/\btexture(2D|2DProj|Cube)Lod(EXT)?\(/g,"textureLod("],[/\btexture(2D|2DProj|Cube)(EXT)?\(/g,"texture("]],EA=[...Vg,[sl("attribute"),"in $1"],[sl("varying"),"out $1"]],AA=[...Vg,[sl("varying"),"in $1"]];function Vd(n,e){for(const[t,i]of e)n=n.replace(t,i);return n}function sl(n){return new RegExp(`\\b${n}[ \\t]+(\\w+[ \\t]+\\w+(\\[\\w+\\])?;)`,"g")}function Wg(n,e){let t="";for(const i in n){const r=n[i];if(t+=`void ${r.signature} {
`,r.header&&(t+=`  ${r.header}`),e[i]){const s=e[i];s.sort((o,a)=>o.order-a.order);for(const o of s)t+=`  ${o.injection}
`}r.footer&&(t+=`  ${r.footer}`),t+=`}
`}return t}function Hg(n){const e={vertex:{},fragment:{}};for(const t of n){let i,r;typeof t!="string"?(i=t,r=i.hook):(i={},r=t),r=r.trim();const[s,o]=r.split(":"),a=r.replace(/\(.+/,""),l=Object.assign(i,{signature:o});switch(s){case"vs":e.vertex[a]=l;break;case"fs":e.fragment[a]=l;break;default:throw new Error(s)}}return e}function CA(n,e){return{name:IA(n,e),language:"glsl",version:RA(n)}}function IA(n,e="unnamed"){const i=/#define[^\S\r\n]*SHADER_NAME[^\S\r\n]*([A-Za-z0-9_-]+)\s*/.exec(n);return i?i[1]:e}function RA(n){let e=100;const t=n.match(/[^\s]+/g);if(t&&t.length>=2&&t[0]==="#version"){const i=parseInt(t[1],10);Number.isFinite(i)&&(e=i)}if(e!==100&&e!==300)throw new Error(`Invalid GLSL version ${e}`);return e}const jg=`

${Xr}
`,PA=`precision highp float;
`;function MA(n){const e=Dc(n.modules||[]);return{source:OA(n.platformInfo,{...n,source:n.source,stage:"vertex",modules:e}),getUniforms:Xg(e)}}function kA(n){const{vs:e,fs:t}=n,i=Dc(n.modules||[]);return{vs:Wd(n.platformInfo,{...n,source:e,stage:"vertex",modules:i}),fs:Wd(n.platformInfo,{...n,source:t,stage:"fragment",modules:i}),getUniforms:Xg(i)}}function OA(n,e){var g;const{source:t,stage:i,modules:r,hookFunctions:s=[],inject:o={},log:a}=e;Fc(typeof t=="string","shader source must be a string");const l=t;let c="";const u=Hg(s),d={},h={},f={};for(const _ in o){const b=typeof o[_]=="string"?{injection:o[_],order:0}:o[_],w=/^(v|f)s:(#)?([\w-]+)$/.exec(_);if(w){const x=w[2],y=w[3];x?y==="decl"?h[_]=[b]:f[_]=[b]:d[_]=[b]}else f[_]=[b]}const p=r;for(const _ of p){a&&$g(_,l,a);const b=Yg(_,"wgsl");c+=b;const w=((g=_.injections)==null?void 0:g[i])||{};for(const x in w){const y=/^(v|f)s:#([\w-]+)$/.exec(x);if(y){const I=y[2]==="decl"?h:f;I[x]=I[x]||[],I[x].push(w[x])}else d[x]=d[x]||[],d[x].push(w[x])}}return c+=jg,c=Ss(c,i,h),c+=Wg(u[i],d),c+=l,c=Ss(c,i,f),c}function Wd(n,e){var F;const{id:t,source:i,stage:r,language:s="glsl",modules:o,defines:a={},hookFunctions:l=[],inject:c={},prologue:u=!0,log:d}=e;Fc(typeof i=="string","shader source must be a string");const h=s==="glsl"?CA(i).version:-1,f=n.shaderLanguageVersion,p=h===100?"#version 100":"#version 300 es",_=i.split(`
`).slice(1).join(`
`),b={};o.forEach(D=>{Object.assign(b,D.defines)}),Object.assign(b,a);let w="";switch(s){case"wgsl":break;case"glsl":w=u?`${p}

// ----- PROLOGUE -------------------------
${NA({id:t,source:i,stage:r})}
${`#define SHADER_TYPE_${r.toUpperCase()}`}

${TA(n)}
${r==="fragment"?PA:""}

// ----- APPLICATION DEFINES -------------------------

${FA(b)}

`:`${p}
`;break}const x=Hg(l),y={},S={},I={};for(const D in c){const B=typeof c[D]=="string"?{injection:c[D],order:0}:c[D],U=/^(v|f)s:(#)?([\w-]+)$/.exec(D);if(U){const O=U[2],H=U[3];O?H==="decl"?S[D]=[B]:I[D]=[B]:y[D]=[B]}else I[D]=[B]}for(const D of o){d&&$g(D,_,d);const B=Yg(D,r);w+=B;const U=((F=D.instance)==null?void 0:F.normalizedInjections[r])||{};for(const O in U){const H=/^(v|f)s:#([\w-]+)$/.exec(O);if(H){const z=H[2]==="decl"?S:I;z[O]=z[O]||[],z[O].push(U[O])}else y[O]=y[O]||[],y[O].push(U[O])}}return w+="// ----- MAIN SHADER SOURCE -------------------------",w+=jg,w=Ss(w,r,S),w+=Wg(x[r],y),w+=_,w=Ss(w,r,I),s==="glsl"&&h!==f&&(w=SA(w,r)),w.trim()}function Xg(n){return function(t){var r;const i={};for(const s of n){const o=(r=s.getUniforms)==null?void 0:r.call(s,t,i);Object.assign(i,o)}return i}}function NA(n){const{id:e,source:t,stage:i}=n;return e&&t.indexOf("SHADER_NAME")===-1?`
#define SHADER_NAME ${e}_${i}`:""}function FA(n={}){let e="";for(const t in n){const i=n[t];(i||Number.isFinite(i))&&(e+=`#define ${t.toUpperCase()} ${n[t]}
`)}return e}function Yg(n,e){let t;switch(e){case"vertex":t=n.vs||"";break;case"fragment":t=n.fs||"";break;case"wgsl":t=n.source||"";break;default:Fc(!1)}if(!n.name)throw new Error("Shader module must have a name");const i=n.name.toUpperCase().replace(/[^0-9a-z]/gi,"_");let r=`// ----- MODULE ${n.name} ---------------

`;return e!=="wgsl"&&(r+=`#define MODULE_${i}
`),r+=`${t}
`,r}const DA=/^\s*\#\s*ifdef\s*([a-zA-Z_]+)\s*$/,BA=/^\s*\#\s*endif\s*$/;function LA(n,e){var o;const t=n.split(`
`),i=[];let r=!0,s=null;for(const a of t){const l=a.match(DA),c=a.match(BA);l?(s=l[1],r=!!((o=e==null?void 0:e.defines)!=null&&o[s])):c?r=!0:r&&i.push(a)}return i.join(`
`)}const an=class an{constructor(){m(this,"_hookFunctions",[]);m(this,"_defaultModules",[])}static getDefaultShaderAssembler(){return an.defaultShaderAssembler=an.defaultShaderAssembler||new an,an.defaultShaderAssembler}addDefaultModule(e){this._defaultModules.find(t=>t.name===(typeof e=="string"?e:e.name))||this._defaultModules.push(e)}removeDefaultModule(e){const t=typeof e=="string"?e:e.name;this._defaultModules=this._defaultModules.filter(i=>i.name!==t)}addShaderHook(e,t){t&&(e=Object.assign(t,{hook:e})),this._hookFunctions.push(e)}assembleWGSLShader(e){const t=this._getModuleList(e.modules),i=this._hookFunctions,{source:r,getUniforms:s}=MA({...e,source:e.source,modules:t,hookFunctions:i});return{source:e.platformInfo.shaderLanguage==="wgsl"?LA(r):r,getUniforms:s,modules:t}}assembleGLSLShaderPair(e){const t=this._getModuleList(e.modules),i=this._hookFunctions;return{...kA({...e,vs:e.vs,fs:e.fs,modules:t,hookFunctions:i}),modules:t}}_getModuleList(e=[]){const t=new Array(this._defaultModules.length+e.length),i={};let r=0;for(let s=0,o=this._defaultModules.length;s<o;++s){const a=this._defaultModules[s],l=a.name;t[r++]=a,i[l]=!0}for(let s=0,o=e.length;s<o;++s){const a=e[s],l=a.name;i[l]||(t[r++]=a,i[l]=!0)}return t.length=r,Es(t),t}};m(an,"defaultShaderAssembler");let As=an;const UA=`out vec4 transform_output;
void main() {
  transform_output = vec4(0);
}`,$A=`#version 300 es
${UA}`;function zA(n){const{input:e,inputChannels:t,output:i}=n||{};if(!e)return $A;if(!t)throw new Error("inputChannels");const r=VA(t),s=WA(e,t);return`#version 300 es
in ${r} ${e};
out vec4 ${i};
void main() {
  ${i} = ${s};
}`}function VA(n){switch(n){case 1:return"float";case 2:return"vec2";case 3:return"vec3";case 4:return"vec4";default:throw new Error(`invalid channels: ${n}`)}}function WA(n,e){switch(e){case 1:return`vec4(${n}, 0.0, 0.0, 1.0)`;case 2:return`vec4(${n}, 0.0, 1.0)`;case 3:return`vec4(${n}, 1.0)`;case 4:return n;default:throw new Error(`invalid channels: ${e}`)}}class HA{constructor(){m(this,"stats",new Map)}getStats(e){return this.get(e)}get(e){return this.stats.has(e)||this.stats.set(e,new yo({id:e})),this.stats.get(e)}}const qg=new HA,L=new rr({id:"luma.gl"}),Yo={};function vo(n="id"){Yo[n]=Yo[n]||1;const e=Yo[n]++;return`${n}-${e}`}var Ra;let se=(Ra=class{constructor(e,t,i){m(this,"id");m(this,"props");m(this,"userData",{});m(this,"_device");m(this,"destroyed",!1);m(this,"allocatedBytes",0);m(this,"_attachedResources",new Set);if(!e)throw new Error("no device");this._device=e,this.props=jA(t,i);const r=this.props.id!=="undefined"?this.props.id:vo(this[Symbol.toStringTag]);this.props.id=r,this.id=r,this.userData=this.props.userData||{},this.addStats()}toString(){return`${this[Symbol.toStringTag]||this.constructor.name}:"${this.id}"`}destroy(){this.destroyResource()}delete(){return this.destroy(),this}getProps(){return this.props}attachResource(e){this._attachedResources.add(e)}detachResource(e){this._attachedResources.delete(e)}destroyAttachedResource(e){this._attachedResources.delete(e)&&e.destroy()}destroyAttachedResources(){for(const e of Object.values(this._attachedResources))e.destroy();this._attachedResources=new Set}destroyResource(){this.destroyAttachedResources(),this.removeStats(),this.destroyed=!0}removeStats(){const e=this._device.statsManager.getStats("Resource Counts"),t=this[Symbol.toStringTag];e.get(`${t}s Active`).decrementCount()}trackAllocatedMemory(e,t=this[Symbol.toStringTag]){const i=this._device.statsManager.getStats("Resource Counts");i.get("GPU Memory").addCount(e),i.get(`${t} Memory`).addCount(e),this.allocatedBytes=e}trackDeallocatedMemory(e=this[Symbol.toStringTag]){const t=this._device.statsManager.getStats("Resource Counts");t.get("GPU Memory").subtractCount(this.allocatedBytes),t.get(`${e} Memory`).subtractCount(this.allocatedBytes),this.allocatedBytes=0}addStats(){const e=this._device.statsManager.getStats("Resource Counts"),t=this[Symbol.toStringTag];e.get("Resources Created").incrementCount(),e.get(`${t}s Created`).incrementCount(),e.get(`${t}s Active`).incrementCount()}},m(Ra,"defaultProps",{id:"undefined",handle:void 0,userData:void 0}),Ra);function jA(n,e){const t={...e};for(const i in n)n[i]!==void 0&&(t[i]=n[i]);return t}const Ie=class Ie extends se{constructor(t,i){const r={...i};(i.usage||0)&Ie.INDEX&&!i.indexType&&(i.data instanceof Uint32Array?r.indexType="uint32":i.data instanceof Uint16Array&&(r.indexType="uint16")),delete r.data;super(t,r,Ie.defaultProps);m(this,"usage");m(this,"indexType");m(this,"updateTimestamp");m(this,"debugData",new ArrayBuffer(0));this.usage=r.usage||0,this.indexType=r.indexType,this.updateTimestamp=t.incrementTimestamp()}get[Symbol.toStringTag](){return"Buffer"}clone(t){return this.device.createBuffer({...this.props,...t})}readSyncWebGL(t,i){throw new Error("not implemented")}_setDebugData(t,i,r){const s=ArrayBuffer.isView(t)?t.buffer:t,o=Math.min(t?t.byteLength:r,Ie.DEBUG_DATA_MAX_LENGTH);s===null?this.debugData=new ArrayBuffer(o):i===0&&r===s.byteLength?this.debugData=s.slice(0,o):this.debugData=s.slice(i,i+o)}};m(Ie,"defaultProps",{...se.defaultProps,usage:0,byteLength:0,byteOffset:0,data:null,indexType:"uint16",mappedAtCreation:!1}),m(Ie,"MAP_READ",1),m(Ie,"MAP_WRITE",2),m(Ie,"COPY_SRC",4),m(Ie,"COPY_DST",8),m(Ie,"INDEX",16),m(Ie,"VERTEX",32),m(Ie,"UNIFORM",64),m(Ie,"STORAGE",128),m(Ie,"INDIRECT",256),m(Ie,"QUERY_RESOLVE",512),m(Ie,"DEBUG_DATA_MAX_LENGTH",32);let le=Ie;function Kg(n){const e=Hd[n],t=XA(e),i=n.includes("norm"),r=!i&&!n.startsWith("float"),s=n.startsWith("s");return{dataType:Hd[n],byteLength:t,integer:r,signed:s,normalized:i}}function XA(n){return YA[n]}const Hd={uint8:"uint8",sint8:"sint8",unorm8:"uint8",snorm8:"sint8",uint16:"uint16",sint16:"sint16",unorm16:"uint16",snorm16:"sint16",float16:"float16",float32:"float32",uint32:"uint32",sint32:"sint32"},YA={uint8:1,sint8:1,uint16:2,sint16:2,float16:2,float32:4,uint32:4,sint32:4},Oe="texture-compression-bc",ie="texture-compression-astc",gt="texture-compression-etc2",qA="texture-compression-etc1-webgl",Er="texture-compression-pvrtc-webgl",qo="texture-compression-atc-webgl",Ar="float32-renderable-webgl",Ko="float16-renderable-webgl",KA="rgb9e5ufloat-renderable-webgl",Zo="snorm8-renderable-webgl",hi="norm16-renderable-webgl",Go="snorm16-renderable-webgl",Cr="float32-filterable",jd="float16-filterable-webgl";function Zg(n){const e=ZA[n];if(!e)throw new Error(`Unsupported texture format ${n}`);return e}const ZA={r8unorm:{},r8snorm:{render:Zo},r8uint:{},r8sint:{},rg8unorm:{},rg8snorm:{render:Zo},rg8uint:{},rg8sint:{},r16uint:{},r16sint:{},r16float:{render:Ko,filter:"float16-filterable-webgl"},"r16unorm-webgl":{f:hi},"r16snorm-webgl":{f:Go},"rgba4unorm-webgl":{channels:"rgba",bitsPerChannel:[4,4,4,4],packed:!0},"rgb565unorm-webgl":{channels:"rgb",bitsPerChannel:[5,6,5,0],packed:!0},"rgb5a1unorm-webgl":{channels:"rgba",bitsPerChannel:[5,5,5,1],packed:!0},"rgb8unorm-webgl":{},"rgb8snorm-webgl":{},rgba8unorm:{},"rgba8unorm-srgb":{},rgba8snorm:{render:Zo},rgba8uint:{},rgba8sint:{},bgra8unorm:{},"bgra8unorm-srgb":{},rg16uint:{},rg16sint:{},rg16float:{render:Ko,filter:jd},"rg16unorm-webgl":{render:hi},"rg16snorm-webgl":{render:Go},r32uint:{},r32sint:{},r32float:{render:Ar,filter:Cr},rgb9e5ufloat:{channels:"rgb",packed:!0,render:KA},rg11b10ufloat:{channels:"rgb",bitsPerChannel:[11,11,10,0],packed:!0,p:1,render:Ar},rgb10a2unorm:{channels:"rgba",bitsPerChannel:[10,10,10,2],packed:!0,p:1},"rgb10a2uint-webgl":{channels:"rgba",bitsPerChannel:[10,10,10,2],packed:!0,p:1,wgpu:!1},"rgb16unorm-webgl":{f:hi},"rgb16snorm-webgl":{f:hi},rg32uint:{},rg32sint:{},rg32float:{render:!1,filter:Cr},rgba16uint:{},rgba16sint:{},rgba16float:{render:Ko,filter:jd},"rgba16unorm-webgl":{render:hi},"rgba16snorm-webgl":{render:Go},"rgb32float-webgl":{render:Ar,filter:Cr},rgba32uint:{},rgba32sint:{},rgba32float:{render:Ar,filter:Cr},stencil8:{attachment:"stencil",bitsPerChannel:[8,0,0,0],dataType:"uint8"},depth16unorm:{attachment:"depth",bitsPerChannel:[16,0,0,0],dataType:"uint16"},depth24plus:{attachment:"depth",bitsPerChannel:[24,0,0,0],dataType:"uint32"},depth32float:{attachment:"depth",bitsPerChannel:[32,0,0,0],dataType:"float32"},"depth24plus-stencil8":{attachment:"depth-stencil",bitsPerChannel:[24,8,0,0],packed:!0},"depth32float-stencil8":{attachment:"depth-stencil",bitsPerChannel:[32,8,0,0],packed:!0},"bc1-rgb-unorm-webgl":{f:Oe},"bc1-rgb-unorm-srgb-webgl":{f:Oe},"bc1-rgba-unorm":{f:Oe},"bc1-rgba-unorm-srgb":{f:Oe},"bc2-rgba-unorm":{f:Oe},"bc2-rgba-unorm-srgb":{f:Oe},"bc3-rgba-unorm":{f:Oe},"bc3-rgba-unorm-srgb":{f:Oe},"bc4-r-unorm":{f:Oe},"bc4-r-snorm":{f:Oe},"bc5-rg-unorm":{f:Oe},"bc5-rg-snorm":{f:Oe},"bc6h-rgb-ufloat":{f:Oe},"bc6h-rgb-float":{f:Oe},"bc7-rgba-unorm":{f:Oe},"bc7-rgba-unorm-srgb":{f:Oe},"etc2-rgb8unorm":{f:gt},"etc2-rgb8unorm-srgb":{f:gt},"etc2-rgb8a1unorm":{f:gt},"etc2-rgb8a1unorm-srgb":{f:gt},"etc2-rgba8unorm":{f:gt},"etc2-rgba8unorm-srgb":{f:gt},"eac-r11unorm":{f:gt},"eac-r11snorm":{f:gt},"eac-rg11unorm":{f:gt},"eac-rg11snorm":{f:gt},"astc-4x4-unorm":{f:ie},"astc-4x4-unorm-srgb":{f:ie},"astc-5x4-unorm":{f:ie},"astc-5x4-unorm-srgb":{f:ie},"astc-5x5-unorm":{f:ie},"astc-5x5-unorm-srgb":{f:ie},"astc-6x5-unorm":{f:ie},"astc-6x5-unorm-srgb":{f:ie},"astc-6x6-unorm":{f:ie},"astc-6x6-unorm-srgb":{f:ie},"astc-8x5-unorm":{f:ie},"astc-8x5-unorm-srgb":{f:ie},"astc-8x6-unorm":{f:ie},"astc-8x6-unorm-srgb":{f:ie},"astc-8x8-unorm":{f:ie},"astc-8x8-unorm-srgb":{f:ie},"astc-10x5-unorm":{f:ie},"astc-10x5-unorm-srgb":{f:ie},"astc-10x6-unorm":{f:ie},"astc-10x6-unorm-srgb":{f:ie},"astc-10x8-unorm":{f:ie},"astc-10x8-unorm-srgb":{f:ie},"astc-10x10-unorm":{f:ie},"astc-10x10-unorm-srgb":{f:ie},"astc-12x10-unorm":{f:ie},"astc-12x10-unorm-srgb":{f:ie},"astc-12x12-unorm":{f:ie},"astc-12x12-unorm-srgb":{f:ie},"pvrtc-rgb4unorm-webgl":{f:Er},"pvrtc-rgba4unorm-webgl":{f:Er},"pvrtc-rbg2unorm-webgl":{f:Er},"pvrtc-rgba2unorm-webgl":{f:Er},"etc1-rbg-unorm-webgl":{f:qA},"atc-rgb-unorm-webgl":{f:qo},"atc-rgba-unorm-webgl":{f:qo},"atc-rgbai-unorm-webgl":{f:qo}},GA=["bc1","bc2","bc3","bc4","bc5","bc6","bc7","etc1","etc2","eac","atc","astc","pvrtc"],QA=/^(r|rg|rgb|rgba|bgra)([0-9]*)([a-z]*)(-srgb)?(-webgl)?$/;function Gg(n){return GA.some(e=>n.startsWith(e))}function Bc(n){let e=JA(n);if(Gg(n)){e.channels="rgb",e.components=3,e.bytesPerPixel=1,e.srgb=!1,e.compressed=!0;const i=eC(n);i&&(e.blockWidth=i.blockWidth,e.blockHeight=i.blockHeight)}const t=QA.exec(n);if(t){const[,i,r,s,o,a]=t,l=`${s}${r}`,c=Kg(l),u=c.byteLength*8,d=i.length,h=[u,d>=2?u:0,d>=3?u:0,d>=4?u:0];e={format:n,attachment:e.attachment,dataType:c.dataType,components:d,channels:i,integer:c.integer,signed:c.signed,normalized:c.normalized,bitsPerChannel:h,bytesPerPixel:c.byteLength*i.length,packed:e.packed,srgb:e.srgb},a==="-webgl"&&(e.webgl=!0),o==="-srgb"&&(e.srgb=!0)}return n.endsWith("-webgl")&&(e.webgl=!0),n.endsWith("-srgb")&&(e.srgb=!0),e}function JA(n){var s;const e=Zg(n),t=e.bytesPerPixel||1,i=e.bitsPerChannel||[8,8,8,8];return delete e.bitsPerChannel,delete e.bytesPerPixel,delete e.f,delete e.render,delete e.filter,delete e.blend,delete e.store,{...e,format:n,attachment:e.attachment||"color",channels:e.channels||"r",components:e.components||((s=e.channels)==null?void 0:s.length)||1,bytesPerPixel:t,bitsPerChannel:i,dataType:e.dataType||"uint8",srgb:e.srgb??!1,packed:e.packed??!1,webgl:e.webgl??!1,integer:e.integer??!1,signed:e.signed??!1,normalized:e.normalized??!1,compressed:e.compressed??!1}}function eC(n){const t=/.*-(\d+)x(\d+)-.*/.exec(n);if(t){const[,i,r]=t;return{blockWidth:Number(i),blockHeight:Number(r)}}return null}function tC(n){const e=Zg(n),t={format:n,create:e.f??!0,render:e.render??!0,filter:e.filter??!0,blend:e.blend??!0,store:e.store??!0},i=Bc(n),r=n.startsWith("depth")||n.startsWith("stencil"),s=i==null?void 0:i.signed,o=i==null?void 0:i.integer,a=i==null?void 0:i.webgl;return t.render&&(t.render=!s),t.filter&&(t.filter=!r&&!s&&!o&&!a),t}class nC{}class iC{constructor(e=[],t){m(this,"features");m(this,"disabledFeatures");this.features=new Set(e),this.disabledFeatures=t||{}}*[Symbol.iterator](){yield*this.features}has(e){var t;return!((t=this.disabledFeatures)!=null&&t[e])&&this.features.has(e)}}const Gs=class Gs{constructor(e){m(this,"id");m(this,"props");m(this,"userData",{});m(this,"statsManager",qg);m(this,"timestamp",0);m(this,"_reused",!1);m(this,"_lumaData",{});this.props={...Gs.defaultProps,...e},this.id=this.props.id||vo(this[Symbol.toStringTag].toLowerCase())}get[Symbol.toStringTag](){return"Device"}getTextureFormatCapabilities(e){const t=tC(e),i=o=>(typeof o=="string"?this.features.has(o):o)??!0,r=i(t.create),s={format:e,create:r,render:r&&i(t.render),filter:r&&i(t.filter),blend:r&&i(t.blend),store:r&&i(t.store)};return this._getDeviceSpecificTextureFormatCapabilities(s)}isTextureFormatSupported(e,t){return this.getTextureFormatCapabilities(e).create}isTextureFormatFilterable(e){return this.getTextureFormatCapabilities(e).filter}isTextureFormatRenderable(e){return this.getTextureFormatCapabilities(e).render}isTextureFormatCompressed(e){return Gg(e)}loseDevice(){return!1}reportError(e){this.props.onError(e)}getDefaultCanvasContext(){if(!this.canvasContext)throw new Error("Device has no default CanvasContext. See props.createCanvasContext");return this.canvasContext}createCommandEncoder(e={}){throw new Error("not implemented")}incrementTimestamp(){return this.timestamp++}onError(e){this.props.onError(e)}getCanvasContext(){return this.getDefaultCanvasContext()}readPixelsToArrayWebGL(e,t){throw new Error("not implemented")}readPixelsToBufferWebGL(e,t){throw new Error("not implemented")}setParametersWebGL(e){throw new Error("not implemented")}getParametersWebGL(e){throw new Error("not implemented")}withParametersWebGL(e,t){throw new Error("not implemented")}clearWebGL(e){throw new Error("not implemented")}resetWebGL(){throw new Error("not implemented")}static _getCanvasContextProps(e){return e.createCanvasContext===!0?{}:e.createCanvasContext}_normalizeBufferProps(e){(e instanceof ArrayBuffer||ArrayBuffer.isView(e))&&(e={data:e});const t={...e};return(e.usage||0)&le.INDEX&&!e.indexType&&(e.data instanceof Uint32Array?t.indexType="uint32":e.data instanceof Uint16Array?t.indexType="uint16":L.warn("indices buffer content must be of integer type")()),t}};m(Gs,"defaultProps",{id:null,powerPreference:"high-performance",failIfMajorPerformanceCaveat:!1,createCanvasContext:void 0,onError:e=>L.error(e.message)(),_reuseDevices:!1,_requestMaxLimits:!0,_factoryDestroyPolicy:"unused",_initializeFeatures:!0,_disabledFeatures:{"compilation-status-async-webgl":!0},_resourceDefaults:{},webgl:{},debug:L.get("debug")||void 0,debugShaders:L.get("debug-shaders")||void 0,debugFramebuffers:!!L.get("debug-framebuffers"),debugWebGL:!!L.get("debug-webgl"),debugSpectorJS:void 0,debugSpectorJSUrl:void 0,_handle:void 0});let qt=Gs;const rC=wn()&&typeof document<"u",sC=()=>rC&&document.readyState==="complete",oC="set luma.log.level=1 (or higher) to trace rendering",Xd="No matching device found. Ensure `@luma.gl/webgl` and/or `@luma.gl/webgpu` modules are imported.",Ht=class Ht{constructor(){m(this,"stats",qg);m(this,"log",L);m(this,"VERSION","9.1.9");m(this,"spector");m(this,"preregisteredAdapters",new Map);if(globalThis.luma){if(globalThis.luma.VERSION!==this.VERSION)throw L.error(`Found luma.gl ${globalThis.luma.VERSION} while initialzing ${this.VERSION}`)(),L.error("'yarn why @luma.gl/core' can help identify the source of the conflict")(),new Error("luma.gl - multiple versions detected: see console log");L.error("This version of luma.gl has already been initialized")()}L.log(1,`${this.VERSION} - ${oC}`)(),globalThis.luma=this}registerAdapters(e){for(const t of e)this.preregisteredAdapters.set(t.type,t)}getSupportedAdapters(e=[]){const t=this.getAdapterMap(e);return Array.from(t).map(([,i])=>i).filter(i=>{var r;return(r=i.isSupported)==null?void 0:r.call(i)}).map(i=>i.type)}getBestAvailableAdapter(e=[]){var i,r,s,o;const t=this.getAdapterMap(e);return(r=(i=t.get("webgpu"))==null?void 0:i.isSupported)!=null&&r.call(i)?"webgpu":(o=(s=t.get("webgl"))==null?void 0:s.isSupported)!=null&&o.call(s)?"webgl":null}setDefaultDeviceProps(e){Object.assign(Ht.defaultProps,e)}async createDevice(e={}){var a;e={...Ht.defaultProps,...e},e.waitForPageLoad&&await Ht.pageLoaded;const t=this.getAdapterMap(e.adapters);let i=e.type||"";i==="best-available"&&(i=this.getBestAvailableAdapter(e.adapters)||i);const s=(this.getAdapterMap(e.adapters)||t).get(i),o=await((a=s==null?void 0:s.create)==null?void 0:a.call(s,e));if(o)return o;throw new Error(Xd)}async attachDevice(e){var o;const t=this.getAdapterMap(e.adapters);let i="";e.handle instanceof WebGL2RenderingContext&&(i="webgl"),e.createCanvasContext&&await Ht.pageLoaded,e.handle===null&&(i="unknown");const r=t.get(i),s=await((o=r==null?void 0:r.attach)==null?void 0:o.call(r,null));if(s)return s;throw new Error(Xd)}enforceWebGL2(e=!0,t=[]){var s;const r=this.getAdapterMap(t).get("webgl");r||L.warn("enforceWebGL2: webgl adapter not found")(),(s=r==null?void 0:r.enforceWebGL2)==null||s.call(r,e)}getAdapterMap(e=[]){const t=new Map(this.preregisteredAdapters);for(const i of e)t.set(i.type,i);return t}registerDevices(e){L.warn("luma.registerDevices() is deprecated, use luma.registerAdapters() instead");for(const t of e){const i=t.adapter;i&&this.preregisteredAdapters.set(i.type,i)}}};m(Ht,"defaultProps",{...qt.defaultProps,type:"best-available",adapters:void 0,waitForPageLoad:!0}),m(Ht,"pageLoaded",aC().then(()=>{L.probe(2,"DOM is loaded")()}));let ol=Ht;const al=new ol;function aC(){return sC()||typeof window>"u"?Promise.resolve():new Promise(n=>{window.addEventListener("load",()=>n())})}class lC{}const Qs=class Qs{constructor(e){m(this,"id");m(this,"props");m(this,"canvas");m(this,"htmlCanvas");m(this,"offscreenCanvas");m(this,"type");m(this,"width",1);m(this,"height",1);m(this,"resizeObserver");m(this,"_canvasSizeInfo",{clientWidth:0,clientHeight:0,devicePixelRatio:1});if(this.props={...Qs.defaultProps,...e},e=this.props,!wn()){this.id="node-canvas-context",this.type="node",this.width=this.props.width,this.height=this.props.height,this.canvas=null;return}if(e.canvas)typeof e.canvas=="string"?this.canvas=uC(e.canvas):this.canvas=e.canvas;else{const t=dC(e),i=cC((e==null?void 0:e.container)||null);i.insertBefore(t,i.firstChild),this.canvas=t,e!=null&&e.visible||(this.canvas.style.visibility="hidden")}this.canvas instanceof HTMLCanvasElement?(this.id=this.canvas.id,this.type="html-canvas",this.htmlCanvas=this.canvas):(this.id="offscreen-canvas",this.type="offscreen-canvas",this.offscreenCanvas=this.canvas),this.canvas instanceof HTMLCanvasElement&&e.autoResize&&(this.resizeObserver=new ResizeObserver(t=>{for(const i of t)i.target===this.canvas&&this.update()}),this.resizeObserver.observe(this.canvas))}toString(){return`${this[Symbol.toStringTag]}(${this.id})`}getDevicePixelRatio(e){return typeof OffscreenCanvas<"u"&&this.canvas instanceof OffscreenCanvas||(e=e===void 0?this.props.useDevicePixels:e,!e||e<=0)?1:e===!0?typeof window<"u"&&window.devicePixelRatio||1:e}getPixelSize(){switch(this.type){case"node":return[this.width,this.height];case"offscreen-canvas":return[this.canvas.width,this.canvas.height];case"html-canvas":const e=this.getDevicePixelRatio(),t=this.canvas;return t.parentElement?[t.clientWidth*e,t.clientHeight*e]:[this.canvas.width,this.canvas.height];default:throw new Error(this.type)}}getAspect(){const[e,t]=this.getPixelSize();return e/t}cssToDeviceRatio(){var e;try{const[t]=this.getDrawingBufferSize(),i=this._canvasSizeInfo.clientWidth||((e=this.htmlCanvas)==null?void 0:e.clientWidth);return i?t/i:1}catch{return 1}}cssToDevicePixels(e,t=!0){const i=this.cssToDeviceRatio(),[r,s]=this.getDrawingBufferSize();return hC(e,i,r,s,t)}setDevicePixelRatio(e,t={}){if(!this.htmlCanvas)return;let i="width"in t?t.width:this.htmlCanvas.clientWidth,r="height"in t?t.height:this.htmlCanvas.clientHeight;(!i||!r)&&(L.log(1,"Canvas clientWidth/clientHeight is 0")(),e=1,i=this.htmlCanvas.width||1,r=this.htmlCanvas.height||1);const s=this._canvasSizeInfo;if(s.clientWidth!==i||s.clientHeight!==r||s.devicePixelRatio!==e){let o=e;const a=Math.floor(i*o),l=Math.floor(r*o);if(this.htmlCanvas.width=a,this.htmlCanvas.height=l,this.device.gl){const[u,d]=this.getDrawingBufferSize();(u!==a||d!==l)&&(o=Math.min(u/i,d/r),this.htmlCanvas.width=Math.floor(i*o),this.htmlCanvas.height=Math.floor(r*o),L.warn("Device pixel ratio clamped")()),this._canvasSizeInfo.clientWidth=i,this._canvasSizeInfo.clientHeight=r,this._canvasSizeInfo.devicePixelRatio=e}}}getDrawingBufferSize(){const e=this.device.gl;return e?[e.drawingBufferWidth,e.drawingBufferHeight]:this.getPixelSize()}_setAutoCreatedCanvasId(e){var t;((t=this.htmlCanvas)==null?void 0:t.id)==="lumagl-auto-created-canvas"&&(this.htmlCanvas.id=e)}};m(Qs,"defaultProps",{canvas:null,width:800,height:600,useDevicePixels:!0,autoResize:!0,container:null,visible:!0,alphaMode:"opaque",colorSpace:"srgb"});let ll=Qs;function cC(n){if(typeof n=="string"){const e=document.getElementById(n);if(!e)throw new Error(`${n} is not an HTML element`);return e}else if(n)return n;return document.body}function uC(n){const e=document.getElementById(n);if(!(e instanceof HTMLCanvasElement))throw new Error("Object is not a canvas element");return e}function dC(n){const{width:e,height:t}=n,i=document.createElement("canvas");return i.id=vo("lumagl-auto-created-canvas"),i.width=e||1,i.height=t||1,i.style.width=Number.isFinite(e)?`${e}px`:"100%",i.style.height=Number.isFinite(t)?`${t}px`:"100%",i}function hC(n,e,t,i,r){const s=n,o=Yd(s[0],e,t);let a=qd(s[1],e,i,r),l=Yd(s[0]+1,e,t);const c=l===t-1?l:l-1;l=qd(s[1]+1,e,i,r);let u;return r?(l=l===0?l:l+1,u=a,a=l):u=l===i-1?l:l-1,{x:o,y:a,width:Math.max(c-o+1,1),height:Math.max(u-a+1,1)}}function Yd(n,e,t){return Math.min(Math.round(n*e),t-1)}function qd(n,e,t,i){return i?Math.max(0,t-1-Math.round(n*e)):Math.min(Math.round(n*e),t-1)}const Re=class Re extends se{constructor(t,i){i=Re.normalizeProps(t,i);super(t,i,Re.defaultProps);m(this,"dimension");m(this,"format");m(this,"width");m(this,"height");m(this,"depth");m(this,"mipLevels");m(this,"updateTimestamp");if(this.dimension=this.props.dimension,this.format=this.props.format,this.width=this.props.width,this.height=this.props.height,this.depth=this.props.depth,this.props.width===void 0||this.props.height===void 0){const r=Re.getTextureDataSize(this.props.data);this.width=(r==null?void 0:r.width)||1,this.height=(r==null?void 0:r.height)||1}this.props.mipmaps&&this.props.mipLevels===void 0&&(this.props.mipLevels="pyramid"),this.mipLevels=this.props.mipLevels==="pyramid"?Re.getMipLevelCount(this.width,this.height):this.props.mipLevels||1,this.updateTimestamp=t.incrementTimestamp()}get[Symbol.toStringTag](){return"Texture"}toString(){return`Texture(${this.id},${this.format},${this.width}x${this.height})`}clone(t){return this.device.createTexture({...this.props,...t})}static isExternalImage(t){return typeof ImageData<"u"&&t instanceof ImageData||typeof ImageBitmap<"u"&&t instanceof ImageBitmap||typeof HTMLImageElement<"u"&&t instanceof HTMLImageElement||typeof HTMLVideoElement<"u"&&t instanceof HTMLVideoElement||typeof VideoFrame<"u"&&t instanceof VideoFrame||typeof HTMLCanvasElement<"u"&&t instanceof HTMLCanvasElement||typeof OffscreenCanvas<"u"&&t instanceof OffscreenCanvas}static getExternalImageSize(t){if(typeof ImageData<"u"&&t instanceof ImageData||typeof ImageBitmap<"u"&&t instanceof ImageBitmap||typeof HTMLCanvasElement<"u"&&t instanceof HTMLCanvasElement||typeof OffscreenCanvas<"u"&&t instanceof OffscreenCanvas)return{width:t.width,height:t.height};if(typeof HTMLImageElement<"u"&&t instanceof HTMLImageElement)return{width:t.naturalWidth,height:t.naturalHeight};if(typeof HTMLVideoElement<"u"&&t instanceof HTMLVideoElement)return{width:t.videoWidth,height:t.videoHeight};if(typeof VideoFrame<"u"&&t instanceof VideoFrame)return{width:t.displayWidth,height:t.displayHeight};throw new Error("Unknown image type")}static isTextureLevelData(t){const i=t==null?void 0:t.data;return ArrayBuffer.isView(i)}static getTextureDataSize(t){if(!t||ArrayBuffer.isView(t))return null;if(Array.isArray(t))return Re.getTextureDataSize(t[0]);if(Re.isExternalImage(t))return Re.getExternalImageSize(t);if(t&&typeof t=="object"&&t.constructor===Object){const r=Object.values(t)[0];return{width:r.width,height:r.height}}throw new Error("texture size deduction failed")}static normalizeTextureData(t,i){let r;return ArrayBuffer.isView(t)?r=[{data:t,width:i.width,height:i.height}]:Array.isArray(t)?r=t:r=[t],r}static getMipLevelCount(t,i){return Math.floor(Math.log2(Math.max(t,i)))+1}static getCubeFaceDepth(t){switch(t){case"+X":return 0;case"-X":return 1;case"+Y":return 2;case"-Y":return 3;case"+Z":return 4;case"-Z":return 5;default:throw new Error(t)}}static normalizeProps(t,i){var l,c;const r={...i},s=((c=(l=t==null?void 0:t.props)==null?void 0:l._resourceDefaults)==null?void 0:c.texture)||{};Object.assign(r,s);const{width:o,height:a}=r;return typeof o=="number"&&(r.width=Math.max(1,Math.ceil(o))),typeof a=="number"&&(r.height=Math.max(1,Math.ceil(a))),r}};m(Re,"COPY_SRC",1),m(Re,"COPY_DST",2),m(Re,"TEXTURE",4),m(Re,"STORAGE",8),m(Re,"RENDER_ATTACHMENT",16),m(Re,"CubeFaces",["+X","-X","+Y","-Y","+Z","-Z"]),m(Re,"defaultProps",{...se.defaultProps,data:null,dimension:"2d",format:"rgba8unorm",width:void 0,height:void 0,depth:1,mipmaps:!1,compressed:!1,usage:0,mipLevels:void 0,samples:void 0,sampler:{},view:void 0,flipY:void 0}),m(Re,"defaultCopyExternalImageOptions",{image:void 0,sourceX:0,sourceY:0,width:void 0,height:void 0,depth:1,mipLevel:0,x:0,y:0,z:0,aspect:"all",colorSpace:"srgb",premultipliedAlpha:!1,flipY:!1});let fe=Re;const Js=class Js extends se{get[Symbol.toStringTag](){return"TextureView"}constructor(e,t){super(e,t,Js.defaultProps)}};m(Js,"defaultProps",{...se.defaultProps,format:void 0,dimension:void 0,aspect:"all",baseMipLevel:0,mipLevelCount:void 0,baseArrayLayer:0,arrayLayerCount:void 0});let Cs=Js;function fC(n,e,t){let i="";const r=e.split(/\r?\n/),s=n.slice().sort((o,a)=>o.lineNum-a.lineNum);switch((t==null?void 0:t.showSourceCode)||"no"){case"all":let o=0;for(let a=1;a<=r.length;a++)for(i+=Qg(r[a-1],a,t);s.length>o&&s[o].lineNum===a;){const l=s[o++];i+=Kd(l,r,l.lineNum,{...t,inlineSource:!1})}return i;case"issues":case"no":for(const a of n)i+=Kd(a,r,a.lineNum,{inlineSource:(t==null?void 0:t.showSourceCode)!=="no"});return i}}function Kd(n,e,t,i){if(i!=null&&i.inlineSource){const s=pC(e,t),o=n.linePos>0?`${" ".repeat(n.linePos+5)}^^^
`:"";return`
${s}${o}${n.type.toUpperCase()}: ${n.message}

`}const r=n.type==="error"?"red":"#8B4000";return i!=null&&i.html?`<div class='luma-compiler-log-error' style="color:${r};"><b> ${n.type.toUpperCase()}: ${n.message}</b></div>`:`${n.type.toUpperCase()}: ${n.message}`}function pC(n,e,t){let i="";for(let r=e-2;r<=e;r++){const s=n[r-1];s!==void 0&&(i+=Qg(s,e,t))}return i}function Qg(n,e,t){const i=t!=null&&t.html?mC(n):n;return`${gC(String(e),4)}: ${i}${t!=null&&t.html?"<br/>":`
`}`}function gC(n,e){let t="";for(let i=n.length;i<e;++i)t+=" ";return t+n}function mC(n){return n.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;")}const eo=class eo extends se{constructor(t,i){i={...i,debugShaders:i.debugShaders||t.props.debugShaders||"errors"};super(t,{id:_C(i),...i},eo.defaultProps);m(this,"stage");m(this,"source");m(this,"compilationStatus","pending");this.stage=this.props.stage,this.source=this.props.source}get[Symbol.toStringTag](){return"Shader"}getCompilationInfoSync(){return null}getTranslatedSource(){return null}async debugShader(){const t=this.props.debugShaders;switch(t){case"never":return;case"errors":if(this.compilationStatus==="success")return;break}const i=await this.getCompilationInfo();t==="warnings"&&(i==null?void 0:i.length)===0||this._displayShaderLog(i)}_displayShaderLog(t){var c;if(typeof document>"u"||!(document!=null&&document.createElement))return;const i=Jg(this.source),r=`${this.stage} ${i}`;let s=fC(t,this.source,{showSourceCode:"all",html:!0});const o=this.getTranslatedSource();o&&(s+=`<br /><br /><h1>Translated Source</h1><br /><br /><code style="user-select:text;"><pre>${o}</pre></code>`);const a=document.createElement("Button");a.innerHTML=`
<h1>Shader Compilation Error in ${r}</h1><br /><br />
<code style="user-select:text;"><pre>
${s}
</pre></code>`,a.style.top="10px",a.style.left="10px",a.style.position="absolute",a.style.zIndex="9999",a.style.width="100%",a.style.textAlign="left",document.body.appendChild(a),(c=document.getElementsByClassName("luma-compiler-log-error")[0])==null||c.scrollIntoView(),a.onclick=()=>{const u=`data:text/plain,${encodeURIComponent(this.source)}`;navigator.clipboard.writeText(u)}}};m(eo,"defaultProps",{...se.defaultProps,language:"auto",stage:void 0,source:"",sourceMap:null,entryPoint:"main",debugShaders:void 0});let Is=eo;function _C(n){return Jg(n.source)||n.id||vo(`unnamed ${n.stage}-shader`)}function Jg(n,e="unnamed"){const i=/#define[\s*]SHADER_NAME[\s*]([A-Za-z0-9_-]+)[\s*]/.exec(n);return i?i[1]:e}const $i=class $i extends se{get[Symbol.toStringTag](){return"Sampler"}constructor(e,t){t=$i.normalizeProps(e,t),super(e,t,$i.defaultProps)}static normalizeProps(e,t){var s,o;const i=((o=(s=e==null?void 0:e.props)==null?void 0:s._resourceDefaults)==null?void 0:o.sampler)||{};return{...t,...i}}};m($i,"defaultProps",{...se.defaultProps,type:"color-sampler",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge",addressModeW:"clamp-to-edge",magFilter:"nearest",minFilter:"nearest",mipmapFilter:"none",lodMinClamp:0,lodMaxClamp:32,compare:"less-equal",maxAnisotropy:1});let Rs=$i;const to=class to extends se{constructor(t,i={}){super(t,i,to.defaultProps);m(this,"width");m(this,"height");this.width=this.props.width,this.height=this.props.height}get[Symbol.toStringTag](){return"Framebuffer"}clone(t){const i=this.colorAttachments.map(s=>s.texture.clone(t)),r=this.depthStencilAttachment&&this.depthStencilAttachment.texture.clone(t);return this.device.createFramebuffer({...this.props,colorAttachments:i,depthStencilAttachment:r})}resize(t){let i=!t;if(t){const[r,s]=Array.isArray(t)?t:[t.width,t.height];i=i||s!==this.height||r!==this.width,this.width=r,this.height=s}i&&(L.log(2,`Resizing framebuffer ${this.id} to ${this.width}x${this.height}`)(),this.resizeAttachments(this.width,this.height))}autoCreateAttachmentTextures(){if(this.props.colorAttachments.length===0&&!this.props.depthStencilAttachment)throw new Error("Framebuffer has noattachments");this.colorAttachments=this.props.colorAttachments.map((i,r)=>{if(typeof i=="string"){const s=this.createColorTexture(i,r);return this.attachResource(s),s.view}return i instanceof fe?i.view:i});const t=this.props.depthStencilAttachment;if(t)if(typeof t=="string"){const i=this.createDepthStencilTexture(t);this.attachResource(i),this.depthStencilAttachment=i.view}else t instanceof fe?this.depthStencilAttachment=t.view:this.depthStencilAttachment=t}createColorTexture(t,i){return this.device.createTexture({id:`${this.id}-color-attachment-${i}`,usage:fe.RENDER_ATTACHMENT,format:t,width:this.width,height:this.height,sampler:{magFilter:"linear",minFilter:"linear"}})}createDepthStencilTexture(t){return this.device.createTexture({id:`${this.id}-depth-stencil-attachment`,usage:fe.RENDER_ATTACHMENT,format:t,width:this.width,height:this.height,mipmaps:!1})}resizeAttachments(t,i){for(let r=0;r<this.colorAttachments.length;++r)if(this.colorAttachments[r]){const s=this.colorAttachments[r].texture.clone({width:t,height:i});this.destroyAttachedResource(this.colorAttachments[r]),this.colorAttachments[r]=s.view,this.attachResource(s.view)}if(this.depthStencilAttachment){const r=this.depthStencilAttachment.texture.clone({width:t,height:i});this.destroyAttachedResource(this.depthStencilAttachment),this.depthStencilAttachment=r.view,this.attachResource(r)}this.updateAttachments()}};m(to,"defaultProps",{...se.defaultProps,width:1,height:1,colorAttachments:[],depthStencilAttachment:null});let Ps=to;const no=class no extends se{constructor(t,i){super(t,i,no.defaultProps);m(this,"shaderLayout");m(this,"bufferLayout");m(this,"linkStatus","pending");m(this,"hash","");this.shaderLayout=this.props.shaderLayout,this.bufferLayout=this.props.bufferLayout||[]}get[Symbol.toStringTag](){return"RenderPipeline"}setUniformsWebGL(t){throw new Error("Use uniform blocks")}};m(no,"defaultProps",{...se.defaultProps,vs:null,vertexEntryPoint:"vertexMain",vsConstants:{},fs:null,fragmentEntryPoint:"fragmentMain",fsConstants:{},shaderLayout:null,bufferLayout:[],topology:"triangle-list",parameters:{},bindings:{},uniforms:{}});let Qn=no;const ot=class ot extends se{get[Symbol.toStringTag](){return"RenderPass"}constructor(e,t){t=ot.normalizeProps(e,t),super(e,t,ot.defaultProps)}static normalizeProps(e,t){var s;return{...(s=e.props._resourceDefaults)==null?void 0:s.renderPass,...t}}};m(ot,"defaultClearColor",[0,0,0,1]),m(ot,"defaultClearDepth",1),m(ot,"defaultClearStencil",0),m(ot,"defaultProps",{...se.defaultProps,framebuffer:null,parameters:void 0,clearColor:ot.defaultClearColor,clearColors:void 0,clearDepth:ot.defaultClearDepth,clearStencil:ot.defaultClearStencil,depthReadOnly:!1,stencilReadOnly:!1,discard:!1,occlusionQuerySet:void 0,timestampQuerySet:void 0,beginTimestampIndex:void 0,endTimestampIndex:void 0});let cl=ot;const io=class io extends se{constructor(t,i){super(t,i,io.defaultProps);m(this,"hash","");m(this,"shaderLayout");this.shaderLayout=i.shaderLayout}get[Symbol.toStringTag](){return"ComputePipeline"}};m(io,"defaultProps",{...se.defaultProps,shader:void 0,entryPoint:void 0,constants:{},shaderLayout:void 0});let Ms=io;const ro=class ro extends se{get[Symbol.toStringTag](){return"CommandEncoder"}constructor(e,t){super(e,t,ro.defaultProps)}};m(ro,"defaultProps",{...se.defaultProps,measureExecutionTime:void 0});let ul=ro;const so=class so extends se{get[Symbol.toStringTag](){return"CommandBuffer"}constructor(e,t){super(e,t,so.defaultProps)}};m(so,"defaultProps",{...se.defaultProps});let dl=so;function yC(n){const[e,t]=vC[n],i=e==="i32"||e==="u32",r=e!=="u32",s=xC[e]*t,o=bC(e,t);return{dataType:e,components:t,defaultVertexFormat:o,byteLength:s,integer:i,signed:r}}function bC(n,e){let t;switch(n){case"f32":t="float32";break;case"i32":t="sint32";break;case"u32":t="uint32";break;case"f16":return e<=2?"float16x2":"float16x4"}return e===1?t:`${t}x${e}`}const vC={f32:["f32",1],"vec2<f32>":["f32",2],"vec3<f32>":["f32",3],"vec4<f32>":["f32",4],f16:["f16",1],"vec2<f16>":["f16",2],"vec3<f16>":["f16",3],"vec4<f16>":["f16",4],i32:["i32",1],"vec2<i32>":["i32",2],"vec3<i32>":["i32",3],"vec4<i32>":["i32",4],u32:["u32",1],"vec2<u32>":["u32",2],"vec3<u32>":["u32",3],"vec4<u32>":["u32",4]},xC={f32:4,f16:2,i32:4,u32:4};function em(n){let e;n.endsWith("-webgl")&&(n.replace("-webgl",""),e=!0);const[t,i]=n.split("x"),r=t,s=i?parseInt(i):1,o=Kg(r),a={type:r,components:s,byteLength:o.byteLength*s,integer:o.integer,signed:o.signed,normalized:o.normalized};return e&&(a.webglOnly=!0),a}function tm(n,e){const t={};for(const i of n.attributes){const r=TC(n,e,i.name);r&&(t[i.name]=r)}return t}function wC(n,e,t=16){const i=tm(n,e),r=new Array(t).fill(null);for(const s of Object.values(i))r[s.location]=s;return r}function TC(n,e,t){const i=SC(n,t),r=EC(e,t);if(!i)return null;const s=yC(i.type),o=(r==null?void 0:r.vertexFormat)||s.defaultVertexFormat,a=em(o);return{attributeName:(r==null?void 0:r.attributeName)||i.name,bufferName:(r==null?void 0:r.bufferName)||i.name,location:i.location,shaderType:i.type,shaderDataType:s.dataType,shaderComponents:s.components,vertexFormat:o,bufferDataType:a.type,bufferComponents:a.components,normalized:a.normalized,integer:s.integer,stepMode:(r==null?void 0:r.stepMode)||i.stepMode||"vertex",byteOffset:(r==null?void 0:r.byteOffset)||0,byteStride:(r==null?void 0:r.byteStride)||0}}function SC(n,e){const t=n.attributes.find(i=>i.name===e);return t||L.warn(`shader layout attribute "${e}" not present in shader`),t||null}function EC(n,e){AC(n);let t=CC(n,e);return t||(t=IC(n,e),t)?t:(L.warn(`layout for attribute "${e}" not present in buffer layout`),null)}function AC(n){for(const e of n)(e.attributes&&e.format||!e.attributes&&!e.format)&&L.warn(`BufferLayout ${name} must have either 'attributes' or 'format' field`)}function CC(n,e){for(const t of n)if(t.format&&t.name===e)return{attributeName:t.name,bufferName:e,stepMode:t.stepMode,vertexFormat:t.format,byteOffset:0,byteStride:t.byteStride||0};return null}function IC(n,e){var t;for(const i of n){let r=i.byteStride;if(typeof i.byteStride!="number")for(const o of i.attributes||[]){const a=em(o.format);r+=a.byteLength}const s=(t=i.attributes)==null?void 0:t.find(o=>o.attribute===e);if(s)return{attributeName:s.attribute,bufferName:i.name,stepMode:i.stepMode,vertexFormat:s.format,byteOffset:s.byteOffset,byteStride:r}}return null}const oo=class oo extends se{constructor(t,i){super(t,i,oo.defaultProps);m(this,"maxVertexAttributes");m(this,"attributeInfos");m(this,"indexBuffer",null);m(this,"attributes");this.maxVertexAttributes=t.limits.maxVertexAttributes,this.attributes=new Array(this.maxVertexAttributes).fill(null);const{shaderLayout:r,bufferLayout:s}=i.renderPipeline||{};if(!r||!s)throw new Error("VertexArray");this.attributeInfos=wC(r,s,this.maxVertexAttributes)}get[Symbol.toStringTag](){return"VertexArray"}setConstantWebGL(t,i){this.device.reportError(new Error("constant attributes not supported"))}};m(oo,"defaultProps",{...se.defaultProps,renderPipeline:null});let hl=oo;const ao=class ao extends se{get[Symbol.toStringTag](){return"TransformFeedback"}constructor(e,t){super(e,t,ao.defaultProps)}};m(ao,"defaultProps",{...se.defaultProps,layout:void 0,buffers:{}});let fl=ao;const lo=class lo extends se{get[Symbol.toStringTag](){return"QuerySet"}constructor(e,t){super(e,t,lo.defaultProps)}};m(lo,"defaultProps",{...se.defaultProps,type:void 0,count:void 0});let pl=lo;const RC={f32:{type:"f32",components:1},i32:{type:"i32",components:1},u32:{type:"u32",components:1},"vec2<f32>":{type:"f32",components:2},"vec3<f32>":{type:"f32",components:3},"vec4<f32>":{type:"f32",components:4},"vec2<i32>":{type:"i32",components:2},"vec3<i32>":{type:"i32",components:3},"vec4<i32>":{type:"i32",components:4},"vec2<u32>":{type:"u32",components:2},"vec3<u32>":{type:"u32",components:3},"vec4<u32>":{type:"u32",components:4},"mat2x2<f32>":{type:"f32",components:4},"mat2x3<f32>":{type:"f32",components:6},"mat2x4<f32>":{type:"f32",components:8},"mat3x2<f32>":{type:"f32",components:6},"mat3x3<f32>":{type:"f32",components:9},"mat3x4<f32>":{type:"f32",components:12},"mat4x2<f32>":{type:"f32",components:8},"mat4x3<f32>":{type:"f32",components:12},"mat4x4<f32>":{type:"f32",components:16}};function PC(n){return RC[n]}function MC(n,e){switch(e){case 1:return n;case 2:return n+n%2;default:return n+(4-n%4)%4}}let Ir;function nm(n){return(!Ir||Ir.byteLength<n)&&(Ir=new ArrayBuffer(n)),Ir}function kC(n,e){const t=nm(n.BYTES_PER_ELEMENT*e);return new n(t,0,e)}function OC(n){return ArrayBuffer.isView(n)&&!(n instanceof DataView)}function ks(n){return Array.isArray(n)?n.length===0||typeof n[0]=="number":OC(n)}const Zd=1024;class NC{constructor(e){m(this,"layout",{});m(this,"byteLength");let t=0;for(const[r,s]of Object.entries(e)){const o=PC(s),{type:a,components:l}=o;t=MC(t,l);const c=t;t+=l,this.layout[r]={type:a,size:l,offset:c}}t+=(4-t%4)%4;const i=t*4;this.byteLength=Math.max(i,Zd)}getData(e){const t=Math.max(this.byteLength,Zd),i=nm(t),r={i32:new Int32Array(i),u32:new Uint32Array(i),f32:new Float32Array(i),f16:new Uint16Array(i)};for(const[s,o]of Object.entries(e)){const a=this.layout[s];if(!a){L.warn(`Supplied uniform value ${s} not present in uniform block layout`)();continue}const{type:l,size:c,offset:u}=a,d=r[l];if(c===1){if(typeof o!="number"&&typeof o!="boolean"){L.warn(`Supplied value for single component uniform ${s} is not a number: ${o}`)();continue}d[u]=Number(o)}else{if(!ks(o)){L.warn(`Supplied value for multi component / array uniform ${s} is not a numeric array: ${o}`)();continue}d.set(o,u)}}return new Uint8Array(i)}has(e){return!!this.layout[e]}get(e){return this.layout[e]}}function FC(n,e,t=16){if(n!==e)return!1;const i=n,r=e;if(!ks(i))return!1;if(ks(r)&&i.length===r.length){for(let s=0;s<i.length;++s)if(r[s]!==i[s])return!1}return!0}function DC(n){return ks(n)?n.slice():n}class BC{constructor(e){m(this,"name");m(this,"uniforms",{});m(this,"modifiedUniforms",{});m(this,"modified",!0);m(this,"bindingLayout",{});m(this,"needsRedraw","initialized");var t;if(this.name=(e==null?void 0:e.name)||"unnamed",e!=null&&e.name&&(e!=null&&e.shaderLayout)){const i=(t=e==null?void 0:e.shaderLayout.bindings)==null?void 0:t.find(s=>s.type==="uniform"&&s.name===(e==null?void 0:e.name));if(!i)throw new Error(e==null?void 0:e.name);const r=i;for(const s of r.uniforms||[])this.bindingLayout[s.name]=s}}setUniforms(e){for(const[t,i]of Object.entries(e))this._setUniform(t,i),this.needsRedraw||this.setNeedsRedraw(`${this.name}.${t}=${i}`)}setNeedsRedraw(e){this.needsRedraw=this.needsRedraw||e}getAllUniforms(){return this.modifiedUniforms={},this.needsRedraw=!1,this.uniforms||{}}_setUniform(e,t){FC(this.uniforms[e],t)||(this.uniforms[e]=DC(t),this.modifiedUniforms[e]=!0,this.modified=!0)}}class LC{constructor(e){m(this,"uniformBlocks",new Map);m(this,"uniformBufferLayouts",new Map);m(this,"uniformBuffers",new Map);for(const[t,i]of Object.entries(e)){const r=t,s=new NC(i.uniformTypes||{});this.uniformBufferLayouts.set(r,s);const o=new BC({name:t});o.setUniforms(i.defaultUniforms||{}),this.uniformBlocks.set(r,o)}}destroy(){for(const e of this.uniformBuffers.values())e.destroy()}setUniforms(e){var t;for(const[i,r]of Object.entries(e))(t=this.uniformBlocks.get(i))==null||t.setUniforms(r);this.updateUniformBuffers()}getUniformBufferByteLength(e){var t;return((t=this.uniformBufferLayouts.get(e))==null?void 0:t.byteLength)||0}getUniformBufferData(e){var i,r;const t=((i=this.uniformBlocks.get(e))==null?void 0:i.getAllUniforms())||{};return(r=this.uniformBufferLayouts.get(e))==null?void 0:r.getData(t)}createUniformBuffer(e,t,i){i&&this.setUniforms(i);const r=this.getUniformBufferByteLength(t),s=e.createBuffer({usage:le.UNIFORM|le.COPY_DST,byteLength:r}),o=this.getUniformBufferData(t);return s.write(o),s}getManagedUniformBuffer(e,t){if(!this.uniformBuffers.get(t)){const i=this.getUniformBufferByteLength(t),r=e.createBuffer({usage:le.UNIFORM|le.COPY_DST,byteLength:i});this.uniformBuffers.set(t,r)}return this.uniformBuffers.get(t)}updateUniformBuffers(){let e=!1;for(const t of this.uniformBlocks.keys()){const i=this.updateUniformBuffer(t);e||(e=i)}return e&&L.log(3,`UniformStore.updateUniformBuffers(): ${e}`)(),e}updateUniformBuffer(e){var s;const t=this.uniformBlocks.get(e);let i=this.uniformBuffers.get(e),r=!1;if(i&&(t!=null&&t.needsRedraw)){r||(r=t.needsRedraw);const o=this.getUniformBufferData(e);i=this.uniformBuffers.get(e),i==null||i.write(o);const a=(s=this.uniformBlocks.get(e))==null?void 0:s.getAllUniforms();L.log(4,`Writing to uniform buffer ${String(e)}`,o,a)()}return r}}function im(n){const e=ArrayBuffer.isView(n)?n.constructor:n;switch(e){case Float32Array:return"float32";case Uint16Array:return"uint16";case Uint32Array:return"uint32";case Uint8Array:case Uint8ClampedArray:return"uint8";case Int8Array:return"sint8";case Int16Array:return"sint16";case Int32Array:return"sint32";default:throw new Error(e.constructor.name)}}function rm(n){switch(n){case"float32":return Float32Array;case"uint32":return Uint32Array;case"sint32":return Int32Array;case"uint16":case"unorm16":return Uint16Array;case"sint16":case"snorm16":return Int16Array;case"uint8":case"unorm8":return Uint8Array;case"sint8":case"snorm8":return Int8Array;default:throw new Error(n)}}function UC(n,e,t){if(!e||e>4)throw new Error(`size ${e}`);const i=e;let r=im(n);if(r==="uint8"&&t&&i===1)return"unorm8-webgl";if(r==="uint8"&&t&&i===3)return"unorm8x3-webgl";if(r==="uint8"||r==="sint8"){if(i===1||i===3)throw new Error(`size: ${e}`);return t&&(r=r.replace("int","norm")),`${r}x${i}`}if(r==="uint16"||r==="sint16"){if(i===1||i===3)throw new Error(`size: ${e}`);return t&&(r=r.replace("int","norm")),`${r}x${i}`}return i===1?r:`${r}x${i}`}class Qo{constructor(e){m(this,"bufferLayouts");this.bufferLayouts=e}getBufferLayout(e){return this.bufferLayouts.find(t=>t.name===e)||null}getAttributeNamesForBuffer(e){var t;return e.attributes?(t=e.attributes)==null?void 0:t.map(i=>i.attribute):[e.name]}mergeBufferLayouts(e,t){const i=[...e];for(const r of t){const s=i.findIndex(o=>o.name===r.name);s<0?i.push(r):i[s]=r}return i}getBufferIndex(e){const t=this.bufferLayouts.findIndex(i=>i.name===e);return t===-1&&L.warn(`BufferLayout: Missing buffer for "${e}".`)(),t}}function $C(n,e){const t=Object.fromEntries(n.attributes.map(r=>[r.name,r.location])),i=e.slice();return i.sort((r,s)=>{const o=r.attributes?r.attributes.map(u=>u.attribute):[r.name],a=s.attributes?s.attributes.map(u=>u.attribute):[s.name],l=Math.min(...o.map(u=>t[u])),c=Math.min(...a.map(u=>t[u]));return l-c}),i}class Qe{constructor(e,t){this.name=e,this.attributes=t,this.size=0}get isArray(){return!1}get isStruct(){return!1}get isTemplate(){return!1}get isPointer(){return!1}getTypeName(){return this.name}}class Gd{constructor(e,t,i){this.name=e,this.type=t,this.attributes=i,this.offset=0,this.size=0}get isArray(){return this.type.isArray}get isStruct(){return this.type.isStruct}get isTemplate(){return this.type.isTemplate}get align(){return this.type.isStruct?this.type.align:0}get members(){return this.type.isStruct?this.type.members:null}get format(){return this.type.isArray||this.type.isTemplate?this.type.format:null}get count(){return this.type.isArray?this.type.count:0}get stride(){return this.type.isArray?this.type.stride:this.size}}let jt=class extends Qe{constructor(e,t){super(e,t),this.members=[],this.align=0,this.startLine=-1,this.endLine=-1,this.inUse=!1}get isStruct(){return!0}};class Kt extends Qe{constructor(e,t){super(e,t),this.count=0,this.stride=0}get isArray(){return!0}getTypeName(){return`array<${this.format.getTypeName()}, ${this.count}>`}}class gl extends Qe{constructor(e,t,i){super(e,i),this.format=t}get isPointer(){return!0}getTypeName(){return`&${this.format.getTypeName()}`}}class yn extends Qe{constructor(e,t,i,r){super(e,i),this.format=t,this.access=r}get isTemplate(){return!0}getTypeName(){let e=this.name;if(this.format!==null){if(e==="vec2"||e==="vec3"||e==="vec4"||e==="mat2x2"||e==="mat2x3"||e==="mat2x4"||e==="mat3x2"||e==="mat3x3"||e==="mat3x4"||e==="mat4x2"||e==="mat4x3"||e==="mat4x4"){if(this.format.name==="f32")return e+="f",e;if(this.format.name==="i32")return e+="i",e;if(this.format.name==="u32")return e+="u",e;if(this.format.name==="bool")return e+="b",e;if(this.format.name==="f16")return e+="h",e}e+=`<${this.format.name}>`}else if(e==="vec2"||e==="vec3"||e==="vec4")return e;return e}}var Vt;(n=>{n[n.Uniform=0]="Uniform",n[n.Storage=1]="Storage",n[n.Texture=2]="Texture",n[n.Sampler=3]="Sampler",n[n.StorageTexture=4]="StorageTexture"})(Vt||(Vt={}));class Rr{constructor(e,t,i,r,s,o,a){this.name=e,this.type=t,this.group=i,this.binding=r,this.attributes=s,this.resourceType=o,this.access=a}get isArray(){return this.type.isArray}get isStruct(){return this.type.isStruct}get isTemplate(){return this.type.isTemplate}get size(){return this.type.size}get align(){return this.type.isStruct?this.type.align:0}get members(){return this.type.isStruct?this.type.members:null}get format(){return this.type.isArray||this.type.isTemplate?this.type.format:null}get count(){return this.type.isArray?this.type.count:0}get stride(){return this.type.isArray?this.type.stride:this.size}}class zC{constructor(e,t){this.name=e,this.type=t}}class VC{constructor(e,t,i,r){this.name=e,this.type=t,this.locationType=i,this.location=r,this.interpolation=null}}class Qd{constructor(e,t,i,r){this.name=e,this.type=t,this.locationType=i,this.location=r}}class WC{constructor(e,t,i,r){this.name=e,this.type=t,this.attributes=i,this.id=r}}class HC{constructor(e,t,i){this.name=e,this.type=t,this.attributes=i}}class jC{constructor(e,t=null,i){this.stage=null,this.inputs=[],this.outputs=[],this.arguments=[],this.returnType=null,this.resources=[],this.overrides=[],this.startLine=-1,this.endLine=-1,this.inUse=!1,this.calls=new Set,this.name=e,this.stage=t,this.attributes=i}}class XC{constructor(){this.vertex=[],this.fragment=[],this.compute=[]}}function YC(n){var e=(32768&n)>>15,t=(31744&n)>>10,i=1023&n;return t==0?(e?-1:1)*Math.pow(2,-14)*(i/Math.pow(2,10)):t==31?i?NaN:1/0*(e?-1:1):(e?-1:1)*Math.pow(2,t-15)*(1+i/Math.pow(2,10))}const sm=new Float32Array(1),qC=new Int32Array(sm.buffer),Ne=new Uint16Array(1);function KC(n){sm[0]=n;const e=qC[0],t=e>>31&1;let i=e>>23&255,r=8388607&e;if(i===255)return Ne[0]=t<<15|31744|(r!==0?512:0),Ne[0];if(i===0){if(r===0)return Ne[0]=t<<15,Ne[0];r|=8388608;let s=113;for(;!(8388608&r);)r<<=1,s--;return i=127-s,r&=8388607,i>0?(r=(r>>126-i)+(r>>127-i&1),Ne[0]=t<<15|i<<10|r>>13,Ne[0]):(Ne[0]=t<<15,Ne[0])}return i=i-127+15,i>=31?(Ne[0]=t<<15|31744,Ne[0]):i<=0?i<-10?(Ne[0]=t<<15,Ne[0]):(r=(8388608|r)>>1-i,Ne[0]=t<<15|r>>13,Ne[0]):(r>>=13,Ne[0]=t<<15|i<<10|r,Ne[0])}const Lc=new Uint32Array(1),om=new Float32Array(Lc.buffer,0,1);function Jd(n){const e=112+(n>>6&31)<<23|(63&n)<<17;return Lc[0]=e,om[0]}function ZC(n,e,t,i,r,s,o,a,l){const c=i*(o>>=r)*(s>>=r)+t*o+e*a;switch(l){case"r8unorm":return[G(n,c,"8unorm",1)[0]];case"r8snorm":return[G(n,c,"8snorm",1)[0]];case"r8uint":return[G(n,c,"8uint",1)[0]];case"r8sint":return[G(n,c,"8sint",1)[0]];case"rg8unorm":{const u=G(n,c,"8unorm",2);return[u[0],u[1]]}case"rg8snorm":{const u=G(n,c,"8snorm",2);return[u[0],u[1]]}case"rg8uint":{const u=G(n,c,"8uint",2);return[u[0],u[1]]}case"rg8sint":{const u=G(n,c,"8sint",2);return[u[0],u[1]]}case"rgba8unorm-srgb":case"rgba8unorm":{const u=G(n,c,"8unorm",4);return[u[0],u[1],u[2],u[3]]}case"rgba8snorm":{const u=G(n,c,"8snorm",4);return[u[0],u[1],u[2],u[3]]}case"rgba8uint":{const u=G(n,c,"8uint",4);return[u[0],u[1],u[2],u[3]]}case"rgba8sint":{const u=G(n,c,"8sint",4);return[u[0],u[1],u[2],u[3]]}case"bgra8unorm-srgb":case"bgra8unorm":{const u=G(n,c,"8unorm",4);return[u[2],u[1],u[0],u[3]]}case"r16uint":return[G(n,c,"16uint",1)[0]];case"r16sint":return[G(n,c,"16sint",1)[0]];case"r16float":return[G(n,c,"16float",1)[0]];case"rg16uint":{const u=G(n,c,"16uint",2);return[u[0],u[1]]}case"rg16sint":{const u=G(n,c,"16sint",2);return[u[0],u[1]]}case"rg16float":{const u=G(n,c,"16float",2);return[u[0],u[1]]}case"rgba16uint":{const u=G(n,c,"16uint",4);return[u[0],u[1],u[2],u[3]]}case"rgba16sint":{const u=G(n,c,"16sint",4);return[u[0],u[1],u[2],u[3]]}case"rgba16float":{const u=G(n,c,"16float",4);return[u[0],u[1],u[2],u[3]]}case"r32uint":return[G(n,c,"32uint",1)[0]];case"r32sint":return[G(n,c,"32sint",1)[0]];case"depth16unorm":case"depth24plus":case"depth24plus-stencil8":case"depth32float":case"depth32float-stencil8":case"r32float":return[G(n,c,"32float",1)[0]];case"rg32uint":{const u=G(n,c,"32uint",2);return[u[0],u[1]]}case"rg32sint":{const u=G(n,c,"32sint",2);return[u[0],u[1]]}case"rg32float":{const u=G(n,c,"32float",2);return[u[0],u[1]]}case"rgba32uint":{const u=G(n,c,"32uint",4);return[u[0],u[1],u[2],u[3]]}case"rgba32sint":{const u=G(n,c,"32sint",4);return[u[0],u[1],u[2],u[3]]}case"rgba32float":{const u=G(n,c,"32float",4);return[u[0],u[1],u[2],u[3]]}case"rg11b10ufloat":{const u=new Uint32Array(n.buffer,c,1)[0],d=(4192256&u)>>11,h=(4290772992&u)>>22;return[Jd(2047&u),Jd(d),function(f){const p=112+(f>>5&31)<<23|(31&f)<<18;return Lc[0]=p,om[0]}(h),1]}}return null}function G(n,e,t,i){const r=[0,0,0,0];for(let s=0;s<i;++s)switch(t){case"8unorm":r[s]=n[e]/255,e++;break;case"8snorm":r[s]=n[e]/255*2-1,e++;break;case"8uint":r[s]=n[e],e++;break;case"8sint":r[s]=n[e]-127,e++;break;case"16uint":r[s]=n[e]|n[e+1]<<8,e+=2;break;case"16sint":r[s]=(n[e]|n[e+1]<<8)-32768,e+=2;break;case"16float":r[s]=YC(n[e]|n[e+1]<<8),e+=2;break;case"32uint":case"32sint":r[s]=n[e]|n[e+1]<<8|n[e+2]<<16|n[e+3]<<24,e+=4;break;case"32float":r[s]=new Float32Array(n.buffer,e,1)[0],e+=4}return r}function J(n,e,t,i,r){for(let s=0;s<i;++s)switch(t){case"8unorm":n[e]=255*r[s],e++;break;case"8snorm":n[e]=.5*(r[s]+1)*255,e++;break;case"8uint":n[e]=r[s],e++;break;case"8sint":n[e]=r[s]+127,e++;break;case"16uint":new Uint16Array(n.buffer,e,1)[0]=r[s],e+=2;break;case"16sint":new Int16Array(n.buffer,e,1)[0]=r[s],e+=2;break;case"16float":{const o=KC(r[s]);new Uint16Array(n.buffer,e,1)[0]=o,e+=2;break}case"32uint":new Uint32Array(n.buffer,e,1)[0]=r[s],e+=4;break;case"32sint":new Int32Array(n.buffer,e,1)[0]=r[s],e+=4;break;case"32float":new Float32Array(n.buffer,e,1)[0]=r[s],e+=4}return r}const Jo={r8unorm:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r8snorm:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r8uint:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r8sint:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},rg8unorm:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg8snorm:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg8uint:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg8sint:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rgba8unorm:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},"rgba8unorm-srgb":{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba8snorm:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba8uint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba8sint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},bgra8unorm:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},"bgra8unorm-srgb":{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},r16uint:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r16sint:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r16float:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},rg16uint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg16sint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg16float:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rgba16uint:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba16sint:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba16float:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},r32uint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r32sint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r32float:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},rg32uint:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg32sint:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg32float:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rgba32uint:{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba32sint:{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba32float:{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgb10a2uint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgb10a2unorm:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rg11b10ufloat:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},stencil8:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!1,hasStencil:!0,channels:1},depth16unorm:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!1,channels:1},depth24plus:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!1,depthOnlyFormat:"depth32float",channels:1},"depth24plus-stencil8":{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!0,depthOnlyFormat:"depth32float",channels:1},depth32float:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!1,channels:1},"depth32float-stencil8":{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!0,stencilOnlyFormat:"depth32float",channels:1},rgb9e5ufloat:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},"bc1-rgba-unorm":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc1-rgba-unorm-srgb":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc2-rgba-unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc2-rgba-unorm-srgb":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc3-rgba-unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc3-rgba-unorm-srgb":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc4-r-unorm":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:1},"bc4-r-snorm":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:1},"bc5-rg-unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:2},"bc5-rg-snorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:2},"bc6h-rgb-ufloat":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc6h-rgb-float":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc7-rgba-unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc7-rgba-unorm-srgb":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgb8unorm":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgb8unorm-srgb":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgb8a1unorm":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgb8a1unorm-srgb":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgba8unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgba8unorm-srgb":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"eac-r11unorm":{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!0,channels:1},"eac-r11snorm":{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!0,channels:1},"eac-rg11unorm":{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!0,channels:2},"eac-rg11snorm":{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!0,channels:2},"astc-4x4-unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"astc-4x4-unorm-srgb":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"astc-5x4-unorm":{bytesPerBlock:16,blockWidth:5,blockHeight:4,isCompressed:!0,channels:4},"astc-5x4-unorm-srgb":{bytesPerBlock:16,blockWidth:5,blockHeight:4,isCompressed:!0,channels:4},"astc-5x5-unorm":{bytesPerBlock:16,blockWidth:5,blockHeight:5,isCompressed:!0,channels:4},"astc-5x5-unorm-srgb":{bytesPerBlock:16,blockWidth:5,blockHeight:5,isCompressed:!0,channels:4},"astc-6x5-unorm":{bytesPerBlock:16,blockWidth:6,blockHeight:5,isCompressed:!0,channels:4},"astc-6x5-unorm-srgb":{bytesPerBlock:16,blockWidth:6,blockHeight:5,isCompressed:!0,channels:4},"astc-6x6-unorm":{bytesPerBlock:16,blockWidth:6,blockHeight:6,isCompressed:!0,channels:4},"astc-6x6-unorm-srgb":{bytesPerBlock:16,blockWidth:6,blockHeight:6,isCompressed:!0,channels:4},"astc-8x5-unorm":{bytesPerBlock:16,blockWidth:8,blockHeight:5,isCompressed:!0,channels:4},"astc-8x5-unorm-srgb":{bytesPerBlock:16,blockWidth:8,blockHeight:5,isCompressed:!0,channels:4},"astc-8x6-unorm":{bytesPerBlock:16,blockWidth:8,blockHeight:6,isCompressed:!0,channels:4},"astc-8x6-unorm-srgb":{bytesPerBlock:16,blockWidth:8,blockHeight:6,isCompressed:!0,channels:4},"astc-8x8-unorm":{bytesPerBlock:16,blockWidth:8,blockHeight:8,isCompressed:!0,channels:4},"astc-8x8-unorm-srgb":{bytesPerBlock:16,blockWidth:8,blockHeight:8,isCompressed:!0,channels:4},"astc-10x5-unorm":{bytesPerBlock:16,blockWidth:10,blockHeight:5,isCompressed:!0,channels:4},"astc-10x5-unorm-srgb":{bytesPerBlock:16,blockWidth:10,blockHeight:5,isCompressed:!0,channels:4},"astc-10x6-unorm":{bytesPerBlock:16,blockWidth:10,blockHeight:6,isCompressed:!0,channels:4},"astc-10x6-unorm-srgb":{bytesPerBlock:16,blockWidth:10,blockHeight:6,isCompressed:!0,channels:4},"astc-10x8-unorm":{bytesPerBlock:16,blockWidth:10,blockHeight:8,isCompressed:!0,channels:4},"astc-10x8-unorm-srgb":{bytesPerBlock:16,blockWidth:10,blockHeight:8,isCompressed:!0,channels:4},"astc-10x10-unorm":{bytesPerBlock:16,blockWidth:10,blockHeight:10,isCompressed:!0,channels:4},"astc-10x10-unorm-srgb":{bytesPerBlock:16,blockWidth:10,blockHeight:10,isCompressed:!0,channels:4},"astc-12x10-unorm":{bytesPerBlock:16,blockWidth:12,blockHeight:10,isCompressed:!0,channels:4},"astc-12x10-unorm-srgb":{bytesPerBlock:16,blockWidth:12,blockHeight:10,isCompressed:!0,channels:4},"astc-12x12-unorm":{bytesPerBlock:16,blockWidth:12,blockHeight:12,isCompressed:!0,channels:4},"astc-12x12-unorm-srgb":{bytesPerBlock:16,blockWidth:12,blockHeight:12,isCompressed:!0,channels:4}};class nt{constructor(){this.id=nt._id++,this.line=0}get isAstNode(){return!0}get astNodeType(){return""}search(e){e(this)}searchBlock(e,t){if(e){t(Os.instance);for(const i of e)i instanceof Array?this.searchBlock(i,t):i.search(t);t(Ns.instance)}}constEvaluate(e,t){throw new Error("Cannot evaluate node")}constEvaluateString(e){return this.constEvaluate(e).toString()}}nt._id=0;class Os extends nt{}Os.instance=new Os;class Ns extends nt{}Ns.instance=new Ns;const am=new Set(["all","all","any","select","arrayLength","abs","acos","acosh","asin","asinh","atan","atanh","atan2","ceil","clamp","cos","cosh","countLeadingZeros","countOneBits","countTrailingZeros","cross","degrees","determinant","distance","dot","dot4U8Packed","dot4I8Packed","exp","exp2","extractBits","faceForward","firstLeadingBit","firstTrailingBit","floor","fma","fract","frexp","insertBits","inverseSqrt","ldexp","length","log","log2","max","min","mix","modf","normalize","pow","quantizeToF16","radians","reflect","refract","reverseBits","round","saturate","sign","sin","sinh","smoothStep","sqrt","step","tan","tanh","transpose","trunc","dpdx","dpdxCoarse","dpdxFine","dpdy","dpdyCoarse","dpdyFine","fwidth","fwidthCoarse","fwidthFine","textureDimensions","textureGather","textureGatherCompare","textureLoad","textureNumLayers","textureNumLevels","textureNumSamples","textureSample","textureSampleBias","textureSampleCompare","textureSampleCompareLevel","textureSampleGrad","textureSampleLevel","textureSampleBaseClampToEdge","textureStore","atomicLoad","atomicStore","atomicAdd","atomicSub","atomicMax","atomicMin","atomicAnd","atomicOr","atomicXor","atomicExchange","atomicCompareExchangeWeak","pack4x8snorm","pack4x8unorm","pack4xI8","pack4xU8","pack4x8Clamp","pack4xU8Clamp","pack2x16snorm","pack2x16unorm","pack2x16float","unpack4x8snorm","unpack4x8unorm","unpack4xI8","unpack4xU8","unpack2x16snorm","unpack2x16unorm","unpack2x16float","storageBarrier","textureBarrier","workgroupBarrier","workgroupUniformLoad","subgroupAdd","subgroupExclusiveAdd","subgroupInclusiveAdd","subgroupAll","subgroupAnd","subgroupAny","subgroupBallot","subgroupBroadcast","subgroupBroadcastFirst","subgroupElect","subgroupMax","subgroupMin","subgroupMul","subgroupExclusiveMul","subgroupInclusiveMul","subgroupOr","subgroupShuffle","subgroupShuffleDown","subgroupShuffleUp","subgroupShuffleXor","subgroupXor","quadBroadcast","quadSwapDiagonal","quadSwapX","quadSwapY"]);class ue extends nt{constructor(){super()}}class Yi extends ue{constructor(e,t,i,r,s,o){super(),this.calls=new Set,this.name=e,this.args=t,this.returnType=i,this.body=r,this.startLine=s,this.endLine=o}get astNodeType(){return"function"}search(e){if(this.attributes)for(const t of this.attributes)e(t);e(this);for(const t of this.args)e(t);this.searchBlock(this.body,e)}}class GC extends ue{constructor(e){super(),this.expression=e}get astNodeType(){return"staticAssert"}search(e){this.expression.search(e)}}class lm extends ue{constructor(e,t){super(),this.condition=e,this.body=t}get astNodeType(){return"while"}search(e){this.condition.search(e),this.searchBlock(this.body,e)}}class ml extends ue{constructor(e,t){super(),this.body=e,this.loopId=t}get astNodeType(){return"continuing"}search(e){this.searchBlock(this.body,e)}}class cm extends ue{constructor(e,t,i,r){super(),this.init=e,this.condition=t,this.increment=i,this.body=r}get astNodeType(){return"for"}search(e){var t,i,r;(t=this.init)===null||t===void 0||t.search(e),(i=this.condition)===null||i===void 0||i.search(e),(r=this.increment)===null||r===void 0||r.search(e),this.searchBlock(this.body,e)}}class Pt extends ue{constructor(e,t,i,r,s){super(),this.attributes=null,this.name=e,this.type=t,this.storage=i,this.access=r,this.value=s}get astNodeType(){return"var"}search(e){var t;e(this),(t=this.value)===null||t===void 0||t.search(e)}}class Uc extends ue{constructor(e,t,i){super(),this.attributes=null,this.name=e,this.type=t,this.value=i}get astNodeType(){return"override"}search(e){var t;(t=this.value)===null||t===void 0||t.search(e)}}class Mi extends ue{constructor(e,t,i,r,s){super(),this.attributes=null,this.name=e,this.type=t,this.storage=i,this.access=r,this.value=s}get astNodeType(){return"let"}search(e){var t;e(this),(t=this.value)===null||t===void 0||t.search(e)}}class Yr extends ue{constructor(e,t,i,r,s){super(),this.attributes=null,this.name=e,this.type=t,this.storage=i,this.access=r,this.value=s}get astNodeType(){return"const"}constEvaluate(e,t){return this.value.constEvaluate(e,t)}search(e){var t;e(this),(t=this.value)===null||t===void 0||t.search(e)}}var Ln,vi,P,A;(n=>{n.increment="++",n.decrement="--"})(Ln||(Ln={})),(n=>{n.parse=function(e){const t=e;if(t=="parse")throw new Error("Invalid value for IncrementOperator");return n[t]}})(Ln||(Ln={}));class um extends ue{constructor(e,t){super(),this.operator=e,this.variable=t}get astNodeType(){return"increment"}search(e){this.variable.search(e)}}(n=>{n.assign="=",n.addAssign="+=",n.subtractAssin="-=",n.multiplyAssign="*=",n.divideAssign="/=",n.moduloAssign="%=",n.andAssign="&=",n.orAssign="|=",n.xorAssign="^=",n.shiftLeftAssign="<<=",n.shiftRightAssign=">>="})(vi||(vi={})),(n=>{n.parse=function(e){const t=e;if(t=="parse")throw new Error("Invalid value for AssignOperator");return t}})(vi||(vi={}));class dm extends ue{constructor(e,t,i){super(),this.operator=e,this.variable=t,this.value=i}get astNodeType(){return"assign"}search(e){this.variable.search(e),this.value.search(e)}}class $c extends ue{constructor(e,t){super(),this.name=e,this.args=t}get astNodeType(){return"call"}isBuiltin(){return am.has(this.name)}search(e){for(const t of this.args)t.search(e);e(this)}}class hm extends ue{constructor(e,t){super(),this.body=e,this.continuing=t}get astNodeType(){return"loop"}search(e){var t;this.searchBlock(this.body,e),(t=this.continuing)===null||t===void 0||t.search(e)}}class fm extends ue{constructor(e,t){super(),this.condition=e,this.cases=t}get astNodeType(){return"switch"}search(e){e(this);for(const t of this.cases)t.search(e)}}class pm extends ue{constructor(e,t,i,r){super(),this.condition=e,this.body=t,this.elseif=i,this.else=r}get astNodeType(){return"if"}search(e){this.condition.search(e),this.searchBlock(this.body,e),this.searchBlock(this.elseif,e),this.searchBlock(this.else,e)}}class gm extends ue{constructor(e){super(),this.value=e}get astNodeType(){return"return"}search(e){var t;(t=this.value)===null||t===void 0||t.search(e)}}class QC extends ue{constructor(e){super(),this.name=e}get astNodeType(){return"enable"}}class JC extends ue{constructor(e){super(),this.extensions=e}get astNodeType(){return"requires"}}class mm extends ue{constructor(e,t){super(),this.severity=e,this.rule=t}get astNodeType(){return"diagnostic"}}class zc extends ue{constructor(e,t){super(),this.name=e,this.type=t}get astNodeType(){return"alias"}}class e2 extends ue{constructor(){super()}get astNodeType(){return"discard"}}class _m extends ue{constructor(){super(),this.condition=null,this.loopId=-1}get astNodeType(){return"break"}}class ym extends ue{constructor(){super(),this.loopId=-1}get astNodeType(){return"continue"}}class N extends ue{constructor(e){super(),this.attributes=null,this.name=e}get astNodeType(){return"type"}get isStruct(){return!1}get isArray(){return!1}static maxFormatType(e){let t=e[0];if(t.name==="f32")return t;for(let i=1;i<e.length;++i){const r=N._priority.get(t.name);N._priority.get(e[i].name)<r&&(t=e[i])}return t.name==="x32"?N.i32:t}getTypeName(){return this.name}}N.x32=new N("x32"),N.f32=new N("f32"),N.i32=new N("i32"),N.u32=new N("u32"),N.f16=new N("f16"),N.bool=new N("bool"),N.void=new N("void"),N._priority=new Map([["f32",0],["f16",1],["u32",2],["i32",3],["x32",3]]);class eh extends N{constructor(e){super(e)}}class It extends N{constructor(e,t,i,r){super(e),this.members=t,this.startLine=i,this.endLine=r}get astNodeType(){return"struct"}get isStruct(){return!0}getMemberIndex(e){for(let t=0;t<this.members.length;t++)if(this.members[t].name==e)return t;return-1}search(e){for(const t of this.members)e(t)}}class R extends N{constructor(e,t,i){super(e),this.format=t,this.access=i}get astNodeType(){return"template"}getTypeName(){let e=this.name;if(this.format!==null){if(e==="vec2"||e==="vec3"||e==="vec4"||e==="mat2x2"||e==="mat2x3"||e==="mat2x4"||e==="mat3x2"||e==="mat3x3"||e==="mat3x4"||e==="mat4x2"||e==="mat4x3"||e==="mat4x4"){if(this.format.name==="f32")return e+="f",e;if(this.format.name==="i32")return e+="i",e;if(this.format.name==="u32")return e+="u",e;if(this.format.name==="bool")return e+="b",e;if(this.format.name==="f16")return e+="h",e}e+=`<${this.format.name}>`}else if(e==="vec2"||e==="vec3"||e==="vec4")return e;return e}}R.vec2f=new R("vec2",N.f32,null),R.vec3f=new R("vec3",N.f32,null),R.vec4f=new R("vec4",N.f32,null),R.vec2i=new R("vec2",N.i32,null),R.vec3i=new R("vec3",N.i32,null),R.vec4i=new R("vec4",N.i32,null),R.vec2u=new R("vec2",N.u32,null),R.vec3u=new R("vec3",N.u32,null),R.vec4u=new R("vec4",N.u32,null),R.vec2h=new R("vec2",N.f16,null),R.vec3h=new R("vec3",N.f16,null),R.vec4h=new R("vec4",N.f16,null),R.vec2b=new R("vec2",N.bool,null),R.vec3b=new R("vec3",N.bool,null),R.vec4b=new R("vec4",N.bool,null),R.mat2x2f=new R("mat2x2",N.f32,null),R.mat2x3f=new R("mat2x3",N.f32,null),R.mat2x4f=new R("mat2x4",N.f32,null),R.mat3x2f=new R("mat3x2",N.f32,null),R.mat3x3f=new R("mat3x3",N.f32,null),R.mat3x4f=new R("mat3x4",N.f32,null),R.mat4x2f=new R("mat4x2",N.f32,null),R.mat4x3f=new R("mat4x3",N.f32,null),R.mat4x4f=new R("mat4x4",N.f32,null),R.mat2x2h=new R("mat2x2",N.f16,null),R.mat2x3h=new R("mat2x3",N.f16,null),R.mat2x4h=new R("mat2x4",N.f16,null),R.mat3x2h=new R("mat3x2",N.f16,null),R.mat3x3h=new R("mat3x3",N.f16,null),R.mat3x4h=new R("mat3x4",N.f16,null),R.mat4x2h=new R("mat4x2",N.f16,null),R.mat4x3h=new R("mat4x3",N.f16,null),R.mat4x4h=new R("mat4x4",N.f16,null),R.mat2x2i=new R("mat2x2",N.i32,null),R.mat2x3i=new R("mat2x3",N.i32,null),R.mat2x4i=new R("mat2x4",N.i32,null),R.mat3x2i=new R("mat3x2",N.i32,null),R.mat3x3i=new R("mat3x3",N.i32,null),R.mat3x4i=new R("mat3x4",N.i32,null),R.mat4x2i=new R("mat4x2",N.i32,null),R.mat4x3i=new R("mat4x3",N.i32,null),R.mat4x4i=new R("mat4x4",N.i32,null),R.mat2x2u=new R("mat2x2",N.u32,null),R.mat2x3u=new R("mat2x3",N.u32,null),R.mat2x4u=new R("mat2x4",N.u32,null),R.mat3x2u=new R("mat3x2",N.u32,null),R.mat3x3u=new R("mat3x3",N.u32,null),R.mat3x4u=new R("mat3x4",N.u32,null),R.mat4x2u=new R("mat4x2",N.u32,null),R.mat4x3u=new R("mat4x3",N.u32,null),R.mat4x4u=new R("mat4x4",N.u32,null);class qr extends N{constructor(e,t,i,r){super(e),this.storage=t,this.type=i,this.access=r}get astNodeType(){return"pointer"}}class ki extends N{constructor(e,t,i,r){super(e),this.attributes=t,this.format=i,this.count=r}get astNodeType(){return"array"}get isArray(){return!0}}class xi extends N{constructor(e,t,i){super(e),this.format=t,this.access=i}get astNodeType(){return"sampler"}}class pt extends nt{constructor(){super(),this.postfix=null}}class bn extends pt{constructor(e){super(),this.value=e}get astNodeType(){return"stringExpr"}toString(){return this.value}constEvaluateString(){return this.value}}class yt extends pt{constructor(e,t){super(),this.type=e,this.args=t}get astNodeType(){return"createExpr"}search(e){if(e(this),this.args)for(const t of this.args)t.search(e)}constEvaluate(e,t){return t&&(t[0]=this.type),e.evalExpression(this,e.context)}}class Vc extends pt{constructor(e,t){super(),this.cachedReturnValue=null,this.name=e,this.args=t}get astNodeType(){return"callExpr"}setCachedReturnValue(e){this.cachedReturnValue=e}get isBuiltin(){return am.has(this.name)}constEvaluate(e,t){return e.evalExpression(this,e.context)}search(e){for(const t of this.args)t.search(e);e(this)}}class je extends pt{constructor(e){super(),this.name=e}get astNodeType(){return"varExpr"}search(e){e(this),this.postfix&&this.postfix.search(e)}constEvaluate(e,t){return e.evalExpression(this,e.context)}}class bm extends pt{constructor(e,t){super(),this.name=e,this.initializer=t}get astNodeType(){return"constExpr"}constEvaluate(e,t){if(this.initializer){const i=e.evalExpression(this.initializer,e.context);return i!==null&&this.postfix?i.getSubData(e,this.postfix,e.context):i}return null}search(e){this.initializer.search(e)}}class we extends pt{constructor(e,t){super(),this.value=e,this.type=t}get astNodeType(){return"literalExpr"}constEvaluate(e,t){return t!==void 0&&(t[0]=this.type),this.value}get isScalar(){return this.value instanceof E}get isVector(){return this.value instanceof T||this.value instanceof j}get scalarValue(){return this.value instanceof E?this.value.value:(console.error("Value is not scalar."),0)}get vectorValue(){return this.value instanceof T||this.value instanceof j?this.value.data:(console.error("Value is not a vector or matrix."),new Float32Array(0))}}class vm extends pt{constructor(e,t){super(),this.type=e,this.value=t}get astNodeType(){return"bitcastExpr"}search(e){this.value.search(e)}}class Jn extends pt{constructor(e){super(),this.index=e}search(e){this.index.search(e)}}class xm extends pt{constructor(){super()}}class ye extends xm{constructor(e,t){super(),this.operator=e,this.right=t}get astNodeType(){return"unaryOp"}constEvaluate(e,t){return e.evalExpression(this,e.context)}search(e){this.right.search(e)}}class st extends xm{constructor(e,t,i){super(),this.operator=e,this.left=t,this.right=i}get astNodeType(){return"binaryOp"}_getPromotedType(e,t){return e.name===t.name?e:e.name==="f32"||t.name==="f32"?N.f32:e.name==="u32"||t.name==="u32"?N.u32:N.i32}constEvaluate(e,t){return e.evalExpression(this,e.context)}search(e){this.left.search(e),this.right.search(e)}}class wm extends nt{constructor(e){super(),this.body=e}search(e){e(this),this.searchBlock(this.body,e)}}class Kr extends pt{constructor(){super()}get astNodeType(){return"default"}}class Tm extends wm{constructor(e,t){super(t),this.selectors=e}get astNodeType(){return"case"}search(e){this.searchBlock(this.body,e)}}class Sm extends wm{constructor(e){super(e)}get astNodeType(){return"default"}search(e){this.searchBlock(this.body,e)}}class th extends nt{constructor(e,t,i){super(),this.name=e,this.type=t,this.attributes=i}get astNodeType(){return"argument"}}class t2 extends nt{constructor(e,t){super(),this.condition=e,this.body=t}get astNodeType(){return"elseif"}search(e){this.condition.search(e),this.searchBlock(this.body,e)}}class nh extends nt{constructor(e,t,i){super(),this.name=e,this.type=t,this.attributes=i}get astNodeType(){return"member"}}class Em extends nt{constructor(e,t){super(),this.name=e,this.value=t}get astNodeType(){return"attribute"}}class et{constructor(e,t){this.parent=null,this.typeInfo=e,this.parent=t,this.id=et._id++}clone(){throw`Clone: Not implemented for ${this.constructor.name}`}setDataValue(e,t,i,r){console.error(`SetDataValue: Not implemented for ${this.constructor.name}`)}getSubData(e,t,i){return console.error(`GetDataValue: Not implemented for ${this.constructor.name}`),null}toString(){return`<${this.typeInfo.getTypeName()}>`}}et._id=0;class _l extends et{constructor(){super(new Qe("void",null),null)}toString(){return"void"}}_l.void=new _l;class Mn extends et{constructor(e){super(new gl("pointer",e.typeInfo,null),null),this.reference=e}clone(){return this}setDataValue(e,t,i,r){this.reference.setDataValue(e,t,i,r)}getSubData(e,t,i){return t?this.reference.getSubData(e,t,i):this}toString(){return`&${this.reference.toString()}`}}class E extends et{constructor(e,t,i=null){super(t,i),e instanceof Int32Array||e instanceof Uint32Array||e instanceof Float32Array?this.data=e:this.typeInfo.name==="x32"?e-Math.floor(e)!==0?this.data=new Float32Array([e]):this.data=e>=0?new Uint32Array([e]):new Int32Array([e]):this.typeInfo.name==="i32"||this.typeInfo.name==="bool"?this.data=new Int32Array([e]):this.typeInfo.name==="u32"?this.data=new Uint32Array([e]):this.typeInfo.name==="f32"||this.typeInfo.name==="f16"?this.data=new Float32Array([e]):console.error("ScalarData2: Invalid type",t)}clone(){if(this.data instanceof Float32Array)return new E(new Float32Array(this.data),this.typeInfo,null);if(this.data instanceof Int32Array)return new E(new Int32Array(this.data),this.typeInfo,null);if(this.data instanceof Uint32Array)return new E(new Uint32Array(this.data),this.typeInfo,null);throw"ScalarData: Invalid data type"}get value(){return this.data[0]}set value(e){this.data[0]=e}setDataValue(e,t,i,r){if(i)return void console.error("SetDataValue: Scalar data does not support postfix",i);if(!(t instanceof E))return void console.error("SetDataValue: Invalid value",t);let s=t.data[0];this.typeInfo.name==="i32"||this.typeInfo.name==="u32"?s=Math.floor(s):this.typeInfo.name==="bool"&&(s=s?1:0),this.data[0]=s}getSubData(e,t,i){return t?(console.error("getSubData: Scalar data does not support postfix",t),null):this}toString(){return`${this.value}`}}function n2(n,e,t){const i=e.length;return i===2?t==="f32"?new T(new Float32Array(e),n.getTypeInfo("vec2f")):t==="i32"||t==="bool"?new T(new Int32Array(e),n.getTypeInfo("vec2i")):t==="u32"?new T(new Uint32Array(e),n.getTypeInfo("vec2u")):t==="f16"?new T(new Float32Array(e),n.getTypeInfo("vec2h")):(console.error(`getSubData: Unknown format ${t}`),null):i===3?t==="f32"?new T(new Float32Array(e),n.getTypeInfo("vec3f")):t==="i32"||t==="bool"?new T(new Int32Array(e),n.getTypeInfo("vec3i")):t==="u32"?new T(new Uint32Array(e),n.getTypeInfo("vec3u")):t==="f16"?new T(new Float32Array(e),n.getTypeInfo("vec3h")):(console.error(`getSubData: Unknown format ${t}`),null):i===4?t==="f32"?new T(new Float32Array(e),n.getTypeInfo("vec4f")):t==="i32"||t==="bool"?new T(new Int32Array(e),n.getTypeInfo("vec4i")):t==="u32"?new T(new Uint32Array(e),n.getTypeInfo("vec4u")):t==="f16"?new T(new Float32Array(e),n.getTypeInfo("vec4h")):(console.error(`getSubData: Unknown format ${t}`),null):(console.error(`getSubData: Invalid vector size ${e.length}`),null)}class T extends et{constructor(e,t,i=null){if(super(t,i),e instanceof Float32Array||e instanceof Uint32Array||e instanceof Int32Array)this.data=e;else{const r=this.typeInfo.name;r==="vec2f"||r==="vec3f"||r==="vec4f"?this.data=new Float32Array(e):r==="vec2i"||r==="vec3i"||r==="vec4i"?this.data=new Int32Array(e):r==="vec2u"||r==="vec3u"||r==="vec4u"?this.data=new Uint32Array(e):r==="vec2h"||r==="vec3h"||r==="vec4h"?this.data=new Float32Array(e):r==="vec2b"||r==="vec3b"||r==="vec4b"?this.data=new Int32Array(e):r==="vec2"||r==="vec3"||r==="vec4"?this.data=new Float32Array(e):console.error(`VectorData: Invalid type ${r}`)}}clone(){if(this.data instanceof Float32Array)return new T(new Float32Array(this.data),this.typeInfo,null);if(this.data instanceof Int32Array)return new T(new Int32Array(this.data),this.typeInfo,null);if(this.data instanceof Uint32Array)return new T(new Uint32Array(this.data),this.typeInfo,null);throw"VectorData: Invalid data type"}setDataValue(e,t,i,r){i instanceof bn?console.error("TODO: Set vector postfix"):t instanceof T?this.data=t.data:console.error("SetDataValue: Invalid value",t)}getSubData(e,t,i){if(t===null)return this;let r=e.getTypeInfo("f32");if(this.typeInfo instanceof yn)r=this.typeInfo.format||r;else{const o=this.typeInfo.name;o==="vec2f"||o==="vec3f"||o==="vec4f"?r=e.getTypeInfo("f32"):o==="vec2i"||o==="vec3i"||o==="vec4i"?r=e.getTypeInfo("i32"):o==="vec2b"||o==="vec3b"||o==="vec4b"?r=e.getTypeInfo("bool"):o==="vec2u"||o==="vec3u"||o==="vec4u"?r=e.getTypeInfo("u32"):o==="vec2h"||o==="vec3h"||o==="vec4h"?r=e.getTypeInfo("f16"):console.error(`GetSubData: Unknown type ${o}`)}let s=this;for(;t!==null&&s!==null;){if(t instanceof Jn){const o=t.index;let a=-1;if(o instanceof we){if(!(o.value instanceof E))return console.error(`GetSubData: Invalid array index ${o.value}`),null;a=o.value.value}else{const l=e.evalExpression(o,i);if(!(l instanceof E))return console.error("GetSubData: Unknown index type",o),null;a=l.value}if(a<0||a>=s.data.length)return console.error("GetSubData: Index out of range",a),null;if(s.data instanceof Float32Array){const l=new Float32Array(s.data.buffer,s.data.byteOffset+4*a,1);return new E(l,r)}if(s.data instanceof Int32Array){const l=new Int32Array(s.data.buffer,s.data.byteOffset+4*a,1);return new E(l,r)}if(s.data instanceof Uint32Array){const l=new Uint32Array(s.data.buffer,s.data.byteOffset+4*a,1);return new E(l,r)}throw"GetSubData: Invalid data type"}if(!(t instanceof bn))return console.error("GetSubData: Unknown postfix",t),null;{const o=t.value.toLowerCase();if(o.length===1){let l=0;if(o==="x"||o==="r")l=0;else if(o==="y"||o==="g")l=1;else if(o==="z"||o==="b")l=2;else{if(o!=="w"&&o!=="a")return console.error(`GetSubData: Unknown member ${o}`),null;l=3}if(this.data instanceof Float32Array){let c=new Float32Array(this.data.buffer,this.data.byteOffset+4*l,1);return new E(c,r,this)}if(this.data instanceof Int32Array){let c=new Int32Array(this.data.buffer,this.data.byteOffset+4*l,1);return new E(c,r,this)}if(this.data instanceof Uint32Array){let c=new Uint32Array(this.data.buffer,this.data.byteOffset+4*l,1);return new E(c,r,this)}}const a=[];for(const l of o)l==="x"||l==="r"?a.push(this.data[0]):l==="y"||l==="g"?a.push(this.data[1]):l==="z"||l==="b"?a.push(this.data[2]):l==="w"||l==="a"?a.push(this.data[3]):console.error(`GetDataValue: Unknown member ${l}`);s=n2(e,a,r.name)}t=t.postfix}return s}toString(){let e=`${this.data[0]}`;for(let t=1;t<this.data.length;++t)e+=`, ${this.data[t]}`;return e}}class j extends et{constructor(e,t,i=null){super(t,i),e instanceof Float32Array?this.data=e:this.data=new Float32Array(e)}clone(){return new j(new Float32Array(this.data),this.typeInfo,null)}setDataValue(e,t,i,r){i instanceof bn?console.error("TODO: Set matrix postfix"):t instanceof j?this.data=t.data:console.error("SetDataValue: Invalid value",t)}getSubData(e,t,i){if(t===null)return this;const r=this.typeInfo.name;if(e.getTypeInfo("f32"),this.typeInfo instanceof yn)this.typeInfo.format;else if(r.endsWith("f"))e.getTypeInfo("f32");else if(r.endsWith("i"))e.getTypeInfo("i32");else if(r.endsWith("u"))e.getTypeInfo("u32");else{if(!r.endsWith("h"))return console.error(`GetDataValue: Unknown type ${r}`),null;e.getTypeInfo("f16")}if(t instanceof Jn){const s=t.index;let o=-1;if(s instanceof we){if(!(s.value instanceof E))return console.error(`GetDataValue: Invalid array index ${s.value}`),null;o=s.value.value}else{const c=e.evalExpression(s,i);if(!(c instanceof E))return console.error("GetDataValue: Unknown index type",s),null;o=c.value}if(o<0||o>=this.data.length)return console.error("GetDataValue: Index out of range",o),null;const a=r.endsWith("h")?"h":"f";let l;if(r==="mat2x2"||r==="mat2x2f"||r==="mat2x2h"||r==="mat3x2"||r==="mat3x2f"||r==="mat3x2h"||r==="mat4x2"||r==="mat4x2f"||r==="mat4x2h")l=new T(new Float32Array(this.data.buffer,this.data.byteOffset+2*o*4,2),e.getTypeInfo(`vec2${a}`));else if(r==="mat2x3"||r==="mat2x3f"||r==="mat2x3h"||r==="mat3x3"||r==="mat3x3f"||r==="mat3x3h"||r==="mat4x3"||r==="mat4x3f"||r==="mat4x3h")l=new T(new Float32Array(this.data.buffer,this.data.byteOffset+3*o*4,3),e.getTypeInfo(`vec3${a}`));else{if(r!=="mat2x4"&&r!=="mat2x4f"&&r!=="mat2x4h"&&r!=="mat3x4"&&r!=="mat3x4f"&&r!=="mat3x4h"&&r!=="mat4x4"&&r!=="mat4x4f"&&r!=="mat4x4h")return console.error(`GetDataValue: Unknown type ${r}`),null;l=new T(new Float32Array(this.data.buffer,this.data.byteOffset+4*o*4,4),e.getTypeInfo(`vec4${a}`))}return t.postfix?l.getSubData(e,t.postfix,i):l}return console.error("GetDataValue: Invalid postfix",t),null}toString(){let e=`${this.data[0]}`;for(let t=1;t<this.data.length;++t)e+=`, ${this.data[t]}`;return e}}class pe extends et{constructor(e,t,i=0,r=null){super(t,r),this.buffer=e instanceof ArrayBuffer?e:e.buffer,this.offset=i}clone(){const e=new Uint8Array(new Uint8Array(this.buffer,this.offset,this.typeInfo.size));return new pe(e.buffer,this.typeInfo,0,null)}setDataValue(e,t,i,r){if(t===null)return void console.log("setDataValue: NULL data.");let s=this.offset,o=this.typeInfo;for(;i;){if(i instanceof Jn)if(o instanceof Kt){const a=i.index;if(a instanceof we){if(!(a.value instanceof E))return void console.error(`SetDataValue: Invalid index type ${a.value}`);s+=a.value.value*o.stride}else{const l=e.evalExpression(a,r);if(!(l instanceof E))return void console.error("SetDataValue: Unknown index type",a);s+=l.value*o.stride}o=o.format}else console.error(`SetDataValue: Type ${o.getTypeName()} is not an array`);else{if(!(i instanceof bn))return void console.error("SetDataValue: Unknown postfix type",i);{const a=i.value;if(o instanceof jt){let l=!1;for(const c of o.members)if(c.name===a){s+=c.offset,o=c.type,l=!0;break}if(!l)return void console.error(`SetDataValue: Member ${a} not found`)}else if(o instanceof Qe){const l=o.getTypeName();let c=0;if(a==="x"||a==="r")c=0;else if(a==="y"||a==="g")c=1;else if(a==="z"||a==="b")c=2;else{if(a!=="w"&&a!=="a")return void console.error(`SetDataValue: Unknown member ${a}`);c=3}if(!(t instanceof E))return void console.error("SetDataValue: Invalid value",t);const u=t.value;return l==="vec2f"?void(new Float32Array(this.buffer,s,2)[c]=u):l==="vec3f"?void(new Float32Array(this.buffer,s,3)[c]=u):l==="vec4f"?void(new Float32Array(this.buffer,s,4)[c]=u):l==="vec2i"?void(new Int32Array(this.buffer,s,2)[c]=u):l==="vec3i"?void(new Int32Array(this.buffer,s,3)[c]=u):l==="vec4i"?void(new Int32Array(this.buffer,s,4)[c]=u):l==="vec2u"?void(new Uint32Array(this.buffer,s,2)[c]=u):l==="vec3u"?void(new Uint32Array(this.buffer,s,3)[c]=u):l==="vec4u"?void(new Uint32Array(this.buffer,s,4)[c]=u):void console.error(`SetDataValue: Type ${l} is not a struct`)}}}i=i.postfix}this.setData(e,t,o,s,r)}setData(e,t,i,r,s){const o=i.getTypeName();if(o!=="f32"&&o!=="f16")if(o!=="i32"&&o!=="atomic<i32>"&&o!=="x32")if(o!=="u32"&&o!=="atomic<u32>")if(o!=="bool"){if(o==="vec2f"||o==="vec2h"){const a=new Float32Array(this.buffer,r,2);return void(t instanceof T?(a[0]=t.data[0],a[1]=t.data[1]):(a[0]=t[0],a[1]=t[1]))}if(o==="vec3f"||o==="vec3h"){const a=new Float32Array(this.buffer,r,3);return void(t instanceof T?(a[0]=t.data[0],a[1]=t.data[1],a[2]=t.data[2]):(a[0]=t[0],a[1]=t[1],a[2]=t[2]))}if(o==="vec4f"||o==="vec4h"){const a=new Float32Array(this.buffer,r,4);return void(t instanceof T?(a[0]=t.data[0],a[1]=t.data[1],a[2]=t.data[2],a[3]=t.data[3]):(a[0]=t[0],a[1]=t[1],a[2]=t[2],a[3]=t[3]))}if(o==="vec2i"){const a=new Int32Array(this.buffer,r,2);return void(t instanceof T?(a[0]=t.data[0],a[1]=t.data[1]):(a[0]=t[0],a[1]=t[1]))}if(o==="vec3i"){const a=new Int32Array(this.buffer,r,3);return void(t instanceof T?(a[0]=t.data[0],a[1]=t.data[1],a[2]=t.data[2]):(a[0]=t[0],a[1]=t[1],a[2]=t[2]))}if(o==="vec4i"){const a=new Int32Array(this.buffer,r,4);return void(t instanceof T?(a[0]=t.data[0],a[1]=t.data[1],a[2]=t.data[2],a[3]=t.data[3]):(a[0]=t[0],a[1]=t[1],a[2]=t[2],a[3]=t[3]))}if(o==="vec2u"){const a=new Uint32Array(this.buffer,r,2);return void(t instanceof T?(a[0]=t.data[0],a[1]=t.data[1]):(a[0]=t[0],a[1]=t[1]))}if(o==="vec3u"){const a=new Uint32Array(this.buffer,r,3);return void(t instanceof T?(a[0]=t.data[0],a[1]=t.data[1],a[2]=t.data[2]):(a[0]=t[0],a[1]=t[1],a[2]=t[2]))}if(o==="vec4u"){const a=new Uint32Array(this.buffer,r,4);return void(t instanceof T?(a[0]=t.data[0],a[1]=t.data[1],a[2]=t.data[2],a[3]=t.data[3]):(a[0]=t[0],a[1]=t[1],a[2]=t[2],a[3]=t[3]))}if(o==="vec2b"){const a=new Uint32Array(this.buffer,r,2);return void(t instanceof T?(a[0]=t.data[0],a[1]=t.data[1]):(a[0]=t[0],a[1]=t[1]))}if(o==="vec3b"){const a=new Uint32Array(this.buffer,r,3);return void(t instanceof T?(a[0]=t.data[0],a[1]=t.data[1],a[2]=t.data[2]):(a[0]=t[0],a[1]=t[1],a[2]=t[2]))}if(o==="vec4b"){const a=new Uint32Array(this.buffer,r,4);return void(t instanceof T?(a[0]=t.data[0],a[1]=t.data[1],a[2]=t.data[2],a[3]=t.data[3]):(a[0]=t[0],a[1]=t[1],a[2]=t[2],a[3]=t[3]))}if(o==="mat2x2f"||o==="mat2x2h"){const a=new Float32Array(this.buffer,r,4);return void(t instanceof j?(a[0]=t.data[0],a[1]=t.data[1],a[2]=t.data[2],a[3]=t.data[3]):(a[0]=t[0],a[1]=t[1],a[2]=t[2],a[3]=t[3]))}if(o==="mat2x3f"||o==="mat2x3h"){const a=new Float32Array(this.buffer,r,6);return void(t instanceof j?(a[0]=t.data[0],a[1]=t.data[1],a[2]=t.data[2],a[3]=t.data[3],a[4]=t.data[4],a[5]=t.data[5]):(a[0]=t[0],a[1]=t[1],a[2]=t[2],a[3]=t[3],a[4]=t[4],a[5]=t[5]))}if(o==="mat2x4f"||o==="mat2x4h"){const a=new Float32Array(this.buffer,r,8);return void(t instanceof j?(a[0]=t.data[0],a[1]=t.data[1],a[2]=t.data[2],a[3]=t.data[3],a[4]=t.data[4],a[5]=t.data[5],a[6]=t.data[6],a[7]=t.data[7]):(a[0]=t[0],a[1]=t[1],a[2]=t[2],a[3]=t[3],a[4]=t[4],a[5]=t[5],a[6]=t[6],a[7]=t[7]))}if(o==="mat3x2f"||o==="mat3x2h"){const a=new Float32Array(this.buffer,r,6);return void(t instanceof j?(a[0]=t.data[0],a[1]=t.data[1],a[2]=t.data[2],a[3]=t.data[3],a[4]=t.data[4],a[5]=t.data[5]):(a[0]=t[0],a[1]=t[1],a[2]=t[2],a[3]=t[3],a[4]=t[4],a[5]=t[5]))}if(o==="mat3x3f"||o==="mat3x3h"){const a=new Float32Array(this.buffer,r,9);return void(t instanceof j?(a[0]=t.data[0],a[1]=t.data[1],a[2]=t.data[2],a[3]=t.data[3],a[4]=t.data[4],a[5]=t.data[5],a[6]=t.data[6],a[7]=t.data[7],a[8]=t.data[8]):(a[0]=t[0],a[1]=t[1],a[2]=t[2],a[3]=t[3],a[4]=t[4],a[5]=t[5],a[6]=t[6],a[7]=t[7],a[8]=t[8]))}if(o==="mat3x4f"||o==="mat3x4h"){const a=new Float32Array(this.buffer,r,12);return void(t instanceof j?(a[0]=t.data[0],a[1]=t.data[1],a[2]=t.data[2],a[3]=t.data[3],a[4]=t.data[4],a[5]=t.data[5],a[6]=t.data[6],a[7]=t.data[7],a[8]=t.data[8],a[9]=t.data[9],a[10]=t.data[10],a[11]=t.data[11]):(a[0]=t[0],a[1]=t[1],a[2]=t[2],a[3]=t[3],a[4]=t[4],a[5]=t[5],a[6]=t[6],a[7]=t[7],a[8]=t[8],a[9]=t[9],a[10]=t[10],a[11]=t[11]))}if(o==="mat4x2f"||o==="mat4x2h"){const a=new Float32Array(this.buffer,r,8);return void(t instanceof j?(a[0]=t.data[0],a[1]=t.data[1],a[2]=t.data[2],a[3]=t.data[3],a[4]=t.data[4],a[5]=t.data[5],a[6]=t.data[6],a[7]=t.data[7]):(a[0]=t[0],a[1]=t[1],a[2]=t[2],a[3]=t[3],a[4]=t[4],a[5]=t[5],a[6]=t[6],a[7]=t[7]))}if(o==="mat4x3f"||o==="mat4x3h"){const a=new Float32Array(this.buffer,r,12);return void(t instanceof j?(a[0]=t.data[0],a[1]=t.data[1],a[2]=t.data[2],a[3]=t.data[3],a[4]=t.data[4],a[5]=t.data[5],a[6]=t.data[6],a[7]=t.data[7],a[8]=t.data[8],a[9]=t.data[9],a[10]=t.data[10],a[11]=t.data[11]):(a[0]=t[0],a[1]=t[1],a[2]=t[2],a[3]=t[3],a[4]=t[4],a[5]=t[5],a[6]=t[6],a[7]=t[7],a[8]=t[8],a[9]=t[9],a[10]=t[10],a[11]=t[11]))}if(o==="mat4x4f"||o==="mat4x4h"){const a=new Float32Array(this.buffer,r,16);return void(t instanceof j?(a[0]=t.data[0],a[1]=t.data[1],a[2]=t.data[2],a[3]=t.data[3],a[4]=t.data[4],a[5]=t.data[5],a[6]=t.data[6],a[7]=t.data[7],a[8]=t.data[8],a[9]=t.data[9],a[10]=t.data[10],a[11]=t.data[11],a[12]=t.data[12],a[13]=t.data[13],a[14]=t.data[14],a[15]=t.data[15]):(a[0]=t[0],a[1]=t[1],a[2]=t[2],a[3]=t[3],a[4]=t[4],a[5]=t[5],a[6]=t[6],a[7]=t[7],a[8]=t[8],a[9]=t[9],a[10]=t[10],a[11]=t[11],a[12]=t[12],a[13]=t[13],a[14]=t[14],a[15]=t[15]))}if(t instanceof pe){if(i===t.typeInfo)return void new Uint8Array(this.buffer,r,t.buffer.byteLength).set(new Uint8Array(t.buffer));console.error("SetDataValue: Type mismatch",o,t.typeInfo.getTypeName())}else console.error(`SetData: Unknown type ${o}`)}else t instanceof E&&(new Int32Array(this.buffer,r,1)[0]=t.value);else t instanceof E&&(new Uint32Array(this.buffer,r,1)[0]=t.value);else t instanceof E&&(new Int32Array(this.buffer,r,1)[0]=t.value);else t instanceof E&&(new Float32Array(this.buffer,r,1)[0]=t.value)}getSubData(e,t,i){var r,s,o;if(t===null)return this;let a=this.offset,l=this.typeInfo;for(;t;){if(t instanceof Jn){const u=t.index,d=u instanceof pt?e.evalExpression(u,i):u;let h=0;if(d instanceof E?h=d.value:typeof d=="number"?h=d:console.error("GetDataValue: Invalid index type",u),l instanceof Kt)a+=h*l.stride,l=l.format;else{const f=l.getTypeName();f==="mat4x4"||f==="mat4x4f"||f==="mat4x4h"?(a+=16*h,l=e.getTypeInfo("vec4f")):console.error(`getDataValue: Type ${l.getTypeName()} is not an array`)}}else{if(!(t instanceof bn))return console.error("GetDataValue: Unknown postfix type",t),null;{const u=t.value;if(l instanceof jt){let d=!1;for(const h of l.members)if(h.name===u){a+=h.offset,l=h.type,d=!0;break}if(!d)return console.error(`GetDataValue: Member ${u} not found`),null}else if(l instanceof Qe){const d=l.getTypeName();if(d==="vec2f"||d==="vec3f"||d==="vec4f"||d==="vec2i"||d==="vec3i"||d==="vec4i"||d==="vec2u"||d==="vec3u"||d==="vec4u"||d==="vec2b"||d==="vec3b"||d==="vec4b"||d==="vec2h"||d==="vec3h"||d==="vec4h"||d==="vec2"||d==="vec3"||d==="vec4"){if(u.length>0&&u.length<5){let h="f";const f=[];for(let p=0;p<u.length;++p){const g=u[p].toLowerCase();let _=0;if(g==="x"||g==="r")_=0;else if(g==="y"||g==="g")_=1;else if(g==="z"||g==="b")_=2;else{if(g!=="w"&&g!=="a")return console.error(`Unknown member ${u}`),null;_=3}if(u.length===1){if(d.endsWith("f"))return this.buffer.byteLength<a+4*_+4?(console.log("Insufficient buffer data"),null):new E(new Float32Array(this.buffer,a+4*_,1),e.getTypeInfo("f32"),this);if(d.endsWith("h"))return new E(new Float32Array(this.buffer,a+4*_,1),e.getTypeInfo("f16"),this);if(d.endsWith("i"))return new E(new Int32Array(this.buffer,a+4*_,1),e.getTypeInfo("i32"),this);if(d.endsWith("b"))return new E(new Int32Array(this.buffer,a+4*_,1),e.getTypeInfo("bool"),this);if(d.endsWith("u"))return new E(new Uint32Array(this.buffer,a+4*_,1),e.getTypeInfo("i32"),this)}if(d==="vec2f")f.push(new Float32Array(this.buffer,a,2)[_]);else if(d==="vec3f"){if(a+12>=this.buffer.byteLength)return console.log("Insufficient buffer data"),null;const b=new Float32Array(this.buffer,a,3);f.push(b[_])}else if(d==="vec4f")f.push(new Float32Array(this.buffer,a,4)[_]);else if(d==="vec2i")h="i",f.push(new Int32Array(this.buffer,a,2)[_]);else if(d==="vec3i")h="i",f.push(new Int32Array(this.buffer,a,3)[_]);else if(d==="vec4i")h="i",f.push(new Int32Array(this.buffer,a,4)[_]);else if(d==="vec2u"){h="u";const b=new Uint32Array(this.buffer,a,2);f.push(b[_])}else d==="vec3u"?(h="u",f.push(new Uint32Array(this.buffer,a,3)[_])):d==="vec4u"&&(h="u",f.push(new Uint32Array(this.buffer,a,4)[_]))}return f.length===2?l=e.getTypeInfo(`vec2${h}`):f.length===3?l=e.getTypeInfo(`vec3${h}`):f.length===4?l=e.getTypeInfo(`vec4${h}`):console.error(`GetDataValue: Invalid vector length ${f.length}`),new T(f,l,null)}return console.error(`GetDataValue: Unknown member ${u}`),null}return console.error(`GetDataValue: Type ${d} is not a struct`),null}}}t=t.postfix}const c=l.getTypeName();return c==="f32"?new E(new Float32Array(this.buffer,a,1),l,this):c==="i32"?new E(new Int32Array(this.buffer,a,1),l,this):c==="u32"?new E(new Uint32Array(this.buffer,a,1),l,this):c==="vec2f"?new T(new Float32Array(this.buffer,a,2),l,this):c==="vec3f"?new T(new Float32Array(this.buffer,a,3),l,this):c==="vec4f"?new T(new Float32Array(this.buffer,a,4),l,this):c==="vec2i"?new T(new Int32Array(this.buffer,a,2),l,this):c==="vec3i"?new T(new Int32Array(this.buffer,a,3),l,this):c==="vec4i"?new T(new Int32Array(this.buffer,a,4),l,this):c==="vec2u"?new T(new Uint32Array(this.buffer,a,2),l,this):c==="vec3u"?new T(new Uint32Array(this.buffer,a,3),l,this):c==="vec4u"?new T(new Uint32Array(this.buffer,a,4),l,this):l instanceof yn&&l.name==="atomic"?((r=l.format)===null||r===void 0?void 0:r.name)==="u32"?new E(new Uint32Array(this.buffer,a,1)[0],l.format,this):((s=l.format)===null||s===void 0?void 0:s.name)==="i32"?new E(new Int32Array(this.buffer,a,1)[0],l.format,this):(console.error(`GetDataValue: Invalid atomic format ${(o=l.format)===null||o===void 0?void 0:o.name}`),null):new pe(this.buffer,l,a,this)}toString(){let e="";if(this.typeInfo instanceof Kt)if(this.typeInfo.format.name==="f32"){const t=new Float32Array(this.buffer,this.offset);e=`[${t[0]}`;for(let i=1;i<t.length;++i)e+=`, ${t[i]}`}else if(this.typeInfo.format.name==="i32"){const t=new Int32Array(this.buffer,this.offset);e=`[${t[0]}`;for(let i=1;i<t.length;++i)e+=`, ${t[i]}`}else if(this.typeInfo.format.name==="u32"){const t=new Uint32Array(this.buffer,this.offset);e=`[${t[0]}`;for(let i=1;i<t.length;++i)e+=`, ${t[i]}`}else if(this.typeInfo.format.name==="vec2f"){const t=new Float32Array(this.buffer,this.offset);e=`[${t[0]}, ${t[1]}]`;for(let i=1;i<t.length/2;++i)e+=`, [${t[2*i]}, ${t[2*i+1]}]`}else if(this.typeInfo.format.name==="vec3f"){const t=new Float32Array(this.buffer,this.offset);e=`[${t[0]}, ${t[1]}, ${t[2]}]`;for(let i=4;i<t.length;i+=4)e+=`, [${t[i]}, ${t[i+1]}, ${t[i+2]}]`}else if(this.typeInfo.format.name==="vec4f"){const t=new Float32Array(this.buffer,this.offset);e=`[${t[0]}, ${t[1]}, ${t[2]}, ${t[3]}]`;for(let i=4;i<t.length;i+=4)e+=`, [${t[i]}, ${t[i+1]}, ${t[i+2]}, ${t[i+3]}]`}else e="[...]";else this.typeInfo instanceof jt?e+="{...}":e="[...]";return e}}class Rt extends et{constructor(e,t,i,r){super(t,null),this.data=e,this.descriptor=i,this.view=r}clone(){return new Rt(this.data,this.typeInfo,this.descriptor,this.view)}get width(){var e,t;const i=this.descriptor.size;return i instanceof Array&&i.length>0?(e=i[0])!==null&&e!==void 0?e:0:i instanceof Object&&(t=i.width)!==null&&t!==void 0?t:0}get height(){var e,t;const i=this.descriptor.size;return i instanceof Array&&i.length>1?(e=i[1])!==null&&e!==void 0?e:0:i instanceof Object&&(t=i.height)!==null&&t!==void 0?t:0}get depthOrArrayLayers(){var e,t;const i=this.descriptor.size;return i instanceof Array&&i.length>2?(e=i[2])!==null&&e!==void 0?e:0:i instanceof Object&&(t=i.depthOrArrayLayers)!==null&&t!==void 0?t:0}get format(){var e;return this.descriptor&&(e=this.descriptor.format)!==null&&e!==void 0?e:"rgba8unorm"}get sampleCount(){var e;return this.descriptor&&(e=this.descriptor.sampleCount)!==null&&e!==void 0?e:1}get mipLevelCount(){var e;return this.descriptor&&(e=this.descriptor.mipLevelCount)!==null&&e!==void 0?e:1}get dimension(){var e;return this.descriptor&&(e=this.descriptor.dimension)!==null&&e!==void 0?e:"2d"}getMipLevelSize(e){if(e>=this.mipLevelCount)return[0,0,0];const t=[this.width,this.height,this.depthOrArrayLayers];for(let i=0;i<t.length;++i)t[i]=Math.max(1,t[i]>>e);return t}get texelByteSize(){const e=this.format,t=Jo[e];return t?t.isDepthStencil?4:t.bytesPerBlock:0}get bytesPerRow(){return this.width*this.texelByteSize}get isDepthStencil(){const e=this.format,t=Jo[e];return!!t&&t.isDepthStencil}getGpuSize(){const e=this.format,t=Jo[e],i=this.width;if(!e||i<=0||!t)return-1;const r=this.height,s=this.depthOrArrayLayers,o=this.dimension;return i/t.blockWidth*(o==="1d"?1:r/t.blockHeight)*t.bytesPerBlock*s}getPixel(e,t,i=0,r=0){const s=this.texelByteSize,o=this.bytesPerRow,a=this.height,l=this.data[r];return ZC(new Uint8Array(l),e,t,i,r,a,o,s,this.format)}setPixel(e,t,i,r,s){const o=this.texelByteSize,a=this.bytesPerRow,l=this.height,c=this.data[r];(function(u,d,h,f,p,g,_,b,w,x){const y=f*(_>>=p)*(g>>=p)+h*_+d*b;switch(w){case"r8unorm":return void J(u,y,"8unorm",1,x);case"r8snorm":return void J(u,y,"8snorm",1,x);case"r8uint":return void J(u,y,"8uint",1,x);case"r8sint":return void J(u,y,"8sint",1,x);case"rg8unorm":return void J(u,y,"8unorm",2,x);case"rg8snorm":return void J(u,y,"8snorm",2,x);case"rg8uint":return void J(u,y,"8uint",2,x);case"rg8sint":return void J(u,y,"8sint",2,x);case"rgba8unorm-srgb":case"rgba8unorm":case"bgra8unorm-srgb":case"bgra8unorm":return void J(u,y,"8unorm",4,x);case"rgba8snorm":return void J(u,y,"8snorm",4,x);case"rgba8uint":return void J(u,y,"8uint",4,x);case"rgba8sint":return void J(u,y,"8sint",4,x);case"r16uint":return void J(u,y,"16uint",1,x);case"r16sint":return void J(u,y,"16sint",1,x);case"r16float":return void J(u,y,"16float",1,x);case"rg16uint":return void J(u,y,"16uint",2,x);case"rg16sint":return void J(u,y,"16sint",2,x);case"rg16float":return void J(u,y,"16float",2,x);case"rgba16uint":return void J(u,y,"16uint",4,x);case"rgba16sint":return void J(u,y,"16sint",4,x);case"rgba16float":return void J(u,y,"16float",4,x);case"r32uint":return void J(u,y,"32uint",1,x);case"r32sint":return void J(u,y,"32sint",1,x);case"depth16unorm":case"depth24plus":case"depth24plus-stencil8":case"depth32float":case"depth32float-stencil8":case"r32float":return void J(u,y,"32float",1,x);case"rg32uint":return void J(u,y,"32uint",2,x);case"rg32sint":return void J(u,y,"32sint",2,x);case"rg32float":return void J(u,y,"32float",2,x);case"rgba32uint":return void J(u,y,"32uint",4,x);case"rgba32sint":return void J(u,y,"32sint",4,x);case"rgba32float":return void J(u,y,"32float",4,x);case"rg11b10ufloat":console.error("TODO: rg11b10ufloat not supported for writing")}})(new Uint8Array(c),e,t,i,r,l,a,o,this.format,s)}}(n=>{n[n.token=0]="token",n[n.keyword=1]="keyword",n[n.reserved=2]="reserved"})(A||(A={}));class C{constructor(e,t,i){this.name=e,this.type=t,this.rule=i}toString(){return this.name}}class v{}P=v,v.none=new C("",A.reserved,""),v.eof=new C("EOF",A.token,""),v.reserved={asm:new C("asm",A.reserved,"asm"),bf16:new C("bf16",A.reserved,"bf16"),do:new C("do",A.reserved,"do"),enum:new C("enum",A.reserved,"enum"),f16:new C("f16",A.reserved,"f16"),f64:new C("f64",A.reserved,"f64"),handle:new C("handle",A.reserved,"handle"),i8:new C("i8",A.reserved,"i8"),i16:new C("i16",A.reserved,"i16"),i64:new C("i64",A.reserved,"i64"),mat:new C("mat",A.reserved,"mat"),premerge:new C("premerge",A.reserved,"premerge"),regardless:new C("regardless",A.reserved,"regardless"),typedef:new C("typedef",A.reserved,"typedef"),u8:new C("u8",A.reserved,"u8"),u16:new C("u16",A.reserved,"u16"),u64:new C("u64",A.reserved,"u64"),unless:new C("unless",A.reserved,"unless"),using:new C("using",A.reserved,"using"),vec:new C("vec",A.reserved,"vec"),void:new C("void",A.reserved,"void")},v.keywords={array:new C("array",A.keyword,"array"),atomic:new C("atomic",A.keyword,"atomic"),bool:new C("bool",A.keyword,"bool"),f32:new C("f32",A.keyword,"f32"),i32:new C("i32",A.keyword,"i32"),mat2x2:new C("mat2x2",A.keyword,"mat2x2"),mat2x3:new C("mat2x3",A.keyword,"mat2x3"),mat2x4:new C("mat2x4",A.keyword,"mat2x4"),mat3x2:new C("mat3x2",A.keyword,"mat3x2"),mat3x3:new C("mat3x3",A.keyword,"mat3x3"),mat3x4:new C("mat3x4",A.keyword,"mat3x4"),mat4x2:new C("mat4x2",A.keyword,"mat4x2"),mat4x3:new C("mat4x3",A.keyword,"mat4x3"),mat4x4:new C("mat4x4",A.keyword,"mat4x4"),ptr:new C("ptr",A.keyword,"ptr"),sampler:new C("sampler",A.keyword,"sampler"),sampler_comparison:new C("sampler_comparison",A.keyword,"sampler_comparison"),struct:new C("struct",A.keyword,"struct"),texture_1d:new C("texture_1d",A.keyword,"texture_1d"),texture_2d:new C("texture_2d",A.keyword,"texture_2d"),texture_2d_array:new C("texture_2d_array",A.keyword,"texture_2d_array"),texture_3d:new C("texture_3d",A.keyword,"texture_3d"),texture_cube:new C("texture_cube",A.keyword,"texture_cube"),texture_cube_array:new C("texture_cube_array",A.keyword,"texture_cube_array"),texture_multisampled_2d:new C("texture_multisampled_2d",A.keyword,"texture_multisampled_2d"),texture_storage_1d:new C("texture_storage_1d",A.keyword,"texture_storage_1d"),texture_storage_2d:new C("texture_storage_2d",A.keyword,"texture_storage_2d"),texture_storage_2d_array:new C("texture_storage_2d_array",A.keyword,"texture_storage_2d_array"),texture_storage_3d:new C("texture_storage_3d",A.keyword,"texture_storage_3d"),texture_depth_2d:new C("texture_depth_2d",A.keyword,"texture_depth_2d"),texture_depth_2d_array:new C("texture_depth_2d_array",A.keyword,"texture_depth_2d_array"),texture_depth_cube:new C("texture_depth_cube",A.keyword,"texture_depth_cube"),texture_depth_cube_array:new C("texture_depth_cube_array",A.keyword,"texture_depth_cube_array"),texture_depth_multisampled_2d:new C("texture_depth_multisampled_2d",A.keyword,"texture_depth_multisampled_2d"),texture_external:new C("texture_external",A.keyword,"texture_external"),u32:new C("u32",A.keyword,"u32"),vec2:new C("vec2",A.keyword,"vec2"),vec3:new C("vec3",A.keyword,"vec3"),vec4:new C("vec4",A.keyword,"vec4"),bitcast:new C("bitcast",A.keyword,"bitcast"),block:new C("block",A.keyword,"block"),break:new C("break",A.keyword,"break"),case:new C("case",A.keyword,"case"),continue:new C("continue",A.keyword,"continue"),continuing:new C("continuing",A.keyword,"continuing"),default:new C("default",A.keyword,"default"),diagnostic:new C("diagnostic",A.keyword,"diagnostic"),discard:new C("discard",A.keyword,"discard"),else:new C("else",A.keyword,"else"),enable:new C("enable",A.keyword,"enable"),fallthrough:new C("fallthrough",A.keyword,"fallthrough"),false:new C("false",A.keyword,"false"),fn:new C("fn",A.keyword,"fn"),for:new C("for",A.keyword,"for"),function:new C("function",A.keyword,"function"),if:new C("if",A.keyword,"if"),let:new C("let",A.keyword,"let"),const:new C("const",A.keyword,"const"),loop:new C("loop",A.keyword,"loop"),while:new C("while",A.keyword,"while"),private:new C("private",A.keyword,"private"),read:new C("read",A.keyword,"read"),read_write:new C("read_write",A.keyword,"read_write"),return:new C("return",A.keyword,"return"),requires:new C("requires",A.keyword,"requires"),storage:new C("storage",A.keyword,"storage"),switch:new C("switch",A.keyword,"switch"),true:new C("true",A.keyword,"true"),alias:new C("alias",A.keyword,"alias"),type:new C("type",A.keyword,"type"),uniform:new C("uniform",A.keyword,"uniform"),var:new C("var",A.keyword,"var"),override:new C("override",A.keyword,"override"),workgroup:new C("workgroup",A.keyword,"workgroup"),write:new C("write",A.keyword,"write"),r8unorm:new C("r8unorm",A.keyword,"r8unorm"),r8snorm:new C("r8snorm",A.keyword,"r8snorm"),r8uint:new C("r8uint",A.keyword,"r8uint"),r8sint:new C("r8sint",A.keyword,"r8sint"),r16uint:new C("r16uint",A.keyword,"r16uint"),r16sint:new C("r16sint",A.keyword,"r16sint"),r16float:new C("r16float",A.keyword,"r16float"),rg8unorm:new C("rg8unorm",A.keyword,"rg8unorm"),rg8snorm:new C("rg8snorm",A.keyword,"rg8snorm"),rg8uint:new C("rg8uint",A.keyword,"rg8uint"),rg8sint:new C("rg8sint",A.keyword,"rg8sint"),r32uint:new C("r32uint",A.keyword,"r32uint"),r32sint:new C("r32sint",A.keyword,"r32sint"),r32float:new C("r32float",A.keyword,"r32float"),rg16uint:new C("rg16uint",A.keyword,"rg16uint"),rg16sint:new C("rg16sint",A.keyword,"rg16sint"),rg16float:new C("rg16float",A.keyword,"rg16float"),rgba8unorm:new C("rgba8unorm",A.keyword,"rgba8unorm"),rgba8unorm_srgb:new C("rgba8unorm_srgb",A.keyword,"rgba8unorm_srgb"),rgba8snorm:new C("rgba8snorm",A.keyword,"rgba8snorm"),rgba8uint:new C("rgba8uint",A.keyword,"rgba8uint"),rgba8sint:new C("rgba8sint",A.keyword,"rgba8sint"),bgra8unorm:new C("bgra8unorm",A.keyword,"bgra8unorm"),bgra8unorm_srgb:new C("bgra8unorm_srgb",A.keyword,"bgra8unorm_srgb"),rgb10a2unorm:new C("rgb10a2unorm",A.keyword,"rgb10a2unorm"),rg11b10float:new C("rg11b10float",A.keyword,"rg11b10float"),rg32uint:new C("rg32uint",A.keyword,"rg32uint"),rg32sint:new C("rg32sint",A.keyword,"rg32sint"),rg32float:new C("rg32float",A.keyword,"rg32float"),rgba16uint:new C("rgba16uint",A.keyword,"rgba16uint"),rgba16sint:new C("rgba16sint",A.keyword,"rgba16sint"),rgba16float:new C("rgba16float",A.keyword,"rgba16float"),rgba32uint:new C("rgba32uint",A.keyword,"rgba32uint"),rgba32sint:new C("rgba32sint",A.keyword,"rgba32sint"),rgba32float:new C("rgba32float",A.keyword,"rgba32float"),static_assert:new C("static_assert",A.keyword,"static_assert")},v.tokens={decimal_float_literal:new C("decimal_float_literal",A.token,/((-?[0-9]*\.[0-9]+|-?[0-9]+\.[0-9]*)((e|E)(\+|-)?[0-9]+)?[fh]?)|(-?[0-9]+(e|E)(\+|-)?[0-9]+[fh]?)|(-?[0-9]+[fh])/),hex_float_literal:new C("hex_float_literal",A.token,/-?0x((([0-9a-fA-F]*\.[0-9a-fA-F]+|[0-9a-fA-F]+\.[0-9a-fA-F]*)((p|P)(\+|-)?[0-9]+[fh]?)?)|([0-9a-fA-F]+(p|P)(\+|-)?[0-9]+[fh]?))/),int_literal:new C("int_literal",A.token,/-?0x[0-9a-fA-F]+|0i?|-?[1-9][0-9]*i?/),uint_literal:new C("uint_literal",A.token,/0x[0-9a-fA-F]+u|0u|[1-9][0-9]*u/),name:new C("name",A.token,/([_\p{XID_Start}][\p{XID_Continue}]+)|([\p{XID_Start}])/u),ident:new C("ident",A.token,/[_a-zA-Z][0-9a-zA-Z_]*/),and:new C("and",A.token,"&"),and_and:new C("and_and",A.token,"&&"),arrow:new C("arrow ",A.token,"->"),attr:new C("attr",A.token,"@"),forward_slash:new C("forward_slash",A.token,"/"),bang:new C("bang",A.token,"!"),bracket_left:new C("bracket_left",A.token,"["),bracket_right:new C("bracket_right",A.token,"]"),brace_left:new C("brace_left",A.token,"{"),brace_right:new C("brace_right",A.token,"}"),colon:new C("colon",A.token,":"),comma:new C("comma",A.token,","),equal:new C("equal",A.token,"="),equal_equal:new C("equal_equal",A.token,"=="),not_equal:new C("not_equal",A.token,"!="),greater_than:new C("greater_than",A.token,">"),greater_than_equal:new C("greater_than_equal",A.token,">="),shift_right:new C("shift_right",A.token,">>"),less_than:new C("less_than",A.token,"<"),less_than_equal:new C("less_than_equal",A.token,"<="),shift_left:new C("shift_left",A.token,"<<"),modulo:new C("modulo",A.token,"%"),minus:new C("minus",A.token,"-"),minus_minus:new C("minus_minus",A.token,"--"),period:new C("period",A.token,"."),plus:new C("plus",A.token,"+"),plus_plus:new C("plus_plus",A.token,"++"),or:new C("or",A.token,"|"),or_or:new C("or_or",A.token,"||"),paren_left:new C("paren_left",A.token,"("),paren_right:new C("paren_right",A.token,")"),semicolon:new C("semicolon",A.token,";"),star:new C("star",A.token,"*"),tilde:new C("tilde",A.token,"~"),underscore:new C("underscore",A.token,"_"),xor:new C("xor",A.token,"^"),plus_equal:new C("plus_equal",A.token,"+="),minus_equal:new C("minus_equal",A.token,"-="),times_equal:new C("times_equal",A.token,"*="),division_equal:new C("division_equal",A.token,"/="),modulo_equal:new C("modulo_equal",A.token,"%="),and_equal:new C("and_equal",A.token,"&="),or_equal:new C("or_equal",A.token,"|="),xor_equal:new C("xor_equal",A.token,"^="),shift_right_equal:new C("shift_right_equal",A.token,">>="),shift_left_equal:new C("shift_left_equal",A.token,"<<=")},v.simpleTokens={"@":P.tokens.attr,"{":P.tokens.brace_left,"}":P.tokens.brace_right,":":P.tokens.colon,",":P.tokens.comma,"(":P.tokens.paren_left,")":P.tokens.paren_right,";":P.tokens.semicolon},v.literalTokens={"&":P.tokens.and,"&&":P.tokens.and_and,"->":P.tokens.arrow,"/":P.tokens.forward_slash,"!":P.tokens.bang,"[":P.tokens.bracket_left,"]":P.tokens.bracket_right,"=":P.tokens.equal,"==":P.tokens.equal_equal,"!=":P.tokens.not_equal,">":P.tokens.greater_than,">=":P.tokens.greater_than_equal,">>":P.tokens.shift_right,"<":P.tokens.less_than,"<=":P.tokens.less_than_equal,"<<":P.tokens.shift_left,"%":P.tokens.modulo,"-":P.tokens.minus,"--":P.tokens.minus_minus,".":P.tokens.period,"+":P.tokens.plus,"++":P.tokens.plus_plus,"|":P.tokens.or,"||":P.tokens.or_or,"*":P.tokens.star,"~":P.tokens.tilde,_:P.tokens.underscore,"^":P.tokens.xor,"+=":P.tokens.plus_equal,"-=":P.tokens.minus_equal,"*=":P.tokens.times_equal,"/=":P.tokens.division_equal,"%=":P.tokens.modulo_equal,"&=":P.tokens.and_equal,"|=":P.tokens.or_equal,"^=":P.tokens.xor_equal,">>=":P.tokens.shift_right_equal,"<<=":P.tokens.shift_left_equal},v.regexTokens={decimal_float_literal:P.tokens.decimal_float_literal,hex_float_literal:P.tokens.hex_float_literal,int_literal:P.tokens.int_literal,uint_literal:P.tokens.uint_literal,ident:P.tokens.ident},v.storage_class=[P.keywords.function,P.keywords.private,P.keywords.workgroup,P.keywords.uniform,P.keywords.storage],v.access_mode=[P.keywords.read,P.keywords.write,P.keywords.read_write],v.sampler_type=[P.keywords.sampler,P.keywords.sampler_comparison],v.sampled_texture_type=[P.keywords.texture_1d,P.keywords.texture_2d,P.keywords.texture_2d_array,P.keywords.texture_3d,P.keywords.texture_cube,P.keywords.texture_cube_array],v.multisampled_texture_type=[P.keywords.texture_multisampled_2d],v.storage_texture_type=[P.keywords.texture_storage_1d,P.keywords.texture_storage_2d,P.keywords.texture_storage_2d_array,P.keywords.texture_storage_3d],v.depth_texture_type=[P.keywords.texture_depth_2d,P.keywords.texture_depth_2d_array,P.keywords.texture_depth_cube,P.keywords.texture_depth_cube_array,P.keywords.texture_depth_multisampled_2d],v.texture_external_type=[P.keywords.texture_external],v.any_texture_type=[...P.sampled_texture_type,...P.multisampled_texture_type,...P.storage_texture_type,...P.depth_texture_type,...P.texture_external_type],v.texel_format=[P.keywords.r8unorm,P.keywords.r8snorm,P.keywords.r8uint,P.keywords.r8sint,P.keywords.r16uint,P.keywords.r16sint,P.keywords.r16float,P.keywords.rg8unorm,P.keywords.rg8snorm,P.keywords.rg8uint,P.keywords.rg8sint,P.keywords.r32uint,P.keywords.r32sint,P.keywords.r32float,P.keywords.rg16uint,P.keywords.rg16sint,P.keywords.rg16float,P.keywords.rgba8unorm,P.keywords.rgba8unorm_srgb,P.keywords.rgba8snorm,P.keywords.rgba8uint,P.keywords.rgba8sint,P.keywords.bgra8unorm,P.keywords.bgra8unorm_srgb,P.keywords.rgb10a2unorm,P.keywords.rg11b10float,P.keywords.rg32uint,P.keywords.rg32sint,P.keywords.rg32float,P.keywords.rgba16uint,P.keywords.rgba16sint,P.keywords.rgba16float,P.keywords.rgba32uint,P.keywords.rgba32sint,P.keywords.rgba32float],v.const_literal=[P.tokens.int_literal,P.tokens.uint_literal,P.tokens.decimal_float_literal,P.tokens.hex_float_literal,P.keywords.true,P.keywords.false],v.literal_or_ident=[P.tokens.ident,P.tokens.int_literal,P.tokens.uint_literal,P.tokens.decimal_float_literal,P.tokens.hex_float_literal,P.tokens.name],v.element_count_expression=[P.tokens.int_literal,P.tokens.uint_literal,P.tokens.ident],v.template_types=[P.keywords.vec2,P.keywords.vec3,P.keywords.vec4,P.keywords.mat2x2,P.keywords.mat2x3,P.keywords.mat2x4,P.keywords.mat3x2,P.keywords.mat3x3,P.keywords.mat3x4,P.keywords.mat4x2,P.keywords.mat4x3,P.keywords.mat4x4,P.keywords.atomic,P.keywords.bitcast,...P.any_texture_type],v.attribute_name=[P.tokens.ident,P.keywords.block,P.keywords.diagnostic],v.assignment_operators=[P.tokens.equal,P.tokens.plus_equal,P.tokens.minus_equal,P.tokens.times_equal,P.tokens.division_equal,P.tokens.modulo_equal,P.tokens.and_equal,P.tokens.or_equal,P.tokens.xor_equal,P.tokens.shift_right_equal,P.tokens.shift_left_equal],v.increment_operators=[P.tokens.plus_plus,P.tokens.minus_minus];class ih{constructor(e,t,i,r,s){this.type=e,this.lexeme=t,this.line=i,this.start=r,this.end=s}toString(){return this.lexeme}isTemplateType(){return v.template_types.indexOf(this.type)!=-1}isArrayType(){return this.type==v.keywords.array}isArrayOrTemplateType(){return this.isArrayType()||this.isTemplateType()}}class i2{constructor(e){this._tokens=[],this._start=0,this._current=0,this._line=1,this._source=e??""}scanTokens(){for(;!this._isAtEnd();)if(this._start=this._current,!this.scanToken())throw`Invalid syntax at line ${this._line}`;return this._tokens.push(new ih(v.eof,"",this._line,this._current,this._current)),this._tokens}scanToken(){let e=this._advance();if(e==`
`)return this._line++,!0;if(this._isWhitespace(e))return!0;if(e=="/"){if(this._peekAhead()=="/"){for(;e!=`
`;){if(this._isAtEnd())return!0;e=this._advance()}return this._line++,!0}if(this._peekAhead()=="*"){this._advance();let o=1;for(;o>0;){if(this._isAtEnd())return!0;if(e=this._advance(),e==`
`)this._line++;else if(e=="*"){if(this._peekAhead()=="/"&&(this._advance(),o--,o==0))return!0}else e=="/"&&this._peekAhead()=="*"&&(this._advance(),o++)}return!0}}const t=v.simpleTokens[e];if(t)return this._addToken(t),!0;let i=v.none;const r=this._isAlpha(e),s=e==="_";if(this._isAlphaNumeric(e)){let o=this._peekAhead();for(;this._isAlphaNumeric(o);)e+=this._advance(),o=this._peekAhead()}if(r){const o=v.keywords[e];if(o)return this._addToken(o),!0}if(r||s)return this._addToken(v.tokens.ident),!0;for(;;){let o=this._findType(e);const a=this._peekAhead();if(e=="-"&&this._tokens.length>0){if(a=="=")return this._current++,e+=a,this._addToken(v.tokens.minus_equal),!0;if(a=="-")return this._current++,e+=a,this._addToken(v.tokens.minus_minus),!0;const l=this._tokens.length-1;if((v.literal_or_ident.indexOf(this._tokens[l].type)!=-1||this._tokens[l].type==v.tokens.paren_right)&&a!=">")return this._addToken(o),!0}if(e==">"&&(a==">"||a=="=")){let l=!1,c=this._tokens.length-1;for(let u=0;u<5&&c>=0&&v.assignment_operators.indexOf(this._tokens[c].type)===-1;++u,--c)if(this._tokens[c].type===v.tokens.less_than){c>0&&this._tokens[c-1].isArrayOrTemplateType()&&(l=!0);break}if(l)return this._addToken(o),!0}if(o===v.none){let l=e,c=0;const u=2;for(let d=0;d<u;++d)if(l+=this._peekAhead(d),o=this._findType(l),o!==v.none){c=d;break}if(o===v.none)return i!==v.none&&(this._current--,this._addToken(i),!0);e=l,this._current+=c+1}if(i=o,this._isAtEnd())break;e+=this._advance()}return i!==v.none&&(this._addToken(i),!0)}_findType(e){for(const i in v.regexTokens){const r=v.regexTokens[i];if(this._match(e,r.rule))return r}return v.literalTokens[e]||v.none}_match(e,t){const i=t.exec(e);return i&&i.index==0&&i[0]==e}_isAtEnd(){return this._current>=this._source.length}_isAlpha(e){return!this._isNumeric(e)&&!this._isWhitespace(e)&&e!=="_"&&e!=="."&&e!=="("&&e!==")"&&e!=="["&&e!=="]"&&e!=="{"&&e!=="}"&&e!==","&&e!==";"&&e!==":"&&e!=="="&&e!=="!"&&e!=="<"&&e!==">"&&e!=="+"&&e!=="-"&&e!=="*"&&e!=="/"&&e!=="%"&&e!=="&"&&e!=="|"&&e!=="^"&&e!=="~"&&e!=="@"&&e!=="#"&&e!=="?"&&e!=="'"&&e!=="`"&&e!=='"'&&e!=="\\"&&e!==`
`&&e!=="\r"&&e!=="	"&&e!=="\0"}_isNumeric(e){return e>="0"&&e<="9"}_isAlphaNumeric(e){return this._isAlpha(e)||this._isNumeric(e)||e==="_"}_isWhitespace(e){return e==" "||e=="	"||e=="\r"}_advance(e=0){let t=this._source[this._current];return e=e||0,e++,this._current+=e,t}_peekAhead(e=0){return e=e||0,this._current+e>=this._source.length?"\0":this._source[this._current+e]}_addToken(e){const t=this._source.substring(this._start,this._current);this._tokens.push(new ih(e,t,this._line,this._start,this._current))}}function V(n){return Array.isArray(n)||(n==null?void 0:n.buffer)instanceof ArrayBuffer}const Fs=new Float32Array(1),r2=new Uint32Array(Fs.buffer),s2=new Uint32Array(Fs.buffer),Ds=new Int32Array(1),o2=new Float32Array(Ds.buffer),a2=new Uint32Array(Ds.buffer),Bs=new Uint32Array(1),l2=new Float32Array(Bs.buffer),c2=new Int32Array(Bs.buffer);function rh(n,e,t){if(e===t)return n;if(e==="f32"){if(t==="i32"||t==="x32")return Fs[0]=n,r2[0];if(t==="u32")return Fs[0]=n,s2[0]}else if(e==="i32"||e==="x32"){if(t==="f32")return Ds[0]=n,o2[0];if(t==="u32")return Ds[0]=n,a2[0]}else if(e==="u32"){if(t==="f32")return Bs[0]=n,l2[0];if(t==="i32"||t==="x32")return Bs[0]=n,c2[0]}return console.error(`Unsupported cast from ${e} to ${t}`),n}class u2{constructor(e){this.resources=null,this.inUse=!1,this.info=null,this.node=e}}class Pr{constructor(e,t){this.align=e,this.size=t}}class vt{constructor(){this.uniforms=[],this.storage=[],this.textures=[],this.samplers=[],this.aliases=[],this.overrides=[],this.structs=[],this.entry=new XC,this.functions=[],this._types=new Map,this._functions=new Map}_isStorageTexture(e){return e.name=="texture_storage_1d"||e.name=="texture_storage_2d"||e.name=="texture_storage_2d_array"||e.name=="texture_storage_3d"}updateAST(e){for(const t of e)t instanceof Yi&&this._functions.set(t.name,new u2(t));for(const t of e)if(t instanceof It){const i=this.getTypeInfo(t,null);i instanceof jt&&this.structs.push(i)}for(const t of e)if(t instanceof zc)this.aliases.push(this._getAliasInfo(t));else{if(t instanceof Uc){const i=t,r=this._getAttributeNum(i.attributes,"id",0),s=i.type!=null?this.getTypeInfo(i.type,i.attributes):null;this.overrides.push(new WC(i.name,s,i.attributes,r));continue}if(this._isUniformVar(t)){const i=t,r=this._getAttributeNum(i.attributes,"group",0),s=this._getAttributeNum(i.attributes,"binding",0),o=this.getTypeInfo(i.type,i.attributes),a=new Rr(i.name,o,r,s,i.attributes,Vt.Uniform,i.access);a.access||(a.access="read"),this.uniforms.push(a);continue}if(this._isStorageVar(t)){const i=t,r=this._getAttributeNum(i.attributes,"group",0),s=this._getAttributeNum(i.attributes,"binding",0),o=this.getTypeInfo(i.type,i.attributes),a=this._isStorageTexture(o),l=new Rr(i.name,o,r,s,i.attributes,a?Vt.StorageTexture:Vt.Storage,i.access);l.access||(l.access="read"),this.storage.push(l);continue}if(this._isTextureVar(t)){const i=t,r=this._getAttributeNum(i.attributes,"group",0),s=this._getAttributeNum(i.attributes,"binding",0),o=this.getTypeInfo(i.type,i.attributes),a=this._isStorageTexture(o),l=new Rr(i.name,o,r,s,i.attributes,a?Vt.StorageTexture:Vt.Texture,i.access);l.access||(l.access="read"),a?this.storage.push(l):this.textures.push(l);continue}if(this._isSamplerVar(t)){const i=t,r=this._getAttributeNum(i.attributes,"group",0),s=this._getAttributeNum(i.attributes,"binding",0),o=this.getTypeInfo(i.type,i.attributes),a=new Rr(i.name,o,r,s,i.attributes,Vt.Sampler,i.access);this.samplers.push(a);continue}}for(const t of e)if(t instanceof Yi){const i=this._getAttribute(t,"vertex"),r=this._getAttribute(t,"fragment"),s=this._getAttribute(t,"compute"),o=i||r||s,a=new jC(t.name,o==null?void 0:o.name,t.attributes);a.attributes=t.attributes,a.startLine=t.startLine,a.endLine=t.endLine,this.functions.push(a),this._functions.get(t.name).info=a,o&&(this._functions.get(t.name).inUse=!0,a.inUse=!0,a.resources=this._findResources(t,!!o),a.inputs=this._getInputs(t.args),a.outputs=this._getOutputs(t.returnType),this.entry[o.name].push(a)),a.arguments=t.args.map(l=>new HC(l.name,this.getTypeInfo(l.type,l.attributes),l.attributes)),a.returnType=t.returnType?this.getTypeInfo(t.returnType,t.attributes):null;continue}for(const t of this._functions.values())t.info&&(t.info.inUse=t.inUse,this._addCalls(t.node,t.info.calls));for(const t of this._functions.values())t.node.search(i=>{var r,s,o;if(i instanceof Em){if(i.value)if(V(i.value))for(const a of i.value)for(const l of this.overrides)a===l.name&&((r=t.info)===null||r===void 0||r.overrides.push(l));else for(const a of this.overrides)i.value===a.name&&((s=t.info)===null||s===void 0||s.overrides.push(a))}else if(i instanceof je)for(const a of this.overrides)i.name===a.name&&((o=t.info)===null||o===void 0||o.overrides.push(a))});for(const t of this.uniforms)this._markStructsInUse(t.type);for(const t of this.storage)this._markStructsInUse(t.type)}getFunctionInfo(e){for(const t of this.functions)if(t.name==e)return t;return null}getStructInfo(e){for(const t of this.structs)if(t.name==e)return t;return null}getOverrideInfo(e){for(const t of this.overrides)if(t.name==e)return t;return null}_markStructsInUse(e){if(e)if(e.isStruct){if(e.inUse=!0,e.members)for(const t of e.members)this._markStructsInUse(t.type)}else if(e.isArray)this._markStructsInUse(e.format);else if(e.isTemplate)e.format&&this._markStructsInUse(e.format);else{const t=this._getAlias(e.name);t&&this._markStructsInUse(t)}}_addCalls(e,t){var i;for(const r of e.calls){const s=(i=this._functions.get(r.name))===null||i===void 0?void 0:i.info;s&&t.add(s)}}findResource(e,t,i){if(i){for(const r of this.entry.compute)if(r.name===i){for(const s of r.resources)if(s.group==e&&s.binding==t)return s}for(const r of this.entry.vertex)if(r.name===i){for(const s of r.resources)if(s.group==e&&s.binding==t)return s}for(const r of this.entry.fragment)if(r.name===i){for(const s of r.resources)if(s.group==e&&s.binding==t)return s}}for(const r of this.uniforms)if(r.group==e&&r.binding==t)return r;for(const r of this.storage)if(r.group==e&&r.binding==t)return r;for(const r of this.textures)if(r.group==e&&r.binding==t)return r;for(const r of this.samplers)if(r.group==e&&r.binding==t)return r;return null}_findResource(e){for(const t of this.uniforms)if(t.name==e)return t;for(const t of this.storage)if(t.name==e)return t;for(const t of this.textures)if(t.name==e)return t;for(const t of this.samplers)if(t.name==e)return t;return null}_markStructsFromAST(e){const t=this.getTypeInfo(e,null);this._markStructsInUse(t)}_findResources(e,t){const i=[],r=this,s=[];return e.search(o=>{if(o instanceof Os)s.push({});else if(o instanceof Ns)s.pop();else if(o instanceof Pt){const a=o;t&&a.type!==null&&this._markStructsFromAST(a.type),s.length>0&&(s[s.length-1][a.name]=a)}else if(o instanceof yt){const a=o;t&&a.type!==null&&this._markStructsFromAST(a.type)}else if(o instanceof Mi){const a=o;t&&a.type!==null&&this._markStructsFromAST(a.type),s.length>0&&(s[s.length-1][a.name]=a)}else if(o instanceof je){const a=o;if(s.length>0&&s[s.length-1][a.name])return;const l=r._findResource(a.name);l&&i.push(l)}else if(o instanceof Vc){const a=o,l=r._functions.get(a.name);l&&(t&&(l.inUse=!0),e.calls.add(l.node),l.resources===null&&(l.resources=r._findResources(l.node,t)),i.push(...l.resources))}else if(o instanceof $c){const a=o,l=r._functions.get(a.name);l&&(t&&(l.inUse=!0),e.calls.add(l.node),l.resources===null&&(l.resources=r._findResources(l.node,t)),i.push(...l.resources))}}),[...new Map(i.map(o=>[o.name,o])).values()]}getBindGroups(){const e=[];function t(i,r){i>=e.length&&(e.length=i+1),e[i]===void 0&&(e[i]=[]),r>=e[i].length&&(e[i].length=r+1)}for(const i of this.uniforms)t(i.group,i.binding),e[i.group][i.binding]=i;for(const i of this.storage)t(i.group,i.binding),e[i.group][i.binding]=i;for(const i of this.textures)t(i.group,i.binding),e[i.group][i.binding]=i;for(const i of this.samplers)t(i.group,i.binding),e[i.group][i.binding]=i;return e}_getOutputs(e,t=void 0){if(t===void 0&&(t=[]),e instanceof It)this._getStructOutputs(e,t);else{const i=this._getOutputInfo(e);i!==null&&t.push(i)}return t}_getStructOutputs(e,t){for(const i of e.members)if(i.type instanceof It)this._getStructOutputs(i.type,t);else{const r=this._getAttribute(i,"location")||this._getAttribute(i,"builtin");if(r!==null){const s=this.getTypeInfo(i.type,i.type.attributes),o=this._parseInt(r.value),a=new Qd(i.name,s,r.name,o);t.push(a)}}}_getOutputInfo(e){const t=this._getAttribute(e,"location")||this._getAttribute(e,"builtin");if(t!==null){const i=this.getTypeInfo(e,e.attributes),r=this._parseInt(t.value);return new Qd("",i,t.name,r)}return null}_getInputs(e,t=void 0){t===void 0&&(t=[]);for(const i of e)if(i.type instanceof It)this._getStructInputs(i.type,t);else{const r=this._getInputInfo(i);r!==null&&t.push(r)}return t}_getStructInputs(e,t){for(const i of e.members)if(i.type instanceof It)this._getStructInputs(i.type,t);else{const r=this._getInputInfo(i);r!==null&&t.push(r)}}_getInputInfo(e){const t=this._getAttribute(e,"location")||this._getAttribute(e,"builtin");if(t!==null){const i=this._getAttribute(e,"interpolation"),r=this.getTypeInfo(e.type,e.attributes),s=this._parseInt(t.value),o=new VC(e.name,r,t.name,s);return i!==null&&(o.interpolation=this._parseString(i.value)),o}return null}_parseString(e){return e instanceof Array&&(e=e[0]),e}_parseInt(e){e instanceof Array&&(e=e[0]);const t=parseInt(e);return isNaN(t)?e:t}_getAlias(e){for(const t of this.aliases)if(t.name==e)return t.type;return null}_getAliasInfo(e){return new zC(e.name,this.getTypeInfo(e.type,null))}getTypeInfoByName(e){for(const t of this.structs)if(t.name==e)return t;for(const t of this.aliases)if(t.name==e)return t.type;return null}getTypeInfo(e,t=null){if(this._types.has(e))return this._types.get(e);if(e instanceof qr){const r=e.type?this.getTypeInfo(e.type,e.attributes):null,s=new gl(e.name,r,t);return this._types.set(e,s),this._updateTypeInfo(s),s}if(e instanceof ki){const r=e,s=r.format?this.getTypeInfo(r.format,r.attributes):null,o=new Kt(r.name,t);return o.format=s,o.count=r.count,this._types.set(e,o),this._updateTypeInfo(o),o}if(e instanceof It){const r=e,s=new jt(r.name,t);s.startLine=r.startLine,s.endLine=r.endLine;for(const o of r.members){const a=this.getTypeInfo(o.type,o.attributes);s.members.push(new Gd(o.name,a,o.attributes))}return this._types.set(e,s),this._updateTypeInfo(s),s}if(e instanceof xi){const r=e,s=r.format instanceof N,o=r.format?s?this.getTypeInfo(r.format,null):new Qe(r.format,null):null,a=new yn(r.name,o,t,r.access);return this._types.set(e,a),this._updateTypeInfo(a),a}if(e instanceof R){const r=e,s=r.format?this.getTypeInfo(r.format,null):null,o=new yn(r.name,s,t,r.access);return this._types.set(e,o),this._updateTypeInfo(o),o}const i=new Qe(e.name,t);return this._types.set(e,i),this._updateTypeInfo(i),i}_updateTypeInfo(e){var t,i,r;const s=this._getTypeSize(e);if(e.size=(t=s==null?void 0:s.size)!==null&&t!==void 0?t:0,e instanceof Kt&&e.format){const o=this._getTypeSize(e.format);e.stride=Math.max((i=o==null?void 0:o.size)!==null&&i!==void 0?i:0,(r=o==null?void 0:o.align)!==null&&r!==void 0?r:0),this._updateTypeInfo(e.format)}e instanceof gl&&this._updateTypeInfo(e.format),e instanceof jt&&this._updateStructInfo(e)}_updateStructInfo(e){var t;let i=0,r=0,s=0,o=0;for(let a=0,l=e.members.length;a<l;++a){const c=e.members[a],u=this._getTypeSize(c);if(!u)continue;(t=this._getAlias(c.type.name))!==null&&t!==void 0||c.type;const d=u.align,h=u.size;i=this._roundUp(d,i+r),r=h,s=i,o=Math.max(o,d),c.offset=i,c.size=h,this._updateTypeInfo(c.type)}e.size=this._roundUp(o,s+r),e.align=o}_getTypeSize(e){var t,i;if(e==null)return null;const r=this._getAttributeNum(e.attributes,"size",0),s=this._getAttributeNum(e.attributes,"align",0);if(e instanceof Gd&&(e=e.type),e instanceof Qe){const o=this._getAlias(e.name);o!==null&&(e=o)}{const o=vt._typeInfo[e.name];if(o!==void 0){const a=((t=e.format)===null||t===void 0?void 0:t.name)==="f16"?2:1;return new Pr(Math.max(s,o.align/a),Math.max(r,o.size/a))}}{const o=vt._typeInfo[e.name.substring(0,e.name.length-1)];if(o){const a=e.name[e.name.length-1]==="h"?2:1;return new Pr(Math.max(s,o.align/a),Math.max(r,o.size/a))}}if(e instanceof Kt){let o=e,a=8,l=8;const c=this._getTypeSize(o.format);return c!==null&&(l=c.size,a=c.align),l=o.count*this._getAttributeNum((i=e==null?void 0:e.attributes)!==null&&i!==void 0?i:null,"stride",this._roundUp(a,l)),r&&(l=r),new Pr(Math.max(s,a),Math.max(r,l))}if(e instanceof jt){let o=0,a=0,l=0,c=0,u=0;for(const d of e.members){const h=this._getTypeSize(d.type);h!==null&&(o=Math.max(h.align,o),l=this._roundUp(h.align,l+c),c=h.size,u=l)}return a=this._roundUp(o,u+c),new Pr(Math.max(s,o),Math.max(r,a))}return null}_isUniformVar(e){return e instanceof Pt&&e.storage=="uniform"}_isStorageVar(e){return e instanceof Pt&&e.storage=="storage"}_isTextureVar(e){return e instanceof Pt&&e.type!==null&&vt._textureTypes.indexOf(e.type.name)!=-1}_isSamplerVar(e){return e instanceof Pt&&e.type!==null&&vt._samplerTypes.indexOf(e.type.name)!=-1}_getAttribute(e,t){const i=e;if(!i||!i.attributes)return null;const r=i.attributes;for(let s of r)if(s.name==t)return s;return null}_getAttributeNum(e,t,i){if(e===null)return i;for(let r of e)if(r.name==t){let s=r!==null&&r.value!==null?r.value:i;return s instanceof Array&&(s=s[0]),typeof s=="number"?s:typeof s=="string"?parseInt(s):i}return i}_roundUp(e,t){return Math.ceil(t/e)*e}}vt._typeInfo={f16:{align:2,size:2},i32:{align:4,size:4},u32:{align:4,size:4},f32:{align:4,size:4},atomic:{align:4,size:4},vec2:{align:8,size:8},vec3:{align:16,size:12},vec4:{align:16,size:16},mat2x2:{align:8,size:16},mat3x2:{align:8,size:24},mat4x2:{align:8,size:32},mat2x3:{align:16,size:32},mat3x3:{align:16,size:48},mat4x3:{align:16,size:64},mat2x4:{align:16,size:32},mat3x4:{align:16,size:48},mat4x4:{align:16,size:64}},vt._textureTypes=v.any_texture_type.map(n=>n.name),vt._samplerTypes=v.sampler_type.map(n=>n.name);let Wc=0;class Hc{constructor(e,t,i){this.id=Wc++,this.name=e,this.value=t,this.node=i}clone(){return new Hc(this.name,this.value,this.node)}}class jc{constructor(e){this.id=Wc++,this.name=e.name,this.node=e}clone(){return new jc(this.node)}}class Xc{constructor(e){this.parent=null,this.variables=new Map,this.functions=new Map,this.currentFunctionName="",this.id=Wc++,e&&(this.parent=e,this.currentFunctionName=e.currentFunctionName)}getVariable(e){var t;return this.variables.has(e)?(t=this.variables.get(e))!==null&&t!==void 0?t:null:this.parent?this.parent.getVariable(e):null}getFunction(e){var t;return this.functions.has(e)?(t=this.functions.get(e))!==null&&t!==void 0?t:null:this.parent?this.parent.getFunction(e):null}createVariable(e,t,i){this.variables.set(e,new Hc(e,t,i??null))}setVariable(e,t,i){const r=this.getVariable(e);r!==null?r.value=t:this.createVariable(e,t,i)}getVariableValue(e){var t;const i=this.getVariable(e);return(t=i==null?void 0:i.value)!==null&&t!==void 0?t:null}clone(){return new Xc(this)}}class d2{evalExpression(e,t){return null}getTypeInfo(e){return null}getVariableName(e,t){return""}}class h2{constructor(e){this.exec=e}getTypeInfo(e){return this.exec.getTypeInfo(e)}All(e,t){const i=this.exec.evalExpression(e.args[0],t);let r=!0;if(i instanceof T)return i.data.forEach(s=>{s||(r=!1)}),new E(r?1:0,this.getTypeInfo("bool"));throw new Error(`All() expects a vector argument. Line ${e.line}`)}Any(e,t){const i=this.exec.evalExpression(e.args[0],t);if(i instanceof T){const r=i.data.some(s=>s);return new E(r?1:0,this.getTypeInfo("bool"))}throw new Error(`Any() expects a vector argument. Line ${e.line}`)}Select(e,t){const i=this.exec.evalExpression(e.args[2],t);if(!(i instanceof E))throw new Error(`Select() expects a bool condition. Line ${e.line}`);return i.value?this.exec.evalExpression(e.args[1],t):this.exec.evalExpression(e.args[0],t)}ArrayLength(e,t){let i=e.args[0];i instanceof ye&&(i=i.right);const r=this.exec.evalExpression(i,t);if(r instanceof pe&&r.typeInfo.size===0){const s=r.typeInfo,o=r.buffer.byteLength/s.stride;return new E(o,this.getTypeInfo("u32"))}return new E(r.typeInfo.size,this.getTypeInfo("u32"))}Abs(e,t){const i=this.exec.evalExpression(e.args[0],t);if(i instanceof T)return new T(i.data.map(s=>Math.abs(s)),i.typeInfo);const r=i;return new E(Math.abs(r.value),r.typeInfo)}Acos(e,t){const i=this.exec.evalExpression(e.args[0],t);if(i instanceof T)return new T(i.data.map(s=>Math.acos(s)),i.typeInfo);const r=i;return new E(Math.acos(r.value),i.typeInfo)}Acosh(e,t){const i=this.exec.evalExpression(e.args[0],t);if(i instanceof T)return new T(i.data.map(s=>Math.acosh(s)),i.typeInfo);const r=i;return new E(Math.acosh(r.value),i.typeInfo)}Asin(e,t){const i=this.exec.evalExpression(e.args[0],t);if(i instanceof T)return new T(i.data.map(s=>Math.asin(s)),i.typeInfo);const r=i;return new E(Math.asin(r.value),i.typeInfo)}Asinh(e,t){const i=this.exec.evalExpression(e.args[0],t);if(i instanceof T)return new T(i.data.map(s=>Math.asinh(s)),i.typeInfo);const r=i;return new E(Math.asinh(r.value),i.typeInfo)}Atan(e,t){const i=this.exec.evalExpression(e.args[0],t);if(i instanceof T)return new T(i.data.map(s=>Math.atan(s)),i.typeInfo);const r=i;return new E(Math.atan(r.value),i.typeInfo)}Atanh(e,t){const i=this.exec.evalExpression(e.args[0],t);if(i instanceof T)return new T(i.data.map(s=>Math.atanh(s)),i.typeInfo);const r=i;return new E(Math.atanh(r.value),i.typeInfo)}Atan2(e,t){const i=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t);if(i instanceof T&&r instanceof T)return new T(i.data.map((a,l)=>Math.atan2(a,r.data[l])),i.typeInfo);const s=i,o=r;return new E(Math.atan2(s.value,o.value),i.typeInfo)}Ceil(e,t){const i=this.exec.evalExpression(e.args[0],t);if(i instanceof T)return new T(i.data.map(s=>Math.ceil(s)),i.typeInfo);const r=i;return new E(Math.ceil(r.value),i.typeInfo)}_clamp(e,t,i){return Math.min(Math.max(e,t),i)}Clamp(e,t){const i=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t),s=this.exec.evalExpression(e.args[2],t);if(i instanceof T&&r instanceof T&&s instanceof T)return new T(i.data.map((c,u)=>this._clamp(c,r.data[u],s.data[u])),i.typeInfo);const o=i,a=r,l=s;return new E(this._clamp(o.value,a.value,l.value),i.typeInfo)}Cos(e,t){const i=this.exec.evalExpression(e.args[0],t);if(i instanceof T)return new T(i.data.map(s=>Math.cos(s)),i.typeInfo);const r=i;return new E(Math.cos(r.value),i.typeInfo)}Cosh(e,t){const i=this.exec.evalExpression(e.args[0],t);if(i instanceof T)return new T(i.data.map(s=>Math.cosh(s)),i.typeInfo);const r=i;return new E(Math.cos(r.value),i.typeInfo)}CountLeadingZeros(e,t){const i=this.exec.evalExpression(e.args[0],t);if(i instanceof T)return new T(i.data.map(s=>Math.clz32(s)),i.typeInfo);const r=i;return new E(Math.clz32(r.value),i.typeInfo)}_countOneBits(e){let t=0;for(;e!==0;)1&e&&t++,e>>=1;return t}CountOneBits(e,t){const i=this.exec.evalExpression(e.args[0],t);if(i instanceof T)return new T(i.data.map(s=>this._countOneBits(s)),i.typeInfo);const r=i;return new E(this._countOneBits(r.value),i.typeInfo)}_countTrailingZeros(e){if(e===0)return 32;let t=0;for(;!(1&e);)e>>=1,t++;return t}CountTrailingZeros(e,t){const i=this.exec.evalExpression(e.args[0],t);if(i instanceof T)return new T(i.data.map(s=>this._countTrailingZeros(s)),i.typeInfo);const r=i;return new E(this._countTrailingZeros(r.value),i.typeInfo)}Cross(e,t){const i=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t);if(i instanceof T&&r instanceof T){if(i.data.length!==3||r.data.length!==3)return console.error(`Cross() expects 3D vectors. Line ${e.line}`),null;const s=i.data,o=r.data;return new T([s[1]*o[2]-o[1]*s[2],s[2]*o[0]-o[2]*s[0],s[0]*o[1]-o[0]*s[1]],i.typeInfo)}return console.error(`Cross() expects vector arguments. Line ${e.line}`),null}Degrees(e,t){const i=this.exec.evalExpression(e.args[0],t),r=180/Math.PI;return i instanceof T?new T(i.data.map(s=>s*r),i.typeInfo):new E(i.value*r,this.getTypeInfo("f32"))}Determinant(e,t){const i=this.exec.evalExpression(e.args[0],t);if(i instanceof j){const r=i.data,s=i.typeInfo.getTypeName(),o=s.endsWith("h")?this.getTypeInfo("f16"):this.getTypeInfo("f32");if(s==="mat2x2"||s==="mat2x2f"||s==="mat2x2h")return new E(r[0]*r[3]-r[1]*r[2],o);if(s==="mat2x3"||s==="mat2x3f"||s==="mat2x3h")return new E(r[0]*(r[4]*r[8]-r[5]*r[7])-r[1]*(r[3]*r[8]-r[5]*r[6])+r[2]*(r[3]*r[7]-r[4]*r[6]),o);if(s==="mat2x4"||s==="mat2x4f"||s==="mat2x4h")console.error(`TODO: Determinant for ${s}`);else if(s==="mat3x2"||s==="mat3x2f"||s==="mat3x2h")console.error(`TODO: Determinant for ${s}`);else{if(s==="mat3x3"||s==="mat3x3f"||s==="mat3x3h")return new E(r[0]*(r[4]*r[8]-r[5]*r[7])-r[1]*(r[3]*r[8]-r[5]*r[6])+r[2]*(r[3]*r[7]-r[4]*r[6]),o);s==="mat3x4"||s==="mat3x4f"||s==="mat3x4h"||s==="mat4x2"||s==="mat4x2f"||s==="mat4x2h"||s==="mat4x3"||s==="mat4x3f"||s==="mat4x3h"?console.error(`TODO: Determinant for ${s}`):s!=="mat4x4"&&s!=="mat4x4f"&&s!=="mat4x4h"||console.error(`TODO: Determinant for ${s}`)}}return console.error(`Determinant expects a matrix argument. Line ${e.line}`),null}Distance(e,t){const i=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t);if(i instanceof T&&r instanceof T){let a=0;for(let l=0;l<i.data.length;++l)a+=(i.data[l]-r.data[l])*(i.data[l]-r.data[l]);return new E(Math.sqrt(a),this.getTypeInfo("f32"))}const s=i,o=r;return new E(Math.abs(s.value-o.value),i.typeInfo)}_dot(e,t){let i=0;for(let r=0;r<e.length;++r)i+=t[r]*e[r];return i}Dot(e,t){const i=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t);return i instanceof T&&r instanceof T?new E(this._dot(i.data,r.data),this.getTypeInfo("f32")):(console.error(`Dot() expects vector arguments. Line ${e.line}`),null)}Dot4U8Packed(e,t){return console.error(`TODO: dot4U8Packed. Line ${e.line}`),null}Dot4I8Packed(e,t){return console.error(`TODO: dot4I8Packed. Line ${e.line}`),null}Exp(e,t){const i=this.exec.evalExpression(e.args[0],t);if(i instanceof T)return new T(i.data.map(s=>Math.exp(s)),i.typeInfo);const r=i;return new E(Math.exp(r.value),i.typeInfo)}Exp2(e,t){const i=this.exec.evalExpression(e.args[0],t);if(i instanceof T)return new T(i.data.map(s=>Math.pow(2,s)),i.typeInfo);const r=i;return new E(Math.pow(2,r.value),i.typeInfo)}ExtractBits(e,t){const i=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t),s=this.exec.evalExpression(e.args[2],t);if(r.typeInfo.name!=="u32"&&r.typeInfo.name!=="x32")return console.error(`ExtractBits() expects an i32 offset argument. Line ${e.line}`),null;if(s.typeInfo.name!=="u32"&&s.typeInfo.name!=="x32")return console.error(`ExtractBits() expects an i32 count argument. Line ${e.line}`),null;const o=r.value,a=s.value;if(i instanceof T)return new T(i.data.map(c=>c>>o&(1<<a)-1),i.typeInfo);if(i.typeInfo.name!=="i32"&&i.typeInfo.name!=="x32")return console.error(`ExtractBits() expects an i32 argument. Line ${e.line}`),null;const l=i.value;return new E(l>>o&(1<<a)-1,this.getTypeInfo("i32"))}FaceForward(e,t){const i=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t),s=this.exec.evalExpression(e.args[2],t);if(i instanceof T&&r instanceof T&&s instanceof T){const o=this._dot(r.data,s.data);return new T(o<0?Array.from(i.data):i.data.map(a=>-a),i.typeInfo)}return console.error(`FaceForward() expects vector arguments. Line ${e.line}`),null}_firstLeadingBit(e){return e===0?-1:31-Math.clz32(e)}FirstLeadingBit(e,t){const i=this.exec.evalExpression(e.args[0],t);if(i instanceof T)return new T(i.data.map(s=>this._firstLeadingBit(s)),i.typeInfo);const r=i;return new E(this._firstLeadingBit(r.value),i.typeInfo)}_firstTrailingBit(e){return e===0?-1:Math.log2(e&-e)}FirstTrailingBit(e,t){const i=this.exec.evalExpression(e.args[0],t);if(i instanceof T)return new T(i.data.map(s=>this._firstTrailingBit(s)),i.typeInfo);const r=i;return new E(this._firstTrailingBit(r.value),i.typeInfo)}Floor(e,t){const i=this.exec.evalExpression(e.args[0],t);if(i instanceof T)return new T(i.data.map(s=>Math.floor(s)),i.typeInfo);const r=i;return new E(Math.floor(r.value),i.typeInfo)}Fma(e,t){const i=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t),s=this.exec.evalExpression(e.args[2],t);if(i instanceof T&&r instanceof T&&s instanceof T)return i.data.length!==r.data.length||i.data.length!==s.data.length?(console.error(`Fma() expects vectors of the same length. Line ${e.line}`),null):new T(i.data.map((c,u)=>c*r.data[u]+s.data[u]),i.typeInfo);const o=i,a=r,l=s;return new E(o.value*a.value+l.value,o.typeInfo)}Fract(e,t){const i=this.exec.evalExpression(e.args[0],t);if(i instanceof T)return new T(i.data.map(s=>s-Math.floor(s)),i.typeInfo);const r=i;return new E(r.value-Math.floor(r.value),i.typeInfo)}Frexp(e,t){return console.error(`TODO: frexp. Line ${e.line}`),null}InsertBits(e,t){const i=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t),s=this.exec.evalExpression(e.args[2],t),o=this.exec.evalExpression(e.args[3],t);if(s.typeInfo.name!=="u32"&&s.typeInfo.name!=="x32")return console.error(`InsertBits() expects an i32 offset argument. Line ${e.line}`),null;const a=s.value,l=(1<<o.value)-1<<a,c=~l;if(i instanceof T&&r instanceof T)return new T(i.data.map((h,f)=>h&c|r.data[f]<<a&l),i.typeInfo);const u=i.value,d=r.value;return new E(u&c|d<<a&l,i.typeInfo)}InverseSqrt(e,t){const i=this.exec.evalExpression(e.args[0],t);if(i instanceof T)return new T(i.data.map(s=>1/Math.sqrt(s)),i.typeInfo);const r=i;return new E(1/Math.sqrt(r.value),i.typeInfo)}Ldexp(e,t){return console.error(`TODO: ldexp. Line ${e.line}`),null}Length(e,t){const i=this.exec.evalExpression(e.args[0],t);if(i instanceof T){let s=0;return i.data.forEach(o=>{s+=o*o}),new E(Math.sqrt(s),this.getTypeInfo("f32"))}const r=i;return new E(Math.abs(r.value),i.typeInfo)}Log(e,t){const i=this.exec.evalExpression(e.args[0],t);if(i instanceof T)return new T(i.data.map(s=>Math.log(s)),i.typeInfo);const r=i;return new E(Math.log(r.value),i.typeInfo)}Log2(e,t){const i=this.exec.evalExpression(e.args[0],t);if(i instanceof T)return new T(i.data.map(s=>Math.log2(s)),i.typeInfo);const r=i;return new E(Math.log2(r.value),i.typeInfo)}Max(e,t){const i=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t);if(i instanceof T&&r instanceof T)return new T(i.data.map((a,l)=>Math.max(a,r.data[l])),i.typeInfo);const s=i,o=r;return new E(Math.max(s.value,o.value),i.typeInfo)}Min(e,t){const i=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t);if(i instanceof T&&r instanceof T)return new T(i.data.map((a,l)=>Math.min(a,r.data[l])),i.typeInfo);const s=i,o=r;return new E(Math.min(s.value,o.value),i.typeInfo)}Mix(e,t){const i=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t),s=this.exec.evalExpression(e.args[2],t);if(i instanceof T&&r instanceof T&&s instanceof T)return new T(i.data.map((l,c)=>i.data[c]*(1-s.data[c])+r.data[c]*s.data[c]),i.typeInfo);const o=r,a=s;return new E(i.value*(1-a.value)+o.value*a.value,i.typeInfo)}Modf(e,t){const i=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t);if(i instanceof T&&r instanceof T)return new T(i.data.map((o,a)=>o%r.data[a]),i.typeInfo);const s=r;return new E(i.value%s.value,i.typeInfo)}Normalize(e,t){const i=this.exec.evalExpression(e.args[0],t);if(i instanceof T){const r=this.Length(e,t).value;return new T(i.data.map(s=>s/r),i.typeInfo)}return console.error(`Normalize() expects a vector argument. Line ${e.line}`),null}Pow(e,t){const i=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t);if(i instanceof T&&r instanceof T)return new T(i.data.map((a,l)=>Math.pow(a,r.data[l])),i.typeInfo);const s=i,o=r;return new E(Math.pow(s.value,o.value),i.typeInfo)}QuantizeToF16(e,t){const i=this.exec.evalExpression(e.args[0],t);return i instanceof T?new T(i.data.map(r=>r),i.typeInfo):new E(i.value,i.typeInfo)}Radians(e,t){const i=this.exec.evalExpression(e.args[0],t);return i instanceof T?new T(i.data.map(r=>r*Math.PI/180),i.typeInfo):new E(i.value*Math.PI/180,this.getTypeInfo("f32"))}Reflect(e,t){let i=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t);if(i instanceof T&&r instanceof T){const s=this._dot(i.data,r.data);return new T(i.data.map((o,a)=>o-2*s*r.data[a]),i.typeInfo)}return console.error(`Reflect() expects vector arguments. Line ${e.line}`),null}Refract(e,t){let i=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t),s=this.exec.evalExpression(e.args[2],t);if(i instanceof T&&r instanceof T&&s instanceof E){const o=this._dot(r.data,i.data);return new T(i.data.map((a,l)=>{const c=1-s.value*s.value*(1-o*o);if(c<0)return 0;const u=Math.sqrt(c);return s.value*a-(s.value*o+u)*r.data[l]}),i.typeInfo)}return console.error(`Refract() expects vector arguments and a scalar argument. Line ${e.line}`),null}ReverseBits(e,t){return console.error(`TODO: reverseBits. Line ${e.line}`),null}Round(e,t){const i=this.exec.evalExpression(e.args[0],t);if(i instanceof T)return new T(i.data.map(s=>Math.round(s)),i.typeInfo);const r=i;return new E(Math.round(r.value),i.typeInfo)}Saturate(e,t){const i=this.exec.evalExpression(e.args[0],t);if(i instanceof T)return new T(i.data.map(s=>Math.min(Math.max(s,0),1)),i.typeInfo);const r=i;return new E(Math.min(Math.max(r.value,0),1),i.typeInfo)}Sign(e,t){const i=this.exec.evalExpression(e.args[0],t);if(i instanceof T)return new T(i.data.map(s=>Math.sign(s)),i.typeInfo);const r=i;return new E(Math.sign(r.value),i.typeInfo)}Sin(e,t){const i=this.exec.evalExpression(e.args[0],t);if(i instanceof T)return new T(i.data.map(s=>Math.sin(s)),i.typeInfo);const r=i;return new E(Math.sin(r.value),i.typeInfo)}Sinh(e,t){const i=this.exec.evalExpression(e.args[0],t);if(i instanceof T)return new T(i.data.map(s=>Math.sinh(s)),i.typeInfo);const r=i;return new E(Math.sinh(r.value),i.typeInfo)}_smoothstep(e,t,i){const r=Math.min(Math.max((i-e)/(t-e),0),1);return r*r*(3-2*r)}SmoothStep(e,t){const i=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t),s=this.exec.evalExpression(e.args[2],t);if(s instanceof T&&i instanceof T&&r instanceof T)return new T(s.data.map((c,u)=>this._smoothstep(i.data[u],r.data[u],c)),s.typeInfo);const o=i,a=r,l=s;return new E(this._smoothstep(o.value,a.value,l.value),s.typeInfo)}Sqrt(e,t){const i=this.exec.evalExpression(e.args[0],t);if(i instanceof T)return new T(i.data.map(s=>Math.sqrt(s)),i.typeInfo);const r=i;return new E(Math.sqrt(r.value),i.typeInfo)}Step(e,t){const i=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t);if(r instanceof T&&i instanceof T)return new T(r.data.map((o,a)=>o<i.data[a]?0:1),r.typeInfo);const s=i;return new E(r.value<s.value?0:1,s.typeInfo)}Tan(e,t){const i=this.exec.evalExpression(e.args[0],t);if(i instanceof T)return new T(i.data.map(s=>Math.tan(s)),i.typeInfo);const r=i;return new E(Math.tan(r.value),i.typeInfo)}Tanh(e,t){const i=this.exec.evalExpression(e.args[0],t);if(i instanceof T)return new T(i.data.map(s=>Math.tanh(s)),i.typeInfo);const r=i;return new E(Math.tanh(r.value),i.typeInfo)}_getTransposeType(e){const t=e.getTypeName();return t==="mat2x2f"||t==="mat2x2h"?e:t==="mat2x3f"?this.getTypeInfo("mat3x2f"):t==="mat2x3h"?this.getTypeInfo("mat3x2h"):t==="mat2x4f"?this.getTypeInfo("mat4x2f"):t==="mat2x4h"?this.getTypeInfo("mat4x2h"):t==="mat3x2f"?this.getTypeInfo("mat2x3f"):t==="mat3x2h"?this.getTypeInfo("mat2x3h"):t==="mat3x3f"||t==="mat3x3h"?e:t==="mat3x4f"?this.getTypeInfo("mat4x3f"):t==="mat3x4h"?this.getTypeInfo("mat4x3h"):t==="mat4x2f"?this.getTypeInfo("mat2x4f"):t==="mat4x2h"?this.getTypeInfo("mat2x4h"):t==="mat4x3f"?this.getTypeInfo("mat3x4f"):t==="mat4x3h"?this.getTypeInfo("mat3x4h"):(t==="mat4x4f"||t==="mat4x4h"||console.error(`Invalid matrix type ${t}`),e)}Transpose(e,t){const i=this.exec.evalExpression(e.args[0],t);if(!(i instanceof j))return console.error(`Transpose() expects a matrix argument. Line ${e.line}`),null;const r=this._getTransposeType(i.typeInfo);if(i.typeInfo.name==="mat2x2"||i.typeInfo.name==="mat2x2f"||i.typeInfo.name==="mat2x2h"){const s=i.data;return new j([s[0],s[2],s[1],s[3]],r)}if(i.typeInfo.name==="mat2x3"||i.typeInfo.name==="mat2x3f"||i.typeInfo.name==="mat2x3h"){const s=i.data;return new j([s[0],s[3],s[6],s[1],s[4],s[7]],r)}if(i.typeInfo.name==="mat2x4"||i.typeInfo.name==="mat2x4f"||i.typeInfo.name==="mat2x4h"){const s=i.data;return new j([s[0],s[4],s[8],s[12],s[1],s[5],s[9],s[13]],r)}if(i.typeInfo.name==="mat3x2"||i.typeInfo.name==="mat3x2f"||i.typeInfo.name==="mat3x2h"){const s=i.data;return new j([s[0],s[3],s[1],s[4],s[2],s[5]],r)}if(i.typeInfo.name==="mat3x3"||i.typeInfo.name==="mat3x3f"||i.typeInfo.name==="mat3x3h"){const s=i.data;return new j([s[0],s[3],s[6],s[1],s[4],s[7],s[2],s[5],s[8]],r)}if(i.typeInfo.name==="mat3x4"||i.typeInfo.name==="mat3x4f"||i.typeInfo.name==="mat3x4h"){const s=i.data;return new j([s[0],s[4],s[8],s[12],s[1],s[5],s[9],s[13],s[2],s[6],s[10],s[14]],r)}if(i.typeInfo.name==="mat4x2"||i.typeInfo.name==="mat4x2f"||i.typeInfo.name==="mat4x2h"){const s=i.data;return new j([s[0],s[4],s[1],s[5],s[2],s[6]],r)}if(i.typeInfo.name==="mat4x3"||i.typeInfo.name==="mat4x3f"||i.typeInfo.name==="mat4x3h"){const s=i.data;return new j([s[0],s[4],s[8],s[1],s[5],s[9],s[2],s[6],s[10]],r)}if(i.typeInfo.name==="mat4x4"||i.typeInfo.name==="mat4x4f"||i.typeInfo.name==="mat4x4h"){const s=i.data;return new j([s[0],s[4],s[8],s[12],s[1],s[5],s[9],s[13],s[2],s[6],s[10],s[14],s[3],s[7],s[11],s[15]],r)}return console.error(`Invalid matrix type ${i.typeInfo.name}`),null}Trunc(e,t){const i=this.exec.evalExpression(e.args[0],t);if(i instanceof T)return new T(i.data.map(s=>Math.trunc(s)),i.typeInfo);const r=i;return new E(Math.trunc(r.value),i.typeInfo)}Dpdx(e,t){return console.error(`TODO: dpdx. Line ${e.line}`),null}DpdxCoarse(e,t){return console.error(`TODO: dpdxCoarse. Line ${e.line}`),null}DpdxFine(e,t){return console.error("TODO: dpdxFine"),null}Dpdy(e,t){return console.error("TODO: dpdy"),null}DpdyCoarse(e,t){return console.error("TODO: dpdyCoarse"),null}DpdyFine(e,t){return console.error("TODO: dpdyFine"),null}Fwidth(e,t){return console.error("TODO: fwidth"),null}FwidthCoarse(e,t){return console.error("TODO: fwidthCoarse"),null}FwidthFine(e,t){return console.error("TODO: fwidthFine"),null}TextureDimensions(e,t){const i=e.args[0],r=e.args.length>1?this.exec.evalExpression(e.args[1],t).value:0;if(i instanceof je){const s=i.name,o=t.getVariableValue(s);if(o instanceof Rt){if(r<0||r>=o.mipLevelCount)return console.error(`Invalid mip level for textureDimensions. Line ${e.line}`),null;const a=o.getMipLevelSize(r),l=o.dimension;return l==="1d"?new E(a[0],this.getTypeInfo("u32")):l==="3d"?new T(a,this.getTypeInfo("vec3u")):l==="2d"?new T(a.slice(0,2),this.getTypeInfo("vec2u")):(console.error(`Invalid texture dimension ${l} not found. Line ${e.line}`),null)}return console.error(`Texture ${s} not found. Line ${e.line}`),null}return console.error(`Invalid texture argument for textureDimensions. Line ${e.line}`),null}TextureGather(e,t){return console.error("TODO: textureGather"),null}TextureGatherCompare(e,t){return console.error("TODO: textureGatherCompare"),null}TextureLoad(e,t){const i=e.args[0],r=this.exec.evalExpression(e.args[1],t),s=e.args.length>2?this.exec.evalExpression(e.args[2],t).value:0;if(!(r instanceof T)||r.data.length!==2)return console.error(`Invalid UV argument for textureLoad. Line ${e.line}`),null;if(i instanceof je){const o=i.name,a=t.getVariableValue(o);if(a instanceof Rt){const l=Math.floor(r.data[0]),c=Math.floor(r.data[1]);if(l<0||l>=a.width||c<0||c>=a.height)return console.error(`Texture ${o} out of bounds. Line ${e.line}`),null;const u=a.getPixel(l,c,0,s);return u===null?(console.error(`Invalid texture format for textureLoad. Line ${e.line}`),null):new T(u,this.getTypeInfo("vec4f"))}return console.error(`Texture ${o} not found. Line ${e.line}`),null}return console.error(`Invalid texture argument for textureLoad. Line ${e.line}`),null}TextureNumLayers(e,t){const i=e.args[0];if(i instanceof je){const r=i.name,s=t.getVariableValue(r);return s instanceof Rt?new E(s.depthOrArrayLayers,this.getTypeInfo("u32")):(console.error(`Texture ${r} not found. Line ${e.line}`),null)}return console.error(`Invalid texture argument for textureNumLayers. Line ${e.line}`),null}TextureNumLevels(e,t){const i=e.args[0];if(i instanceof je){const r=i.name,s=t.getVariableValue(r);return s instanceof Rt?new E(s.mipLevelCount,this.getTypeInfo("u32")):(console.error(`Texture ${r} not found. Line ${e.line}`),null)}return console.error(`Invalid texture argument for textureNumLevels. Line ${e.line}`),null}TextureNumSamples(e,t){const i=e.args[0];if(i instanceof je){const r=i.name,s=t.getVariableValue(r);return s instanceof Rt?new E(s.sampleCount,this.getTypeInfo("u32")):(console.error(`Texture ${r} not found. Line ${e.line}`),null)}return console.error(`Invalid texture argument for textureNumSamples. Line ${e.line}`),null}TextureSample(e,t){return console.error("TODO: textureSample"),null}TextureSampleBias(e,t){return console.error("TODO: textureSampleBias"),null}TextureSampleCompare(e,t){return console.error("TODO: textureSampleCompare"),null}TextureSampleCompareLevel(e,t){return console.error("TODO: textureSampleCompareLevel"),null}TextureSampleGrad(e,t){return console.error("TODO: textureSampleGrad"),null}TextureSampleLevel(e,t){return console.error("TODO: textureSampleLevel"),null}TextureSampleBaseClampToEdge(e,t){return console.error("TODO: textureSampleBaseClampToEdge"),null}TextureStore(e,t){const i=e.args[0],r=this.exec.evalExpression(e.args[1],t),s=e.args.length===4?this.exec.evalExpression(e.args[2],t).value:0,o=e.args.length===4?this.exec.evalExpression(e.args[3],t).data:this.exec.evalExpression(e.args[2],t).data;if(o.length!==4)return console.error(`Invalid value argument for textureStore. Line ${e.line}`),null;if(!(r instanceof T)||r.data.length!==2)return console.error(`Invalid UV argument for textureStore. Line ${e.line}`),null;if(i instanceof je){const a=i.name,l=t.getVariableValue(a);if(l instanceof Rt){const c=l.getMipLevelSize(0),u=Math.floor(r.data[0]),d=Math.floor(r.data[1]);return u<0||u>=c[0]||d<0||d>=c[1]?(console.error(`Texture ${a} out of bounds. Line ${e.line}`),null):(l.setPixel(u,d,0,s,Array.from(o)),null)}return console.error(`Texture ${a} not found. Line ${e.line}`),null}return console.error(`Invalid texture argument for textureStore. Line ${e.line}`),null}AtomicLoad(e,t){let i=e.args[0];i instanceof ye&&(i=i.right);const r=this.exec.getVariableName(i,t);return t.getVariable(r).value.getSubData(this.exec,i.postfix,t)}AtomicStore(e,t){let i=e.args[0];i instanceof ye&&(i=i.right);const r=this.exec.getVariableName(i,t),s=t.getVariable(r);let o=e.args[1];const a=this.exec.evalExpression(o,t),l=s.value.getSubData(this.exec,i.postfix,t);return l instanceof E&&a instanceof E&&(l.value=a.value),s.value instanceof pe&&s.value.setDataValue(this.exec,l,i.postfix,t),null}AtomicAdd(e,t){let i=e.args[0];i instanceof ye&&(i=i.right);const r=this.exec.getVariableName(i,t),s=t.getVariable(r);let o=e.args[1];const a=this.exec.evalExpression(o,t),l=s.value.getSubData(this.exec,i.postfix,t),c=new E(l.value,l.typeInfo);return l instanceof E&&a instanceof E&&(l.value+=a.value),s.value instanceof pe&&s.value.setDataValue(this.exec,l,i.postfix,t),c}AtomicSub(e,t){let i=e.args[0];i instanceof ye&&(i=i.right);const r=this.exec.getVariableName(i,t),s=t.getVariable(r);let o=e.args[1];const a=this.exec.evalExpression(o,t),l=s.value.getSubData(this.exec,i.postfix,t),c=new E(l.value,l.typeInfo);return l instanceof E&&a instanceof E&&(l.value-=a.value),s.value instanceof pe&&s.value.setDataValue(this.exec,l,i.postfix,t),c}AtomicMax(e,t){let i=e.args[0];i instanceof ye&&(i=i.right);const r=this.exec.getVariableName(i,t),s=t.getVariable(r);let o=e.args[1];const a=this.exec.evalExpression(o,t),l=s.value.getSubData(this.exec,i.postfix,t),c=new E(l.value,l.typeInfo);return l instanceof E&&a instanceof E&&(l.value=Math.max(l.value,a.value)),s.value instanceof pe&&s.value.setDataValue(this.exec,l,i.postfix,t),c}AtomicMin(e,t){let i=e.args[0];i instanceof ye&&(i=i.right);const r=this.exec.getVariableName(i,t),s=t.getVariable(r);let o=e.args[1];const a=this.exec.evalExpression(o,t),l=s.value.getSubData(this.exec,i.postfix,t),c=new E(l.value,l.typeInfo);return l instanceof E&&a instanceof E&&(l.value=Math.min(l.value,a.value)),s.value instanceof pe&&s.value.setDataValue(this.exec,l,i.postfix,t),c}AtomicAnd(e,t){let i=e.args[0];i instanceof ye&&(i=i.right);const r=this.exec.getVariableName(i,t),s=t.getVariable(r);let o=e.args[1];const a=this.exec.evalExpression(o,t),l=s.value.getSubData(this.exec,i.postfix,t),c=new E(l.value,l.typeInfo);return l instanceof E&&a instanceof E&&(l.value=l.value&a.value),s.value instanceof pe&&s.value.setDataValue(this.exec,l,i.postfix,t),c}AtomicOr(e,t){let i=e.args[0];i instanceof ye&&(i=i.right);const r=this.exec.getVariableName(i,t),s=t.getVariable(r);let o=e.args[1];const a=this.exec.evalExpression(o,t),l=s.value.getSubData(this.exec,i.postfix,t),c=new E(l.value,l.typeInfo);return l instanceof E&&a instanceof E&&(l.value=l.value|a.value),s.value instanceof pe&&s.value.setDataValue(this.exec,l,i.postfix,t),c}AtomicXor(e,t){let i=e.args[0];i instanceof ye&&(i=i.right);const r=this.exec.getVariableName(i,t),s=t.getVariable(r);let o=e.args[1];const a=this.exec.evalExpression(o,t),l=s.value.getSubData(this.exec,i.postfix,t),c=new E(l.value,l.typeInfo);return l instanceof E&&a instanceof E&&(l.value=l.value^a.value),s.value instanceof pe&&s.value.setDataValue(this.exec,l,i.postfix,t),c}AtomicExchange(e,t){let i=e.args[0];i instanceof ye&&(i=i.right);const r=this.exec.getVariableName(i,t),s=t.getVariable(r);let o=e.args[1];const a=this.exec.evalExpression(o,t),l=s.value.getSubData(this.exec,i.postfix,t),c=new E(l.value,l.typeInfo);return l instanceof E&&a instanceof E&&(l.value=a.value),s.value instanceof pe&&s.value.setDataValue(this.exec,l,i.postfix,t),c}AtomicCompareExchangeWeak(e,t){return console.error("TODO: atomicCompareExchangeWeak"),null}Pack4x8snorm(e,t){return console.error("TODO: pack4x8snorm"),null}Pack4x8unorm(e,t){return console.error("TODO: pack4x8unorm"),null}Pack4xI8(e,t){return console.error("TODO: pack4xI8"),null}Pack4xU8(e,t){return console.error("TODO: pack4xU8"),null}Pack4x8Clamp(e,t){return console.error("TODO: pack4x8Clamp"),null}Pack4xU8Clamp(e,t){return console.error("TODO: pack4xU8Clamp"),null}Pack2x16snorm(e,t){return console.error("TODO: pack2x16snorm"),null}Pack2x16unorm(e,t){return console.error("TODO: pack2x16unorm"),null}Pack2x16float(e,t){return console.error("TODO: pack2x16float"),null}Unpack4x8snorm(e,t){return console.error("TODO: unpack4x8snorm"),null}Unpack4x8unorm(e,t){return console.error("TODO: unpack4x8unorm"),null}Unpack4xI8(e,t){return console.error("TODO: unpack4xI8"),null}Unpack4xU8(e,t){return console.error("TODO: unpack4xU8"),null}Unpack2x16snorm(e,t){return console.error("TODO: unpack2x16snorm"),null}Unpack2x16unorm(e,t){return console.error("TODO: unpack2x16unorm"),null}Unpack2x16float(e,t){return console.error("TODO: unpack2x16float"),null}StorageBarrier(e,t){return null}TextureBarrier(e,t){return null}WorkgroupBarrier(e,t){return null}WorkgroupUniformLoad(e,t){return null}SubgroupAdd(e,t){return console.error("TODO: subgroupAdd"),null}SubgroupExclusiveAdd(e,t){return console.error("TODO: subgroupExclusiveAdd"),null}SubgroupInclusiveAdd(e,t){return console.error("TODO: subgroupInclusiveAdd"),null}SubgroupAll(e,t){return console.error("TODO: subgroupAll"),null}SubgroupAnd(e,t){return console.error("TODO: subgroupAnd"),null}SubgroupAny(e,t){return console.error("TODO: subgroupAny"),null}SubgroupBallot(e,t){return console.error("TODO: subgroupBallot"),null}SubgroupBroadcast(e,t){return console.error("TODO: subgroupBroadcast"),null}SubgroupBroadcastFirst(e,t){return console.error("TODO: subgroupBroadcastFirst"),null}SubgroupElect(e,t){return console.error("TODO: subgroupElect"),null}SubgroupMax(e,t){return console.error("TODO: subgroupMax"),null}SubgroupMin(e,t){return console.error("TODO: subgroupMin"),null}SubgroupMul(e,t){return console.error("TODO: subgroupMul"),null}SubgroupExclusiveMul(e,t){return console.error("TODO: subgroupExclusiveMul"),null}SubgroupInclusiveMul(e,t){return console.error("TODO: subgroupInclusiveMul"),null}SubgroupOr(e,t){return console.error("TODO: subgroupOr"),null}SubgroupShuffle(e,t){return console.error("TODO: subgroupShuffle"),null}SubgroupShuffleDown(e,t){return console.error("TODO: subgroupShuffleDown"),null}SubgroupShuffleUp(e,t){return console.error("TODO: subgroupShuffleUp"),null}SubgroupShuffleXor(e,t){return console.error("TODO: subgroupShuffleXor"),null}SubgroupXor(e,t){return console.error("TODO: subgroupXor"),null}QuadBroadcast(e,t){return console.error("TODO: quadBroadcast"),null}QuadSwapDiagonal(e,t){return console.error("TODO: quadSwapDiagonal"),null}QuadSwapX(e,t){return console.error("TODO: quadSwapX"),null}QuadSwapY(e,t){return console.error("TODO: quadSwapY"),null}}const ea={vec2:2,vec2f:2,vec2i:2,vec2u:2,vec2b:2,vec2h:2,vec3:3,vec3f:3,vec3i:3,vec3u:3,vec3b:3,vec3h:3,vec4:4,vec4f:4,vec4i:4,vec4u:4,vec4b:4,vec4h:4},Be={mat2x2:[2,2,4],mat2x2f:[2,2,4],mat2x2h:[2,2,4],mat2x3:[2,3,6],mat2x3f:[2,3,6],mat2x3h:[2,3,6],mat2x4:[2,4,8],mat2x4f:[2,4,8],mat2x4h:[2,4,8],mat3x2:[3,2,6],mat3x2f:[3,2,6],mat3x2h:[3,2,6],mat3x3:[3,3,9],mat3x3f:[3,3,9],mat3x3h:[3,3,9],mat3x4:[3,4,12],mat3x4f:[3,4,12],mat3x4h:[3,4,12],mat4x2:[4,2,8],mat4x2f:[4,2,8],mat4x2h:[4,2,8],mat4x3:[4,3,12],mat4x3f:[4,3,12],mat4x3h:[4,3,12],mat4x4:[4,4,16],mat4x4f:[4,4,16],mat4x4h:[4,4,16]};class Fe extends d2{constructor(e,t){var i;super(),this.ast=e??[],this.reflection=new vt,this.reflection.updateAST(this.ast),this.context=(i=t==null?void 0:t.clone())!==null&&i!==void 0?i:new Xc,this.builtins=new h2(this),this.typeInfo={bool:this.getTypeInfo(N.bool),i32:this.getTypeInfo(N.i32),u32:this.getTypeInfo(N.u32),f32:this.getTypeInfo(N.f32),f16:this.getTypeInfo(N.f16),vec2f:this.getTypeInfo(R.vec2f),vec2u:this.getTypeInfo(R.vec2u),vec2i:this.getTypeInfo(R.vec2i),vec2h:this.getTypeInfo(R.vec2h),vec3f:this.getTypeInfo(R.vec3f),vec3u:this.getTypeInfo(R.vec3u),vec3i:this.getTypeInfo(R.vec3i),vec3h:this.getTypeInfo(R.vec3h),vec4f:this.getTypeInfo(R.vec4f),vec4u:this.getTypeInfo(R.vec4u),vec4i:this.getTypeInfo(R.vec4i),vec4h:this.getTypeInfo(R.vec4h),mat2x2f:this.getTypeInfo(R.mat2x2f),mat2x3f:this.getTypeInfo(R.mat2x3f),mat2x4f:this.getTypeInfo(R.mat2x4f),mat3x2f:this.getTypeInfo(R.mat3x2f),mat3x3f:this.getTypeInfo(R.mat3x3f),mat3x4f:this.getTypeInfo(R.mat3x4f),mat4x2f:this.getTypeInfo(R.mat4x2f),mat4x3f:this.getTypeInfo(R.mat4x3f),mat4x4f:this.getTypeInfo(R.mat4x4f)}}getVariableValue(e){var t,i;const r=(i=(t=this.context.getVariable(e))===null||t===void 0?void 0:t.value)!==null&&i!==void 0?i:null;if(r===null)return null;if(r instanceof E)return r.value;if(r instanceof T||r instanceof j)return Array.from(r.data);if(r instanceof pe&&r.typeInfo instanceof Kt){if(r.typeInfo.format.name==="u32")return Array.from(new Uint32Array(r.buffer,r.offset,r.typeInfo.count));if(r.typeInfo.format.name==="i32")return Array.from(new Int32Array(r.buffer,r.offset,r.typeInfo.count));if(r.typeInfo.format.name==="f32")return Array.from(new Float32Array(r.buffer,r.offset,r.typeInfo.count))}return console.error(`Unsupported return variable type ${r.typeInfo.name}`),null}execute(e){(e=e??{}).constants&&this._setOverrides(e.constants,this.context),this._execStatements(this.ast,this.context)}dispatchWorkgroups(e,t,i,r){const s=this.context.clone();(r=r??{}).constants&&this._setOverrides(r.constants,s),this._execStatements(this.ast,s);const o=s.getFunction(e);if(!o)return void console.error(`Function ${e} not found`);if(typeof t=="number")t=[t,1,1];else{if(t.length===0)return void console.error("Invalid dispatch count");t.length===1?t=[t[0],1,1]:t.length===2?t=[t[0],t[1],1]:t.length>3&&(t=[t[0],t[1],t[2]])}const a=t[0],l=t[1],c=t[2],u=this.getTypeInfo("vec3u");s.setVariable("@num_workgroups",new T(t,u));const d=this.reflection.getFunctionInfo(e);d===null&&console.error(`Function ${e} not found in reflection data`);for(const h in i)for(const f in i[h]){const p=i[h][f];s.variables.forEach(g=>{var _;const b=g.node;if(b!=null&&b.attributes){let w=null,x=null;for(const y of b.attributes)y.name==="binding"?w=y.value:y.name==="group"&&(x=y.value);if(f==w&&h==x){let y=!1;for(const S of d.resources)if(S.name===g.name&&S.group===parseInt(h)&&S.binding===parseInt(f)){y=!0;break}if(y)if(p.texture!==void 0&&p.descriptor!==void 0){const S=new Rt(p.texture,this.getTypeInfo(b.type),p.descriptor,(_=p.texture.view)!==null&&_!==void 0?_:null);g.value=S}else p.uniform!==void 0?g.value=new pe(p.uniform,this.getTypeInfo(b.type)):g.value=new pe(p,this.getTypeInfo(b.type))}}})}for(let h=0;h<c;++h)for(let f=0;f<l;++f)for(let p=0;p<a;++p)s.setVariable("@workgroup_id",new T([p,f,h],this.getTypeInfo("vec3u"))),this._dispatchWorkgroup(o,[p,f,h],s)}execStatement(e,t){if(e instanceof gm)return this.evalExpression(e.value,t);if(e instanceof _m){if(e.condition){const i=this.evalExpression(e.condition,t);if(!(i instanceof E))throw new Error("Invalid break-if condition");if(!i.value)return null}return Fe._breakObj}if(e instanceof ym)return Fe._continueObj;if(e instanceof Mi)this._let(e,t);else if(e instanceof Pt)this._var(e,t);else if(e instanceof Yr)this._const(e,t);else if(e instanceof Yi)this._function(e,t);else{if(e instanceof pm)return this._if(e,t);if(e instanceof fm)return this._switch(e,t);if(e instanceof cm)return this._for(e,t);if(e instanceof lm)return this._while(e,t);if(e instanceof hm)return this._loop(e,t);if(e instanceof ml){const i=t.clone();return i.currentFunctionName=t.currentFunctionName,this._execStatements(e.body,i)}if(e instanceof dm)this._assign(e,t);else if(e instanceof um)this._increment(e,t);else{if(e instanceof It)return null;if(e instanceof Uc){const i=e.name;t.getVariable(i)===null&&t.setVariable(i,new E(0,this.getTypeInfo("u32")))}else if(e instanceof $c)this._call(e,t);else{if(e instanceof mm||e instanceof zc)return null;console.error("Invalid statement type.",e,`Line ${e.line}`)}}}return null}evalExpression(e,t){return e instanceof st?this._evalBinaryOp(e,t):e instanceof we?this._evalLiteral(e,t):e instanceof je?this._evalVariable(e,t):e instanceof Vc?this._evalCall(e,t):e instanceof yt?this._evalCreate(e,t):e instanceof bm?this._evalConst(e,t):e instanceof vm?this._evalBitcast(e,t):e instanceof ye?this._evalUnaryOp(e,t):(console.error("Invalid expression type",e,`Line ${e.line}`),null)}getTypeInfo(e){var t;if(e instanceof N){const r=this.reflection.getTypeInfo(e);if(r!==null)return r}let i=(t=this.typeInfo[e])!==null&&t!==void 0?t:null;return i!==null||(i=this.reflection.getTypeInfoByName(e)),i}_setOverrides(e,t){for(const i in e){const r=e[i],s=this.reflection.getOverrideInfo(i);s!==null?(s.type===null&&(s.type=this.getTypeInfo("u32")),s.type.name==="u32"||s.type.name==="i32"||s.type.name==="f32"||s.type.name==="f16"?t.setVariable(i,new E(r,s.type)):s.type.name==="bool"?t.setVariable(i,new E(r?1:0,s.type)):s.type.name==="vec2"||s.type.name==="vec3"||s.type.name==="vec4"||s.type.name==="vec2f"||s.type.name==="vec3f"||s.type.name==="vec4f"||s.type.name==="vec2i"||s.type.name==="vec3i"||s.type.name==="vec4i"||s.type.name==="vec2u"||s.type.name==="vec3u"||s.type.name==="vec4u"||s.type.name==="vec2h"||s.type.name==="vec3h"||s.type.name==="vec4h"?t.setVariable(i,new T(r,s.type)):console.error(`Invalid constant type for ${i}`)):console.error(`Override ${i} does not exist in the shader.`)}}_dispatchWorkgroup(e,t,i){const r=[1,1,1];for(const u of e.node.attributes)if(u.name==="workgroup_size"){if(u.value.length>0){const d=i.getVariableValue(u.value[0]);r[0]=d instanceof E?d.value:parseInt(u.value[0])}if(u.value.length>1){const d=i.getVariableValue(u.value[1]);r[1]=d instanceof E?d.value:parseInt(u.value[1])}if(u.value.length>2){const d=i.getVariableValue(u.value[2]);r[2]=d instanceof E?d.value:parseInt(u.value[2])}}const s=this.getTypeInfo("vec3u"),o=this.getTypeInfo("u32");i.setVariable("@workgroup_size",new T(r,s));const a=r[0],l=r[1],c=r[2];for(let u=0,d=0;u<c;++u)for(let h=0;h<l;++h)for(let f=0;f<a;++f,++d){const p=[f,h,u],g=[f+t[0]*r[0],h+t[1]*r[1],u+t[2]*r[2]];i.setVariable("@local_invocation_id",new T(p,s)),i.setVariable("@global_invocation_id",new T(g,s)),i.setVariable("@local_invocation_index",new E(d,o)),this._dispatchExec(e,i)}}_dispatchExec(e,t){for(const i of e.node.args)for(const r of i.attributes)if(r.name==="builtin"){const s=`@${r.value}`,o=t.getVariable(s);o!==void 0&&t.variables.set(i.name,o)}this._execStatements(e.node.body,t)}getVariableName(e,t){for(;e instanceof ye;)e=e.right;return e instanceof je?e.name:(console.error("Unknown variable type",e,"Line",e.line),null)}_execStatements(e,t){for(const i of e){if(i instanceof Array){const s=t.clone(),o=this._execStatements(i,s);if(o)return o;continue}const r=this.execStatement(i,t);if(r)return r}return null}_call(e,t){const i=t.clone();i.currentFunctionName=e.name;const r=t.getFunction(e.name);if(r){for(let s=0;s<r.node.args.length;++s){const o=r.node.args[s],a=this.evalExpression(e.args[s],i);i.setVariable(o.name,a,o)}this._execStatements(r.node.body,i)}else e.isBuiltin?this._callBuiltinFunction(e,i):this.getTypeInfo(e.name)&&this._evalCreate(e,t)}_increment(e,t){const i=this.getVariableName(e.variable,t),r=t.getVariable(i);r?e.operator==="++"?r.value instanceof E?r.value.value++:console.error(`Variable ${i} is not a scalar. Line ${e.line}`):e.operator==="--"?r.value instanceof E?r.value.value--:console.error(`Variable ${i} is not a scalar. Line ${e.line}`):console.error(`Unknown increment operator ${e.operator}. Line ${e.line}`):console.error(`Variable ${i} not found. Line ${e.line}`)}_getVariableData(e,t){if(e instanceof je){const i=this.getVariableName(e,t),r=t.getVariable(i);return r===null?(console.error(`Variable ${i} not found. Line ${e.line}`),null):r.value.getSubData(this,e.postfix,t)}if(e instanceof ye){if(e.operator==="*"){const i=this._getVariableData(e.right,t);return i instanceof Mn?i.reference.getSubData(this,e.postfix,t):(console.error(`Variable ${e.right} is not a pointer. Line ${e.line}`),null)}if(e.operator==="&"){const i=this._getVariableData(e.right,t);return new Mn(i)}}return null}_assign(e,t){let i=null,r="<var>",s=null;if(e.variable instanceof ye){const l=this._getVariableData(e.variable,t),c=this.evalExpression(e.value,t),u=e.operator;if(u==="="){if(l instanceof E||l instanceof T||l instanceof j){if(c instanceof E||c instanceof T||c instanceof j&&l.data.length===c.data.length)return void l.data.set(c.data);console.error(`Invalid assignment. Line ${e.line}`)}else if(l instanceof pe&&c instanceof pe&&l.buffer.byteLength-l.offset>=c.buffer.byteLength-c.offset)return void(l.buffer.byteLength%4==0?new Uint32Array(l.buffer,l.offset,l.typeInfo.size/4).set(new Uint32Array(c.buffer,c.offset,c.typeInfo.size/4)):new Uint8Array(l.buffer,l.offset,l.typeInfo.size).set(new Uint8Array(c.buffer,c.offset,c.typeInfo.size)));return console.error(`Invalid assignment. Line ${e.line}`),null}if(u==="+=")return l instanceof E||l instanceof T||l instanceof j?c instanceof E||c instanceof T||c instanceof j?void l.data.set(c.data.map((d,h)=>l.data[h]+d)):void console.error(`Invalid assignment . Line ${e.line}`):void console.error(`Invalid assignment. Line ${e.line}`);if(u==="-=")return(l instanceof E||l instanceof T||l instanceof j)&&(c instanceof E||c instanceof T||c instanceof j)?void l.data.set(c.data.map((d,h)=>l.data[h]-d)):void console.error(`Invalid assignment. Line ${e.line}`)}if(e.variable instanceof ye){if(e.variable.operator==="*"){r=this.getVariableName(e.variable.right,t);const l=t.getVariable(r);if(!(l&&l.value instanceof Mn))return void console.error(`Variable ${r} is not a pointer. Line ${e.line}`);i=l.value.reference;let c=e.variable.postfix;if(!c){let u=e.variable.right;for(;u instanceof ye;){if(u.postfix){c=u.postfix;break}u=u.right}}c&&(i=i.getSubData(this,c,t))}}else{s=e.variable.postfix,r=this.getVariableName(e.variable,t);const l=t.getVariable(r);if(l===null)return void console.error(`Variable ${r} not found. Line ${e.line}`);i=l.value}if(i instanceof Mn&&(i=i.reference),i===null)return void console.error(`Variable ${r} not found. Line ${e.line}`);const o=this.evalExpression(e.value,t),a=e.operator;if(a!=="="){const l=i.getSubData(this,s,t);if(l instanceof T&&o instanceof E){const c=l.data,u=o.value;if(a==="+=")for(let d=0;d<c.length;++d)c[d]+=u;else if(a==="-=")for(let d=0;d<c.length;++d)c[d]-=u;else if(a==="*=")for(let d=0;d<c.length;++d)c[d]*=u;else if(a==="/=")for(let d=0;d<c.length;++d)c[d]/=u;else if(a==="%=")for(let d=0;d<c.length;++d)c[d]%=u;else if(a==="&=")for(let d=0;d<c.length;++d)c[d]&=u;else if(a==="|=")for(let d=0;d<c.length;++d)c[d]|=u;else if(a==="^=")for(let d=0;d<c.length;++d)c[d]^=u;else if(a==="<<=")for(let d=0;d<c.length;++d)c[d]<<=u;else if(a===">>=")for(let d=0;d<c.length;++d)c[d]>>=u;else console.error(`Invalid operator ${a}. Line ${e.line}`)}else if(l instanceof T&&o instanceof T){const c=l.data,u=o.data;if(c.length!==u.length)return void console.error(`Vector length mismatch. Line ${e.line}`);if(a==="+=")for(let d=0;d<c.length;++d)c[d]+=u[d];else if(a==="-=")for(let d=0;d<c.length;++d)c[d]-=u[d];else if(a==="*=")for(let d=0;d<c.length;++d)c[d]*=u[d];else if(a==="/=")for(let d=0;d<c.length;++d)c[d]/=u[d];else if(a==="%=")for(let d=0;d<c.length;++d)c[d]%=u[d];else if(a==="&=")for(let d=0;d<c.length;++d)c[d]&=u[d];else if(a==="|=")for(let d=0;d<c.length;++d)c[d]|=u[d];else if(a==="^=")for(let d=0;d<c.length;++d)c[d]^=u[d];else if(a==="<<=")for(let d=0;d<c.length;++d)c[d]<<=u[d];else if(a===">>=")for(let d=0;d<c.length;++d)c[d]>>=u[d];else console.error(`Invalid operator ${a}. Line ${e.line}`)}else{if(!(l instanceof E&&o instanceof E))return void console.error(`Invalid type for ${e.operator} operator. Line ${e.line}`);a==="+="?l.value+=o.value:a==="-="?l.value-=o.value:a==="*="?l.value*=o.value:a==="/="?l.value/=o.value:a==="%="?l.value%=o.value:a==="&="?l.value&=o.value:a==="|="?l.value|=o.value:a==="^="?l.value^=o.value:a==="<<="?l.value<<=o.value:a===">>="?l.value>>=o.value:console.error(`Invalid operator ${a}. Line ${e.line}`)}return void(i instanceof pe&&i.setDataValue(this,l,s,t))}if(i instanceof pe)i.setDataValue(this,o,s,t);else if(s){if(!(i instanceof T||i instanceof j))return void console.error(`Variable ${r} is not a vector or matrix. Line ${e.line}`);if(s instanceof Jn){const l=this.evalExpression(s.index,t).value;if(i instanceof T){if(!(o instanceof E))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);i.data[l]=o.value}else{if(!(i instanceof j))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);{const c=this.evalExpression(s.index,t).value;if(c<0)return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);if(!(o instanceof T))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);{const u=i.typeInfo.getTypeName();if(u==="mat2x2"||u==="mat2x2f"||u==="mat2x2h"){if(!(c<2&&o.data.length===2))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);i.data[2*c]=o.data[0],i.data[2*c+1]=o.data[1]}else if(u==="mat2x3"||u==="mat2x3f"||u==="mat2x3h"){if(!(c<2&&o.data.length===3))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);i.data[3*c]=o.data[0],i.data[3*c+1]=o.data[1],i.data[3*c+2]=o.data[2]}else if(u==="mat2x4"||u==="mat2x4f"||u==="mat2x4h"){if(!(c<2&&o.data.length===4))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);i.data[4*c]=o.data[0],i.data[4*c+1]=o.data[1],i.data[4*c+2]=o.data[2],i.data[4*c+3]=o.data[3]}else if(u==="mat3x2"||u==="mat3x2f"||u==="mat3x2h"){if(!(c<3&&o.data.length===2))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);i.data[2*c]=o.data[0],i.data[2*c+1]=o.data[1]}else if(u==="mat3x3"||u==="mat3x3f"||u==="mat3x3h"){if(!(c<3&&o.data.length===3))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);i.data[3*c]=o.data[0],i.data[3*c+1]=o.data[1],i.data[3*c+2]=o.data[2]}else if(u==="mat3x4"||u==="mat3x4f"||u==="mat3x4h"){if(!(c<3&&o.data.length===4))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);i.data[4*c]=o.data[0],i.data[4*c+1]=o.data[1],i.data[4*c+2]=o.data[2],i.data[4*c+3]=o.data[3]}else if(u==="mat4x2"||u==="mat4x2f"||u==="mat4x2h"){if(!(c<4&&o.data.length===2))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);i.data[2*c]=o.data[0],i.data[2*c+1]=o.data[1]}else if(u==="mat4x3"||u==="mat4x3f"||u==="mat4x3h"){if(!(c<4&&o.data.length===3))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);i.data[3*c]=o.data[0],i.data[3*c+1]=o.data[1],i.data[3*c+2]=o.data[2]}else{if(u!=="mat4x4"&&u!=="mat4x4f"&&u!=="mat4x4h")return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);if(!(c<4&&o.data.length===4))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);i.data[4*c]=o.data[0],i.data[4*c+1]=o.data[1],i.data[4*c+2]=o.data[2],i.data[4*c+3]=o.data[3]}}}}}else if(s instanceof bn){const l=s.value;if(!(i instanceof T))return void console.error(`Invalid assignment to ${l}. Variable ${r} is not a vector. Line ${e.line}`);if(o instanceof E){if(l.length>1)return void console.error(`Invalid assignment to ${l} for variable ${r}. Line ${e.line}`);if(l==="x")i.data[0]=o.value;else if(l==="y"){if(i.data.length<2)return void console.error(`Invalid assignment to ${l} for variable ${r}. Line ${e.line}`);i.data[1]=o.value}else if(l==="z"){if(i.data.length<3)return void console.error(`Invalid assignment to ${l} for variable ${r}. Line ${e.line}`);i.data[2]=o.value}else if(l==="w"){if(i.data.length<4)return void console.error(`Invalid assignment to ${l} for variable ${r}. Line ${e.line}`);i.data[3]=o.value}}else{if(!(o instanceof T))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);if(l.length!==o.data.length)return void console.error(`Invalid assignment to ${l} for variable ${r}. Line ${e.line}`);for(let c=0;c<l.length;++c){const u=l[c];if(u==="x"||u==="r")i.data[0]=o.data[c];else if(u==="y"||u==="g"){if(o.data.length<2)return void console.error(`Invalid assignment to ${u} for variable ${r}. Line ${e.line}`);i.data[1]=o.data[c]}else if(u==="z"||u==="b"){if(o.data.length<3)return void console.error(`Invalid assignment to ${u} for variable ${r}. Line ${e.line}`);i.data[2]=o.data[c]}else{if(u!=="w"&&u!=="a")return void console.error(`Invalid assignment to ${u} for variable ${r}. Line ${e.line}`);if(o.data.length<4)return void console.error(`Invalid assignment to ${u} for variable ${r}. Line ${e.line}`);i.data[3]=o.data[c]}}}}}else i instanceof E&&o instanceof E?i.value=o.value:i instanceof T&&o instanceof T||i instanceof j&&o instanceof j?i.data.set(o.data):console.error(`Invalid assignment to ${r}. Line ${e.line}`)}_function(e,t){const i=new jc(e);t.functions.set(e.name,i)}_const(e,t){let i=null;e.value!==null&&(i=this.evalExpression(e.value,t)),t.createVariable(e.name,i,e)}_let(e,t){let i=null;if(e.value!==null){if(i=this.evalExpression(e.value,t),i===null)return void console.error(`Invalid value for variable ${e.name}. Line ${e.line}`);e.value instanceof ye||(i=i.clone())}else{const r=e.type.name;if(r==="f32"||r==="i32"||r==="u32"||r==="bool"||r==="f16"||r==="vec2"||r==="vec3"||r==="vec4"||r==="vec2f"||r==="vec3f"||r==="vec4f"||r==="vec2i"||r==="vec3i"||r==="vec4i"||r==="vec2u"||r==="vec3u"||r==="vec4u"||r==="vec2h"||r==="vec3h"||r==="vec4h"||r==="vec2b"||r==="vec3b"||r==="vec4b"||r==="mat2x2"||r==="mat2x3"||r==="mat2x4"||r==="mat3x2"||r==="mat3x3"||r==="mat3x4"||r==="mat4x2"||r==="mat4x3"||r==="mat4x4"||r==="mat2x2f"||r==="mat2x3f"||r==="mat2x4f"||r==="mat3x2f"||r==="mat3x3f"||r==="mat3x4f"||r==="mat4x2f"||r==="mat4x3f"||r==="mat4x4f"||r==="mat2x2h"||r==="mat2x3h"||r==="mat2x4h"||r==="mat3x2h"||r==="mat3x3h"||r==="mat3x4h"||r==="mat4x2h"||r==="mat4x3h"||r==="mat4x4h"||r==="array"){const s=new yt(e.type,[]);i=this._evalCreate(s,t)}}t.createVariable(e.name,i,e)}_var(e,t){let i=null;if(e.value!==null){if(i=this.evalExpression(e.value,t),i===null)return void console.error(`Invalid value for variable ${e.name}. Line ${e.line}`);e.value instanceof ye||(i=i.clone())}else{if(e.type===null)return void console.error(`Variable ${e.name} has no type. Line ${e.line}`);const r=e.type.name;if(r==="f32"||r==="i32"||r==="u32"||r==="bool"||r==="f16"||r==="vec2"||r==="vec3"||r==="vec4"||r==="vec2f"||r==="vec3f"||r==="vec4f"||r==="vec2i"||r==="vec3i"||r==="vec4i"||r==="vec2u"||r==="vec3u"||r==="vec4u"||r==="vec2h"||r==="vec3h"||r==="vec4h"||r==="vec2b"||r==="vec3b"||r==="vec4b"||r==="mat2x2"||r==="mat2x3"||r==="mat2x4"||r==="mat3x2"||r==="mat3x3"||r==="mat3x4"||r==="mat4x2"||r==="mat4x3"||r==="mat4x4"||r==="mat2x2f"||r==="mat2x3f"||r==="mat2x4f"||r==="mat3x2f"||r==="mat3x3f"||r==="mat3x4f"||r==="mat4x2f"||r==="mat4x3f"||r==="mat4x4f"||r==="mat2x2h"||r==="mat2x3h"||r==="mat2x4h"||r==="mat3x2h"||r==="mat3x3h"||r==="mat3x4h"||r==="mat4x2h"||r==="mat4x3h"||r==="mat4x4h"||e.type instanceof ki||e.type instanceof It||e.type instanceof R){const s=new yt(e.type,[]);i=this._evalCreate(s,t)}}t.createVariable(e.name,i,e)}_switch(e,t){t=t.clone();const i=this.evalExpression(e.condition,t);if(!(i instanceof E))return console.error(`Invalid if condition. Line ${e.line}`),null;let r=null;for(const s of e.cases)if(s instanceof Tm)for(const o of s.selectors){if(o instanceof Kr){r=s;continue}const a=this.evalExpression(o,t);if(!(a instanceof E))return console.error(`Invalid case selector. Line ${e.line}`),null;if(a.value===i.value)return this._execStatements(s.body,t)}else s instanceof Sm&&(r=s);return r?this._execStatements(r.body,t):null}_if(e,t){t=t.clone();const i=this.evalExpression(e.condition,t);if(!(i instanceof E))return console.error(`Invalid if condition. Line ${e.line}`),null;if(i.value)return this._execStatements(e.body,t);for(const r of e.elseif){const s=this.evalExpression(r.condition,t);if(!(s instanceof E))return console.error(`Invalid if condition. Line ${e.line}`),null;if(s.value)return this._execStatements(r.body,t)}return e.else?this._execStatements(e.else,t):null}_getScalarValue(e){return e instanceof E?e.value:(console.error("Expected scalar value.",e),0)}_for(e,t){for(t=t.clone(),this.execStatement(e.init,t);this._getScalarValue(this.evalExpression(e.condition,t));){const i=this._execStatements(e.body,t);if(i===Fe._breakObj)break;if(i!==null&&i!==Fe._continueObj)return i;this.execStatement(e.increment,t)}return null}_loop(e,t){for(t=t.clone();;){const i=this._execStatements(e.body,t);if(i===Fe._breakObj)break;if(i===Fe._continueObj){if(e.continuing&&this._execStatements(e.continuing.body,t)===Fe._breakObj)break}else if(i!==null)return i}return null}_while(e,t){for(t=t.clone();this._getScalarValue(this.evalExpression(e.condition,t));){const i=this._execStatements(e.body,t);if(i===Fe._breakObj)break;if(i!==Fe._continueObj&&i!==null)return i}return null}_evalBitcast(e,t){const i=this.evalExpression(e.value,t),r=e.type;if(i instanceof E){const s=rh(i.value,i.typeInfo.name,r.name);return new E(s,this.getTypeInfo(r))}if(i instanceof T){const s=i.typeInfo.getTypeName();let o="";if(s.endsWith("f"))o="f32";else if(s.endsWith("i"))o="i32";else if(s.endsWith("u"))o="u32";else if(s.endsWith("b"))o="bool";else{if(!s.endsWith("h"))return console.error(`Unknown vector type ${s}. Line ${e.line}`),null;o="f16"}const a=r.getTypeName();let l="";if(a.endsWith("f"))l="f32";else if(a.endsWith("i"))l="i32";else if(a.endsWith("u"))l="u32";else if(a.endsWith("b"))l="bool";else{if(!a.endsWith("h"))return console.error(`Unknown vector type ${l}. Line ${e.line}`),null;l="f16"}const c=function(u,d,h){if(d===h)return u;const f=new Array(u.length);for(let p=0;p<u.length;p++)f[p]=rh(u[p],d,h);return f}(Array.from(i.data),o,l);return new T(c,this.getTypeInfo(r))}return console.error(`TODO: bitcast for ${i.typeInfo.name}. Line ${e.line}`),null}_evalConst(e,t){return t.getVariableValue(e.name).clone().getSubData(this,e.postfix,t)}_evalCreate(e,t){var i;if(e instanceof yt){if(e.type===null)return _l.void;switch(e.type.getTypeName()){case"bool":case"i32":case"u32":case"f32":case"f16":return this._callConstructorValue(e,t);case"vec2":case"vec3":case"vec4":case"vec2f":case"vec3f":case"vec4f":case"vec2h":case"vec3h":case"vec4h":case"vec2i":case"vec3i":case"vec4i":case"vec2u":case"vec3u":case"vec4u":case"vec2b":case"vec3b":case"vec4b":return this._callConstructorVec(e,t);case"mat2x2":case"mat2x2f":case"mat2x2h":case"mat2x3":case"mat2x3f":case"mat2x3h":case"mat2x4":case"mat2x4f":case"mat2x4h":case"mat3x2":case"mat3x2f":case"mat3x2h":case"mat3x3":case"mat3x3f":case"mat3x3h":case"mat3x4":case"mat3x4f":case"mat3x4h":case"mat4x2":case"mat4x2f":case"mat4x2h":case"mat4x3":case"mat4x3f":case"mat4x3h":case"mat4x4":case"mat4x4f":case"mat4x4h":return this._callConstructorMatrix(e,t)}}const r=e instanceof yt?e.type.name:e.name,s=e instanceof yt?this.getTypeInfo(e.type):this.getTypeInfo(e.name);if(s===null)return console.error(`Unknown type ${r}. Line ${e.line}`),null;if(s.size===0)return null;const o=new pe(new ArrayBuffer(s.size),s,0);if(s instanceof jt){if(e.args)for(let a=0;a<e.args.length;++a){const l=s.members[a],c=e.args[a],u=this.evalExpression(c,t);o.setData(this,u,l.type,l.offset,t)}}else if(s instanceof Kt){let a=0;if(e.args)for(let l=0;l<e.args.length;++l){const c=e.args[l],u=this.evalExpression(c,t);s.format===null&&(((i=u.typeInfo)===null||i===void 0?void 0:i.name)==="x32"?s.format=this.getTypeInfo("i32"):s.format=u.typeInfo),o.setData(this,u,s.format,a,t),a+=s.stride}}else console.error(`Unknown type "${r}". Line ${e.line}`);return e instanceof yt?o.getSubData(this,e.postfix,t):o}_evalLiteral(e,t){const i=this.getTypeInfo(e.type),r=i.name;return r==="x32"||r==="u32"||r==="f32"||r==="f16"||r==="i32"||r==="bool"?new E(e.scalarValue,i):r==="vec2"||r==="vec3"||r==="vec4"||r==="vec2f"||r==="vec3f"||r==="vec4f"||r==="vec2h"||r==="vec3h"||r==="vec4h"||r==="vec2i"||r==="vec3i"||r==="vec4i"||r==="vec2u"||r==="vec3u"||r==="vec4u"?this._callConstructorVec(e,t):r==="mat2x2"||r==="mat2x3"||r==="mat2x4"||r==="mat3x2"||r==="mat3x3"||r==="mat3x4"||r==="mat4x2"||r==="mat4x3"||r==="mat4x4"||r==="mat2x2f"||r==="mat2x3f"||r==="mat2x4f"||r==="mat3x2f"||r==="mat3x3f"||r==="mat3x4f"||r==="mat4x2f"||r==="mat4x3f"||r==="mat4x4f"||r==="mat2x2h"||r==="mat2x3h"||r==="mat2x4h"||r==="mat3x2h"||r==="mat3x3h"||r==="mat3x4h"||r==="mat4x2h"||r==="mat4x3h"||r==="mat4x4h"?this._callConstructorMatrix(e,t):e.value}_evalVariable(e,t){const i=t.getVariableValue(e.name);return i===null?i:i.getSubData(this,e.postfix,t)}_maxFormatTypeInfo(e){let t=e[0];if(t.name==="f32")return t;for(let i=1;i<e.length;++i){const r=Fe._priority.get(t.name);Fe._priority.get(e[i].name)<r&&(t=e[i])}return t.name==="x32"?this.getTypeInfo("i32"):t}_evalUnaryOp(e,t){const i=this.evalExpression(e.right,t);if(e.operator==="&")return new Mn(i);if(e.operator==="*")return i instanceof Mn?i.reference.getSubData(this,e.postfix,t):(console.error(`Invalid dereference. Line ${e.line}`),null);const r=i instanceof E?i.value:i instanceof T?Array.from(i.data):null;switch(e.operator){case"+":{if(V(r)){const a=r.map((l,c)=>+l);return new T(a,i.typeInfo)}const s=r,o=this._maxFormatTypeInfo([i.typeInfo,i.typeInfo]);return new E(+s,o)}case"-":{if(V(r)){const a=r.map((l,c)=>-l);return new T(a,i.typeInfo)}const s=r,o=this._maxFormatTypeInfo([i.typeInfo,i.typeInfo]);return new E(-s,o)}case"!":{if(V(r)){const a=r.map((l,c)=>l?0:1);return new T(a,i.typeInfo)}const s=r,o=this._maxFormatTypeInfo([i.typeInfo,i.typeInfo]);return new E(s?0:1,o)}case"~":{if(V(r)){const a=r.map((l,c)=>~l);return new T(a,i.typeInfo)}const s=r,o=this._maxFormatTypeInfo([i.typeInfo,i.typeInfo]);return new E(~s,o)}}return console.error(`Invalid unary operator ${e.operator}. Line ${e.line}`),null}_evalBinaryOp(e,t){const i=this.evalExpression(e.left,t),r=this.evalExpression(e.right,t),s=i instanceof E?i.value:i instanceof T||i instanceof j?Array.from(i.data):null,o=r instanceof E?r.value:r instanceof T||r instanceof j?Array.from(r.data):null;switch(e.operator){case"+":{if(V(s)&&V(o)){const u=s,d=o;if(u.length!==d.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const h=u.map((f,p)=>f+d[p]);return new T(h,i.typeInfo)}if(V(s)){const u=o,d=s.map((h,f)=>h+u);return new T(d,i.typeInfo)}if(V(o)){const u=s,d=o.map((h,f)=>u+h);return new T(d,r.typeInfo)}const a=s,l=o,c=this._maxFormatTypeInfo([i.typeInfo,r.typeInfo]);return new E(a+l,c)}case"-":{if(V(s)&&V(o)){const u=s,d=o;if(u.length!==d.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const h=u.map((f,p)=>f-d[p]);return new T(h,i.typeInfo)}if(V(s)){const u=o,d=s.map((h,f)=>h-u);return new T(d,i.typeInfo)}if(V(o)){const u=s,d=o.map((h,f)=>u-h);return new T(d,r.typeInfo)}const a=s,l=o,c=this._maxFormatTypeInfo([i.typeInfo,r.typeInfo]);return new E(a-l,c)}case"*":{if(V(s)&&V(o)){const u=s,d=o;if(i instanceof j&&r instanceof j){const h=function(_,b,w,x){if(Be[b.name]===void 0||Be[x.name]===void 0)return null;const y=Be[b.name][0],S=Be[b.name][1],I=Be[x.name][0];if(y!==Be[x.name][1])return null;const F=new Array(I*S);for(let D=0;D<S;D++)for(let B=0;B<I;B++){let U=0;for(let O=0;O<y;O++)U+=_[O*S+D]*w[B*y+O];F[D*I+B]=U}return F}(u,i.typeInfo,d,r.typeInfo);if(h===null)return console.error(`Matrix multiplication failed. Line ${e.line}.`),null;const f=Be[r.typeInfo.name][0],p=Be[i.typeInfo.name][1],g=this.getTypeInfo(`mat${f}x${p}f`);return new j(h,g)}if(i instanceof j&&r instanceof T){const h=function(f,p,g,_){if(Be[p.name]===void 0||ea[_.name]===void 0)return null;const b=Be[p.name][0],w=Be[p.name][1];if(b!==g.length)return null;const x=new Array(w);for(let y=0;y<w;y++){let S=0;for(let I=0;I<b;I++)S+=f[I*w+y]*g[I];x[y]=S}return x}(u,i.typeInfo,d,r.typeInfo);return h===null?(console.error(`Matrix vector multiplication failed. Line ${e.line}.`),null):new T(h,r.typeInfo)}if(i instanceof T&&r instanceof j){const h=function(f,p,g,_){if(ea[p.name]===void 0||Be[_.name]===void 0)return null;const b=Be[_.name][0],w=Be[_.name][1];if(w!==f.length)return null;const x=[];for(let y=0;y<b;y++){let S=0;for(let I=0;I<w;I++)S+=f[I]*g[I*b+y];x[y]=S}return x}(u,i.typeInfo,d,r.typeInfo);return h===null?(console.error(`Matrix vector multiplication failed. Line ${e.line}.`),null):new T(h,i.typeInfo)}{if(u.length!==d.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const h=u.map((f,p)=>f*d[p]);return new T(h,i.typeInfo)}}if(V(s)){const u=o,d=s.map((h,f)=>h*u);return i instanceof j?new j(d,i.typeInfo):new T(d,i.typeInfo)}if(V(o)){const u=s,d=o.map((h,f)=>u*h);return r instanceof j?new j(d,r.typeInfo):new T(d,r.typeInfo)}const a=s,l=o,c=this._maxFormatTypeInfo([i.typeInfo,r.typeInfo]);return new E(a*l,c)}case"%":{if(V(s)&&V(o)){const u=s,d=o;if(u.length!==d.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const h=u.map((f,p)=>f%d[p]);return new T(h,i.typeInfo)}if(V(s)){const u=o,d=s.map((h,f)=>h%u);return new T(d,i.typeInfo)}if(V(o)){const u=s,d=o.map((h,f)=>u%h);return new T(d,r.typeInfo)}const a=s,l=o,c=this._maxFormatTypeInfo([i.typeInfo,r.typeInfo]);return new E(a%l,c)}case"/":{if(V(s)&&V(o)){const u=s,d=o;if(u.length!==d.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const h=u.map((f,p)=>f/d[p]);return new T(h,i.typeInfo)}if(V(s)){const u=o,d=s.map((h,f)=>h/u);return new T(d,i.typeInfo)}if(V(o)){const u=s,d=o.map((h,f)=>u/h);return new T(d,r.typeInfo)}const a=s,l=o,c=this._maxFormatTypeInfo([i.typeInfo,r.typeInfo]);return new E(a/l,c)}case"&":{if(V(s)&&V(o)){const u=s,d=o;if(u.length!==d.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const h=u.map((f,p)=>f&d[p]);return new T(h,i.typeInfo)}if(V(s)){const u=o,d=s.map((h,f)=>h&u);return new T(d,i.typeInfo)}if(V(o)){const u=s,d=o.map((h,f)=>u&h);return new T(d,r.typeInfo)}const a=s,l=o,c=this._maxFormatTypeInfo([i.typeInfo,r.typeInfo]);return new E(a&l,c)}case"|":{if(V(s)&&V(o)){const u=s,d=o;if(u.length!==d.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const h=u.map((f,p)=>f|d[p]);return new T(h,i.typeInfo)}if(V(s)){const u=o,d=s.map((h,f)=>h|u);return new T(d,i.typeInfo)}if(V(o)){const u=s,d=o.map((h,f)=>u|h);return new T(d,r.typeInfo)}const a=s,l=o,c=this._maxFormatTypeInfo([i.typeInfo,r.typeInfo]);return new E(a|l,c)}case"^":{if(V(s)&&V(o)){const u=s,d=o;if(u.length!==d.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const h=u.map((f,p)=>f^d[p]);return new T(h,i.typeInfo)}if(V(s)){const u=o,d=s.map((h,f)=>h^u);return new T(d,i.typeInfo)}if(V(o)){const u=s,d=o.map((h,f)=>u^h);return new T(d,r.typeInfo)}const a=s,l=o,c=this._maxFormatTypeInfo([i.typeInfo,r.typeInfo]);return new E(a^l,c)}case"<<":{if(V(s)&&V(o)){const u=s,d=o;if(u.length!==d.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const h=u.map((f,p)=>f<<d[p]);return new T(h,i.typeInfo)}if(V(s)){const u=o,d=s.map((h,f)=>h<<u);return new T(d,i.typeInfo)}if(V(o)){const u=s,d=o.map((h,f)=>u<<h);return new T(d,r.typeInfo)}const a=s,l=o,c=this._maxFormatTypeInfo([i.typeInfo,r.typeInfo]);return new E(a<<l,c)}case">>":{if(V(s)&&V(o)){const u=s,d=o;if(u.length!==d.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const h=u.map((f,p)=>f>>d[p]);return new T(h,i.typeInfo)}if(V(s)){const u=o,d=s.map((h,f)=>h>>u);return new T(d,i.typeInfo)}if(V(o)){const u=s,d=o.map((h,f)=>u>>h);return new T(d,r.typeInfo)}const a=s,l=o,c=this._maxFormatTypeInfo([i.typeInfo,r.typeInfo]);return new E(a>>l,c)}case">":if(V(s)&&V(o)){const a=s,l=o;if(a.length!==l.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const c=a.map((u,d)=>u>l[d]?1:0);return new T(c,i.typeInfo)}if(V(s)){const a=o,l=s.map((c,u)=>c>a?1:0);return new T(l,i.typeInfo)}if(V(o)){const a=s,l=o.map((c,u)=>a>c?1:0);return new T(l,r.typeInfo)}return new E(s>o?1:0,this.getTypeInfo("bool"));case"<":if(V(s)&&V(o)){const a=s,l=o;if(a.length!==l.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const c=a.map((u,d)=>u<l[d]?1:0);return new T(c,i.typeInfo)}if(V(s)){const a=o,l=s.map((c,u)=>c<a?1:0);return new T(l,i.typeInfo)}if(V(o)){const a=s,l=o.map((c,u)=>a<c?1:0);return new T(l,r.typeInfo)}return new E(s<o?1:0,this.getTypeInfo("bool"));case"==":if(V(s)&&V(o)){const a=s,l=o;if(a.length!==l.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const c=a.map((u,d)=>u===l[d]?1:0);return new T(c,i.typeInfo)}if(V(s)){const a=o,l=s.map((c,u)=>c==a?1:0);return new T(l,i.typeInfo)}if(V(o)){const a=s,l=o.map((c,u)=>a==c?1:0);return new T(l,r.typeInfo)}return new E(s===o?1:0,this.getTypeInfo("bool"));case"!=":if(V(s)&&V(o)){const a=s,l=o;if(a.length!==l.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const c=a.map((u,d)=>u!==l[d]?1:0);return new T(c,i.typeInfo)}if(V(s)){const a=o,l=s.map((c,u)=>c!==a?1:0);return new T(l,i.typeInfo)}if(V(o)){const a=s,l=o.map((c,u)=>a!==c?1:0);return new T(l,r.typeInfo)}return new E(s!==o?1:0,this.getTypeInfo("bool"));case">=":if(V(s)&&V(o)){const a=s,l=o;if(a.length!==l.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const c=a.map((u,d)=>u>=l[d]?1:0);return new T(c,i.typeInfo)}if(V(s)){const a=o,l=s.map((c,u)=>c>=a?1:0);return new T(l,i.typeInfo)}if(V(o)){const a=s,l=o.map((c,u)=>a>=c?1:0);return new T(l,r.typeInfo)}return new E(s>=o?1:0,this.getTypeInfo("bool"));case"<=":if(V(s)&&V(o)){const a=s,l=o;if(a.length!==l.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const c=a.map((u,d)=>u<=l[d]?1:0);return new T(c,i.typeInfo)}if(V(s)){const a=o,l=s.map((c,u)=>c<=a?1:0);return new T(l,i.typeInfo)}if(V(o)){const a=s,l=o.map((c,u)=>a<=c?1:0);return new T(l,r.typeInfo)}return new E(s<=o?1:0,this.getTypeInfo("bool"));case"&&":if(V(s)&&V(o)){const a=s,l=o;if(a.length!==l.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const c=a.map((u,d)=>u&&l[d]?1:0);return new T(c,i.typeInfo)}if(V(s)){const a=o,l=s.map((c,u)=>c&&a?1:0);return new T(l,i.typeInfo)}if(V(o)){const a=s,l=o.map((c,u)=>a&&c?1:0);return new T(l,r.typeInfo)}return new E(s&&o?1:0,this.getTypeInfo("bool"));case"||":if(V(s)&&V(o)){const a=s,l=o;if(a.length!==l.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const c=a.map((u,d)=>u||l[d]?1:0);return new T(c,i.typeInfo)}if(V(s)){const a=o,l=s.map((c,u)=>c||a?1:0);return new T(l,i.typeInfo)}if(V(o)){const a=s,l=o.map((c,u)=>a||c?1:0);return new T(l,r.typeInfo)}return new E(s||o?1:0,this.getTypeInfo("bool"))}return console.error(`Unknown operator ${e.operator}. Line ${e.line}`),null}_evalCall(e,t){if(e.cachedReturnValue!==null)return e.cachedReturnValue;const i=t.clone();i.currentFunctionName=e.name;const r=t.getFunction(e.name);if(!r)return e.isBuiltin?this._callBuiltinFunction(e,i):this.getTypeInfo(e.name)?this._evalCreate(e,t):(console.error(`Unknown function "${e.name}". Line ${e.line}`),null);for(let s=0;s<r.node.args.length;++s){const o=r.node.args[s],a=this.evalExpression(e.args[s],i);i.createVariable(o.name,a,o)}return this._execStatements(r.node.body,i)}_callBuiltinFunction(e,t){switch(e.name){case"all":return this.builtins.All(e,t);case"any":return this.builtins.Any(e,t);case"select":return this.builtins.Select(e,t);case"arrayLength":return this.builtins.ArrayLength(e,t);case"abs":return this.builtins.Abs(e,t);case"acos":return this.builtins.Acos(e,t);case"acosh":return this.builtins.Acosh(e,t);case"asin":return this.builtins.Asin(e,t);case"asinh":return this.builtins.Asinh(e,t);case"atan":return this.builtins.Atan(e,t);case"atanh":return this.builtins.Atanh(e,t);case"atan2":return this.builtins.Atan2(e,t);case"ceil":return this.builtins.Ceil(e,t);case"clamp":return this.builtins.Clamp(e,t);case"cos":return this.builtins.Cos(e,t);case"cosh":return this.builtins.Cosh(e,t);case"countLeadingZeros":return this.builtins.CountLeadingZeros(e,t);case"countOneBits":return this.builtins.CountOneBits(e,t);case"countTrailingZeros":return this.builtins.CountTrailingZeros(e,t);case"cross":return this.builtins.Cross(e,t);case"degrees":return this.builtins.Degrees(e,t);case"determinant":return this.builtins.Determinant(e,t);case"distance":return this.builtins.Distance(e,t);case"dot":return this.builtins.Dot(e,t);case"dot4U8Packed":return this.builtins.Dot4U8Packed(e,t);case"dot4I8Packed":return this.builtins.Dot4I8Packed(e,t);case"exp":return this.builtins.Exp(e,t);case"exp2":return this.builtins.Exp2(e,t);case"extractBits":return this.builtins.ExtractBits(e,t);case"faceForward":return this.builtins.FaceForward(e,t);case"firstLeadingBit":return this.builtins.FirstLeadingBit(e,t);case"firstTrailingBit":return this.builtins.FirstTrailingBit(e,t);case"floor":return this.builtins.Floor(e,t);case"fma":return this.builtins.Fma(e,t);case"fract":return this.builtins.Fract(e,t);case"frexp":return this.builtins.Frexp(e,t);case"insertBits":return this.builtins.InsertBits(e,t);case"inverseSqrt":return this.builtins.InverseSqrt(e,t);case"ldexp":return this.builtins.Ldexp(e,t);case"length":return this.builtins.Length(e,t);case"log":return this.builtins.Log(e,t);case"log2":return this.builtins.Log2(e,t);case"max":return this.builtins.Max(e,t);case"min":return this.builtins.Min(e,t);case"mix":return this.builtins.Mix(e,t);case"modf":return this.builtins.Modf(e,t);case"normalize":return this.builtins.Normalize(e,t);case"pow":return this.builtins.Pow(e,t);case"quantizeToF16":return this.builtins.QuantizeToF16(e,t);case"radians":return this.builtins.Radians(e,t);case"reflect":return this.builtins.Reflect(e,t);case"refract":return this.builtins.Refract(e,t);case"reverseBits":return this.builtins.ReverseBits(e,t);case"round":return this.builtins.Round(e,t);case"saturate":return this.builtins.Saturate(e,t);case"sign":return this.builtins.Sign(e,t);case"sin":return this.builtins.Sin(e,t);case"sinh":return this.builtins.Sinh(e,t);case"smoothstep":return this.builtins.SmoothStep(e,t);case"sqrt":return this.builtins.Sqrt(e,t);case"step":return this.builtins.Step(e,t);case"tan":return this.builtins.Tan(e,t);case"tanh":return this.builtins.Tanh(e,t);case"transpose":return this.builtins.Transpose(e,t);case"trunc":return this.builtins.Trunc(e,t);case"dpdx":return this.builtins.Dpdx(e,t);case"dpdxCoarse":return this.builtins.DpdxCoarse(e,t);case"dpdxFine":return this.builtins.DpdxFine(e,t);case"dpdy":return this.builtins.Dpdy(e,t);case"dpdyCoarse":return this.builtins.DpdyCoarse(e,t);case"dpdyFine":return this.builtins.DpdyFine(e,t);case"fwidth":return this.builtins.Fwidth(e,t);case"fwidthCoarse":return this.builtins.FwidthCoarse(e,t);case"fwidthFine":return this.builtins.FwidthFine(e,t);case"textureDimensions":return this.builtins.TextureDimensions(e,t);case"textureGather":return this.builtins.TextureGather(e,t);case"textureGatherCompare":return this.builtins.TextureGatherCompare(e,t);case"textureLoad":return this.builtins.TextureLoad(e,t);case"textureNumLayers":return this.builtins.TextureNumLayers(e,t);case"textureNumLevels":return this.builtins.TextureNumLevels(e,t);case"textureNumSamples":return this.builtins.TextureNumSamples(e,t);case"textureSample":return this.builtins.TextureSample(e,t);case"textureSampleBias":return this.builtins.TextureSampleBias(e,t);case"textureSampleCompare":return this.builtins.TextureSampleCompare(e,t);case"textureSampleCompareLevel":return this.builtins.TextureSampleCompareLevel(e,t);case"textureSampleGrad":return this.builtins.TextureSampleGrad(e,t);case"textureSampleLevel":return this.builtins.TextureSampleLevel(e,t);case"textureSampleBaseClampToEdge":return this.builtins.TextureSampleBaseClampToEdge(e,t);case"textureStore":return this.builtins.TextureStore(e,t);case"atomicLoad":return this.builtins.AtomicLoad(e,t);case"atomicStore":return this.builtins.AtomicStore(e,t);case"atomicAdd":return this.builtins.AtomicAdd(e,t);case"atomicSub":return this.builtins.AtomicSub(e,t);case"atomicMax":return this.builtins.AtomicMax(e,t);case"atomicMin":return this.builtins.AtomicMin(e,t);case"atomicAnd":return this.builtins.AtomicAnd(e,t);case"atomicOr":return this.builtins.AtomicOr(e,t);case"atomicXor":return this.builtins.AtomicXor(e,t);case"atomicExchange":return this.builtins.AtomicExchange(e,t);case"atomicCompareExchangeWeak":return this.builtins.AtomicCompareExchangeWeak(e,t);case"pack4x8snorm":return this.builtins.Pack4x8snorm(e,t);case"pack4x8unorm":return this.builtins.Pack4x8unorm(e,t);case"pack4xI8":return this.builtins.Pack4xI8(e,t);case"pack4xU8":return this.builtins.Pack4xU8(e,t);case"pack4x8Clamp":return this.builtins.Pack4x8Clamp(e,t);case"pack4xU8Clamp":return this.builtins.Pack4xU8Clamp(e,t);case"pack2x16snorm":return this.builtins.Pack2x16snorm(e,t);case"pack2x16unorm":return this.builtins.Pack2x16unorm(e,t);case"pack2x16float":return this.builtins.Pack2x16float(e,t);case"unpack4x8snorm":return this.builtins.Unpack4x8snorm(e,t);case"unpack4x8unorm":return this.builtins.Unpack4x8unorm(e,t);case"unpack4xI8":return this.builtins.Unpack4xI8(e,t);case"unpack4xU8":return this.builtins.Unpack4xU8(e,t);case"unpack2x16snorm":return this.builtins.Unpack2x16snorm(e,t);case"unpack2x16unorm":return this.builtins.Unpack2x16unorm(e,t);case"unpack2x16float":return this.builtins.Unpack2x16float(e,t);case"storageBarrier":return this.builtins.StorageBarrier(e,t);case"textureBarrier":return this.builtins.TextureBarrier(e,t);case"workgroupBarrier":return this.builtins.WorkgroupBarrier(e,t);case"workgroupUniformLoad":return this.builtins.WorkgroupUniformLoad(e,t);case"subgroupAdd":return this.builtins.SubgroupAdd(e,t);case"subgroupExclusiveAdd":return this.builtins.SubgroupExclusiveAdd(e,t);case"subgroupInclusiveAdd":return this.builtins.SubgroupInclusiveAdd(e,t);case"subgroupAll":return this.builtins.SubgroupAll(e,t);case"subgroupAnd":return this.builtins.SubgroupAnd(e,t);case"subgroupAny":return this.builtins.SubgroupAny(e,t);case"subgroupBallot":return this.builtins.SubgroupBallot(e,t);case"subgroupBroadcast":return this.builtins.SubgroupBroadcast(e,t);case"subgroupBroadcastFirst":return this.builtins.SubgroupBroadcastFirst(e,t);case"subgroupElect":return this.builtins.SubgroupElect(e,t);case"subgroupMax":return this.builtins.SubgroupMax(e,t);case"subgroupMin":return this.builtins.SubgroupMin(e,t);case"subgroupMul":return this.builtins.SubgroupMul(e,t);case"subgroupExclusiveMul":return this.builtins.SubgroupExclusiveMul(e,t);case"subgroupInclusiveMul":return this.builtins.SubgroupInclusiveMul(e,t);case"subgroupOr":return this.builtins.SubgroupOr(e,t);case"subgroupShuffle":return this.builtins.SubgroupShuffle(e,t);case"subgroupShuffleDown":return this.builtins.SubgroupShuffleDown(e,t);case"subgroupShuffleUp":return this.builtins.SubgroupShuffleUp(e,t);case"subgroupShuffleXor":return this.builtins.SubgroupShuffleXor(e,t);case"subgroupXor":return this.builtins.SubgroupXor(e,t);case"quadBroadcast":return this.builtins.QuadBroadcast(e,t);case"quadSwapDiagonal":return this.builtins.QuadSwapDiagonal(e,t);case"quadSwapX":return this.builtins.QuadSwapX(e,t);case"quadSwapY":return this.builtins.QuadSwapY(e,t)}const i=t.getFunction(e.name);if(i){const r=t.clone();for(let s=0;s<i.node.args.length;++s){const o=i.node.args[s],a=this.evalExpression(e.args[s],r);r.setVariable(o.name,a,o)}return this._execStatements(i.node.body,r)}return null}_callConstructorValue(e,t){if(!e.args||e.args.length===0)return new E(0,this.getTypeInfo(e.type));const i=this.evalExpression(e.args[0],t);return i.typeInfo=this.getTypeInfo(e.type),i.getSubData(this,e.postfix,t).clone()}_callConstructorVec(e,t){const i=this.getTypeInfo(e.type),r=e.type.getTypeName(),s=ea[r];if(s===void 0)return console.error(`Invalid vec constructor ${r}. Line ${e.line}`),null;const o=[];if(e instanceof we)if(e.isVector){const a=e.vectorValue;for(const l of a)o.push(l)}else o.push(e.scalarValue);else if(e.args)for(const a of e.args){const l=this.evalExpression(a,t);if(l instanceof T){const c=l.data;for(let u=0;u<c.length;++u){let d=c[u];o.push(d)}}else if(l instanceof E){let c=l.value;o.push(c)}}if(e.type instanceof R&&e.type.format===null&&(e.type.format=R.f32),o.length===0){const a=new Array(s).fill(0);return new T(a,i).getSubData(this,e.postfix,t)}if(o.length===1)for(;o.length<s;)o.push(o[0]);return o.length<s?(console.error(`Invalid vec constructor. Line ${e.line}`),null):new T(o.length>s?o.slice(0,s):o,i).getSubData(this,e.postfix,t)}_callConstructorMatrix(e,t){const i=this.getTypeInfo(e.type),r=e.type.getTypeName(),s=Be[r];if(s===void 0)return console.error(`Invalid matrix constructor ${r}. Line ${e.line}`),null;const o=[];if(e instanceof we)if(e.isVector){const a=e.vectorValue;for(const l of a)o.push(l)}else o.push(e.scalarValue);else if(e.args)for(const a of e.args){const l=this.evalExpression(a,t);l instanceof T?o.push(...l.data):l instanceof E?o.push(l.value):l instanceof j&&o.push(...l.data)}if(i instanceof yn&&i.format===null&&(i.format=this.getTypeInfo("f32")),o.length===0){const a=new Array(s[2]).fill(0);return new j(a,i).getSubData(this,e.postfix,t)}return o.length!==s[2]?(console.error(`Invalid matrix constructor. Line ${e.line}`),null):new j(o,i).getSubData(this,e.postfix,t)}}Fe._breakObj=new et(new Qe("BREAK",null),null),Fe._continueObj=new et(new Qe("CONTINUE",null),null),Fe._priority=new Map([["f32",0],["f16",1],["u32",2],["i32",3],["x32",3]]);class f2{constructor(){this.constants=new Map,this.aliases=new Map,this.structs=new Map}}class p2{constructor(){this._tokens=[],this._current=0,this._currentLine=1,this._deferArrayCountEval=[],this._currentLoop=[],this._context=new f2,this._exec=new Fe,this._forwardTypeCount=0}parse(e){this._initialize(e),this._deferArrayCountEval.length=0;const t=[];for(;!this._isAtEnd();){const i=this._global_decl_or_directive();if(!i)break;t.push(i)}if(this._deferArrayCountEval.length>0){for(const i of this._deferArrayCountEval){const r=i.arrayType,s=i.countNode;if(s instanceof je){const o=s.name,a=this._context.constants.get(o);if(a)try{const l=a.constEvaluate(this._exec);r.count=l}catch{}}}this._deferArrayCountEval.length=0}if(this._forwardTypeCount>0)for(const i of t)i.search(r=>{r instanceof nh||r instanceof qr?r.type=this._forwardType(r.type):r instanceof ki?r.format=this._forwardType(r.format):r instanceof Pt||r instanceof Mi||r instanceof Yr?r.type=this._forwardType(r.type):r instanceof Yi?r.returnType=this._forwardType(r.returnType):r instanceof th&&(r.type=this._forwardType(r.type))});return t}_forwardType(e){if(e instanceof eh){const t=this._getType(e.name);if(t)return t}else e instanceof qr?e.type=this._forwardType(e.type):e instanceof ki&&(e.format=this._forwardType(e.format));return e}_initialize(e){if(e)if(typeof e=="string"){const t=new i2(e);this._tokens=t.scanTokens()}else this._tokens=e;else this._tokens=[];this._current=0}_updateNode(e,t){return e.line=t??this._currentLine,e}_error(e,t){return{token:e,message:t,toString:()=>`${t}`}}_isAtEnd(){return this._current>=this._tokens.length||this._peek().type==v.eof}_match(e){if(e instanceof C)return!!this._check(e)&&(this._advance(),!0);for(let t=0,i=e.length;t<i;++t){const r=e[t];if(this._check(r))return this._advance(),!0}return!1}_consume(e,t){if(this._check(e))return this._advance();throw this._error(this._peek(),`${t}. Line:${this._currentLine}`)}_check(e){if(this._isAtEnd())return!1;const t=this._peek();if(e instanceof Array){const i=t.type;let r=!1;for(const s of e){if(i===s)return!0;s===v.tokens.name&&(r=!0)}if(r){const s=v.tokens.name.rule.exec(t.lexeme);if(s&&s.index==0&&s[0]==t.lexeme)return!0}return!1}if(t.type===e)return!0;if(e===v.tokens.name){const i=v.tokens.name.rule.exec(t.lexeme);return i&&i.index==0&&i[0]==t.lexeme}return!1}_advance(){var e,t;return this._currentLine=(t=(e=this._peek())===null||e===void 0?void 0:e.line)!==null&&t!==void 0?t:-1,this._isAtEnd()||this._current++,this._previous()}_peek(){return this._tokens[this._current]}_previous(){return this._tokens[this._current-1]}_global_decl_or_directive(){for(;this._match(v.tokens.semicolon)&&!this._isAtEnd(););if(this._match(v.keywords.alias)){const t=this._type_alias();return this._consume(v.tokens.semicolon,"Expected ';'"),this._exec.reflection.updateAST([t]),t}if(this._match(v.keywords.diagnostic)){const t=this._diagnostic();return this._consume(v.tokens.semicolon,"Expected ';'"),this._exec.reflection.updateAST([t]),t}if(this._match(v.keywords.requires)){const t=this._requires_directive();return this._consume(v.tokens.semicolon,"Expected ';'"),this._exec.reflection.updateAST([t]),t}if(this._match(v.keywords.enable)){const t=this._enable_directive();return this._consume(v.tokens.semicolon,"Expected ';'"),this._exec.reflection.updateAST([t]),t}const e=this._attribute();if(this._check(v.keywords.var)){const t=this._global_variable_decl();return t!=null&&(t.attributes=e),this._consume(v.tokens.semicolon,"Expected ';'."),this._exec.reflection.updateAST([t]),t}if(this._check(v.keywords.override)){const t=this._override_variable_decl();return t!=null&&(t.attributes=e),this._consume(v.tokens.semicolon,"Expected ';'."),this._exec.reflection.updateAST([t]),t}if(this._check(v.keywords.let)){const t=this._global_let_decl();return t!=null&&(t.attributes=e),this._consume(v.tokens.semicolon,"Expected ';'."),this._exec.reflection.updateAST([t]),t}if(this._check(v.keywords.const)){const t=this._global_const_decl();return t!=null&&(t.attributes=e),this._consume(v.tokens.semicolon,"Expected ';'."),this._exec.reflection.updateAST([t]),t}if(this._check(v.keywords.struct)){const t=this._struct_decl();return t!=null&&(t.attributes=e),this._exec.reflection.updateAST([t]),t}if(this._check(v.keywords.fn)){const t=this._function_decl();return t!=null&&(t.attributes=e),this._exec.reflection.updateAST([t]),t}return null}_function_decl(){if(!this._match(v.keywords.fn))return null;const e=this._currentLine,t=this._consume(v.tokens.ident,"Expected function name.").toString();this._consume(v.tokens.paren_left,"Expected '(' for function arguments.");const i=[];if(!this._check(v.tokens.paren_right))do{if(this._check(v.tokens.paren_right))break;const a=this._attribute(),l=this._consume(v.tokens.name,"Expected argument name.").toString();this._consume(v.tokens.colon,"Expected ':' for argument type.");const c=this._attribute(),u=this._type_decl();u!=null&&(u.attributes=c,i.push(this._updateNode(new th(l,u,a))))}while(this._match(v.tokens.comma));this._consume(v.tokens.paren_right,"Expected ')' after function arguments.");let r=null;if(this._match(v.tokens.arrow)){const a=this._attribute();r=this._type_decl(),r!=null&&(r.attributes=a)}const s=this._compound_statement(),o=this._currentLine;return this._updateNode(new Yi(t,i,r,s,e,o),e)}_compound_statement(){const e=[];for(this._consume(v.tokens.brace_left,"Expected '{' for block.");!this._check(v.tokens.brace_right);){const t=this._statement();t!==null&&e.push(t)}return this._consume(v.tokens.brace_right,"Expected '}' for block."),e}_statement(){for(;this._match(v.tokens.semicolon)&&!this._isAtEnd(););if(this._check(v.tokens.attr)&&this._attribute(),this._check(v.keywords.if))return this._if_statement();if(this._check(v.keywords.switch))return this._switch_statement();if(this._check(v.keywords.loop))return this._loop_statement();if(this._check(v.keywords.for))return this._for_statement();if(this._check(v.keywords.while))return this._while_statement();if(this._check(v.keywords.continuing))return this._continuing_statement();if(this._check(v.keywords.static_assert))return this._static_assert_statement();if(this._check(v.tokens.brace_left))return this._compound_statement();let e=null;if(this._check(v.keywords.return))e=this._return_statement();else if(this._check([v.keywords.var,v.keywords.let,v.keywords.const]))e=this._variable_statement();else if(this._match(v.keywords.discard))e=this._updateNode(new e2);else if(this._match(v.keywords.break)){const t=this._updateNode(new _m);if(this._currentLoop.length>0){const i=this._currentLoop[this._currentLoop.length-1];t.loopId=i.id}e=t,this._check(v.keywords.if)&&(this._advance(),t.condition=this._optional_paren_expression())}else if(this._match(v.keywords.continue)){const t=this._updateNode(new ym);if(!(this._currentLoop.length>0))throw this._error(this._peek(),`Continue statement must be inside a loop. Line: ${t.line}`);{const i=this._currentLoop[this._currentLoop.length-1];t.loopId=i.id}e=t}else e=this._increment_decrement_statement()||this._func_call_statement()||this._assignment_statement();return e!=null&&this._consume(v.tokens.semicolon,"Expected ';' after statement."),e}_static_assert_statement(){if(!this._match(v.keywords.static_assert))return null;const e=this._currentLine,t=this._optional_paren_expression();return this._updateNode(new GC(t),e)}_while_statement(){if(!this._match(v.keywords.while))return null;const e=this._updateNode(new lm(null,null));return this._currentLoop.push(e),e.condition=this._optional_paren_expression(),this._check(v.tokens.attr)&&this._attribute(),e.body=this._compound_statement(),this._currentLoop.pop(),e}_continuing_statement(){const e=this._currentLoop.length>0?this._currentLoop[this._currentLoop.length-1].id:-1;if(!this._match(v.keywords.continuing))return null;const t=this._currentLine,i=this._compound_statement();return this._updateNode(new ml(i,e),t)}_for_statement(){if(!this._match(v.keywords.for))return null;this._consume(v.tokens.paren_left,"Expected '('.");const e=this._updateNode(new cm(null,null,null,null));return this._currentLoop.push(e),e.init=this._check(v.tokens.semicolon)?null:this._for_init(),this._consume(v.tokens.semicolon,"Expected ';'."),e.condition=this._check(v.tokens.semicolon)?null:this._short_circuit_or_expression(),this._consume(v.tokens.semicolon,"Expected ';'."),e.increment=this._check(v.tokens.paren_right)?null:this._for_increment(),this._consume(v.tokens.paren_right,"Expected ')'."),this._check(v.tokens.attr)&&this._attribute(),e.body=this._compound_statement(),this._currentLoop.pop(),e}_for_init(){return this._variable_statement()||this._func_call_statement()||this._assignment_statement()}_for_increment(){return this._func_call_statement()||this._increment_decrement_statement()||this._assignment_statement()}_variable_statement(){if(this._check(v.keywords.var)){const e=this._variable_decl();if(e===null)throw this._error(this._peek(),"Variable declaration expected.");let t=null;return this._match(v.tokens.equal)&&(t=this._short_circuit_or_expression()),this._updateNode(new Pt(e.name,e.type,e.storage,e.access,t),e.line)}if(this._match(v.keywords.let)){const e=this._currentLine,t=this._consume(v.tokens.name,"Expected name for let.").toString();let i=null;if(this._match(v.tokens.colon)){const s=this._attribute();i=this._type_decl(),i!=null&&(i.attributes=s)}this._consume(v.tokens.equal,"Expected '=' for let.");const r=this._short_circuit_or_expression();return this._updateNode(new Mi(t,i,null,null,r),e)}if(this._match(v.keywords.const)){const e=this._currentLine,t=this._consume(v.tokens.name,"Expected name for const.").toString();let i=null;if(this._match(v.tokens.colon)){const s=this._attribute();i=this._type_decl(),i!=null&&(i.attributes=s)}this._consume(v.tokens.equal,"Expected '=' for const.");const r=this._short_circuit_or_expression();return i===null&&r instanceof we&&(i=r.type),this._updateNode(new Yr(t,i,null,null,r),e)}return null}_increment_decrement_statement(){const e=this._current,t=this._unary_expression();if(t==null)return null;if(!this._check(v.increment_operators))return this._current=e,null;const i=this._consume(v.increment_operators,"Expected increment operator");return this._updateNode(new um(i.type===v.tokens.plus_plus?Ln.increment:Ln.decrement,t))}_assignment_statement(){let e=null;const t=this._currentLine;if(this._check(v.tokens.brace_right))return null;let i=this._match(v.tokens.underscore);if(i||(e=this._unary_expression()),!i&&e==null)return null;const r=this._consume(v.assignment_operators,"Expected assignment operator."),s=this._short_circuit_or_expression();return this._updateNode(new dm(vi.parse(r.lexeme),e,s),t)}_func_call_statement(){if(!this._check(v.tokens.ident))return null;const e=this._currentLine,t=this._current,i=this._consume(v.tokens.ident,"Expected function name."),r=this._argument_expression_list();return r===null?(this._current=t,null):this._updateNode(new $c(i.lexeme,r),e)}_loop_statement(){if(!this._match(v.keywords.loop))return null;this._check(v.tokens.attr)&&this._attribute(),this._consume(v.tokens.brace_left,"Expected '{' for loop.");const e=this._updateNode(new hm([],null));this._currentLoop.push(e);let t=this._statement();for(;t!==null;){if(Array.isArray(t))for(let i of t)e.body.push(i);else e.body.push(t);if(t instanceof ml){e.continuing=t;break}t=this._statement()}return this._currentLoop.pop(),this._consume(v.tokens.brace_right,"Expected '}' for loop."),e}_switch_statement(){if(!this._match(v.keywords.switch))return null;const e=this._updateNode(new fm(null,[]));if(this._currentLoop.push(e),e.condition=this._optional_paren_expression(),this._check(v.tokens.attr)&&this._attribute(),this._consume(v.tokens.brace_left,"Expected '{' for switch."),e.cases=this._switch_body(),e.cases==null||e.cases.length==0)throw this._error(this._previous(),"Expected 'case' or 'default'.");return this._consume(v.tokens.brace_right,"Expected '}' for switch."),this._currentLoop.pop(),e}_switch_body(){const e=[];let t=!1;for(;this._check([v.keywords.default,v.keywords.case]);){if(this._match(v.keywords.case)){const i=this._case_selectors();for(const s of i)if(s instanceof Kr){if(t)throw this._error(this._previous(),"Multiple default cases in switch statement.");t=!0;break}this._match(v.tokens.colon),this._check(v.tokens.attr)&&this._attribute(),this._consume(v.tokens.brace_left,"Exected '{' for switch case.");const r=this._case_body();this._consume(v.tokens.brace_right,"Exected '}' for switch case."),e.push(this._updateNode(new Tm(i,r)))}if(this._match(v.keywords.default)){if(t)throw this._error(this._previous(),"Multiple default cases in switch statement.");this._match(v.tokens.colon),this._check(v.tokens.attr)&&this._attribute(),this._consume(v.tokens.brace_left,"Exected '{' for switch default.");const i=this._case_body();this._consume(v.tokens.brace_right,"Exected '}' for switch default."),e.push(this._updateNode(new Sm(i)))}}return e}_case_selectors(){const e=[];for(this._match(v.keywords.default)?e.push(this._updateNode(new Kr)):e.push(this._shift_expression());this._match(v.tokens.comma);)this._match(v.keywords.default)?e.push(this._updateNode(new Kr)):e.push(this._shift_expression());return e}_case_body(){if(this._match(v.keywords.fallthrough))return this._consume(v.tokens.semicolon,"Expected ';'"),[];let e=this._statement();if(e==null)return[];e instanceof Array||(e=[e]);const t=this._case_body();return t.length==0?e:[...e,t[0]]}_if_statement(){if(!this._match(v.keywords.if))return null;const e=this._currentLine,t=this._optional_paren_expression();this._check(v.tokens.attr)&&this._attribute();const i=this._compound_statement();let r=[];this._match_elseif()&&(this._check(v.tokens.attr)&&this._attribute(),r=this._elseif_statement(r));let s=null;return this._match(v.keywords.else)&&(this._check(v.tokens.attr)&&this._attribute(),s=this._compound_statement()),this._updateNode(new pm(t,i,r,s),e)}_match_elseif(){return this._tokens[this._current].type===v.keywords.else&&this._tokens[this._current+1].type===v.keywords.if&&(this._advance(),this._advance(),!0)}_elseif_statement(e=[]){const t=this._optional_paren_expression(),i=this._compound_statement();return e.push(this._updateNode(new t2(t,i))),this._match_elseif()&&(this._check(v.tokens.attr)&&this._attribute(),this._elseif_statement(e)),e}_return_statement(){if(!this._match(v.keywords.return))return null;const e=this._short_circuit_or_expression();return this._updateNode(new gm(e))}_short_circuit_or_expression(){let e=this._short_circuit_and_expr();for(;this._match(v.tokens.or_or);)e=this._updateNode(new st(this._previous().toString(),e,this._short_circuit_and_expr()));return e}_short_circuit_and_expr(){let e=this._inclusive_or_expression();for(;this._match(v.tokens.and_and);)e=this._updateNode(new st(this._previous().toString(),e,this._inclusive_or_expression()));return e}_inclusive_or_expression(){let e=this._exclusive_or_expression();for(;this._match(v.tokens.or);)e=this._updateNode(new st(this._previous().toString(),e,this._exclusive_or_expression()));return e}_exclusive_or_expression(){let e=this._and_expression();for(;this._match(v.tokens.xor);)e=this._updateNode(new st(this._previous().toString(),e,this._and_expression()));return e}_and_expression(){let e=this._equality_expression();for(;this._match(v.tokens.and);)e=this._updateNode(new st(this._previous().toString(),e,this._equality_expression()));return e}_equality_expression(){const e=this._relational_expression();return this._match([v.tokens.equal_equal,v.tokens.not_equal])?this._updateNode(new st(this._previous().toString(),e,this._relational_expression())):e}_relational_expression(){let e=this._shift_expression();for(;this._match([v.tokens.less_than,v.tokens.greater_than,v.tokens.less_than_equal,v.tokens.greater_than_equal]);)e=this._updateNode(new st(this._previous().toString(),e,this._shift_expression()));return e}_shift_expression(){let e=this._additive_expression();for(;this._match([v.tokens.shift_left,v.tokens.shift_right]);)e=this._updateNode(new st(this._previous().toString(),e,this._additive_expression()));return e}_additive_expression(){let e=this._multiplicative_expression();for(;this._match([v.tokens.plus,v.tokens.minus]);)e=this._updateNode(new st(this._previous().toString(),e,this._multiplicative_expression()));return e}_multiplicative_expression(){let e=this._unary_expression();for(;this._match([v.tokens.star,v.tokens.forward_slash,v.tokens.modulo]);)e=this._updateNode(new st(this._previous().toString(),e,this._unary_expression()));return e}_unary_expression(){return this._match([v.tokens.minus,v.tokens.bang,v.tokens.tilde,v.tokens.star,v.tokens.and])?this._updateNode(new ye(this._previous().toString(),this._unary_expression())):this._singular_expression()}_singular_expression(){const e=this._primary_expression(),t=this._postfix_expression();return t&&(e.postfix=t),e}_postfix_expression(){if(this._match(v.tokens.bracket_left)){const e=this._short_circuit_or_expression();this._consume(v.tokens.bracket_right,"Expected ']'.");const t=this._updateNode(new Jn(e)),i=this._postfix_expression();return i&&(t.postfix=i),t}if(this._match(v.tokens.period)){const e=this._consume(v.tokens.name,"Expected member name."),t=this._postfix_expression(),i=this._updateNode(new bn(e.lexeme));return t&&(i.postfix=t),i}return null}_getStruct(e){return this._context.aliases.has(e)?this._context.aliases.get(e).type:this._context.structs.has(e)?this._context.structs.get(e):null}_getType(e){const t=this._getStruct(e);if(t!==null)return t;switch(e){case"void":return N.void;case"bool":return N.bool;case"i32":return N.i32;case"u32":return N.u32;case"f32":return N.f32;case"f16":return N.f16;case"vec2f":return R.vec2f;case"vec3f":return R.vec3f;case"vec4f":return R.vec4f;case"vec2i":return R.vec2i;case"vec3i":return R.vec3i;case"vec4i":return R.vec4i;case"vec2u":return R.vec2u;case"vec3u":return R.vec3u;case"vec4u":return R.vec4u;case"vec2h":return R.vec2h;case"vec3h":return R.vec3h;case"vec4h":return R.vec4h;case"mat2x2f":return R.mat2x2f;case"mat2x3f":return R.mat2x3f;case"mat2x4f":return R.mat2x4f;case"mat3x2f":return R.mat3x2f;case"mat3x3f":return R.mat3x3f;case"mat3x4f":return R.mat3x4f;case"mat4x2f":return R.mat4x2f;case"mat4x3f":return R.mat4x3f;case"mat4x4f":return R.mat4x4f;case"mat2x2h":return R.mat2x2h;case"mat2x3h":return R.mat2x3h;case"mat2x4h":return R.mat2x4h;case"mat3x2h":return R.mat3x2h;case"mat3x3h":return R.mat3x3h;case"mat3x4h":return R.mat3x4h;case"mat4x2h":return R.mat4x2h;case"mat4x3h":return R.mat4x3h;case"mat4x4h":return R.mat4x4h;case"mat2x2i":return R.mat2x2i;case"mat2x3i":return R.mat2x3i;case"mat2x4i":return R.mat2x4i;case"mat3x2i":return R.mat3x2i;case"mat3x3i":return R.mat3x3i;case"mat3x4i":return R.mat3x4i;case"mat4x2i":return R.mat4x2i;case"mat4x3i":return R.mat4x3i;case"mat4x4i":return R.mat4x4i;case"mat2x2u":return R.mat2x2u;case"mat2x3u":return R.mat2x3u;case"mat2x4u":return R.mat2x4u;case"mat3x2u":return R.mat3x2u;case"mat3x3u":return R.mat3x3u;case"mat3x4u":return R.mat3x4u;case"mat4x2u":return R.mat4x2u;case"mat4x3u":return R.mat4x3u;case"mat4x4u":return R.mat4x4u}return null}_validateTypeRange(e,t){if(t.name==="i32"){if(e<-2147483648||e>2147483647)throw this._error(this._previous(),`Value out of range for i32: ${e}. Line: ${this._currentLine}.`)}else if(t.name==="u32"&&(e<0||e>4294967295))throw this._error(this._previous(),`Value out of range for u32: ${e}. Line: ${this._currentLine}.`)}_primary_expression(){if(this._match(v.tokens.ident)){const i=this._previous().toString();if(this._check(v.tokens.paren_left)){const r=this._argument_expression_list(),s=this._getType(i);return s!==null?this._updateNode(new yt(s,r)):this._updateNode(new Vc(i,r))}if(this._context.constants.has(i)){const r=this._context.constants.get(i);return this._updateNode(new bm(i,r.value))}return this._updateNode(new je(i))}if(this._match(v.tokens.int_literal)){const i=this._previous().toString();let r=i.endsWith("i")||i.endsWith("i")?N.i32:i.endsWith("u")||i.endsWith("U")?N.u32:N.x32;const s=parseInt(i);return this._validateTypeRange(s,r),this._updateNode(new we(new E(s,this._exec.getTypeInfo(r)),r))}if(this._match(v.tokens.uint_literal)){const i=parseInt(this._previous().toString());return this._validateTypeRange(i,N.u32),this._updateNode(new we(new E(i,this._exec.getTypeInfo(N.u32)),N.u32))}if(this._match([v.tokens.decimal_float_literal,v.tokens.hex_float_literal])){let i=this._previous().toString(),r=i.endsWith("h");r&&(i=i.substring(0,i.length-1));const s=parseFloat(i);this._validateTypeRange(s,r?N.f16:N.f32);const o=r?N.f16:N.f32;return this._updateNode(new we(new E(s,this._exec.getTypeInfo(o)),o))}if(this._match([v.keywords.true,v.keywords.false])){let i=this._previous().toString()===v.keywords.true.rule;return this._updateNode(new we(new E(i?1:0,this._exec.getTypeInfo(N.bool)),N.bool))}if(this._check(v.tokens.paren_left))return this._paren_expression();if(this._match(v.keywords.bitcast)){this._consume(v.tokens.less_than,"Expected '<'.");const i=this._type_decl();this._consume(v.tokens.greater_than,"Expected '>'.");const r=this._paren_expression();return this._updateNode(new vm(i,r))}const e=this._type_decl(),t=this._argument_expression_list();return this._updateNode(new yt(e,t))}_argument_expression_list(){if(!this._match(v.tokens.paren_left))return null;const e=[];do{if(this._check(v.tokens.paren_right))break;const t=this._short_circuit_or_expression();e.push(t)}while(this._match(v.tokens.comma));return this._consume(v.tokens.paren_right,"Expected ')' for agument list"),e}_optional_paren_expression(){this._match(v.tokens.paren_left);const e=this._short_circuit_or_expression();return this._match(v.tokens.paren_right),e}_paren_expression(){this._consume(v.tokens.paren_left,"Expected '('.");const e=this._short_circuit_or_expression();return this._consume(v.tokens.paren_right,"Expected ')'."),e}_struct_decl(){if(!this._match(v.keywords.struct))return null;const e=this._currentLine,t=this._consume(v.tokens.ident,"Expected name for struct.").toString();this._consume(v.tokens.brace_left,"Expected '{' for struct body.");const i=[];for(;!this._check(v.tokens.brace_right);){const o=this._attribute(),a=this._consume(v.tokens.name,"Expected variable name.").toString();this._consume(v.tokens.colon,"Expected ':' for struct member type.");const l=this._attribute(),c=this._type_decl();c!=null&&(c.attributes=l),this._check(v.tokens.brace_right)?this._match(v.tokens.comma):this._consume(v.tokens.comma,"Expected ',' for struct member."),i.push(this._updateNode(new nh(a,c,o)))}this._consume(v.tokens.brace_right,"Expected '}' after struct body.");const r=this._currentLine,s=this._updateNode(new It(t,i,e,r),e);return this._context.structs.set(t,s),s}_global_variable_decl(){const e=this._variable_decl();if(!e)return null;if(this._match(v.tokens.equal)){const t=this._const_expression();e.value=t}if(e.type!==null&&e.value instanceof we){if(e.value.type.name!=="x32"&&e.type.getTypeName()!==e.value.type.getTypeName())throw this._error(this._peek(),`Invalid cast from ${e.value.type.name} to ${e.type.name}. Line:${this._currentLine}`);e.value.isScalar&&this._validateTypeRange(e.value.scalarValue,e.type),e.value.type=e.type}else e.type===null&&e.value instanceof we&&(e.type=e.value.type.name==="x32"?N.i32:e.value.type,e.value.isScalar&&this._validateTypeRange(e.value.scalarValue,e.type));return e}_override_variable_decl(){const e=this._override_decl();return e&&this._match(v.tokens.equal)&&(e.value=this._const_expression()),e}_global_const_decl(){var e;if(!this._match(v.keywords.const))return null;const t=this._consume(v.tokens.name,"Expected variable name"),i=this._currentLine;let r=null;if(this._match(v.tokens.colon)){const l=this._attribute();r=this._type_decl(),r!=null&&(r.attributes=l)}let s=null;this._consume(v.tokens.equal,"const declarations require an assignment");const o=this._short_circuit_or_expression();try{let l=[N.f32],c=o.constEvaluate(this._exec,l);c instanceof E&&this._validateTypeRange(c.value,l[0]),l[0]instanceof R&&l[0].format===null&&c.typeInfo instanceof yn&&c.typeInfo.format!==null&&(c.typeInfo.format.name==="f16"?l[0].format=N.f16:c.typeInfo.format.name==="f32"?l[0].format=N.f32:c.typeInfo.format.name==="i32"?l[0].format=N.i32:c.typeInfo.format.name==="u32"?l[0].format=N.u32:c.typeInfo.format.name==="bool"?l[0].format=N.bool:console.error(`TODO: impelement template format type ${c.typeInfo.format.name}`)),s=this._updateNode(new we(c,l[0])),this._exec.context.setVariable(t.toString(),c)}catch{s=o}if(r!==null&&s instanceof we){if(s.type.name!=="x32"&&r.getTypeName()!==s.type.getTypeName())throw this._error(this._peek(),`Invalid cast from ${s.type.name} to ${r.name}. Line:${this._currentLine}`);s.type=r,s.isScalar&&this._validateTypeRange(s.scalarValue,s.type)}else r===null&&s instanceof we&&(r=(e=s==null?void 0:s.type)!==null&&e!==void 0?e:N.f32,r===N.x32&&(r=N.i32));const a=this._updateNode(new Yr(t.toString(),r,"","",s),i);return this._context.constants.set(a.name,a),a}_global_let_decl(){if(!this._match(v.keywords.let))return null;const e=this._currentLine,t=this._consume(v.tokens.name,"Expected variable name");let i=null;if(this._match(v.tokens.colon)){const s=this._attribute();i=this._type_decl(),i!=null&&(i.attributes=s)}let r=null;if(this._match(v.tokens.equal)&&(r=this._const_expression()),i!==null&&r instanceof we){if(r.type.name!=="x32"&&i.getTypeName()!==r.type.getTypeName())throw this._error(this._peek(),`Invalid cast from ${r.type.name} to ${i.name}. Line:${this._currentLine}`);r.type=i}else i===null&&r instanceof we&&(i=r.type.name==="x32"?N.i32:r.type);return r instanceof we&&r.isScalar&&this._validateTypeRange(r.scalarValue,i),this._updateNode(new Mi(t.toString(),i,"","",r),e)}_const_expression(){return this._short_circuit_or_expression()}_variable_decl(){if(!this._match(v.keywords.var))return null;const e=this._currentLine;let t="",i="";this._match(v.tokens.less_than)&&(t=this._consume(v.storage_class,"Expected storage_class.").toString(),this._match(v.tokens.comma)&&(i=this._consume(v.access_mode,"Expected access_mode.").toString()),this._consume(v.tokens.greater_than,"Expected '>'."));const r=this._consume(v.tokens.name,"Expected variable name");let s=null;if(this._match(v.tokens.colon)){const o=this._attribute();s=this._type_decl(),s!=null&&(s.attributes=o)}return this._updateNode(new Pt(r.toString(),s,t,i,null),e)}_override_decl(){if(!this._match(v.keywords.override))return null;const e=this._consume(v.tokens.name,"Expected variable name");let t=null;if(this._match(v.tokens.colon)){const i=this._attribute();t=this._type_decl(),t!=null&&(t.attributes=i)}return this._updateNode(new Uc(e.toString(),t,null))}_diagnostic(){this._consume(v.tokens.paren_left,"Expected '('");const e=this._consume(v.tokens.ident,"Expected severity control name.");this._consume(v.tokens.comma,"Expected ','");let t=this._consume(v.tokens.ident,"Expected diagnostic rule name.").toString();return this._match(v.tokens.period)&&(t+=`.${this._consume(v.tokens.ident,"Expected diagnostic message.").toString()}`),this._consume(v.tokens.paren_right,"Expected ')'"),this._updateNode(new mm(e.toString(),t))}_enable_directive(){const e=this._consume(v.tokens.ident,"identity expected.");return this._updateNode(new QC(e.toString()))}_requires_directive(){const e=[this._consume(v.tokens.ident,"identity expected.").toString()];for(;this._match(v.tokens.comma);){const t=this._consume(v.tokens.ident,"identity expected.");e.push(t.toString())}return this._updateNode(new JC(e))}_type_alias(){const e=this._consume(v.tokens.ident,"identity expected.");this._consume(v.tokens.equal,"Expected '=' for type alias.");let t=this._type_decl();if(t===null)throw this._error(this._peek(),"Expected Type for Alias.");this._context.aliases.has(t.name)&&(t=this._context.aliases.get(t.name).type);const i=this._updateNode(new zc(e.toString(),t));return this._context.aliases.set(i.name,i),i}_type_decl(){if(this._check([v.tokens.ident,...v.texel_format,v.keywords.bool,v.keywords.f32,v.keywords.i32,v.keywords.u32])){const i=this._advance().toString();if(this._context.structs.has(i))return this._context.structs.get(i);if(this._context.aliases.has(i))return this._context.aliases.get(i).type;if(!this._getType(i)){const r=this._updateNode(new eh(i));return this._forwardTypeCount++,r}return this._updateNode(new N(i))}let e=this._texture_sampler_types();if(e)return e;if(this._check(v.template_types)){let i=this._advance().toString(),r=null,s=null;return this._match(v.tokens.less_than)&&(r=this._type_decl(),s=null,this._match(v.tokens.comma)&&(s=this._consume(v.access_mode,"Expected access_mode for pointer").toString()),this._consume(v.tokens.greater_than,"Expected '>' for type.")),this._updateNode(new R(i,r,s))}if(this._match(v.keywords.ptr)){let i=this._previous().toString();this._consume(v.tokens.less_than,"Expected '<' for pointer.");const r=this._consume(v.storage_class,"Expected storage_class for pointer");this._consume(v.tokens.comma,"Expected ',' for pointer.");const s=this._type_decl();let o=null;return this._match(v.tokens.comma)&&(o=this._consume(v.access_mode,"Expected access_mode for pointer").toString()),this._consume(v.tokens.greater_than,"Expected '>' for pointer."),this._updateNode(new qr(i,r.toString(),s,o))}const t=this._attribute();if(this._match(v.keywords.array)){let i=null,r=-1;const s=this._previous();let o=null;if(this._match(v.tokens.less_than)){i=this._type_decl(),this._context.aliases.has(i.name)&&(i=this._context.aliases.get(i.name).type);let l="";if(this._match(v.tokens.comma)){o=this._shift_expression();try{l=o.constEvaluate(this._exec).toString(),o=null}catch{l="1"}}this._consume(v.tokens.greater_than,"Expected '>' for array."),r=l?parseInt(l):0}const a=this._updateNode(new ki(s.toString(),t,i,r));return o&&this._deferArrayCountEval.push({arrayType:a,countNode:o}),a}return null}_texture_sampler_types(){if(this._match(v.sampler_type))return this._updateNode(new xi(this._previous().toString(),null,null));if(this._match(v.depth_texture_type))return this._updateNode(new xi(this._previous().toString(),null,null));if(this._match(v.sampled_texture_type)||this._match(v.multisampled_texture_type)){const e=this._previous();this._consume(v.tokens.less_than,"Expected '<' for sampler type.");const t=this._type_decl();return this._consume(v.tokens.greater_than,"Expected '>' for sampler type."),this._updateNode(new xi(e.toString(),t,null))}if(this._match(v.storage_texture_type)){const e=this._previous();this._consume(v.tokens.less_than,"Expected '<' for sampler type.");const t=this._consume(v.texel_format,"Invalid texel format.").toString();this._consume(v.tokens.comma,"Expected ',' after texel format.");const i=this._consume(v.access_mode,"Expected access mode for storage texture type.").toString();return this._consume(v.tokens.greater_than,"Expected '>' for sampler type."),this._updateNode(new xi(e.toString(),t,i))}return null}_attribute(){let e=[];for(;this._match(v.tokens.attr);){const t=this._consume(v.attribute_name,"Expected attribute name"),i=this._updateNode(new Em(t.toString(),null));if(this._match(v.tokens.paren_left)){if(i.value=this._consume(v.literal_or_ident,"Expected attribute value").toString(),this._check(v.tokens.comma)){this._advance();do{const r=this._consume(v.literal_or_ident,"Expected attribute value").toString();i.value instanceof Array||(i.value=[i.value]),i.value.push(r)}while(this._match(v.tokens.comma))}this._consume(v.tokens.paren_right,"Expected ')'")}e.push(i)}return e.length==0?null:e}}class g2 extends vt{constructor(e){super(),e&&this.update(e)}update(e){const t=new p2().parse(e);this.updateAST(t)}}function m2(n){var s;const e={attributes:[],bindings:[]};let t;try{t=_2(n)}catch(o){return L.error(o.message)(),e}for(const o of t.uniforms){const a=[];for(const l of((s=o.type)==null?void 0:s.members)||[])a.push({name:l.name,type:sh(l.type)});e.bindings.push({type:"uniform",name:o.name,group:o.group,location:o.binding,members:a})}for(const o of t.textures)e.bindings.push({type:"texture",name:o.name,group:o.group,location:o.binding});for(const o of t.samplers)e.bindings.push({type:"sampler",name:o.name,group:o.group,location:o.binding});const i=t.entry.vertex[0],r=(i==null?void 0:i.inputs.length)||0;for(let o=0;o<r;o++){const a=i.inputs[o];if(a.locationType==="location"){const l=sh(a.type);e.attributes.push({name:a.name,location:Number(a.location),type:l})}}return e}function sh(n){return n.format?`${n.name}<${n.format.name}>`:n.name}function _2(n){try{return new g2(n)}catch(e){if(e instanceof Error)throw e;let t="WGSL parse error";throw typeof e=="object"&&(e!=null&&e.message)&&(t+=`: ${e.message} `),typeof e=="object"&&(e!=null&&e.token)&&(t+=e.token.line||""),new Error(t,{cause:e})}}const y2={EPSILON:1e-12,debug:!1,precision:4,printTypes:!1,printDegrees:!1,printRowMajor:!0,_cartographicRadians:!1};globalThis.mathgl=globalThis.mathgl||{config:{...y2}};const Xe=globalThis.mathgl.config;function b2(n,{precision:e=Xe.precision}={}){return n=v2(n),`${parseFloat(n.toPrecision(e))}`}function ei(n){return Array.isArray(n)||ArrayBuffer.isView(n)&&!(n instanceof DataView)}function Ce(n,e,t){return w2(n,i=>Math.max(e,Math.min(t,i)))}function Ls(n,e,t){return ei(n)?n.map((i,r)=>Ls(i,e[r],t)):t*e+(1-t)*n}function qi(n,e,t){const i=Xe.EPSILON;t&&(Xe.EPSILON=t);try{if(n===e)return!0;if(ei(n)&&ei(e)){if(n.length!==e.length)return!1;for(let r=0;r<n.length;++r)if(!qi(n[r],e[r]))return!1;return!0}return n&&n.equals?n.equals(e):e&&e.equals?e.equals(n):typeof n=="number"&&typeof e=="number"?Math.abs(n-e)<=Xe.EPSILON*Math.max(1,Math.abs(n),Math.abs(e)):!1}finally{Xe.EPSILON=i}}function v2(n){return Math.round(n/Xe.EPSILON)*Xe.EPSILON}function x2(n){return n.clone?n.clone():new Array(n.length)}function w2(n,e,t){if(ei(n)){const i=n;t=t||x2(i);for(let r=0;r<t.length&&r<i.length;++r){const s=typeof n=="number"?n:n[r];t[r]=e(s,r,t)}return t}return e(n)}class Am extends Array{clone(){return new this.constructor().copy(this)}fromArray(e,t=0){for(let i=0;i<this.ELEMENTS;++i)this[i]=e[i+t];return this.check()}toArray(e=[],t=0){for(let i=0;i<this.ELEMENTS;++i)e[t+i]=this[i];return e}toObject(e){return e}from(e){return Array.isArray(e)?this.copy(e):this.fromObject(e)}to(e){return e===this?this:ei(e)?this.toArray(e):this.toObject(e)}toTarget(e){return e?this.to(e):this}toFloat32Array(){return new Float32Array(this)}toString(){return this.formatString(Xe)}formatString(e){let t="";for(let i=0;i<this.ELEMENTS;++i)t+=(i>0?", ":"")+b2(this[i],e);return`${e.printTypes?this.constructor.name:""}[${t}]`}equals(e){if(!e||this.length!==e.length)return!1;for(let t=0;t<this.ELEMENTS;++t)if(!qi(this[t],e[t]))return!1;return!0}exactEquals(e){if(!e||this.length!==e.length)return!1;for(let t=0;t<this.ELEMENTS;++t)if(this[t]!==e[t])return!1;return!0}negate(){for(let e=0;e<this.ELEMENTS;++e)this[e]=-this[e];return this.check()}lerp(e,t,i){if(i===void 0)return this.lerp(this,e,t);for(let r=0;r<this.ELEMENTS;++r){const s=e[r],o=typeof t=="number"?t:t[r];this[r]=s+i*(o-s)}return this.check()}min(e){for(let t=0;t<this.ELEMENTS;++t)this[t]=Math.min(e[t],this[t]);return this.check()}max(e){for(let t=0;t<this.ELEMENTS;++t)this[t]=Math.max(e[t],this[t]);return this.check()}clamp(e,t){for(let i=0;i<this.ELEMENTS;++i)this[i]=Math.min(Math.max(this[i],e[i]),t[i]);return this.check()}add(...e){for(const t of e)for(let i=0;i<this.ELEMENTS;++i)this[i]+=t[i];return this.check()}subtract(...e){for(const t of e)for(let i=0;i<this.ELEMENTS;++i)this[i]-=t[i];return this.check()}scale(e){if(typeof e=="number")for(let t=0;t<this.ELEMENTS;++t)this[t]*=e;else for(let t=0;t<this.ELEMENTS&&t<e.length;++t)this[t]*=e[t];return this.check()}multiplyByScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]*=e;return this.check()}check(){if(Xe.debug&&!this.validate())throw new Error(`math.gl: ${this.constructor.name} some fields set to invalid numbers'`);return this}validate(){let e=this.length===this.ELEMENTS;for(let t=0;t<this.ELEMENTS;++t)e=e&&Number.isFinite(this[t]);return e}sub(e){return this.subtract(e)}setScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]=e;return this.check()}addScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]+=e;return this.check()}subScalar(e){return this.addScalar(-e)}multiplyScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]*=e;return this.check()}divideScalar(e){return this.multiplyByScalar(1/e)}clampScalar(e,t){for(let i=0;i<this.ELEMENTS;++i)this[i]=Math.min(Math.max(this[i],e),t);return this.check()}get elements(){return this}}function T2(n,e){if(n.length!==e)return!1;for(let t=0;t<n.length;++t)if(!Number.isFinite(n[t]))return!1;return!0}function He(n){if(!Number.isFinite(n))throw new Error(`Invalid number ${JSON.stringify(n)}`);return n}function ta(n,e,t=""){if(Xe.debug&&!T2(n,e))throw new Error(`math.gl: ${t} some fields set to invalid numbers'`);return n}function oh(n,e){if(!n)throw new Error(`math.gl assertion ${e}`)}class S2 extends Am{get x(){return this[0]}set x(e){this[0]=He(e)}get y(){return this[1]}set y(e){this[1]=He(e)}len(){return Math.sqrt(this.lengthSquared())}magnitude(){return this.len()}lengthSquared(){let e=0;for(let t=0;t<this.ELEMENTS;++t)e+=this[t]*this[t];return e}magnitudeSquared(){return this.lengthSquared()}distance(e){return Math.sqrt(this.distanceSquared(e))}distanceSquared(e){let t=0;for(let i=0;i<this.ELEMENTS;++i){const r=this[i]-e[i];t+=r*r}return He(t)}dot(e){let t=0;for(let i=0;i<this.ELEMENTS;++i)t+=this[i]*e[i];return He(t)}normalize(){const e=this.magnitude();if(e!==0)for(let t=0;t<this.ELEMENTS;++t)this[t]/=e;return this.check()}multiply(...e){for(const t of e)for(let i=0;i<this.ELEMENTS;++i)this[i]*=t[i];return this.check()}divide(...e){for(const t of e)for(let i=0;i<this.ELEMENTS;++i)this[i]/=t[i];return this.check()}lengthSq(){return this.lengthSquared()}distanceTo(e){return this.distance(e)}distanceToSquared(e){return this.distanceSquared(e)}getComponent(e){return oh(e>=0&&e<this.ELEMENTS,"index is out of range"),He(this[e])}setComponent(e,t){return oh(e>=0&&e<this.ELEMENTS,"index is out of range"),this[e]=t,this.check()}addVectors(e,t){return this.copy(e).add(t)}subVectors(e,t){return this.copy(e).subtract(t)}multiplyVectors(e,t){return this.copy(e).multiply(t)}addScaledVector(e,t){return this.add(new this.constructor(e).multiplyScalar(t))}}const Zr=1e-6;let ti=typeof Float32Array<"u"?Float32Array:Array;function E2(){const n=new ti(2);return ti!=Float32Array&&(n[0]=0,n[1]=0),n}function Us(n,e,t){return n[0]=e[0]+t[0],n[1]=e[1]+t[1],n}function Cm(n,e){return n[0]=-e[0],n[1]=-e[1],n}function Im(n,e,t,i){const r=e[0],s=e[1];return n[0]=r+i*(t[0]-r),n[1]=s+i*(t[1]-s),n}function A2(n,e,t){const i=e[0],r=e[1];return n[0]=t[0]*i+t[4]*r+t[12],n[1]=t[1]*i+t[5]*r+t[13],n}(function(){const n=E2();return function(e,t,i,r,s,o){let a,l;for(t||(t=2),i||(i=0),r?l=Math.min(r*t+i,e.length):l=e.length,a=i;a<l;a+=t)n[0]=e[a],n[1]=e[a+1],s(n,n,o),e[a]=n[0],e[a+1]=n[1];return e}})();function C2(n,e,t){const i=e[0],r=e[1],s=t[3]*i+t[7]*r||1;return n[0]=(t[0]*i+t[4]*r)/s,n[1]=(t[1]*i+t[5]*r)/s,n}function Rm(n,e,t){const i=e[0],r=e[1],s=e[2],o=t[3]*i+t[7]*r+t[11]*s||1;return n[0]=(t[0]*i+t[4]*r+t[8]*s)/o,n[1]=(t[1]*i+t[5]*r+t[9]*s)/o,n[2]=(t[2]*i+t[6]*r+t[10]*s)/o,n}function I2(n,e,t){const i=e[0],r=e[1];return n[0]=t[0]*i+t[2]*r,n[1]=t[1]*i+t[3]*r,n[2]=e[2],n}function R2(){const n=new ti(3);return ti!=Float32Array&&(n[0]=0,n[1]=0,n[2]=0),n}function P2(n,e,t){return n[0]=e[0]-t[0],n[1]=e[1]-t[1],n[2]=e[2]-t[2],n}function M2(n,e){return n[0]=-e[0],n[1]=-e[1],n[2]=-e[2],n}function k2(n,e){return n[0]*e[0]+n[1]*e[1]+n[2]*e[2]}function O2(n,e,t){const i=e[0],r=e[1],s=e[2],o=t[0],a=t[1],l=t[2];return n[0]=r*l-s*a,n[1]=s*o-i*l,n[2]=i*a-r*o,n}function Pm(n,e,t){const i=e[0],r=e[1],s=e[2];let o=t[3]*i+t[7]*r+t[11]*s+t[15];return o=o||1,n[0]=(t[0]*i+t[4]*r+t[8]*s+t[12])/o,n[1]=(t[1]*i+t[5]*r+t[9]*s+t[13])/o,n[2]=(t[2]*i+t[6]*r+t[10]*s+t[14])/o,n}function N2(n,e,t){const i=e[0],r=e[1],s=e[2];return n[0]=i*t[0]+r*t[3]+s*t[6],n[1]=i*t[1]+r*t[4]+s*t[7],n[2]=i*t[2]+r*t[5]+s*t[8],n}function F2(n,e,t){const i=t[0],r=t[1],s=t[2],o=t[3],a=e[0],l=e[1],c=e[2];let u=r*c-s*l,d=s*a-i*c,h=i*l-r*a,f=r*h-s*d,p=s*u-i*h,g=i*d-r*u;const _=o*2;return u*=_,d*=_,h*=_,f*=2,p*=2,g*=2,n[0]=a+u+f,n[1]=l+d+p,n[2]=c+h+g,n}function D2(n,e,t,i){const r=[],s=[];return r[0]=e[0]-t[0],r[1]=e[1]-t[1],r[2]=e[2]-t[2],s[0]=r[0],s[1]=r[1]*Math.cos(i)-r[2]*Math.sin(i),s[2]=r[1]*Math.sin(i)+r[2]*Math.cos(i),n[0]=s[0]+t[0],n[1]=s[1]+t[1],n[2]=s[2]+t[2],n}function B2(n,e,t,i){const r=[],s=[];return r[0]=e[0]-t[0],r[1]=e[1]-t[1],r[2]=e[2]-t[2],s[0]=r[2]*Math.sin(i)+r[0]*Math.cos(i),s[1]=r[1],s[2]=r[2]*Math.cos(i)-r[0]*Math.sin(i),n[0]=s[0]+t[0],n[1]=s[1]+t[1],n[2]=s[2]+t[2],n}function L2(n,e,t,i){const r=[],s=[];return r[0]=e[0]-t[0],r[1]=e[1]-t[1],r[2]=e[2]-t[2],s[0]=r[0]*Math.cos(i)-r[1]*Math.sin(i),s[1]=r[0]*Math.sin(i)+r[1]*Math.cos(i),s[2]=r[2],n[0]=s[0]+t[0],n[1]=s[1]+t[1],n[2]=s[2]+t[2],n}function U2(n,e){const t=n[0],i=n[1],r=n[2],s=e[0],o=e[1],a=e[2],l=Math.sqrt((t*t+i*i+r*r)*(s*s+o*o+a*a)),c=l&&k2(n,e)/l;return Math.acos(Math.min(Math.max(c,-1),1))}const $2=P2;(function(){const n=R2();return function(e,t,i,r,s,o){let a,l;for(t||(t=3),i||(i=0),r?l=Math.min(r*t+i,e.length):l=e.length,a=i;a<l;a+=t)n[0]=e[a],n[1]=e[a+1],n[2]=e[a+2],s(n,n,o),e[a]=n[0],e[a+1]=n[1],e[a+2]=n[2];return e}})();const na=[0,0,0];let Mr;class Tt extends S2{static get ZERO(){return Mr||(Mr=new Tt(0,0,0),Object.freeze(Mr)),Mr}constructor(e=0,t=0,i=0){super(-0,-0,-0),arguments.length===1&&ei(e)?this.copy(e):(Xe.debug&&(He(e),He(t),He(i)),this[0]=e,this[1]=t,this[2]=i)}set(e,t,i){return this[0]=e,this[1]=t,this[2]=i,this.check()}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this.check()}fromObject(e){return Xe.debug&&(He(e.x),He(e.y),He(e.z)),this[0]=e.x,this[1]=e.y,this[2]=e.z,this.check()}toObject(e){return e.x=this[0],e.y=this[1],e.z=this[2],e}get ELEMENTS(){return 3}get z(){return this[2]}set z(e){this[2]=He(e)}angle(e){return U2(this,e)}cross(e){return O2(this,this,e),this.check()}rotateX({radians:e,origin:t=na}){return D2(this,this,t,e),this.check()}rotateY({radians:e,origin:t=na}){return B2(this,this,t,e),this.check()}rotateZ({radians:e,origin:t=na}){return L2(this,this,t,e),this.check()}transform(e){return this.transformAsPoint(e)}transformAsPoint(e){return Pm(this,this,e),this.check()}transformAsVector(e){return Rm(this,this,e),this.check()}transformByMatrix3(e){return N2(this,this,e),this.check()}transformByMatrix2(e){return I2(this,this,e),this.check()}transformByQuaternion(e){return F2(this,this,e),this.check()}}class z2 extends Am{toString(){let e="[";if(Xe.printRowMajor){e+="row-major:";for(let t=0;t<this.RANK;++t)for(let i=0;i<this.RANK;++i)e+=` ${this[i*this.RANK+t]}`}else{e+="column-major:";for(let t=0;t<this.ELEMENTS;++t)e+=` ${this[t]}`}return e+="]",e}getElementIndex(e,t){return t*this.RANK+e}getElement(e,t){return this[t*this.RANK+e]}setElement(e,t,i){return this[t*this.RANK+e]=He(i),this}getColumn(e,t=new Array(this.RANK).fill(-0)){const i=e*this.RANK;for(let r=0;r<this.RANK;++r)t[r]=this[i+r];return t}setColumn(e,t){const i=e*this.RANK;for(let r=0;r<this.RANK;++r)this[i+r]=t[r];return this}}function V2(n){return n[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=1,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=1,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n}function W2(n,e){if(n===e){const t=e[1],i=e[2],r=e[3],s=e[6],o=e[7],a=e[11];n[1]=e[4],n[2]=e[8],n[3]=e[12],n[4]=t,n[6]=e[9],n[7]=e[13],n[8]=i,n[9]=s,n[11]=e[14],n[12]=r,n[13]=o,n[14]=a}else n[0]=e[0],n[1]=e[4],n[2]=e[8],n[3]=e[12],n[4]=e[1],n[5]=e[5],n[6]=e[9],n[7]=e[13],n[8]=e[2],n[9]=e[6],n[10]=e[10],n[11]=e[14],n[12]=e[3],n[13]=e[7],n[14]=e[11],n[15]=e[15];return n}function yl(n,e){const t=e[0],i=e[1],r=e[2],s=e[3],o=e[4],a=e[5],l=e[6],c=e[7],u=e[8],d=e[9],h=e[10],f=e[11],p=e[12],g=e[13],_=e[14],b=e[15],w=t*a-i*o,x=t*l-r*o,y=t*c-s*o,S=i*l-r*a,I=i*c-s*a,F=r*c-s*l,D=u*g-d*p,B=u*_-h*p,U=u*b-f*p,O=d*_-h*g,H=d*b-f*g,$=h*b-f*_;let z=w*$-x*H+y*O+S*U-I*B+F*D;return z?(z=1/z,n[0]=(a*$-l*H+c*O)*z,n[1]=(r*H-i*$-s*O)*z,n[2]=(g*F-_*I+b*S)*z,n[3]=(h*I-d*F-f*S)*z,n[4]=(l*U-o*$-c*B)*z,n[5]=(t*$-r*U+s*B)*z,n[6]=(_*y-p*F-b*x)*z,n[7]=(u*F-h*y+f*x)*z,n[8]=(o*H-a*U+c*D)*z,n[9]=(i*U-t*H-s*D)*z,n[10]=(p*I-g*y+b*w)*z,n[11]=(d*y-u*I-f*w)*z,n[12]=(a*B-o*O-l*D)*z,n[13]=(t*O-i*B+r*D)*z,n[14]=(g*x-p*S-_*w)*z,n[15]=(u*S-d*x+h*w)*z,n):null}function H2(n){const e=n[0],t=n[1],i=n[2],r=n[3],s=n[4],o=n[5],a=n[6],l=n[7],c=n[8],u=n[9],d=n[10],h=n[11],f=n[12],p=n[13],g=n[14],_=n[15],b=e*o-t*s,w=e*a-i*s,x=t*a-i*o,y=c*p-u*f,S=c*g-d*f,I=u*g-d*p,F=e*I-t*S+i*y,D=s*I-o*S+a*y,B=c*x-u*w+d*b,U=f*x-p*w+g*b;return l*F-r*D+_*B-h*U}function fn(n,e,t){const i=e[0],r=e[1],s=e[2],o=e[3],a=e[4],l=e[5],c=e[6],u=e[7],d=e[8],h=e[9],f=e[10],p=e[11],g=e[12],_=e[13],b=e[14],w=e[15];let x=t[0],y=t[1],S=t[2],I=t[3];return n[0]=x*i+y*a+S*d+I*g,n[1]=x*r+y*l+S*h+I*_,n[2]=x*s+y*c+S*f+I*b,n[3]=x*o+y*u+S*p+I*w,x=t[4],y=t[5],S=t[6],I=t[7],n[4]=x*i+y*a+S*d+I*g,n[5]=x*r+y*l+S*h+I*_,n[6]=x*s+y*c+S*f+I*b,n[7]=x*o+y*u+S*p+I*w,x=t[8],y=t[9],S=t[10],I=t[11],n[8]=x*i+y*a+S*d+I*g,n[9]=x*r+y*l+S*h+I*_,n[10]=x*s+y*c+S*f+I*b,n[11]=x*o+y*u+S*p+I*w,x=t[12],y=t[13],S=t[14],I=t[15],n[12]=x*i+y*a+S*d+I*g,n[13]=x*r+y*l+S*h+I*_,n[14]=x*s+y*c+S*f+I*b,n[15]=x*o+y*u+S*p+I*w,n}function $s(n,e,t){const i=t[0],r=t[1],s=t[2];let o,a,l,c,u,d,h,f,p,g,_,b;return e===n?(n[12]=e[0]*i+e[4]*r+e[8]*s+e[12],n[13]=e[1]*i+e[5]*r+e[9]*s+e[13],n[14]=e[2]*i+e[6]*r+e[10]*s+e[14],n[15]=e[3]*i+e[7]*r+e[11]*s+e[15]):(o=e[0],a=e[1],l=e[2],c=e[3],u=e[4],d=e[5],h=e[6],f=e[7],p=e[8],g=e[9],_=e[10],b=e[11],n[0]=o,n[1]=a,n[2]=l,n[3]=c,n[4]=u,n[5]=d,n[6]=h,n[7]=f,n[8]=p,n[9]=g,n[10]=_,n[11]=b,n[12]=o*i+u*r+p*s+e[12],n[13]=a*i+d*r+g*s+e[13],n[14]=l*i+h*r+_*s+e[14],n[15]=c*i+f*r+b*s+e[15]),n}function Yc(n,e,t){const i=t[0],r=t[1],s=t[2];return n[0]=e[0]*i,n[1]=e[1]*i,n[2]=e[2]*i,n[3]=e[3]*i,n[4]=e[4]*r,n[5]=e[5]*r,n[6]=e[6]*r,n[7]=e[7]*r,n[8]=e[8]*s,n[9]=e[9]*s,n[10]=e[10]*s,n[11]=e[11]*s,n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15],n}function j2(n,e,t,i){let r=i[0],s=i[1],o=i[2],a=Math.sqrt(r*r+s*s+o*o),l,c,u,d,h,f,p,g,_,b,w,x,y,S,I,F,D,B,U,O,H,$,z,te;return a<Zr?null:(a=1/a,r*=a,s*=a,o*=a,c=Math.sin(t),l=Math.cos(t),u=1-l,d=e[0],h=e[1],f=e[2],p=e[3],g=e[4],_=e[5],b=e[6],w=e[7],x=e[8],y=e[9],S=e[10],I=e[11],F=r*r*u+l,D=s*r*u+o*c,B=o*r*u-s*c,U=r*s*u-o*c,O=s*s*u+l,H=o*s*u+r*c,$=r*o*u+s*c,z=s*o*u-r*c,te=o*o*u+l,n[0]=d*F+g*D+x*B,n[1]=h*F+_*D+y*B,n[2]=f*F+b*D+S*B,n[3]=p*F+w*D+I*B,n[4]=d*U+g*O+x*H,n[5]=h*U+_*O+y*H,n[6]=f*U+b*O+S*H,n[7]=p*U+w*O+I*H,n[8]=d*$+g*z+x*te,n[9]=h*$+_*z+y*te,n[10]=f*$+b*z+S*te,n[11]=p*$+w*z+I*te,e!==n&&(n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15]),n)}function Mm(n,e,t){const i=Math.sin(t),r=Math.cos(t),s=e[4],o=e[5],a=e[6],l=e[7],c=e[8],u=e[9],d=e[10],h=e[11];return e!==n&&(n[0]=e[0],n[1]=e[1],n[2]=e[2],n[3]=e[3],n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15]),n[4]=s*r+c*i,n[5]=o*r+u*i,n[6]=a*r+d*i,n[7]=l*r+h*i,n[8]=c*r-s*i,n[9]=u*r-o*i,n[10]=d*r-a*i,n[11]=h*r-l*i,n}function X2(n,e,t){const i=Math.sin(t),r=Math.cos(t),s=e[0],o=e[1],a=e[2],l=e[3],c=e[8],u=e[9],d=e[10],h=e[11];return e!==n&&(n[4]=e[4],n[5]=e[5],n[6]=e[6],n[7]=e[7],n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15]),n[0]=s*r-c*i,n[1]=o*r-u*i,n[2]=a*r-d*i,n[3]=l*r-h*i,n[8]=s*i+c*r,n[9]=o*i+u*r,n[10]=a*i+d*r,n[11]=l*i+h*r,n}function km(n,e,t){const i=Math.sin(t),r=Math.cos(t),s=e[0],o=e[1],a=e[2],l=e[3],c=e[4],u=e[5],d=e[6],h=e[7];return e!==n&&(n[8]=e[8],n[9]=e[9],n[10]=e[10],n[11]=e[11],n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15]),n[0]=s*r+c*i,n[1]=o*r+u*i,n[2]=a*r+d*i,n[3]=l*r+h*i,n[4]=c*r-s*i,n[5]=u*r-o*i,n[6]=d*r-a*i,n[7]=h*r-l*i,n}function Y2(n,e){const t=e[0],i=e[1],r=e[2],s=e[3],o=t+t,a=i+i,l=r+r,c=t*o,u=i*o,d=i*a,h=r*o,f=r*a,p=r*l,g=s*o,_=s*a,b=s*l;return n[0]=1-d-p,n[1]=u+b,n[2]=h-_,n[3]=0,n[4]=u-b,n[5]=1-c-p,n[6]=f+g,n[7]=0,n[8]=h+_,n[9]=f-g,n[10]=1-c-d,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n}function q2(n,e,t,i,r,s,o){const a=1/(t-e),l=1/(r-i),c=1/(s-o);return n[0]=s*2*a,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=s*2*l,n[6]=0,n[7]=0,n[8]=(t+e)*a,n[9]=(r+i)*l,n[10]=(o+s)*c,n[11]=-1,n[12]=0,n[13]=0,n[14]=o*s*2*c,n[15]=0,n}function K2(n,e,t,i,r){const s=1/Math.tan(e/2);if(n[0]=s/t,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=s,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[11]=-1,n[12]=0,n[13]=0,n[15]=0,r!=null&&r!==1/0){const o=1/(i-r);n[10]=(r+i)*o,n[14]=2*r*i*o}else n[10]=-1,n[14]=-2*i;return n}const Z2=K2;function G2(n,e,t,i,r,s,o){const a=1/(e-t),l=1/(i-r),c=1/(s-o);return n[0]=-2*a,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=-2*l,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=2*c,n[11]=0,n[12]=(e+t)*a,n[13]=(r+i)*l,n[14]=(o+s)*c,n[15]=1,n}const Q2=G2;function J2(n,e,t,i){let r,s,o,a,l,c,u,d,h,f;const p=e[0],g=e[1],_=e[2],b=i[0],w=i[1],x=i[2],y=t[0],S=t[1],I=t[2];return Math.abs(p-y)<Zr&&Math.abs(g-S)<Zr&&Math.abs(_-I)<Zr?V2(n):(d=p-y,h=g-S,f=_-I,r=1/Math.sqrt(d*d+h*h+f*f),d*=r,h*=r,f*=r,s=w*f-x*h,o=x*d-b*f,a=b*h-w*d,r=Math.sqrt(s*s+o*o+a*a),r?(r=1/r,s*=r,o*=r,a*=r):(s=0,o=0,a=0),l=h*a-f*o,c=f*s-d*a,u=d*o-h*s,r=Math.sqrt(l*l+c*c+u*u),r?(r=1/r,l*=r,c*=r,u*=r):(l=0,c=0,u=0),n[0]=s,n[1]=l,n[2]=d,n[3]=0,n[4]=o,n[5]=c,n[6]=h,n[7]=0,n[8]=a,n[9]=u,n[10]=f,n[11]=0,n[12]=-(s*p+o*g+a*_),n[13]=-(l*p+c*g+u*_),n[14]=-(d*p+h*g+f*_),n[15]=1,n)}function e3(){const n=new ti(4);return ti!=Float32Array&&(n[0]=0,n[1]=0,n[2]=0,n[3]=0),n}function t3(n,e,t){return n[0]=e[0]*t,n[1]=e[1]*t,n[2]=e[2]*t,n[3]=e[3]*t,n}function ar(n,e,t){const i=e[0],r=e[1],s=e[2],o=e[3];return n[0]=t[0]*i+t[4]*r+t[8]*s+t[12]*o,n[1]=t[1]*i+t[5]*r+t[9]*s+t[13]*o,n[2]=t[2]*i+t[6]*r+t[10]*s+t[14]*o,n[3]=t[3]*i+t[7]*r+t[11]*s+t[15]*o,n}(function(){const n=e3();return function(e,t,i,r,s,o){let a,l;for(t||(t=4),i||(i=0),r?l=Math.min(r*t+i,e.length):l=e.length,a=i;a<l;a+=t)n[0]=e[a],n[1]=e[a+1],n[2]=e[a+2],n[3]=e[a+3],s(n,n,o),e[a]=n[0],e[a+1]=n[1],e[a+2]=n[2],e[a+3]=n[3];return e}})();var bl;(function(n){n[n.COL0ROW0=0]="COL0ROW0",n[n.COL0ROW1=1]="COL0ROW1",n[n.COL0ROW2=2]="COL0ROW2",n[n.COL0ROW3=3]="COL0ROW3",n[n.COL1ROW0=4]="COL1ROW0",n[n.COL1ROW1=5]="COL1ROW1",n[n.COL1ROW2=6]="COL1ROW2",n[n.COL1ROW3=7]="COL1ROW3",n[n.COL2ROW0=8]="COL2ROW0",n[n.COL2ROW1=9]="COL2ROW1",n[n.COL2ROW2=10]="COL2ROW2",n[n.COL2ROW3=11]="COL2ROW3",n[n.COL3ROW0=12]="COL3ROW0",n[n.COL3ROW1=13]="COL3ROW1",n[n.COL3ROW2=14]="COL3ROW2",n[n.COL3ROW3=15]="COL3ROW3"})(bl||(bl={}));const n3=45*Math.PI/180,i3=1,ia=.1,ra=500,r3=Object.freeze([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);class qe extends z2{static get IDENTITY(){return o3()}static get ZERO(){return s3()}get ELEMENTS(){return 16}get RANK(){return 4}get INDICES(){return bl}constructor(e){super(-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0),arguments.length===1&&Array.isArray(e)?this.copy(e):this.identity()}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this[3]=e[3],this[4]=e[4],this[5]=e[5],this[6]=e[6],this[7]=e[7],this[8]=e[8],this[9]=e[9],this[10]=e[10],this[11]=e[11],this[12]=e[12],this[13]=e[13],this[14]=e[14],this[15]=e[15],this.check()}set(e,t,i,r,s,o,a,l,c,u,d,h,f,p,g,_){return this[0]=e,this[1]=t,this[2]=i,this[3]=r,this[4]=s,this[5]=o,this[6]=a,this[7]=l,this[8]=c,this[9]=u,this[10]=d,this[11]=h,this[12]=f,this[13]=p,this[14]=g,this[15]=_,this.check()}setRowMajor(e,t,i,r,s,o,a,l,c,u,d,h,f,p,g,_){return this[0]=e,this[1]=s,this[2]=c,this[3]=f,this[4]=t,this[5]=o,this[6]=u,this[7]=p,this[8]=i,this[9]=a,this[10]=d,this[11]=g,this[12]=r,this[13]=l,this[14]=h,this[15]=_,this.check()}toRowMajor(e){return e[0]=this[0],e[1]=this[4],e[2]=this[8],e[3]=this[12],e[4]=this[1],e[5]=this[5],e[6]=this[9],e[7]=this[13],e[8]=this[2],e[9]=this[6],e[10]=this[10],e[11]=this[14],e[12]=this[3],e[13]=this[7],e[14]=this[11],e[15]=this[15],e}identity(){return this.copy(r3)}fromObject(e){return this.check()}fromQuaternion(e){return Y2(this,e),this.check()}frustum(e){const{left:t,right:i,bottom:r,top:s,near:o=ia,far:a=ra}=e;return a===1/0?a3(this,t,i,r,s,o):q2(this,t,i,r,s,o,a),this.check()}lookAt(e){const{eye:t,center:i=[0,0,0],up:r=[0,1,0]}=e;return J2(this,t,i,r),this.check()}ortho(e){const{left:t,right:i,bottom:r,top:s,near:o=ia,far:a=ra}=e;return Q2(this,t,i,r,s,o,a),this.check()}orthographic(e){const{fovy:t=n3,aspect:i=i3,focalDistance:r=1,near:s=ia,far:o=ra}=e;ah(t);const a=t/2,l=r*Math.tan(a),c=l*i;return this.ortho({left:-c,right:c,bottom:-l,top:l,near:s,far:o})}perspective(e){const{fovy:t=45*Math.PI/180,aspect:i=1,near:r=.1,far:s=500}=e;return ah(t),Z2(this,t,i,r,s),this.check()}determinant(){return H2(this)}getScale(e=[-0,-0,-0]){return e[0]=Math.sqrt(this[0]*this[0]+this[1]*this[1]+this[2]*this[2]),e[1]=Math.sqrt(this[4]*this[4]+this[5]*this[5]+this[6]*this[6]),e[2]=Math.sqrt(this[8]*this[8]+this[9]*this[9]+this[10]*this[10]),e}getTranslation(e=[-0,-0,-0]){return e[0]=this[12],e[1]=this[13],e[2]=this[14],e}getRotation(e,t){e=e||[-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0],t=t||[-0,-0,-0];const i=this.getScale(t),r=1/i[0],s=1/i[1],o=1/i[2];return e[0]=this[0]*r,e[1]=this[1]*s,e[2]=this[2]*o,e[3]=0,e[4]=this[4]*r,e[5]=this[5]*s,e[6]=this[6]*o,e[7]=0,e[8]=this[8]*r,e[9]=this[9]*s,e[10]=this[10]*o,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}getRotationMatrix3(e,t){e=e||[-0,-0,-0,-0,-0,-0,-0,-0,-0],t=t||[-0,-0,-0];const i=this.getScale(t),r=1/i[0],s=1/i[1],o=1/i[2];return e[0]=this[0]*r,e[1]=this[1]*s,e[2]=this[2]*o,e[3]=this[4]*r,e[4]=this[5]*s,e[5]=this[6]*o,e[6]=this[8]*r,e[7]=this[9]*s,e[8]=this[10]*o,e}transpose(){return W2(this,this),this.check()}invert(){return yl(this,this),this.check()}multiplyLeft(e){return fn(this,e,this),this.check()}multiplyRight(e){return fn(this,this,e),this.check()}rotateX(e){return Mm(this,this,e),this.check()}rotateY(e){return X2(this,this,e),this.check()}rotateZ(e){return km(this,this,e),this.check()}rotateXYZ(e){return this.rotateX(e[0]).rotateY(e[1]).rotateZ(e[2])}rotateAxis(e,t){return j2(this,this,e,t),this.check()}scale(e){return Yc(this,this,Array.isArray(e)?e:[e,e,e]),this.check()}translate(e){return $s(this,this,e),this.check()}transform(e,t){return e.length===4?(t=ar(t||[-0,-0,-0,-0],e,this),ta(t,4),t):this.transformAsPoint(e,t)}transformAsPoint(e,t){const{length:i}=e;let r;switch(i){case 2:r=A2(t||[-0,-0],e,this);break;case 3:r=Pm(t||[-0,-0,-0],e,this);break;default:throw new Error("Illegal vector")}return ta(r,e.length),r}transformAsVector(e,t){let i;switch(e.length){case 2:i=C2(t||[-0,-0],e,this);break;case 3:i=Rm(t||[-0,-0,-0],e,this);break;default:throw new Error("Illegal vector")}return ta(i,e.length),i}transformPoint(e,t){return this.transformAsPoint(e,t)}transformVector(e,t){return this.transformAsPoint(e,t)}transformDirection(e,t){return this.transformAsVector(e,t)}makeRotationX(e){return this.identity().rotateX(e)}makeTranslation(e,t,i){return this.identity().translate([e,t,i])}}let kr,Or;function s3(){return kr||(kr=new qe([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),Object.freeze(kr)),kr}function o3(){return Or||(Or=new qe,Object.freeze(Or)),Or}function ah(n){if(n>Math.PI*2)throw Error("expected radians")}function a3(n,e,t,i,r,s){const o=2*s/(t-e),a=2*s/(r-i),l=(t+e)/(t-e),c=(r+i)/(r-i),u=-1,d=-1,h=-2*s;return n[0]=o,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=a,n[6]=0,n[7]=0,n[8]=l,n[9]=c,n[10]=u,n[11]=d,n[12]=0,n[13]=0,n[14]=h,n[15]=0,n}function Om(n,e=[],t=0){const i=Math.fround(n),r=n-i;return e[t]=i,e[t+1]=r,e}function l3(n){return n-Math.fround(n)}function c3(n){const e=new Float32Array(32);for(let t=0;t<4;++t)for(let i=0;i<4;++i){const r=t*4+i;Om(n[i*4+t],e,r*2)}return e}const u3=`#ifdef LUMA_FP32_TAN_PRECISION_WORKAROUND

// All these functions are for substituting tan() function from Intel GPU only
const float TWO_PI = 6.2831854820251465;
const float PI_2 = 1.5707963705062866;
const float PI_16 = 0.1963495463132858;

const float SIN_TABLE_0 = 0.19509032368659973;
const float SIN_TABLE_1 = 0.3826834261417389;
const float SIN_TABLE_2 = 0.5555702447891235;
const float SIN_TABLE_3 = 0.7071067690849304;

const float COS_TABLE_0 = 0.9807852506637573;
const float COS_TABLE_1 = 0.9238795042037964;
const float COS_TABLE_2 = 0.8314695954322815;
const float COS_TABLE_3 = 0.7071067690849304;

const float INVERSE_FACTORIAL_3 = 1.666666716337204e-01; // 1/3!
const float INVERSE_FACTORIAL_5 = 8.333333767950535e-03; // 1/5!
const float INVERSE_FACTORIAL_7 = 1.9841270113829523e-04; // 1/7!
const float INVERSE_FACTORIAL_9 = 2.75573188446287533e-06; // 1/9!

float sin_taylor_fp32(float a) {
  float r, s, t, x;

  if (a == 0.0) {
    return 0.0;
  }

  x = -a * a;
  s = a;
  r = a;

  r = r * x;
  t = r * INVERSE_FACTORIAL_3;
  s = s + t;

  r = r * x;
  t = r * INVERSE_FACTORIAL_5;
  s = s + t;

  r = r * x;
  t = r * INVERSE_FACTORIAL_7;
  s = s + t;

  r = r * x;
  t = r * INVERSE_FACTORIAL_9;
  s = s + t;

  return s;
}

void sincos_taylor_fp32(float a, out float sin_t, out float cos_t) {
  if (a == 0.0) {
    sin_t = 0.0;
    cos_t = 1.0;
  }
  sin_t = sin_taylor_fp32(a);
  cos_t = sqrt(1.0 - sin_t * sin_t);
}

float tan_taylor_fp32(float a) {
    float sin_a;
    float cos_a;

    if (a == 0.0) {
        return 0.0;
    }

    // 2pi range reduction
    float z = floor(a / TWO_PI);
    float r = a - TWO_PI * z;

    float t;
    float q = floor(r / PI_2 + 0.5);
    int j = int(q);

    if (j < -2 || j > 2) {
        return 1.0 / 0.0;
    }

    t = r - PI_2 * q;

    q = floor(t / PI_16 + 0.5);
    int k = int(q);
    int abs_k = int(abs(float(k)));

    if (abs_k > 4) {
        return 1.0 / 0.0;
    } else {
        t = t - PI_16 * q;
    }

    float u = 0.0;
    float v = 0.0;

    float sin_t, cos_t;
    float s, c;
    sincos_taylor_fp32(t, sin_t, cos_t);

    if (k == 0) {
        s = sin_t;
        c = cos_t;
    } else {
        if (abs(float(abs_k) - 1.0) < 0.5) {
            u = COS_TABLE_0;
            v = SIN_TABLE_0;
        } else if (abs(float(abs_k) - 2.0) < 0.5) {
            u = COS_TABLE_1;
            v = SIN_TABLE_1;
        } else if (abs(float(abs_k) - 3.0) < 0.5) {
            u = COS_TABLE_2;
            v = SIN_TABLE_2;
        } else if (abs(float(abs_k) - 4.0) < 0.5) {
            u = COS_TABLE_3;
            v = SIN_TABLE_3;
        }
        if (k > 0) {
            s = u * sin_t + v * cos_t;
            c = u * cos_t - v * sin_t;
        } else {
            s = u * sin_t - v * cos_t;
            c = u * cos_t + v * sin_t;
        }
    }

    if (j == 0) {
        sin_a = s;
        cos_a = c;
    } else if (j == 1) {
        sin_a = c;
        cos_a = -s;
    } else if (j == -1) {
        sin_a = -c;
        cos_a = s;
    } else {
        sin_a = -s;
        cos_a = -c;
    }
    return sin_a / cos_a;
}
#endif

float tan_fp32(float a) {
#ifdef LUMA_FP32_TAN_PRECISION_WORKAROUND
  return tan_taylor_fp32(a);
#else
  return tan(a);
#endif
}
`,d3={name:"fp32",vs:u3},h3=`
uniform fp64arithmeticUniforms {
  uniform float ONE;
} fp64;

/*
About LUMA_FP64_CODE_ELIMINATION_WORKAROUND

The purpose of this workaround is to prevent shader compilers from
optimizing away necessary arithmetic operations by swapping their sequences
or transform the equation to some 'equivalent' form.

The method is to multiply an artifical variable, ONE, which will be known to
the compiler to be 1 only at runtime. The whole expression is then represented
as a polynomial with respective to ONE. In the coefficients of all terms, only one a
and one b should appear

err = (a + b) * ONE^6 - a * ONE^5 - (a + b) * ONE^4 + a * ONE^3 - b - (a + b) * ONE^2 + a * ONE
*/

// Divide float number to high and low floats to extend fraction bits
vec2 split(float a) {
  const float SPLIT = 4097.0;
  float t = a * SPLIT;
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  float a_hi = t * fp64.ONE - (t - a);
  float a_lo = a * fp64.ONE - a_hi;
#else
  float a_hi = t - (t - a);
  float a_lo = a - a_hi;
#endif
  return vec2(a_hi, a_lo);
}

// Divide float number again when high float uses too many fraction bits
vec2 split2(vec2 a) {
  vec2 b = split(a.x);
  b.y += a.y;
  return b;
}

// Special sum operation when a > b
vec2 quickTwoSum(float a, float b) {
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  float sum = (a + b) * fp64.ONE;
  float err = b - (sum - a) * fp64.ONE;
#else
  float sum = a + b;
  float err = b - (sum - a);
#endif
  return vec2(sum, err);
}

// General sum operation
vec2 twoSum(float a, float b) {
  float s = (a + b);
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  float v = (s * fp64.ONE - a) * fp64.ONE;
  float err = (a - (s - v) * fp64.ONE) * fp64.ONE * fp64.ONE * fp64.ONE + (b - v);
#else
  float v = s - a;
  float err = (a - (s - v)) + (b - v);
#endif
  return vec2(s, err);
}

vec2 twoSub(float a, float b) {
  float s = (a - b);
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  float v = (s * fp64.ONE - a) * fp64.ONE;
  float err = (a - (s - v) * fp64.ONE) * fp64.ONE * fp64.ONE * fp64.ONE - (b + v);
#else
  float v = s - a;
  float err = (a - (s - v)) - (b + v);
#endif
  return vec2(s, err);
}

vec2 twoSqr(float a) {
  float prod = a * a;
  vec2 a_fp64 = split(a);
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  float err = ((a_fp64.x * a_fp64.x - prod) * fp64.ONE + 2.0 * a_fp64.x *
    a_fp64.y * fp64.ONE * fp64.ONE) + a_fp64.y * a_fp64.y * fp64.ONE * fp64.ONE * fp64.ONE;
#else
  float err = ((a_fp64.x * a_fp64.x - prod) + 2.0 * a_fp64.x * a_fp64.y) + a_fp64.y * a_fp64.y;
#endif
  return vec2(prod, err);
}

vec2 twoProd(float a, float b) {
  float prod = a * b;
  vec2 a_fp64 = split(a);
  vec2 b_fp64 = split(b);
  float err = ((a_fp64.x * b_fp64.x - prod) + a_fp64.x * b_fp64.y +
    a_fp64.y * b_fp64.x) + a_fp64.y * b_fp64.y;
  return vec2(prod, err);
}

vec2 sum_fp64(vec2 a, vec2 b) {
  vec2 s, t;
  s = twoSum(a.x, b.x);
  t = twoSum(a.y, b.y);
  s.y += t.x;
  s = quickTwoSum(s.x, s.y);
  s.y += t.y;
  s = quickTwoSum(s.x, s.y);
  return s;
}

vec2 sub_fp64(vec2 a, vec2 b) {
  vec2 s, t;
  s = twoSub(a.x, b.x);
  t = twoSub(a.y, b.y);
  s.y += t.x;
  s = quickTwoSum(s.x, s.y);
  s.y += t.y;
  s = quickTwoSum(s.x, s.y);
  return s;
}

vec2 mul_fp64(vec2 a, vec2 b) {
  vec2 prod = twoProd(a.x, b.x);
  // y component is for the error
  prod.y += a.x * b.y;
#if defined(LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND)
  prod = split2(prod);
#endif
  prod = quickTwoSum(prod.x, prod.y);
  prod.y += a.y * b.x;
#if defined(LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND)
  prod = split2(prod);
#endif
  prod = quickTwoSum(prod.x, prod.y);
  return prod;
}

vec2 div_fp64(vec2 a, vec2 b) {
  float xn = 1.0 / b.x;
#if defined(LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND)
  vec2 yn = mul_fp64(a, vec2(xn, 0));
#else
  vec2 yn = a * xn;
#endif
  float diff = (sub_fp64(a, mul_fp64(b, yn))).x;
  vec2 prod = twoProd(xn, diff);
  return sum_fp64(yn, prod);
}

vec2 sqrt_fp64(vec2 a) {
  if (a.x == 0.0 && a.y == 0.0) return vec2(0.0, 0.0);
  if (a.x < 0.0) return vec2(0.0 / 0.0, 0.0 / 0.0);

  float x = 1.0 / sqrt(a.x);
  float yn = a.x * x;
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  vec2 yn_sqr = twoSqr(yn) * fp64.ONE;
#else
  vec2 yn_sqr = twoSqr(yn);
#endif
  float diff = sub_fp64(a, yn_sqr).x;
  vec2 prod = twoProd(x * 0.5, diff);
#if defined(LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND)
  return sum_fp64(split(yn), prod);
#else
  return sum_fp64(vec2(yn, 0.0), prod);
#endif
}
`,f3={ONE:1},p3={name:"fp64arithmetic",vs:h3,defaultUniforms:f3,uniformTypes:{ONE:"f32"},fp64ify:Om,fp64LowPart:l3,fp64ifyMatrix4:c3},g3=[0,1,1,1],m3=`uniform pickingUniforms {
  float isActive;
  float isAttribute;
  float isHighlightActive;
  float useFloatColors;
  vec3 highlightedObjectColor;
  vec4 highlightColor;
} picking;

out vec4 picking_vRGBcolor_Avalid;

// Normalize unsigned byte color to 0-1 range
vec3 picking_normalizeColor(vec3 color) {
  return picking.useFloatColors > 0.5 ? color : color / 255.0;
}

// Normalize unsigned byte color to 0-1 range
vec4 picking_normalizeColor(vec4 color) {
  return picking.useFloatColors > 0.5 ? color : color / 255.0;
}

bool picking_isColorZero(vec3 color) {
  return dot(color, vec3(1.0)) < 0.00001;
}

bool picking_isColorValid(vec3 color) {
  return dot(color, vec3(1.0)) > 0.00001;
}

// Check if this vertex is highlighted 
bool isVertexHighlighted(vec3 vertexColor) {
  vec3 highlightedObjectColor = picking_normalizeColor(picking.highlightedObjectColor);
  return
    bool(picking.isHighlightActive) && picking_isColorZero(abs(vertexColor - highlightedObjectColor));
}

// Set the current picking color
void picking_setPickingColor(vec3 pickingColor) {
  pickingColor = picking_normalizeColor(pickingColor);

  if (bool(picking.isActive)) {
    // Use alpha as the validity flag. If pickingColor is [0, 0, 0] fragment is non-pickable
    picking_vRGBcolor_Avalid.a = float(picking_isColorValid(pickingColor));

    if (!bool(picking.isAttribute)) {
      // Stores the picking color so that the fragment shader can render it during picking
      picking_vRGBcolor_Avalid.rgb = pickingColor;
    }
  } else {
    // Do the comparison with selected item color in vertex shader as it should mean fewer compares
    picking_vRGBcolor_Avalid.a = float(isVertexHighlighted(pickingColor));
  }
}

void picking_setPickingAttribute(float value) {
  if (bool(picking.isAttribute)) {
    picking_vRGBcolor_Avalid.r = value;
  }
}

void picking_setPickingAttribute(vec2 value) {
  if (bool(picking.isAttribute)) {
    picking_vRGBcolor_Avalid.rg = value;
  }
}

void picking_setPickingAttribute(vec3 value) {
  if (bool(picking.isAttribute)) {
    picking_vRGBcolor_Avalid.rgb = value;
  }
}
`,_3=`uniform pickingUniforms {
  float isActive;
  float isAttribute;
  float isHighlightActive;
  float useFloatColors;
  vec3 highlightedObjectColor;
  vec4 highlightColor;
} picking;

in vec4 picking_vRGBcolor_Avalid;

/*
 * Returns highlight color if this item is selected.
 */
vec4 picking_filterHighlightColor(vec4 color) {
  // If we are still picking, we don't highlight
  if (picking.isActive > 0.5) {
    return color;
  }

  bool selected = bool(picking_vRGBcolor_Avalid.a);

  if (selected) {
    // Blend in highlight color based on its alpha value
    float highLightAlpha = picking.highlightColor.a;
    float blendedAlpha = highLightAlpha + color.a * (1.0 - highLightAlpha);
    float highLightRatio = highLightAlpha / blendedAlpha;

    vec3 blendedRGB = mix(color.rgb, picking.highlightColor.rgb, highLightRatio);
    return vec4(blendedRGB, blendedAlpha);
  } else {
    return color;
  }
}

/*
 * Returns picking color if picking enabled else unmodified argument.
 */
vec4 picking_filterPickingColor(vec4 color) {
  if (bool(picking.isActive)) {
    if (picking_vRGBcolor_Avalid.a == 0.0) {
      discard;
    }
    return picking_vRGBcolor_Avalid;
  }
  return color;
}

/*
 * Returns picking color if picking is enabled if not
 * highlight color if this item is selected, otherwise unmodified argument.
 */
vec4 picking_filterColor(vec4 color) {
  vec4 highlightColor = picking_filterHighlightColor(color);
  return picking_filterPickingColor(highlightColor);
}
`,lh={props:{},uniforms:{},name:"picking",uniformTypes:{isActive:"f32",isAttribute:"f32",isHighlightActive:"f32",useFloatColors:"f32",highlightedObjectColor:"vec3<f32>",highlightColor:"vec4<f32>"},defaultUniforms:{isActive:!1,isAttribute:!1,isHighlightActive:!1,useFloatColors:!0,highlightedObjectColor:[0,0,0],highlightColor:g3},vs:m3,fs:_3,getUniforms:y3};function y3(n={},e){const t={};if(n.highlightedObjectColor!==void 0)if(n.highlightedObjectColor===null)t.isHighlightActive=!1;else{t.isHighlightActive=!0;const i=n.highlightedObjectColor.slice(0,3);t.highlightedObjectColor=i}if(n.highlightColor){const i=Array.from(n.highlightColor,r=>r/255);Number.isFinite(i[3])||(i[3]=1),t.highlightColor=i}return n.isActive!==void 0&&(t.isActive=!!n.isActive,t.isAttribute=!!n.isAttribute),n.useFloatColors!==void 0&&(t.useFloatColors=!!n.useFloatColors),t}const ch=`uniform layerUniforms {
  uniform float opacity;
} layer;
`,b3={name:"layer",vs:ch,fs:ch,getUniforms:n=>({opacity:Math.pow(n.opacity,1/2.2)}),uniformTypes:{opacity:"f32"}},v3=`const SMOOTH_EDGE_RADIUS: f32 = 0.5;

struct VertexGeometry {
  position: vec4<f32>,
  worldPosition: vec3<f32>,
  worldPositionAlt: vec3<f32>,
  normal: vec3<f32>,
  uv: vec2<f32>,
  pickingColor: vec3<f32>,
};

var<private> geometry_: VertexGeometry = VertexGeometry(
  vec4<f32>(0.0, 0.0, 1.0, 0.0),
  vec3<f32>(0.0, 0.0, 0.0),
  vec3<f32>(0.0, 0.0, 0.0),
  vec3<f32>(0.0, 0.0, 0.0),
  vec2<f32>(0.0, 0.0),
  vec3<f32>(0.0, 0.0, 0.0)
);

struct FragmentGeometry {
  uv: vec2<f32>,
};

var<private> fragmentGeometry: FragmentGeometry;

fn smoothedge(edge: f32, x: f32) -> f32 {
  return smoothstep(edge - SMOOTH_EDGE_RADIUS, edge + SMOOTH_EDGE_RADIUS, x);
}
`,Nm="#define SMOOTH_EDGE_RADIUS 0.5",x3=`${Nm}

struct VertexGeometry {
  vec4 position;
  vec3 worldPosition;
  vec3 worldPositionAlt;
  vec3 normal;
  vec2 uv;
  vec3 pickingColor;
} geometry = VertexGeometry(
  vec4(0.0, 0.0, 1.0, 0.0),
  vec3(0.0),
  vec3(0.0),
  vec3(0.0),
  vec2(0.0),
  vec3(0.0)
);
`,w3=`${Nm}

struct FragmentGeometry {
  vec2 uv;
} geometry;

float smoothedge(float edge, float x) {
  return smoothstep(edge - SMOOTH_EDGE_RADIUS, edge + SMOOTH_EDGE_RADIUS, x);
}
`,Fm={name:"geometry",source:v3,vs:x3,fs:w3},T3=25;var ve;(function(n){n[n.Start=1]="Start",n[n.Move=2]="Move",n[n.End=4]="End",n[n.Cancel=8]="Cancel"})(ve||(ve={}));var Te;(function(n){n[n.None=0]="None",n[n.Left=1]="Left",n[n.Right=2]="Right",n[n.Up=4]="Up",n[n.Down=8]="Down",n[n.Horizontal=3]="Horizontal",n[n.Vertical=12]="Vertical",n[n.All=15]="All"})(Te||(Te={}));var Y;(function(n){n[n.Possible=1]="Possible",n[n.Began=2]="Began",n[n.Changed=4]="Changed",n[n.Ended=8]="Ended",n[n.Recognized=8]="Recognized",n[n.Cancelled=16]="Cancelled",n[n.Failed=32]="Failed"})(Y||(Y={}));const S3="compute",E3="auto",vl="manipulation",Gr="none",xl="pan-x",wl="pan-y";function A3(n){if(n.includes(Gr))return Gr;const e=n.includes(xl),t=n.includes(wl);return e&&t?Gr:e||t?e?xl:wl:n.includes(vl)?vl:E3}class C3{constructor(e,t){this.actions="",this.manager=e,this.set(t)}set(e){e===S3&&(e=this.compute()),this.manager.element&&(this.manager.element.style.touchAction=e,this.actions=e)}update(){this.set(this.manager.options.touchAction)}compute(){let e=[];for(const t of this.manager.recognizers)t.options.enable&&(e=e.concat(t.getTouchAction()));return A3(e.join(" "))}}function zs(n){return n.trim().split(/\s+/g)}function sa(n,e,t){if(n)for(const i of zs(e))n.addEventListener(i,t,!1)}function oa(n,e,t){if(n)for(const i of zs(e))n.removeEventListener(i,t,!1)}function uh(n){return(n.ownerDocument||n).defaultView}function I3(n,e){let t=n;for(;t;){if(t===e)return!0;t=t.parentNode}return!1}function Dm(n){const e=n.length;if(e===1)return{x:Math.round(n[0].clientX),y:Math.round(n[0].clientY)};let t=0,i=0,r=0;for(;r<e;)t+=n[r].clientX,i+=n[r].clientY,r++;return{x:Math.round(t/e),y:Math.round(i/e)}}function dh(n){const e=[];let t=0;for(;t<n.pointers.length;)e[t]={clientX:Math.round(n.pointers[t].clientX),clientY:Math.round(n.pointers[t].clientY)},t++;return{timeStamp:Date.now(),pointers:e,center:Dm(e),deltaX:n.deltaX,deltaY:n.deltaY}}function Bm(n,e){const t=e.x-n.x,i=e.y-n.y;return Math.sqrt(t*t+i*i)}function hh(n,e){const t=e.clientX-n.clientX,i=e.clientY-n.clientY;return Math.sqrt(t*t+i*i)}function R3(n,e){const t=e.x-n.x,i=e.y-n.y;return Math.atan2(i,t)*180/Math.PI}function fh(n,e){const t=e.clientX-n.clientX,i=e.clientY-n.clientY;return Math.atan2(i,t)*180/Math.PI}function Lm(n,e){return n===e?Te.None:Math.abs(n)>=Math.abs(e)?n<0?Te.Left:Te.Right:e<0?Te.Up:Te.Down}function P3(n,e){const t=e.center;let i=n.offsetDelta,r=n.prevDelta;const s=n.prevInput;return(e.eventType===ve.Start||(s==null?void 0:s.eventType)===ve.End)&&(r=n.prevDelta={x:(s==null?void 0:s.deltaX)||0,y:(s==null?void 0:s.deltaY)||0},i=n.offsetDelta={x:t.x,y:t.y}),{deltaX:r.x+(t.x-i.x),deltaY:r.y+(t.y-i.y)}}function Um(n,e,t){return{x:e/n||0,y:t/n||0}}function M3(n,e){return hh(e[0],e[1])/hh(n[0],n[1])}function k3(n,e){return fh(e[1],e[0])-fh(n[1],n[0])}function O3(n,e){const t=n.lastInterval||e,i=e.timeStamp-t.timeStamp;let r,s,o,a;if(e.eventType!==ve.Cancel&&(i>T3||t.velocity===void 0)){const l=e.deltaX-t.deltaX,c=e.deltaY-t.deltaY,u=Um(i,l,c);s=u.x,o=u.y,r=Math.abs(u.x)>Math.abs(u.y)?u.x:u.y,a=Lm(l,c),n.lastInterval=e}else r=t.velocity,s=t.velocityX,o=t.velocityY,a=t.direction;e.velocity=r,e.velocityX=s,e.velocityY=o,e.direction=a}function N3(n,e){const{session:t}=n,{pointers:i}=e,{length:r}=i;t.firstInput||(t.firstInput=dh(e)),r>1&&!t.firstMultiple?t.firstMultiple=dh(e):r===1&&(t.firstMultiple=!1);const{firstInput:s,firstMultiple:o}=t,a=o?o.center:s.center,l=e.center=Dm(i);e.timeStamp=Date.now(),e.deltaTime=e.timeStamp-s.timeStamp,e.angle=R3(a,l),e.distance=Bm(a,l);const{deltaX:c,deltaY:u}=P3(t,e);e.deltaX=c,e.deltaY=u,e.offsetDirection=Lm(e.deltaX,e.deltaY);const d=Um(e.deltaTime,e.deltaX,e.deltaY);e.overallVelocityX=d.x,e.overallVelocityY=d.y,e.overallVelocity=Math.abs(d.x)>Math.abs(d.y)?d.x:d.y,e.scale=o?M3(o.pointers,i):1,e.rotation=o?k3(o.pointers,i):0,e.maxPointers=t.prevInput?e.pointers.length>t.prevInput.maxPointers?e.pointers.length:t.prevInput.maxPointers:e.pointers.length;let h=n.element;return I3(e.srcEvent.target,h)&&(h=e.srcEvent.target),e.target=h,O3(t,e),e}function F3(n,e,t){const i=t.pointers.length,r=t.changedPointers.length,s=e&ve.Start&&i-r===0,o=e&(ve.End|ve.Cancel)&&i-r===0;t.isFirst=!!s,t.isFinal=!!o,s&&(n.session={}),t.eventType=e;const a=N3(n,t);n.emit("hammer.input",a),n.recognize(a),n.session.prevInput=a}let D3=class{constructor(e){this.evEl="",this.evWin="",this.evTarget="",this.domHandler=t=>{this.manager.options.enable&&this.handler(t)},this.manager=e,this.element=e.element,this.target=e.options.inputTarget||e.element}callback(e,t){F3(this.manager,e,t)}init(){sa(this.element,this.evEl,this.domHandler),sa(this.target,this.evTarget,this.domHandler),sa(uh(this.element),this.evWin,this.domHandler)}destroy(){oa(this.element,this.evEl,this.domHandler),oa(this.target,this.evTarget,this.domHandler),oa(uh(this.element),this.evWin,this.domHandler)}};const B3={pointerdown:ve.Start,pointermove:ve.Move,pointerup:ve.End,pointercancel:ve.Cancel,pointerout:ve.Cancel},L3="pointerdown",U3="pointermove pointerup pointercancel";class $3 extends D3{constructor(e){super(e),this.evEl=L3,this.evWin=U3,this.store=this.manager.session.pointerEvents=[],this.init()}handler(e){const{store:t}=this;let i=!1;const r=B3[e.type],s=e.pointerType,o=s==="touch";let a=t.findIndex(l=>l.pointerId===e.pointerId);r&ve.Start&&(e.buttons||o)?a<0&&(t.push(e),a=t.length-1):r&(ve.End|ve.Cancel)&&(i=!0),!(a<0)&&(t[a]=e,this.callback(r,{pointers:t,changedPointers:[e],eventType:r,pointerType:s,srcEvent:e}),i&&t.splice(a,1))}}const z3=["","webkit","Moz","MS","ms","o"];function V3(n,e){const t=e[0].toUpperCase()+e.slice(1);for(const i of z3){const r=i?i+t:e;if(r in n)return r}}const W3=1,ph=2,gh={touchAction:"compute",enable:!0,inputTarget:null,cssProps:{userSelect:"none",userDrag:"none",touchCallout:"none",tapHighlightColor:"rgba(0,0,0,0)"}};class H3{constructor(e,t){this.options={...gh,...t,cssProps:{...gh.cssProps,...t.cssProps},inputTarget:t.inputTarget||e},this.handlers={},this.session={},this.recognizers=[],this.oldCssProps={},this.element=e,this.input=new $3(this),this.touchAction=new C3(this,this.options.touchAction),this.toggleCssProps(!0)}set(e){return Object.assign(this.options,e),e.touchAction&&this.touchAction.update(),e.inputTarget&&(this.input.destroy(),this.input.target=e.inputTarget,this.input.init()),this}stop(e){this.session.stopped=e?ph:W3}recognize(e){const{session:t}=this;if(t.stopped)return;this.session.prevented&&e.srcEvent.preventDefault();let i;const{recognizers:r}=this;let{curRecognizer:s}=t;(!s||s&&s.state&Y.Recognized)&&(s=t.curRecognizer=null);let o=0;for(;o<r.length;)i=r[o],t.stopped!==ph&&(!s||i===s||i.canRecognizeWith(s))?i.recognize(e):i.reset(),!s&&i.state&(Y.Began|Y.Changed|Y.Ended)&&(s=t.curRecognizer=i),o++}get(e){const{recognizers:t}=this;for(let i=0;i<t.length;i++)if(t[i].options.event===e)return t[i];return null}add(e){if(Array.isArray(e)){for(const i of e)this.add(i);return this}const t=this.get(e.options.event);return t&&this.remove(t),this.recognizers.push(e),e.manager=this,this.touchAction.update(),e}remove(e){if(Array.isArray(e)){for(const i of e)this.remove(i);return this}const t=typeof e=="string"?this.get(e):e;if(t){const{recognizers:i}=this,r=i.indexOf(t);r!==-1&&(i.splice(r,1),this.touchAction.update())}return this}on(e,t){if(!e||!t)return;const{handlers:i}=this;for(const r of zs(e))i[r]=i[r]||[],i[r].push(t)}off(e,t){if(!e)return;const{handlers:i}=this;for(const r of zs(e))t?i[r]&&i[r].splice(i[r].indexOf(t),1):delete i[r]}emit(e,t){const i=this.handlers[e]&&this.handlers[e].slice();if(!i||!i.length)return;const r=t;r.type=e,r.preventDefault=function(){t.srcEvent.preventDefault()};let s=0;for(;s<i.length;)i[s](r),s++}destroy(){this.toggleCssProps(!1),this.handlers={},this.session={},this.input.destroy(),this.element=null}toggleCssProps(e){const{element:t}=this;if(t){for(const[i,r]of Object.entries(this.options.cssProps)){const s=V3(t.style,i);e?(this.oldCssProps[s]=t.style[s],t.style[s]=r):t.style[s]=this.oldCssProps[s]||""}e||(this.oldCssProps={})}}}let j3=1;function X3(){return j3++}function mh(n){return n&Y.Cancelled?"cancel":n&Y.Ended?"end":n&Y.Changed?"move":n&Y.Began?"start":""}class $m{constructor(e){this.options=e,this.id=X3(),this.state=Y.Possible,this.simultaneous={},this.requireFail=[]}set(e){return Object.assign(this.options,e),this.manager.touchAction.update(),this}recognizeWith(e){if(Array.isArray(e)){for(const r of e)this.recognizeWith(r);return this}let t;if(typeof e=="string"){if(t=this.manager.get(e),!t)throw new Error(`Cannot find recognizer ${e}`)}else t=e;const{simultaneous:i}=this;return i[t.id]||(i[t.id]=t,t.recognizeWith(this)),this}dropRecognizeWith(e){if(Array.isArray(e)){for(const i of e)this.dropRecognizeWith(i);return this}let t;return typeof e=="string"?t=this.manager.get(e):t=e,t&&delete this.simultaneous[t.id],this}requireFailure(e){if(Array.isArray(e)){for(const r of e)this.requireFailure(r);return this}let t;if(typeof e=="string"){if(t=this.manager.get(e),!t)throw new Error(`Cannot find recognizer ${e}`)}else t=e;const{requireFail:i}=this;return i.indexOf(t)===-1&&(i.push(t),t.requireFailure(this)),this}dropRequireFailure(e){if(Array.isArray(e)){for(const i of e)this.dropRequireFailure(i);return this}let t;if(typeof e=="string"?t=this.manager.get(e):t=e,t){const i=this.requireFail.indexOf(t);i>-1&&this.requireFail.splice(i,1)}return this}hasRequireFailures(){return!!this.requireFail.find(e=>e.options.enable)}canRecognizeWith(e){return!!this.simultaneous[e.id]}emit(e){if(!e)return;const{state:t}=this;t<Y.Ended&&this.manager.emit(this.options.event+mh(t),e),this.manager.emit(this.options.event,e),e.additionalEvent&&this.manager.emit(e.additionalEvent,e),t>=Y.Ended&&this.manager.emit(this.options.event+mh(t),e)}tryEmit(e){this.canEmit()?this.emit(e):this.state=Y.Failed}canEmit(){let e=0;for(;e<this.requireFail.length;){if(!(this.requireFail[e].state&(Y.Failed|Y.Possible)))return!1;e++}return!0}recognize(e){const t={...e};if(!this.options.enable){this.reset(),this.state=Y.Failed;return}this.state&(Y.Recognized|Y.Cancelled|Y.Failed)&&(this.state=Y.Possible),this.state=this.process(t),this.state&(Y.Began|Y.Changed|Y.Ended|Y.Cancelled)&&this.tryEmit(t)}getEventNames(){return[this.options.event]}reset(){}}class zm extends $m{attrTest(e){const t=this.options.pointers;return t===0||e.pointers.length===t}process(e){const{state:t}=this,{eventType:i}=e,r=t&(Y.Began|Y.Changed),s=this.attrTest(e);return r&&(i&ve.Cancel||!s)?t|Y.Cancelled:r||s?i&ve.End?t|Y.Ended:t&Y.Began?t|Y.Changed:Y.Began:Y.Failed}}class _h extends $m{constructor(e={}){super({enable:!0,event:"tap",pointers:1,taps:1,interval:300,time:250,threshold:9,posThreshold:10,...e}),this.pTime=null,this.pCenter=null,this._timer=null,this._input=null,this.count=0}getTouchAction(){return[vl]}process(e){const{options:t}=this,i=e.pointers.length===t.pointers,r=e.distance<t.threshold,s=e.deltaTime<t.time;if(this.reset(),e.eventType&ve.Start&&this.count===0)return this.failTimeout();if(r&&s&&i){if(e.eventType!==ve.End)return this.failTimeout();const o=this.pTime?e.timeStamp-this.pTime<t.interval:!0,a=!this.pCenter||Bm(this.pCenter,e.center)<t.posThreshold;if(this.pTime=e.timeStamp,this.pCenter=e.center,!a||!o?this.count=1:this.count+=1,this._input=e,this.count%t.taps===0)return this.hasRequireFailures()?(this._timer=setTimeout(()=>{this.state=Y.Recognized,this.tryEmit(this._input)},t.interval),Y.Began):Y.Recognized}return Y.Failed}failTimeout(){return this._timer=setTimeout(()=>{this.state=Y.Failed},this.options.interval),Y.Failed}reset(){clearTimeout(this._timer)}emit(e){this.state===Y.Recognized&&(e.tapCount=this.count,this.manager.emit(this.options.event,e))}}const Y3=["","start","move","end","cancel","up","down","left","right"];class yh extends zm{constructor(e={}){super({enable:!0,pointers:1,event:"pan",threshold:10,direction:Te.All,...e}),this.pX=null,this.pY=null}getTouchAction(){const{options:{direction:e}}=this,t=[];return e&Te.Horizontal&&t.push(wl),e&Te.Vertical&&t.push(xl),t}getEventNames(){return Y3.map(e=>this.options.event+e)}directionTest(e){const{options:t}=this;let i=!0,{distance:r}=e,{direction:s}=e;const o=e.deltaX,a=e.deltaY;return s&t.direction||(t.direction&Te.Horizontal?(s=o===0?Te.None:o<0?Te.Left:Te.Right,i=o!==this.pX,r=Math.abs(e.deltaX)):(s=a===0?Te.None:a<0?Te.Up:Te.Down,i=a!==this.pY,r=Math.abs(e.deltaY))),e.direction=s,i&&r>t.threshold&&!!(s&t.direction)}attrTest(e){return super.attrTest(e)&&(!!(this.state&Y.Began)||!(this.state&Y.Began)&&this.directionTest(e))}emit(e){this.pX=e.deltaX,this.pY=e.deltaY;const t=Te[e.direction].toLowerCase();t&&(e.additionalEvent=this.options.event+t),super.emit(e)}}const q3=["","start","move","end","cancel","in","out"];class K3 extends zm{constructor(e={}){super({enable:!0,event:"pinch",threshold:0,pointers:2,...e})}getTouchAction(){return[Gr]}getEventNames(){return q3.map(e=>this.options.event+e)}attrTest(e){return super.attrTest(e)&&(Math.abs(e.scale-1)>this.options.threshold||!!(this.state&Y.Began))}emit(e){if(e.scale!==1){const t=e.scale<1?"in":"out";e.additionalEvent=this.options.event+t}super.emit(e)}}class xo{constructor(e,t,i){this.element=e,this.callback=t,this.options=i}}const Z3=typeof navigator<"u"&&navigator.userAgent?navigator.userAgent.toLowerCase():"",G3=Z3.indexOf("firefox")!==-1,bh=4.000244140625,Q3=40,J3=.25;class eI extends xo{constructor(e,t,i){super(e,t,{enable:!0,...i}),this.handleEvent=r=>{if(!this.options.enable)return;let s=r.deltaY;globalThis.WheelEvent&&(G3&&r.deltaMode===globalThis.WheelEvent.DOM_DELTA_PIXEL&&(s/=globalThis.devicePixelRatio),r.deltaMode===globalThis.WheelEvent.DOM_DELTA_LINE&&(s*=Q3)),s!==0&&s%bh===0&&(s=Math.floor(s/bh)),r.shiftKey&&s&&(s=s*J3),this.callback({type:"wheel",center:{x:r.clientX,y:r.clientY},delta:-s,srcEvent:r,pointerType:"mouse",target:r.target})},e.addEventListener("wheel",this.handleEvent,{passive:!1})}destroy(){this.element.removeEventListener("wheel",this.handleEvent)}enableEventType(e,t){e==="wheel"&&(this.options.enable=t)}}const vh=["mousedown","mousemove","mouseup","mouseover","mouseout","mouseleave"];class tI extends xo{constructor(e,t,i){super(e,t,{enable:!0,...i}),this.handleEvent=s=>{this.handleOverEvent(s),this.handleOutEvent(s),this.handleEnterEvent(s),this.handleLeaveEvent(s),this.handleMoveEvent(s)},this.pressed=!1;const{enable:r}=this.options;this.enableMoveEvent=r,this.enableLeaveEvent=r,this.enableEnterEvent=r,this.enableOutEvent=r,this.enableOverEvent=r,vh.forEach(s=>e.addEventListener(s,this.handleEvent))}destroy(){vh.forEach(e=>this.element.removeEventListener(e,this.handleEvent))}enableEventType(e,t){switch(e){case"pointermove":this.enableMoveEvent=t;break;case"pointerover":this.enableOverEvent=t;break;case"pointerout":this.enableOutEvent=t;break;case"pointerenter":this.enableEnterEvent=t;break;case"pointerleave":this.enableLeaveEvent=t;break}}handleOverEvent(e){this.enableOverEvent&&e.type==="mouseover"&&this._emit("pointerover",e)}handleOutEvent(e){this.enableOutEvent&&e.type==="mouseout"&&this._emit("pointerout",e)}handleEnterEvent(e){this.enableEnterEvent&&e.type==="mouseenter"&&this._emit("pointerenter",e)}handleLeaveEvent(e){this.enableLeaveEvent&&e.type==="mouseleave"&&this._emit("pointerleave",e)}handleMoveEvent(e){if(this.enableMoveEvent)switch(e.type){case"mousedown":e.button>=0&&(this.pressed=!0);break;case"mousemove":e.buttons===0&&(this.pressed=!1),this.pressed||this._emit("pointermove",e);break;case"mouseup":this.pressed=!1;break}}_emit(e,t){this.callback({type:e,center:{x:t.clientX,y:t.clientY},srcEvent:t,pointerType:"mouse",target:t.target})}}const xh=["keydown","keyup"];class nI extends xo{constructor(e,t,i){super(e,t,{enable:!0,tabIndex:0,...i}),this.handleEvent=r=>{const s=r.target||r.srcElement;s.tagName==="INPUT"&&s.type==="text"||s.tagName==="TEXTAREA"||(this.enableDownEvent&&r.type==="keydown"&&this.callback({type:"keydown",srcEvent:r,key:r.key,target:r.target}),this.enableUpEvent&&r.type==="keyup"&&this.callback({type:"keyup",srcEvent:r,key:r.key,target:r.target}))},this.enableDownEvent=this.options.enable,this.enableUpEvent=this.options.enable,e.tabIndex=this.options.tabIndex,e.style.outline="none",xh.forEach(r=>e.addEventListener(r,this.handleEvent))}destroy(){xh.forEach(e=>this.element.removeEventListener(e,this.handleEvent))}enableEventType(e,t){e==="keydown"&&(this.enableDownEvent=t),e==="keyup"&&(this.enableUpEvent=t)}}class iI extends xo{constructor(e,t,i){super(e,t,i),this.handleEvent=r=>{this.options.enable&&this.callback({type:"contextmenu",center:{x:r.clientX,y:r.clientY},srcEvent:r,pointerType:"mouse",target:r.target})},e.addEventListener("contextmenu",this.handleEvent)}destroy(){this.element.removeEventListener("contextmenu",this.handleEvent)}enableEventType(e,t){e==="contextmenu"&&(this.options.enable=t)}}const wh=1,Tl=2,Th=4,rI={pointerdown:wh,pointermove:Tl,pointerup:Th,mousedown:wh,mousemove:Tl,mouseup:Th},sI=0,oI=1,aI=2,lI=1,cI=2,uI=4;function dI(n){const e=rI[n.srcEvent.type];if(!e)return null;const{buttons:t,button:i}=n.srcEvent;let r=!1,s=!1,o=!1;return e===Tl?(r=!!(t&lI),s=!!(t&uI),o=!!(t&cI)):(r=i===sI,s=i===oI,o=i===aI),{leftButton:r,middleButton:s,rightButton:o}}function hI(n,e){const t=n.center;if(!t)return null;const i=e.getBoundingClientRect(),r=i.width/e.offsetWidth||1,s=i.height/e.offsetHeight||1,o={x:(t.x-i.left-e.clientLeft)/r,y:(t.y-i.top-e.clientTop)/s};return{center:t,offsetCenter:o}}const fI={srcElement:"root",priority:0};class pI{constructor(e,t){this.handleEvent=i=>{if(this.isEmpty())return;const r=this._normalizeEvent(i);let s=i.srcEvent.target;for(;s&&s!==r.rootElement;){if(this._emit(r,s),r.handled)return;s=s.parentNode}this._emit(r,"root")},this.eventManager=e,this.recognizerName=t,this.handlers=[],this.handlersByElement=new Map,this._active=!1}isEmpty(){return!this._active}add(e,t,i,r=!1,s=!1){const{handlers:o,handlersByElement:a}=this,l={...fI,...i};let c=a.get(l.srcElement);c||(c=[],a.set(l.srcElement,c));const u={type:e,handler:t,srcElement:l.srcElement,priority:l.priority};r&&(u.once=!0),s&&(u.passive=!0),o.push(u),this._active=this._active||!u.passive;let d=c.length-1;for(;d>=0&&!(c[d].priority>=u.priority);)d--;c.splice(d+1,0,u)}remove(e,t){const{handlers:i,handlersByElement:r}=this;for(let s=i.length-1;s>=0;s--){const o=i[s];if(o.type===e&&o.handler===t){i.splice(s,1);const a=r.get(o.srcElement);a.splice(a.indexOf(o),1),a.length===0&&r.delete(o.srcElement)}}this._active=i.some(s=>!s.passive)}_emit(e,t){const i=this.handlersByElement.get(t);if(i){let r=!1;const s=()=>{e.handled=!0},o=()=>{e.handled=!0,r=!0},a=[];for(let l=0;l<i.length;l++){const{type:c,handler:u,once:d}=i[l];if(u({...e,type:c,stopPropagation:s,stopImmediatePropagation:o}),d&&a.push(i[l]),r)break}for(let l=0;l<a.length;l++){const{type:c,handler:u}=a[l];this.remove(c,u)}}}_normalizeEvent(e){const t=this.eventManager.getElement();return{...e,...dI(e),...hI(e,t),preventDefault:()=>{e.srcEvent.preventDefault()},stopImmediatePropagation:null,stopPropagation:null,handled:!1,rootElement:t}}}function gI(n){if("recognizer"in n)return n;let e;const t=Array.isArray(n)?[...n]:[n];if(typeof t[0]=="function"){const i=t.shift(),r=t.shift()||{};e=new i(r)}else e=t.shift();return{recognizer:e,recognizeWith:typeof t[0]=="string"?[t[0]]:t[0],requireFailure:typeof t[1]=="string"?[t[1]]:t[1]}}class mI{constructor(e=null,t={}){if(this._onBasicInput=i=>{this.manager.emit(i.srcEvent.type,i)},this._onOtherEvent=i=>{this.manager.emit(i.type,i)},this.options={recognizers:[],events:{},touchAction:"compute",tabIndex:0,cssProps:{},...t},this.events=new Map,this.element=e,!!e){this.manager=new H3(e,this.options);for(const i of this.options.recognizers){const{recognizer:r,recognizeWith:s,requireFailure:o}=gI(i);this.manager.add(r),s&&r.recognizeWith(s),o&&r.requireFailure(o)}this.manager.on("hammer.input",this._onBasicInput),this.wheelInput=new eI(e,this._onOtherEvent,{enable:!1}),this.moveInput=new tI(e,this._onOtherEvent,{enable:!1}),this.keyInput=new nI(e,this._onOtherEvent,{enable:!1,tabIndex:t.tabIndex}),this.contextmenuInput=new iI(e,this._onOtherEvent,{enable:!1}),this.on(this.options.events)}}getElement(){return this.element}destroy(){this.element&&(this.wheelInput.destroy(),this.moveInput.destroy(),this.keyInput.destroy(),this.contextmenuInput.destroy(),this.manager.destroy())}on(e,t,i){this._addEventHandler(e,t,i,!1)}once(e,t,i){this._addEventHandler(e,t,i,!0)}watch(e,t,i){this._addEventHandler(e,t,i,!1,!0)}off(e,t){this._removeEventHandler(e,t)}_toggleRecognizer(e,t){var s,o,a,l;const{manager:i}=this;if(!i)return;const r=i.get(e);r&&(r.set({enable:t}),i.touchAction.update()),(s=this.wheelInput)==null||s.enableEventType(e,t),(o=this.moveInput)==null||o.enableEventType(e,t),(a=this.keyInput)==null||a.enableEventType(e,t),(l=this.contextmenuInput)==null||l.enableEventType(e,t)}_addEventHandler(e,t,i,r,s){if(typeof e!="string"){i=t;for(const[c,u]of Object.entries(e))this._addEventHandler(c,u,i,r,s);return}const{manager:o,events:a}=this;if(!o)return;let l=a.get(e);if(!l){const c=this._getRecognizerName(e)||e;l=new pI(this,c),a.set(e,l),o&&o.on(e,l.handleEvent)}l.add(e,t,i,r,s),l.isEmpty()||this._toggleRecognizer(l.recognizerName,!0)}_removeEventHandler(e,t){if(typeof e!="string"){for(const[s,o]of Object.entries(e))this._removeEventHandler(s,o);return}const{events:i}=this,r=i.get(e);if(r&&(r.remove(e,t),r.isEmpty())){const{recognizerName:s}=r;let o=!1;for(const a of i.values())if(a.recognizerName===s&&!a.isEmpty()){o=!0;break}o||this._toggleRecognizer(s,!1)}}_getRecognizerName(e){var t;return(t=this.manager.recognizers.find(i=>i.getEventNames().includes(e)))==null?void 0:t.options.event}}const Z={DEFAULT:-1,LNGLAT:1,METER_OFFSETS:2,LNGLAT_OFFSETS:3,CARTESIAN:0};Object.defineProperty(Z,"IDENTITY",{get:()=>(Q.deprecated("COORDINATE_SYSTEM.IDENTITY","COORDINATE_SYSTEM.CARTESIAN")(),0)});const Ge={WEB_MERCATOR:1,GLOBE:2,WEB_MERCATOR_AUTO_OFFSET:4,IDENTITY:0},Ot={common:0,meters:1,pixels:2},Sl={click:"onClick",dblclick:"onClick",panstart:"onDragStart",panmove:"onDrag",panend:"onDragEnd"},Sh={multipan:[yh,{threshold:10,direction:Te.Vertical,pointers:2}],pinch:[K3,{},null,["multipan"]],pan:[yh,{threshold:1},["pinch"],["multipan"]],dblclick:[_h,{event:"dblclick",taps:2}],click:[_h,{event:"click"},null,["dblclick"]]};function _I(n,e){if(n===e)return!0;if(Array.isArray(n)){const t=n.length;if(!e||e.length!==t)return!1;for(let i=0;i<t;i++)if(n[i]!==e[i])return!1;return!0}return!1}function lr(n){let e={},t;return i=>{for(const r in i)if(!_I(i[r],e[r])){t=n(i),e=i;break}return t}}const Eh=[0,0,0,0],yI=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0],Vm=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],bI=[0,0,0],Wm=[0,0,0],vI=lr(TI);function Hm(n,e,t=Wm){t.length<3&&(t=[t[0],t[1],0]);let i=t,r,s=!0;switch(e===Z.LNGLAT_OFFSETS||e===Z.METER_OFFSETS?r=t:r=n.isGeospatial?[Math.fround(n.longitude),Math.fround(n.latitude),0]:null,n.projectionMode){case Ge.WEB_MERCATOR:(e===Z.LNGLAT||e===Z.CARTESIAN)&&(r=[0,0,0],s=!1);break;case Ge.WEB_MERCATOR_AUTO_OFFSET:e===Z.LNGLAT?i=r:e===Z.CARTESIAN&&(i=[Math.fround(n.center[0]),Math.fround(n.center[1]),0],r=n.unprojectPosition(i),i[0]-=t[0],i[1]-=t[1],i[2]-=t[2]);break;case Ge.IDENTITY:i=n.position.map(Math.fround),i[2]=i[2]||0;break;case Ge.GLOBE:s=!1,r=null;break;default:s=!1}return{geospatialOrigin:r,shaderCoordinateOrigin:i,offsetMode:s}}function xI(n,e,t){const{viewMatrixUncentered:i,projectionMatrix:r}=n;let{viewMatrix:s,viewProjectionMatrix:o}=n,a=Eh,l=Eh,c=n.cameraPosition;const{geospatialOrigin:u,shaderCoordinateOrigin:d,offsetMode:h}=Hm(n,e,t);return h&&(l=n.projectPosition(u||d),c=[c[0]-l[0],c[1]-l[1],c[2]-l[2]],l[3]=1,a=ar([],l,o),s=i||s,o=fn([],r,s),o=fn([],o,yI)),{viewMatrix:s,viewProjectionMatrix:o,projectionCenter:a,originCommon:l,cameraPosCommon:c,shaderCoordinateOrigin:d,geospatialOrigin:u}}function wI({viewport:n,devicePixelRatio:e=1,modelMatrix:t=null,coordinateSystem:i=Z.DEFAULT,coordinateOrigin:r=Wm,autoWrapLongitude:s=!1}){i===Z.DEFAULT&&(i=n.isGeospatial?Z.LNGLAT:Z.CARTESIAN);const o=vI({viewport:n,devicePixelRatio:e,coordinateSystem:i,coordinateOrigin:r});return o.wrapLongitude=s,o.modelMatrix=t||Vm,o}function TI({viewport:n,devicePixelRatio:e,coordinateSystem:t,coordinateOrigin:i}){const{projectionCenter:r,viewProjectionMatrix:s,originCommon:o,cameraPosCommon:a,shaderCoordinateOrigin:l,geospatialOrigin:c}=xI(n,t,i),u=n.getDistanceScales(),d=[n.width*e,n.height*e],h=ar([],[0,0,-n.focalDistance,1],n.projectionMatrix)[3]||1,f={coordinateSystem:t,projectionMode:n.projectionMode,coordinateOrigin:l,commonOrigin:o.slice(0,3),center:r,pseudoMeters:!!n._pseudoMeters,viewportSize:d,devicePixelRatio:e,focalDistance:h,commonUnitsPerMeter:u.unitsPerMeter,commonUnitsPerWorldUnit:u.unitsPerMeter,commonUnitsPerWorldUnit2:bI,scale:n.scale,wrapLongitude:!1,viewProjectionMatrix:s,modelMatrix:Vm,cameraPosition:a};if(c){const p=n.getDistanceScales(c);switch(t){case Z.METER_OFFSETS:f.commonUnitsPerWorldUnit=p.unitsPerMeter,f.commonUnitsPerWorldUnit2=p.unitsPerMeter2;break;case Z.LNGLAT:case Z.LNGLAT_OFFSETS:n._pseudoMeters||(f.commonUnitsPerMeter=p.unitsPerMeter),f.commonUnitsPerWorldUnit=p.unitsPerDegree,f.commonUnitsPerWorldUnit2=p.unitsPerDegree2;break;case Z.CARTESIAN:f.commonUnitsPerWorldUnit=[1,1,p.unitsPerMeter[2]],f.commonUnitsPerWorldUnit2=[0,0,p.unitsPerMeter2[2]];break}}return f}const SI=Object.keys(Z).map(n=>`const COORDINATE_SYSTEM_${n}: i32 = ${Z[n]};`).join(""),EI=Object.keys(Ge).map(n=>`const PROJECTION_MODE_${n}: i32 = ${Ge[n]};`).join(""),AI=Object.keys(Ot).map(n=>`const UNIT_${n.toUpperCase()}: i32 = ${Ot[n]};`).join(""),CI=`${SI}
${EI}
${AI}

const TILE_SIZE: f32 = 512.0;
const PI: f32 = 3.1415926536;
const WORLD_SCALE: f32 = TILE_SIZE / (PI * 2.0);
const ZERO_64_LOW: vec3<f32> = vec3<f32>(0.0, 0.0, 0.0);
const EARTH_RADIUS: f32 = 6370972.0; // meters
const GLOBE_RADIUS: f32 = 256.0;

// -----------------------------------------------------------------------------
// Uniform block (converted from GLSL uniform block)
// -----------------------------------------------------------------------------
struct ProjectUniforms {
  wrapLongitude: i32,
  coordinateSystem: i32,
  commonUnitsPerMeter: vec3<f32>,
  projectionMode: i32,
  scale: f32,
  commonUnitsPerWorldUnit: vec3<f32>,
  commonUnitsPerWorldUnit2: vec3<f32>,
  center: vec4<f32>,
  modelMatrix: mat4x4<f32>,
  viewProjectionMatrix: mat4x4<f32>,
  viewportSize: vec2<f32>,
  devicePixelRatio: f32,
  focalDistance: f32,
  cameraPosition: vec3<f32>,
  coordinateOrigin: vec3<f32>,
  commonOrigin: vec3<f32>,
  pseudoMeters: i32,
};

@group(0) @binding(0)
var<uniform> project: ProjectUniforms;

// -----------------------------------------------------------------------------
// Geometry data
// (In your GLSL code, "geometry" was assumed to be available globally. In WGSL,
// you might supply this via vertex attributes or a uniform. Here we define a
// uniform struct for demonstration.)
// -----------------------------------------------------------------------------

// Structure to carry additional geometry data used by deck.gl filters.
struct Geometry {
  worldPosition: vec3<f32>,
  worldPositionAlt: vec3<f32>,
  position: vec4<f32>,
  uv: vec2<f32>,
  pickingColor: vec3<f32>,
};

// @group(0) @binding(1)
var<private> geometry: Geometry;
`,II=`${CI}

// -----------------------------------------------------------------------------
// Functions
// -----------------------------------------------------------------------------

// Returns an adjustment factor for commonUnitsPerMeter
fn _project_size_at_latitude(lat: f32) -> f32 {
  let y = clamp(lat, -89.9, 89.9);
  return 1.0 / cos(radians(y));
}

// Overloaded version: scales a value in meters at a given latitude.
fn _project_size_at_latitude_m(meters: f32, lat: f32) -> f32 {
  return meters * project.commonUnitsPerMeter.z * _project_size_at_latitude(lat);
}

// Computes a non-linear scale factor based on geometry.
// (Note: This function relies on "geometry" being provided.)
fn project_size() -> f32 {
  if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR &&
      project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT &&
      project.pseudoMeters == 0) {
    if (geometry.position.w == 0.0) {
      return _project_size_at_latitude(geometry.worldPosition.y);
    }
    let y: f32 = geometry.position.y / TILE_SIZE * 2.0 - 1.0;
    let y2 = y * y;
    let y4 = y2 * y2;
    let y6 = y4 * y2;
    return 1.0 + 4.9348 * y2 + 4.0587 * y4 + 1.5642 * y6;
  }
  return 1.0;
}

// Overloads to scale offsets (meters to world units)
fn project_size_float(meters: f32) -> f32 {
  return meters * project.commonUnitsPerMeter.z * project_size();
}

fn project_size_vec2(meters: vec2<f32>) -> vec2<f32> {
  return meters * project.commonUnitsPerMeter.xy * project_size();
}

fn project_size_vec3(meters: vec3<f32>) -> vec3<f32> {
  return meters * project.commonUnitsPerMeter * project_size();
}

fn project_size_vec4(meters: vec4<f32>) -> vec4<f32> {
  return vec4<f32>(meters.xyz * project.commonUnitsPerMeter, meters.w);
}

// Returns a rotation matrix aligning the zâ€‘axis with the given up vector.
fn project_get_orientation_matrix(up: vec3<f32>) -> mat3x3<f32> {
  let uz = normalize(up);
  let ux = select(
    vec3<f32>(1.0, 0.0, 0.0),
    normalize(vec3<f32>(uz.y, -uz.x, 0.0)),
    abs(uz.z) == 1.0
  );
  let uy = cross(uz, ux);
  return mat3x3<f32>(ux, uy, uz);
}

// Since WGSL does not support "out" parameters, we return a struct.
struct RotationResult {
  needsRotation: bool,
  transform: mat3x3<f32>,
};

fn project_needs_rotation(commonPosition: vec3<f32>) -> RotationResult {
  if (project.projectionMode == PROJECTION_MODE_GLOBE) {
    return RotationResult(true, project_get_orientation_matrix(commonPosition));
  } else {
    return RotationResult(false, mat3x3<f32>());  // identity alternative if needed
  };
}

// Projects a normal vector from the current coordinate system to world space.
fn project_normal(vector: vec3<f32>) -> vec3<f32> {
  let normal_modelspace = project.modelMatrix * vec4<f32>(vector, 0.0);
  var n = normalize(normal_modelspace.xyz * project.commonUnitsPerMeter);
  let rotResult = project_needs_rotation(geometry.position.xyz);
  if (rotResult.needsRotation) {
    n = rotResult.transform * n;
  }
  return n;
}

// Applies a scale offset based on y-offset (dy)
fn project_offset_(offset: vec4<f32>) -> vec4<f32> {
  let dy: f32 = offset.y;
  let commonUnitsPerWorldUnit = project.commonUnitsPerWorldUnit + project.commonUnitsPerWorldUnit2 * dy;
  return vec4<f32>(offset.xyz * commonUnitsPerWorldUnit, offset.w);
}

// Projects lng/lat coordinates to a unit tile [0,1]
fn project_mercator_(lnglat: vec2<f32>) -> vec2<f32> {
  var x = lnglat.x;
  if (project.wrapLongitude != 0) {
    x = ((x + 180.0) % 360.0) - 180.0;
  }
  let y = clamp(lnglat.y, -89.9, 89.9);
  return vec2<f32>(
    radians(x) + PI,
    PI + log(tan(PI * 0.25 + radians(y) * 0.5))
  ) * WORLD_SCALE;
}

// Projects lng/lat/z coordinates for a globe projection.
fn project_globe_(lnglatz: vec3<f32>) -> vec3<f32> {
  let lambda = radians(lnglatz.x);
  let phi = radians(lnglatz.y);
  let cosPhi = cos(phi);
  let D = (lnglatz.z / EARTH_RADIUS + 1.0) * GLOBE_RADIUS;
  return vec3<f32>(
    sin(lambda) * cosPhi,
    -cos(lambda) * cosPhi,
    sin(phi)
  ) * D;
}

// Projects positions (with an optional 64-bit low part) from the input
// coordinate system to the common space.
fn project_position_vec4_f64(position: vec4<f32>, position64Low: vec3<f32>) -> vec4<f32> {
  var position_world = project.modelMatrix * position;

  // Work around for a Mac+NVIDIA bug:
  if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR) {
    if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
      return vec4<f32>(
        project_mercator_(position_world.xy),
        _project_size_at_latitude_m(position_world.z, position_world.y),
        position_world.w
      );
    }
    if (project.coordinateSystem == COORDINATE_SYSTEM_CARTESIAN) {
      position_world = vec4f(position_world.xyz + project.coordinateOrigin, position_world.w);
    }
  }
  if (project.projectionMode == PROJECTION_MODE_GLOBE) {
    if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
      return vec4<f32>(
        project_globe_(position_world.xyz),
        position_world.w
      );
    }
  }
  if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET) {
    if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
      if (abs(position_world.y - project.coordinateOrigin.y) > 0.25) {
        return vec4<f32>(
          project_mercator_(position_world.xy) - project.commonOrigin.xy,
          project_size_float(position_world.z),
          position_world.w
        );
      }
    }
  }
  if (project.projectionMode == PROJECTION_MODE_IDENTITY ||
      (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET &&
       (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT ||
        project.coordinateSystem == COORDINATE_SYSTEM_CARTESIAN))) {
    position_world = vec4f(position_world.xyz - project.coordinateOrigin, position_world.w);
  }

  return project_offset_(position_world) +
         project_offset_(project.modelMatrix * vec4<f32>(position64Low, 0.0));
}

// Overloaded versions for different input types.
fn project_position_vec4_f32(position: vec4<f32>) -> vec4<f32> {
  return project_position_vec4_f64(position, ZERO_64_LOW);
}

fn project_position_vec3_f64(position: vec3<f32>, position64Low: vec3<f32>) -> vec3<f32> {
  let projected_position = project_position_vec4_f64(vec4<f32>(position, 1.0), position64Low);
  return projected_position.xyz;
}

fn project_position_vec3_f32(position: vec3<f32>) -> vec3<f32> {
  let projected_position = project_position_vec4_f64(vec4<f32>(position, 1.0), ZERO_64_LOW);
  return projected_position.xyz;
}

fn project_position_vec2_f32(position: vec2<f32>) -> vec2<f32> {
  let projected_position = project_position_vec4_f64(vec4<f32>(position, 0.0, 1.0), ZERO_64_LOW);
  return projected_position.xy;
}

// Transforms a common space position to clip space.
fn project_common_position_to_clipspace_with_projection(position: vec4<f32>, viewProjectionMatrix: mat4x4<f32>, center: vec4<f32>) -> vec4<f32> {
  return viewProjectionMatrix * position + center;
}

// Uses the project viewProjectionMatrix and center.
fn project_common_position_to_clipspace(position: vec4<f32>) -> vec4<f32> {
  return project_common_position_to_clipspace_with_projection(position, project.viewProjectionMatrix, project.center);
}

// Returns a clip space offset corresponding to a given number of screen pixels.
fn project_pixel_size_to_clipspace(pixels: vec2<f32>) -> vec2<f32> {
  let offset = pixels / project.viewportSize * project.devicePixelRatio * 2.0;
  return offset * project.focalDistance;
}

fn project_meter_size_to_pixel(meters: f32) -> f32 {
  return project_size_float(meters) * project.scale;
}

fn project_unit_size_to_pixel(size: f32, unit: i32) -> f32 {
  if (unit == UNIT_METERS) {
    return project_meter_size_to_pixel(size);
  } else if (unit == UNIT_COMMON) {
    return size * project.scale;
  }
  // UNIT_PIXELS: no scaling applied.
  return size;
}

fn project_pixel_size_float(pixels: f32) -> f32 {
  return pixels / project.scale;
}

fn project_pixel_size_vec2(pixels: vec2<f32>) -> vec2<f32> {
  return pixels / project.scale;
}
`,RI=Object.keys(Z).map(n=>`const int COORDINATE_SYSTEM_${n} = ${Z[n]};`).join(""),PI=Object.keys(Ge).map(n=>`const int PROJECTION_MODE_${n} = ${Ge[n]};`).join(""),MI=Object.keys(Ot).map(n=>`const int UNIT_${n.toUpperCase()} = ${Ot[n]};`).join(""),kI=`${RI}
${PI}
${MI}
uniform projectUniforms {
bool wrapLongitude;
int coordinateSystem;
vec3 commonUnitsPerMeter;
int projectionMode;
float scale;
vec3 commonUnitsPerWorldUnit;
vec3 commonUnitsPerWorldUnit2;
vec4 center;
mat4 modelMatrix;
mat4 viewProjectionMatrix;
vec2 viewportSize;
float devicePixelRatio;
float focalDistance;
vec3 cameraPosition;
vec3 coordinateOrigin;
vec3 commonOrigin;
bool pseudoMeters;
} project;
const float TILE_SIZE = 512.0;
const float PI = 3.1415926536;
const float WORLD_SCALE = TILE_SIZE / (PI * 2.0);
const vec3 ZERO_64_LOW = vec3(0.0);
const float EARTH_RADIUS = 6370972.0;
const float GLOBE_RADIUS = 256.0;
float project_size_at_latitude(float lat) {
float y = clamp(lat, -89.9, 89.9);
return 1.0 / cos(radians(y));
}
float project_size() {
if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR &&
project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT &&
project.pseudoMeters == false) {
if (geometry.position.w == 0.0) {
return project_size_at_latitude(geometry.worldPosition.y);
}
float y = geometry.position.y / TILE_SIZE * 2.0 - 1.0;
float y2 = y * y;
float y4 = y2 * y2;
float y6 = y4 * y2;
return 1.0 + 4.9348 * y2 + 4.0587 * y4 + 1.5642 * y6;
}
return 1.0;
}
float project_size_at_latitude(float meters, float lat) {
return meters * project.commonUnitsPerMeter.z * project_size_at_latitude(lat);
}
float project_size(float meters) {
return meters * project.commonUnitsPerMeter.z * project_size();
}
vec2 project_size(vec2 meters) {
return meters * project.commonUnitsPerMeter.xy * project_size();
}
vec3 project_size(vec3 meters) {
return meters * project.commonUnitsPerMeter * project_size();
}
vec4 project_size(vec4 meters) {
return vec4(meters.xyz * project.commonUnitsPerMeter, meters.w);
}
mat3 project_get_orientation_matrix(vec3 up) {
vec3 uz = normalize(up);
vec3 ux = abs(uz.z) == 1.0 ? vec3(1.0, 0.0, 0.0) : normalize(vec3(uz.y, -uz.x, 0));
vec3 uy = cross(uz, ux);
return mat3(ux, uy, uz);
}
bool project_needs_rotation(vec3 commonPosition, out mat3 transform) {
if (project.projectionMode == PROJECTION_MODE_GLOBE) {
transform = project_get_orientation_matrix(commonPosition);
return true;
}
return false;
}
vec3 project_normal(vec3 vector) {
vec4 normal_modelspace = project.modelMatrix * vec4(vector, 0.0);
vec3 n = normalize(normal_modelspace.xyz * project.commonUnitsPerMeter);
mat3 rotation;
if (project_needs_rotation(geometry.position.xyz, rotation)) {
n = rotation * n;
}
return n;
}
vec4 project_offset_(vec4 offset) {
float dy = offset.y;
vec3 commonUnitsPerWorldUnit = project.commonUnitsPerWorldUnit + project.commonUnitsPerWorldUnit2 * dy;
return vec4(offset.xyz * commonUnitsPerWorldUnit, offset.w);
}
vec2 project_mercator_(vec2 lnglat) {
float x = lnglat.x;
if (project.wrapLongitude) {
x = mod(x + 180., 360.0) - 180.;
}
float y = clamp(lnglat.y, -89.9, 89.9);
return vec2(
radians(x) + PI,
PI + log(tan_fp32(PI * 0.25 + radians(y) * 0.5))
) * WORLD_SCALE;
}
vec3 project_globe_(vec3 lnglatz) {
float lambda = radians(lnglatz.x);
float phi = radians(lnglatz.y);
float cosPhi = cos(phi);
float D = (lnglatz.z / EARTH_RADIUS + 1.0) * GLOBE_RADIUS;
return vec3(
sin(lambda) * cosPhi,
-cos(lambda) * cosPhi,
sin(phi)
) * D;
}
vec4 project_position(vec4 position, vec3 position64Low) {
vec4 position_world = project.modelMatrix * position;
if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR) {
if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
return vec4(
project_mercator_(position_world.xy),
project_size_at_latitude(position_world.z, position_world.y),
position_world.w
);
}
if (project.coordinateSystem == COORDINATE_SYSTEM_CARTESIAN) {
position_world.xyz += project.coordinateOrigin;
}
}
if (project.projectionMode == PROJECTION_MODE_GLOBE) {
if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
return vec4(
project_globe_(position_world.xyz),
position_world.w
);
}
}
if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET) {
if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
if (abs(position_world.y - project.coordinateOrigin.y) > 0.25) {
return vec4(
project_mercator_(position_world.xy) - project.commonOrigin.xy,
project_size(position_world.z),
position_world.w
);
}
}
}
if (project.projectionMode == PROJECTION_MODE_IDENTITY ||
(project.projectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET &&
(project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT ||
project.coordinateSystem == COORDINATE_SYSTEM_CARTESIAN))) {
position_world.xyz -= project.coordinateOrigin;
}
return project_offset_(position_world) + project_offset_(project.modelMatrix * vec4(position64Low, 0.0));
}
vec4 project_position(vec4 position) {
return project_position(position, ZERO_64_LOW);
}
vec3 project_position(vec3 position, vec3 position64Low) {
vec4 projected_position = project_position(vec4(position, 1.0), position64Low);
return projected_position.xyz;
}
vec3 project_position(vec3 position) {
vec4 projected_position = project_position(vec4(position, 1.0), ZERO_64_LOW);
return projected_position.xyz;
}
vec2 project_position(vec2 position) {
vec4 projected_position = project_position(vec4(position, 0.0, 1.0), ZERO_64_LOW);
return projected_position.xy;
}
vec4 project_common_position_to_clipspace(vec4 position, mat4 viewProjectionMatrix, vec4 center) {
return viewProjectionMatrix * position + center;
}
vec4 project_common_position_to_clipspace(vec4 position) {
return project_common_position_to_clipspace(position, project.viewProjectionMatrix, project.center);
}
vec2 project_pixel_size_to_clipspace(vec2 pixels) {
vec2 offset = pixels / project.viewportSize * project.devicePixelRatio * 2.0;
return offset * project.focalDistance;
}
float project_size_to_pixel(float meters) {
return project_size(meters) * project.scale;
}
float project_size_to_pixel(float size, int unit) {
if (unit == UNIT_METERS) return project_size_to_pixel(size);
if (unit == UNIT_COMMON) return size * project.scale;
return size;
}
float project_pixel_size(float pixels) {
return pixels / project.scale;
}
vec2 project_pixel_size(vec2 pixels) {
return pixels / project.scale;
}
`,OI={};function NI(n=OI){return"viewport"in n?wI(n):{}}const qc={name:"project",dependencies:[d3,Fm],source:II,vs:kI,getUniforms:NI,uniformTypes:{wrapLongitude:"f32",coordinateSystem:"i32",commonUnitsPerMeter:"vec3<f32>",projectionMode:"i32",scale:"f32",commonUnitsPerWorldUnit:"vec3<f32>",commonUnitsPerWorldUnit2:"vec3<f32>",center:"vec4<f32>",modelMatrix:"mat4x4<f32>",viewProjectionMatrix:"mat4x4<f32>",viewportSize:"vec2<f32>",devicePixelRatio:"f32",focalDistance:"f32",cameraPosition:"vec3<f32>",coordinateOrigin:"vec3<f32>",commonOrigin:"vec3<f32>",pseudoMeters:"f32"}},FI=`// Define a structure to hold both the clip-space position and the common position.
struct ProjectResult {
  clipPosition: vec4<f32>,
  commonPosition: vec4<f32>,
};

// This function mimics the GLSL version with the 'out' parameter by returning both values.
fn project_position_to_clipspace_and_commonspace(
    position: vec3<f32>,
    position64Low: vec3<f32>,
    offset: vec3<f32>
) -> ProjectResult {
  // Compute the projected position.
  let projectedPosition: vec3<f32> = project_position_vec3_f64(position, position64Low);

  // Start with the provided offset.
  var finalOffset: vec3<f32> = offset;

  // Get whether a rotation is needed and the rotation matrix.
  let rotationResult = project_needs_rotation(projectedPosition);

  // If rotation is needed, update the offset.
  if (rotationResult.needsRotation) {
    finalOffset = rotationResult.transform * offset;
  }

  // Compute the common position.
  let commonPosition: vec4<f32> = vec4<f32>(projectedPosition + finalOffset, 1.0);

  // Convert to clip-space.
  let clipPosition: vec4<f32> = project_common_position_to_clipspace(commonPosition);

  return ProjectResult(clipPosition, commonPosition);
}

// A convenience overload that returns only the clip-space position.
fn project_position_to_clipspace(
    position: vec3<f32>,
    position64Low: vec3<f32>,
    offset: vec3<f32>
) -> vec4<f32> {
  return project_position_to_clipspace_and_commonspace(position, position64Low, offset).clipPosition;
}
`,DI=`vec4 project_position_to_clipspace(
  vec3 position, vec3 position64Low, vec3 offset, out vec4 commonPosition
) {
  vec3 projectedPosition = project_position(position, position64Low);
  mat3 rotation;
  if (project_needs_rotation(projectedPosition, rotation)) {
    // offset is specified as ENU
    // when in globe projection, rotate offset so that the ground alighs with the surface of the globe
    offset = rotation * offset;
  }
  commonPosition = vec4(projectedPosition + offset, 1.0);
  return project_common_position_to_clipspace(commonPosition);
}

vec4 project_position_to_clipspace(
  vec3 position, vec3 position64Low, vec3 offset
) {
  vec4 commonPosition;
  return project_position_to_clipspace(position, position64Low, offset, commonPosition);
}
`,wo={name:"project32",dependencies:[qc],source:FI,vs:DI};function BI(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function Xn(n,e){const t=ar([],e,n);return t3(t,t,1/t[3]),t}function Ah(n,e){const t=n%e;return t<0?e+t:t}function El(n,e,t){return n<e?e:n>t?t:n}function LI(n){return Math.log(n)*Math.LOG2E}const Kc=Math.log2||LI;function Nt(n,e){if(!n)throw new Error(e||"@math.gl/web-mercator: assertion failed.")}const ut=Math.PI,jm=ut/4,Je=ut/180,Al=180/ut,ni=512,Vs=4003e4,Nr=85.051129,UI=1.5;function $I(n){return Kc(n)}function Ws(n){const[e,t]=n;Nt(Number.isFinite(e)),Nt(Number.isFinite(t)&&t>=-90&&t<=90,"invalid latitude");const i=e*Je,r=t*Je,s=ni*(i+ut)/(2*ut),o=ni*(ut+Math.log(Math.tan(jm+r*.5)))/(2*ut);return[s,o]}function ii(n){const[e,t]=n,i=e/ni*(2*ut)-ut,r=2*(Math.atan(Math.exp(t/ni*(2*ut)-ut))-jm);return[i*Al,r*Al]}function zI(n){const{latitude:e}=n;Nt(Number.isFinite(e));const t=Math.cos(e*Je);return $I(Vs*t)-9}function aa(n){const e=Math.cos(n*Je);return ni/Vs/e}function Cl(n){const{latitude:e,longitude:t,highPrecision:i=!1}=n;Nt(Number.isFinite(e)&&Number.isFinite(t));const r=ni,s=Math.cos(e*Je),o=r/360,a=o/s,l=r/Vs/s,c={unitsPerMeter:[l,l,l],metersPerUnit:[1/l,1/l,1/l],unitsPerDegree:[o,a,l],degreesPerUnit:[1/o,1/a,1/l]};if(i){const u=Je*Math.tan(e*Je)/s,d=o*u/2,h=r/Vs*u,f=h/a*l;c.unitsPerDegree2=[0,d,h],c.unitsPerMeter2=[f,0,f]}return c}function Xm(n,e){const[t,i,r]=n,[s,o,a]=e,{unitsPerMeter:l,unitsPerMeter2:c}=Cl({longitude:t,latitude:i,highPrecision:!0}),u=Ws(n);u[0]+=s*(l[0]+c[0]*o),u[1]+=o*(l[1]+c[1]*o);const d=ii(u),h=(r||0)+(a||0);return Number.isFinite(r)||Number.isFinite(a)?[d[0],d[1],h]:d}function VI(n){const{height:e,pitch:t,bearing:i,altitude:r,scale:s,center:o}=n,a=BI();$s(a,a,[0,0,-r]),Mm(a,a,-t*Je),km(a,a,i*Je);const l=s/e;return Yc(a,a,[l,l,l]),o&&$s(a,a,M2([],o)),a}function WI(n){const{width:e,height:t,altitude:i,pitch:r=0,offset:s,center:o,scale:a,nearZMultiplier:l=1,farZMultiplier:c=1}=n;let{fovy:u=Hs(UI)}=n;i!==void 0&&(u=Hs(i));const d=u*Je,h=r*Je,f=Zc(u);let p=f;o&&(p+=o[2]*a/Math.cos(h)/t);const g=d*(.5+(s?s[1]:0)/t),_=Math.sin(g)*p/Math.sin(El(Math.PI/2-h-g,.01,Math.PI-.01)),b=Math.sin(h)*_+p,w=p*10,x=Math.min(b*c,w);return{fov:d,aspect:e/t,focalDistance:f,near:l,far:x}}function Hs(n){return 2*Math.atan(.5/n)*Al}function Zc(n){return .5/Math.tan(.5*n*Je)}function Ym(n,e){const[t,i,r=0]=n;return Nt(Number.isFinite(t)&&Number.isFinite(i)&&Number.isFinite(r)),Xn(e,[t,i,r,1])}function cr(n,e,t=0){const[i,r,s]=n;if(Nt(Number.isFinite(i)&&Number.isFinite(r),"invalid pixel coordinate"),Number.isFinite(s))return Xn(e,[i,r,s,1]);const o=Xn(e,[i,r,0,1]),a=Xn(e,[i,r,1,1]),l=o[2],c=a[2],u=l===c?0:((t||0)-l)/(c-l);return Im([],o,a,u)}function HI(n){const{width:e,height:t,bounds:i,minExtent:r=0,maxZoom:s=24,offset:o=[0,0]}=n,[[a,l],[c,u]]=i,d=jI(n.padding),h=Ws([a,El(u,-Nr,Nr)]),f=Ws([c,El(l,-Nr,Nr)]),p=[Math.max(Math.abs(f[0]-h[0]),r),Math.max(Math.abs(f[1]-h[1]),r)],g=[e-d.left-d.right-Math.abs(o[0])*2,t-d.top-d.bottom-Math.abs(o[1])*2];Nt(g[0]>0&&g[1]>0);const _=g[0]/p[0],b=g[1]/p[1],w=(d.right-d.left)/2/_,x=(d.top-d.bottom)/2/b,y=[(f[0]+h[0])/2+w,(f[1]+h[1])/2+x],S=ii(y),I=Math.min(s,Kc(Math.abs(Math.min(_,b))));return Nt(Number.isFinite(I)),{longitude:S[0],latitude:S[1],zoom:I}}function jI(n=0){return typeof n=="number"?{top:n,bottom:n,left:n,right:n}:(Nt(Number.isFinite(n.top)&&Number.isFinite(n.bottom)&&Number.isFinite(n.left)&&Number.isFinite(n.right)),n)}const Ch=Math.PI/180;function XI(n,e=0){const{width:t,height:i,unproject:r}=n,s={targetZ:e},o=r([0,i],s),a=r([t,i],s);let l,c;const u=n.fovy?.5*n.fovy*Ch:Math.atan(.5/n.altitude),d=(90-n.pitch)*Ch;return u>d-.01?(l=Ih(n,0,e),c=Ih(n,t,e)):(l=r([0,0],s),c=r([t,0],s)),[o,a,c,l]}function Ih(n,e,t){const{pixelUnprojectionMatrix:i}=n,r=Xn(i,[e,0,1,1]),s=Xn(i,[e,n.height,1,1]),a=(t*n.distanceScales.unitsPerMeter[2]-r[2])/(s[2]-r[2]),l=Im([],r,s,a),c=ii(l);return c.push(t),c}const Rh=512;function YI(n){const{width:e,height:t,pitch:i=0}=n;let{longitude:r,latitude:s,zoom:o,bearing:a=0}=n;(r<-180||r>180)&&(r=Ah(r+180,360)-180),(a<-180||a>180)&&(a=Ah(a+180,360)-180);const l=Kc(t/Rh);if(o<=l)o=l,s=0;else{const c=t/2/Math.pow(2,o),u=ii([0,c])[1];if(s<u)s=u;else{const d=ii([0,Rh-c])[1];s>d&&(s=d)}}return{width:e,height:t,longitude:r,latitude:s,zoom:o,pitch:i,bearing:a}}const qm=`
uniform shadowUniforms {
  bool drawShadowMap;
  bool useShadowMap;
  vec4 color;
  highp int lightId;
  float lightCount;
  mat4 viewProjectionMatrix0;
  mat4 viewProjectionMatrix1;
  vec4 projectCenter0;
  vec4 projectCenter1;
} shadow;
`,qI=`
const int max_lights = 2;

out vec3 shadow_vPosition[max_lights];

vec4 shadow_setVertexPosition(vec4 position_commonspace) {
  mat4 viewProjectionMatrices[max_lights];
  viewProjectionMatrices[0] = shadow.viewProjectionMatrix0;
  viewProjectionMatrices[1] = shadow.viewProjectionMatrix1;
  vec4 projectCenters[max_lights];
  projectCenters[0] = shadow.projectCenter0;
  projectCenters[1] = shadow.projectCenter1;

  if (shadow.drawShadowMap) {
    return project_common_position_to_clipspace(position_commonspace, viewProjectionMatrices[shadow.lightId], projectCenters[shadow.lightId]);
  }
  if (shadow.useShadowMap) {
    for (int i = 0; i < max_lights; i++) {
      if(i < int(shadow.lightCount)) {
        vec4 shadowMap_position = project_common_position_to_clipspace(position_commonspace, viewProjectionMatrices[i], projectCenters[i]);
        shadow_vPosition[i] = (shadowMap_position.xyz / shadowMap_position.w + 1.0) / 2.0;
      }
    }
  }
  return gl_Position;
}
`,KI=`
${qm}
${qI}
`,ZI=`
const int max_lights = 2;
uniform sampler2D shadow_uShadowMap0;
uniform sampler2D shadow_uShadowMap1;

in vec3 shadow_vPosition[max_lights];

const vec4 bitPackShift = vec4(1.0, 255.0, 65025.0, 16581375.0);
const vec4 bitUnpackShift = 1.0 / bitPackShift;
const vec4 bitMask = vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0,  0.0);

float shadow_getShadowWeight(vec3 position, sampler2D shadowMap) {
  vec4 rgbaDepth = texture(shadowMap, position.xy);

  float z = dot(rgbaDepth, bitUnpackShift);
  return smoothstep(0.001, 0.01, position.z - z);
}

vec4 shadow_filterShadowColor(vec4 color) {
  if (shadow.drawShadowMap) {
    vec4 rgbaDepth = fract(gl_FragCoord.z * bitPackShift);
    rgbaDepth -= rgbaDepth.gbaa * bitMask;
    return rgbaDepth;
  }
  if (shadow.useShadowMap) {
    float shadowAlpha = 0.0;
    shadowAlpha += shadow_getShadowWeight(shadow_vPosition[0], shadow_uShadowMap0);
    if(shadow.lightCount > 1.0) {
      shadowAlpha += shadow_getShadowWeight(shadow_vPosition[1], shadow_uShadowMap1);
    }
    shadowAlpha *= shadow.color.a / shadow.lightCount;
    float blendedAlpha = shadowAlpha + color.a * (1.0 - shadowAlpha);

    return vec4(
      mix(color.rgb, shadow.color.rgb, shadowAlpha / blendedAlpha),
      blendedAlpha
    );
  }
  return color;
}
`,GI=`
${qm}
${ZI}
`,QI=lr(iR),JI=lr(rR),eR=[0,0,0,1],tR=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0];function nR(n,e){const[t,i,r]=n,s=cr([t,i,r],e);return Number.isFinite(r)?s:[s[0],s[1],0]}function iR({viewport:n,center:e}){return new qe(n.viewProjectionMatrix).invert().transform(e)}function rR({viewport:n,shadowMatrices:e}){const t=[],i=n.pixelUnprojectionMatrix,r=n.isGeospatial?void 0:1,s=[[0,0,r],[n.width,0,r],[0,n.height,r],[n.width,n.height,r],[0,0,-1],[n.width,0,-1],[0,n.height,-1],[n.width,n.height,-1]].map(o=>nR(o,i));for(const o of e){const a=o.clone().translate(new Tt(n.center).negate()),l=s.map(u=>a.transform(u)),c=new qe().ortho({left:Math.min(...l.map(u=>u[0])),right:Math.max(...l.map(u=>u[0])),bottom:Math.min(...l.map(u=>u[1])),top:Math.max(...l.map(u=>u[1])),near:Math.min(...l.map(u=>-u[2])),far:Math.max(...l.map(u=>-u[2]))});t.push(c.multiplyRight(o))}return t}function sR(n){const{shadowEnabled:e=!0,project:t}=n;if(!e||!t||!n.shadowMatrices||!n.shadowMatrices.length)return{drawShadowMap:!1,useShadowMap:!1,shadow_uShadowMap0:n.dummyShadowMap,shadow_uShadowMap1:n.dummyShadowMap};const i=qc.getUniforms(t),r=QI({viewport:t.viewport,center:i.center}),s=[],o=JI({shadowMatrices:n.shadowMatrices,viewport:t.viewport}).slice();for(let l=0;l<n.shadowMatrices.length;l++){const c=o[l],u=c.clone().translate(new Tt(t.viewport.center).negate());i.coordinateSystem===Z.LNGLAT&&i.projectionMode===Ge.WEB_MERCATOR?(o[l]=u,s[l]=r):(o[l]=c.clone().multiplyRight(tR),s[l]=u.transform(r))}const a={drawShadowMap:!!n.drawToShadowMap,useShadowMap:n.shadowMaps?n.shadowMaps.length>0:!1,color:n.shadowColor||eR,lightId:n.shadowLightId||0,lightCount:n.shadowMatrices.length,shadow_uShadowMap0:n.dummyShadowMap,shadow_uShadowMap1:n.dummyShadowMap};for(let l=0;l<o.length;l++)a[`viewProjectionMatrix${l}`]=o[l],a[`projectCenter${l}`]=s[l];for(let l=0;l<2;l++)a[`shadow_uShadowMap${l}`]=n.shadowMaps&&n.shadowMaps[l]||n.dummyShadowMap;return a}const Ph={name:"shadow",dependencies:[qc],vs:KI,fs:GI,inject:{"vs:DECKGL_FILTER_GL_POSITION":`
    position = shadow_setVertexPosition(geometry.position);
    `,"fs:DECKGL_FILTER_COLOR":`
    color = shadow_filterShadowColor(color);
    `},getUniforms:sR,uniformTypes:{drawShadowMap:"f32",useShadowMap:"f32",color:"vec4<f32>",lightId:"i32",lightCount:"f32",viewProjectionMatrix0:"mat4x4<f32>",viewProjectionMatrix1:"mat4x4<f32>",projectCenter0:"vec4<f32>",projectCenter1:"vec4<f32>"}},To={...lh,defaultUniforms:{...lh.defaultUniforms,useFloatColors:!1},inject:{"vs:DECKGL_FILTER_GL_POSITION":`
    // for picking depth values
    picking_setPickingAttribute(position.z / position.w);
  `,"vs:DECKGL_FILTER_COLOR":`
  picking_setPickingColor(geometry.pickingColor);
  `,"fs:DECKGL_FILTER_COLOR":{order:99,injection:`
  // use highlight color if this fragment belongs to the selected object.
  color = picking_filterHighlightColor(color);

  // use picking color if rendering to picking FBO.
  color = picking_filterPickingColor(color);
    `}}},oR=[Fm],aR=["vs:DECKGL_FILTER_SIZE(inout vec3 size, VertexGeometry geometry)","vs:DECKGL_FILTER_GL_POSITION(inout vec4 position, VertexGeometry geometry)","vs:DECKGL_FILTER_COLOR(inout vec4 color, VertexGeometry geometry)","fs:DECKGL_FILTER_COLOR(inout vec4 color, FragmentGeometry geometry)"],lR=[];function cR(n){const e=As.getDefaultShaderAssembler();for(const i of oR)e.addDefaultModule(i);const t=n==="glsl"?aR:lR;for(const i of t)e.addShaderHook(i);return e}const uR=[255,255,255],dR=1;let hR=0;class fR{constructor(e={}){this.type="ambient";const{color:t=uR}=e,{intensity:i=dR}=e;this.id=e.id||`ambient-${hR++}`,this.color=t,this.intensity=i}}const pR=[255,255,255],gR=1,mR=[0,0,-1];let _R=0;class Mh{constructor(e={}){this.type="directional";const{color:t=pR}=e,{intensity:i=gR}=e,{direction:r=mR}=e,{_shadow:s=!1}=e;this.id=e.id||`directional-${_R++}`,this.color=t,this.intensity=i,this.type="directional",this.direction=new Tt(r).normalize().toArray(),this.shadow=s}getProjectedLight(e){return this}}class yR{constructor(e,t={id:"pass"}){const{id:i}=t;this.id=i,this.device=e,this.props={...t}}setProps(e){Object.assign(this.props,e)}render(e){}cleanup(){}}class Gc extends yR{constructor(){super(...arguments),this._lastRenderIndex=-1}render(e){const[t,i]=this.device.canvasContext.getDrawingBufferSize(),r=e.clearCanvas??!0,s=e.clearColor??(r?[0,0,0,0]:!1),o=r?1:!1,a=r?0:!1,l=e.colorMask??15,c={viewport:[0,0,t,i]};e.colorMask&&(c.colorMask=l),e.scissorRect&&(c.scissorRect=e.scissorRect);const u=this.device.beginRenderPass({framebuffer:e.target,parameters:c,clearColor:s,clearDepth:o,clearStencil:a});try{return this._drawLayers(u,e)}finally{u.end(),this.device.submit()}}_drawLayers(e,t){const{target:i,shaderModuleProps:r,viewports:s,views:o,onViewportActive:a,clearStack:l=!0}=t;t.pass=t.pass||"unknown",l&&(this._lastRenderIndex=-1);const c=[];for(const u of s){const d=o&&o[u.id];a==null||a(u);const h=this._getDrawLayerParams(u,t),f=u.subViewports||[u];for(const p of f){const g=this._drawLayersInViewport(e,{target:i,shaderModuleProps:r,viewport:p,view:d,pass:t.pass,layers:t.layers},h);c.push(g)}}return c}_getDrawLayerParams(e,{layers:t,pass:i,isPicking:r=!1,layerFilter:s,cullRect:o,effects:a,shaderModuleProps:l},c=!1){var p;const u=[],d=Km(this._lastRenderIndex+1),h={layer:t[0],viewport:e,isPicking:r,renderPass:i,cullRect:o},f={};for(let g=0;g<t.length;g++){const _=t[g],b=this._shouldDrawLayer(_,h,s,f),w={shouldDrawLayer:b};b&&!c&&(w.shouldDrawLayer=!0,w.layerRenderIndex=d(_,b),w.shaderModuleProps=this._getShaderModuleProps(_,a,i,l),w.layerParameters={...(p=_.context.deck)==null?void 0:p.props.parameters,...this.getLayerParameters(_,g,e)}),u[g]=w}return u}_drawLayersInViewport(e,{layers:t,shaderModuleProps:i,pass:r,target:s,viewport:o,view:a},l){const c=bR(this.device,{shaderModuleProps:i,target:s,viewport:o});if(a&&a.props.clear){const d=a.props.clear===!0?{color:!0,depth:!0}:a.props.clear;this.device.beginRenderPass({framebuffer:s,parameters:{viewport:c,scissorRect:c},clearColor:d.color?[0,0,0,0]:!1,clearDepth:d.depth?1:!1}).end()}const u={totalCount:t.length,visibleCount:0,compositeCount:0,pickableCount:0};e.setParameters({viewport:c});for(let d=0;d<t.length;d++){const h=t[d],f=l[d],{shouldDrawLayer:p}=f;if(p&&h.props.pickable&&u.pickableCount++,h.isComposite&&u.compositeCount++,h.isDrawable&&f.shouldDrawLayer){const{layerRenderIndex:g,shaderModuleProps:_,layerParameters:b}=f;u.visibleCount++,this._lastRenderIndex=Math.max(this._lastRenderIndex,g),_.project&&(_.project.viewport=o),h.context.renderPass=e;try{h._drawLayer({renderPass:e,shaderModuleProps:_,uniforms:{layerIndex:g},parameters:b})}catch(w){h.raiseError(w,`drawing ${h} to ${r}`)}}}return u}shouldDrawLayer(e){return!0}getShaderModuleProps(e,t,i){return null}getLayerParameters(e,t,i){return e.props.parameters}_shouldDrawLayer(e,t,i,r){if(!(e.props.visible&&this.shouldDrawLayer(e)))return!1;t.layer=e;let o=e.parent;for(;o;){if(!o.props.visible||!o.filterSubLayer(t))return!1;t.layer=o,o=o.parent}if(i){const a=t.layer.id;if(a in r||(r[a]=i(t)),!r[a])return!1}return e.activateViewport(t.viewport),!0}_getShaderModuleProps(e,t,i,r){var l,c;const s=this.device.canvasContext.cssToDeviceRatio(),o=((l=e.internalState)==null?void 0:l.propsInTransition)||e.props,a={layer:o,picking:{isActive:!1},project:{viewport:e.context.viewport,devicePixelRatio:s,modelMatrix:o.modelMatrix,coordinateSystem:o.coordinateSystem,coordinateOrigin:o.coordinateOrigin,autoWrapLongitude:e.wrapLongitude}};if(t)for(const u of t)kh(a,(c=u.getShaderModuleProps)==null?void 0:c.call(u,e,a));return kh(a,this.getShaderModuleProps(e,t,a),r)}}function Km(n=0,e={}){const t={},i=(r,s)=>{const o=r.props._offset,a=r.id,l=r.parent&&r.parent.id;let c;if(l&&!(l in e)&&i(r.parent,!1),l in t){const u=t[l]=t[l]||Km(e[l],e);c=u(r,s),t[a]=u}else Number.isFinite(o)?(c=o+(e[l]||0),t[a]=null):c=n;return s&&c>=n&&(n=c+1),e[a]=c,c};return i}function bR(n,{shaderModuleProps:e,target:t,viewport:i}){var l;const r=((l=e==null?void 0:e.project)==null?void 0:l.devicePixelRatio)??n.canvasContext.cssToDeviceRatio(),[,s]=n.canvasContext.getDrawingBufferSize(),o=t?t.height:s,a=i;return[a.x*r,o-(a.y+a.height)*r,a.width*r,a.height*r]}function kh(n,...e){for(const t of e)if(t)for(const i in t)n[i]?Object.assign(n[i],t[i]):n[i]=t[i];return n}class vR extends Gc{constructor(e,t){super(e,t);const i=e.createTexture({format:"rgba8unorm",width:1,height:1,sampler:{minFilter:"linear",magFilter:"linear",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge"},mipmaps:!0}),r=e.createTexture({format:"depth16unorm",width:1,height:1,mipmaps:!1});this.fbo=e.createFramebuffer({id:"shadowmap",width:1,height:1,colorAttachments:[i],depthStencilAttachment:r})}delete(){this.fbo&&(this.fbo.destroy(),this.fbo=null)}getShadowMap(){return this.fbo.colorAttachments[0].texture}render(e){const t=this.fbo,i=this.device.canvasContext.cssToDeviceRatio(),r=e.viewports[0],s=r.width*i,o=r.height*i,a=[1,1,1,1];(s!==t.width||o!==t.height)&&t.resize({width:s,height:o}),super.render({...e,clearColor:a,target:t,pass:"shadow"})}getLayerParameters(e,t,i){return{...e.props.parameters,blend:!1,depthWriteEnabled:!0,depthCompare:"less-equal"}}shouldDrawLayer(e){return e.props.shadowEnabled!==!1}getShaderModuleProps(e,t,i){return{shadow:{project:i.project,drawToShadowMap:!0}}}}const xR={color:[255,255,255],intensity:1},Oh=[{color:[255,255,255],intensity:1,direction:[-1,3,-1]},{color:[255,255,255],intensity:.9,direction:[1,-8,-2.5]}],wR=[0,0,0,200/255];class Zm{constructor(e={}){this.id="lighting-effect",this.shadowColor=wR,this.shadow=!1,this.directionalLights=[],this.pointLights=[],this.shadowPasses=[],this.dummyShadowMap=null,this.setProps(e)}setup(e){this.context=e;const{device:t,deck:i}=e;this.shadow&&!this.dummyShadowMap&&(this._createShadowPasses(t),i._addDefaultShaderModule(Ph),this.dummyShadowMap=t.createTexture({width:1,height:1}))}setProps(e){this.ambientLight=void 0,this.directionalLights=[],this.pointLights=[];for(const t in e){const i=e[t];switch(i.type){case"ambient":this.ambientLight=i;break;case"directional":this.directionalLights.push(i);break;case"point":this.pointLights.push(i);break}}this._applyDefaultLights(),this.shadow=this.directionalLights.some(t=>t.shadow),this.context&&this.setup(this.context),this.props=e}preRender({layers:e,layerFilter:t,viewports:i,onViewportActive:r,views:s}){if(this.shadow){this.shadowMatrices=this._calculateMatrices();for(let o=0;o<this.shadowPasses.length;o++)this.shadowPasses[o].render({layers:e,layerFilter:t,viewports:i,onViewportActive:r,views:s,shaderModuleProps:{shadow:{shadowLightId:o,dummyShadowMap:this.dummyShadowMap,shadowMatrices:this.shadowMatrices}}})}}getShaderModuleProps(e,t){const i=this.shadow?{project:t.project,shadowMaps:this.shadowPasses.map(o=>o.getShadowMap()),dummyShadowMap:this.dummyShadowMap,shadowColor:this.shadowColor,shadowMatrices:this.shadowMatrices}:{},r={enabled:!0,ambientLight:this.ambientLight,directionalLights:this.directionalLights.map(o=>o.getProjectedLight({layer:e})),pointLights:this.pointLights.map(o=>o.getProjectedLight({layer:e}))},s=e.props.material;return{shadow:i,lighting:r,phongMaterial:s,gouraudMaterial:s}}cleanup(e){for(const t of this.shadowPasses)t.delete();this.shadowPasses.length=0,this.dummyShadowMap&&(this.dummyShadowMap.destroy(),this.dummyShadowMap=null,e.deck._removeDefaultShaderModule(Ph))}_calculateMatrices(){const e=[];for(const t of this.directionalLights){const i=new qe().lookAt({eye:new Tt(t.direction).negate()});e.push(i)}return e}_createShadowPasses(e){for(let t=0;t<this.directionalLights.length;t++){const i=new vR(e);this.shadowPasses[t]=i}}_applyDefaultLights(){const{ambientLight:e,pointLights:t,directionalLights:i}=this;!e&&t.length===0&&i.length===0&&(this.ambientLight=new fR(xR),this.directionalLights.push(new Mh(Oh[0]),new Mh(Oh[1])))}}class TR{constructor(e={}){this._pool=[],this.opts={overAlloc:2,poolSize:100},this.setOptions(e)}setOptions(e){Object.assign(this.opts,e)}allocate(e,t,{size:i=1,type:r,padding:s=0,copy:o=!1,initialize:a=!1,maxCount:l}){const c=r||e&&e.constructor||Float32Array,u=t*i+s;if(ArrayBuffer.isView(e)){if(u<=e.length)return e;if(u*e.BYTES_PER_ELEMENT<=e.buffer.byteLength)return new c(e.buffer,0,u)}let d=1/0;l&&(d=l*i+s);const h=this._allocate(c,u,a,d);return e&&o?h.set(e):a||h.fill(0,0,4),this._release(e),h}release(e){this._release(e)}_allocate(e,t,i,r){let s=Math.max(Math.ceil(t*this.opts.overAlloc),1);s>r&&(s=r);const o=this._pool,a=e.BYTES_PER_ELEMENT*s,l=o.findIndex(c=>c.byteLength>=a);if(l>=0){const c=new e(o.splice(l,1)[0],0,s);return i&&c.fill(0),c}return new e(s)}_release(e){if(!ArrayBuffer.isView(e))return;const t=this._pool,{buffer:i}=e,{byteLength:r}=i,s=t.findIndex(o=>o.byteLength>=r);s<0?t.push(i):(s>0||t.length<this.opts.poolSize)&&t.splice(s,0,i),t.length>this.opts.poolSize&&t.shift()}}const ri=new TR;function wi(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function SR(n,e){const t=n%e;return t<0?e+t:t}function ER(n){return[n[12],n[13],n[14]]}function AR(n){return{left:kn(n[3]+n[0],n[7]+n[4],n[11]+n[8],n[15]+n[12]),right:kn(n[3]-n[0],n[7]-n[4],n[11]-n[8],n[15]-n[12]),bottom:kn(n[3]+n[1],n[7]+n[5],n[11]+n[9],n[15]+n[13]),top:kn(n[3]-n[1],n[7]-n[5],n[11]-n[9],n[15]-n[13]),near:kn(n[3]+n[2],n[7]+n[6],n[11]+n[10],n[15]+n[14]),far:kn(n[3]-n[2],n[7]-n[6],n[11]-n[10],n[15]-n[14])}}const Nh=new Tt;function kn(n,e,t,i){Nh.set(n,e,t);const r=Nh.len();return{distance:i/r,normal:new Tt(-n/r,-e/r,-t/r)}}function CR(n){return n-Math.fround(n)}let fi;function la(n,e){const{size:t=1,startIndex:i=0}=e,r=e.endIndex!==void 0?e.endIndex:n.length,s=(r-i)/t;fi=ri.allocate(fi,s,{type:Float32Array,size:t*2});let o=i,a=0;for(;o<r;){for(let l=0;l<t;l++){const c=n[o++];fi[a+l]=c,fi[a+l+t]=CR(c)}a+=t*2}return fi.subarray(0,s*t*2)}function IR(n){let e=null,t=!1;for(const i of n)i&&(e?(t||(e=[[e[0][0],e[0][1]],[e[1][0],e[1][1]]],t=!0),e[0][0]=Math.min(e[0][0],i[0][0]),e[0][1]=Math.min(e[0][1],i[0][1]),e[1][0]=Math.max(e[1][0],i[1][0]),e[1][1]=Math.max(e[1][1],i[1][1])):e=i);return e}const RR=Math.PI/180,PR=wi(),Fh=[0,0,0],MR={unitsPerMeter:[1,1,1],metersPerUnit:[1,1,1]};function kR({width:n,height:e,orthographic:t,fovyRadians:i,focalDistance:r,padding:s,near:o,far:a}){const l=n/e,c=t?new qe().orthographic({fovy:i,aspect:l,focalDistance:r,near:o,far:a}):new qe().perspective({fovy:i,aspect:l,near:o,far:a});if(s){const{left:u=0,right:d=0,top:h=0,bottom:f=0}=s,p=Ce((u+n-d)/2,0,n)-n/2,g=Ce((h+e-f)/2,0,e)-e/2;c[8]-=p*2/n,c[9]+=g*2/e}return c}class So{constructor(e={}){this._frustumPlanes={},this.id=e.id||this.constructor.displayName||"viewport",this.x=e.x||0,this.y=e.y||0,this.width=e.width||1,this.height=e.height||1,this.zoom=e.zoom||0,this.padding=e.padding,this.distanceScales=e.distanceScales||MR,this.focalDistance=e.focalDistance||1,this.position=e.position||Fh,this.modelMatrix=e.modelMatrix||null;const{longitude:t,latitude:i}=e;this.isGeospatial=Number.isFinite(i)&&Number.isFinite(t),this._initProps(e),this._initMatrices(e),this.equals=this.equals.bind(this),this.project=this.project.bind(this),this.unproject=this.unproject.bind(this),this.projectPosition=this.projectPosition.bind(this),this.unprojectPosition=this.unprojectPosition.bind(this),this.projectFlat=this.projectFlat.bind(this),this.unprojectFlat=this.unprojectFlat.bind(this)}get subViewports(){return null}get metersPerPixel(){return this.distanceScales.metersPerUnit[2]/this.scale}get projectionMode(){return this.isGeospatial?this.zoom<12?Ge.WEB_MERCATOR:Ge.WEB_MERCATOR_AUTO_OFFSET:Ge.IDENTITY}equals(e){return e instanceof So?this===e?!0:e.width===this.width&&e.height===this.height&&e.scale===this.scale&&qi(e.projectionMatrix,this.projectionMatrix)&&qi(e.viewMatrix,this.viewMatrix):!1}project(e,{topLeft:t=!0}={}){const i=this.projectPosition(e),r=Ym(i,this.pixelProjectionMatrix),[s,o]=r,a=t?o:this.height-o;return e.length===2?[s,a]:[s,a,r[2]]}unproject(e,{topLeft:t=!0,targetZ:i}={}){const[r,s,o]=e,a=t?s:this.height-s,l=i&&i*this.distanceScales.unitsPerMeter[2],c=cr([r,a,o],this.pixelUnprojectionMatrix,l),[u,d,h]=this.unprojectPosition(c);return Number.isFinite(o)?[u,d,h]:Number.isFinite(i)?[u,d,i]:[u,d]}projectPosition(e){const[t,i]=this.projectFlat(e),r=(e[2]||0)*this.distanceScales.unitsPerMeter[2];return[t,i,r]}unprojectPosition(e){const[t,i]=this.unprojectFlat(e),r=(e[2]||0)*this.distanceScales.metersPerUnit[2];return[t,i,r]}projectFlat(e){if(this.isGeospatial){const t=Ws(e);return t[1]=Ce(t[1],-318,830),t}return e}unprojectFlat(e){return this.isGeospatial?ii(e):e}getBounds(e={}){const t={targetZ:e.z||0},i=this.unproject([0,0],t),r=this.unproject([this.width,0],t),s=this.unproject([0,this.height],t),o=this.unproject([this.width,this.height],t);return[Math.min(i[0],r[0],s[0],o[0]),Math.min(i[1],r[1],s[1],o[1]),Math.max(i[0],r[0],s[0],o[0]),Math.max(i[1],r[1],s[1],o[1])]}getDistanceScales(e){return e&&this.isGeospatial?Cl({longitude:e[0],latitude:e[1],highPrecision:!0}):this.distanceScales}containsPixel({x:e,y:t,width:i=1,height:r=1}){return e<this.x+this.width&&this.x<e+i&&t<this.y+this.height&&this.y<t+r}getFrustumPlanes(){return this._frustumPlanes.near?this._frustumPlanes:(Object.assign(this._frustumPlanes,AR(this.viewProjectionMatrix)),this._frustumPlanes)}panByPosition(e,t){return null}_initProps(e){const t=e.longitude,i=e.latitude;this.isGeospatial&&(Number.isFinite(e.zoom)||(this.zoom=zI({latitude:i})+Math.log2(this.focalDistance)),this.distanceScales=e.distanceScales||Cl({latitude:i,longitude:t}));const r=Math.pow(2,this.zoom);this.scale=r;const{position:s,modelMatrix:o}=e;let a=Fh;if(s&&(a=o?new qe(o).transformAsVector(s,[]):s),this.isGeospatial){const l=this.projectPosition([t,i,0]);this.center=new Tt(a).scale(this.distanceScales.unitsPerMeter).add(l)}else this.center=this.projectPosition(a)}_initMatrices(e){const{viewMatrix:t=PR,projectionMatrix:i=null,orthographic:r=!1,fovyRadians:s,fovy:o=75,near:a=.1,far:l=1e3,padding:c=null,focalDistance:u=1}=e;this.viewMatrixUncentered=t,this.viewMatrix=new qe().multiplyRight(t).translate(new Tt(this.center).negate()),this.projectionMatrix=i||kR({width:this.width,height:this.height,orthographic:r,fovyRadians:s||o*RR,focalDistance:u,padding:c,near:a,far:l});const d=wi();fn(d,d,this.projectionMatrix),fn(d,d,this.viewMatrix),this.viewProjectionMatrix=d,this.viewMatrixInverse=yl([],this.viewMatrix)||this.viewMatrix,this.cameraPosition=ER(this.viewMatrixInverse);const h=wi(),f=wi();Yc(h,h,[this.width/2,-this.height/2,1]),$s(h,h,[1,-1,0]),fn(f,h,this.viewProjectionMatrix),this.pixelProjectionMatrix=f,this.pixelUnprojectionMatrix=yl(wi(),this.pixelProjectionMatrix),this.pixelUnprojectionMatrix||Q.warn("Pixel project matrix not invertible")()}}So.displayName="Viewport";const Eo=So;class Ki extends Eo{constructor(e={}){const{latitude:t=0,longitude:i=0,zoom:r=0,pitch:s=0,bearing:o=0,nearZMultiplier:a=.1,farZMultiplier:l=1.01,nearZ:c,farZ:u,orthographic:d=!1,projectionMatrix:h,repeat:f=!1,worldOffset:p=0,position:g,padding:_,legacyMeterSizes:b=!1}=e;let{width:w,height:x,altitude:y=1.5}=e;const S=Math.pow(2,r);w=w||1,x=x||1;let I,F=null;if(h)y=h[5]/2,I=Hs(y);else{e.fovy?(I=e.fovy,y=Zc(I)):I=Hs(y);let B;if(_){const{top:U=0,bottom:O=0}=_;B=[0,Ce((U+x-O)/2,0,x)-x/2]}F=WI({width:w,height:x,scale:S,center:g&&[0,0,g[2]*aa(t)],offset:B,pitch:s,fovy:I,nearZMultiplier:a,farZMultiplier:l}),Number.isFinite(c)&&(F.near=c),Number.isFinite(u)&&(F.far=u)}let D=VI({height:x,pitch:s,bearing:o,scale:S,altitude:y});p&&(D=new qe().translate([512*p,0,0]).multiplyLeft(D)),super({...e,width:w,height:x,viewMatrix:D,longitude:i,latitude:t,zoom:r,...F,fovy:I,focalDistance:y}),this.latitude=t,this.longitude=i,this.zoom=r,this.pitch=s,this.bearing=o,this.altitude=y,this.fovy=I,this.orthographic=d,this._subViewports=f?[]:null,this._pseudoMeters=b,Object.freeze(this)}get subViewports(){if(this._subViewports&&!this._subViewports.length){const e=this.getBounds(),t=Math.floor((e[0]+180)/360),i=Math.ceil((e[2]-180)/360);for(let r=t;r<=i;r++){const s=r?new Ki({...this,worldOffset:r}):this;this._subViewports.push(s)}}return this._subViewports}projectPosition(e){if(this._pseudoMeters)return super.projectPosition(e);const[t,i]=this.projectFlat(e),r=(e[2]||0)*aa(e[1]);return[t,i,r]}unprojectPosition(e){if(this._pseudoMeters)return super.unprojectPosition(e);const[t,i]=this.unprojectFlat(e),r=(e[2]||0)/aa(i);return[t,i,r]}addMetersToLngLat(e,t){return Xm(e,t)}panByPosition(e,t){const i=cr(t,this.pixelUnprojectionMatrix),r=this.projectFlat(e),s=Us([],r,Cm([],i)),o=Us([],this.center,s),[a,l]=this.unprojectFlat(o);return{longitude:a,latitude:l}}getBounds(e={}){const t=XI(this,e.z||0);return[Math.min(t[0][0],t[1][0],t[2][0],t[3][0]),Math.min(t[0][1],t[1][1],t[2][1],t[3][1]),Math.max(t[0][0],t[1][0],t[2][0],t[3][0]),Math.max(t[0][1],t[1][1],t[2][1],t[3][1])]}fitBounds(e,t={}){const{width:i,height:r}=this,{longitude:s,latitude:o,zoom:a}=HI({width:i,height:r,bounds:e,...t});return new Ki({width:i,height:r,longitude:s,latitude:o,zoom:a})}}Ki.displayName="WebMercatorViewport";const Gm=Ki,Dh=[0,0,0];function ca(n,e,t=!1){const i=e.projectPosition(n);if(t&&e instanceof Gm){const[r,s,o=0]=n,a=e.getDistanceScales([r,s]);i[2]=o*a.unitsPerMeter[2]}return i}function OR(n){const{viewport:e,modelMatrix:t,coordinateOrigin:i}=n;let{coordinateSystem:r,fromCoordinateSystem:s,fromCoordinateOrigin:o}=n;return r===Z.DEFAULT&&(r=e.isGeospatial?Z.LNGLAT:Z.CARTESIAN),s===void 0&&(s=r),o===void 0&&(o=i),{viewport:e,coordinateSystem:r,coordinateOrigin:i,modelMatrix:t,fromCoordinateSystem:s,fromCoordinateOrigin:o}}function Qm(n,{viewport:e,modelMatrix:t,coordinateSystem:i,coordinateOrigin:r,offsetMode:s}){let[o,a,l=0]=n;switch(t&&([o,a,l]=ar([],[o,a,l,1],t)),i){case Z.LNGLAT:return ca([o,a,l],e,s);case Z.LNGLAT_OFFSETS:return ca([o+r[0],a+r[1],l+(r[2]||0)],e,s);case Z.METER_OFFSETS:return ca(Xm(r,[o,a,l]),e,s);case Z.CARTESIAN:default:return e.isGeospatial?[o+r[0],a+r[1],l+r[2]]:e.projectPosition([o,a,l])}}function NR(n,e){const{viewport:t,coordinateSystem:i,coordinateOrigin:r,modelMatrix:s,fromCoordinateSystem:o,fromCoordinateOrigin:a}=OR(e),{autoOffset:l=!0}=e,{geospatialOrigin:c=Dh,shaderCoordinateOrigin:u=Dh,offsetMode:d=!1}=l?Hm(t,i,r):{},h=Qm(n,{viewport:t,modelMatrix:s,coordinateSystem:o,coordinateOrigin:a,offsetMode:d});if(d){const f=t.projectPosition(c||u);$2(h,h,f)}return h}let FR=1,DR=1;class Jm{constructor(){m(this,"time",0);m(this,"channels",new Map);m(this,"animations",new Map);m(this,"playing",!1);m(this,"lastEngineTime",-1)}addChannel(e){const{delay:t=0,duration:i=Number.POSITIVE_INFINITY,rate:r=1,repeat:s=1}=e,o=FR++,a={time:0,delay:t,duration:i,rate:r,repeat:s};return this._setChannelTime(a,this.time),this.channels.set(o,a),o}removeChannel(e){this.channels.delete(e);for(const[t,i]of this.animations)i.channel===e&&this.detachAnimation(t)}isFinished(e){const t=this.channels.get(e);return t===void 0?!1:this.time>=t.delay+t.duration*t.repeat}getTime(e){if(e===void 0)return this.time;const t=this.channels.get(e);return t===void 0?-1:t.time}setTime(e){this.time=Math.max(0,e);const t=this.channels.values();for(const r of t)this._setChannelTime(r,this.time);const i=this.animations.values();for(const r of i){const{animation:s,channel:o}=r;s.setTime(this.getTime(o))}}play(){this.playing=!0}pause(){this.playing=!1,this.lastEngineTime=-1}reset(){this.setTime(0)}attachAnimation(e,t){const i=DR++;return this.animations.set(i,{animation:e,channel:t}),e.setTime(this.getTime(t)),i}detachAnimation(e){this.animations.delete(e)}update(e){this.playing&&(this.lastEngineTime===-1&&(this.lastEngineTime=e),this.setTime(this.time+(e-this.lastEngineTime)),this.lastEngineTime=e)}_setChannelTime(e,t){const i=t-e.delay,r=e.duration*e.repeat;i>=r?e.time=e.duration*e.rate:(e.time=Math.max(0,i)%e.duration,e.time*=e.rate)}}function BR(n){return typeof window<"u"&&window.requestAnimationFrame?window.requestAnimationFrame(n):setTimeout(n,1e3/60)}function LR(n){return typeof window<"u"&&window.cancelAnimationFrame?window.cancelAnimationFrame(n):clearTimeout(n)}let UR=0;const $R={device:null,onAddHTML:()=>"",onInitialize:async()=>null,onRender:()=>{},onFinalize:()=>{},onError:n=>console.error(n),stats:al.stats.get(`animation-loop-${UR++}`),useDevicePixels:!0,autoResizeViewport:!1,autoResizeDrawingBuffer:!1};class zR{constructor(e){m(this,"device",null);m(this,"canvas",null);m(this,"props");m(this,"animationProps",null);m(this,"timeline",null);m(this,"stats");m(this,"cpuTime");m(this,"gpuTime");m(this,"frameRate");m(this,"display");m(this,"needsRedraw","initialized");m(this,"_initialized",!1);m(this,"_running",!1);m(this,"_animationFrameId",null);m(this,"_nextFramePromise",null);m(this,"_resolveNextFrame",null);m(this,"_cpuStartTime",0);m(this,"_error",null);if(this.props={...$R,...e},e=this.props,!e.device)throw new Error("No device provided");const{useDevicePixels:t=!0}=this.props;this.stats=e.stats||new yo({id:"animation-loop-stats"}),this.cpuTime=this.stats.get("CPU Time"),this.gpuTime=this.stats.get("GPU Time"),this.frameRate=this.stats.get("Frame Rate"),this.setProps({autoResizeViewport:e.autoResizeViewport,autoResizeDrawingBuffer:e.autoResizeDrawingBuffer,useDevicePixels:t}),this.start=this.start.bind(this),this.stop=this.stop.bind(this),this._onMousemove=this._onMousemove.bind(this),this._onMouseleave=this._onMouseleave.bind(this)}destroy(){this.stop(),this._setDisplay(null)}delete(){this.destroy()}setError(e){var i,r;if(this.props.onError(e),this._error=Error(),((r=(i=this.device)==null?void 0:i.canvasContext)==null?void 0:r.canvas)instanceof HTMLCanvasElement){const s=document.createElement("h1");s.innerHTML=e.message,s.style.position="absolute",s.style.top="20%",s.style.left="10px",s.style.color="black",s.style.backgroundColor="red",document.body.appendChild(s)}}setNeedsRedraw(e){return this.needsRedraw=this.needsRedraw||e,this}setProps(e){return"autoResizeViewport"in e&&(this.props.autoResizeViewport=e.autoResizeViewport||!1),"autoResizeDrawingBuffer"in e&&(this.props.autoResizeDrawingBuffer=e.autoResizeDrawingBuffer||!1),"useDevicePixels"in e&&(this.props.useDevicePixels=e.useDevicePixels||!1),this}async start(){if(this._running)return this;this._running=!0;try{let e;return this._initialized||(this._initialized=!0,await this._initDevice(),this._initialize(),await this.props.onInitialize(this._getAnimationProps())),this._running?(e!==!1&&(this._cancelAnimationFrame(),this._requestAnimationFrame()),this):null}catch(e){const t=e instanceof Error?e:new Error("Unknown error");throw this.props.onError(t),t}}stop(){return this._running&&(this.animationProps&&!this._error&&this.props.onFinalize(this.animationProps),this._cancelAnimationFrame(),this._nextFramePromise=null,this._resolveNextFrame=null,this._running=!1),this}redraw(){var e;return(e=this.device)!=null&&e.isLost||this._error?this:(this._beginFrameTimers(),this._setupFrame(),this._updateAnimationProps(),this._renderFrame(this._getAnimationProps()),this._clearNeedsRedraw(),this._resolveNextFrame&&(this._resolveNextFrame(this),this._nextFramePromise=null,this._resolveNextFrame=null),this._endFrameTimers(),this)}attachTimeline(e){return this.timeline=e,this.timeline}detachTimeline(){this.timeline=null}waitForRender(){return this.setNeedsRedraw("waitForRender"),this._nextFramePromise||(this._nextFramePromise=new Promise(e=>{this._resolveNextFrame=e})),this._nextFramePromise}async toDataURL(){if(this.setNeedsRedraw("toDataURL"),await this.waitForRender(),this.canvas instanceof HTMLCanvasElement)return this.canvas.toDataURL();throw new Error("OffscreenCanvas")}_initialize(){this._startEventHandling(),this._initializeAnimationProps(),this._updateAnimationProps(),this._resizeCanvasDrawingBuffer(),this._resizeViewport()}_setDisplay(e){this.display&&(this.display.destroy(),this.display.animationLoop=null),e&&(e.animationLoop=this),this.display=e}_requestAnimationFrame(){this._running&&(this._animationFrameId=BR(this._animationFrame.bind(this)))}_cancelAnimationFrame(){this._animationFrameId!==null&&(LR(this._animationFrameId),this._animationFrameId=null)}_animationFrame(){this._running&&(this.redraw(),this._requestAnimationFrame())}_renderFrame(e){var t;if(this.display){this.display._renderFrame(e);return}this.props.onRender(this._getAnimationProps()),(t=this.device)==null||t.submit()}_clearNeedsRedraw(){this.needsRedraw=!1}_setupFrame(){this._resizeCanvasDrawingBuffer(),this._resizeViewport()}_initializeAnimationProps(){var t,i;const e=(i=(t=this.device)==null?void 0:t.canvasContext)==null?void 0:i.canvas;if(!this.device||!e)throw new Error("loop");this.animationProps={animationLoop:this,device:this.device,canvas:e,timeline:this.timeline,useDevicePixels:this.props.useDevicePixels,needsRedraw:!1,width:1,height:1,aspect:1,time:0,startTime:Date.now(),engineTime:0,tick:0,tock:0,_mousePosition:null}}_getAnimationProps(){if(!this.animationProps)throw new Error("animationProps");return this.animationProps}_updateAnimationProps(){if(!this.animationProps)return;const{width:e,height:t,aspect:i}=this._getSizeAndAspect();(e!==this.animationProps.width||t!==this.animationProps.height)&&this.setNeedsRedraw("drawing buffer resized"),i!==this.animationProps.aspect&&this.setNeedsRedraw("drawing buffer aspect changed"),this.animationProps.width=e,this.animationProps.height=t,this.animationProps.aspect=i,this.animationProps.needsRedraw=this.needsRedraw,this.animationProps.engineTime=Date.now()-this.animationProps.startTime,this.timeline&&this.timeline.update(this.animationProps.engineTime),this.animationProps.tick=Math.floor(this.animationProps.time/1e3*60),this.animationProps.tock++,this.animationProps.time=this.timeline?this.timeline.getTime():this.animationProps.engineTime}async _initDevice(){var e;if(this.device=await this.props.device,!this.device)throw new Error("No device provided");this.canvas=((e=this.device.canvasContext)==null?void 0:e.canvas)||null}_createInfoDiv(){if(this.canvas&&this.props.onAddHTML){const e=document.createElement("div");document.body.appendChild(e),e.style.position="relative";const t=document.createElement("div");t.style.position="absolute",t.style.left="10px",t.style.bottom="10px",t.style.width="300px",t.style.background="white",this.canvas instanceof HTMLCanvasElement&&e.appendChild(this.canvas),e.appendChild(t);const i=this.props.onAddHTML(t);i&&(t.innerHTML=i)}}_getSizeAndAspect(){var s,o,a,l;if(!this.device)return{width:1,height:1,aspect:1};const[e,t]=((o=(s=this.device)==null?void 0:s.canvasContext)==null?void 0:o.getPixelSize())||[1,1];let i=1;const r=(l=(a=this.device)==null?void 0:a.canvasContext)==null?void 0:l.canvas;return r&&r.clientHeight?i=r.clientWidth/r.clientHeight:e>0&&t>0&&(i=e/t),{width:e,height:t,aspect:i}}_resizeViewport(){this.props.autoResizeViewport&&this.device.gl&&this.device.gl.viewport(0,0,this.device.gl.drawingBufferWidth,this.device.gl.drawingBufferHeight)}_resizeCanvasDrawingBuffer(){var e,t;this.props.autoResizeDrawingBuffer&&((t=(e=this.device)==null?void 0:e.canvasContext)==null||t.resize({useDevicePixels:this.props.useDevicePixels}))}_beginFrameTimers(){this.frameRate.timeEnd(),this.frameRate.timeStart(),this.cpuTime.timeStart()}_endFrameTimers(){this.cpuTime.timeEnd()}_startEventHandling(){this.canvas&&(this.canvas.addEventListener("mousemove",this._onMousemove.bind(this)),this.canvas.addEventListener("mouseleave",this._onMouseleave.bind(this)))}_onMousemove(e){e instanceof MouseEvent&&(this._getAnimationProps()._mousePosition=[e.offsetX,e.offsetY])}_onMouseleave(e){this._getAnimationProps()._mousePosition=null}}const ua={};function Ao(n="id"){ua[n]=ua[n]||1;const e=ua[n]++;return`${n}-${e}`}class Bh{constructor(e){m(this,"id");m(this,"userData",{});m(this,"topology");m(this,"bufferLayout",[]);m(this,"vertexCount");m(this,"indices");m(this,"attributes");if(this.id=e.id||Ao("geometry"),this.topology=e.topology,this.indices=e.indices||null,this.attributes=e.attributes,this.vertexCount=e.vertexCount,this.bufferLayout=e.bufferLayout||[],this.indices&&!(this.indices.usage&le.INDEX))throw new Error("Index buffer must have INDEX usage")}destroy(){var e;(e=this.indices)==null||e.destroy();for(const t of Object.values(this.attributes))t.destroy()}getVertexCount(){return this.vertexCount}getAttributes(){return this.attributes}getIndexes(){return this.indices||null}_calculateVertexCount(e){return e.byteLength/12}}function VR(n,e){if(e instanceof Bh)return e;const t=WR(n,e),{attributes:i,bufferLayout:r}=HR(n,e);return new Bh({topology:e.topology||"triangle-list",bufferLayout:r,vertexCount:e.vertexCount,indices:t,attributes:i})}function WR(n,e){if(!e.indices)return;const t=e.indices.value;return n.createBuffer({usage:le.INDEX,data:t})}function HR(n,e){const t=[],i={};for(const[s,o]of Object.entries(e.attributes)){let a=s;switch(s){case"POSITION":a="positions";break;case"NORMAL":a="normals";break;case"TEXCOORD_0":a="texCoords";break;case"COLOR_0":a="colors";break}if(o){i[a]=n.createBuffer({data:o.value,id:`${s}-buffer`});const{value:l,size:c,normalized:u}=o;t.push({name:a,format:UC(l,c,u)})}}const r=e._calculateVertexCount(e.attributes,e.indices);return{attributes:i,bufferLayout:t,vertexCount:r}}const co=class co{constructor(e){m(this,"device");m(this,"destroyPolicy");m(this,"_hashCounter",0);m(this,"_hashes",{});m(this,"_renderPipelineCache",{});m(this,"_computePipelineCache",{});this.device=e,this.destroyPolicy=e.props._factoryDestroyPolicy}static getDefaultPipelineFactory(e){return e._lumaData.defaultPipelineFactory=e._lumaData.defaultPipelineFactory||new co(e),e._lumaData.defaultPipelineFactory}createRenderPipeline(e){const t={...Qn.defaultProps,...e},i=this._hashRenderPipeline(t);if(!this._renderPipelineCache[i]){const r=this.device.createRenderPipeline({...t,id:t.id?`${t.id}-cached`:void 0});r.hash=i,this._renderPipelineCache[i]={pipeline:r,useCount:0}}return this._renderPipelineCache[i].useCount++,this._renderPipelineCache[i].pipeline}createComputePipeline(e){const t={...Ms.defaultProps,...e},i=this._hashComputePipeline(t);if(!this._computePipelineCache[i]){const r=this.device.createComputePipeline({...t,id:t.id?`${t.id}-cached`:void 0});r.hash=i,this._computePipelineCache[i]={pipeline:r,useCount:0}}return this._computePipelineCache[i].useCount++,this._computePipelineCache[i].pipeline}release(e){const t=e.hash,i=e instanceof Ms?this._computePipelineCache:this._renderPipelineCache;i[t].useCount--,i[t].useCount===0&&this.destroyPolicy==="unused"&&(i[t].pipeline.destroy(),delete i[t])}_hashComputePipeline(e){return`${this._getHash(e.shader.source)}`}_hashRenderPipeline(e){const t=e.vs?this._getHash(e.vs.source):0,i=e.fs?this._getHash(e.fs.source):0,r="-",s=this._getHash(JSON.stringify(e.bufferLayout));switch(this.device.type){case"webgl":return`${t}/${i}V${r}BL${s}`;default:const o=this._getHash(JSON.stringify(e.parameters));return`${t}/${i}V${r}T${e.topology}P${o}BL${s}`}}_getHash(e){return this._hashes[e]===void 0&&(this._hashes[e]=this._hashCounter++),this._hashes[e]}};m(co,"defaultProps",{...Qn.defaultProps});let Il=co;const uo=class uo{constructor(e){m(this,"device");m(this,"destroyPolicy");m(this,"_cache",{});this.device=e,this.destroyPolicy=e.props._factoryDestroyPolicy}static getDefaultShaderFactory(e){var t;return(t=e._lumaData).defaultShaderFactory||(t.defaultShaderFactory=new uo(e)),e._lumaData.defaultShaderFactory}createShader(e){const t=this._hashShader(e);let i=this._cache[t];if(!i){const r=this.device.createShader({...e,id:e.id?`${e.id}-cached`:void 0});this._cache[t]=i={shader:r,useCount:0}}return i.useCount++,i.shader}release(e){const t=this._hashShader(e),i=this._cache[t];i&&(i.useCount--,i.useCount===0&&this.destroyPolicy==="unused"&&(delete this._cache[t],i.shader.destroy()))}_hashShader(e){return`${e.stage}:${e.source}`}};m(uo,"defaultProps",{...Is.defaultProps});let Rl=uo;function jR(n,e){var r;const t={},i="Values";if(n.attributes.length===0&&!((r=n.varyings)!=null&&r.length))return{"No attributes or varyings":{[i]:"N/A"}};for(const s of n.attributes)if(s){const o=`${s.location} ${s.name}: ${s.type}`;t[`in ${o}`]={[i]:s.stepMode||"vertex"}}for(const s of n.varyings||[]){const o=`${s.location} ${s.name}`;t[`out ${o}`]={[i]:JSON.stringify(s)}}return t}let Se=null,en=null;function XR(n,{id:e,minimap:t,opaque:i,top:r="0",left:s="0",rgbaScale:o=1}){Se||(Se=document.createElement("canvas"),Se.id=e,Se.title=e,Se.style.zIndex="100",Se.style.position="absolute",Se.style.top=r,Se.style.left=s,Se.style.border="blue 5px solid",Se.style.transform="scaleY(-1)",document.body.appendChild(Se),en=Se.getContext("2d")),(Se.width!==n.width||Se.height!==n.height)&&(Se.width=n.width/2,Se.height=n.height/2,Se.style.width="400px",Se.style.height="400px");const a=n.device.readPixelsToArrayWebGL(n),l=en==null?void 0:en.createImageData(n.width,n.height);if(l){for(let u=0;u<a.length;u+=4)l.data[0+u+0]=a[u+0]*o,l.data[0+u+1]=a[u+1]*o,l.data[0+u+2]=a[u+2]*o,l.data[0+u+3]=i?255:a[u+3]*o;en==null||en.putImageData(l,0,0)}}function Pl(n,e,t){if(n===e)return!0;if(!t||!n||!e)return!1;if(Array.isArray(n)){if(!Array.isArray(e)||n.length!==e.length)return!1;for(let i=0;i<n.length;i++)if(!Pl(n[i],e[i],t-1))return!1;return!0}if(Array.isArray(e))return!1;if(typeof n=="object"&&typeof e=="object"){const i=Object.keys(n),r=Object.keys(e);if(i.length!==r.length)return!1;for(const s of i)if(!e.hasOwnProperty(s)||!Pl(n[s],e[s],t-1))return!1;return!0}return!1}function YR(n){return ArrayBuffer.isView(n)&&!(n instanceof DataView)}function qR(n){return Array.isArray(n)?n.length===0||typeof n[0]=="number":!1}function e_(n){return YR(n)||qR(n)}function KR(n){return e_(n)||typeof n=="number"||typeof n=="boolean"}function t_(n){const e={bindings:{},uniforms:{}};return Object.keys(n).forEach(t=>{const i=n[t];KR(i)?e.uniforms[t]=i:e.bindings[t]=i}),e}class ZR{constructor(e,t){m(this,"options",{disableWarnings:!1});m(this,"modules");m(this,"moduleUniforms");m(this,"moduleBindings");Object.assign(this.options,t);const i=Dc(Object.values(e).filter(r=>r.dependencies));for(const r of i)e[r.name]=r;L.log(1,"Creating ShaderInputs with modules",Object.keys(e))(),this.modules=e,this.moduleUniforms={},this.moduleBindings={};for(const[r,s]of Object.entries(e))this._addModule(s),s.name&&r!==s.name&&!this.options.disableWarnings&&L.warn(`Module name: ${r} vs ${s.name}`)()}destroy(){}setProps(e){var t;for(const i of Object.keys(e)){const r=i,s=e[r]||{},o=this.modules[r];if(!o){this.options.disableWarnings||L.warn(`Module ${i} not found`)();continue}const a=this.moduleUniforms[r],l=this.moduleBindings[r],c=((t=o.getUniforms)==null?void 0:t.call(o,s,a))||s,{uniforms:u,bindings:d}=t_(c);this.moduleUniforms[r]={...a,...u},this.moduleBindings[r]={...l,...d}}}getModules(){return Object.values(this.modules)}getUniformValues(){return this.moduleUniforms}getBindingValues(){const e={};for(const t of Object.values(this.moduleBindings))Object.assign(e,t);return e}getDebugTable(){var t;const e={};for(const[i,r]of Object.entries(this.moduleUniforms))for(const[s,o]of Object.entries(r))e[`${i}.${s}`]={type:(t=this.modules[i].uniformTypes)==null?void 0:t[s],value:String(o)};return e}_addModule(e){const t=e.name;this.moduleUniforms[t]=e.defaultUniforms||{},this.moduleBindings[t]={}}}let GR="";async function QR(n,e){const t=new Image;return t.crossOrigin=(e==null?void 0:e.crossOrigin)||"anonymous",t.src=n.startsWith("http")?n:GR+n,await t.decode(),e?await createImageBitmap(t,e):await createImageBitmap(t)}class da{constructor(e,t){m(this,"device");m(this,"id");m(this,"texture");m(this,"sampler");m(this,"view");m(this,"ready");m(this,"isReady",!1);m(this,"destroyed",!1);m(this,"resolveReady",()=>{});m(this,"rejectReady",()=>{});this.device=e,this.id=t.id||Ao("async-texture"),typeof(t==null?void 0:t.data)=="string"&&t.dimension==="2d"&&(t={...t,data:QR(t.data)}),this.ready=new Promise((i,r)=>{this.resolveReady=()=>{this.isReady=!0,i()},this.rejectReady=r}),this.initAsync(t)}get[Symbol.toStringTag](){return"AsyncTexture"}toString(){return`AsyncTexture:"${this.id}"(${this.isReady?"ready":"loading"})`}async initAsync(e){const t=e.data;let i;try{i=await n_(t)}catch(s){this.rejectReady(s)}if(this.destroyed)return;const r={...e,data:i};this.texture=this.device.createTexture(r),this.sampler=this.texture.sampler,this.view=this.texture.view,this.isReady=!0,this.resolveReady()}destroy(){this.texture&&(this.texture.destroy(),this.texture=null),this.destroyed=!0}resize(e){if(!this.isReady)throw new Error("Cannot resize texture before it is ready");if(e.width===this.texture.width&&e.height===this.texture.height)return!1;if(this.texture){const t=this.texture;this.texture=t.clone(e),t.destroy()}return!0}}async function n_(n){if(n=await n,Array.isArray(n))return await Promise.all(n.map(n_));if(n&&typeof n=="object"&&n.constructor===Object){const e=n,t=await Promise.all(Object.values(e)),i=Object.keys(e),r={};for(let s=0;s<i.length;s++)r[i[s]]=t[s];return r}return n}const tn=2,JR=1e4,ho=class ho{constructor(e,t){m(this,"device");m(this,"id");m(this,"source");m(this,"vs");m(this,"fs");m(this,"pipelineFactory");m(this,"shaderFactory");m(this,"userData",{});m(this,"parameters");m(this,"topology");m(this,"bufferLayout");m(this,"isInstanced");m(this,"instanceCount",0);m(this,"vertexCount");m(this,"indexBuffer",null);m(this,"bufferAttributes",{});m(this,"constantAttributes",{});m(this,"bindings",{});m(this,"uniforms",{});m(this,"vertexArray");m(this,"transformFeedback",null);m(this,"pipeline");m(this,"shaderInputs");m(this,"_uniformStore");m(this,"_attributeInfos",{});m(this,"_gpuGeometry",null);m(this,"_getModuleUniforms");m(this,"props");m(this,"_pipelineNeedsUpdate","newly created");m(this,"_needsRedraw","initializing");m(this,"_destroyed",!1);m(this,"_lastDrawTimestamp",-1);m(this,"_lastLogTime",0);m(this,"_logOpen",!1);m(this,"_drawCount",0);var l,c,u,d;this.props={...ho.defaultProps,...t},t=this.props,this.id=t.id||Ao("model"),this.device=e,Object.assign(this.userData,t.userData);const i=Object.fromEntries(((l=this.props.modules)==null?void 0:l.map(h=>[h.name,h]))||[]),r=t.shaderInputs||new ZR(i,{disableWarnings:this.props.disableWarnings});this.setShaderInputs(r);const s=tP(e),o=(((c=this.props.modules)==null?void 0:c.length)>0?this.props.modules:(u=this.shaderInputs)==null?void 0:u.getModules())||[];if(this.device.type==="webgpu"&&this.props.source){const{source:h,getUniforms:f}=this.props.shaderAssembler.assembleWGSLShader({platformInfo:s,...this.props,modules:o});this.source=h,this._getModuleUniforms=f,(d=this.props).shaderLayout||(d.shaderLayout=m2(this.source))}else{const{vs:h,fs:f,getUniforms:p}=this.props.shaderAssembler.assembleGLSLShaderPair({platformInfo:s,...this.props,modules:o});this.vs=h,this.fs=f,this._getModuleUniforms=p}this.vertexCount=this.props.vertexCount,this.instanceCount=this.props.instanceCount,this.topology=this.props.topology,this.bufferLayout=this.props.bufferLayout,this.parameters=this.props.parameters,t.geometry&&this.setGeometry(t.geometry),this.pipelineFactory=t.pipelineFactory||Il.getDefaultPipelineFactory(this.device),this.shaderFactory=t.shaderFactory||Rl.getDefaultShaderFactory(this.device),this.pipeline=this._updatePipeline(),this.vertexArray=e.createVertexArray({renderPipeline:this.pipeline}),this._gpuGeometry&&this._setGeometryAttributes(this._gpuGeometry),"isInstanced"in t&&(this.isInstanced=t.isInstanced),t.instanceCount&&this.setInstanceCount(t.instanceCount),t.vertexCount&&this.setVertexCount(t.vertexCount),t.indexBuffer&&this.setIndexBuffer(t.indexBuffer),t.attributes&&this.setAttributes(t.attributes),t.constantAttributes&&this.setConstantAttributes(t.constantAttributes),t.bindings&&this.setBindings(t.bindings),t.uniforms&&this.setUniformsWebGL(t.uniforms),t.moduleSettings&&this.updateModuleSettingsWebGL(t.moduleSettings),t.transformFeedback&&(this.transformFeedback=t.transformFeedback),Object.seal(this)}get[Symbol.toStringTag](){return"Model"}toString(){return`Model(${this.id})`}destroy(){var e;this._destroyed||(this.pipelineFactory.release(this.pipeline),this.shaderFactory.release(this.pipeline.vs),this.pipeline.fs&&this.shaderFactory.release(this.pipeline.fs),this._uniformStore.destroy(),(e=this._gpuGeometry)==null||e.destroy(),this._destroyed=!0)}needsRedraw(){this._getBindingsUpdateTimestamp()>this._lastDrawTimestamp&&this.setNeedsRedraw("contents of bound textures or buffers updated");const e=this._needsRedraw;return this._needsRedraw=!1,e}setNeedsRedraw(e){this._needsRedraw||(this._needsRedraw=e)}predraw(){this.updateShaderInputs(),this.pipeline=this._updatePipeline()}draw(e){const t=this._areBindingsLoading();if(t)return L.info(tn,`>>> DRAWING ABORTED ${this.id}: ${t} not loaded`)(),!1;try{e.pushDebugGroup(`${this}.predraw(${e})`),this.predraw()}finally{e.popDebugGroup()}let i;try{e.pushDebugGroup(`${this}.draw(${e})`),this._logDrawCallStart(),this.pipeline=this._updatePipeline();const r=this._getBindings();this.pipeline.setBindings(r,{disableWarnings:this.props.disableWarnings}),Ml(this.uniforms)||this.pipeline.setUniformsWebGL(this.uniforms);const{indexBuffer:s}=this.vertexArray,o=s?s.byteLength/(s.indexType==="uint32"?4:2):void 0;i=this.pipeline.draw({renderPass:e,vertexArray:this.vertexArray,isInstanced:this.isInstanced,vertexCount:this.vertexCount,instanceCount:this.instanceCount,indexCount:o,transformFeedback:this.transformFeedback||void 0,parameters:this.parameters,topology:this.topology})}finally{e.popDebugGroup(),this._logDrawCallEnd()}return this._logFramebuffer(e),i?(this._lastDrawTimestamp=this.device.timestamp,this._needsRedraw=!1):this._needsRedraw="waiting for resource initialization",i}setGeometry(e){var i;(i=this._gpuGeometry)==null||i.destroy();const t=e&&VR(this.device,e);if(t){this.setTopology(t.topology||"triangle-list");const r=new Qo(this.bufferLayout);this.bufferLayout=r.mergeBufferLayouts(t.bufferLayout,this.bufferLayout),this.vertexArray&&this._setGeometryAttributes(t)}this._gpuGeometry=t}setTopology(e){e!==this.topology&&(this.topology=e,this._setPipelineNeedsUpdate("topology"))}setBufferLayout(e){const t=new Qo(this.bufferLayout);this.bufferLayout=this._gpuGeometry?t.mergeBufferLayouts(e,this._gpuGeometry.bufferLayout):e,this._setPipelineNeedsUpdate("bufferLayout"),this.pipeline=this._updatePipeline(),this.vertexArray=this.device.createVertexArray({renderPipeline:this.pipeline}),this._gpuGeometry&&this._setGeometryAttributes(this._gpuGeometry)}setParameters(e){Pl(e,this.parameters,2)||(this.parameters=e,this._setPipelineNeedsUpdate("parameters"))}setInstanceCount(e){this.instanceCount=e,this.isInstanced===void 0&&e>0&&(this.isInstanced=!0),this.setNeedsRedraw("instanceCount")}setVertexCount(e){this.vertexCount=e,this.setNeedsRedraw("vertexCount")}setShaderInputs(e){this.shaderInputs=e,this._uniformStore=new LC(this.shaderInputs.modules);for(const[t,i]of Object.entries(this.shaderInputs.modules))if(eP(i)){const r=this._uniformStore.getManagedUniformBuffer(this.device,t);this.bindings[`${t}Uniforms`]=r}this.setNeedsRedraw("shaderInputs")}updateShaderInputs(){this._uniformStore.setUniforms(this.shaderInputs.getUniformValues()),this.setBindings(this.shaderInputs.getBindingValues()),this.setNeedsRedraw("shaderInputs")}setBindings(e){Object.assign(this.bindings,e),this.setNeedsRedraw("bindings")}setTransformFeedback(e){this.transformFeedback=e,this.setNeedsRedraw("transformFeedback")}setIndexBuffer(e){this.vertexArray.setIndexBuffer(e),this.setNeedsRedraw("indexBuffer")}setAttributes(e,t){const i=(t==null?void 0:t.disableWarnings)??this.props.disableWarnings;e.indices&&L.warn(`Model:${this.id} setAttributes() - indexBuffer should be set using setIndexBuffer()`)(),this.bufferLayout=$C(this.pipeline.shaderLayout,this.bufferLayout);const r=new Qo(this.bufferLayout);for(const[s,o]of Object.entries(e)){const a=r.getBufferLayout(s);if(!a){i||L.warn(`Model(${this.id}): Missing layout for buffer "${s}".`)();continue}const l=r.getAttributeNamesForBuffer(a);let c=!1;for(const u of l){const d=this._attributeInfos[u];if(d){const h=this.device.type==="webgpu"?r.getBufferIndex(d.bufferName):d.location;this.vertexArray.setBuffer(h,o),c=!0}}!c&&!i&&L.warn(`Model(${this.id}): Ignoring buffer "${o.id}" for unknown attribute "${s}"`)()}this.setNeedsRedraw("attributes")}setConstantAttributes(e,t){for(const[i,r]of Object.entries(e)){const s=this._attributeInfos[i];s?this.vertexArray.setConstantWebGL(s.location,r):((t==null?void 0:t.disableWarnings)??this.props.disableWarnings)||L.warn(`Model "${this.id}: Ignoring constant supplied for unknown attribute "${i}"`)()}this.setNeedsRedraw("constants")}setUniforms(e){this.setUniformsWebGL(e)}setUniformsWebGL(e){Ml(e)||(this.pipeline.setUniformsWebGL(e),Object.assign(this.uniforms,e)),this.setNeedsRedraw("uniforms")}updateModuleSettingsWebGL(e){const{bindings:t,uniforms:i}=t_(this._getModuleUniforms(e));Object.assign(this.bindings,t),Object.assign(this.uniforms,i),this.setNeedsRedraw("moduleSettings")}_areBindingsLoading(){for(const e of Object.values(this.bindings))if(e instanceof da&&!e.isReady)return e.id;return!1}_getBindings(){const e={};for(const[t,i]of Object.entries(this.bindings))i instanceof da?i.isReady&&(e[t]=i.texture):e[t]=i;return e}_getBindingsUpdateTimestamp(){let e=0;for(const t of Object.values(this.bindings))t instanceof Cs?e=Math.max(e,t.texture.updateTimestamp):t instanceof le||t instanceof fe?e=Math.max(e,t.updateTimestamp):t instanceof da?e=t.texture?Math.max(e,t.texture.updateTimestamp):1/0:t instanceof Rs||(e=Math.max(e,t.buffer.updateTimestamp));return e}_setGeometryAttributes(e){const t={...e.attributes};for(const[i]of Object.entries(t))!this.pipeline.shaderLayout.attributes.find(r=>r.name===i)&&i!=="positions"&&delete t[i];this.vertexCount=e.vertexCount,this.setIndexBuffer(e.indices||null),this.setAttributes(e.attributes,{disableWarnings:!0}),this.setAttributes(t,{disableWarnings:this.props.disableWarnings}),this.setNeedsRedraw("geometry attributes")}_setPipelineNeedsUpdate(e){this._pipelineNeedsUpdate||(this._pipelineNeedsUpdate=e),this.setNeedsRedraw(e)}_updatePipeline(){if(this._pipelineNeedsUpdate){let e=null,t=null;this.pipeline&&(L.log(1,`Model ${this.id}: Recreating pipeline because "${this._pipelineNeedsUpdate}".`)(),e=this.pipeline.vs,t=this.pipeline.fs),this._pipelineNeedsUpdate=!1;const i=this.shaderFactory.createShader({id:`${this.id}-vertex`,stage:"vertex",source:this.source||this.vs,debugShaders:this.props.debugShaders});let r=null;this.source?r=i:this.fs&&(r=this.shaderFactory.createShader({id:`${this.id}-fragment`,stage:"fragment",source:this.source||this.fs,debugShaders:this.props.debugShaders})),this.pipeline=this.pipelineFactory.createRenderPipeline({...this.props,bufferLayout:this.bufferLayout,topology:this.topology,parameters:this.parameters,bindings:this._getBindings(),vs:i,fs:r}),this._attributeInfos=tm(this.pipeline.shaderLayout,this.bufferLayout),e&&this.shaderFactory.release(e),t&&this.shaderFactory.release(t)}return this.pipeline}_logDrawCallStart(){const e=L.level>3?0:JR;L.level<2||Date.now()-this._lastLogTime<e||(this._lastLogTime=Date.now(),this._logOpen=!0,L.group(tn,`>>> DRAWING MODEL ${this.id}`,{collapsed:L.level<=2})())}_logDrawCallEnd(){if(this._logOpen){const e=jR(this.pipeline.shaderLayout,this.id);L.table(tn,e)();const t=this.shaderInputs.getDebugTable();for(const[r,s]of Object.entries(this.uniforms))t[r]={value:s};L.table(tn,t)();const i=this._getAttributeDebugTable();L.table(tn,this._attributeInfos)(),L.table(tn,i)(),L.groupEnd(tn)(),this._logOpen=!1}}_logFramebuffer(e){const t=this.device.props.debugFramebuffers;if(this._drawCount++,!t)return;const i=e.props.framebuffer;i&&XR(i,{id:i.id,minimap:!0})}_getAttributeDebugTable(){const e={};for(const[t,i]of Object.entries(this._attributeInfos)){const r=this.vertexArray.attributes[i.location];e[i.location]={name:t,type:i.shaderType,values:r?this._getBufferOrConstantValues(r,i.bufferDataType):"null"}}if(this.vertexArray.indexBuffer){const{indexBuffer:t}=this.vertexArray,i=t.indexType==="uint32"?new Uint32Array(t.debugData):new Uint16Array(t.debugData);e.indices={name:"indices",type:t.indexType,values:i.toString()}}return e}_getBufferOrConstantValues(e,t){const i=rm(t);return(e instanceof le?new i(e.debugData):e).toString()}};m(ho,"defaultProps",{...Qn.defaultProps,source:void 0,vs:null,fs:null,id:"unnamed",handle:void 0,userData:{},defines:{},modules:[],moduleSettings:void 0,geometry:null,indexBuffer:null,attributes:{},constantAttributes:{},varyings:[],isInstanced:void 0,instanceCount:0,vertexCount:0,shaderInputs:void 0,pipelineFactory:void 0,shaderFactory:void 0,transformFeedback:void 0,shaderAssembler:As.getDefaultShaderAssembler(),debugShaders:void 0,disableWarnings:void 0});let Qt=ho;function eP(n){return!!(n.uniformTypes&&!Ml(n.uniformTypes))}function tP(n){return{type:n.type,shaderLanguage:n.info.shadingLanguage,shaderLanguageVersion:n.info.shadingLanguageVersion,gpu:n.info.gpu,features:n.features}}function Ml(n){for(const e in n)return!1;return!0}const zi=class zi{constructor(e,t=zi.defaultProps){m(this,"device");m(this,"model");m(this,"transformFeedback");if(!zi.isSupported(e))throw new Error("BufferTransform not yet implemented on WebGPU");this.device=e,this.model=new Qt(this.device,{id:t.id||"buffer-transform-model",fs:t.fs||zA(),topology:t.topology||"point-list",varyings:t.outputs||t.varyings,...t}),this.transformFeedback=this.device.createTransformFeedback({layout:this.model.pipeline.shaderLayout,buffers:t.feedbackBuffers}),this.model.setTransformFeedback(this.transformFeedback),Object.seal(this)}static isSupported(e){var t;return((t=e==null?void 0:e.info)==null?void 0:t.type)==="webgl"}destroy(){this.model&&this.model.destroy()}delete(){this.destroy()}run(e){e!=null&&e.inputBuffers&&this.model.setAttributes(e.inputBuffers),e!=null&&e.outputBuffers&&this.transformFeedback.setBuffers(e.outputBuffers);const t=this.device.beginRenderPass(e);this.model.draw(t),t.end()}getBuffer(e){return this.transformFeedback.getBuffer(e)}readAsync(e){const t=this.getBuffer(e);if(!t)throw new Error("BufferTransform#getBuffer");if(t instanceof le)return t.readAsync();const{buffer:i,byteOffset:r=0,byteLength:s=i.byteLength}=t;return i.readAsync(r,s)}};m(zi,"defaultProps",{...Qt.defaultProps,outputs:void 0,feedbackBuffers:void 0});let Zi=zi;class Co{constructor(e){m(this,"id");m(this,"topology");m(this,"vertexCount");m(this,"indices");m(this,"attributes");m(this,"userData",{});const{attributes:t={},indices:i=null,vertexCount:r=null}=e;this.id=e.id||Ao("geometry"),this.topology=e.topology,i&&(this.indices=ArrayBuffer.isView(i)?{value:i,size:1}:i),this.attributes={};for(const[s,o]of Object.entries(t)){const a=ArrayBuffer.isView(o)?{value:o}:o;if(!ArrayBuffer.isView(a.value))throw new Error(`${this._print(s)}: must be typed array or object with value as typed array`);if((s==="POSITION"||s==="positions")&&!a.size&&(a.size=3),s==="indices"){if(this.indices)throw new Error("Multiple indices detected");this.indices=a}else this.attributes[s]=a}this.indices&&this.indices.isIndexed!==void 0&&(this.indices=Object.assign({},this.indices),delete this.indices.isIndexed),this.vertexCount=r||this._calculateVertexCount(this.attributes,this.indices)}getVertexCount(){return this.vertexCount}getAttributes(){return this.indices?{indices:this.indices,...this.attributes}:this.attributes}_print(e){return`Geometry ${this.id} attribute ${e}`}_setAttributes(e,t){return this}_calculateVertexCount(e,t){if(t)return t.value.length;let i=1/0;for(const r of Object.values(e)){const{value:s,size:o,constant:a}=r;!a&&s&&o!==void 0&&o>=1&&(i=Math.min(i,s.length/o))}return i}}const nP={blendColorOperation:"add",blendColorSrcFactor:"one",blendColorDstFactor:"zero",blendAlphaOperation:"add",blendAlphaSrcFactor:"constant-alpha",blendAlphaDstFactor:"zero"};class i_ extends Gc{constructor(){super(...arguments),this._colorEncoderState=null}render(e){return"pickingFBO"in e?this._drawPickingBuffer(e):super.render(e)}_drawPickingBuffer({layers:e,layerFilter:t,views:i,viewports:r,onViewportActive:s,pickingFBO:o,deviceRect:{x:a,y:l,width:c,height:u},cullRect:d,effects:h,pass:f="picking",pickZ:p,shaderModuleProps:g}){this.pickZ=p;const _=this._resetColorEncoder(p),b=[a,l,c,u],w=super.render({target:o,layers:e,layerFilter:t,views:i,viewports:r,onViewportActive:s,cullRect:d,effects:h==null?void 0:h.filter(y=>y.useInPicking),pass:f,isPicking:!0,shaderModuleProps:g,clearColor:[0,0,0,0],colorMask:15,scissorRect:b});return this._colorEncoderState=null,{decodePickingColor:_&&rP.bind(null,_),stats:w}}shouldDrawLayer(e){const{pickable:t,operation:i}=e.props;return t&&i.includes("draw")||i.includes("terrain")||i.includes("mask")}getShaderModuleProps(e,t,i){return{picking:{isActive:1,isAttribute:this.pickZ},lighting:{enabled:!1}}}getLayerParameters(e,t,i){const r={...e.props.parameters},{pickable:s,operation:o}=e.props;return!this._colorEncoderState||o.includes("terrain")?r.blend=!1:s&&o.includes("draw")&&(Object.assign(r,nP),r.blend=!0,r.blendColor=iP(this._colorEncoderState,e,i)),r}_resetColorEncoder(e){return this._colorEncoderState=e?null:{byLayer:new Map,byAlpha:[]},this._colorEncoderState}}function iP(n,e,t){const{byLayer:i,byAlpha:r}=n;let s,o=i.get(e);return o?(o.viewports.push(t),s=o.a):(s=i.size+1,s<=255?(o={a:s,layer:e,viewports:[t]},i.set(e,o),r[s]=o):(Q.warn("Too many pickable layers, only picking the first 255")(),s=0)),[0,0,0,s/255]}function rP(n,e){const t=n.byAlpha[e[3]];return t&&{pickedLayer:t.layer,pickedViewports:t.viewports,pickedObjectIndex:t.layer.decodePickingColor(e)}}const Dn={NO_STATE:"Awaiting state",MATCHED:"Matched. State transferred from previous layer",INITIALIZED:"Initialized",AWAITING_GC:"Discarded. Awaiting garbage collection",AWAITING_FINALIZATION:"No longer matched. Awaiting garbage collection",FINALIZED:"Finalized! Awaiting garbage collection"},js=Symbol.for("component"),Zt=Symbol.for("propTypes"),ha=Symbol.for("deprecatedProps"),Yn=Symbol.for("asyncPropDefaults"),vn=Symbol.for("asyncPropOriginal"),Xt=Symbol.for("asyncPropResolved");function Qc(n,e=()=>!0){return Array.isArray(n)?r_(n,e,[]):e(n)?[n]:[]}function r_(n,e,t){let i=-1;for(;++i<n.length;){const r=n[i];Array.isArray(r)?r_(r,e,t):e(r)&&t.push(r)}return t}function sP({target:n,source:e,start:t=0,count:i=1}){const r=e.length,s=i*r;let o=0;for(let a=t;o<r;o++)n[a++]=e[o];for(;o<s;)o<s-o?(n.copyWithin(t+o,t,t+o),o*=2):(n.copyWithin(t+o,t,t+s-o),o=s);return n}class oP{constructor(e,t,i){this._loadCount=0,this._subscribers=new Set,this.id=e,this.context=i,this.setData(t)}subscribe(e){this._subscribers.add(e)}unsubscribe(e){this._subscribers.delete(e)}inUse(){return this._subscribers.size>0}delete(){}getData(){return this.isLoaded?this._error?Promise.reject(this._error):this._content:this._loader.then(()=>this.getData())}setData(e,t){if(e===this._data&&!t)return;this._data=e;const i=++this._loadCount;let r=e;typeof e=="string"&&(r=Ts(e)),r instanceof Promise?(this.isLoaded=!1,this._loader=r.then(s=>{this._loadCount===i&&(this.isLoaded=!0,this._error=void 0,this._content=s)}).catch(s=>{this._loadCount===i&&(this.isLoaded=!0,this._error=s||!0)})):(this.isLoaded=!0,this._error=void 0,this._content=e);for(const s of this._subscribers)s.onChange(this.getData())}}class aP{constructor(e){var t;this.protocol=e.protocol||"resource://",this._context={device:e.device,gl:(t=e.device)==null?void 0:t.gl,resourceManager:this},this._resources={},this._consumers={},this._pruneRequest=null}contains(e){return e.startsWith(this.protocol)?!0:e in this._resources}add({resourceId:e,data:t,forceUpdate:i=!1,persistent:r=!0}){let s=this._resources[e];s?s.setData(t,i):(s=new oP(e,t,this._context),this._resources[e]=s),s.persistent=r}remove(e){const t=this._resources[e];t&&(t.delete(),delete this._resources[e])}unsubscribe({consumerId:e}){const t=this._consumers[e];if(t){for(const i in t){const r=t[i],s=this._resources[r.resourceId];s&&s.unsubscribe(r)}delete this._consumers[e],this.prune()}}subscribe({resourceId:e,onChange:t,consumerId:i,requestId:r="default"}){const{_resources:s,protocol:o}=this;e.startsWith(o)&&(e=e.replace(o,""),s[e]||this.add({resourceId:e,data:null,persistent:!1}));const a=s[e];if(this._track(i,r,a,t),a)return a.getData()}prune(){this._pruneRequest||(this._pruneRequest=setTimeout(()=>this._prune(),0))}finalize(){for(const e in this._resources)this._resources[e].delete()}_track(e,t,i,r){const s=this._consumers,o=s[e]=s[e]||{};let a=o[t];const l=a&&a.resourceId&&this._resources[a.resourceId];l&&(l.unsubscribe(a),this.prune()),i&&(a?(a.onChange=r,a.resourceId=i.id):a={onChange:r,resourceId:i.id},o[t]=a,i.subscribe(a))}_prune(){this._pruneRequest=null;for(const e of Object.keys(this._resources)){const t=this._resources[e];!t.persistent&&!t.inUse()&&(t.delete(),delete this._resources[e])}}}const lP="layerManager.setLayers",cP="layerManager.activateViewport";let uP=class{constructor(e,t){var a;this._lastRenderedLayers=[],this._needsRedraw=!1,this._needsUpdate=!1,this._nextLayers=null,this._debug=!1,this._defaultShaderModulesChanged=!1,this.activateViewport=l=>{De(cP,this,l),l&&(this.context.viewport=l)};const{deck:i,stats:r,viewport:s,timeline:o}=t||{};this.layers=[],this.resourceManager=new aP({device:e,protocol:"deck://"}),this.context={mousePosition:null,userData:{},layerManager:this,device:e,gl:e==null?void 0:e.gl,deck:i,shaderAssembler:cR(((a=e==null?void 0:e.info)==null?void 0:a.shadingLanguage)||"glsl"),defaultShaderModules:[b3],renderPass:void 0,stats:r||new yo({id:"deck.gl"}),viewport:s||new Eo({id:"DEFAULT-INITIAL-VIEWPORT"}),timeline:o||new Jm,resourceManager:this.resourceManager,onError:void 0},Object.seal(this)}finalize(){this.resourceManager.finalize();for(const e of this.layers)this._finalizeLayer(e)}needsRedraw(e={clearRedrawFlags:!1}){let t=this._needsRedraw;e.clearRedrawFlags&&(this._needsRedraw=!1);for(const i of this.layers){const r=i.getNeedsRedraw(e);t=t||r}return t}needsUpdate(){return this._nextLayers&&this._nextLayers!==this._lastRenderedLayers?"layers changed":this._defaultShaderModulesChanged?"shader modules changed":this._needsUpdate}setNeedsRedraw(e){this._needsRedraw=this._needsRedraw||e}setNeedsUpdate(e){this._needsUpdate=this._needsUpdate||e}getLayers({layerIds:e}={}){return e?this.layers.filter(t=>e.find(i=>t.id.indexOf(i)===0)):this.layers}setProps(e){"debug"in e&&(this._debug=e.debug),"userData"in e&&(this.context.userData=e.userData),"layers"in e&&(this._nextLayers=e.layers),"onError"in e&&(this.context.onError=e.onError)}setLayers(e,t){De(lP,this,t,e),this._lastRenderedLayers=e;const i=Qc(e,Boolean);for(const r of i)r.context=this.context;this._updateLayers(this.layers,i)}updateLayers(){const e=this.needsUpdate();e&&(this.setNeedsRedraw(`updating layers: ${e}`),this.setLayers(this._nextLayers||this._lastRenderedLayers,e)),this._nextLayers=null}addDefaultShaderModule(e){const{defaultShaderModules:t}=this.context;t.find(i=>i.name===e.name)||(t.push(e),this._defaultShaderModulesChanged=!0)}removeDefaultShaderModule(e){const{defaultShaderModules:t}=this.context,i=t.findIndex(r=>r.name===e.name);i>=0&&(t.splice(i,1),this._defaultShaderModulesChanged=!0)}_handleError(e,t,i){i.raiseError(t,`${e} of ${i}`)}_updateLayers(e,t){const i={};for(const o of e)i[o.id]?Q.warn(`Multiple old layers with same id ${o.id}`)():i[o.id]=o;if(this._defaultShaderModulesChanged){for(const o of e)o.setNeedsUpdate(),o.setChangeFlags({extensionsChanged:!0});this._defaultShaderModulesChanged=!1}const r=[];this._updateSublayersRecursively(t,i,r),this._finalizeOldLayers(i);let s=!1;for(const o of r)if(o.hasUniformTransition()){s=`Uniform transition in ${o}`;break}this._needsUpdate=s,this.layers=r}_updateSublayersRecursively(e,t,i){for(const r of e){r.context=this.context;const s=t[r.id];s===null&&Q.warn(`Multiple new layers with same id ${r.id}`)(),t[r.id]=null;let o=null;try{this._debug&&s!==r&&r.validateProps(),s?(this._transferLayerState(s,r),this._updateLayer(r)):this._initializeLayer(r),i.push(r),o=r.isComposite?r.getSubLayers():null}catch(a){this._handleError("matching",a,r)}o&&this._updateSublayersRecursively(o,t,i)}}_finalizeOldLayers(e){for(const t in e){const i=e[t];i&&this._finalizeLayer(i)}}_initializeLayer(e){try{e._initialize(),e.lifecycle=Dn.INITIALIZED}catch(t){this._handleError("initialization",t,e)}}_transferLayerState(e,t){t._transferState(e),t.lifecycle=Dn.MATCHED,t!==e&&(e.lifecycle=Dn.AWAITING_GC)}_updateLayer(e){try{e._update()}catch(t){this._handleError("update",t,e)}}_finalizeLayer(e){this._needsRedraw=this._needsRedraw||`finalized ${e}`,e.lifecycle=Dn.AWAITING_FINALIZATION;try{e._finalize(),e.lifecycle=Dn.FINALIZED}catch(t){this._handleError("finalization",t,e)}}};function dt(n,e,t){if(n===e)return!0;if(!t||!n||!e)return!1;if(Array.isArray(n)){if(!Array.isArray(e)||n.length!==e.length)return!1;for(let i=0;i<n.length;i++)if(!dt(n[i],e[i],t-1))return!1;return!0}if(Array.isArray(e))return!1;if(typeof n=="object"&&typeof e=="object"){const i=Object.keys(n),r=Object.keys(e);if(i.length!==r.length)return!1;for(const s of i)if(!e.hasOwnProperty(s)||!dt(n[s],e[s],t-1))return!1;return!0}return!1}class dP{constructor(e){this.views=[],this.width=100,this.height=100,this.viewState={},this.controllers={},this.timeline=e.timeline,this._viewports=[],this._viewportMap={},this._isUpdating=!1,this._needsRedraw="First render",this._needsUpdate="Initialize",this._eventManager=e.eventManager,this._eventCallbacks={onViewStateChange:e.onViewStateChange,onInteractionStateChange:e.onInteractionStateChange},Object.seal(this),this.setProps(e)}finalize(){for(const e in this.controllers){const t=this.controllers[e];t&&t.finalize()}this.controllers={}}needsRedraw(e={clearRedrawFlags:!1}){const t=this._needsRedraw;return e.clearRedrawFlags&&(this._needsRedraw=!1),t}setNeedsUpdate(e){this._needsUpdate=this._needsUpdate||e,this._needsRedraw=this._needsRedraw||e}updateViewStates(){for(const e in this.controllers){const t=this.controllers[e];t&&t.updateTransition()}}getViewports(e){return e?this._viewports.filter(t=>t.containsPixel(e)):this._viewports}getViews(){const e={};return this.views.forEach(t=>{e[t.id]=t}),e}getView(e){return this.views.find(t=>t.id===e)}getViewState(e){const t=typeof e=="string"?this.getView(e):e,i=t&&this.viewState[t.getViewStateId()]||this.viewState;return t?t.filterViewState(i):i}getViewport(e){return this._viewportMap[e]}unproject(e,t){const i=this.getViewports(),r={x:e[0],y:e[1]};for(let s=i.length-1;s>=0;--s){const o=i[s];if(o.containsPixel(r)){const a=e.slice();return a[0]-=o.x,a[1]-=o.y,o.unproject(a,t)}}return null}setProps(e){e.views&&this._setViews(e.views),e.viewState&&this._setViewState(e.viewState),("width"in e||"height"in e)&&this._setSize(e.width,e.height),this._isUpdating||this._update()}_update(){this._isUpdating=!0,this._needsUpdate&&(this._needsUpdate=!1,this._rebuildViewports()),this._needsUpdate&&(this._needsUpdate=!1,this._rebuildViewports()),this._isUpdating=!1}_setSize(e,t){(e!==this.width||t!==this.height)&&(this.width=e,this.height=t,this.setNeedsUpdate("Size changed"))}_setViews(e){e=Qc(e,Boolean),this._diffViews(e,this.views)&&this.setNeedsUpdate("views changed"),this.views=e}_setViewState(e){e?(!dt(e,this.viewState,3)&&this.setNeedsUpdate("viewState changed"),this.viewState=e):Q.warn("missing `viewState` or `initialViewState`")()}_createController(e,t){const i=t.type;return new i({timeline:this.timeline,eventManager:this._eventManager,onViewStateChange:this._eventCallbacks.onViewStateChange,onStateChange:this._eventCallbacks.onInteractionStateChange,makeViewport:s=>{var o;return(o=this.getView(e.id))==null?void 0:o.makeViewport({viewState:s,width:this.width,height:this.height})}})}_updateController(e,t,i,r){const s=e.controller;if(s&&i){const o={...t,...s,id:e.id,x:i.x,y:i.y,width:i.width,height:i.height};return(!r||r.constructor!==s.type)&&(r=this._createController(e,o)),r&&r.setProps(o),r}return null}_rebuildViewports(){const{views:e}=this,t=this.controllers;this._viewports=[],this.controllers={};let i=!1;for(let r=e.length;r--;){const s=e[r],o=this.getViewState(s),a=s.makeViewport({viewState:o,width:this.width,height:this.height});let l=t[s.id];const c=!!s.controller;c&&!l&&(i=!0),(i||!c)&&l&&(l.finalize(),l=null),this.controllers[s.id]=this._updateController(s,o,a,l),a&&this._viewports.unshift(a)}for(const r in t){const s=t[r];s&&!this.controllers[r]&&s.finalize()}this._buildViewportMap()}_buildViewportMap(){this._viewportMap={},this._viewports.forEach(e=>{e.id&&(this._viewportMap[e.id]=this._viewportMap[e.id]||e)})}_diffViews(e,t){return e.length!==t.length?!0:e.some((i,r)=>!e[r].equals(t[r]))}}const hP=/([0-9]+\.?[0-9]*)(%|px)/;function Lt(n){switch(typeof n){case"number":return{position:n,relative:!1};case"string":const e=hP.exec(n);if(e&&e.length>=3){const t=e[2]==="%",i=parseFloat(e[1]);return{position:t?i/100:i,relative:t}}default:throw new Error(`Could not parse position string ${n}`)}}function Ut(n,e){return n.relative?Math.round(n.position*e):n.position}class Jc{constructor(e){const{id:t,x:i=0,y:r=0,width:s="100%",height:o="100%",padding:a=null}=e;this.id=t||this.constructor.displayName||"view",this.props={...e,id:this.id},this._x=Lt(i),this._y=Lt(r),this._width=Lt(s),this._height=Lt(o),this._padding=a&&{left:Lt(a.left||0),right:Lt(a.right||0),top:Lt(a.top||0),bottom:Lt(a.bottom||0)},this.equals=this.equals.bind(this),Object.seal(this)}equals(e){return this===e?!0:this.constructor===e.constructor&&dt(this.props,e.props,2)}makeViewport({width:e,height:t,viewState:i}){i=this.filterViewState(i);const r=this.getDimensions({width:e,height:t});if(!r.height||!r.width)return null;const s=this.getViewportType(i);return new s({...i,...this.props,...r})}getViewStateId(){const{viewState:e}=this.props;return typeof e=="string"?e:(e==null?void 0:e.id)||this.id}filterViewState(e){if(this.props.viewState&&typeof this.props.viewState=="object"){if(!this.props.viewState.id)return this.props.viewState;const t={...e};for(const i in this.props.viewState)i!=="id"&&(t[i]=this.props.viewState[i]);return t}return e}getDimensions({width:e,height:t}){const i={x:Ut(this._x,e),y:Ut(this._y,t),width:Ut(this._width,e),height:Ut(this._height,t)};return this._padding&&(i.padding={left:Ut(this._padding.left,e),top:Ut(this._padding.top,t),right:Ut(this._padding.right,e),bottom:Ut(this._padding.bottom,t)}),i}get controller(){const e=this.props.controller;return e?e===!0?{type:this.ControllerType}:typeof e=="function"?{type:e}:{type:this.ControllerType,...e}:null}}class Io{constructor(e){this._inProgress=!1,this._handle=null,this.time=0,this.settings={duration:0},this._timeline=e}get inProgress(){return this._inProgress}start(e){var t,i;this.cancel(),this.settings=e,this._inProgress=!0,(i=(t=this.settings).onStart)==null||i.call(t,this)}end(){var e,t;this._inProgress&&(this._timeline.removeChannel(this._handle),this._handle=null,this._inProgress=!1,(t=(e=this.settings).onEnd)==null||t.call(e,this))}cancel(){var e,t;this._inProgress&&((t=(e=this.settings).onInterrupt)==null||t.call(e,this),this._timeline.removeChannel(this._handle),this._handle=null,this._inProgress=!1)}update(){var e,t;if(!this._inProgress)return!1;if(this._handle===null){const{_timeline:i,settings:r}=this;this._handle=i.addChannel({delay:i.getTime(),duration:r.duration})}return this.time=this._timeline.getTime(this._handle),this._onUpdate(),(t=(e=this.settings).onUpdate)==null||t.call(e,this),this._timeline.isFinished(this._handle)&&this.end(),!0}_onUpdate(){}}const Lh=()=>{},kl={BREAK:1,SNAP_TO_END:2,IGNORE:3},fP=n=>n,pP=kl.BREAK;class gP{constructor(e){this._onTransitionUpdate=t=>{const{time:i,settings:{interpolator:r,startProps:s,endProps:o,duration:a,easing:l}}=t,c=l(i/a),u=r.interpolateProps(s,o,c);this.propsInTransition=this.getControllerState({...this.props,...u}).getViewportProps(),this.onViewStateChange({viewState:this.propsInTransition,oldViewState:this.props})},this.getControllerState=e.getControllerState,this.propsInTransition=null,this.transition=new Io(e.timeline),this.onViewStateChange=e.onViewStateChange||Lh,this.onStateChange=e.onStateChange||Lh}finalize(){this.transition.cancel()}getViewportInTransition(){return this.propsInTransition}processViewStateChange(e){let t=!1;const i=this.props;if(this.props=e,!i||this._shouldIgnoreViewportChange(i,e))return!1;if(this._isTransitionEnabled(e)){let r=i;if(this.transition.inProgress){const{interruption:s,endProps:o}=this.transition.settings;r={...i,...s===kl.SNAP_TO_END?o:this.propsInTransition||i}}this._triggerTransition(r,e),t=!0}else this.transition.cancel();return t}updateTransition(){this.transition.update()}_isTransitionEnabled(e){const{transitionDuration:t,transitionInterpolator:i}=e;return(t>0||t==="auto")&&!!i}_isUpdateDueToCurrentTransition(e){return this.transition.inProgress&&this.propsInTransition?this.transition.settings.interpolator.arePropsEqual(e,this.propsInTransition):!1}_shouldIgnoreViewportChange(e,t){return this.transition.inProgress?this.transition.settings.interruption===kl.IGNORE||this._isUpdateDueToCurrentTransition(t):this._isTransitionEnabled(t)?t.transitionInterpolator.arePropsEqual(e,t):!0}_triggerTransition(e,t){const i=this.getControllerState(e),r=this.getControllerState(t).shortestPathFrom(i),s=t.transitionInterpolator,o=s.getDuration?s.getDuration(e,t):t.transitionDuration;if(o===0)return;const a=s.initializeProps(e,r);this.propsInTransition={};const l={duration:o,easing:t.transitionEasing||fP,interpolator:s,interruption:t.transitionInterruption||pP,startProps:a.start,endProps:a.end,onStart:t.onTransitionStart,onUpdate:this._onTransitionUpdate,onInterrupt:this._onTransitionEnd(t.onTransitionInterrupt),onEnd:this._onTransitionEnd(t.onTransitionEnd)};this.transition.start(l),this.onStateChange({inTransition:!0}),this.updateTransition()}_onTransitionEnd(e){return t=>{this.propsInTransition=null,this.onStateChange({inTransition:!1,isZooming:!1,isPanning:!1,isRotating:!1}),e==null||e(t)}}}function Me(n,e){if(!n)throw new Error(e||"deck.gl: assertion failed.")}class mP{constructor(e){const{compare:t,extract:i,required:r}=e;this._propsToCompare=t,this._propsToExtract=i||t,this._requiredProps=r}arePropsEqual(e,t){for(const i of this._propsToCompare)if(!(i in e)||!(i in t)||!qi(e[i],t[i]))return!1;return!0}initializeProps(e,t){const i={},r={};for(const s of this._propsToExtract)(s in e||s in t)&&(i[s]=e[s],r[s]=t[s]);return this._checkRequiredProps(i),this._checkRequiredProps(r),{start:i,end:r}}getDuration(e,t){return t.transitionDuration}_checkRequiredProps(e){this._requiredProps&&this._requiredProps.forEach(t=>{const i=e[t];Me(Number.isFinite(i)||Array.isArray(i),`${t} is required for transition`)})}}const _P=["longitude","latitude","zoom","bearing","pitch"],yP=["longitude","latitude","zoom"];class si extends mP{constructor(e={}){const t=Array.isArray(e)?e:e.transitionProps,i=Array.isArray(e)?{}:e;i.transitionProps=Array.isArray(t)?{compare:t,required:t}:t||{compare:_P,required:yP},super(i.transitionProps),this.opts=i}initializeProps(e,t){const i=super.initializeProps(e,t),{makeViewport:r,around:s}=this.opts;if(r&&s){const o=r(e),a=r(t),l=o.unproject(s);i.start.around=s,Object.assign(i.end,{around:a.project(l),aroundPosition:l,width:t.width,height:t.height})}return i}interpolateProps(e,t,i){const r={};for(const s of this._propsToExtract)r[s]=Ls(e[s]||0,t[s]||0,i);if(t.aroundPosition&&this.opts.makeViewport){const s=this.opts.makeViewport({...t,...r});Object.assign(r,s.panByPosition(t.aroundPosition,Ls(e.around,t.around,i)))}return r}}const $t={transitionDuration:0},bP=300,Fr=n=>1-(1-n)*(1-n),On={WHEEL:["wheel"],PAN:["panstart","panmove","panend"],PINCH:["pinchstart","pinchmove","pinchend"],MULTI_PAN:["multipanstart","multipanmove","multipanend"],DOUBLE_CLICK:["dblclick"],KEYBOARD:["keydown"]},nn={};class eu{constructor(e){this.state={},this._events={},this._interactionState={isDragging:!1},this._customEvents=[],this._eventStartBlocked=null,this._panMove=!1,this.invertPan=!1,this.dragMode="rotate",this.inertia=0,this.scrollZoom=!0,this.dragPan=!0,this.dragRotate=!0,this.doubleClickZoom=!0,this.touchZoom=!0,this.touchRotate=!1,this.keyboard=!0,this.transitionManager=new gP({...e,getControllerState:t=>new this.ControllerState(t),onViewStateChange:this._onTransition.bind(this),onStateChange:this._setInteractionState.bind(this)}),this.handleEvent=this.handleEvent.bind(this),this.eventManager=e.eventManager,this.onViewStateChange=e.onViewStateChange||(()=>{}),this.onStateChange=e.onStateChange||(()=>{}),this.makeViewport=e.makeViewport}set events(e){this.toggleEvents(this._customEvents,!1),this.toggleEvents(e,!0),this._customEvents=e,this.props&&this.setProps(this.props)}finalize(){var e;for(const t in this._events)this._events[t]&&((e=this.eventManager)==null||e.off(t,this.handleEvent));this.transitionManager.finalize()}handleEvent(e){this._controllerState=void 0;const t=this._eventStartBlocked;switch(e.type){case"panstart":return t?!1:this._onPanStart(e);case"panmove":return this._onPan(e);case"panend":return this._onPanEnd(e);case"pinchstart":return t?!1:this._onPinchStart(e);case"pinchmove":return this._onPinch(e);case"pinchend":return this._onPinchEnd(e);case"multipanstart":return t?!1:this._onMultiPanStart(e);case"multipanmove":return this._onMultiPan(e);case"multipanend":return this._onMultiPanEnd(e);case"dblclick":return this._onDoubleClick(e);case"wheel":return this._onWheel(e);case"keydown":return this._onKeyDown(e);default:return!1}}get controllerState(){return this._controllerState=this._controllerState||new this.ControllerState({makeViewport:this.makeViewport,...this.props,...this.state}),this._controllerState}getCenter(e){const{x:t,y:i}=this.props,{offsetCenter:r}=e;return[r.x-t,r.y-i]}isPointInBounds(e,t){const{width:i,height:r}=this.props;if(t&&t.handled)return!1;const s=e[0]>=0&&e[0]<=i&&e[1]>=0&&e[1]<=r;return s&&t&&t.stopPropagation(),s}isFunctionKeyPressed(e){const{srcEvent:t}=e;return!!(t.metaKey||t.altKey||t.ctrlKey||t.shiftKey)}isDragging(){return this._interactionState.isDragging||!1}blockEvents(e){const t=setTimeout(()=>{this._eventStartBlocked===t&&(this._eventStartBlocked=null)},e);this._eventStartBlocked=t}setProps(e){e.dragMode&&(this.dragMode=e.dragMode),this.props=e,"transitionInterpolator"in e||(e.transitionInterpolator=this._getTransitionProps().transitionInterpolator),this.transitionManager.processViewStateChange(e);const{inertia:t}=e;this.inertia=Number.isFinite(t)?t:t===!0?bP:0;const{scrollZoom:i=!0,dragPan:r=!0,dragRotate:s=!0,doubleClickZoom:o=!0,touchZoom:a=!0,touchRotate:l=!1,keyboard:c=!0}=e,u=!!this.onViewStateChange;this.toggleEvents(On.WHEEL,u&&i),this.toggleEvents(On.PAN,u),this.toggleEvents(On.PINCH,u&&(a||l)),this.toggleEvents(On.MULTI_PAN,u&&l),this.toggleEvents(On.DOUBLE_CLICK,u&&o),this.toggleEvents(On.KEYBOARD,u&&c),this.scrollZoom=i,this.dragPan=r,this.dragRotate=s,this.doubleClickZoom=o,this.touchZoom=a,this.touchRotate=l,this.keyboard=c}updateTransition(){this.transitionManager.updateTransition()}toggleEvents(e,t){this.eventManager&&e.forEach(i=>{this._events[i]!==t&&(this._events[i]=t,t?this.eventManager.on(i,this.handleEvent):this.eventManager.off(i,this.handleEvent))})}updateViewport(e,t=null,i={}){const r={...e.getViewportProps(),...t},s=this.controllerState!==e;if(this.state=e.getState(),this._setInteractionState(i),s){const o=this.controllerState&&this.controllerState.getViewportProps();this.onViewStateChange&&this.onViewStateChange({viewState:r,interactionState:this._interactionState,oldViewState:o,viewId:this.props.id})}}_onTransition(e){this.onViewStateChange({...e,interactionState:this._interactionState,viewId:this.props.id})}_setInteractionState(e){Object.assign(this._interactionState,e),this.onStateChange(this._interactionState)}_onPanStart(e){const t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;let i=this.isFunctionKeyPressed(e)||e.rightButton||!1;(this.invertPan||this.dragMode==="pan")&&(i=!i);const r=this.controllerState[i?"panStart":"rotateStart"]({pos:t});return this._panMove=i,this.updateViewport(r,$t,{isDragging:!0}),!0}_onPan(e){return this.isDragging()?this._panMove?this._onPanMove(e):this._onPanRotate(e):!1}_onPanEnd(e){return this.isDragging()?this._panMove?this._onPanMoveEnd(e):this._onPanRotateEnd(e):!1}_onPanMove(e){if(!this.dragPan)return!1;const t=this.getCenter(e),i=this.controllerState.pan({pos:t});return this.updateViewport(i,$t,{isDragging:!0,isPanning:!0}),!0}_onPanMoveEnd(e){const{inertia:t}=this;if(this.dragPan&&t&&e.velocity){const i=this.getCenter(e),r=[i[0]+e.velocityX*t/2,i[1]+e.velocityY*t/2],s=this.controllerState.pan({pos:r}).panEnd();this.updateViewport(s,{...this._getTransitionProps(),transitionDuration:t,transitionEasing:Fr},{isDragging:!1,isPanning:!0})}else{const i=this.controllerState.panEnd();this.updateViewport(i,null,{isDragging:!1,isPanning:!1})}return!0}_onPanRotate(e){if(!this.dragRotate)return!1;const t=this.getCenter(e),i=this.controllerState.rotate({pos:t});return this.updateViewport(i,$t,{isDragging:!0,isRotating:!0}),!0}_onPanRotateEnd(e){const{inertia:t}=this;if(this.dragRotate&&t&&e.velocity){const i=this.getCenter(e),r=[i[0]+e.velocityX*t/2,i[1]+e.velocityY*t/2],s=this.controllerState.rotate({pos:r}).rotateEnd();this.updateViewport(s,{...this._getTransitionProps(),transitionDuration:t,transitionEasing:Fr},{isDragging:!1,isRotating:!0})}else{const i=this.controllerState.rotateEnd();this.updateViewport(i,null,{isDragging:!1,isRotating:!1})}return!0}_onWheel(e){if(!this.scrollZoom)return!1;const t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;e.srcEvent.preventDefault();const{speed:i=.01,smooth:r=!1}=this.scrollZoom===!0?{}:this.scrollZoom,{delta:s}=e;let o=2/(1+Math.exp(-Math.abs(s*i)));s<0&&o!==0&&(o=1/o);const a=this.controllerState.zoom({pos:t,scale:o});return this.updateViewport(a,{...this._getTransitionProps({around:t}),transitionDuration:r?250:1},{isZooming:!0,isPanning:!0}),!0}_onMultiPanStart(e){const t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;const i=this.controllerState.rotateStart({pos:t});return this.updateViewport(i,$t,{isDragging:!0}),!0}_onMultiPan(e){if(!this.touchRotate||!this.isDragging())return!1;const t=this.getCenter(e);t[0]-=e.deltaX;const i=this.controllerState.rotate({pos:t});return this.updateViewport(i,$t,{isDragging:!0,isRotating:!0}),!0}_onMultiPanEnd(e){if(!this.isDragging())return!1;const{inertia:t}=this;if(this.touchRotate&&t&&e.velocityY){const i=this.getCenter(e),r=[i[0],i[1]+=e.velocityY*t/2],s=this.controllerState.rotate({pos:r});this.updateViewport(s,{...this._getTransitionProps(),transitionDuration:t,transitionEasing:Fr},{isDragging:!1,isRotating:!0}),this.blockEvents(t)}else{const i=this.controllerState.rotateEnd();this.updateViewport(i,null,{isDragging:!1,isRotating:!1})}return!0}_onPinchStart(e){const t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;const i=this.controllerState.zoomStart({pos:t}).rotateStart({pos:t});return nn._startPinchRotation=e.rotation,nn._lastPinchEvent=e,this.updateViewport(i,$t,{isDragging:!0}),!0}_onPinch(e){if(!this.touchZoom&&!this.touchRotate||!this.isDragging())return!1;let t=this.controllerState;if(this.touchZoom){const{scale:i}=e,r=this.getCenter(e);t=t.zoom({pos:r,scale:i})}if(this.touchRotate){const{rotation:i}=e;t=t.rotate({deltaAngleX:nn._startPinchRotation-i})}return this.updateViewport(t,$t,{isDragging:!0,isPanning:this.touchZoom,isZooming:this.touchZoom,isRotating:this.touchRotate}),nn._lastPinchEvent=e,!0}_onPinchEnd(e){if(!this.isDragging())return!1;const{inertia:t}=this,{_lastPinchEvent:i}=nn;if(this.touchZoom&&t&&i&&e.scale!==i.scale){const r=this.getCenter(e);let s=this.controllerState.rotateEnd();const o=Math.log2(e.scale),a=(o-Math.log2(i.scale))/(e.deltaTime-i.deltaTime),l=Math.pow(2,o+a*t/2);s=s.zoom({pos:r,scale:l}).zoomEnd(),this.updateViewport(s,{...this._getTransitionProps({around:r}),transitionDuration:t,transitionEasing:Fr},{isDragging:!1,isPanning:this.touchZoom,isZooming:this.touchZoom,isRotating:!1}),this.blockEvents(t)}else{const r=this.controllerState.zoomEnd().rotateEnd();this.updateViewport(r,null,{isDragging:!1,isPanning:!1,isZooming:!1,isRotating:!1})}return nn._startPinchRotation=null,nn._lastPinchEvent=null,!0}_onDoubleClick(e){if(!this.doubleClickZoom)return!1;const t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;const i=this.isFunctionKeyPressed(e),r=this.controllerState.zoom({pos:t,scale:i?.5:2});return this.updateViewport(r,this._getTransitionProps({around:t}),{isZooming:!0,isPanning:!0}),this.blockEvents(100),!0}_onKeyDown(e){if(!this.keyboard)return!1;const t=this.isFunctionKeyPressed(e),{zoomSpeed:i,moveSpeed:r,rotateSpeedX:s,rotateSpeedY:o}=this.keyboard===!0?{}:this.keyboard,{controllerState:a}=this;let l;const c={};switch(e.srcEvent.code){case"Minus":l=t?a.zoomOut(i).zoomOut(i):a.zoomOut(i),c.isZooming=!0;break;case"Equal":l=t?a.zoomIn(i).zoomIn(i):a.zoomIn(i),c.isZooming=!0;break;case"ArrowLeft":t?(l=a.rotateLeft(s),c.isRotating=!0):(l=a.moveLeft(r),c.isPanning=!0);break;case"ArrowRight":t?(l=a.rotateRight(s),c.isRotating=!0):(l=a.moveRight(r),c.isPanning=!0);break;case"ArrowUp":t?(l=a.rotateUp(o),c.isRotating=!0):(l=a.moveUp(r),c.isPanning=!0);break;case"ArrowDown":t?(l=a.rotateDown(o),c.isRotating=!0):(l=a.moveDown(r),c.isPanning=!0);break;default:return!1}return this.updateViewport(l,this._getTransitionProps(),c),!0}_getTransitionProps(e){const{transition:t}=this;return!t||!t.transitionInterpolator?$t:e?{...t,transitionInterpolator:new si({...e,...t.transitionInterpolator.opts,makeViewport:this.controllerState.makeViewport})}:t}}class s_{constructor(e,t){this._viewportProps=this.applyConstraints(e),this._state=t}getViewportProps(){return this._viewportProps}getState(){return this._state}}const Uh=5,vP=1.2;class xP extends s_{constructor(e){const{width:t,height:i,latitude:r,longitude:s,zoom:o,bearing:a=0,pitch:l=0,altitude:c=1.5,position:u=[0,0,0],maxZoom:d=20,minZoom:h=0,maxPitch:f=60,minPitch:p=0,startPanLngLat:g,startZoomLngLat:_,startRotatePos:b,startBearing:w,startPitch:x,startZoom:y,normalize:S=!0}=e;Me(Number.isFinite(s)),Me(Number.isFinite(r)),Me(Number.isFinite(o)),super({width:t,height:i,latitude:r,longitude:s,zoom:o,bearing:a,pitch:l,altitude:c,maxZoom:d,minZoom:h,maxPitch:f,minPitch:p,normalize:S,position:u},{startPanLngLat:g,startZoomLngLat:_,startRotatePos:b,startBearing:w,startPitch:x,startZoom:y}),this.makeViewport=e.makeViewport}panStart({pos:e}){return this._getUpdatedState({startPanLngLat:this._unproject(e)})}pan({pos:e,startPos:t}){const i=this.getState().startPanLngLat||this._unproject(t);if(!i)return this;const s=this.makeViewport(this.getViewportProps()).panByPosition(i,e);return this._getUpdatedState(s)}panEnd(){return this._getUpdatedState({startPanLngLat:null})}rotateStart({pos:e}){return this._getUpdatedState({startRotatePos:e,startBearing:this.getViewportProps().bearing,startPitch:this.getViewportProps().pitch})}rotate({pos:e,deltaAngleX:t=0,deltaAngleY:i=0}){const{startRotatePos:r,startBearing:s,startPitch:o}=this.getState();if(!r||s===void 0||o===void 0)return this;let a;return e?a=this._getNewRotation(e,r,o,s):a={bearing:s+t,pitch:o+i},this._getUpdatedState(a)}rotateEnd(){return this._getUpdatedState({startBearing:null,startPitch:null})}zoomStart({pos:e}){return this._getUpdatedState({startZoomLngLat:this._unproject(e),startZoom:this.getViewportProps().zoom})}zoom({pos:e,startPos:t,scale:i}){let{startZoom:r,startZoomLngLat:s}=this.getState();if(s||(r=this.getViewportProps().zoom,s=this._unproject(t)||this._unproject(e)),!s)return this;const{maxZoom:o,minZoom:a}=this.getViewportProps();let l=r+Math.log2(i);l=Ce(l,a,o);const c=this.makeViewport({...this.getViewportProps(),zoom:l});return this._getUpdatedState({zoom:l,...c.panByPosition(s,e)})}zoomEnd(){return this._getUpdatedState({startZoomLngLat:null,startZoom:null})}zoomIn(e=2){return this._zoomFromCenter(e)}zoomOut(e=2){return this._zoomFromCenter(1/e)}moveLeft(e=100){return this._panFromCenter([e,0])}moveRight(e=100){return this._panFromCenter([-e,0])}moveUp(e=100){return this._panFromCenter([0,e])}moveDown(e=100){return this._panFromCenter([0,-e])}rotateLeft(e=15){return this._getUpdatedState({bearing:this.getViewportProps().bearing-e})}rotateRight(e=15){return this._getUpdatedState({bearing:this.getViewportProps().bearing+e})}rotateUp(e=10){return this._getUpdatedState({pitch:this.getViewportProps().pitch+e})}rotateDown(e=10){return this._getUpdatedState({pitch:this.getViewportProps().pitch-e})}shortestPathFrom(e){const t=e.getViewportProps(),i={...this.getViewportProps()},{bearing:r,longitude:s}=i;return Math.abs(r-t.bearing)>180&&(i.bearing=r<0?r+360:r-360),Math.abs(s-t.longitude)>180&&(i.longitude=s<0?s+360:s-360),i}applyConstraints(e){const{maxZoom:t,minZoom:i,zoom:r}=e;e.zoom=Ce(r,i,t);const{maxPitch:s,minPitch:o,pitch:a}=e;e.pitch=Ce(a,o,s);const{normalize:l=!0}=e;return l&&Object.assign(e,YI(e)),e}_zoomFromCenter(e){const{width:t,height:i}=this.getViewportProps();return this.zoom({pos:[t/2,i/2],scale:e})}_panFromCenter(e){const{width:t,height:i}=this.getViewportProps();return this.pan({startPos:[t/2,i/2],pos:[t/2+e[0],i/2+e[1]]})}_getUpdatedState(e){return new this.constructor({makeViewport:this.makeViewport,...this.getViewportProps(),...this.getState(),...e})}_unproject(e){const t=this.makeViewport(this.getViewportProps());return e&&t.unproject(e)}_getNewRotation(e,t,i,r){const s=e[0]-t[0],o=e[1]-t[1],a=e[1],l=t[1],{width:c,height:u}=this.getViewportProps(),d=s/c;let h=0;o>0?Math.abs(u-l)>Uh&&(h=o/(l-u)*vP):o<0&&l>Uh&&(h=1-a/l),h=Ce(h,-1,1);const{minPitch:f,maxPitch:p}=this.getViewportProps(),g=r+180*d;let _=i;return h>0?_=i+h*(p-i):h<0&&(_=i-h*(f-i)),{pitch:_,bearing:g}}}class wP extends eu{constructor(){super(...arguments),this.ControllerState=xP,this.transition={transitionDuration:300,transitionInterpolator:new si({transitionProps:{compare:["longitude","latitude","zoom","bearing","pitch","position"],required:["longitude","latitude","zoom"]}})},this.dragMode="pan"}setProps(e){e.position=e.position||[0,0,0];const t=this.props;super.setProps(e),(!t||t.height!==e.height)&&this.updateViewport(new this.ControllerState({makeViewport:this.makeViewport,...e,...this.state}))}}class o_ extends Jc{constructor(e={}){super(e)}getViewportType(){return Gm}get ControllerType(){return wP}}o_.displayName="MapView";const TP=o_,SP=new Zm;function EP(n,e){const t=n.order??1/0,i=e.order??1/0;return t-i}class AP{constructor(e){this._resolvedEffects=[],this._defaultEffects=[],this.effects=[],this._context=e,this._needsRedraw="Initial render",this._setEffects([])}addDefaultEffect(e){const t=this._defaultEffects;if(!t.find(i=>i.id===e.id)){const i=t.findIndex(r=>EP(r,e)>0);i<0?t.push(e):t.splice(i,0,e),e.setup(this._context),this._setEffects(this.effects)}}setProps(e){"effects"in e&&(dt(e.effects,this.effects,1)||this._setEffects(e.effects))}needsRedraw(e={clearRedrawFlags:!1}){const t=this._needsRedraw;return e.clearRedrawFlags&&(this._needsRedraw=!1),t}getEffects(){return this._resolvedEffects}_setEffects(e){const t={};for(const r of this.effects)t[r.id]=r;const i=[];for(const r of e){const s=t[r.id];let o=r;s&&s!==r?s.setProps?(s.setProps(r.props),o=s):s.cleanup(this._context):s||r.setup(this._context),i.push(o),delete t[r.id]}for(const r in t)t[r].cleanup(this._context);this.effects=i,this._resolvedEffects=i.concat(this._defaultEffects),e.some(r=>r instanceof Zm)||this._resolvedEffects.push(SP),this._needsRedraw="effects changed"}finalize(){for(const e of this._resolvedEffects)e.cleanup(this._context);this.effects.length=0,this._resolvedEffects.length=0,this._defaultEffects.length=0}}class CP extends Gc{shouldDrawLayer(e){const{operation:t}=e.props;return t.includes("draw")||t.includes("terrain")}}const IP="deckRenderer.renderLayers";class RP{constructor(e){this.device=e,this.layerFilter=null,this.drawPickingColors=!1,this.drawLayersPass=new CP(e),this.pickLayersPass=new i_(e),this.renderCount=0,this._needsRedraw="Initial render",this.renderBuffers=[],this.lastPostProcessEffect=null}setProps(e){this.layerFilter!==e.layerFilter&&(this.layerFilter=e.layerFilter,this._needsRedraw="layerFilter changed"),this.drawPickingColors!==e.drawPickingColors&&(this.drawPickingColors=e.drawPickingColors,this._needsRedraw="drawPickingColors changed")}renderLayers(e){if(!e.viewports.length)return;const t=this.drawPickingColors?this.pickLayersPass:this.drawLayersPass,i={layerFilter:this.layerFilter,isPicking:this.drawPickingColors,...e};i.effects&&this._preRender(i.effects,i);const r=this.lastPostProcessEffect?this.renderBuffers[0]:i.target;this.lastPostProcessEffect&&(i.clearColor=[0,0,0,0],i.clearCanvas=!0);const s=t.render({...i,target:r});i.effects&&this._postRender(i.effects,i),this.renderCount++,De(IP,this,s,e)}needsRedraw(e={clearRedrawFlags:!1}){const t=this._needsRedraw;return e.clearRedrawFlags&&(this._needsRedraw=!1),t}finalize(){const{renderBuffers:e}=this;for(const t of e)t.delete();e.length=0}_preRender(e,t){this.lastPostProcessEffect=null,t.preRenderStats=t.preRenderStats||{};for(const i of e)t.preRenderStats[i.id]=i.preRender(t),i.postRender&&(this.lastPostProcessEffect=i.id);this.lastPostProcessEffect&&this._resizeRenderBuffers()}_resizeRenderBuffers(){const{renderBuffers:e}=this,t=this.device.canvasContext.getDrawingBufferSize();e.length===0&&[0,1].map(i=>{const r=this.device.createTexture({sampler:{minFilter:"linear",magFilter:"linear"}});e.push(this.device.createFramebuffer({id:`deck-renderbuffer-${i}`,colorAttachments:[r]}))});for(const i of e)i.resize(t)}_postRender(e,t){const{renderBuffers:i}=this,r={...t,inputBuffer:i[0],swapBuffer:i[1]};for(const s of e)if(s.postRender){r.target=s.id===this.lastPostProcessEffect?t.target:void 0;const o=s.postRender(r);r.inputBuffer=o,r.swapBuffer=o===i[0]?i[1]:i[0]}}}const PP={pickedColor:null,pickedObjectIndex:-1};function MP({pickedColors:n,decodePickingColor:e,deviceX:t,deviceY:i,deviceRadius:r,deviceRect:s}){const{x:o,y:a,width:l,height:c}=s;let u=r*r,d=-1,h=0;for(let f=0;f<c;f++){const p=f+a-i,g=p*p;if(g>u)h+=4*l;else for(let _=0;_<l;_++){if(n[h+3]-1>=0){const w=_+o-t,x=w*w+g;x<=u&&(u=x,d=h)}h+=4}}if(d>=0){const f=n.slice(d,d+4),p=e(f);if(p){const g=Math.floor(d/4/l),_=d/4-g*l;return{...p,pickedColor:f,pickedX:o+_,pickedY:a+g}}Q.error("Picked non-existent layer. Is picking buffer corrupt?")()}return PP}function kP({pickedColors:n,decodePickingColor:e}){const t=new Map;if(n){for(let i=0;i<n.length;i+=4)if(n[i+3]-1>=0){const s=n.slice(i,i+4),o=s.join(",");if(!t.has(o)){const a=e(s);a?t.set(o,{...a,color:s}):Q.error("Picked non-existent layer. Is picking buffer corrupt?")()}}}return Array.from(t.values())}function a_({pickInfo:n,viewports:e,pixelRatio:t,x:i,y:r,z:s}){let o=e[0];e.length>1&&(o=NP((n==null?void 0:n.pickedViewports)||e,{x:i,y:r}));let a;if(o){const l=[i-o.x,r-o.y];s!==void 0&&(l[2]=s),a=o.unproject(l)}return{color:null,layer:null,viewport:o,index:-1,picked:!1,x:i,y:r,pixel:[i,r],coordinate:a,devicePixel:n&&"pickedX"in n?[n.pickedX,n.pickedY]:void 0,pixelRatio:t}}function OP(n){const{pickInfo:e,lastPickedInfo:t,mode:i,layers:r}=n,{pickedColor:s,pickedLayer:o,pickedObjectIndex:a}=e,l=o?[o]:[];if(i==="hover"){const d=t.index,h=t.layerId,f=o?o.props.id:null;if(f!==h||a!==d){if(f!==h){const p=r.find(g=>g.props.id===h);p&&l.unshift(p)}t.layerId=f,t.index=a,t.info=null}}const c=a_(n),u=new Map;return u.set(null,c),l.forEach(d=>{let h={...c};d===o&&(h.color=s,h.index=a,h.picked=!0),h=l_({layer:d,info:h,mode:i});const f=h.layer;d===o&&i==="hover"&&(t.info=h),u.set(f.id,h),i==="hover"&&f.updateAutoHighlight(h)}),u}function l_({layer:n,info:e,mode:t}){for(;n&&e;){const i=e.layer||null;e.sourceLayer=i,e.layer=n,e=n.getPickingInfo({info:e,mode:t,sourceLayer:i}),n=n.parent}return e}function NP(n,e){for(let t=n.length-1;t>=0;t--){const i=n[t];if(i.containsPixel(e))return i}return n[0]}class FP{constructor(e){this._pickable=!0,this.device=e,this.pickLayersPass=new i_(e),this.lastPickedInfo={index:-1,layerId:null,info:null}}setProps(e){"layerFilter"in e&&(this.layerFilter=e.layerFilter),"_pickable"in e&&(this._pickable=e._pickable)}finalize(){this.pickingFBO&&this.pickingFBO.destroy(),this.depthFBO&&this.depthFBO.destroy()}pickObject(e){return this._pickClosestObject(e)}pickObjects(e){return this._pickVisibleObjects(e)}getLastPickedObject({x:e,y:t,layers:i,viewports:r},s=this.lastPickedInfo.info){const o=s&&s.layer&&s.layer.id,a=s&&s.viewport&&s.viewport.id,l=o?i.find(h=>h.id===o):null,c=a&&r.find(h=>h.id===a)||r[0],u=c&&c.unproject([e-c.x,t-c.y]);return{...s,...{x:e,y:t,viewport:c,coordinate:u,layer:l}}}_resizeBuffer(){var t,i;if(!this.pickingFBO&&(this.pickingFBO=this.device.createFramebuffer({colorAttachments:["rgba8unorm"],depthStencilAttachment:"depth16unorm"}),this.device.isTextureFormatRenderable("rgba32float"))){const r=this.device.createFramebuffer({colorAttachments:["rgba32float"],depthStencilAttachment:"depth16unorm"});this.depthFBO=r}const{canvas:e}=this.device.getDefaultCanvasContext();(t=this.pickingFBO)==null||t.resize({width:e.width,height:e.height}),(i=this.depthFBO)==null||i.resize({width:e.width,height:e.height})}_getPickable(e){if(this._pickable===!1)return null;const t=e.filter(i=>this.pickLayersPass.shouldDrawLayer(i)&&!i.isComposite);return t.length?t:null}_pickClosestObject({layers:e,views:t,viewports:i,x:r,y:s,radius:o=0,depth:a=1,mode:l="query",unproject3D:c,onViewportActive:u,effects:d}){const h=this.device.canvasContext.cssToDeviceRatio(),f=this._getPickable(e);if(!f||i.length===0)return{result:[],emptyInfo:a_({viewports:i,x:r,y:s,pixelRatio:h})};this._resizeBuffer();const p=this.device.canvasContext.cssToDevicePixels([r,s],!0),g=[p.x+Math.floor(p.width/2),p.y+Math.floor(p.height/2)],_=Math.round(o*h),{width:b,height:w}=this.pickingFBO,x=this._getPickingRect({deviceX:g[0],deviceY:g[1],deviceRadius:_,deviceWidth:b,deviceHeight:w}),y={x:r-o,y:s-o,width:o*2+1,height:o*2+1};let S;const I=[],F=new Set;for(let D=0;D<a;D++){let B;if(x){const O=this._drawAndSample({layers:f,views:t,viewports:i,onViewportActive:u,deviceRect:x,cullRect:y,effects:d,pass:`picking:${l}`});B=MP({...O,deviceX:g[0],deviceY:g[1],deviceRadius:_,deviceRect:x})}else B={pickedColor:null,pickedObjectIndex:-1};let U;if(B.pickedLayer&&c&&this.depthFBO){const{pickedColors:O}=this._drawAndSample({layers:[B.pickedLayer],views:t,viewports:i,onViewportActive:u,deviceRect:{x:B.pickedX,y:B.pickedY,width:1,height:1},cullRect:y,effects:d,pass:`picking:${l}:z`},!0);O[3]&&(U=O[0])}B.pickedLayer&&D+1<a&&(F.add(B.pickedLayer),B.pickedLayer.disablePickingIndex(B.pickedObjectIndex)),S=OP({pickInfo:B,lastPickedInfo:this.lastPickedInfo,mode:l,layers:f,viewports:i,x:r,y:s,z:U,pixelRatio:h});for(const O of S.values())O.layer&&I.push(O);if(!B.pickedColor)break}for(const D of F)D.restorePickingColors();return{result:I,emptyInfo:S.get(null)}}_pickVisibleObjects({layers:e,views:t,viewports:i,x:r,y:s,width:o=1,height:a=1,mode:l="query",maxObjects:c=null,onViewportActive:u,effects:d}){const h=this._getPickable(e);if(!h||i.length===0)return[];this._resizeBuffer();const f=this.device.canvasContext.cssToDeviceRatio(),p=this.device.canvasContext.cssToDevicePixels([r,s],!0),g=p.x,_=p.y+p.height,b=this.device.canvasContext.cssToDevicePixels([r+o,s+a],!0),w=b.x+b.width,x=b.y,y={x:g,y:x,width:w-g,height:_-x},S=this._drawAndSample({layers:h,views:t,viewports:i,onViewportActive:u,deviceRect:y,cullRect:{x:r,y:s,width:o,height:a},effects:d,pass:`picking:${l}`}),I=kP(S),F=new Map,D=[],B=Number.isFinite(c);for(let U=0;U<I.length&&!(B&&D.length>=c);U++){const O=I[U];let H={color:O.pickedColor,layer:null,index:O.pickedObjectIndex,picked:!0,x:r,y:s,pixelRatio:f};H=l_({layer:O.pickedLayer,info:H,mode:l});const $=H.layer.id;F.has($)||F.set($,new Set);const z=F.get($),te=H.object??H.index;z.has(te)||(z.add(te),D.push(H))}return D}_drawAndSample({layers:e,views:t,viewports:i,onViewportActive:r,deviceRect:s,cullRect:o,effects:a,pass:l},c=!1){const u=c?this.depthFBO:this.pickingFBO,d={layers:e,layerFilter:this.layerFilter,views:t,viewports:i,onViewportActive:r,pickingFBO:u,deviceRect:s,cullRect:o,effects:a,pass:l,pickZ:c,preRenderStats:{},isPicking:!0};for(const w of a)w.useInPicking&&(d.preRenderStats[w.id]=w.preRender(d));const{decodePickingColor:h}=this.pickLayersPass.render(d),{x:f,y:p,width:g,height:_}=s,b=new(c?Float32Array:Uint8Array)(g*_*4);return this.device.readPixelsToArrayWebGL(u,{sourceX:f,sourceY:p,sourceWidth:g,sourceHeight:_,target:b}),{pickedColors:b,decodePickingColor:h}}_getPickingRect({deviceX:e,deviceY:t,deviceRadius:i,deviceWidth:r,deviceHeight:s}){const o=Math.max(0,e-i),a=Math.max(0,t-i),l=Math.min(r,e+i+1)-o,c=Math.min(s,t+i+1)-a;return l<=0||c<=0?null:{x:o,y:a,width:l,height:c}}}const DP={"top-left":{top:0,left:0},"top-right":{top:0,right:0},"bottom-left":{bottom:0,left:0},"bottom-right":{bottom:0,right:0},fill:{top:0,left:0,bottom:0,right:0}},BP="top-left",$h="__root";class LP{constructor({deck:e,parentElement:t}){this.defaultWidgets=[],this.widgets=[],this.resolvedWidgets=[],this.containers={},this.lastViewports={},this.deck=e,this.parentElement=t}getWidgets(){return this.resolvedWidgets}setProps(e){e.widgets&&!dt(e.widgets,this.widgets,1)&&this._setWidgets(e.widgets)}finalize(){for(const e of this.getWidgets())this._remove(e);this.defaultWidgets.length=0,this.resolvedWidgets.length=0;for(const e in this.containers)this.containers[e].remove()}addDefault(e){this.defaultWidgets.find(t=>t.id===e.id)||(this._add(e),this.defaultWidgets.push(e),this._setWidgets(this.widgets))}_setWidgets(e){const t={};for(const i of this.resolvedWidgets)t[i.id]=i;this.resolvedWidgets.length=0;for(const i of this.defaultWidgets)t[i.id]=null,this.resolvedWidgets.push(i);for(let i of e){const r=t[i.id];r?r.viewId!==i.viewId||r.placement!==i.placement?(this._remove(r),this._add(i)):i!==r&&(r.setProps(i.props),i=r):this._add(i),t[i.id]=null,this.resolvedWidgets.push(i)}for(const i in t){const r=t[i];r&&this._remove(r)}this.widgets=e}_add(e){const{viewId:t=null,placement:i=BP}=e,r=e.onAdd({deck:this.deck,viewId:t});r&&this._getContainer(t,i).append(r),e._element=r}_remove(e){var t;(t=e.onRemove)==null||t.call(e),e._element&&e._element.remove(),e._element=void 0}_getContainer(e,t){var o;const i=e||$h;let r=this.containers[i];r||(r=document.createElement("div"),r.style.pointerEvents="none",r.style.position="absolute",r.style.overflow="hidden",(o=this.parentElement)==null||o.append(r),this.containers[i]=r);let s=r.querySelector(`.${t}`);return s||(s=document.createElement("div"),s.className=t,s.style.position="absolute",s.style.zIndex="2",Object.assign(s.style,DP[t]),r.append(s)),s}_updateContainers(){const e=this.deck.width,t=this.deck.height;for(const i in this.containers){const r=this.lastViewports[i]||null,s=i===$h||r,o=this.containers[i];s?(o.style.display="block",o.style.left=`${r?r.x:0}px`,o.style.top=`${r?r.y:0}px`,o.style.width=`${r?r.width:e}px`,o.style.height=`${r?r.height:t}px`):o.style.display="none"}}onRedraw({viewports:e,layers:t}){var r,s;const i=e.reduce((o,a)=>(o[a.id]=a,o),{});for(const o of this.getWidgets()){const{viewId:a}=o;if(a){const l=i[a];l&&(o.onViewportChange&&o.onViewportChange(l),(r=o.onRedraw)==null||r.call(o,{viewports:[l],layers:t}))}else{if(o.onViewportChange)for(const l of e)o.onViewportChange(l);(s=o.onRedraw)==null||s.call(o,{viewports:e,layers:t})}}this.lastViewports=i,this._updateContainers()}onHover(e,t){var i,r;for(const s of this.getWidgets()){const{viewId:o}=s;(!o||o===((i=e.viewport)==null?void 0:i.id))&&((r=s.onHover)==null||r.call(s,e,t))}}onEvent(e,t){var r,s;const i=Sl[t.type];if(i)for(const o of this.getWidgets()){const{viewId:a}=o;(!a||a===((r=e.viewport)==null?void 0:r.id))&&((s=o[i])==null||s.call(o,e,t))}}}const UP={zIndex:"1",position:"absolute",pointerEvents:"none",color:"#a0a7b4",backgroundColor:"#29323c",padding:"10px",top:"0",left:"0",display:"none"};class $P{constructor(){this.id="default-tooltip",this.placement="fill",this.props={},this.isVisible=!1}onAdd({deck:e}){const t=document.createElement("div");return t.className="deck-tooltip",Object.assign(t.style,UP),this.deck=e,this.element=t,t}onRemove(){this.deck=void 0,this.element=void 0}setProps(){}onViewportChange(e){var t;this.isVisible&&e.id===((t=this.lastViewport)==null?void 0:t.id)&&e!==this.lastViewport&&this.setTooltip(null)}onHover(e){const{deck:t}=this,i=t&&t.props.getTooltip;if(!i)return;const r=i(e);this.lastViewport=e.viewport,this.setTooltip(r,e.x,e.y)}setTooltip(e,t,i){const r=this.element;if(r){if(typeof e=="string")r.innerText=e;else if(e)e.text&&(r.innerText=e.text),e.html&&(r.innerHTML=e.html),e.className&&(r.className=e.className);else{this.isVisible=!1,r.style.display="none";return}this.isVisible=!0,r.style.display="block",r.style.transform=`translate(${t}px, ${i}px)`,e&&typeof e=="object"&&"style"in e&&Object.assign(r.style,e.style)}}}var Un;(function(n){n[n.DEPTH_BUFFER_BIT=256]="DEPTH_BUFFER_BIT",n[n.STENCIL_BUFFER_BIT=1024]="STENCIL_BUFFER_BIT",n[n.COLOR_BUFFER_BIT=16384]="COLOR_BUFFER_BIT",n[n.POINTS=0]="POINTS",n[n.LINES=1]="LINES",n[n.LINE_LOOP=2]="LINE_LOOP",n[n.LINE_STRIP=3]="LINE_STRIP",n[n.TRIANGLES=4]="TRIANGLES",n[n.TRIANGLE_STRIP=5]="TRIANGLE_STRIP",n[n.TRIANGLE_FAN=6]="TRIANGLE_FAN",n[n.ZERO=0]="ZERO",n[n.ONE=1]="ONE",n[n.SRC_COLOR=768]="SRC_COLOR",n[n.ONE_MINUS_SRC_COLOR=769]="ONE_MINUS_SRC_COLOR",n[n.SRC_ALPHA=770]="SRC_ALPHA",n[n.ONE_MINUS_SRC_ALPHA=771]="ONE_MINUS_SRC_ALPHA",n[n.DST_ALPHA=772]="DST_ALPHA",n[n.ONE_MINUS_DST_ALPHA=773]="ONE_MINUS_DST_ALPHA",n[n.DST_COLOR=774]="DST_COLOR",n[n.ONE_MINUS_DST_COLOR=775]="ONE_MINUS_DST_COLOR",n[n.SRC_ALPHA_SATURATE=776]="SRC_ALPHA_SATURATE",n[n.CONSTANT_COLOR=32769]="CONSTANT_COLOR",n[n.ONE_MINUS_CONSTANT_COLOR=32770]="ONE_MINUS_CONSTANT_COLOR",n[n.CONSTANT_ALPHA=32771]="CONSTANT_ALPHA",n[n.ONE_MINUS_CONSTANT_ALPHA=32772]="ONE_MINUS_CONSTANT_ALPHA",n[n.FUNC_ADD=32774]="FUNC_ADD",n[n.FUNC_SUBTRACT=32778]="FUNC_SUBTRACT",n[n.FUNC_REVERSE_SUBTRACT=32779]="FUNC_REVERSE_SUBTRACT",n[n.BLEND_EQUATION=32777]="BLEND_EQUATION",n[n.BLEND_EQUATION_RGB=32777]="BLEND_EQUATION_RGB",n[n.BLEND_EQUATION_ALPHA=34877]="BLEND_EQUATION_ALPHA",n[n.BLEND_DST_RGB=32968]="BLEND_DST_RGB",n[n.BLEND_SRC_RGB=32969]="BLEND_SRC_RGB",n[n.BLEND_DST_ALPHA=32970]="BLEND_DST_ALPHA",n[n.BLEND_SRC_ALPHA=32971]="BLEND_SRC_ALPHA",n[n.BLEND_COLOR=32773]="BLEND_COLOR",n[n.ARRAY_BUFFER_BINDING=34964]="ARRAY_BUFFER_BINDING",n[n.ELEMENT_ARRAY_BUFFER_BINDING=34965]="ELEMENT_ARRAY_BUFFER_BINDING",n[n.LINE_WIDTH=2849]="LINE_WIDTH",n[n.ALIASED_POINT_SIZE_RANGE=33901]="ALIASED_POINT_SIZE_RANGE",n[n.ALIASED_LINE_WIDTH_RANGE=33902]="ALIASED_LINE_WIDTH_RANGE",n[n.CULL_FACE_MODE=2885]="CULL_FACE_MODE",n[n.FRONT_FACE=2886]="FRONT_FACE",n[n.DEPTH_RANGE=2928]="DEPTH_RANGE",n[n.DEPTH_WRITEMASK=2930]="DEPTH_WRITEMASK",n[n.DEPTH_CLEAR_VALUE=2931]="DEPTH_CLEAR_VALUE",n[n.DEPTH_FUNC=2932]="DEPTH_FUNC",n[n.STENCIL_CLEAR_VALUE=2961]="STENCIL_CLEAR_VALUE",n[n.STENCIL_FUNC=2962]="STENCIL_FUNC",n[n.STENCIL_FAIL=2964]="STENCIL_FAIL",n[n.STENCIL_PASS_DEPTH_FAIL=2965]="STENCIL_PASS_DEPTH_FAIL",n[n.STENCIL_PASS_DEPTH_PASS=2966]="STENCIL_PASS_DEPTH_PASS",n[n.STENCIL_REF=2967]="STENCIL_REF",n[n.STENCIL_VALUE_MASK=2963]="STENCIL_VALUE_MASK",n[n.STENCIL_WRITEMASK=2968]="STENCIL_WRITEMASK",n[n.STENCIL_BACK_FUNC=34816]="STENCIL_BACK_FUNC",n[n.STENCIL_BACK_FAIL=34817]="STENCIL_BACK_FAIL",n[n.STENCIL_BACK_PASS_DEPTH_FAIL=34818]="STENCIL_BACK_PASS_DEPTH_FAIL",n[n.STENCIL_BACK_PASS_DEPTH_PASS=34819]="STENCIL_BACK_PASS_DEPTH_PASS",n[n.STENCIL_BACK_REF=36003]="STENCIL_BACK_REF",n[n.STENCIL_BACK_VALUE_MASK=36004]="STENCIL_BACK_VALUE_MASK",n[n.STENCIL_BACK_WRITEMASK=36005]="STENCIL_BACK_WRITEMASK",n[n.VIEWPORT=2978]="VIEWPORT",n[n.SCISSOR_BOX=3088]="SCISSOR_BOX",n[n.COLOR_CLEAR_VALUE=3106]="COLOR_CLEAR_VALUE",n[n.COLOR_WRITEMASK=3107]="COLOR_WRITEMASK",n[n.UNPACK_ALIGNMENT=3317]="UNPACK_ALIGNMENT",n[n.PACK_ALIGNMENT=3333]="PACK_ALIGNMENT",n[n.MAX_TEXTURE_SIZE=3379]="MAX_TEXTURE_SIZE",n[n.MAX_VIEWPORT_DIMS=3386]="MAX_VIEWPORT_DIMS",n[n.SUBPIXEL_BITS=3408]="SUBPIXEL_BITS",n[n.RED_BITS=3410]="RED_BITS",n[n.GREEN_BITS=3411]="GREEN_BITS",n[n.BLUE_BITS=3412]="BLUE_BITS",n[n.ALPHA_BITS=3413]="ALPHA_BITS",n[n.DEPTH_BITS=3414]="DEPTH_BITS",n[n.STENCIL_BITS=3415]="STENCIL_BITS",n[n.POLYGON_OFFSET_UNITS=10752]="POLYGON_OFFSET_UNITS",n[n.POLYGON_OFFSET_FACTOR=32824]="POLYGON_OFFSET_FACTOR",n[n.TEXTURE_BINDING_2D=32873]="TEXTURE_BINDING_2D",n[n.SAMPLE_BUFFERS=32936]="SAMPLE_BUFFERS",n[n.SAMPLES=32937]="SAMPLES",n[n.SAMPLE_COVERAGE_VALUE=32938]="SAMPLE_COVERAGE_VALUE",n[n.SAMPLE_COVERAGE_INVERT=32939]="SAMPLE_COVERAGE_INVERT",n[n.COMPRESSED_TEXTURE_FORMATS=34467]="COMPRESSED_TEXTURE_FORMATS",n[n.VENDOR=7936]="VENDOR",n[n.RENDERER=7937]="RENDERER",n[n.VERSION=7938]="VERSION",n[n.IMPLEMENTATION_COLOR_READ_TYPE=35738]="IMPLEMENTATION_COLOR_READ_TYPE",n[n.IMPLEMENTATION_COLOR_READ_FORMAT=35739]="IMPLEMENTATION_COLOR_READ_FORMAT",n[n.BROWSER_DEFAULT_WEBGL=37444]="BROWSER_DEFAULT_WEBGL",n[n.STATIC_DRAW=35044]="STATIC_DRAW",n[n.STREAM_DRAW=35040]="STREAM_DRAW",n[n.DYNAMIC_DRAW=35048]="DYNAMIC_DRAW",n[n.ARRAY_BUFFER=34962]="ARRAY_BUFFER",n[n.ELEMENT_ARRAY_BUFFER=34963]="ELEMENT_ARRAY_BUFFER",n[n.BUFFER_SIZE=34660]="BUFFER_SIZE",n[n.BUFFER_USAGE=34661]="BUFFER_USAGE",n[n.CURRENT_VERTEX_ATTRIB=34342]="CURRENT_VERTEX_ATTRIB",n[n.VERTEX_ATTRIB_ARRAY_ENABLED=34338]="VERTEX_ATTRIB_ARRAY_ENABLED",n[n.VERTEX_ATTRIB_ARRAY_SIZE=34339]="VERTEX_ATTRIB_ARRAY_SIZE",n[n.VERTEX_ATTRIB_ARRAY_STRIDE=34340]="VERTEX_ATTRIB_ARRAY_STRIDE",n[n.VERTEX_ATTRIB_ARRAY_TYPE=34341]="VERTEX_ATTRIB_ARRAY_TYPE",n[n.VERTEX_ATTRIB_ARRAY_NORMALIZED=34922]="VERTEX_ATTRIB_ARRAY_NORMALIZED",n[n.VERTEX_ATTRIB_ARRAY_POINTER=34373]="VERTEX_ATTRIB_ARRAY_POINTER",n[n.VERTEX_ATTRIB_ARRAY_BUFFER_BINDING=34975]="VERTEX_ATTRIB_ARRAY_BUFFER_BINDING",n[n.CULL_FACE=2884]="CULL_FACE",n[n.FRONT=1028]="FRONT",n[n.BACK=1029]="BACK",n[n.FRONT_AND_BACK=1032]="FRONT_AND_BACK",n[n.BLEND=3042]="BLEND",n[n.DEPTH_TEST=2929]="DEPTH_TEST",n[n.DITHER=3024]="DITHER",n[n.POLYGON_OFFSET_FILL=32823]="POLYGON_OFFSET_FILL",n[n.SAMPLE_ALPHA_TO_COVERAGE=32926]="SAMPLE_ALPHA_TO_COVERAGE",n[n.SAMPLE_COVERAGE=32928]="SAMPLE_COVERAGE",n[n.SCISSOR_TEST=3089]="SCISSOR_TEST",n[n.STENCIL_TEST=2960]="STENCIL_TEST",n[n.NO_ERROR=0]="NO_ERROR",n[n.INVALID_ENUM=1280]="INVALID_ENUM",n[n.INVALID_VALUE=1281]="INVALID_VALUE",n[n.INVALID_OPERATION=1282]="INVALID_OPERATION",n[n.OUT_OF_MEMORY=1285]="OUT_OF_MEMORY",n[n.CONTEXT_LOST_WEBGL=37442]="CONTEXT_LOST_WEBGL",n[n.CW=2304]="CW",n[n.CCW=2305]="CCW",n[n.DONT_CARE=4352]="DONT_CARE",n[n.FASTEST=4353]="FASTEST",n[n.NICEST=4354]="NICEST",n[n.GENERATE_MIPMAP_HINT=33170]="GENERATE_MIPMAP_HINT",n[n.BYTE=5120]="BYTE",n[n.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",n[n.SHORT=5122]="SHORT",n[n.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",n[n.INT=5124]="INT",n[n.UNSIGNED_INT=5125]="UNSIGNED_INT",n[n.FLOAT=5126]="FLOAT",n[n.DOUBLE=5130]="DOUBLE",n[n.DEPTH_COMPONENT=6402]="DEPTH_COMPONENT",n[n.ALPHA=6406]="ALPHA",n[n.RGB=6407]="RGB",n[n.RGBA=6408]="RGBA",n[n.LUMINANCE=6409]="LUMINANCE",n[n.LUMINANCE_ALPHA=6410]="LUMINANCE_ALPHA",n[n.UNSIGNED_SHORT_4_4_4_4=32819]="UNSIGNED_SHORT_4_4_4_4",n[n.UNSIGNED_SHORT_5_5_5_1=32820]="UNSIGNED_SHORT_5_5_5_1",n[n.UNSIGNED_SHORT_5_6_5=33635]="UNSIGNED_SHORT_5_6_5",n[n.FRAGMENT_SHADER=35632]="FRAGMENT_SHADER",n[n.VERTEX_SHADER=35633]="VERTEX_SHADER",n[n.COMPILE_STATUS=35713]="COMPILE_STATUS",n[n.DELETE_STATUS=35712]="DELETE_STATUS",n[n.LINK_STATUS=35714]="LINK_STATUS",n[n.VALIDATE_STATUS=35715]="VALIDATE_STATUS",n[n.ATTACHED_SHADERS=35717]="ATTACHED_SHADERS",n[n.ACTIVE_ATTRIBUTES=35721]="ACTIVE_ATTRIBUTES",n[n.ACTIVE_UNIFORMS=35718]="ACTIVE_UNIFORMS",n[n.MAX_VERTEX_ATTRIBS=34921]="MAX_VERTEX_ATTRIBS",n[n.MAX_VERTEX_UNIFORM_VECTORS=36347]="MAX_VERTEX_UNIFORM_VECTORS",n[n.MAX_VARYING_VECTORS=36348]="MAX_VARYING_VECTORS",n[n.MAX_COMBINED_TEXTURE_IMAGE_UNITS=35661]="MAX_COMBINED_TEXTURE_IMAGE_UNITS",n[n.MAX_VERTEX_TEXTURE_IMAGE_UNITS=35660]="MAX_VERTEX_TEXTURE_IMAGE_UNITS",n[n.MAX_TEXTURE_IMAGE_UNITS=34930]="MAX_TEXTURE_IMAGE_UNITS",n[n.MAX_FRAGMENT_UNIFORM_VECTORS=36349]="MAX_FRAGMENT_UNIFORM_VECTORS",n[n.SHADER_TYPE=35663]="SHADER_TYPE",n[n.SHADING_LANGUAGE_VERSION=35724]="SHADING_LANGUAGE_VERSION",n[n.CURRENT_PROGRAM=35725]="CURRENT_PROGRAM",n[n.NEVER=512]="NEVER",n[n.LESS=513]="LESS",n[n.EQUAL=514]="EQUAL",n[n.LEQUAL=515]="LEQUAL",n[n.GREATER=516]="GREATER",n[n.NOTEQUAL=517]="NOTEQUAL",n[n.GEQUAL=518]="GEQUAL",n[n.ALWAYS=519]="ALWAYS",n[n.KEEP=7680]="KEEP",n[n.REPLACE=7681]="REPLACE",n[n.INCR=7682]="INCR",n[n.DECR=7683]="DECR",n[n.INVERT=5386]="INVERT",n[n.INCR_WRAP=34055]="INCR_WRAP",n[n.DECR_WRAP=34056]="DECR_WRAP",n[n.NEAREST=9728]="NEAREST",n[n.LINEAR=9729]="LINEAR",n[n.NEAREST_MIPMAP_NEAREST=9984]="NEAREST_MIPMAP_NEAREST",n[n.LINEAR_MIPMAP_NEAREST=9985]="LINEAR_MIPMAP_NEAREST",n[n.NEAREST_MIPMAP_LINEAR=9986]="NEAREST_MIPMAP_LINEAR",n[n.LINEAR_MIPMAP_LINEAR=9987]="LINEAR_MIPMAP_LINEAR",n[n.TEXTURE_MAG_FILTER=10240]="TEXTURE_MAG_FILTER",n[n.TEXTURE_MIN_FILTER=10241]="TEXTURE_MIN_FILTER",n[n.TEXTURE_WRAP_S=10242]="TEXTURE_WRAP_S",n[n.TEXTURE_WRAP_T=10243]="TEXTURE_WRAP_T",n[n.TEXTURE_2D=3553]="TEXTURE_2D",n[n.TEXTURE=5890]="TEXTURE",n[n.TEXTURE_CUBE_MAP=34067]="TEXTURE_CUBE_MAP",n[n.TEXTURE_BINDING_CUBE_MAP=34068]="TEXTURE_BINDING_CUBE_MAP",n[n.TEXTURE_CUBE_MAP_POSITIVE_X=34069]="TEXTURE_CUBE_MAP_POSITIVE_X",n[n.TEXTURE_CUBE_MAP_NEGATIVE_X=34070]="TEXTURE_CUBE_MAP_NEGATIVE_X",n[n.TEXTURE_CUBE_MAP_POSITIVE_Y=34071]="TEXTURE_CUBE_MAP_POSITIVE_Y",n[n.TEXTURE_CUBE_MAP_NEGATIVE_Y=34072]="TEXTURE_CUBE_MAP_NEGATIVE_Y",n[n.TEXTURE_CUBE_MAP_POSITIVE_Z=34073]="TEXTURE_CUBE_MAP_POSITIVE_Z",n[n.TEXTURE_CUBE_MAP_NEGATIVE_Z=34074]="TEXTURE_CUBE_MAP_NEGATIVE_Z",n[n.MAX_CUBE_MAP_TEXTURE_SIZE=34076]="MAX_CUBE_MAP_TEXTURE_SIZE",n[n.TEXTURE0=33984]="TEXTURE0",n[n.ACTIVE_TEXTURE=34016]="ACTIVE_TEXTURE",n[n.REPEAT=10497]="REPEAT",n[n.CLAMP_TO_EDGE=33071]="CLAMP_TO_EDGE",n[n.MIRRORED_REPEAT=33648]="MIRRORED_REPEAT",n[n.TEXTURE_WIDTH=4096]="TEXTURE_WIDTH",n[n.TEXTURE_HEIGHT=4097]="TEXTURE_HEIGHT",n[n.FLOAT_VEC2=35664]="FLOAT_VEC2",n[n.FLOAT_VEC3=35665]="FLOAT_VEC3",n[n.FLOAT_VEC4=35666]="FLOAT_VEC4",n[n.INT_VEC2=35667]="INT_VEC2",n[n.INT_VEC3=35668]="INT_VEC3",n[n.INT_VEC4=35669]="INT_VEC4",n[n.BOOL=35670]="BOOL",n[n.BOOL_VEC2=35671]="BOOL_VEC2",n[n.BOOL_VEC3=35672]="BOOL_VEC3",n[n.BOOL_VEC4=35673]="BOOL_VEC4",n[n.FLOAT_MAT2=35674]="FLOAT_MAT2",n[n.FLOAT_MAT3=35675]="FLOAT_MAT3",n[n.FLOAT_MAT4=35676]="FLOAT_MAT4",n[n.SAMPLER_2D=35678]="SAMPLER_2D",n[n.SAMPLER_CUBE=35680]="SAMPLER_CUBE",n[n.LOW_FLOAT=36336]="LOW_FLOAT",n[n.MEDIUM_FLOAT=36337]="MEDIUM_FLOAT",n[n.HIGH_FLOAT=36338]="HIGH_FLOAT",n[n.LOW_INT=36339]="LOW_INT",n[n.MEDIUM_INT=36340]="MEDIUM_INT",n[n.HIGH_INT=36341]="HIGH_INT",n[n.FRAMEBUFFER=36160]="FRAMEBUFFER",n[n.RENDERBUFFER=36161]="RENDERBUFFER",n[n.RGBA4=32854]="RGBA4",n[n.RGB5_A1=32855]="RGB5_A1",n[n.RGB565=36194]="RGB565",n[n.DEPTH_COMPONENT16=33189]="DEPTH_COMPONENT16",n[n.STENCIL_INDEX=6401]="STENCIL_INDEX",n[n.STENCIL_INDEX8=36168]="STENCIL_INDEX8",n[n.DEPTH_STENCIL=34041]="DEPTH_STENCIL",n[n.RENDERBUFFER_WIDTH=36162]="RENDERBUFFER_WIDTH",n[n.RENDERBUFFER_HEIGHT=36163]="RENDERBUFFER_HEIGHT",n[n.RENDERBUFFER_INTERNAL_FORMAT=36164]="RENDERBUFFER_INTERNAL_FORMAT",n[n.RENDERBUFFER_RED_SIZE=36176]="RENDERBUFFER_RED_SIZE",n[n.RENDERBUFFER_GREEN_SIZE=36177]="RENDERBUFFER_GREEN_SIZE",n[n.RENDERBUFFER_BLUE_SIZE=36178]="RENDERBUFFER_BLUE_SIZE",n[n.RENDERBUFFER_ALPHA_SIZE=36179]="RENDERBUFFER_ALPHA_SIZE",n[n.RENDERBUFFER_DEPTH_SIZE=36180]="RENDERBUFFER_DEPTH_SIZE",n[n.RENDERBUFFER_STENCIL_SIZE=36181]="RENDERBUFFER_STENCIL_SIZE",n[n.FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE=36048]="FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE",n[n.FRAMEBUFFER_ATTACHMENT_OBJECT_NAME=36049]="FRAMEBUFFER_ATTACHMENT_OBJECT_NAME",n[n.FRAMEBUFFER_ATTACHMENT_TEXTURE_LEVEL=36050]="FRAMEBUFFER_ATTACHMENT_TEXTURE_LEVEL",n[n.FRAMEBUFFER_ATTACHMENT_TEXTURE_CUBE_MAP_FACE=36051]="FRAMEBUFFER_ATTACHMENT_TEXTURE_CUBE_MAP_FACE",n[n.COLOR_ATTACHMENT0=36064]="COLOR_ATTACHMENT0",n[n.DEPTH_ATTACHMENT=36096]="DEPTH_ATTACHMENT",n[n.STENCIL_ATTACHMENT=36128]="STENCIL_ATTACHMENT",n[n.DEPTH_STENCIL_ATTACHMENT=33306]="DEPTH_STENCIL_ATTACHMENT",n[n.NONE=0]="NONE",n[n.FRAMEBUFFER_COMPLETE=36053]="FRAMEBUFFER_COMPLETE",n[n.FRAMEBUFFER_INCOMPLETE_ATTACHMENT=36054]="FRAMEBUFFER_INCOMPLETE_ATTACHMENT",n[n.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT=36055]="FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT",n[n.FRAMEBUFFER_INCOMPLETE_DIMENSIONS=36057]="FRAMEBUFFER_INCOMPLETE_DIMENSIONS",n[n.FRAMEBUFFER_UNSUPPORTED=36061]="FRAMEBUFFER_UNSUPPORTED",n[n.FRAMEBUFFER_BINDING=36006]="FRAMEBUFFER_BINDING",n[n.RENDERBUFFER_BINDING=36007]="RENDERBUFFER_BINDING",n[n.READ_FRAMEBUFFER=36008]="READ_FRAMEBUFFER",n[n.DRAW_FRAMEBUFFER=36009]="DRAW_FRAMEBUFFER",n[n.MAX_RENDERBUFFER_SIZE=34024]="MAX_RENDERBUFFER_SIZE",n[n.INVALID_FRAMEBUFFER_OPERATION=1286]="INVALID_FRAMEBUFFER_OPERATION",n[n.UNPACK_FLIP_Y_WEBGL=37440]="UNPACK_FLIP_Y_WEBGL",n[n.UNPACK_PREMULTIPLY_ALPHA_WEBGL=37441]="UNPACK_PREMULTIPLY_ALPHA_WEBGL",n[n.UNPACK_COLORSPACE_CONVERSION_WEBGL=37443]="UNPACK_COLORSPACE_CONVERSION_WEBGL",n[n.READ_BUFFER=3074]="READ_BUFFER",n[n.UNPACK_ROW_LENGTH=3314]="UNPACK_ROW_LENGTH",n[n.UNPACK_SKIP_ROWS=3315]="UNPACK_SKIP_ROWS",n[n.UNPACK_SKIP_PIXELS=3316]="UNPACK_SKIP_PIXELS",n[n.PACK_ROW_LENGTH=3330]="PACK_ROW_LENGTH",n[n.PACK_SKIP_ROWS=3331]="PACK_SKIP_ROWS",n[n.PACK_SKIP_PIXELS=3332]="PACK_SKIP_PIXELS",n[n.TEXTURE_BINDING_3D=32874]="TEXTURE_BINDING_3D",n[n.UNPACK_SKIP_IMAGES=32877]="UNPACK_SKIP_IMAGES",n[n.UNPACK_IMAGE_HEIGHT=32878]="UNPACK_IMAGE_HEIGHT",n[n.MAX_3D_TEXTURE_SIZE=32883]="MAX_3D_TEXTURE_SIZE",n[n.MAX_ELEMENTS_VERTICES=33e3]="MAX_ELEMENTS_VERTICES",n[n.MAX_ELEMENTS_INDICES=33001]="MAX_ELEMENTS_INDICES",n[n.MAX_TEXTURE_LOD_BIAS=34045]="MAX_TEXTURE_LOD_BIAS",n[n.MAX_FRAGMENT_UNIFORM_COMPONENTS=35657]="MAX_FRAGMENT_UNIFORM_COMPONENTS",n[n.MAX_VERTEX_UNIFORM_COMPONENTS=35658]="MAX_VERTEX_UNIFORM_COMPONENTS",n[n.MAX_ARRAY_TEXTURE_LAYERS=35071]="MAX_ARRAY_TEXTURE_LAYERS",n[n.MIN_PROGRAM_TEXEL_OFFSET=35076]="MIN_PROGRAM_TEXEL_OFFSET",n[n.MAX_PROGRAM_TEXEL_OFFSET=35077]="MAX_PROGRAM_TEXEL_OFFSET",n[n.MAX_VARYING_COMPONENTS=35659]="MAX_VARYING_COMPONENTS",n[n.FRAGMENT_SHADER_DERIVATIVE_HINT=35723]="FRAGMENT_SHADER_DERIVATIVE_HINT",n[n.RASTERIZER_DISCARD=35977]="RASTERIZER_DISCARD",n[n.VERTEX_ARRAY_BINDING=34229]="VERTEX_ARRAY_BINDING",n[n.MAX_VERTEX_OUTPUT_COMPONENTS=37154]="MAX_VERTEX_OUTPUT_COMPONENTS",n[n.MAX_FRAGMENT_INPUT_COMPONENTS=37157]="MAX_FRAGMENT_INPUT_COMPONENTS",n[n.MAX_SERVER_WAIT_TIMEOUT=37137]="MAX_SERVER_WAIT_TIMEOUT",n[n.MAX_ELEMENT_INDEX=36203]="MAX_ELEMENT_INDEX",n[n.RED=6403]="RED",n[n.RGB8=32849]="RGB8",n[n.RGBA8=32856]="RGBA8",n[n.RGB10_A2=32857]="RGB10_A2",n[n.TEXTURE_3D=32879]="TEXTURE_3D",n[n.TEXTURE_WRAP_R=32882]="TEXTURE_WRAP_R",n[n.TEXTURE_MIN_LOD=33082]="TEXTURE_MIN_LOD",n[n.TEXTURE_MAX_LOD=33083]="TEXTURE_MAX_LOD",n[n.TEXTURE_BASE_LEVEL=33084]="TEXTURE_BASE_LEVEL",n[n.TEXTURE_MAX_LEVEL=33085]="TEXTURE_MAX_LEVEL",n[n.TEXTURE_COMPARE_MODE=34892]="TEXTURE_COMPARE_MODE",n[n.TEXTURE_COMPARE_FUNC=34893]="TEXTURE_COMPARE_FUNC",n[n.SRGB=35904]="SRGB",n[n.SRGB8=35905]="SRGB8",n[n.SRGB8_ALPHA8=35907]="SRGB8_ALPHA8",n[n.COMPARE_REF_TO_TEXTURE=34894]="COMPARE_REF_TO_TEXTURE",n[n.RGBA32F=34836]="RGBA32F",n[n.RGB32F=34837]="RGB32F",n[n.RGBA16F=34842]="RGBA16F",n[n.RGB16F=34843]="RGB16F",n[n.TEXTURE_2D_ARRAY=35866]="TEXTURE_2D_ARRAY",n[n.TEXTURE_BINDING_2D_ARRAY=35869]="TEXTURE_BINDING_2D_ARRAY",n[n.R11F_G11F_B10F=35898]="R11F_G11F_B10F",n[n.RGB9_E5=35901]="RGB9_E5",n[n.RGBA32UI=36208]="RGBA32UI",n[n.RGB32UI=36209]="RGB32UI",n[n.RGBA16UI=36214]="RGBA16UI",n[n.RGB16UI=36215]="RGB16UI",n[n.RGBA8UI=36220]="RGBA8UI",n[n.RGB8UI=36221]="RGB8UI",n[n.RGBA32I=36226]="RGBA32I",n[n.RGB32I=36227]="RGB32I",n[n.RGBA16I=36232]="RGBA16I",n[n.RGB16I=36233]="RGB16I",n[n.RGBA8I=36238]="RGBA8I",n[n.RGB8I=36239]="RGB8I",n[n.RED_INTEGER=36244]="RED_INTEGER",n[n.RGB_INTEGER=36248]="RGB_INTEGER",n[n.RGBA_INTEGER=36249]="RGBA_INTEGER",n[n.R8=33321]="R8",n[n.RG8=33323]="RG8",n[n.R16F=33325]="R16F",n[n.R32F=33326]="R32F",n[n.RG16F=33327]="RG16F",n[n.RG32F=33328]="RG32F",n[n.R8I=33329]="R8I",n[n.R8UI=33330]="R8UI",n[n.R16I=33331]="R16I",n[n.R16UI=33332]="R16UI",n[n.R32I=33333]="R32I",n[n.R32UI=33334]="R32UI",n[n.RG8I=33335]="RG8I",n[n.RG8UI=33336]="RG8UI",n[n.RG16I=33337]="RG16I",n[n.RG16UI=33338]="RG16UI",n[n.RG32I=33339]="RG32I",n[n.RG32UI=33340]="RG32UI",n[n.R8_SNORM=36756]="R8_SNORM",n[n.RG8_SNORM=36757]="RG8_SNORM",n[n.RGB8_SNORM=36758]="RGB8_SNORM",n[n.RGBA8_SNORM=36759]="RGBA8_SNORM",n[n.RGB10_A2UI=36975]="RGB10_A2UI",n[n.TEXTURE_IMMUTABLE_FORMAT=37167]="TEXTURE_IMMUTABLE_FORMAT",n[n.TEXTURE_IMMUTABLE_LEVELS=33503]="TEXTURE_IMMUTABLE_LEVELS",n[n.UNSIGNED_INT_2_10_10_10_REV=33640]="UNSIGNED_INT_2_10_10_10_REV",n[n.UNSIGNED_INT_10F_11F_11F_REV=35899]="UNSIGNED_INT_10F_11F_11F_REV",n[n.UNSIGNED_INT_5_9_9_9_REV=35902]="UNSIGNED_INT_5_9_9_9_REV",n[n.FLOAT_32_UNSIGNED_INT_24_8_REV=36269]="FLOAT_32_UNSIGNED_INT_24_8_REV",n[n.UNSIGNED_INT_24_8=34042]="UNSIGNED_INT_24_8",n[n.HALF_FLOAT=5131]="HALF_FLOAT",n[n.RG=33319]="RG",n[n.RG_INTEGER=33320]="RG_INTEGER",n[n.INT_2_10_10_10_REV=36255]="INT_2_10_10_10_REV",n[n.CURRENT_QUERY=34917]="CURRENT_QUERY",n[n.QUERY_RESULT=34918]="QUERY_RESULT",n[n.QUERY_RESULT_AVAILABLE=34919]="QUERY_RESULT_AVAILABLE",n[n.ANY_SAMPLES_PASSED=35887]="ANY_SAMPLES_PASSED",n[n.ANY_SAMPLES_PASSED_CONSERVATIVE=36202]="ANY_SAMPLES_PASSED_CONSERVATIVE",n[n.MAX_DRAW_BUFFERS=34852]="MAX_DRAW_BUFFERS",n[n.DRAW_BUFFER0=34853]="DRAW_BUFFER0",n[n.DRAW_BUFFER1=34854]="DRAW_BUFFER1",n[n.DRAW_BUFFER2=34855]="DRAW_BUFFER2",n[n.DRAW_BUFFER3=34856]="DRAW_BUFFER3",n[n.DRAW_BUFFER4=34857]="DRAW_BUFFER4",n[n.DRAW_BUFFER5=34858]="DRAW_BUFFER5",n[n.DRAW_BUFFER6=34859]="DRAW_BUFFER6",n[n.DRAW_BUFFER7=34860]="DRAW_BUFFER7",n[n.DRAW_BUFFER8=34861]="DRAW_BUFFER8",n[n.DRAW_BUFFER9=34862]="DRAW_BUFFER9",n[n.DRAW_BUFFER10=34863]="DRAW_BUFFER10",n[n.DRAW_BUFFER11=34864]="DRAW_BUFFER11",n[n.DRAW_BUFFER12=34865]="DRAW_BUFFER12",n[n.DRAW_BUFFER13=34866]="DRAW_BUFFER13",n[n.DRAW_BUFFER14=34867]="DRAW_BUFFER14",n[n.DRAW_BUFFER15=34868]="DRAW_BUFFER15",n[n.MAX_COLOR_ATTACHMENTS=36063]="MAX_COLOR_ATTACHMENTS",n[n.COLOR_ATTACHMENT1=36065]="COLOR_ATTACHMENT1",n[n.COLOR_ATTACHMENT2=36066]="COLOR_ATTACHMENT2",n[n.COLOR_ATTACHMENT3=36067]="COLOR_ATTACHMENT3",n[n.COLOR_ATTACHMENT4=36068]="COLOR_ATTACHMENT4",n[n.COLOR_ATTACHMENT5=36069]="COLOR_ATTACHMENT5",n[n.COLOR_ATTACHMENT6=36070]="COLOR_ATTACHMENT6",n[n.COLOR_ATTACHMENT7=36071]="COLOR_ATTACHMENT7",n[n.COLOR_ATTACHMENT8=36072]="COLOR_ATTACHMENT8",n[n.COLOR_ATTACHMENT9=36073]="COLOR_ATTACHMENT9",n[n.COLOR_ATTACHMENT10=36074]="COLOR_ATTACHMENT10",n[n.COLOR_ATTACHMENT11=36075]="COLOR_ATTACHMENT11",n[n.COLOR_ATTACHMENT12=36076]="COLOR_ATTACHMENT12",n[n.COLOR_ATTACHMENT13=36077]="COLOR_ATTACHMENT13",n[n.COLOR_ATTACHMENT14=36078]="COLOR_ATTACHMENT14",n[n.COLOR_ATTACHMENT15=36079]="COLOR_ATTACHMENT15",n[n.SAMPLER_3D=35679]="SAMPLER_3D",n[n.SAMPLER_2D_SHADOW=35682]="SAMPLER_2D_SHADOW",n[n.SAMPLER_2D_ARRAY=36289]="SAMPLER_2D_ARRAY",n[n.SAMPLER_2D_ARRAY_SHADOW=36292]="SAMPLER_2D_ARRAY_SHADOW",n[n.SAMPLER_CUBE_SHADOW=36293]="SAMPLER_CUBE_SHADOW",n[n.INT_SAMPLER_2D=36298]="INT_SAMPLER_2D",n[n.INT_SAMPLER_3D=36299]="INT_SAMPLER_3D",n[n.INT_SAMPLER_CUBE=36300]="INT_SAMPLER_CUBE",n[n.INT_SAMPLER_2D_ARRAY=36303]="INT_SAMPLER_2D_ARRAY",n[n.UNSIGNED_INT_SAMPLER_2D=36306]="UNSIGNED_INT_SAMPLER_2D",n[n.UNSIGNED_INT_SAMPLER_3D=36307]="UNSIGNED_INT_SAMPLER_3D",n[n.UNSIGNED_INT_SAMPLER_CUBE=36308]="UNSIGNED_INT_SAMPLER_CUBE",n[n.UNSIGNED_INT_SAMPLER_2D_ARRAY=36311]="UNSIGNED_INT_SAMPLER_2D_ARRAY",n[n.MAX_SAMPLES=36183]="MAX_SAMPLES",n[n.SAMPLER_BINDING=35097]="SAMPLER_BINDING",n[n.PIXEL_PACK_BUFFER=35051]="PIXEL_PACK_BUFFER",n[n.PIXEL_UNPACK_BUFFER=35052]="PIXEL_UNPACK_BUFFER",n[n.PIXEL_PACK_BUFFER_BINDING=35053]="PIXEL_PACK_BUFFER_BINDING",n[n.PIXEL_UNPACK_BUFFER_BINDING=35055]="PIXEL_UNPACK_BUFFER_BINDING",n[n.COPY_READ_BUFFER=36662]="COPY_READ_BUFFER",n[n.COPY_WRITE_BUFFER=36663]="COPY_WRITE_BUFFER",n[n.COPY_READ_BUFFER_BINDING=36662]="COPY_READ_BUFFER_BINDING",n[n.COPY_WRITE_BUFFER_BINDING=36663]="COPY_WRITE_BUFFER_BINDING",n[n.FLOAT_MAT2x3=35685]="FLOAT_MAT2x3",n[n.FLOAT_MAT2x4=35686]="FLOAT_MAT2x4",n[n.FLOAT_MAT3x2=35687]="FLOAT_MAT3x2",n[n.FLOAT_MAT3x4=35688]="FLOAT_MAT3x4",n[n.FLOAT_MAT4x2=35689]="FLOAT_MAT4x2",n[n.FLOAT_MAT4x3=35690]="FLOAT_MAT4x3",n[n.UNSIGNED_INT_VEC2=36294]="UNSIGNED_INT_VEC2",n[n.UNSIGNED_INT_VEC3=36295]="UNSIGNED_INT_VEC3",n[n.UNSIGNED_INT_VEC4=36296]="UNSIGNED_INT_VEC4",n[n.UNSIGNED_NORMALIZED=35863]="UNSIGNED_NORMALIZED",n[n.SIGNED_NORMALIZED=36764]="SIGNED_NORMALIZED",n[n.VERTEX_ATTRIB_ARRAY_INTEGER=35069]="VERTEX_ATTRIB_ARRAY_INTEGER",n[n.VERTEX_ATTRIB_ARRAY_DIVISOR=35070]="VERTEX_ATTRIB_ARRAY_DIVISOR",n[n.TRANSFORM_FEEDBACK_BUFFER_MODE=35967]="TRANSFORM_FEEDBACK_BUFFER_MODE",n[n.MAX_TRANSFORM_FEEDBACK_SEPARATE_COMPONENTS=35968]="MAX_TRANSFORM_FEEDBACK_SEPARATE_COMPONENTS",n[n.TRANSFORM_FEEDBACK_VARYINGS=35971]="TRANSFORM_FEEDBACK_VARYINGS",n[n.TRANSFORM_FEEDBACK_BUFFER_START=35972]="TRANSFORM_FEEDBACK_BUFFER_START",n[n.TRANSFORM_FEEDBACK_BUFFER_SIZE=35973]="TRANSFORM_FEEDBACK_BUFFER_SIZE",n[n.TRANSFORM_FEEDBACK_PRIMITIVES_WRITTEN=35976]="TRANSFORM_FEEDBACK_PRIMITIVES_WRITTEN",n[n.MAX_TRANSFORM_FEEDBACK_INTERLEAVED_COMPONENTS=35978]="MAX_TRANSFORM_FEEDBACK_INTERLEAVED_COMPONENTS",n[n.MAX_TRANSFORM_FEEDBACK_SEPARATE_ATTRIBS=35979]="MAX_TRANSFORM_FEEDBACK_SEPARATE_ATTRIBS",n[n.INTERLEAVED_ATTRIBS=35980]="INTERLEAVED_ATTRIBS",n[n.SEPARATE_ATTRIBS=35981]="SEPARATE_ATTRIBS",n[n.TRANSFORM_FEEDBACK_BUFFER=35982]="TRANSFORM_FEEDBACK_BUFFER",n[n.TRANSFORM_FEEDBACK_BUFFER_BINDING=35983]="TRANSFORM_FEEDBACK_BUFFER_BINDING",n[n.TRANSFORM_FEEDBACK=36386]="TRANSFORM_FEEDBACK",n[n.TRANSFORM_FEEDBACK_PAUSED=36387]="TRANSFORM_FEEDBACK_PAUSED",n[n.TRANSFORM_FEEDBACK_ACTIVE=36388]="TRANSFORM_FEEDBACK_ACTIVE",n[n.TRANSFORM_FEEDBACK_BINDING=36389]="TRANSFORM_FEEDBACK_BINDING",n[n.FRAMEBUFFER_ATTACHMENT_COLOR_ENCODING=33296]="FRAMEBUFFER_ATTACHMENT_COLOR_ENCODING",n[n.FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE=33297]="FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE",n[n.FRAMEBUFFER_ATTACHMENT_RED_SIZE=33298]="FRAMEBUFFER_ATTACHMENT_RED_SIZE",n[n.FRAMEBUFFER_ATTACHMENT_GREEN_SIZE=33299]="FRAMEBUFFER_ATTACHMENT_GREEN_SIZE",n[n.FRAMEBUFFER_ATTACHMENT_BLUE_SIZE=33300]="FRAMEBUFFER_ATTACHMENT_BLUE_SIZE",n[n.FRAMEBUFFER_ATTACHMENT_ALPHA_SIZE=33301]="FRAMEBUFFER_ATTACHMENT_ALPHA_SIZE",n[n.FRAMEBUFFER_ATTACHMENT_DEPTH_SIZE=33302]="FRAMEBUFFER_ATTACHMENT_DEPTH_SIZE",n[n.FRAMEBUFFER_ATTACHMENT_STENCIL_SIZE=33303]="FRAMEBUFFER_ATTACHMENT_STENCIL_SIZE",n[n.FRAMEBUFFER_DEFAULT=33304]="FRAMEBUFFER_DEFAULT",n[n.DEPTH24_STENCIL8=35056]="DEPTH24_STENCIL8",n[n.DRAW_FRAMEBUFFER_BINDING=36006]="DRAW_FRAMEBUFFER_BINDING",n[n.READ_FRAMEBUFFER_BINDING=36010]="READ_FRAMEBUFFER_BINDING",n[n.RENDERBUFFER_SAMPLES=36011]="RENDERBUFFER_SAMPLES",n[n.FRAMEBUFFER_ATTACHMENT_TEXTURE_LAYER=36052]="FRAMEBUFFER_ATTACHMENT_TEXTURE_LAYER",n[n.FRAMEBUFFER_INCOMPLETE_MULTISAMPLE=36182]="FRAMEBUFFER_INCOMPLETE_MULTISAMPLE",n[n.UNIFORM_BUFFER=35345]="UNIFORM_BUFFER",n[n.UNIFORM_BUFFER_BINDING=35368]="UNIFORM_BUFFER_BINDING",n[n.UNIFORM_BUFFER_START=35369]="UNIFORM_BUFFER_START",n[n.UNIFORM_BUFFER_SIZE=35370]="UNIFORM_BUFFER_SIZE",n[n.MAX_VERTEX_UNIFORM_BLOCKS=35371]="MAX_VERTEX_UNIFORM_BLOCKS",n[n.MAX_FRAGMENT_UNIFORM_BLOCKS=35373]="MAX_FRAGMENT_UNIFORM_BLOCKS",n[n.MAX_COMBINED_UNIFORM_BLOCKS=35374]="MAX_COMBINED_UNIFORM_BLOCKS",n[n.MAX_UNIFORM_BUFFER_BINDINGS=35375]="MAX_UNIFORM_BUFFER_BINDINGS",n[n.MAX_UNIFORM_BLOCK_SIZE=35376]="MAX_UNIFORM_BLOCK_SIZE",n[n.MAX_COMBINED_VERTEX_UNIFORM_COMPONENTS=35377]="MAX_COMBINED_VERTEX_UNIFORM_COMPONENTS",n[n.MAX_COMBINED_FRAGMENT_UNIFORM_COMPONENTS=35379]="MAX_COMBINED_FRAGMENT_UNIFORM_COMPONENTS",n[n.UNIFORM_BUFFER_OFFSET_ALIGNMENT=35380]="UNIFORM_BUFFER_OFFSET_ALIGNMENT",n[n.ACTIVE_UNIFORM_BLOCKS=35382]="ACTIVE_UNIFORM_BLOCKS",n[n.UNIFORM_TYPE=35383]="UNIFORM_TYPE",n[n.UNIFORM_SIZE=35384]="UNIFORM_SIZE",n[n.UNIFORM_BLOCK_INDEX=35386]="UNIFORM_BLOCK_INDEX",n[n.UNIFORM_OFFSET=35387]="UNIFORM_OFFSET",n[n.UNIFORM_ARRAY_STRIDE=35388]="UNIFORM_ARRAY_STRIDE",n[n.UNIFORM_MATRIX_STRIDE=35389]="UNIFORM_MATRIX_STRIDE",n[n.UNIFORM_IS_ROW_MAJOR=35390]="UNIFORM_IS_ROW_MAJOR",n[n.UNIFORM_BLOCK_BINDING=35391]="UNIFORM_BLOCK_BINDING",n[n.UNIFORM_BLOCK_DATA_SIZE=35392]="UNIFORM_BLOCK_DATA_SIZE",n[n.UNIFORM_BLOCK_ACTIVE_UNIFORMS=35394]="UNIFORM_BLOCK_ACTIVE_UNIFORMS",n[n.UNIFORM_BLOCK_ACTIVE_UNIFORM_INDICES=35395]="UNIFORM_BLOCK_ACTIVE_UNIFORM_INDICES",n[n.UNIFORM_BLOCK_REFERENCED_BY_VERTEX_SHADER=35396]="UNIFORM_BLOCK_REFERENCED_BY_VERTEX_SHADER",n[n.UNIFORM_BLOCK_REFERENCED_BY_FRAGMENT_SHADER=35398]="UNIFORM_BLOCK_REFERENCED_BY_FRAGMENT_SHADER",n[n.OBJECT_TYPE=37138]="OBJECT_TYPE",n[n.SYNC_CONDITION=37139]="SYNC_CONDITION",n[n.SYNC_STATUS=37140]="SYNC_STATUS",n[n.SYNC_FLAGS=37141]="SYNC_FLAGS",n[n.SYNC_FENCE=37142]="SYNC_FENCE",n[n.SYNC_GPU_COMMANDS_COMPLETE=37143]="SYNC_GPU_COMMANDS_COMPLETE",n[n.UNSIGNALED=37144]="UNSIGNALED",n[n.SIGNALED=37145]="SIGNALED",n[n.ALREADY_SIGNALED=37146]="ALREADY_SIGNALED",n[n.TIMEOUT_EXPIRED=37147]="TIMEOUT_EXPIRED",n[n.CONDITION_SATISFIED=37148]="CONDITION_SATISFIED",n[n.WAIT_FAILED=37149]="WAIT_FAILED",n[n.SYNC_FLUSH_COMMANDS_BIT=1]="SYNC_FLUSH_COMMANDS_BIT",n[n.COLOR=6144]="COLOR",n[n.DEPTH=6145]="DEPTH",n[n.STENCIL=6146]="STENCIL",n[n.MIN=32775]="MIN",n[n.MAX=32776]="MAX",n[n.DEPTH_COMPONENT24=33190]="DEPTH_COMPONENT24",n[n.STREAM_READ=35041]="STREAM_READ",n[n.STREAM_COPY=35042]="STREAM_COPY",n[n.STATIC_READ=35045]="STATIC_READ",n[n.STATIC_COPY=35046]="STATIC_COPY",n[n.DYNAMIC_READ=35049]="DYNAMIC_READ",n[n.DYNAMIC_COPY=35050]="DYNAMIC_COPY",n[n.DEPTH_COMPONENT32F=36012]="DEPTH_COMPONENT32F",n[n.DEPTH32F_STENCIL8=36013]="DEPTH32F_STENCIL8",n[n.INVALID_INDEX=4294967295]="INVALID_INDEX",n[n.TIMEOUT_IGNORED=-1]="TIMEOUT_IGNORED",n[n.MAX_CLIENT_WAIT_TIMEOUT_WEBGL=37447]="MAX_CLIENT_WAIT_TIMEOUT_WEBGL",n[n.UNMASKED_VENDOR_WEBGL=37445]="UNMASKED_VENDOR_WEBGL",n[n.UNMASKED_RENDERER_WEBGL=37446]="UNMASKED_RENDERER_WEBGL",n[n.MAX_TEXTURE_MAX_ANISOTROPY_EXT=34047]="MAX_TEXTURE_MAX_ANISOTROPY_EXT",n[n.TEXTURE_MAX_ANISOTROPY_EXT=34046]="TEXTURE_MAX_ANISOTROPY_EXT",n[n.R16_EXT=33322]="R16_EXT",n[n.RG16_EXT=33324]="RG16_EXT",n[n.RGB16_EXT=32852]="RGB16_EXT",n[n.RGBA16_EXT=32859]="RGBA16_EXT",n[n.R16_SNORM_EXT=36760]="R16_SNORM_EXT",n[n.RG16_SNORM_EXT=36761]="RG16_SNORM_EXT",n[n.RGB16_SNORM_EXT=36762]="RGB16_SNORM_EXT",n[n.RGBA16_SNORM_EXT=36763]="RGBA16_SNORM_EXT",n[n.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",n[n.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",n[n.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",n[n.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",n[n.COMPRESSED_SRGB_S3TC_DXT1_EXT=35916]="COMPRESSED_SRGB_S3TC_DXT1_EXT",n[n.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917]="COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT",n[n.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918]="COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT",n[n.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919]="COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT",n[n.COMPRESSED_RED_RGTC1_EXT=36283]="COMPRESSED_RED_RGTC1_EXT",n[n.COMPRESSED_SIGNED_RED_RGTC1_EXT=36284]="COMPRESSED_SIGNED_RED_RGTC1_EXT",n[n.COMPRESSED_RED_GREEN_RGTC2_EXT=36285]="COMPRESSED_RED_GREEN_RGTC2_EXT",n[n.COMPRESSED_SIGNED_RED_GREEN_RGTC2_EXT=36286]="COMPRESSED_SIGNED_RED_GREEN_RGTC2_EXT",n[n.COMPRESSED_RGBA_BPTC_UNORM_EXT=36492]="COMPRESSED_RGBA_BPTC_UNORM_EXT",n[n.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT=36493]="COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT",n[n.COMPRESSED_RGB_BPTC_SIGNED_FLOAT_EXT=36494]="COMPRESSED_RGB_BPTC_SIGNED_FLOAT_EXT",n[n.COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT_EXT=36495]="COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT_EXT",n[n.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",n[n.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",n[n.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",n[n.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",n[n.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",n[n.COMPRESSED_RGBA8_ETC2_EAC=37493]="COMPRESSED_RGBA8_ETC2_EAC",n[n.COMPRESSED_SRGB8_ETC2=37494]="COMPRESSED_SRGB8_ETC2",n[n.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37495]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC",n[n.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37496]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",n[n.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37497]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",n[n.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",n[n.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",n[n.COMPRESSED_RGB_PVRTC_2BPPV1_IMG=35841]="COMPRESSED_RGB_PVRTC_2BPPV1_IMG",n[n.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG=35843]="COMPRESSED_RGBA_PVRTC_2BPPV1_IMG",n[n.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",n[n.COMPRESSED_RGB_ATC_WEBGL=35986]="COMPRESSED_RGB_ATC_WEBGL",n[n.COMPRESSED_RGBA_ATC_EXPLICIT_ALPHA_WEBGL=35986]="COMPRESSED_RGBA_ATC_EXPLICIT_ALPHA_WEBGL",n[n.COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL=34798]="COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL",n[n.COMPRESSED_RGBA_ASTC_4x4_KHR=37808]="COMPRESSED_RGBA_ASTC_4x4_KHR",n[n.COMPRESSED_RGBA_ASTC_5x4_KHR=37809]="COMPRESSED_RGBA_ASTC_5x4_KHR",n[n.COMPRESSED_RGBA_ASTC_5x5_KHR=37810]="COMPRESSED_RGBA_ASTC_5x5_KHR",n[n.COMPRESSED_RGBA_ASTC_6x5_KHR=37811]="COMPRESSED_RGBA_ASTC_6x5_KHR",n[n.COMPRESSED_RGBA_ASTC_6x6_KHR=37812]="COMPRESSED_RGBA_ASTC_6x6_KHR",n[n.COMPRESSED_RGBA_ASTC_8x5_KHR=37813]="COMPRESSED_RGBA_ASTC_8x5_KHR",n[n.COMPRESSED_RGBA_ASTC_8x6_KHR=37814]="COMPRESSED_RGBA_ASTC_8x6_KHR",n[n.COMPRESSED_RGBA_ASTC_8x8_KHR=37815]="COMPRESSED_RGBA_ASTC_8x8_KHR",n[n.COMPRESSED_RGBA_ASTC_10x5_KHR=37816]="COMPRESSED_RGBA_ASTC_10x5_KHR",n[n.COMPRESSED_RGBA_ASTC_10x6_KHR=37817]="COMPRESSED_RGBA_ASTC_10x6_KHR",n[n.COMPRESSED_RGBA_ASTC_10x8_KHR=37818]="COMPRESSED_RGBA_ASTC_10x8_KHR",n[n.COMPRESSED_RGBA_ASTC_10x10_KHR=37819]="COMPRESSED_RGBA_ASTC_10x10_KHR",n[n.COMPRESSED_RGBA_ASTC_12x10_KHR=37820]="COMPRESSED_RGBA_ASTC_12x10_KHR",n[n.COMPRESSED_RGBA_ASTC_12x12_KHR=37821]="COMPRESSED_RGBA_ASTC_12x12_KHR",n[n.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840]="COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR",n[n.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR=37841]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR",n[n.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR=37842]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR",n[n.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR=37843]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR",n[n.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR=37844]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR",n[n.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR=37845]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR",n[n.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR=37846]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR",n[n.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR=37847]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR",n[n.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR=37848]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR",n[n.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR=37849]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR",n[n.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR=37850]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR",n[n.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR=37851]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR",n[n.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR=37852]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR",n[n.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR=37853]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR",n[n.QUERY_COUNTER_BITS_EXT=34916]="QUERY_COUNTER_BITS_EXT",n[n.CURRENT_QUERY_EXT=34917]="CURRENT_QUERY_EXT",n[n.QUERY_RESULT_EXT=34918]="QUERY_RESULT_EXT",n[n.QUERY_RESULT_AVAILABLE_EXT=34919]="QUERY_RESULT_AVAILABLE_EXT",n[n.TIME_ELAPSED_EXT=35007]="TIME_ELAPSED_EXT",n[n.TIMESTAMP_EXT=36392]="TIMESTAMP_EXT",n[n.GPU_DISJOINT_EXT=36795]="GPU_DISJOINT_EXT",n[n.COMPLETION_STATUS_KHR=37297]="COMPLETION_STATUS_KHR",n[n.DEPTH_CLAMP_EXT=34383]="DEPTH_CLAMP_EXT",n[n.FIRST_VERTEX_CONVENTION_WEBGL=36429]="FIRST_VERTEX_CONVENTION_WEBGL",n[n.LAST_VERTEX_CONVENTION_WEBGL=36430]="LAST_VERTEX_CONVENTION_WEBGL",n[n.PROVOKING_VERTEX_WEBL=36431]="PROVOKING_VERTEX_WEBL",n[n.POLYGON_MODE_WEBGL=2880]="POLYGON_MODE_WEBGL",n[n.POLYGON_OFFSET_LINE_WEBGL=10754]="POLYGON_OFFSET_LINE_WEBGL",n[n.LINE_WEBGL=6913]="LINE_WEBGL",n[n.FILL_WEBGL=6914]="FILL_WEBGL",n[n.MAX_CLIP_DISTANCES_WEBGL=3378]="MAX_CLIP_DISTANCES_WEBGL",n[n.MAX_CULL_DISTANCES_WEBGL=33529]="MAX_CULL_DISTANCES_WEBGL",n[n.MAX_COMBINED_CLIP_AND_CULL_DISTANCES_WEBGL=33530]="MAX_COMBINED_CLIP_AND_CULL_DISTANCES_WEBGL",n[n.CLIP_DISTANCE0_WEBGL=12288]="CLIP_DISTANCE0_WEBGL",n[n.CLIP_DISTANCE1_WEBGL=12289]="CLIP_DISTANCE1_WEBGL",n[n.CLIP_DISTANCE2_WEBGL=12290]="CLIP_DISTANCE2_WEBGL",n[n.CLIP_DISTANCE3_WEBGL=12291]="CLIP_DISTANCE3_WEBGL",n[n.CLIP_DISTANCE4_WEBGL=12292]="CLIP_DISTANCE4_WEBGL",n[n.CLIP_DISTANCE5_WEBGL=12293]="CLIP_DISTANCE5_WEBGL",n[n.CLIP_DISTANCE6_WEBGL=12294]="CLIP_DISTANCE6_WEBGL",n[n.CLIP_DISTANCE7_WEBGL=12295]="CLIP_DISTANCE7_WEBGL",n[n.POLYGON_OFFSET_CLAMP_EXT=36379]="POLYGON_OFFSET_CLAMP_EXT",n[n.LOWER_LEFT_EXT=36001]="LOWER_LEFT_EXT",n[n.UPPER_LEFT_EXT=36002]="UPPER_LEFT_EXT",n[n.NEGATIVE_ONE_TO_ONE_EXT=37726]="NEGATIVE_ONE_TO_ONE_EXT",n[n.ZERO_TO_ONE_EXT=37727]="ZERO_TO_ONE_EXT",n[n.CLIP_ORIGIN_EXT=37724]="CLIP_ORIGIN_EXT",n[n.CLIP_DEPTH_MODE_EXT=37725]="CLIP_DEPTH_MODE_EXT",n[n.SRC1_COLOR_WEBGL=35065]="SRC1_COLOR_WEBGL",n[n.SRC1_ALPHA_WEBGL=34185]="SRC1_ALPHA_WEBGL",n[n.ONE_MINUS_SRC1_COLOR_WEBGL=35066]="ONE_MINUS_SRC1_COLOR_WEBGL",n[n.ONE_MINUS_SRC1_ALPHA_WEBGL=35067]="ONE_MINUS_SRC1_ALPHA_WEBGL",n[n.MAX_DUAL_SOURCE_DRAW_BUFFERS_WEBGL=35068]="MAX_DUAL_SOURCE_DRAW_BUFFERS_WEBGL",n[n.MIRROR_CLAMP_TO_EDGE_EXT=34627]="MIRROR_CLAMP_TO_EDGE_EXT"})(Un||(Un={}));const tu={3042:!1,32773:new Float32Array([0,0,0,0]),32777:32774,34877:32774,32969:1,32968:0,32971:1,32970:0,3106:new Float32Array([0,0,0,0]),3107:[!0,!0,!0,!0],2884:!1,2885:1029,2929:!1,2931:1,2932:513,2928:new Float32Array([0,1]),2930:!0,3024:!0,35725:null,36006:null,36007:null,34229:null,34964:null,2886:2305,33170:4352,2849:1,32823:!1,32824:0,10752:0,32926:!1,32928:!1,32938:1,32939:!1,3089:!1,3088:new Int32Array([0,0,1024,1024]),2960:!1,2961:0,2968:4294967295,36005:4294967295,2962:519,2967:0,2963:4294967295,34816:519,36003:0,36004:4294967295,2964:7680,2965:7680,2966:7680,34817:7680,34818:7680,34819:7680,2978:[0,0,1024,1024],36389:null,36662:null,36663:null,35053:null,35055:null,35723:4352,36010:null,35977:!1,3333:4,3317:4,37440:!1,37441:!1,37443:37444,3330:0,3332:0,3331:0,3314:0,32878:0,3316:0,3315:0,32877:0},_e=(n,e,t)=>e?n.enable(t):n.disable(t),zh=(n,e,t)=>n.hint(t,e),We=(n,e,t)=>n.pixelStorei(t,e),Vh=(n,e,t)=>{const i=t===36006?36009:36008;return n.bindFramebuffer(i,e)},pi=(n,e,t)=>{const r={34964:34962,36662:36662,36663:36663,35053:35051,35055:35052}[t];n.bindBuffer(r,e)};function fa(n){return Array.isArray(n)||ArrayBuffer.isView(n)&&!(n instanceof DataView)}const zP={3042:_e,32773:(n,e)=>n.blendColor(...e),32777:"blendEquation",34877:"blendEquation",32969:"blendFunc",32968:"blendFunc",32971:"blendFunc",32970:"blendFunc",3106:(n,e)=>n.clearColor(...e),3107:(n,e)=>n.colorMask(...e),2884:_e,2885:(n,e)=>n.cullFace(e),2929:_e,2931:(n,e)=>n.clearDepth(e),2932:(n,e)=>n.depthFunc(e),2928:(n,e)=>n.depthRange(...e),2930:(n,e)=>n.depthMask(e),3024:_e,35723:zh,35725:(n,e)=>n.useProgram(e),36007:(n,e)=>n.bindRenderbuffer(36161,e),36389:(n,e)=>{var t;return(t=n.bindTransformFeedback)==null?void 0:t.call(n,36386,e)},34229:(n,e)=>n.bindVertexArray(e),36006:Vh,36010:Vh,34964:pi,36662:pi,36663:pi,35053:pi,35055:pi,2886:(n,e)=>n.frontFace(e),33170:zh,2849:(n,e)=>n.lineWidth(e),32823:_e,32824:"polygonOffset",10752:"polygonOffset",35977:_e,32926:_e,32928:_e,32938:"sampleCoverage",32939:"sampleCoverage",3089:_e,3088:(n,e)=>n.scissor(...e),2960:_e,2961:(n,e)=>n.clearStencil(e),2968:(n,e)=>n.stencilMaskSeparate(1028,e),36005:(n,e)=>n.stencilMaskSeparate(1029,e),2962:"stencilFuncFront",2967:"stencilFuncFront",2963:"stencilFuncFront",34816:"stencilFuncBack",36003:"stencilFuncBack",36004:"stencilFuncBack",2964:"stencilOpFront",2965:"stencilOpFront",2966:"stencilOpFront",34817:"stencilOpBack",34818:"stencilOpBack",34819:"stencilOpBack",2978:(n,e)=>n.viewport(...e),34383:_e,10754:_e,12288:_e,12289:_e,12290:_e,12291:_e,12292:_e,12293:_e,12294:_e,12295:_e,3333:We,3317:We,37440:We,37441:We,37443:We,3330:We,3332:We,3331:We,3314:We,32878:We,3316:We,3315:We,32877:We,framebuffer:(n,e)=>{const t=e&&"handle"in e?e.handle:e;return n.bindFramebuffer(36160,t)},blend:(n,e)=>e?n.enable(3042):n.disable(3042),blendColor:(n,e)=>n.blendColor(...e),blendEquation:(n,e)=>{const t=typeof e=="number"?[e,e]:e;n.blendEquationSeparate(...t)},blendFunc:(n,e)=>{const t=(e==null?void 0:e.length)===2?[...e,...e]:e;n.blendFuncSeparate(...t)},clearColor:(n,e)=>n.clearColor(...e),clearDepth:(n,e)=>n.clearDepth(e),clearStencil:(n,e)=>n.clearStencil(e),colorMask:(n,e)=>n.colorMask(...e),cull:(n,e)=>e?n.enable(2884):n.disable(2884),cullFace:(n,e)=>n.cullFace(e),depthTest:(n,e)=>e?n.enable(2929):n.disable(2929),depthFunc:(n,e)=>n.depthFunc(e),depthMask:(n,e)=>n.depthMask(e),depthRange:(n,e)=>n.depthRange(...e),dither:(n,e)=>e?n.enable(3024):n.disable(3024),derivativeHint:(n,e)=>{n.hint(35723,e)},frontFace:(n,e)=>n.frontFace(e),mipmapHint:(n,e)=>n.hint(33170,e),lineWidth:(n,e)=>n.lineWidth(e),polygonOffsetFill:(n,e)=>e?n.enable(32823):n.disable(32823),polygonOffset:(n,e)=>n.polygonOffset(...e),sampleCoverage:(n,e)=>n.sampleCoverage(e[0],e[1]||!1),scissorTest:(n,e)=>e?n.enable(3089):n.disable(3089),scissor:(n,e)=>n.scissor(...e),stencilTest:(n,e)=>e?n.enable(2960):n.disable(2960),stencilMask:(n,e)=>{e=fa(e)?e:[e,e];const[t,i]=e;n.stencilMaskSeparate(1028,t),n.stencilMaskSeparate(1029,i)},stencilFunc:(n,e)=>{e=fa(e)&&e.length===3?[...e,...e]:e;const[t,i,r,s,o,a]=e;n.stencilFuncSeparate(1028,t,i,r),n.stencilFuncSeparate(1029,s,o,a)},stencilOp:(n,e)=>{e=fa(e)&&e.length===3?[...e,...e]:e;const[t,i,r,s,o,a]=e;n.stencilOpSeparate(1028,t,i,r),n.stencilOpSeparate(1029,s,o,a)},viewport:(n,e)=>n.viewport(...e)};function he(n,e,t){return e[n]!==void 0?e[n]:t[n]}const VP={blendEquation:(n,e,t)=>n.blendEquationSeparate(he(32777,e,t),he(34877,e,t)),blendFunc:(n,e,t)=>n.blendFuncSeparate(he(32969,e,t),he(32968,e,t),he(32971,e,t),he(32970,e,t)),polygonOffset:(n,e,t)=>n.polygonOffset(he(32824,e,t),he(10752,e,t)),sampleCoverage:(n,e,t)=>n.sampleCoverage(he(32938,e,t),he(32939,e,t)),stencilFuncFront:(n,e,t)=>n.stencilFuncSeparate(1028,he(2962,e,t),he(2967,e,t),he(2963,e,t)),stencilFuncBack:(n,e,t)=>n.stencilFuncSeparate(1029,he(34816,e,t),he(36003,e,t),he(36004,e,t)),stencilOpFront:(n,e,t)=>n.stencilOpSeparate(1028,he(2964,e,t),he(2965,e,t),he(2966,e,t)),stencilOpBack:(n,e,t)=>n.stencilOpSeparate(1029,he(34817,e,t),he(34818,e,t),he(34819,e,t))},Wh={enable:(n,e)=>n({[e]:!0}),disable:(n,e)=>n({[e]:!1}),pixelStorei:(n,e,t)=>n({[e]:t}),hint:(n,e,t)=>n({[e]:t}),useProgram:(n,e)=>n({35725:e}),bindRenderbuffer:(n,e,t)=>n({36007:t}),bindTransformFeedback:(n,e,t)=>n({36389:t}),bindVertexArray:(n,e)=>n({34229:e}),bindFramebuffer:(n,e,t)=>{switch(e){case 36160:return n({36006:t,36010:t});case 36009:return n({36006:t});case 36008:return n({36010:t});default:return null}},bindBuffer:(n,e,t)=>{const i={34962:[34964],36662:[36662],36663:[36663],35051:[35053],35052:[35055]}[e];return i?n({[i]:t}):{valueChanged:!0}},blendColor:(n,e,t,i,r)=>n({32773:new Float32Array([e,t,i,r])}),blendEquation:(n,e)=>n({32777:e,34877:e}),blendEquationSeparate:(n,e,t)=>n({32777:e,34877:t}),blendFunc:(n,e,t)=>n({32969:e,32968:t,32971:e,32970:t}),blendFuncSeparate:(n,e,t,i,r)=>n({32969:e,32968:t,32971:i,32970:r}),clearColor:(n,e,t,i,r)=>n({3106:new Float32Array([e,t,i,r])}),clearDepth:(n,e)=>n({2931:e}),clearStencil:(n,e)=>n({2961:e}),colorMask:(n,e,t,i,r)=>n({3107:[e,t,i,r]}),cullFace:(n,e)=>n({2885:e}),depthFunc:(n,e)=>n({2932:e}),depthRange:(n,e,t)=>n({2928:new Float32Array([e,t])}),depthMask:(n,e)=>n({2930:e}),frontFace:(n,e)=>n({2886:e}),lineWidth:(n,e)=>n({2849:e}),polygonOffset:(n,e,t)=>n({32824:e,10752:t}),sampleCoverage:(n,e,t)=>n({32938:e,32939:t}),scissor:(n,e,t,i,r)=>n({3088:new Int32Array([e,t,i,r])}),stencilMask:(n,e)=>n({2968:e,36005:e}),stencilMaskSeparate:(n,e,t)=>n({[e===1028?2968:36005]:t}),stencilFunc:(n,e,t,i)=>n({2962:e,2967:t,2963:i,34816:e,36003:t,36004:i}),stencilFuncSeparate:(n,e,t,i,r)=>n({[e===1028?2962:34816]:t,[e===1028?2967:36003]:i,[e===1028?2963:36004]:r}),stencilOp:(n,e,t,i)=>n({2964:e,2965:t,2966:i,34817:e,34818:t,34819:i}),stencilOpSeparate:(n,e,t,i,r)=>n({[e===1028?2964:34817]:t,[e===1028?2965:34818]:i,[e===1028?2966:34819]:r}),viewport:(n,e,t,i,r)=>n({2978:[e,t,i,r]})},mt=(n,e)=>n.isEnabled(e),Hh={3042:mt,2884:mt,2929:mt,3024:mt,32823:mt,32926:mt,32928:mt,3089:mt,2960:mt,35977:mt},WP=new Set([34016,36388,36387,35983,35368,34965,35739,35738,3074,34853,34854,34855,34856,34857,34858,34859,34860,34861,34862,34863,34864,34865,34866,34867,34868,35097,32873,35869,32874,34068]);function ci(n,e){if(jP(e))return;const t={};for(const r in e){const s=Number(r),o=zP[r];o&&(typeof o=="string"?t[o]=!0:o(n,e[r],s))}const i=n.state&&n.state.cache;if(i)for(const r in t){const s=VP[r];s(n,e,i)}}function c_(n,e=tu){if(typeof e=="number"){const r=e,s=Hh[r];return s?s(n,r):n.getParameter(r)}const t=Array.isArray(e)?e:Object.keys(e),i={};for(const r of t){const s=Hh[r];i[r]=s?s(n,Number(r)):n.getParameter(Number(r))}return i}function HP(n){ci(n,tu)}function jP(n){for(const e in n)return!1;return!0}function XP(n,e){if(n===e)return!0;const t=Array.isArray(n)||ArrayBuffer.isView(n),i=Array.isArray(e)||ArrayBuffer.isView(e);if(t&&i&&n.length===e.length){for(let r=0;r<n.length;++r)if(n[r]!==e[r])return!1;return!0}return!1}class pn{constructor(e,t){m(this,"gl");m(this,"program",null);m(this,"stateStack",[]);m(this,"enable",!0);m(this,"cache",null);m(this,"log");m(this,"initialized",!1);this.gl=e,this.log=(t==null?void 0:t.log)||(()=>{}),this._updateCache=this._updateCache.bind(this),Object.seal(this)}static get(e){return e.state}push(e={}){this.stateStack.push({})}pop(){const e=this.stateStack[this.stateStack.length-1];ci(this.gl,e),this.stateStack.pop()}trackState(e,t){if(this.cache=t.copyState?c_(e):Object.assign({},tu),this.initialized)throw new Error("WebGLStateTracker");this.initialized=!0,this.gl.state=this,qP(e);for(const i in Wh){const r=Wh[i];YP(e,i,r)}jh(e,"getParameter"),jh(e,"isEnabled")}_updateCache(e){let t=!1,i;const r=this.stateStack.length>0?this.stateStack[this.stateStack.length-1]:null;for(const s in e){const o=e[s],a=this.cache[s];XP(o,a)||(t=!0,i=a,r&&!(s in r)&&(r[s]=a),this.cache[s]=o)}return{valueChanged:t,oldValue:i}}}function jh(n,e){const t=n[e].bind(n);n[e]=function(r){if(r===void 0||WP.has(r))return t(r);const s=pn.get(n);return r in s.cache||(s.cache[r]=t(r)),s.enable?s.cache[r]:t(r)},Object.defineProperty(n[e],"name",{value:`${e}-from-cache`,configurable:!1})}function YP(n,e,t){if(!n[e])return;const i=n[e].bind(n);n[e]=function(...s){const o=pn.get(n),{valueChanged:a,oldValue:l}=t(o._updateCache,...s);return a&&i(...s),l},Object.defineProperty(n[e],"name",{value:`${e}-to-cache`,configurable:!1})}function qP(n){const e=n.useProgram.bind(n);n.useProgram=function(i){const r=pn.get(n);r.program!==i&&(e(i),r.program=i)}}function KP(n,e,t){let i="";const r={preserveDrawingBuffer:!0,...t};let s=null;if(s||(s=n.getContext("webgl2",r)),r.failIfMajorPerformanceCaveat&&(i||(i="Only software GPU is available. Set `failIfMajorPerformanceCaveat: false` to allow.")),!s&&!t.failIfMajorPerformanceCaveat&&(r.failIfMajorPerformanceCaveat=!1,s=n.getContext("webgl2",r),s.luma||(s.luma={}),s.luma.softwareRenderer=!0),s||(s=n.getContext("webgl",{}),s&&(s=null,i||(i="Your browser only supports WebGL1"))),!s)throw i||(i="Your browser does not support WebGL"),new Error(`Failed to create WebGL context: ${i}`);const{onContextLost:o,onContextRestored:a}=e;return n.addEventListener("webglcontextlost",l=>o(l),!1),n.addEventListener("webglcontextrestored",l=>a(l),!1),s.luma||(s.luma={}),s}function oi(n,e,t){return t[e]===void 0&&(t[e]=n.getExtension(e)||null),t[e]}function ZP(n,e){const t=n.getParameter(7936),i=n.getParameter(7937);oi(n,"WEBGL_debug_renderer_info",e);const r=e.WEBGL_debug_renderer_info,s=n.getParameter(r?r.UNMASKED_VENDOR_WEBGL:7936),o=n.getParameter(r?r.UNMASKED_RENDERER_WEBGL:7937),a=s||t,l=o||i,c=n.getParameter(7938),u=u_(a,l),d=GP(a,l),h=QP(a,l);return{type:"webgl",gpu:u,gpuType:h,gpuBackend:d,vendor:a,renderer:l,version:c,shadingLanguage:"glsl",shadingLanguageVersion:300}}function u_(n,e){return/NVIDIA/i.exec(n)||/NVIDIA/i.exec(e)?"nvidia":/INTEL/i.exec(n)||/INTEL/i.exec(e)?"intel":/Apple/i.exec(n)||/Apple/i.exec(e)?"apple":/AMD/i.exec(n)||/AMD/i.exec(e)||/ATI/i.exec(n)||/ATI/i.exec(e)?"amd":/SwiftShader/i.exec(n)||/SwiftShader/i.exec(e)?"software":"unknown"}function GP(n,e){return/Metal/i.exec(n)||/Metal/i.exec(e)?"metal":/ANGLE/i.exec(n)||/ANGLE/i.exec(e)?"opengl":"unknown"}function QP(n,e){if(/SwiftShader/i.exec(n)||/SwiftShader/i.exec(e))return"cpu";switch(u_(n,e)){case"intel":return"integrated";case"software":return"cpu";case"unknown":return"unknown";default:return"discrete"}}function d_(n){switch(n){case"uint8":return 5121;case"sint8":return 5120;case"unorm8":return 5121;case"snorm8":return 5120;case"uint16":return 5123;case"sint16":return 5122;case"unorm16":return 5123;case"snorm16":return 5122;case"uint32":return 5125;case"sint32":return 5124;case"float16":return 5131;case"float32":return 5126}throw new Error(String(n))}const Ti="WEBGL_compressed_texture_s3tc",Si="WEBGL_compressed_texture_s3tc_srgb",$n="EXT_texture_compression_rgtc",zn="EXT_texture_compression_bptc",JP="WEBGL_compressed_texture_etc",eM="WEBGL_compressed_texture_astc",tM="WEBGL_compressed_texture_etc1",nM="WEBGL_compressed_texture_pvrtc",iM="WEBGL_compressed_texture_atc",Xh="EXT_texture_norm16",Yh="EXT_render_snorm",rM="EXT_color_buffer_float",nu={"float32-renderable-webgl":["EXT_color_buffer_float"],"float16-renderable-webgl":["EXT_color_buffer_half_float"],"rgb9e5ufloat-renderable-webgl":["WEBGL_render_shared_exponent"],"snorm8-renderable-webgl":[Yh],"norm16-renderable-webgl":[Xh],"snorm16-renderable-webgl":[Xh,Yh],"float32-filterable":["OES_texture_float_linear"],"float16-filterable-webgl":["OES_texture_half_float_linear"],"texture-filterable-anisotropic-webgl":["EXT_texture_filter_anisotropic"],"texture-blend-float-webgl":["EXT_float_blend"],"texture-compression-bc":[Ti,Si,$n,zn],"texture-compression-bc5-webgl":[$n],"texture-compression-bc7-webgl":[zn],"texture-compression-etc2":[JP],"texture-compression-astc":[eM],"texture-compression-etc1-webgl":[tM],"texture-compression-pvrtc-webgl":[nM],"texture-compression-atc-webgl":[iM]};function sM(n){return n in nu}function oM(n,e,t){return(nu[e]||[]).every(r=>oi(n,r,t))}const iu={r8unorm:{gl:33321,rb:!0},r8snorm:{gl:36756},r8uint:{gl:33330,rb:!0},r8sint:{gl:33329,rb:!0},rg8unorm:{gl:33323,rb:!0},rg8snorm:{gl:36757},rg8uint:{gl:33336,rb:!0},rg8sint:{gl:33335,rb:!0},r16uint:{gl:33332,rb:!0},r16sint:{gl:33331,rb:!0},r16float:{gl:33325,rb:!0},"r16unorm-webgl":{gl:33322,rb:!0},"r16snorm-webgl":{gl:36760},"rgba4unorm-webgl":{gl:32854,rb:!0},"rgb565unorm-webgl":{gl:36194,rb:!0},"rgb5a1unorm-webgl":{gl:32855,rb:!0},"rgb8unorm-webgl":{gl:32849},"rgb8snorm-webgl":{gl:36758},rgba8unorm:{gl:32856},"rgba8unorm-srgb":{gl:35907},rgba8snorm:{gl:36759},rgba8uint:{gl:36220},rgba8sint:{gl:36238},bgra8unorm:{},"bgra8unorm-srgb":{},rg16uint:{gl:33338},rg16sint:{gl:33337},rg16float:{gl:33327,rb:!0},"rg16unorm-webgl":{gl:33324},"rg16snorm-webgl":{gl:36761},r32uint:{gl:33334,rb:!0},r32sint:{gl:33333,rb:!0},r32float:{gl:33326},rgb9e5ufloat:{gl:35901},rg11b10ufloat:{gl:35898,rb:!0},rgb10a2unorm:{gl:32857,rb:!0},"rgb10a2uint-webgl":{gl:36975,rb:!0},"rgb16unorm-webgl":{gl:32852},"rgb16snorm-webgl":{gl:36762},rg32uint:{gl:33340,rb:!0},rg32sint:{gl:33339,rb:!0},rg32float:{gl:33328,rb:!0},rgba16uint:{gl:36214,rb:!0},rgba16sint:{gl:36232,rb:!0},rgba16float:{gl:34842},"rgba16unorm-webgl":{gl:32859,rb:!0},"rgba16snorm-webgl":{gl:36763},"rgb32float-webgl":{gl:34837,x:rM,dataFormat:6407,types:[5126]},rgba32uint:{gl:36208,rb:!0},rgba32sint:{gl:36226,rb:!0},rgba32float:{gl:34836,rb:!0},stencil8:{gl:36168,rb:!0},depth16unorm:{gl:33189,dataFormat:6402,types:[5123],rb:!0},depth24plus:{gl:33190,dataFormat:6402,types:[5125]},depth32float:{gl:36012,dataFormat:6402,types:[5126],rb:!0},"depth24plus-stencil8":{gl:35056,rb:!0,depthTexture:!0,dataFormat:34041,types:[34042]},"depth32float-stencil8":{gl:36013,dataFormat:34041,types:[36269],rb:!0},"bc1-rgb-unorm-webgl":{gl:33776,x:Ti},"bc1-rgb-unorm-srgb-webgl":{gl:35916,x:Si},"bc1-rgba-unorm":{gl:33777,x:Ti},"bc1-rgba-unorm-srgb":{gl:35916,x:Si},"bc2-rgba-unorm":{gl:33778,x:Ti},"bc2-rgba-unorm-srgb":{gl:35918,x:Si},"bc3-rgba-unorm":{gl:33779,x:Ti},"bc3-rgba-unorm-srgb":{gl:35919,x:Si},"bc4-r-unorm":{gl:36283,x:$n},"bc4-r-snorm":{gl:36284,x:$n},"bc5-rg-unorm":{gl:36285,x:$n},"bc5-rg-snorm":{gl:36286,x:$n},"bc6h-rgb-ufloat":{gl:36495,x:zn},"bc6h-rgb-float":{gl:36494,x:zn},"bc7-rgba-unorm":{gl:36492,x:zn},"bc7-rgba-unorm-srgb":{gl:36493,x:zn},"etc2-rgb8unorm":{gl:37492},"etc2-rgb8unorm-srgb":{gl:37494},"etc2-rgb8a1unorm":{gl:37496},"etc2-rgb8a1unorm-srgb":{gl:37497},"etc2-rgba8unorm":{gl:37493},"etc2-rgba8unorm-srgb":{gl:37495},"eac-r11unorm":{gl:37488},"eac-r11snorm":{gl:37489},"eac-rg11unorm":{gl:37490},"eac-rg11snorm":{gl:37491},"astc-4x4-unorm":{gl:37808},"astc-4x4-unorm-srgb":{gl:37840},"astc-5x4-unorm":{gl:37809},"astc-5x4-unorm-srgb":{gl:37841},"astc-5x5-unorm":{gl:37810},"astc-5x5-unorm-srgb":{gl:37842},"astc-6x5-unorm":{gl:37811},"astc-6x5-unorm-srgb":{gl:37843},"astc-6x6-unorm":{gl:37812},"astc-6x6-unorm-srgb":{gl:37844},"astc-8x5-unorm":{gl:37813},"astc-8x5-unorm-srgb":{gl:37845},"astc-8x6-unorm":{gl:37814},"astc-8x6-unorm-srgb":{gl:37846},"astc-8x8-unorm":{gl:37815},"astc-8x8-unorm-srgb":{gl:37847},"astc-10x5-unorm":{gl:37819},"astc-10x5-unorm-srgb":{gl:37851},"astc-10x6-unorm":{gl:37817},"astc-10x6-unorm-srgb":{gl:37849},"astc-10x8-unorm":{gl:37818},"astc-10x8-unorm-srgb":{gl:37850},"astc-10x10-unorm":{gl:37819},"astc-10x10-unorm-srgb":{gl:37851},"astc-12x10-unorm":{gl:37820},"astc-12x10-unorm-srgb":{gl:37852},"astc-12x12-unorm":{gl:37821},"astc-12x12-unorm-srgb":{gl:37853},"pvrtc-rgb4unorm-webgl":{gl:35840},"pvrtc-rgba4unorm-webgl":{gl:35842},"pvrtc-rbg2unorm-webgl":{gl:35841},"pvrtc-rgba2unorm-webgl":{gl:35843},"etc1-rbg-unorm-webgl":{gl:36196},"atc-rgb-unorm-webgl":{gl:35986},"atc-rgba-unorm-webgl":{gl:35986},"atc-rgbai-unorm-webgl":{gl:34798}};function aM(n,e,t){let i=e.create;const r=iu[e.format];return(r==null?void 0:r.gl)===void 0&&(i=!1),r!=null&&r.x&&(i=i&&!!oi(n,r.x,t)),{format:e.format,create:i&&e.create,render:i&&e.render,filter:i&&e.filter,blend:i&&e.blend,store:i&&e.store}}function h_(n){var r;const e=iu[n],t=uM(n),i=Bc(n);return{internalFormat:t,format:(e==null?void 0:e.dataFormat)||cM(i.channels,i.integer,i.normalized,t),type:i.dataType?d_(i.dataType):((r=e==null?void 0:e.types)==null?void 0:r[0])||5121,compressed:i.compressed||!1}}function lM(n){switch(Bc(n).attachment){case"depth":return 36096;case"stencil":return 36128;case"depth-stencil":return 33306;default:throw new Error(`Not a depth stencil format: ${n}`)}}function cM(n,e,t,i){if(i===6408||i===6407)return i;switch(n){case"r":return e&&!t?36244:6403;case"rg":return e&&!t?33320:33319;case"rgb":return e&&!t?36248:6407;case"rgba":return e&&!t?36249:6408;case"bgra":throw new Error("bgra pixels not supported by WebGL");default:return 6408}}function uM(n){const e=iu[n],t=e==null?void 0:e.gl;if(t===void 0)throw new Error(`Unsupported texture format ${n}`);return t}const qh={"depth-clip-control":"EXT_depth_clamp","timer-query-webgl":"EXT_disjoint_timer_query_webgl2","compilation-status-async-webgl":"KHR_parallel_shader_compile","polygon-mode-webgl":"WEBGL_polygon_mode","provoking-vertex-webgl":"WEBGL_provoking_vertex","shader-clip-cull-distance-webgl":"WEBGL_clip_cull_distance","shader-noperspective-interpolation-webgl":"NV_shader_noperspective_interpolation","shader-conservative-depth-webgl":"EXT_conservative_depth"};class dM extends iC{constructor(t,i,r){super([],r);m(this,"gl");m(this,"extensions");m(this,"testedFeatures",new Set);this.gl=t,this.extensions=i,oi(t,"EXT_color_buffer_float",i)}*[Symbol.iterator](){const t=this.getFeatures();for(const i of t)this.has(i)&&(yield i);return[]}has(t){var i;return(i=this.disabledFeatures)!=null&&i[t]?!1:(this.testedFeatures.has(t)||(this.testedFeatures.add(t),sM(t)&&oM(this.gl,t,this.extensions)&&this.features.add(t),this.getWebGLFeature(t)&&this.features.add(t)),this.features.has(t))}initializeFeatures(){const t=this.getFeatures().filter(i=>i!=="polygon-mode-webgl");for(const i of t)this.has(i)}getFeatures(){return[...Object.keys(qh),...Object.keys(nu)]}getWebGLFeature(t){const i=qh[t];return typeof i=="string"?!!oi(this.gl,i,this.extensions):!!i}}class hM extends nC{constructor(t){super();m(this,"gl");m(this,"limits",{});this.gl=t}get maxTextureDimension1D(){return 0}get maxTextureDimension2D(){return this.getParameter(3379)}get maxTextureDimension3D(){return this.getParameter(32883)}get maxTextureArrayLayers(){return this.getParameter(35071)}get maxBindGroups(){return 0}get maxDynamicUniformBuffersPerPipelineLayout(){return 0}get maxDynamicStorageBuffersPerPipelineLayout(){return 0}get maxSampledTexturesPerShaderStage(){return this.getParameter(35660)}get maxSamplersPerShaderStage(){return this.getParameter(35661)}get maxStorageBuffersPerShaderStage(){return 0}get maxStorageTexturesPerShaderStage(){return 0}get maxUniformBuffersPerShaderStage(){return this.getParameter(35375)}get maxUniformBufferBindingSize(){return this.getParameter(35376)}get maxStorageBufferBindingSize(){return 0}get minUniformBufferOffsetAlignment(){return this.getParameter(35380)}get minStorageBufferOffsetAlignment(){return 0}get maxVertexBuffers(){return 16}get maxVertexAttributes(){return this.getParameter(34921)}get maxVertexBufferArrayStride(){return 2048}get maxInterStageShaderComponents(){return this.getParameter(35659)}get maxComputeWorkgroupStorageSize(){return 0}get maxComputeInvocationsPerWorkgroup(){return 0}get maxComputeWorkgroupSizeX(){return 0}get maxComputeWorkgroupSizeY(){return 0}get maxComputeWorkgroupSizeZ(){return 0}get maxComputeWorkgroupsPerDimension(){return 0}getParameter(t){return this.limits[t]===void 0&&(this.limits[t]=this.gl.getParameter(t)),this.limits[t]||0}}class Oi extends Ps{constructor(t,i){super(t,i);m(this,"device");m(this,"gl");m(this,"handle");m(this,"colorAttachments",[]);m(this,"depthStencilAttachment",null);const r=i.handle===null;this.device=t,this.gl=t.gl,this.handle=this.props.handle||r?this.props.handle:this.gl.createFramebuffer(),r||(t.setSpectorMetadata(this.handle,{id:this.props.id,props:this.props}),this.autoCreateAttachmentTextures(),this.updateAttachments())}destroy(){super.destroy(),!this.destroyed&&this.handle!==null&&this.gl.deleteFramebuffer(this.handle)}updateAttachments(){const t=this.gl.bindFramebuffer(36160,this.handle);for(let i=0;i<this.colorAttachments.length;++i){const r=this.colorAttachments[i];if(r){const s=36064+i;this._attachTextureView(s,r)}}if(this.depthStencilAttachment){const i=lM(this.depthStencilAttachment.props.format);this._attachTextureView(i,this.depthStencilAttachment)}if(this.device.props.debug){const i=this.gl.checkFramebufferStatus(36160);if(i!==36053)throw new Error(`Framebuffer ${pM(i)}`)}this.gl.bindFramebuffer(36160,t)}_attachTextureView(t,i){const{gl:r}=this.device,{texture:s}=i,o=i.props.baseMipLevel,a=i.props.baseArrayLayer;switch(r.bindTexture(s.glTarget,s.handle),s.glTarget){case 35866:case 32879:r.framebufferTextureLayer(36160,t,s.handle,o,a);break;case 34067:const l=fM(a);r.framebufferTexture2D(36160,t,l,s.handle,o);break;case 3553:r.framebufferTexture2D(36160,t,3553,s.handle,o);break;default:throw new Error("Illegal texture type")}r.bindTexture(s.glTarget,null)}}function fM(n){return n<34069?n+34069:n}function pM(n){switch(n){case 36053:return"success";case 36054:return"Mismatched attachments";case 36055:return"No attachments";case 36057:return"Height/width mismatch";case 36061:return"Unsupported or split attachments";case 36182:return"Samples mismatch";default:return`${n}`}}class gM extends ll{constructor(t,i){super(i);m(this,"device");m(this,"format","rgba8unorm");m(this,"depthStencilFormat","depth24plus");m(this,"presentationSize");m(this,"_framebuffer",null);this.device=t,this.presentationSize=[-1,-1],this._setAutoCreatedCanvasId(`${this.device.id}-canvas`),this.update()}get[Symbol.toStringTag](){return"WebGLCanvasContext"}getCurrentFramebuffer(){return this.update(),this._framebuffer=this._framebuffer||new Oi(this.device,{handle:null}),this._framebuffer}update(){const t=this.getPixelSize();(t[0]!==this.presentationSize[0]||t[1]!==this.presentationSize[1])&&(this.presentationSize=t,this.resize())}resize(t){if(this.device.gl&&this.canvas){const i=this.getDevicePixelRatio(t==null?void 0:t.useDevicePixels);this.setDevicePixelRatio(i,t);return}}commit(){}}async function f_(n,e){const t=document.getElementsByTagName("head")[0];if(!t)throw new Error("loadScript");const i=document.createElement("script");return i.setAttribute("type","text/javascript"),i.setAttribute("src",n),e&&(i.id=e),new Promise((r,s)=>{i.onload=r,i.onerror=o=>s(new Error(`Unable to load script '${n}': ${o}`)),t.appendChild(i)})}const mM=1;let oe=null,Kh=!1;const ru={debugSpectorJS:L.get("debug-spectorjs"),debugSpectorJSUrl:"https://cdn.jsdelivr.net/npm/spectorjs@0.9.30/dist/spector.bundle.js",gl:void 0};async function _M(n){if(!globalThis.SPECTOR)try{await f_(n.debugSpectorJSUrl||ru.debugSpectorJSUrl)}catch(e){L.warn(String(e))}}function yM(n){var e;if(n={...ru,...n},!n.debugSpectorJS)return null;if(!oe&&globalThis.SPECTOR&&!((e=globalThis.luma)!=null&&e.spector)){L.probe(mM,"SPECTOR found and initialized. Start with `luma.spector.displayUI()`")();const{Spector:t}=globalThis.SPECTOR;oe=new t,globalThis.luma&&(globalThis.luma.spector=oe)}if(!oe)return null;if(Kh||(Kh=!0,oe.spyCanvases(),oe==null||oe.onCaptureStarted.add(t=>L.info("Spector capture started:",t)()),oe==null||oe.onCapture.add(t=>{L.info("Spector capture complete:",t)(),oe==null||oe.getResultUI(),oe==null||oe.resultView.display(),oe==null||oe.resultView.addCapture(t)})),n.gl){const t=n.gl,i=t.device;oe==null||oe.startCapture(n.gl,500),t.device=i,new Promise(r=>setTimeout(r,2e3)).then(r=>{L.info("Spector capture stopped after 2 seconds")(),oe==null||oe.stopCapture()})}return oe}const bM="https://unpkg.com/webgl-debug@2.0.1/index.js";function p_(n){return n.luma=n.luma||{},n.luma}async function vM(){wn()&&!globalThis.WebGLDebugUtils&&(globalThis.global=globalThis.global||globalThis,globalThis.global.module={},await f_(bM))}function xM(n,e={}){return e.debugWebGL||e.traceWebGL?TM(n,e):wM(n)}function wM(n){const e=p_(n);return e.realContext?e.realContext:n}function TM(n,e){if(!globalThis.WebGLDebugUtils)return L.warn("webgl-debug not loaded")(),n;const t=p_(n);if(t.debugContext)return t.debugContext;globalThis.WebGLDebugUtils.init({...Un,...n});const i=globalThis.WebGLDebugUtils.makeDebugContext(n,SM.bind(null,e),EM.bind(null,e));for(const o in Un)!(o in i)&&typeof Un[o]=="number"&&(i[o]=Un[o]);class r{}Object.setPrototypeOf(i,Object.getPrototypeOf(n)),Object.setPrototypeOf(r,i);const s=Object.create(r);return t.realContext=n,t.debugContext=s,s.debug=!0,s}function Zh(n,e){e=Array.from(e).map(i=>i===void 0?"undefined":i);let t=globalThis.WebGLDebugUtils.glFunctionArgsToString(n,e);return t=`${t.slice(0,100)}${t.length>100?"...":""}`,`gl.${n}(${t})`}function SM(n,e,t,i){i=Array.from(i).map(a=>a===void 0?"undefined":a);const r=globalThis.WebGLDebugUtils.glEnumToString(e),s=globalThis.WebGLDebugUtils.glFunctionArgsToString(t,i),o=`${r} in gl.${t}(${s})`;L.error(o)();debugger}function EM(n,e,t){let i="";L.level>=1&&(i=Zh(e,t),n.traceWebGL&&L.log(1,i)());for(const r of t)if(r===void 0){i=i||Zh(e,t);debugger}}const pa={};function AM(n="id"){pa[n]=pa[n]||1;const e=pa[n]++;return`${n}-${e}`}class Ni extends le{constructor(t,i={}){super(t,i);m(this,"device");m(this,"gl");m(this,"handle");m(this,"glTarget");m(this,"glUsage");m(this,"glIndexType",5123);m(this,"byteLength");m(this,"bytesUsed");this.device=t,this.gl=this.device.gl;const r=typeof i=="object"?i.handle:void 0;this.handle=r||this.gl.createBuffer(),t.setSpectorMetadata(this.handle,{...this.props,data:typeof this.props.data}),this.glTarget=CM(this.props.usage),this.glUsage=IM(this.props.usage),this.glIndexType=this.props.indexType==="uint32"?5125:5123,i.data?this._initWithData(i.data,i.byteOffset,i.byteLength):this._initWithByteLength(i.byteLength||0)}_initWithData(t,i=0,r=t.byteLength+i){const s=this.glTarget;this.gl.bindBuffer(s,this.handle),this.gl.bufferData(s,r,this.glUsage),this.gl.bufferSubData(s,i,t),this.gl.bindBuffer(s,null),this.bytesUsed=r,this.byteLength=r,this._setDebugData(t,i,r),this.trackAllocatedMemory(r)}_initWithByteLength(t){let i=t;t===0&&(i=new Float32Array(0));const r=this.glTarget;return this.gl.bindBuffer(r,this.handle),this.gl.bufferData(r,i,this.glUsage),this.gl.bindBuffer(r,null),this.bytesUsed=t,this.byteLength=t,this._setDebugData(null,0,t),this.trackAllocatedMemory(t),this}destroy(){!this.destroyed&&this.handle&&(this.removeStats(),this.trackDeallocatedMemory(),this.gl.deleteBuffer(this.handle),this.destroyed=!0,this.handle=null)}write(t,i=0){this.gl.bindBuffer(36663,this.handle),this.gl.bufferSubData(36663,i,t),this.gl.bindBuffer(36663,null),this._setDebugData(t,i,t.byteLength)}async readAsync(t=0,i){return this.readSyncWebGL(t,i)}readSyncWebGL(t=0,i){i=i??this.byteLength-t;const r=new Uint8Array(i),s=0;return this.gl.bindBuffer(36662,this.handle),this.gl.getBufferSubData(36662,t,r,s,i),this.gl.bindBuffer(36662,null),this._setDebugData(r,t,i),r}}function CM(n){return n&le.INDEX?34963:n&le.VERTEX?34962:n&le.UNIFORM?35345:34962}function IM(n){return n&le.INDEX||n&le.VERTEX?35044:n&le.UNIFORM?35048:35044}function RM(n){const e=n.split(/\r?\n/),t=[];for(const i of e){if(i.length<=1)continue;const r=i.split(":");if(r.length===2){const[d,h]=r;t.push({message:h.trim(),type:Gh(d),lineNum:0,linePos:0});continue}const[s,o,a,...l]=r;let c=parseInt(a,10);isNaN(c)&&(c=0);let u=parseInt(o,10);isNaN(u)&&(u=0),t.push({message:l.join(":").trim(),type:Gh(s),lineNum:c,linePos:u})}return t}function Gh(n){const e=["warning","error","info"],t=n.toLowerCase();return e.includes(t)?t:"info"}class PM extends Is{constructor(t,i){super(t,i);m(this,"device");m(this,"handle");switch(this.device=t,this.props.stage){case"vertex":this.handle=this.props.handle||this.device.gl.createShader(35633);break;case"fragment":this.handle=this.props.handle||this.device.gl.createShader(35632);break;default:throw new Error(this.props.stage)}this._compile(this.source)}destroy(){this.handle&&(this.removeStats(),this.device.gl.deleteShader(this.handle),this.destroyed=!0)}get asyncCompilationStatus(){return this._waitForCompilationComplete().then(()=>this.compilationStatus)}async getCompilationInfo(){return await this._waitForCompilationComplete(),this.getCompilationInfoSync()}getCompilationInfoSync(){const t=this.device.gl.getShaderInfoLog(this.handle);return t?RM(t):[]}getTranslatedSource(){const i=this.device.getExtension("WEBGL_debug_shaders").WEBGL_debug_shaders;return(i==null?void 0:i.getTranslatedShaderSource(this.handle))||null}async _compile(t){t=t.startsWith("#version ")?t:`#version 300 es
${t}`;const{gl:i}=this.device;if(i.shaderSource(this.handle,t),i.compileShader(this.handle),!this.device.props.debug){this.compilationStatus="pending";return}if(!this.device.features.has("compilation-status-async-webgl")){if(this._getCompilationStatus(),this.debugShader(),this.compilationStatus==="error")throw new Error(`GLSL compilation errors in ${this.props.stage} shader ${this.props.id}`);return}L.once(1,"Shader compilation is asynchronous")(),await this._waitForCompilationComplete(),L.info(2,`Shader ${this.id} - async compilation complete: ${this.compilationStatus}`)(),this._getCompilationStatus(),this.debugShader()}async _waitForCompilationComplete(){const t=async s=>await new Promise(o=>setTimeout(o,s));if(!this.device.features.has("compilation-status-async-webgl")){await t(10);return}const{gl:r}=this.device;for(;;){if(r.getShaderParameter(this.handle,37297))return;await t(10)}}_getCompilationStatus(){this.compilationStatus=this.device.gl.getShaderParameter(this.handle,35713)?"success":"error"}}function MM(n,e,t,i){if(FM(e))return i(n);const r=n;r.pushState();try{return kM(n,e),ci(r.gl,t),i(n)}finally{r.popState()}}function kM(n,e){const t=n,{gl:i}=t;if(e.cullMode)switch(e.cullMode){case"none":i.disable(2884);break;case"front":i.enable(2884),i.cullFace(1028);break;case"back":i.enable(2884),i.cullFace(1029);break}if(e.frontFace&&i.frontFace(gn("frontFace",e.frontFace,{ccw:2305,cw:2304})),e.unclippedDepth&&n.features.has("depth-clip-control")&&i.enable(34383),e.depthBias!==void 0&&(i.enable(32823),i.polygonOffset(e.depthBias,e.depthBiasSlopeScale||0)),e.provokingVertex&&n.features.has("provoking-vertex-webgl")){const s=t.getExtension("WEBGL_provoking_vertex").WEBGL_provoking_vertex,o=gn("provokingVertex",e.provokingVertex,{first:36429,last:36430});s==null||s.provokingVertexWEBGL(o)}if((e.polygonMode||e.polygonOffsetLine)&&n.features.has("polygon-mode-webgl")){if(e.polygonMode){const s=t.getExtension("WEBGL_polygon_mode").WEBGL_polygon_mode,o=gn("polygonMode",e.polygonMode,{fill:6914,line:6913});s==null||s.polygonModeWEBGL(1028,o),s==null||s.polygonModeWEBGL(1029,o)}e.polygonOffsetLine&&i.enable(10754)}if(n.features.has("shader-clip-cull-distance-webgl")&&(e.clipDistance0&&i.enable(12288),e.clipDistance1&&i.enable(12289),e.clipDistance2&&i.enable(12290),e.clipDistance3&&i.enable(12291),e.clipDistance4&&i.enable(12292),e.clipDistance5&&i.enable(12293),e.clipDistance6&&i.enable(12294),e.clipDistance7&&i.enable(12295)),e.depthWriteEnabled!==void 0&&i.depthMask(NM("depthWriteEnabled",e.depthWriteEnabled)),e.depthCompare&&(e.depthCompare!=="always"?i.enable(2929):i.disable(2929),i.depthFunc(Ol("depthCompare",e.depthCompare))),e.stencilWriteMask){const r=e.stencilWriteMask;i.stencilMaskSeparate(1028,r),i.stencilMaskSeparate(1029,r)}if(e.stencilReadMask&&L.warn("stencilReadMask not supported under WebGL"),e.stencilCompare){const r=e.stencilReadMask||4294967295,s=Ol("depthCompare",e.stencilCompare);e.stencilCompare!=="always"?i.enable(2960):i.disable(2960),i.stencilFuncSeparate(1028,s,0,r),i.stencilFuncSeparate(1029,s,0,r)}if(e.stencilPassOperation&&e.stencilFailOperation&&e.stencilDepthFailOperation){const r=ga("stencilPassOperation",e.stencilPassOperation),s=ga("stencilFailOperation",e.stencilFailOperation),o=ga("stencilDepthFailOperation",e.stencilDepthFailOperation);i.stencilOpSeparate(1028,s,o,r),i.stencilOpSeparate(1029,s,o,r)}switch(e.blend){case!0:i.enable(3042);break;case!1:i.disable(3042);break}if(e.blendColorOperation||e.blendAlphaOperation){const r=Qh("blendColorOperation",e.blendColorOperation||"add"),s=Qh("blendAlphaOperation",e.blendAlphaOperation||"add");i.blendEquationSeparate(r,s);const o=Dr("blendColorSrcFactor",e.blendColorSrcFactor||"one"),a=Dr("blendColorDstFactor",e.blendColorDstFactor||"zero"),l=Dr("blendAlphaSrcFactor",e.blendAlphaSrcFactor||"one"),c=Dr("blendAlphaDstFactor",e.blendAlphaDstFactor||"zero");i.blendFuncSeparate(o,a,l,c)}}function Ol(n,e){return gn(n,e,{never:512,less:513,equal:514,"less-equal":515,greater:516,"not-equal":517,"greater-equal":518,always:519})}function ga(n,e){return gn(n,e,{keep:7680,zero:0,replace:7681,invert:5386,"increment-clamp":7682,"decrement-clamp":7683,"increment-wrap":34055,"decrement-wrap":34056})}function Qh(n,e){return gn(n,e,{add:32774,subtract:32778,"reverse-subtract":32779,min:32775,max:32776})}function Dr(n,e){return gn(n,e,{one:1,zero:0,"src-color":768,"one-minus-src-color":769,"dst-color":774,"one-minus-dst-color":775,"src-alpha":770,"one-minus-src-alpha":771,"dst-alpha":772,"one-minus-dst-alpha":773,"src-alpha-saturated":776,"constant-color":32769,"one-minus-constant-color":32770,"constant-alpha":32771,"one-minus-constant-alpha":32772})}function OM(n,e){return`Illegal parameter ${e} for ${n}`}function gn(n,e,t){if(!(e in t))throw new Error(OM(n,e));return t[e]}function NM(n,e){return e}function FM(n){let e=!0;for(const t in n){e=!1;break}return e}function g_(n){const e={};return n.addressModeU&&(e[10242]=ma(n.addressModeU)),n.addressModeV&&(e[10243]=ma(n.addressModeV)),n.addressModeW&&(e[32882]=ma(n.addressModeW)),n.magFilter&&(e[10240]=Nl(n.magFilter)),(n.minFilter||n.mipmapFilter)&&(e[10241]=DM(n.minFilter||"linear",n.mipmapFilter)),n.lodMinClamp!==void 0&&(e[33082]=n.lodMinClamp),n.lodMaxClamp!==void 0&&(e[33083]=n.lodMaxClamp),n.type==="comparison-sampler"&&(e[34892]=34894),n.compare&&(e[34893]=Ol("compare",n.compare)),n.maxAnisotropy&&(e[34046]=n.maxAnisotropy),e}function ma(n){switch(n){case"clamp-to-edge":return 33071;case"repeat":return 10497;case"mirror-repeat":return 33648}}function Nl(n){switch(n){case"nearest":return 9728;case"linear":return 9729}}function DM(n,e="none"){if(!e)return Nl(n);switch(e){case"none":return Nl(n);case"nearest":return n==="nearest"?9984:9986;case"linear":return n==="nearest"?9985:9987}}class Fl extends Rs{constructor(t,i){super(t,i);m(this,"device");m(this,"handle");m(this,"parameters");this.device=t,this.parameters=g_(i),this.handle=this.handle||this.device.gl.createSampler(),this._setSamplerParameters(this.parameters)}destroy(){this.handle&&(this.device.gl.deleteSampler(this.handle),this.handle=void 0)}toString(){return`Sampler(${this.id},${JSON.stringify(this.props)})`}_setSamplerParameters(t){for(const[i,r]of Object.entries(t)){const s=Number(i);switch(s){case 33082:case 33083:this.device.gl.samplerParameterf(this.handle,s,r);break;default:this.device.gl.samplerParameteri(this.handle,s,r);break}}}}class Vn extends Cs{constructor(t,i){super(t,{...fe.defaultProps,...i});m(this,"device");m(this,"gl");m(this,"handle");m(this,"texture");this.device=t,this.gl=this.device.gl,this.handle=null,this.texture=i.texture}}const BM="Failed to deduce GL constant from typed array";function LM(n){switch(ArrayBuffer.isView(n)?n.constructor:n){case Float32Array:return 5126;case Uint16Array:return 5123;case Uint32Array:return 5125;case Uint8Array:return 5121;case Uint8ClampedArray:return 5121;case Int8Array:return 5120;case Int16Array:return 5122;case Int32Array:return 5124;default:throw new Error(BM)}}function UM(n,e){const{clamped:t=!0}=e||{};switch(n){case 5126:return Float32Array;case 5123:case 33635:case 32819:case 32820:return Uint16Array;case 5125:return Uint32Array;case 5121:return t?Uint8ClampedArray:Uint8Array;case 5120:return Int8Array;case 5122:return Int16Array;case 5124:return Int32Array;default:throw new Error("Failed to deduce typed array type from GL constant")}}function m_(n){switch(n){case 6406:case 33326:case 6403:case 36244:return 1;case 33339:case 33340:case 33328:case 33320:case 33319:return 2;case 6407:case 36248:case 34837:return 3;case 6408:case 36249:case 34836:return 4;default:return 0}}function $M(n){switch(n){case 5121:return 1;case 33635:case 32819:case 32820:return 2;case 5126:return 4;default:return 0}}function Xs(n,e,t){if(zM(e))return t(n);const{nocatch:i=!0}=e,r=pn.get(n);r.push(),ci(n,e);let s;if(i)s=t(n),r.pop();else try{s=t(n)}finally{r.pop()}return s}function zM(n){for(const e in n)return!1;return!0}function VM(n,e,t){const{dimension:i,width:r,height:s,depth:o=0}=t,{glInternalFormat:a}=t,l=t.glTarget;switch(i){case"2d-array":case"3d":n.texStorage3D(l,e,a,r,s,o);break;default:n.texStorage2D(l,e,a,r,s)}}function Jh(n,e,t,i){const{width:r,height:s}=i,{dimension:o,depth:a=0,mipLevel:l=0}=i,{x:c=0,y:u=0,z:d=0}=i,{glFormat:h,glType:f}=i,p=__(i.glTarget,o,a),g=i.flipY?{37440:!0}:{};Xs(n,g,()=>{switch(o){case"2d-array":case"3d":n.bindTexture(p,e),n.texSubImage3D(p,l,c,u,d,r,s,a,h,f,t),n.bindTexture(p,null);break;case"2d":case"cube":n.bindTexture(p,e),n.texSubImage2D(p,l,c,u,r,s,h,f,t),n.bindTexture(p,null);break;default:throw new Error(o)}})}function ef(n,e,t){const{dimension:i,width:r,height:s,depth:o=0,mipLevel:a=0,byteOffset:l=0}=t,{x:c=0,y:u=0,z:d=0}=t,{glFormat:h,glType:f,compressed:p}=t,g=__(t.glTarget,i,o);switch(i){case"2d-array":case"3d":p?n.compressedTexSubImage3D(g,a,c,u,d,r,s,o,h,e,l):n.texSubImage3D(g,a,c,u,d,r,s,o,h,f,e,l);break;case"2d":case"cube":p?n.compressedTexSubImage2D(g,a,c,u,r,s,h,e,l):n.texSubImage2D(g,a,c,u,r,s,h,f,e,l);break;default:throw new Error(i)}}function WM(n){switch(n){case"1d":break;case"2d":return 3553;case"3d":return 32879;case"cube":return 34067;case"2d-array":return 35866}throw new Error(n)}function __(n,e,t){return e==="cube"?34069+t:n}function HM(n,e){var b;const{sourceX:t=0,sourceY:i=0,sourceAttachment:r=0}=e||{};let{target:s=null,sourceWidth:o,sourceHeight:a,sourceDepth:l,sourceFormat:c,sourceType:u}=e||{};const{framebuffer:d,deleteFramebuffer:h}=y_(n),{gl:f,handle:p}=d;o||(o=d.width),a||(a=d.height);const g=(b=d.colorAttachments[r])==null?void 0:b.texture;if(!g)throw new Error(`Invalid framebuffer attachment ${r}`);l=(g==null?void 0:g.depth)||1,c||(c=(g==null?void 0:g.glFormat)||6408),u||(u=(g==null?void 0:g.glType)||5121),s=YM(s,u,c,o,a),u=u||LM(s);const _=f.bindFramebuffer(36160,p);return f.readBuffer(36064+r),f.readPixels(t,i,o,a,c,u,s),f.readBuffer(36064),f.bindFramebuffer(36160,_||null),h&&d.destroy(),s}function jM(n,e){const{target:t,sourceX:i=0,sourceY:r=0,sourceFormat:s=6408,targetByteOffset:o=0}=e||{};let{sourceWidth:a,sourceHeight:l,sourceType:c}=e||{};const{framebuffer:u,deleteFramebuffer:d}=y_(n);a=a||u.width,l=l||u.height;const h=u;c=c||5121;let f=t;if(!f){const g=m_(s),_=$M(c),b=o+a*l*g*_;f=h.device.createBuffer({byteLength:b})}const p=n.device.createCommandEncoder();return p.copyTextureToBuffer({sourceTexture:n,width:a,height:l,origin:[i,r],destinationBuffer:f,byteOffset:o}),p.destroy(),d&&u.destroy(),f}function y_(n){return n instanceof Ps?{framebuffer:n,deleteFramebuffer:!1}:{framebuffer:XM(n),deleteFramebuffer:!0}}function XM(n,e){const{device:t,width:i,height:r,id:s}=n;return t.createFramebuffer({...e,id:`framebuffer-for-${s}`,width:i,height:r,colorAttachments:[n]})}function YM(n,e,t,i,r,s){if(n)return n;e||(e=5121);const o=UM(e,{clamped:!1}),a=m_(t);return new o(i*r*a)}class Fi extends fe{constructor(t,i){super(t,i);m(this,"device");m(this,"gl");m(this,"handle");m(this,"sampler");m(this,"view");m(this,"mipmaps");m(this,"compressed");m(this,"glTarget");m(this,"glFormat");m(this,"glType");m(this,"glInternalFormat");m(this,"textureUnit",0);const r={...this.props};r.data=i.data,this.device=t,this.gl=this.device.gl,this.glTarget=WM(this.props.dimension);const s=h_(this.props.format);this.glInternalFormat=s.internalFormat,this.glFormat=s.format,this.glType=s.type,this.compressed=s.compressed,this.mipmaps=!!this.props.mipmaps,this._initialize(r),Object.seal(this)}_initialize(t){this.handle=this.props.handle||this.gl.createTexture(),this.device.setSpectorMetadata(this.handle,{...this.props,data:t.data});let{width:i,height:r}=t;if(!i||!r){const s=fe.getTextureDataSize(t.data);i=(s==null?void 0:s.width)||1,r=(s==null?void 0:s.height)||1}if(this.width=i,this.height=r,this.depth=t.depth,this.setSampler(t.sampler),this.view=new Vn(this.device,{...this.props,texture:this}),this.bind(),VM(this.gl,this.mipLevels,this),t.data)switch(t.dimension){case"1d":this.setTexture1DData(t.data);break;case"2d":this.setTexture2DData(t.data);break;case"3d":this.setTexture3DData(t.data);break;case"cube":this.setTextureCubeData(t.data);break;case"2d-array":this.setTextureArrayData(t.data);break;case"cube-array":this.setTextureCubeArrayData(t.data);break;default:throw new Error(t.dimension)}this.mipmaps&&this.generateMipmap()}destroy(){this.handle&&(this.gl.deleteTexture(this.handle),this.removeStats(),this.trackDeallocatedMemory("Texture"),this.destroyed=!0)}createView(t){return new Vn(this.device,{...t,texture:this})}setSampler(t={}){let i;t instanceof Fl?(this.sampler=t,i=t.props):(this.sampler=new Fl(this.device,t),i=t);const r=g_(i);this._setSamplerParameters(r)}generateMipmap(t){if(!(!(this.device.isTextureFormatRenderable(this.props.format)&&this.device.isTextureFormatFilterable(this.props.format))&&(L.warn(`${this} is not renderable or filterable, may not be able to generate mipmaps`)(),!(t!=null&&t.force))))try{this.gl.bindTexture(this.glTarget,this.handle),this.gl.generateMipmap(this.glTarget)}catch(r){L.warn(`Error generating mipmap for ${this}: ${r.message}`)()}finally{this.gl.bindTexture(this.glTarget,null)}}copyExternalImage(t){const i=fe.getExternalImageSize(t.image),r={...fe.defaultCopyExternalImageOptions,...i,...t},{image:s,depth:o,mipLevel:a,x:l,y:c,z:u,flipY:d}=r;let{width:h,height:f}=r;const{dimension:p,glTarget:g,glFormat:_,glInternalFormat:b,glType:w}=this;if(h=Math.min(h,this.width-l),f=Math.min(f,this.height-c),t.sourceX||t.sourceY)throw new Error("WebGL does not support sourceX/sourceY)");return Jh(this.device.gl,this.handle,s,{dimension:p,mipLevel:a,x:l,y:c,z:u,width:h,height:f,depth:o,glFormat:_,glInternalFormat:b,glType:w,glTarget:g,flipY:d}),{width:r.width,height:r.height}}setTexture1DData(t){throw new Error("setTexture1DData not supported in WebGL.")}setTexture2DData(t,i=0){this.bind();const r=fe.normalizeTextureData(t,this);r.length>1&&this.props.mipmaps!==!1&&L.warn(`Texture ${this.id} mipmap and multiple LODs.`)();for(let s=0;s<r.length;s++){const o=r[s];this._setMipLevel(i,s,o)}this.unbind()}setTexture3DData(t){if(this.props.dimension!=="3d")throw new Error(this.id);ArrayBuffer.isView(t)&&(this.bind(),ef(this.device.gl,t,this),this.unbind())}setTextureCubeData(t,i=0){if(this.props.dimension!=="cube")throw new Error(this.id);for(const r of fe.CubeFaces)this.setTextureCubeFaceData(t[r],r)}setTextureArrayData(t){throw this.props.dimension!=="2d-array"?new Error(this.id):new Error("setTextureArrayData not implemented.")}setTextureCubeArrayData(t){throw new Error("setTextureCubeArrayData not supported in WebGL2.")}setTextureCubeFaceData(t,i,r=0){Array.isArray(t)&&t.length>1&&this.props.mipmaps!==!1&&L.warn(`${this.id} has mipmap and multiple LODs.`)();const s=fe.CubeFaces.indexOf(i);this.setTexture2DData(t,s)}update(){throw new Error("Texture.update() not implemented. Use ExternalTexture")}setImageDataForFace(t){const{face:i,width:r,height:s,pixels:o,data:a,format:l=6408,type:c=5121}=t,{gl:u}=this,d=o||a;this.bind(),d instanceof Promise?d.then(h=>this.setImageDataForFace(Object.assign({},t,{face:i,data:h,pixels:h}))):this.width||this.height?u.texImage2D(i,0,l,r,s,0,l,c,d):u.texImage2D(i,0,l,l,c,d)}_getImageDataMap(t){for(let i=0;i<fe.CubeFaces.length;++i){const r=fe.CubeFaces[i];t[r]&&(t[34069+i]=t[r],delete t[r])}return t}_setSamplerParameters(t){L.log(1,`${this.id} sampler parameters`,this.device.getGLKeys(t))(),this.gl.bindTexture(this.glTarget,this.handle);for(const[i,r]of Object.entries(t)){const s=Number(i),o=r;switch(s){case 33082:case 33083:this.gl.texParameterf(this.glTarget,s,o);break;case 10241:this.gl.texParameteri(this.glTarget,s,o);break;case 10242:case 10243:this.gl.texParameteri(this.glTarget,s,o);break;case 34046:this.device.features.has("texture-filterable-anisotropic-webgl")&&this.gl.texParameteri(this.glTarget,s,o);break;default:this.gl.texParameteri(this.glTarget,s,o);break}}this.gl.bindTexture(this.glTarget,null)}_setMipLevel(t,i,r,s=this.glTarget){if(fe.isExternalImage(r)){Jh(this.device.gl,this.handle,r,{...this,depth:t,mipLevel:i,glTarget:s,flipY:this.props.flipY});return}if(fe.isTextureLevelData(r)){ef(this.device.gl,r.data,{...this,depth:t,mipLevel:i,glTarget:s});return}throw new Error("Texture: invalid image data")}getActiveUnit(){return this.gl.getParameter(34016)-33984}bind(t){const{gl:i}=this;return t!==void 0&&(this.textureUnit=t,i.activeTexture(33984+t)),i.bindTexture(this.glTarget,this.handle),t}unbind(t){const{gl:i}=this;return t!==void 0&&(this.textureUnit=t,i.activeTexture(33984+t)),i.bindTexture(this.glTarget,null),t}}const qM=[1,2,4,8];class KM extends cl{constructor(t,i){var o;super(t,i);m(this,"device");m(this,"glParameters");this.device=t;let r;if(!((o=i==null?void 0:i.parameters)!=null&&o.viewport))if(i!=null&&i.framebuffer){const{width:a,height:l}=i.framebuffer;r=[0,0,a,l]}else{const[a,l]=t.getCanvasContext().getDrawingBufferSize();r=[0,0,a,l]}this.device.pushState(),this.setParameters({viewport:r,...this.props.parameters});const s=this.props.framebuffer;if(s!=null&&s.handle)if(this.props.framebuffer){const a=this.props.framebuffer.colorAttachments.map((l,c)=>36064+c);this.device.gl.drawBuffers(a)}else this.device.gl.drawBuffers([1029]);this.clear()}end(){this.device.popState()}pushDebugGroup(t){}popDebugGroup(){}insertDebugMarker(t){}setParameters(t={}){const i={...this.glParameters};i.framebuffer=this.props.framebuffer||null,this.props.depthReadOnly&&(i.depthMask=!this.props.depthReadOnly),i.stencilMask=this.props.stencilReadOnly?0:1,i[35977]=this.props.discard,t.viewport&&(t.viewport.length>=6?(i.viewport=t.viewport.slice(0,4),i.depthRange=[t.viewport[4],t.viewport[5]]):i.viewport=t.viewport),t.scissorRect&&(i.scissorTest=!0,i.scissor=t.scissorRect),t.blendConstant&&(i.blendColor=t.blendConstant),t.stencilReference&&(console.warn("RenderPassParameters.stencilReference not yet implemented in WebGL"),t[2967]=t.stencilReference),t.colorMask&&(i.colorMask=qM.map(r=>!!(r&t.colorMask))),this.glParameters=i,ci(this.device.gl,i)}beginOcclusionQuery(t){const i=this.props.occlusionQuerySet;i==null||i.beginOcclusionQuery()}endOcclusionQuery(){const t=this.props.occlusionQuerySet;t==null||t.endOcclusionQuery()}clear(){const t={...this.glParameters};let i=0;this.props.clearColors&&this.props.clearColors.forEach((r,s)=>{r&&this.clearColorBuffer(s,r)}),this.props.clearColor!==!1&&this.props.clearColors===void 0&&(i|=16384,t.clearColor=this.props.clearColor),this.props.clearDepth!==!1&&(i|=256,t.clearDepth=this.props.clearDepth),this.props.clearStencil!==!1&&(i|=1024,t.clearStencil=this.props.clearStencil),i!==0&&Xs(this.device.gl,t,()=>{this.device.gl.clear(i)})}clearColorBuffer(t=0,i=[0,0,0,0]){Xs(this.device.gl,{framebuffer:this.props.framebuffer},()=>{switch(i.constructor){case Int8Array:case Int16Array:case Int32Array:this.device.gl.clearBufferiv(6144,t,i);break;case Uint8Array:case Uint8ClampedArray:case Uint16Array:case Uint32Array:this.device.gl.clearBufferuiv(6144,t,i);break;case Float32Array:this.device.gl.clearBufferfv(6144,t,i);break;default:throw new Error("clearColorBuffer: color must be typed array")}})}}function ZM(n){return GM.includes(n)}const GM=[35678,35680,35679,35682,36289,36292,36293,36298,36299,36300,36303,36306,36307,36308,36311],b_={5126:[5126,1,"float","f32","float32"],35664:[5126,2,"vec2","vec2<f32>","float32x2"],35665:[5126,3,"vec3","vec3<f32>","float32x3"],35666:[5126,4,"vec4","vec4<f32>","float32x4"],5124:[5124,1,"int","i32","sint32"],35667:[5124,2,"ivec2","vec2<i32>","sint32x2"],35668:[5124,3,"ivec3","vec3<i32>","sint32x3"],35669:[5124,4,"ivec4","vec4<i32>","sint32x4"],5125:[5125,1,"uint","u32","uint32"],36294:[5125,2,"uvec2","vec2<u32>","uint32x2"],36295:[5125,3,"uvec3","vec3<u32>","uint32x3"],36296:[5125,4,"uvec4","vec4<u32>","uint32x4"],35670:[5126,1,"bool","f32","float32"],35671:[5126,2,"bvec2","vec2<f32>","float32x2"],35672:[5126,3,"bvec3","vec3<f32>","float32x3"],35673:[5126,4,"bvec4","vec4<f32>","float32x4"],35674:[5126,8,"mat2","mat2x2<f32>"],35685:[5126,8,"mat2x3","mat2x3<f32>"],35686:[5126,8,"mat2x4","mat2x4<f32>"],35687:[5126,12,"mat3x2","mat3x2<f32>"],35675:[5126,12,"mat3","mat3x3<f32>"],35688:[5126,12,"mat3x4","mat3x4<f32>"],35689:[5126,16,"mat4x2","mat4x2<f32>"],35690:[5126,16,"mat4x3","mat4x3<f32>"],35676:[5126,16,"mat4","mat4x4<f32>"]};function v_(n){const e=b_[n];if(!e)throw new Error("uniform");const[t,i,,r]=e;return{format:r,components:i,glType:t}}function QM(n){const e=b_[n];if(!e)throw new Error("attribute");const[,t,,i,r]=e;return{attributeType:i,vertexFormat:r,components:t}}function JM(n,e){const t={attributes:[],bindings:[]};t.attributes=ek(n,e);const i=ik(n,e);for(const a of i){const l=a.uniforms.map(c=>({name:c.name,format:c.format,byteOffset:c.byteOffset,byteStride:c.byteStride,arrayLength:c.arrayLength}));t.bindings.push({type:"uniform",name:a.name,group:0,location:a.location,visibility:(a.vertex?1:0)&(a.fragment?2:0),minBindingSize:a.byteLength,uniforms:l})}const r=nk(n,e);let s=0;for(const a of r)if(ZM(a.type)){const{viewDimension:l,sampleType:c}=sk(a.type);t.bindings.push({type:"texture",name:a.name,group:0,location:s,viewDimension:l,sampleType:c}),a.textureUnit=s,s+=1}r.length&&(t.uniforms=r);const o=tk(n,e);return o!=null&&o.length&&(t.varyings=o),t}function ek(n,e){const t=[],i=n.getProgramParameter(e,35721);for(let r=0;r<i;r++){const s=n.getActiveAttrib(e,r);if(!s)throw new Error("activeInfo");const{name:o,type:a}=s,l=n.getAttribLocation(e,o);if(l>=0){const{attributeType:c}=QM(a),u=/instance/i.test(o)?"instance":"vertex";t.push({name:o,location:l,stepMode:u,type:c})}}return t.sort((r,s)=>r.location-s.location),t}function tk(n,e){const t=[],i=n.getProgramParameter(e,35971);for(let r=0;r<i;r++){const s=n.getTransformFeedbackVarying(e,r);if(!s)throw new Error("activeInfo");const{name:o,type:a,size:l}=s,{glType:c,components:u}=v_(a),d={location:r,name:o,type:c,size:l*u};t.push(d)}return t.sort((r,s)=>r.location-s.location),t}function nk(n,e){const t=[],i=n.getProgramParameter(e,35718);for(let r=0;r<i;r++){const s=n.getActiveUniform(e,r);if(!s)throw new Error("activeInfo");const{name:o,size:a,type:l}=s,{name:c,isArray:u}=ok(o);let d=n.getUniformLocation(e,c);const h={location:d,name:c,size:a,type:l,isArray:u};if(t.push(h),h.size>1)for(let f=0;f<h.size;f++){const p=`${c}[${f}]`;d=n.getUniformLocation(e,p);const g={...h,name:p,location:d};t.push(g)}}return t}function ik(n,e){const t=(s,o)=>n.getActiveUniformBlockParameter(e,s,o),i=[],r=n.getProgramParameter(e,35382);for(let s=0;s<r;s++){const o={name:n.getActiveUniformBlockName(e,s)||"",location:t(s,35391),byteLength:t(s,35392),vertex:t(s,35396),fragment:t(s,35398),uniformCount:t(s,35394),uniforms:[]},a=t(s,35395)||[],l=n.getActiveUniforms(e,a,35383),c=n.getActiveUniforms(e,a,35384),u=n.getActiveUniforms(e,a,35387),d=n.getActiveUniforms(e,a,35388);for(let h=0;h<o.uniformCount;++h){const f=n.getActiveUniform(e,a[h]);if(!f)throw new Error("activeInfo");o.uniforms.push({name:f.name,format:v_(l[h]).format,type:l[h],arrayLength:c[h],byteOffset:u[h],byteStride:d[h]})}i.push(o)}return i.sort((s,o)=>s.location-o.location),i}const rk={35678:["2d","float"],35680:["cube","float"],35679:["3d","float"],35682:["3d","depth"],36289:["2d-array","float"],36292:["2d-array","depth"],36293:["cube","float"],36298:["2d","sint"],36299:["3d","sint"],36300:["cube","sint"],36303:["2d-array","uint"],36306:["2d","uint"],36307:["3d","uint"],36308:["cube","uint"],36311:["2d-array","uint"]};function sk(n){const e=rk[n];if(!e)throw new Error("sampler");const[t,i]=e;return{viewDimension:t,sampleType:i}}function ok(n){if(n[n.length-1]!=="]")return{name:n,length:1,isArray:!1};const t=/([^[]*)(\[[0-9]+\])?/.exec(n);if(!t||t.length<2)throw new Error(`Failed to parse GLSL uniform name ${n}`);return{name:t[1],length:t[2]?1:0,isArray:!!t[2]}}function ak(n,e,t,i){const r=n;let s=i;s===!0&&(s=1),s===!1&&(s=0);const o=typeof s=="number"?[s]:s;switch(t){case 35678:case 35680:case 35679:case 35682:case 36289:case 36292:case 36293:case 36298:case 36299:case 36300:case 36303:case 36306:case 36307:case 36308:case 36311:if(typeof i!="number")throw new Error("samplers must be set to integers");return n.uniform1i(e,i);case 5126:return n.uniform1fv(e,o);case 35664:return n.uniform2fv(e,o);case 35665:return n.uniform3fv(e,o);case 35666:return n.uniform4fv(e,o);case 5124:return n.uniform1iv(e,o);case 35667:return n.uniform2iv(e,o);case 35668:return n.uniform3iv(e,o);case 35669:return n.uniform4iv(e,o);case 35670:return n.uniform1iv(e,o);case 35671:return n.uniform2iv(e,o);case 35672:return n.uniform3iv(e,o);case 35673:return n.uniform4iv(e,o);case 5125:return r.uniform1uiv(e,o,1);case 36294:return r.uniform2uiv(e,o,2);case 36295:return r.uniform3uiv(e,o,3);case 36296:return r.uniform4uiv(e,o,4);case 35674:return n.uniformMatrix2fv(e,!1,o);case 35675:return n.uniformMatrix3fv(e,!1,o);case 35676:return n.uniformMatrix4fv(e,!1,o);case 35685:return r.uniformMatrix2x3fv(e,!1,o);case 35686:return r.uniformMatrix2x4fv(e,!1,o);case 35687:return r.uniformMatrix3x2fv(e,!1,o);case 35688:return r.uniformMatrix3x4fv(e,!1,o);case 35689:return r.uniformMatrix4x2fv(e,!1,o);case 35690:return r.uniformMatrix4x3fv(e,!1,o)}throw new Error("Illegal uniform")}function lk(n){return e_(n)!==null||typeof n=="number"||typeof n=="boolean"}function ck(n){const e={bindings:{},uniforms:{}};return Object.keys(n).forEach(t=>{const i=n[t];lk(i)?e.uniforms[t]=i:e.bindings[t]=i}),e}function uk(n){switch(n){case"point-list":return 0;case"line-list":return 1;case"line-strip":return 3;case"triangle-list":return 4;case"triangle-strip":return 5;default:throw new Error(n)}}function dk(n){switch(n){case"point-list":return 0;case"line-list":return 1;case"line-strip":return 1;case"triangle-list":return 4;case"triangle-strip":return 4;default:throw new Error(n)}}const tf=4;class hk extends Qn{constructor(t,i){super(t,i);m(this,"device");m(this,"handle");m(this,"vs");m(this,"fs");m(this,"introspectedLayout");m(this,"uniforms",{});m(this,"bindings",{});m(this,"varyings",null);m(this,"_uniformCount",0);m(this,"_uniformSetters",{});this.device=t,this.handle=this.props.handle||this.device.gl.createProgram(),this.device.setSpectorMetadata(this.handle,{id:this.props.id}),this.vs=i.vs,this.fs=i.fs;const{varyings:r,bufferMode:s=35981}=i;r&&r.length>0&&(this.varyings=r,this.device.gl.transformFeedbackVaryings(this.handle,r,s)),this._linkShaders(),L.time(1,`RenderPipeline ${this.id} - shaderLayout introspection`)(),this.introspectedLayout=JM(this.device.gl,this.handle),L.timeEnd(1,`RenderPipeline ${this.id} - shaderLayout introspection`)(),this.shaderLayout=fk(this.introspectedLayout,i.shaderLayout)}destroy(){this.handle&&(this.device.gl.deleteProgram(this.handle),this.destroyed=!0)}setBindings(t,i){for(const[r,s]of Object.entries(t)){const o=this.shaderLayout.bindings.find(a=>a.name===r)||this.shaderLayout.bindings.find(a=>a.name===`${r}Uniforms`);if(!o){const a=this.shaderLayout.bindings.map(l=>`"${l.name}"`).join(", ");i!=null&&i.disableWarnings||L.warn(`No binding "${r}" in render pipeline "${this.id}", expected one of ${a}`,s)();continue}switch(s||L.warn(`Unsetting binding "${r}" in render pipeline "${this.id}"`)(),o.type){case"uniform":if(!(s instanceof Ni)&&!(s.buffer instanceof Ni))throw new Error("buffer value");break;case"texture":if(!(s instanceof Vn||s instanceof Fi||s instanceof Oi))throw new Error("texture value");break;case"sampler":L.warn(`Ignoring sampler ${r}`)();break;default:throw new Error(o.type)}this.bindings[r]=s}}draw(t){var _;const{renderPass:i,parameters:r=this.props.parameters,topology:s=this.props.topology,vertexArray:o,vertexCount:a,instanceCount:l,isInstanced:c=!1,firstVertex:u=0,transformFeedback:d}=t,h=uk(s),f=!!o.indexBuffer,p=(_=o.indexBuffer)==null?void 0:_.glIndexType;if(this.linkStatus!=="success")return L.info(2,`RenderPipeline:${this.id}.draw() aborted - waiting for shader linking`)(),!1;if(!this._areTexturesRenderable())return L.info(2,`RenderPipeline:${this.id}.draw() aborted - textures not yet loaded`)(),!1;this.device.gl.useProgram(this.handle),o.bindBeforeRender(i),d&&d.begin(this.props.topology),this._applyBindings(),this._applyUniforms();const g=i;return MM(this.device,r,g.glParameters,()=>{f&&c?this.device.gl.drawElementsInstanced(h,a||0,p,u,l||0):f?this.device.gl.drawElements(h,a||0,p,u):c?this.device.gl.drawArraysInstanced(h,u,a||0,l||0):this.device.gl.drawArrays(h,u,a||0),d&&d.end()}),o.unbindAfterRender(i),!0}setUniformsWebGL(t){const{bindings:i}=ck(t);Object.keys(i).forEach(r=>{L.warn(`Unsupported value "${JSON.stringify(i[r])}" used in setUniforms() for key ${r}. Use setBindings() instead?`)()}),Object.assign(this.uniforms,t)}async _linkShaders(){const{gl:t}=this.device;if(t.attachShader(this.handle,this.vs.handle),t.attachShader(this.handle,this.fs.handle),L.time(tf,`linkProgram for ${this.id}`)(),t.linkProgram(this.handle),L.timeEnd(tf,`linkProgram for ${this.id}`)(),L.level,!this.device.features.has("compilation-status-async-webgl")){const r=this._getLinkStatus();this._reportLinkStatus(r);return}L.once(1,"RenderPipeline linking is asynchronous")(),await this._waitForLinkComplete(),L.info(2,`RenderPipeline ${this.id} - async linking complete: ${this.linkStatus}`)();const i=this._getLinkStatus();this._reportLinkStatus(i)}async _reportLinkStatus(t){var i;switch(t){case"success":return;default:switch(this.vs.compilationStatus){case"error":throw this.vs.debugShader(),new Error(`Error during compilation of shader ${this.vs.id}`);case"pending":this.vs.asyncCompilationStatus.then(()=>this.vs.debugShader());break}switch((i=this.fs)==null?void 0:i.compilationStatus){case"error":throw this.fs.debugShader(),new Error(`Error during compilation of shader ${this.fs.id}`);case"pending":this.fs.asyncCompilationStatus.then(()=>this.fs.debugShader());break}const r=this.device.gl.getProgramInfoLog(this.handle);throw new Error(`Error during ${t}: ${r}`)}}_getLinkStatus(){const{gl:t}=this.device;return t.getProgramParameter(this.handle,35714)?(t.validateProgram(this.handle),t.getProgramParameter(this.handle,35715)?(this.linkStatus="success","success"):(this.linkStatus="error","validation")):(this.linkStatus="error","linking")}async _waitForLinkComplete(){const t=async s=>await new Promise(o=>setTimeout(o,s));if(!this.device.features.has("compilation-status-async-webgl")){await t(10);return}const{gl:r}=this.device;for(;;){if(r.getProgramParameter(this.handle,37297))return;await t(10)}}_areTexturesRenderable(){let t=!0;for(const i of this.shaderLayout.bindings)!this.bindings[i.name]&&!this.bindings[i.name.replace(/Uniforms$/,"")]&&(L.warn(`Binding ${i.name} not found in ${this.id}`)(),t=!1);return t}_applyBindings(){if(this.linkStatus!=="success")return;const{gl:t}=this.device;t.useProgram(this.handle);let i=0,r=0;for(const s of this.shaderLayout.bindings){const o=this.bindings[s.name]||this.bindings[s.name.replace(/Uniforms$/,"")];if(!o)throw new Error(`No value for binding ${s.name} in ${this.id}`);switch(s.type){case"uniform":const{name:a}=s,l=t.getUniformBlockIndex(this.handle,a);if(l===4294967295)throw new Error(`Invalid uniform block name ${a}`);t.uniformBlockBinding(this.handle,r,l),o instanceof Ni?t.bindBufferBase(35345,r,o.handle):t.bindBufferRange(35345,r,o.buffer.handle,o.offset||0,o.size||o.buffer.byteLength-o.offset),r+=1;break;case"texture":if(!(o instanceof Vn||o instanceof Fi||o instanceof Oi))throw new Error("texture");let c;if(o instanceof Vn)c=o.texture;else if(o instanceof Fi)c=o;else if(o instanceof Oi&&o.colorAttachments[0]instanceof Vn)L.warn("Passing framebuffer in texture binding may be deprecated. Use fbo.colorAttachments[0] instead")(),c=o.colorAttachments[0].texture;else throw new Error("No texture");t.activeTexture(33984+i),t.bindTexture(c.glTarget,c.handle),i+=1;break;case"sampler":break;case"storage":case"read-only-storage":throw new Error(`binding type '${s.type}' not supported in WebGL`)}}}_applyUniforms(){for(const t of this.shaderLayout.uniforms||[]){const{name:i,location:r,type:s,textureUnit:o}=t,a=this.uniforms[i]??o;a!==void 0&&ak(this.device.gl,r,s,a)}}}function fk(n,e){const t={...n,attributes:n.attributes.map(i=>({...i}))};for(const i of(e==null?void 0:e.attributes)||[]){const r=t.attributes.find(s=>s.name===i.name);r?(r.type=i.type||r.type,r.stepMode=i.stepMode||r.stepMode):L.warn(`shader layout attribute ${i.name} not present in shader`)}return t}class pk extends dl{constructor(t){super(t,{});m(this,"device");m(this,"commands",[]);this.device=t}submitCommands(t=this.commands){for(const i of t)switch(i.name){case"copy-buffer-to-buffer":gk(this.device,i.options);break;case"copy-buffer-to-texture":mk(this.device,i.options);break;case"copy-texture-to-buffer":_k(this.device,i.options);break;case"copy-texture-to-texture":yk(this.device,i.options);break;default:throw new Error(i.name)}}}function gk(n,e){const t=e.sourceBuffer,i=e.destinationBuffer;n.gl.bindBuffer(36662,t.handle),n.gl.bindBuffer(36663,i.handle),n.gl.copyBufferSubData(36662,36663,e.sourceOffset??0,e.destinationOffset??0,e.size),n.gl.bindBuffer(36662,null),n.gl.bindBuffer(36663,null)}function mk(n,e){throw new Error("Not implemented")}function _k(n,e){const{sourceTexture:t,mipLevel:i=0,aspect:r="all",width:s=e.sourceTexture.width,height:o=e.sourceTexture.height,depthOrArrayLayers:a=0,origin:l=[0,0],destinationBuffer:c,byteOffset:u=0,bytesPerRow:d,rowsPerImage:h}=e;if(r!=="all")throw new Error("aspect not supported in WebGL");if(i!==0||a!==0||d||h)throw new Error("not implemented");const{framebuffer:f,destroyFramebuffer:p}=x_(t);let g;try{const _=c,b=s||f.width,w=o||f.height,x=h_(f.colorAttachments[0].texture.props.format),y=x.format,S=x.type;n.gl.bindBuffer(35051,_.handle),g=n.gl.bindFramebuffer(36160,f.handle),n.gl.readPixels(l[0],l[1],b,w,y,S,u)}finally{n.gl.bindBuffer(35051,null),g!==void 0&&n.gl.bindFramebuffer(36160,g),p&&f.destroy()}}function yk(n,e){const{sourceTexture:t,destinationMipLevel:i=0,origin:r=[0,0],destinationOrigin:s=[0,0],destinationTexture:o}=e;let{width:a=e.destinationTexture.width,height:l=e.destinationTexture.height}=e;const{framebuffer:c,destroyFramebuffer:u}=x_(t),[d,h]=r,[f,p,g]=s,_=n.gl.bindFramebuffer(36160,c.handle);let b=null,w;if(o instanceof Fi)b=o,a=Number.isFinite(a)?a:b.width,l=Number.isFinite(l)?l:b.height,b.bind(0),w=b.glTarget;else throw new Error("invalid destination");switch(w){case 3553:case 34067:n.gl.copyTexSubImage2D(w,i,f,p,d,h,a,l);break;case 35866:case 32879:n.gl.copyTexSubImage3D(w,i,f,p,g,d,h,a,l);break}b&&b.unbind(),n.gl.bindFramebuffer(36160,_),u&&c.destroy()}function x_(n){if(n instanceof fe){const{width:e,height:t,id:i}=n;return{framebuffer:n.device.createFramebuffer({id:`framebuffer-for-${i}`,width:e,height:t,colorAttachments:[n]}),destroyFramebuffer:!0}}return{framebuffer:n,destroyFramebuffer:!1}}class bk extends ul{constructor(t,i){super(t,i);m(this,"device");m(this,"commandBuffer");this.device=t,this.commandBuffer=new pk(t)}destroy(){}finish(){this.commandBuffer.submitCommands()}copyBufferToBuffer(t){this.commandBuffer.commands.push({name:"copy-buffer-to-buffer",options:t})}copyBufferToTexture(t){this.commandBuffer.commands.push({name:"copy-buffer-to-texture",options:t})}copyTextureToBuffer(t){this.commandBuffer.commands.push({name:"copy-texture-to-buffer",options:t})}copyTextureToTexture(t){this.commandBuffer.commands.push({name:"copy-texture-to-texture",options:t})}pushDebugGroup(t){}popDebugGroup(){}insertDebugMarker(t){}resolveQuerySet(t,i,r){}}function vk(n){const{target:e,source:t,start:i=0,count:r=1}=n,s=t.length,o=r*s;let a=0;for(let l=i;a<s;a++)e[l++]=t[a];for(;a<o;)a<o-a?(e.copyWithin(i+a,i,i+a),a*=2):(e.copyWithin(i+a,i,i+o-a),a=o);return n.target}class su extends hl{constructor(t,i){super(t,i);m(this,"device");m(this,"handle");m(this,"buffer",null);m(this,"bufferValue",null);this.device=t,this.handle=this.device.gl.createVertexArray()}get[Symbol.toStringTag](){return"VertexArray"}static isConstantAttributeZeroSupported(t){return jS()==="Chrome"}destroy(){var t;super.destroy(),this.buffer&&((t=this.buffer)==null||t.destroy()),this.handle&&(this.device.gl.deleteVertexArray(this.handle),this.handle=void 0)}setIndexBuffer(t){const i=t;if(i&&i.glTarget!==34963)throw new Error("Use .setBuffer()");this.device.gl.bindVertexArray(this.handle),this.device.gl.bindBuffer(34963,i?i.handle:null),this.indexBuffer=i,this.device.gl.bindVertexArray(null)}setBuffer(t,i){const r=i;if(r.glTarget===34963)throw new Error("Use .setIndexBuffer()");const{size:s,type:o,stride:a,offset:l,normalized:c,integer:u,divisor:d}=this._getAccessor(t);this.device.gl.bindVertexArray(this.handle),this.device.gl.bindBuffer(34962,r.handle),u?this.device.gl.vertexAttribIPointer(t,s,o,a,l):this.device.gl.vertexAttribPointer(t,s,o,c,a,l),this.device.gl.bindBuffer(34962,null),this.device.gl.enableVertexAttribArray(t),this.device.gl.vertexAttribDivisor(t,d||0),this.attributes[t]=r,this.device.gl.bindVertexArray(null)}setConstantWebGL(t,i){this._enable(t,!1),this.attributes[t]=i}bindBeforeRender(){this.device.gl.bindVertexArray(this.handle),this._applyConstantAttributes()}unbindAfterRender(){this.device.gl.bindVertexArray(null)}_applyConstantAttributes(){for(let t=0;t<this.maxVertexAttributes;++t){const i=this.attributes[t];ArrayBuffer.isView(i)&&this.device.setConstantAttributeWebGL(t,i)}}_getAccessor(t){const i=this.attributeInfos[t];if(!i)throw new Error(`Unknown attribute location ${t}`);const r=d_(i.bufferDataType);return{size:i.bufferComponents,type:r,stride:i.byteStride,offset:i.byteOffset,normalized:i.normalized,integer:i.integer,divisor:i.stepMode==="instance"?1:0}}_enable(t,i=!0){const s=su.isConstantAttributeZeroSupported(this.device)||t!==0;(i||s)&&(t=Number(t),this.device.gl.bindVertexArray(this.handle),i?this.device.gl.enableVertexAttribArray(t):this.device.gl.disableVertexAttribArray(t),this.device.gl.bindVertexArray(null))}getConstantBuffer(t,i){const r=xk(i),s=r.byteLength*t,o=r.length*t;if(this.buffer&&s!==this.buffer.byteLength)throw new Error(`Buffer size is immutable, byte length ${s} !== ${this.buffer.byteLength}.`);let a=!this.buffer;if(this.buffer=this.buffer||this.device.createBuffer({byteLength:s}),a=a||!wk(r,this.bufferValue),a){const l=kC(i.constructor,o);vk({target:l,source:r,start:0,count:o}),this.buffer.write(l),this.bufferValue=i}return this.buffer}}function xk(n){return Array.isArray(n)?new Float32Array(n):n}function wk(n,e){if(!n||!e||n.length!==e.length||n.constructor!==e.constructor)return!1;for(let t=0;t<n.length;++t)if(n[t]!==e[t])return!1;return!0}class Tk extends fl{constructor(t,i){super(t,i);m(this,"device");m(this,"gl");m(this,"handle");m(this,"layout");m(this,"buffers",{});m(this,"unusedBuffers",{});m(this,"bindOnUse",!0);m(this,"_bound",!1);this.device=t,this.gl=t.gl,this.handle=this.props.handle||this.gl.createTransformFeedback(),this.layout=this.props.layout,i.buffers&&this.setBuffers(i.buffers),Object.seal(this)}destroy(){this.gl.deleteTransformFeedback(this.handle),super.destroy()}begin(t="point-list"){this.gl.bindTransformFeedback(36386,this.handle),this.bindOnUse&&this._bindBuffers(),this.gl.beginTransformFeedback(dk(t))}end(){this.gl.endTransformFeedback(),this.bindOnUse&&this._unbindBuffers(),this.gl.bindTransformFeedback(36386,null)}setBuffers(t){this.buffers={},this.unusedBuffers={},this.bind(()=>{for(const i in t)this.setBuffer(i,t[i])})}setBuffer(t,i){const r=this._getVaryingIndex(t),{buffer:s,byteLength:o,byteOffset:a}=this._getBufferRange(i);if(r<0){this.unusedBuffers[t]=s,L.warn(`${this.id} unusedBuffers varying buffer ${t}`)();return}this.buffers[r]={buffer:s,byteLength:o,byteOffset:a},this.bindOnUse||this._bindBuffer(r,s,a,o)}getBuffer(t){if(nf(t))return this.buffers[t]||null;const i=this._getVaryingIndex(t);return i>=0?this.buffers[i]:null}bind(t=this.handle){if(typeof t!="function")return this.gl.bindTransformFeedback(36386,t),this;let i;return this._bound?i=t():(this.gl.bindTransformFeedback(36386,this.handle),this._bound=!0,i=t(),this._bound=!1,this.gl.bindTransformFeedback(36386,null)),i}unbind(){this.bind(null)}_getBufferRange(t){if(t instanceof Ni)return{buffer:t,byteOffset:0,byteLength:t.byteLength};const{buffer:i,byteOffset:r=0,byteLength:s=t.buffer.byteLength}=t;return{buffer:i,byteOffset:r,byteLength:s}}_getVaryingIndex(t){if(nf(t))return Number(t);for(const i of this.layout.varyings)if(t===i.name)return i.location;return-1}_bindBuffers(){for(const t in this.buffers){const{buffer:i,byteLength:r,byteOffset:s}=this._getBufferRange(this.buffers[t]);this._bindBuffer(Number(t),i,s,r)}}_unbindBuffers(){for(const t in this.buffers)this.gl.bindBufferBase(35982,Number(t),null)}_bindBuffer(t,i,r=0,s){const o=i&&i.handle;!o||s===void 0?this.gl.bindBufferBase(35982,t,o):this.gl.bindBufferRange(35982,t,o,r,s)}}function nf(n){return typeof n=="number"?Number.isInteger(n):/^\d+$/.test(n)}class Sk extends pl{constructor(t,i){super(t,i);m(this,"device");m(this,"handle");m(this,"target",null);m(this,"_queryPending",!1);m(this,"_pollingPromise",null);if(this.device=t,i.count>1)throw new Error("WebGL QuerySet can only have one value");this.handle=this.device.gl.createQuery(),Object.seal(this)}get[Symbol.toStringTag](){return"Query"}destroy(){this.device.gl.deleteQuery(this.handle)}beginTimestampQuery(){return this._begin(35007)}endTimestampQuery(){this._end()}beginOcclusionQuery(t){return this._begin(t!=null&&t.conservative?36202:35887)}endOcclusionQuery(){this._end()}beginTransformFeedbackQuery(){return this._begin(35976)}endTransformFeedbackQuery(){this._end()}async resolveQuery(){return[await this.pollQuery()]}_begin(t){this._queryPending||(this.target=t,this.device.gl.beginQuery(this.target,this.handle))}_end(){this._queryPending||this.target&&(this.device.gl.endQuery(this.target),this.target=null,this._queryPending=!0)}isResultAvailable(){if(!this._queryPending)return!1;const t=this.device.gl.getQueryParameter(this.handle,34919);return t&&(this._queryPending=!1),t}isTimerDisjoint(){return this.device.gl.getParameter(36795)}getResult(){return this.device.gl.getQueryParameter(this.handle,34918)}getTimerMilliseconds(){return this.getResult()/1e6}pollQuery(t=Number.POSITIVE_INFINITY){if(this._pollingPromise)return this._pollingPromise;let i=0;return this._pollingPromise=new Promise((r,s)=>{const o=()=>{this.isResultAvailable()?(r(this.getResult()),this._pollingPromise=null):i++>t?(s("Timed out"),this._pollingPromise=null):requestAnimationFrame(o)};requestAnimationFrame(o)}),this._pollingPromise}}class Wn extends qt{constructor(t){var d,h;super({...t,id:t.id||AM("webgl-device")});m(this,"type","webgl");m(this,"handle");m(this,"features");m(this,"limits");m(this,"info");m(this,"canvasContext");m(this,"lost");m(this,"_resolveContextLost");m(this,"gl");m(this,"debug",!1);m(this,"_canvasSizeInfo",{clientWidth:0,clientHeight:0,devicePixelRatio:1});m(this,"_extensions",{});m(this,"_polyfilled",!1);m(this,"spectorJS");m(this,"renderPass",null);m(this,"_constants");const i=qt._getCanvasContextProps(t);if(!i)throw new Error("WebGLDevice requires props.createCanvasContext to be set");let r=(h=(d=i.canvas)==null?void 0:d.gl)==null?void 0:h.device;if(r)throw new Error(`WebGL context already attached to device ${r.id}`);this.canvasContext=new gM(this,i),this.lost=new Promise(f=>{this._resolveContextLost=f});const s={...t.webgl};i.alphaMode==="premultiplied"&&(s.premultipliedAlpha=!0),t.powerPreference!==void 0&&(s.powerPreference=t.powerPreference);const a=this.props._handle||KP(this.canvasContext.canvas,{onContextLost:f=>{var p;return(p=this._resolveContextLost)==null?void 0:p.call(this,{reason:"destroyed",message:"Entered sleep mode, or too many apps or browser tabs are using the GPU."})},onContextRestored:f=>console.log("WebGL context restored")},s);if(!a)throw new Error("WebGL context creation failed");if(r=a.device,r){if(t._reuseDevices)return L.log(1,`Not creating a new Device, instead returning a reference to Device ${r.id} already attached to WebGL context`,r)(),r._reused=!0,r;throw new Error(`WebGL context already attached to device ${r.id}`)}this.handle=a,this.gl=a,this.spectorJS=yM({...this.props,gl:this.handle}),this.gl.device=this,this.gl._version=2,this.info=ZP(this.gl,this._extensions),this.limits=new hM(this.gl),this.features=new dM(this.gl,this._extensions,this.props._disabledFeatures),this.props._initializeFeatures&&this.features.initializeFeatures(),i.autoResize!==!1&&this.canvasContext.resize(),new pn(this.gl,{log:(...f)=>L.log(1,...f)()}).trackState(this.gl,{copyState:!1});const c=t.debugWebGL||t.debug,u=t.debugWebGL;c&&(this.gl=xM(this.gl,{debugWebGL:c,traceWebGL:u}),L.warn("WebGL debug mode activated. Performance reduced.")(),t.debugWebGL&&(L.level=Math.max(L.level,1)))}destroy(){!this.props._reuseDevices&&!this._reused&&delete this.gl.device}get isLost(){return this.gl.isContextLost()}createCanvasContext(t){throw new Error("WebGL only supports a single canvas")}createBuffer(t){const i=this._normalizeBufferProps(t);return new Ni(this,i)}createTexture(t){return new Fi(this,t)}createExternalTexture(t){throw new Error("createExternalTexture() not implemented")}createSampler(t){return new Fl(this,t)}createShader(t){return new PM(this,t)}createFramebuffer(t){return new Oi(this,t)}createVertexArray(t){return new su(this,t)}createTransformFeedback(t){return new Tk(this,t)}createQuerySet(t){return new Sk(this,t)}createRenderPipeline(t){return new hk(this,t)}beginRenderPass(t){return new KM(this,t)}createComputePipeline(t){throw new Error("ComputePipeline not supported in WebGL")}beginComputePass(t){throw new Error("ComputePass not supported in WebGL")}createCommandEncoder(t={}){return new bk(this,t)}submit(){var t;(t=this.renderPass)==null||t.end(),this.renderPass=null}readPixelsToArrayWebGL(t,i){return HM(t,i)}readPixelsToBufferWebGL(t,i){return jM(t,i)}setParametersWebGL(t){ci(this.gl,t)}getParametersWebGL(t){return c_(this.gl,t)}withParametersWebGL(t,i){return Xs(this.gl,t,i)}resetWebGL(){L.warn("WebGLDevice.resetWebGL is deprecated, use only for debugging")(),HP(this.gl)}_getDeviceSpecificTextureFormatCapabilities(t){return aM(this.gl,t,this._extensions)}loseDevice(){var s;let t=!1;const r=this.getExtension("WEBGL_lose_context").WEBGL_lose_context;return r&&(t=!0,r.loseContext()),(s=this._resolveContextLost)==null||s.call(this,{reason:"destroyed",message:"Application triggered context loss"}),t}pushState(){pn.get(this.gl).push()}popState(){pn.get(this.gl).pop()}setSpectorMetadata(t,i){t.__SPECTOR_Metadata=i}getGLKey(t,i){const r=Number(t);for(const s in this.gl)if(this.gl[s]===r)return`GL.${s}`;return i!=null&&i.emptyIfUnknown?"":String(t)}getGLKeys(t){const i={emptyIfUnknown:!0};return Object.entries(t).reduce((r,[s,o])=>(r[`${s}:${this.getGLKey(s,i)}`]=`${o}:${this.getGLKey(o,i)}`,r),{})}setConstantAttributeWebGL(t,i){const r=this.limits.maxVertexAttributes;this._constants=this._constants||new Array(r).fill(null);const s=this._constants[t];switch(s&&Ik(s,i)&&L.info(1,`setConstantAttributeWebGL(${t}) could have been skipped, value unchanged`)(),this._constants[t]=i,i.constructor){case Float32Array:Ek(this,t,i);break;case Int32Array:Ak(this,t,i);break;case Uint32Array:Ck(this,t,i);break;default:throw new Error("constant")}}getExtension(t){return oi(this.gl,t,this._extensions),this._extensions}}function Ek(n,e,t){switch(t.length){case 1:n.gl.vertexAttrib1fv(e,t);break;case 2:n.gl.vertexAttrib2fv(e,t);break;case 3:n.gl.vertexAttrib3fv(e,t);break;case 4:n.gl.vertexAttrib4fv(e,t);break}}function Ak(n,e,t){n.gl.vertexAttribI4iv(e,t)}function Ck(n,e,t){n.gl.vertexAttribI4uiv(e,t)}function Ik(n,e){if(!n||!e||n.length!==e.length||n.constructor!==e.constructor)return!1;for(let t=0;t<n.length;++t)if(n[t]!==e[t])return!1;return!0}const Rk={WEBGL_depth_texture:{UNSIGNED_INT_24_8_WEBGL:34042},OES_element_index_uint:{},OES_texture_float:{},OES_texture_half_float:{HALF_FLOAT_OES:5131},EXT_color_buffer_float:{},OES_standard_derivatives:{FRAGMENT_SHADER_DERIVATIVE_HINT_OES:35723},EXT_frag_depth:{},EXT_blend_minmax:{MIN_EXT:32775,MAX_EXT:32776},EXT_shader_texture_lod:{}},Pk=n=>({drawBuffersWEBGL(e){return n.drawBuffers(e)},COLOR_ATTACHMENT0_WEBGL:36064,COLOR_ATTACHMENT1_WEBGL:36065,COLOR_ATTACHMENT2_WEBGL:36066,COLOR_ATTACHMENT3_WEBGL:36067}),Mk=n=>({VERTEX_ARRAY_BINDING_OES:34229,createVertexArrayOES(){return n.createVertexArray()},deleteVertexArrayOES(e){return n.deleteVertexArray(e)},isVertexArrayOES(e){return n.isVertexArray(e)},bindVertexArrayOES(e){return n.bindVertexArray(e)}}),kk=n=>({VERTEX_ATTRIB_ARRAY_DIVISOR_ANGLE:35070,drawArraysInstancedANGLE(...e){return n.drawArraysInstanced(...e)},drawElementsInstancedANGLE(...e){return n.drawElementsInstanced(...e)},vertexAttribDivisorANGLE(...e){return n.vertexAttribDivisor(...e)}});function Ok(n=!0){const e=HTMLCanvasElement.prototype;if(!n&&e.originalGetContext){e.getContext=e.originalGetContext,e.originalGetContext=void 0;return}e.originalGetContext=e.getContext,e.getContext=function(t,i){if(t==="webgl"||t==="experimental-webgl"){const r=this.originalGetContext("webgl2",i);return r instanceof HTMLElement&&Nk(r),r}return this.originalGetContext(t,i)}}function Nk(n){n.getExtension("EXT_color_buffer_float");const e={...Rk,WEBGL_disjoint_timer_query:n.getExtension("EXT_disjoint_timer_query_webgl2"),WEBGL_draw_buffers:Pk(n),OES_vertex_array_object:Mk(n),ANGLE_instanced_arrays:kk(n)},t=n.getExtension;n.getExtension=function(r){const s=t.call(n,r);return s||(r in e?e[r]:null)};const i=n.getSupportedExtensions;n.getSupportedExtensions=function(){const r=i.apply(n)||[];return r==null?void 0:r.concat(Object.keys(e))}}const Br=1;class Fk extends lC{constructor(){super();m(this,"type","webgl");qt.defaultProps={...qt.defaultProps,...ru},Wn.adapter=this}isSupported(){return typeof WebGL2RenderingContext<"u"}enforceWebGL2(t){Ok(t)}async attach(t){if(t instanceof Wn)return t;if((t==null?void 0:t.device)instanceof qt)return t.device;if(!Dk(t))throw new Error("Invalid WebGL2RenderingContext");return new Wn({_handle:t,createCanvasContext:{canvas:t.canvas,autoResize:!1}})}async create(t={}){L.groupCollapsed(Br,"WebGLDevice created")();const i=[];(t.debugWebGL||t.debug)&&i.push(vM()),t.debugSpectorJS&&i.push(_M(t));const r=await Promise.allSettled(i);for(const a of r)a.status==="rejected"&&L.error(`Failed to initialize debug libraries ${a.reason}`)();const s=new Wn(t),o=`${s._reused?"Reusing":"Created"} device with WebGL2 ${s.debug?"debug ":""}context: ${s.info.vendor}, ${s.info.renderer} for canvas: ${s.canvasContext.id}`;return L.probe(Br,o)(),L.table(Br,s.info)(),L.groupEnd(Br)(),s}}function Dk(n){return typeof WebGL2RenderingContext<"u"&&n instanceof WebGL2RenderingContext?!0:!!(n&&Number.isFinite(n._version))}const rf=new Fk;function zt(){}const Bk=({isDragging:n})=>n?"grabbing":"grab",w_={id:"",width:"100%",height:"100%",style:null,viewState:null,initialViewState:null,pickingRadius:0,layerFilter:null,parameters:{},parent:null,device:null,deviceProps:{},gl:null,canvas:null,layers:[],effects:[],views:null,controller:null,useDevicePixels:!0,touchAction:"none",eventRecognizerOptions:{},_framebuffer:null,_animate:!1,_pickable:!0,_typedArrayManagerProps:{},_customRender:null,widgets:[],onDeviceInitialized:zt,onWebGLInitialized:zt,onResize:zt,onViewStateChange:zt,onInteractionStateChange:zt,onBeforeRender:zt,onAfterRender:zt,onLoad:zt,onError:n=>Q.error(n.message,n.cause)(),onHover:null,onClick:null,onDragStart:null,onDrag:null,onDragEnd:null,_onMetrics:null,getCursor:Bk,getTooltip:null,debug:!1,drawPickingColors:!1};class ou{constructor(e){this.width=0,this.height=0,this.userData={},this.device=null,this.canvas=null,this.viewManager=null,this.layerManager=null,this.effectManager=null,this.deckRenderer=null,this.deckPicker=null,this.eventManager=null,this.widgetManager=null,this.tooltip=null,this.animationLoop=null,this.cursorState={isHovering:!1,isDragging:!1},this.stats=new yo({id:"deck.gl"}),this.metrics={fps:0,setPropsTime:0,updateAttributesTime:0,framesRedrawn:0,pickTime:0,pickCount:0,gpuTime:0,gpuTimePerFrame:0,cpuTime:0,cpuTimePerFrame:0,bufferMemory:0,textureMemory:0,renderbufferMemory:0,gpuMemory:0},this._metricsCounter=0,this._needsRedraw="Initial render",this._pickRequest={mode:"hover",x:-1,y:-1,radius:0,event:null},this._lastPointerDownInfo=null,this._onPointerMove=i=>{const{_pickRequest:r}=this;if(i.type==="pointerleave")r.x=-1,r.y=-1,r.radius=0;else{if(i.leftButton||i.rightButton)return;{const s=i.offsetCenter;if(!s)return;r.x=s.x,r.y=s.y,r.radius=this.props.pickingRadius}}this.layerManager&&(this.layerManager.context.mousePosition={x:r.x,y:r.y}),r.event=i},this._onEvent=i=>{const r=Sl[i.type],s=i.offsetCenter;if(!r||!s||!this.layerManager)return;const o=this.layerManager.getLayers(),a=this.deckPicker.getLastPickedObject({x:s.x,y:s.y,layers:o,viewports:this.getViewports(s)},this._lastPointerDownInfo),{layer:l}=a,c=l&&(l[r]||l.props[r]),u=this.props[r];let d=!1;c&&(d=c.call(l,a,i)),d||(u==null||u(a,i),this.widgetManager.onEvent(a,i))},this._onPointerDown=i=>{var o;if(((o=this.device)==null?void 0:o.type)==="webgpu")return;const r=i.offsetCenter,s=this._pick("pickObject","pickObject Time",{x:r.x,y:r.y,radius:this.props.pickingRadius});this._lastPointerDownInfo=s.result[0]||s.emptyInfo},this.props={...w_,...e},e=this.props,e.viewState&&e.initialViewState&&Q.warn("View state tracking is disabled. Use either `initialViewState` for auto update or `viewState` for manual update.")(),this.viewState=this.props.initialViewState,e.device&&(this.device=e.device);let t=this.device;!t&&e.gl&&(e.gl instanceof WebGLRenderingContext&&Q.error("WebGL1 context not supported.")(),t=rf.attach(e.gl)),t||(t=al.createDevice({type:"best-available",_reuseDevices:!0,adapters:[rf],...e.deviceProps,createCanvasContext:{canvas:this._createCanvas(e),useDevicePixels:this.props.useDevicePixels,autoResize:!1}})),this.animationLoop=this._createAnimationLoop(t,e),this.setProps(e),e._typedArrayManagerProps&&ri.setOptions(e._typedArrayManagerProps),this.animationLoop.start()}finalize(){var e,t,i,r,s,o,a,l,c,u;(e=this.animationLoop)==null||e.stop(),(t=this.animationLoop)==null||t.destroy(),this.animationLoop=null,this._lastPointerDownInfo=null,(i=this.layerManager)==null||i.finalize(),this.layerManager=null,(r=this.viewManager)==null||r.finalize(),this.viewManager=null,(s=this.effectManager)==null||s.finalize(),this.effectManager=null,(o=this.deckRenderer)==null||o.finalize(),this.deckRenderer=null,(a=this.deckPicker)==null||a.finalize(),this.deckPicker=null,(l=this.eventManager)==null||l.destroy(),this.eventManager=null,(c=this.widgetManager)==null||c.finalize(),this.widgetManager=null,!this.props.canvas&&!this.props.device&&!this.props.gl&&this.canvas&&((u=this.canvas.parentElement)==null||u.removeChild(this.canvas),this.canvas=null)}setProps(e){var i;this.stats.get("setProps Time").timeStart(),"onLayerHover"in e&&Q.removed("onLayerHover","onHover")(),"onLayerClick"in e&&Q.removed("onLayerClick","onClick")(),e.initialViewState&&!dt(this.props.initialViewState,e.initialViewState,3)&&(this.viewState=e.initialViewState),Object.assign(this.props,e),this._setCanvasSize(this.props);const t=Object.create(this.props);Object.assign(t,{views:this._getViews(),width:this.width,height:this.height,viewState:this._getViewState()}),(i=this.animationLoop)==null||i.setProps(t),this.layerManager&&(this.viewManager.setProps(t),this.layerManager.activateViewport(this.getViewports()[0]),this.layerManager.setProps(t),this.effectManager.setProps(t),this.deckRenderer.setProps(t),this.deckPicker.setProps(t),this.widgetManager.setProps(t)),this.stats.get("setProps Time").timeEnd()}needsRedraw(e={clearRedrawFlags:!1}){if(!this.layerManager)return!1;if(this.props._animate)return"Deck._animate";let t=this._needsRedraw;e.clearRedrawFlags&&(this._needsRedraw=!1);const i=this.viewManager.needsRedraw(e),r=this.layerManager.needsRedraw(e),s=this.effectManager.needsRedraw(e),o=this.deckRenderer.needsRedraw(e);return t=t||i||r||s||o,t}redraw(e){if(!this.layerManager)return;let t=this.needsRedraw({clearRedrawFlags:!0});t=e||t,t&&(this.stats.get("Redraw Count").incrementCount(),this.props._customRender?this.props._customRender(t):this._drawLayers(t))}get isInitialized(){return this.viewManager!==null}getViews(){return Me(this.viewManager),this.viewManager.views}getViewports(e){return Me(this.viewManager),this.viewManager.getViewports(e)}getCanvas(){return this.canvas}pickObject(e){const t=this._pick("pickObject","pickObject Time",e).result;return t.length?t[0]:null}pickMultipleObjects(e){return e.depth=e.depth||10,this._pick("pickObject","pickMultipleObjects Time",e).result}pickObjects(e){return this._pick("pickObjects","pickObjects Time",e)}_addResources(e,t=!1){for(const i in e)this.layerManager.resourceManager.add({resourceId:i,data:e[i],forceUpdate:t})}_removeResources(e){for(const t of e)this.layerManager.resourceManager.remove(t)}_addDefaultEffect(e){this.effectManager.addDefaultEffect(e)}_addDefaultShaderModule(e){this.layerManager.addDefaultShaderModule(e)}_removeDefaultShaderModule(e){var t;(t=this.layerManager)==null||t.removeDefaultShaderModule(e)}_pick(e,t,i){Me(this.deckPicker);const{stats:r}=this;r.get("Pick Count").incrementCount(),r.get(t).timeStart();const s=this.deckPicker[e]({layers:this.layerManager.getLayers(i),views:this.viewManager.getViews(),viewports:this.getViewports(i),onViewportActive:this.layerManager.activateViewport,effects:this.effectManager.getEffects(),...i});return r.get(t).timeEnd(),s}_createCanvas(e){let t=e.canvas;return typeof t=="string"&&(t=document.getElementById(t),Me(t)),t||(t=document.createElement("canvas"),t.id=e.id||"deckgl-overlay",(e.parent||document.body).appendChild(t)),Object.assign(t.style,e.style),t}_setCanvasSize(e){var r;if(!this.canvas)return;const{width:t,height:i}=e;if(t||t===0){const s=Number.isFinite(t)?`${t}px`:t;this.canvas.style.width=s}if(i||i===0){const s=Number.isFinite(i)?`${i}px`:i;this.canvas.style.position=((r=e.style)==null?void 0:r.position)||"absolute",this.canvas.style.height=s}}_updateCanvasSize(){var r,s;const{canvas:e}=this;if(!e)return;const t=e.clientWidth??e.width,i=e.clientHeight??e.height;(t!==this.width||i!==this.height)&&(this.width=t,this.height=i,(r=this.viewManager)==null||r.setProps({width:t,height:i}),(s=this.layerManager)==null||s.activateViewport(this.getViewports()[0]),this.props.onResize({width:t,height:i}))}_createAnimationLoop(e,t){const{gl:i,onError:r,useDevicePixels:s}=t;return new zR({device:e,useDevicePixels:s,autoResizeDrawingBuffer:!i,autoResizeViewport:!1,onInitialize:o=>this._setDevice(o.device),onRender:this._onRenderFrame.bind(this),onError:r})}_getViewState(){return this.props.viewState||this.viewState}_getViews(){const{views:e}=this.props,t=Array.isArray(e)?e:e?[e]:[new TP({id:"default-view"})];return t.length&&this.props.controller&&(t[0].props.controller=this.props.controller),t}_onContextLost(){const{onError:e}=this.props;this.animationLoop&&e&&e(new Error("WebGL context is lost"))}_pickAndCallback(){var t,i,r,s;if(((t=this.device)==null?void 0:t.type)==="webgpu")return;const{_pickRequest:e}=this;if(e.event){const{result:o,emptyInfo:a}=this._pick("pickObject","pickObject Time",e);this.cursorState.isHovering=o.length>0;let l=a,c=!1;for(const u of o)l=u,c=((i=u.layer)==null?void 0:i.onHover(u,e.event))||c;c||((s=(r=this.props).onHover)==null||s.call(r,l,e.event),this.widgetManager.onHover(l,e.event)),e.event=null}}_updateCursor(){const e=this.props.parent||this.canvas;e&&(e.style.cursor=this.props.getCursor(this.cursorState))}_setDevice(e){var r,s;if(this.device=e,!this.animationLoop)return;this.canvas||(this.canvas=(r=this.device.canvasContext)==null?void 0:r.canvas),this.device.type==="webgl"&&this.device.setParametersWebGL({blend:!0,blendFunc:[770,771,1,771],polygonOffsetFill:!0,depthTest:!0,depthFunc:515}),this.props.onDeviceInitialized(this.device),this.device.type==="webgl"&&this.props.onWebGLInitialized(this.device.gl);const t=new Jm;t.play(),this.animationLoop.attachTimeline(t),this.eventManager=new mI(this.props.parent||this.canvas,{touchAction:this.props.touchAction,recognizers:Object.keys(Sh).map(o=>{var f;const[a,l,c,u]=Sh[o],d=(f=this.props.eventRecognizerOptions)==null?void 0:f[o],h={...l,...d,event:o};return{recognizer:new a(h),recognizeWith:c,requestFailure:u}}),events:{pointerdown:this._onPointerDown,pointermove:this._onPointerMove,pointerleave:this._onPointerMove}});for(const o in Sl)this.eventManager.on(o,this._onEvent);this.viewManager=new dP({timeline:t,eventManager:this.eventManager,onViewStateChange:this._onViewStateChange.bind(this),onInteractionStateChange:this._onInteractionStateChange.bind(this),views:this._getViews(),viewState:this._getViewState(),width:this.width,height:this.height});const i=this.viewManager.getViewports()[0];this.layerManager=new uP(this.device,{deck:this,stats:this.stats,viewport:i,timeline:t}),this.effectManager=new AP({deck:this,device:this.device}),this.deckRenderer=new RP(this.device),this.deckPicker=new FP(this.device),this.widgetManager=new LP({deck:this,parentElement:(s=this.canvas)==null?void 0:s.parentElement}),this.widgetManager.addDefault(new $P),this.setProps(this.props),this._updateCanvasSize(),this.props.onLoad()}_drawLayers(e,t){var o;const{device:i,gl:r}=this.layerManager.context;this.props.onBeforeRender({device:i,gl:r});const s={target:this.props._framebuffer,layers:this.layerManager.getLayers(),viewports:this.viewManager.getViewports(),onViewportActive:this.layerManager.activateViewport,views:this.viewManager.getViews(),pass:"screen",effects:this.effectManager.getEffects(),...t};(o=this.deckRenderer)==null||o.renderLayers(s),s.pass==="screen"&&this.widgetManager.onRedraw({viewports:s.viewports,layers:s.layers}),this.props.onAfterRender({device:i,gl:r})}_onRenderFrame(){var e;this._getFrameStats(),this._metricsCounter++%60===0&&(this._getMetrics(),this.stats.reset(),Q.table(4,this.metrics)(),this.props._onMetrics&&this.props._onMetrics(this.metrics)),this._updateCanvasSize(),this._updateCursor(),this.layerManager.updateLayers(),((e=this.device)==null?void 0:e.type)!=="webgpu"&&this._pickAndCallback(),this.redraw(),this.viewManager&&this.viewManager.updateViewStates()}_onViewStateChange(e){const t=this.props.onViewStateChange(e)||e.viewState;this.viewState&&(this.viewState={...this.viewState,[e.viewId]:t},this.props.viewState||this.viewManager&&this.viewManager.setProps({viewState:this.viewState}))}_onInteractionStateChange(e){this.cursorState.isDragging=e.isDragging||!1,this.props.onInteractionStateChange(e)}_getFrameStats(){const{stats:e}=this;e.get("frameRate").timeEnd(),e.get("frameRate").timeStart();const t=this.animationLoop.stats;e.get("GPU Time").addTime(t.get("GPU Time").lastTiming),e.get("CPU Time").addTime(t.get("CPU Time").lastTiming)}_getMetrics(){const{metrics:e,stats:t}=this;e.fps=t.get("frameRate").getHz(),e.setPropsTime=t.get("setProps Time").time,e.updateAttributesTime=t.get("Update Attributes").time,e.framesRedrawn=t.get("Redraw Count").count,e.pickTime=t.get("pickObject Time").time+t.get("pickMultipleObjects Time").time+t.get("pickObjects Time").time,e.pickCount=t.get("Pick Count").count,e.gpuTime=t.get("GPU Time").time,e.cpuTime=t.get("CPU Time").time,e.gpuTimePerFrame=t.get("GPU Time").getAverageTime(),e.cpuTimePerFrame=t.get("CPU Time").getAverageTime();const i=al.stats.get("Memory Usage");e.bufferMemory=i.get("Buffer Memory").count,e.textureMemory=i.get("Texture Memory").count,e.renderbufferMemory=i.get("Renderbuffer Memory").count,e.gpuMemory=i.get("GPU Memory").count}}ou.defaultProps=w_;ou.VERSION=fA;const T_=ou;function Lk(n){switch(n){case"float64":return Float64Array;case"uint8":case"unorm8":return Uint8ClampedArray;default:return rm(n)}}const Uk=im;function Lr(n,e,t){const i=t==="webgpu"&&e.type==="uint8"?"unorm8":e.type;return{attribute:n,format:e.size>1?`${i}x${e.size}`:e.type,byteOffset:e.offset||0}}function cn(n){return n.stride||n.size*n.bytesPerElement}function $k(n,e){return n.type===e.type&&n.size===e.size&&cn(n)===cn(e)&&(n.offset||0)===(e.offset||0)}function Dl(n,e){e.offset&&Q.removed("shaderAttribute.offset","vertexOffset, elementOffset")();const t=cn(n),i=e.vertexOffset!==void 0?e.vertexOffset:n.vertexOffset||0,r=e.elementOffset||0,s=i*t+r*n.bytesPerElement+(n.offset||0);return{...e,offset:s,stride:t}}function zk(n,e){const t=Dl(n,e);return{high:t,low:{...t,offset:t.offset+n.size*4}}}class Vk{constructor(e,t,i){this._buffer=null,this.device=e,this.id=t.id||"",this.size=t.size||1;const r=t.logicalType||t.type,s=r==="float64";let{defaultValue:o}=t;o=Number.isFinite(o)?[o]:o||new Array(this.size).fill(0);let a;s?a="float32":!r&&t.isIndexed?a="uint32":a=r||"float32";let l=Lk(r||a);this.doublePrecision=s,s&&t.fp64===!1&&(l=Float32Array),this.value=null,this.settings={...t,defaultType:l,defaultValue:o,logicalType:r,type:a,normalized:a.includes("norm"),size:this.size,bytesPerElement:l.BYTES_PER_ELEMENT},this.state={...i,externalBuffer:null,bufferAccessor:this.settings,allocatedValue:null,numInstances:0,bounds:null,constant:!1}}get isConstant(){return this.state.constant}get buffer(){return this._buffer}get byteOffset(){const e=this.getAccessor();return e.vertexOffset?e.vertexOffset*cn(e):0}get numInstances(){return this.state.numInstances}set numInstances(e){this.state.numInstances=e}delete(){this._buffer&&(this._buffer.delete(),this._buffer=null),ri.release(this.state.allocatedValue)}getBuffer(){return this.state.constant?null:this.state.externalBuffer||this._buffer}getValue(e=this.id,t=null){const i={};if(this.state.constant){const r=this.value;if(t){const s=Dl(this.getAccessor(),t),o=s.offset/r.BYTES_PER_ELEMENT,a=s.size||this.size;i[e]=r.subarray(o,o+a)}else i[e]=r}else i[e]=this.getBuffer();return this.doublePrecision&&(this.value instanceof Float64Array?i[`${e}64Low`]=i[e]:i[`${e}64Low`]=new Float32Array(this.size)),i}_getBufferLayout(e=this.id,t=null){const i=this.getAccessor(),r=[],s={name:this.id,byteStride:cn(i),attributes:r};if(this.doublePrecision){const o=zk(i,t||{});r.push(Lr(e,{...i,...o.high},this.device.type),Lr(`${e}64Low`,{...i,...o.low},this.device.type))}else if(t){const o=Dl(i,t);r.push(Lr(e,{...i,...o},this.device.type))}else r.push(Lr(e,i,this.device.type));return s}setAccessor(e){this.state.bufferAccessor=e}getAccessor(){return this.state.bufferAccessor}getBounds(){if(this.state.bounds)return this.state.bounds;let e=null;if(this.state.constant&&this.value){const t=Array.from(this.value);e=[t,t]}else{const{value:t,numInstances:i,size:r}=this,s=i*r;if(t&&s&&t.length>=s){const o=new Array(r).fill(1/0),a=new Array(r).fill(-1/0);for(let l=0;l<s;)for(let c=0;c<r;c++){const u=t[l++];u<o[c]&&(o[c]=u),u>a[c]&&(a[c]=u)}e=[o,a]}}return this.state.bounds=e,e}setData(e){const{state:t}=this;let i;ArrayBuffer.isView(e)?i={value:e}:e instanceof le?i={buffer:e}:i=e;const r={...this.settings,...i};if(ArrayBuffer.isView(i.value)){if(!i.type)if(this.doublePrecision&&i.value instanceof Float64Array)r.type="float32";else{const o=Uk(i.value);r.type=r.normalized?o.replace("int","norm"):o}r.bytesPerElement=i.value.BYTES_PER_ELEMENT,r.stride=cn(r)}if(t.bounds=null,i.constant){let s=i.value;if(s=this._normalizeValue(s,[],0),this.settings.normalized&&(s=this.normalizeConstant(s)),!(!t.constant||!this._areValuesEqual(s,this.value)))return!1;t.externalBuffer=null,t.constant=!0,this.value=ArrayBuffer.isView(s)?s:new Float32Array(s)}else if(i.buffer){const s=i.buffer;t.externalBuffer=s,t.constant=!1,this.value=i.value||null}else if(i.value){this._checkExternalBuffer(i);let s=i.value;t.externalBuffer=null,t.constant=!1,this.value=s;let{buffer:o}=this;const a=cn(r),l=(r.vertexOffset||0)*a;if(this.doublePrecision&&s instanceof Float64Array&&(s=la(s,r)),this.settings.isIndexed){const u=this.settings.defaultType;s.constructor!==u&&(s=new u(s))}const c=s.byteLength+l+a*2;(!o||o.byteLength<c)&&(o=this._createBuffer(c)),o.write(s,l)}return this.setAccessor(r),!0}updateSubBuffer(e={}){this.state.bounds=null;const t=this.value,{startOffset:i=0,endOffset:r}=e;this.buffer.write(this.doublePrecision&&t instanceof Float64Array?la(t,{size:this.size,startIndex:i,endIndex:r}):t.subarray(i,r),i*t.BYTES_PER_ELEMENT+this.byteOffset)}allocate(e,t=!1){const{state:i}=this,r=i.allocatedValue,s=ri.allocate(r,e+1,{size:this.size,type:this.settings.defaultType,copy:t});this.value=s;const{byteOffset:o}=this;let{buffer:a}=this;return(!a||a.byteLength<s.byteLength+o)&&(a=this._createBuffer(s.byteLength+o),t&&r&&a.write(r instanceof Float64Array?la(r,this):r,o)),i.allocatedValue=s,i.constant=!1,i.externalBuffer=null,this.setAccessor(this.settings),!0}_checkExternalBuffer(e){const{value:t}=e;if(!ArrayBuffer.isView(t))throw new Error(`Attribute ${this.id} value is not TypedArray`);const i=this.settings.defaultType;let r=!1;if(this.doublePrecision&&(r=t.BYTES_PER_ELEMENT<4),r)throw new Error(`Attribute ${this.id} does not support ${t.constructor.name}`);!(t instanceof i)&&this.settings.normalized&&!("normalized"in e)&&Q.warn(`Attribute ${this.id} is normalized`)()}normalizeConstant(e){switch(this.settings.type){case"snorm8":return new Float32Array(e).map(t=>(t+128)/255*2-1);case"snorm16":return new Float32Array(e).map(t=>(t+32768)/65535*2-1);case"unorm8":return new Float32Array(e).map(t=>t/255);case"unorm16":return new Float32Array(e).map(t=>t/65535);default:return e}}_normalizeValue(e,t,i){const{defaultValue:r,size:s}=this.settings;if(Number.isFinite(e))return t[i]=e,t;if(!e){let o=s;for(;--o>=0;)t[i+o]=r[o];return t}switch(s){case 4:t[i+3]=Number.isFinite(e[3])?e[3]:r[3];case 3:t[i+2]=Number.isFinite(e[2])?e[2]:r[2];case 2:t[i+1]=Number.isFinite(e[1])?e[1]:r[1];case 1:t[i+0]=Number.isFinite(e[0])?e[0]:r[0];break;default:let o=s;for(;--o>=0;)t[i+o]=Number.isFinite(e[o])?e[o]:r[o]}return t}_areValuesEqual(e,t){if(!e||!t)return!1;const{size:i}=this;for(let r=0;r<i;r++)if(e[r]!==t[r])return!1;return!0}_createBuffer(e){var r;this._buffer&&this._buffer.destroy();const{isIndexed:t,type:i}=this.settings;return this._buffer=this.device.createBuffer({...(r=this._buffer)==null?void 0:r.props,id:this.id,usage:(t?le.INDEX:le.VERTEX)|le.COPY_DST,indexType:t?i:void 0,byteLength:e}),this._buffer}}const sf=[],of=[];function Ro(n,e=0,t=1/0){let i=sf;const r={index:-1,data:n,target:[]};return n?typeof n[Symbol.iterator]=="function"?i=n:n.length>0&&(of.length=n.length,i=of):i=sf,(e>0||Number.isFinite(t))&&(i=(Array.isArray(i)?i:Array.from(i)).slice(e,t),r.index=e-1),{iterable:i,objectInfo:r}}function S_(n){return n&&n[Symbol.asyncIterator]}function E_(n,e){const{size:t,stride:i,offset:r,startIndices:s,nested:o}=e,a=n.BYTES_PER_ELEMENT,l=i?i/a:t,c=r?r/a:0,u=Math.floor((n.length-c)/l);return(d,{index:h,target:f})=>{if(!s){const b=h*l+c;for(let w=0;w<t;w++)f[w]=n[b+w];return f}const p=s[h],g=s[h+1]||u;let _;if(o){_=new Array(g-p);for(let b=p;b<g;b++){const w=b*l+c;f=new Array(t);for(let x=0;x<t;x++)f[x]=n[w+x];_[b-p]=f}}else if(l===t)_=n.subarray(p*t+c,g*t+c);else{_=new n.constructor((g-p)*t);let b=0;for(let w=p;w<g;w++){const x=w*l+c;for(let y=0;y<t;y++)_[b++]=n[x+y]}}return _}}const Wk=[],Qr=[[0,1/0]];function Hk(n,e){if(n===Qr||(e[0]<0&&(e[0]=0),e[0]>=e[1]))return n;const t=[],i=n.length;let r=0;for(let s=0;s<i;s++){const o=n[s];o[1]<e[0]?(t.push(o),r=s+1):o[0]>e[1]?t.push(o):e=[Math.min(o[0],e[0]),Math.max(o[1],e[1])]}return t.splice(r,0,e),t}const jk={interpolation:{duration:0,easing:n=>n},spring:{stiffness:.05,damping:.5}};function A_(n,e){if(!n)return null;Number.isFinite(n)&&(n={type:"interpolation",duration:n});const t=n.type||"interpolation";return{...jk[t],...e,...n,type:t}}class C_ extends Vk{constructor(e,t){super(e,t,{startIndices:null,lastExternalBuffer:null,binaryValue:null,binaryAccessor:null,needsUpdate:!0,needsRedraw:!1,layoutChanged:!1,updateRanges:Qr}),this.constant=!1,this.settings.update=t.update||(t.accessor?this._autoUpdater:void 0),Object.seal(this.settings),Object.seal(this.state),this._validateAttributeUpdaters()}get startIndices(){return this.state.startIndices}set startIndices(e){this.state.startIndices=e}needsUpdate(){return this.state.needsUpdate}needsRedraw({clearChangedFlags:e=!1}={}){const t=this.state.needsRedraw;return this.state.needsRedraw=t&&!e,t}layoutChanged(){return this.state.layoutChanged}setAccessor(e){var t;(t=this.state).layoutChanged||(t.layoutChanged=!$k(e,this.getAccessor())),super.setAccessor(e)}getUpdateTriggers(){const{accessor:e}=this.settings;return[this.id].concat(typeof e!="function"&&e||[])}supportsTransition(){return!!this.settings.transition}getTransitionSetting(e){if(!e||!this.supportsTransition())return null;const{accessor:t}=this.settings,i=this.settings.transition,r=Array.isArray(t)?e[t.find(s=>e[s])]:e[t];return A_(r,i)}setNeedsUpdate(e=this.id,t){if(this.state.needsUpdate=this.state.needsUpdate||e,this.setNeedsRedraw(e),t){const{startRow:i=0,endRow:r=1/0}=t;this.state.updateRanges=Hk(this.state.updateRanges,[i,r])}else this.state.updateRanges=Qr}clearNeedsUpdate(){this.state.needsUpdate=!1,this.state.updateRanges=Wk}setNeedsRedraw(e=this.id){this.state.needsRedraw=this.state.needsRedraw||e}allocate(e){const{state:t,settings:i}=this;return i.noAlloc?!1:i.update?(super.allocate(e,t.updateRanges!==Qr),!0):!1}updateBuffer({numInstances:e,data:t,props:i,context:r}){if(!this.needsUpdate())return!1;const{state:{updateRanges:s},settings:{update:o,noAlloc:a}}=this;let l=!0;if(o){for(const[c,u]of s)o.call(r,this,{data:t,startRow:c,endRow:u,props:i,numInstances:e});if(this.value)if(this.constant||!this.buffer||this.buffer.byteLength<this.value.byteLength+this.byteOffset)this.setData({value:this.value,constant:this.constant}),this.constant=!1;else for(const[c,u]of s){const d=Number.isFinite(c)?this.getVertexOffset(c):0,h=Number.isFinite(u)?this.getVertexOffset(u):a||!Number.isFinite(e)?this.value.length:e*this.size;super.updateSubBuffer({startOffset:d,endOffset:h})}this._checkAttributeArray()}else l=!1;return this.clearNeedsUpdate(),this.setNeedsRedraw(),l}setConstantValue(e){return this.device.type==="webgpu"||e===void 0||typeof e=="function"?!1:(this.setData({constant:!0,value:e})&&this.setNeedsRedraw(),this.clearNeedsUpdate(),!0)}setExternalBuffer(e){const{state:t}=this;return e?(this.clearNeedsUpdate(),t.lastExternalBuffer===e||(t.lastExternalBuffer=e,this.setNeedsRedraw(),this.setData(e)),!0):(t.lastExternalBuffer=null,!1)}setBinaryValue(e,t=null){const{state:i,settings:r}=this;if(!e)return i.binaryValue=null,i.binaryAccessor=null,!1;if(r.noAlloc)return!1;if(i.binaryValue===e)return this.clearNeedsUpdate(),!0;if(i.binaryValue=e,this.setNeedsRedraw(),r.transform||t!==this.startIndices){ArrayBuffer.isView(e)&&(e={value:e});const o=e;Me(ArrayBuffer.isView(o.value),`invalid ${r.accessor}`);const a=!!o.size&&o.size!==this.size;return i.binaryAccessor=E_(o.value,{size:o.size||this.size,stride:o.stride,offset:o.offset,startIndices:t,nested:a}),!1}return this.clearNeedsUpdate(),this.setData(e),!0}getVertexOffset(e){const{startIndices:t}=this;return(t?e<t.length?t[e]:this.numInstances:e)*this.size}getValue(){const e=this.settings.shaderAttributes,t=super.getValue();if(!e)return t;for(const i in e)Object.assign(t,super.getValue(i,e[i]));return t}getBufferLayout(e){this.state.layoutChanged=!1;const t=this.settings.shaderAttributes,i=super._getBufferLayout(),{stepMode:r}=this.settings;if(r==="dynamic"?i.stepMode=e?e.isInstanced?"instance":"vertex":"instance":i.stepMode=r??"vertex",!t)return i;for(const s in t){const o=super._getBufferLayout(s,t[s]);i.attributes.push(...o.attributes)}return i}_autoUpdater(e,{data:t,startRow:i,endRow:r,props:s,numInstances:o}){if(e.constant&&this.context.device.type!=="webgpu")return;const{settings:a,state:l,value:c,size:u,startIndices:d}=e,{accessor:h,transform:f}=a;let p=l.binaryAccessor||(typeof h=="function"?h:s[h]);typeof p!="function"&&(p=()=>p),Me(typeof p=="function",`accessor "${h}" is not a function`);let g=e.getVertexOffset(i);const{iterable:_,objectInfo:b}=Ro(t,i,r);for(const w of _){b.index++;let x=p(w,b);if(f&&(x=f.call(this,x)),d){const y=(b.index<d.length-1?d[b.index+1]:o)-d[b.index];if(x&&Array.isArray(x[0])){let S=g;for(const I of x)e._normalizeValue(I,c,S),S+=u}else x&&x.length>u?c.set(x,g):(e._normalizeValue(x,b.target,0),sP({target:c,source:b.target,start:g,count:y}));g+=y*u}else e._normalizeValue(x,c,g),g+=u}}_validateAttributeUpdaters(){const{settings:e}=this;if(!(e.noAlloc||typeof e.update=="function"))throw new Error(`Attribute ${this.id} missing update or accessor`)}_checkAttributeArray(){const{value:e}=this,t=Math.min(4,this.size);if(e&&e.length>=t){let i=!0;switch(t){case 4:i=i&&Number.isFinite(e[3]);case 3:i=i&&Number.isFinite(e[2]);case 2:i=i&&Number.isFinite(e[1]);case 1:i=i&&Number.isFinite(e[0]);break;default:i=!1}if(!i)throw new Error(`Illegal attribute generated for ${this.id}`)}}}function _a(n){const{source:e,target:t,start:i=0,size:r,getData:s}=n,o=n.end||t.length,a=e.length,l=o-i;if(a>l){t.set(e.subarray(0,l),i);return}if(t.set(e,i),!s)return;let c=a;for(;c<l;){const u=s(c,e);for(let d=0;d<r;d++)t[i+c]=u[d]||0,c++}}function Xk({source:n,target:e,size:t,getData:i,sourceStartIndices:r,targetStartIndices:s}){if(!r||!s)return _a({source:n,target:e,size:t,getData:i}),e;let o=0,a=0;const l=i&&((u,d)=>i(u+a,d)),c=Math.min(r.length,s.length);for(let u=1;u<c;u++){const d=r[u]*t,h=s[u]*t;_a({source:n.subarray(o,d),target:e,start:a,end:h,size:t,getData:l}),o=d,a=h}return a<e.length&&_a({source:[],target:e,start:a,size:t,getData:l}),e}function Yk(n){const{device:e,settings:t,value:i}=n,r=new C_(e,t);return r.setData({value:i instanceof Float64Array?new Float64Array(0):new Float32Array(0),normalized:t.normalized}),r}function I_(n){switch(n){case 1:return"float";case 2:return"vec2";case 3:return"vec3";case 4:return"vec4";default:throw new Error(`No defined attribute type for size "${n}"`)}}function R_(n){switch(n){case 1:return"float32";case 2:return"float32x2";case 3:return"float32x3";case 4:return"float32x4";default:throw new Error("invalid type size")}}function P_(n){n.push(n.shift())}function qk(n,e){const{doublePrecision:t,settings:i,value:r,size:s}=n,o=t&&r instanceof Float64Array?2:1;let a=0;const{shaderAttributes:l}=n.settings;if(l)for(const c of Object.values(l))a=Math.max(a,c.vertexOffset??0);return(i.noAlloc?r.length:(e+a)*s)*o}function M_({device:n,source:e,target:t}){return(!t||t.byteLength<e.byteLength)&&(t==null||t.destroy(),t=n.createBuffer({byteLength:e.byteLength,usage:e.usage})),t}function k_({device:n,buffer:e,attribute:t,fromLength:i,toLength:r,fromStartIndices:s,getData:o=a=>a}){const a=t.doublePrecision&&t.value instanceof Float64Array?2:1,l=t.size*a,c=t.byteOffset,u=t.settings.bytesPerElement<4?c/t.settings.bytesPerElement*4:c,d=t.startIndices,h=s&&d,f=t.isConstant;if(!h&&e&&i>=r)return e;const p=t.value instanceof Float64Array?Float32Array:t.value.constructor,g=f?t.value:new p(t.getBuffer().readSyncWebGL(c,r*p.BYTES_PER_ELEMENT).buffer);if(t.settings.normalized&&!f){const x=o;o=(y,S)=>t.normalizeConstant(x(y,S))}const _=f?(x,y)=>o(g,y):(x,y)=>o(g.subarray(x+c,x+c+l),y),b=e?new Float32Array(e.readSyncWebGL(u,i*4).buffer):new Float32Array(0),w=new Float32Array(r);return Xk({source:b,target:w,sourceStartIndices:s,targetStartIndices:d,size:l,getData:_}),(!e||e.byteLength<w.byteLength+u)&&(e==null||e.destroy(),e=n.createBuffer({byteLength:w.byteLength+u,usage:35050})),e.write(w,u),e}class O_{constructor({device:e,attribute:t,timeline:i}){this.buffers=[],this.currentLength=0,this.device=e,this.transition=new Io(i),this.attribute=t,this.attributeInTransition=Yk(t),this.currentStartIndices=t.startIndices}get inProgress(){return this.transition.inProgress}start(e,t,i=1/0){this.settings=e,this.currentStartIndices=this.attribute.startIndices,this.currentLength=qk(this.attribute,t),this.transition.start({...e,duration:i})}update(){const e=this.transition.update();return e&&this.onUpdate(),e}setBuffer(e){this.attributeInTransition.setData({buffer:e,normalized:this.attribute.settings.normalized,value:this.attributeInTransition.value})}cancel(){this.transition.cancel()}delete(){this.cancel();for(const e of this.buffers)e.destroy();this.buffers.length=0}}class Kk extends O_{constructor({device:e,attribute:t,timeline:i}){super({device:e,attribute:t,timeline:i}),this.type="interpolation",this.transform=Jk(e,t)}start(e,t){const i=this.currentLength,r=this.currentStartIndices;if(super.start(e,t,e.duration),e.duration<=0){this.transition.cancel();return}const{buffers:s,attribute:o}=this;P_(s),s[0]=k_({device:this.device,buffer:s[0],attribute:o,fromLength:i,toLength:this.currentLength,fromStartIndices:r,getData:e.enter}),s[1]=M_({device:this.device,source:s[0],target:s[1]}),this.setBuffer(s[1]);const{transform:a}=this,l=a.model;let c=Math.floor(this.currentLength/o.size);N_(o)&&(c/=2),l.setVertexCount(c),o.isConstant?(l.setAttributes({aFrom:s[0]}),l.setConstantAttributes({aTo:o.value})):l.setAttributes({aFrom:s[0],aTo:o.getBuffer()}),a.transformFeedback.setBuffers({vCurrent:s[1]})}onUpdate(){const{duration:e,easing:t}=this.settings,{time:i}=this.transition;let r=i/e;t&&(r=t(r));const{model:s}=this.transform,o={time:r};s.shaderInputs.setProps({interpolation:o}),this.transform.run({discard:!0})}delete(){super.delete(),this.transform.destroy()}}const Zk=`uniform interpolationUniforms {
  float time;
} interpolation;
`,af={name:"interpolation",vs:Zk,uniformTypes:{time:"f32"}},Gk=`#version 300 es
#define SHADER_NAME interpolation-transition-vertex-shader

in ATTRIBUTE_TYPE aFrom;
in ATTRIBUTE_TYPE aTo;
out ATTRIBUTE_TYPE vCurrent;

void main(void) {
  vCurrent = mix(aFrom, aTo, interpolation.time);
  gl_Position = vec4(0.0);
}
`,Qk=`#version 300 es
#define SHADER_NAME interpolation-transition-vertex-shader

in ATTRIBUTE_TYPE aFrom;
in ATTRIBUTE_TYPE aFrom64Low;
in ATTRIBUTE_TYPE aTo;
in ATTRIBUTE_TYPE aTo64Low;
out ATTRIBUTE_TYPE vCurrent;
out ATTRIBUTE_TYPE vCurrent64Low;

vec2 mix_fp64(vec2 a, vec2 b, float x) {
  vec2 range = sub_fp64(b, a);
  return sum_fp64(a, mul_fp64(range, vec2(x, 0.0)));
}

void main(void) {
  for (int i=0; i<ATTRIBUTE_SIZE; i++) {
    vec2 value = mix_fp64(vec2(aFrom[i], aFrom64Low[i]), vec2(aTo[i], aTo64Low[i]), interpolation.time);
    vCurrent[i] = value.x;
    vCurrent64Low[i] = value.y;
  }
  gl_Position = vec4(0.0);
}
`;function N_(n){return n.doublePrecision&&n.value instanceof Float64Array}function Jk(n,e){const t=e.size,i=I_(t),r=R_(t),s=e.getBufferLayout();return N_(e)?new Zi(n,{vs:Qk,bufferLayout:[{name:"aFrom",byteStride:8*t,attributes:[{attribute:"aFrom",format:r,byteOffset:0},{attribute:"aFrom64Low",format:r,byteOffset:4*t}]},{name:"aTo",byteStride:8*t,attributes:[{attribute:"aTo",format:r,byteOffset:0},{attribute:"aTo64Low",format:r,byteOffset:4*t}]}],modules:[p3,af],defines:{ATTRIBUTE_TYPE:i,ATTRIBUTE_SIZE:t},moduleSettings:{},varyings:["vCurrent","vCurrent64Low"],bufferMode:35980,disableWarnings:!0}):new Zi(n,{vs:Gk,bufferLayout:[{name:"aFrom",format:r},{name:"aTo",format:s.attributes[0].format}],modules:[af],defines:{ATTRIBUTE_TYPE:i},varyings:["vCurrent"],disableWarnings:!0})}class eO extends O_{constructor({device:e,attribute:t,timeline:i}){super({device:e,attribute:t,timeline:i}),this.type="spring",this.texture=oO(e),this.framebuffer=aO(e,this.texture),this.transform=sO(e,t)}start(e,t){const i=this.currentLength,r=this.currentStartIndices;super.start(e,t);const{buffers:s,attribute:o}=this;for(let l=0;l<2;l++)s[l]=k_({device:this.device,buffer:s[l],attribute:o,fromLength:i,toLength:this.currentLength,fromStartIndices:r,getData:e.enter});s[2]=M_({device:this.device,source:s[0],target:s[2]}),this.setBuffer(s[1]);const{model:a}=this.transform;a.setVertexCount(Math.floor(this.currentLength/o.size)),o.isConstant?a.setConstantAttributes({aTo:o.value}):a.setAttributes({aTo:o.getBuffer()})}onUpdate(){const{buffers:e,transform:t,framebuffer:i,transition:r}=this,s=this.settings;t.model.setAttributes({aPrev:e[0],aCur:e[1]}),t.transformFeedback.setBuffers({vNext:e[2]});const o={stiffness:s.stiffness,damping:s.damping};t.model.shaderInputs.setProps({spring:o}),t.run({framebuffer:i,discard:!1,parameters:{viewport:[0,0,1,1]},clearColor:[0,0,0,0]}),P_(e),this.setBuffer(e[1]),this.device.readPixelsToArrayWebGL(i)[0]>0||r.end()}delete(){super.delete(),this.transform.destroy(),this.texture.destroy(),this.framebuffer.destroy()}}const tO=`uniform springUniforms {
  float damping;
  float stiffness;
} spring;
`,nO={name:"spring",vs:tO,uniformTypes:{damping:"f32",stiffness:"f32"}},iO=`#version 300 es
#define SHADER_NAME spring-transition-vertex-shader

#define EPSILON 0.00001

in ATTRIBUTE_TYPE aPrev;
in ATTRIBUTE_TYPE aCur;
in ATTRIBUTE_TYPE aTo;
out ATTRIBUTE_TYPE vNext;
out float vIsTransitioningFlag;

ATTRIBUTE_TYPE getNextValue(ATTRIBUTE_TYPE cur, ATTRIBUTE_TYPE prev, ATTRIBUTE_TYPE dest) {
  ATTRIBUTE_TYPE velocity = cur - prev;
  ATTRIBUTE_TYPE delta = dest - cur;
  ATTRIBUTE_TYPE force = delta * spring.stiffness;
  ATTRIBUTE_TYPE resistance = velocity * spring.damping;
  return force - resistance + velocity + cur;
}

void main(void) {
  bool isTransitioning = length(aCur - aPrev) > EPSILON || length(aTo - aCur) > EPSILON;
  vIsTransitioningFlag = isTransitioning ? 1.0 : 0.0;

  vNext = getNextValue(aCur, aPrev, aTo);
  gl_Position = vec4(0, 0, 0, 1);
  gl_PointSize = 100.0;
}
`,rO=`#version 300 es
#define SHADER_NAME spring-transition-is-transitioning-fragment-shader

in float vIsTransitioningFlag;

out vec4 fragColor;

void main(void) {
  if (vIsTransitioningFlag == 0.0) {
    discard;
  }
  fragColor = vec4(1.0);
}`;function sO(n,e){const t=I_(e.size),i=R_(e.size);return new Zi(n,{vs:iO,fs:rO,bufferLayout:[{name:"aPrev",format:i},{name:"aCur",format:i},{name:"aTo",format:e.getBufferLayout().attributes[0].format}],varyings:["vNext"],modules:[nO],defines:{ATTRIBUTE_TYPE:t},parameters:{depthCompare:"always",blendColorOperation:"max",blendColorSrcFactor:"one",blendColorDstFactor:"one",blendAlphaOperation:"max",blendAlphaSrcFactor:"one",blendAlphaDstFactor:"one"}})}function oO(n){return n.createTexture({data:new Uint8Array(4),format:"rgba8unorm",mipmaps:!1,width:1,height:1})}function aO(n,e){return n.createFramebuffer({id:"spring-transition-is-transitioning-framebuffer",width:1,height:1,colorAttachments:[e]})}const lO={interpolation:Kk,spring:eO};class cO{constructor(e,{id:t,timeline:i}){if(!e)throw new Error("AttributeTransitionManager is constructed without device");this.id=t,this.device=e,this.timeline=i,this.transitions={},this.needsRedraw=!1,this.numInstances=1}finalize(){for(const e in this.transitions)this._removeTransition(e)}update({attributes:e,transitions:t,numInstances:i}){this.numInstances=i||1;for(const r in e){const s=e[r],o=s.getTransitionSetting(t);o&&this._updateAttribute(r,s,o)}for(const r in this.transitions){const s=e[r];(!s||!s.getTransitionSetting(t))&&this._removeTransition(r)}}hasAttribute(e){const t=this.transitions[e];return t&&t.inProgress}getAttributes(){const e={};for(const t in this.transitions){const i=this.transitions[t];i.inProgress&&(e[t]=i.attributeInTransition)}return e}run(){if(this.numInstances===0)return!1;for(const t in this.transitions)this.transitions[t].update()&&(this.needsRedraw=!0);const e=this.needsRedraw;return this.needsRedraw=!1,e}_removeTransition(e){this.transitions[e].delete(),delete this.transitions[e]}_updateAttribute(e,t,i){const r=this.transitions[e];let s=!r||r.type!==i.type;if(s){r&&this._removeTransition(e);const o=lO[i.type];o?this.transitions[e]=new o({attribute:t,timeline:this.timeline,device:this.device}):(Q.error(`unsupported transition type '${i.type}'`)(),s=!1)}(s||t.needsRedraw())&&(this.needsRedraw=!0,this.transitions[e].start(i,this.numInstances))}}const lf="attributeManager.invalidate",uO="attributeManager.updateStart",dO="attributeManager.updateEnd",hO="attribute.updateStart",fO="attribute.allocate",pO="attribute.updateEnd";class gO{constructor(e,{id:t="attribute-manager",stats:i,timeline:r}={}){this.mergeBoundsMemoized=lr(IR),this.id=t,this.device=e,this.attributes={},this.updateTriggers={},this.needsRedraw=!0,this.userData={},this.stats=i,this.attributeTransitionManager=new cO(e,{id:`${t}-transitions`,timeline:r}),Object.seal(this)}finalize(){for(const e in this.attributes)this.attributes[e].delete();this.attributeTransitionManager.finalize()}getNeedsRedraw(e={clearRedrawFlags:!1}){const t=this.needsRedraw;return this.needsRedraw=this.needsRedraw&&!e.clearRedrawFlags,t&&this.id}setNeedsRedraw(){this.needsRedraw=!0}add(e){this._add(e)}addInstanced(e){this._add(e,{stepMode:"instance"})}remove(e){for(const t of e)this.attributes[t]!==void 0&&(this.attributes[t].delete(),delete this.attributes[t])}invalidate(e,t){const i=this._invalidateTrigger(e,t);De(lf,this,e,i)}invalidateAll(e){for(const t in this.attributes)this.attributes[t].setNeedsUpdate(t,e);De(lf,this,"all")}update({data:e,numInstances:t,startIndices:i=null,transitions:r,props:s={},buffers:o={},context:a={}}){let l=!1;De(uO,this),this.stats&&this.stats.get("Update Attributes").timeStart();for(const c in this.attributes){const u=this.attributes[c],d=u.settings.accessor;u.startIndices=i,u.numInstances=t,s[c]&&Q.removed(`props.${c}`,`data.attributes.${c}`)(),u.setExternalBuffer(o[c])||u.setBinaryValue(typeof d=="string"?o[d]:void 0,e.startIndices)||typeof d=="string"&&!o[d]&&u.setConstantValue(s[d])||u.needsUpdate()&&(l=!0,this._updateAttribute({attribute:u,numInstances:t,data:e,props:s,context:a})),this.needsRedraw=this.needsRedraw||u.needsRedraw()}l&&De(dO,this,t),this.stats&&this.stats.get("Update Attributes").timeEnd(),this.attributeTransitionManager.update({attributes:this.attributes,numInstances:t,transitions:r})}updateTransition(){const{attributeTransitionManager:e}=this,t=e.run();return this.needsRedraw=this.needsRedraw||t,t}getAttributes(){return{...this.attributes,...this.attributeTransitionManager.getAttributes()}}getBounds(e){const t=e.map(i=>{var r;return(r=this.attributes[i])==null?void 0:r.getBounds()});return this.mergeBoundsMemoized(t)}getChangedAttributes(e={clearChangedFlags:!1}){const{attributes:t,attributeTransitionManager:i}=this,r={...i.getAttributes()};for(const s in t){const o=t[s];o.needsRedraw(e)&&!i.hasAttribute(s)&&(r[s]=o)}return r}getBufferLayouts(e){return Object.values(this.getAttributes()).map(t=>t.getBufferLayout(e))}_add(e,t){for(const i in e){const r=e[i],s={...r,id:i,size:r.isIndexed&&1||r.size||1,...t};this.attributes[i]=new C_(this.device,s)}this._mapUpdateTriggersToAttributes()}_mapUpdateTriggersToAttributes(){const e={};for(const t in this.attributes)this.attributes[t].getUpdateTriggers().forEach(r=>{e[r]||(e[r]=[]),e[r].push(t)});this.updateTriggers=e}_invalidateTrigger(e,t){const{attributes:i,updateTriggers:r}=this,s=r[e];return s&&s.forEach(o=>{const a=i[o];a&&a.setNeedsUpdate(a.id,t)}),s}_updateAttribute(e){const{attribute:t,numInstances:i}=e;if(De(hO,t),t.constant){t.setConstantValue(t.value);return}t.allocate(i)&&De(fO,t,i),t.updateBuffer(e)&&(this.needsRedraw=!0,De(pO,t,i))}}class mO extends Io{get value(){return this._value}_onUpdate(){const{time:e,settings:{fromValue:t,toValue:i,duration:r,easing:s}}=this,o=s(e/r);this._value=Ls(t,i,o)}}const cf=1e-5;function uf(n,e,t,i,r){const s=e-n,a=(t-e)*r,l=-s*i;return a+l+s+e}function _O(n,e,t,i,r){if(Array.isArray(t)){const s=[];for(let o=0;o<t.length;o++)s[o]=uf(n[o],e[o],t[o],i,r);return s}return uf(n,e,t,i,r)}function df(n,e){if(Array.isArray(n)){let t=0;for(let i=0;i<n.length;i++){const r=n[i]-e[i];t+=r*r}return Math.sqrt(t)}return Math.abs(n-e)}class yO extends Io{get value(){return this._currValue}_onUpdate(){const{fromValue:e,toValue:t,damping:i,stiffness:r}=this.settings,{_prevValue:s=e,_currValue:o=e}=this;let a=_O(s,o,t,i,r);const l=df(a,t),c=df(a,o);l<cf&&c<cf&&(a=t,this.end()),this._prevValue=o,this._currValue=a}}const bO={interpolation:mO,spring:yO};class vO{constructor(e){this.transitions=new Map,this.timeline=e}get active(){return this.transitions.size>0}add(e,t,i,r){const{transitions:s}=this;if(s.has(e)){const l=s.get(e),{value:c=l.settings.fromValue}=l;t=c,this.remove(e)}if(r=A_(r),!r)return;const o=bO[r.type];if(!o){Q.error(`unsupported transition type '${r.type}'`)();return}const a=new o(this.timeline);a.start({...r,fromValue:t,toValue:i}),s.set(e,a)}remove(e){const{transitions:t}=this;t.has(e)&&(t.get(e).cancel(),t.delete(e))}update(){const e={};for(const[t,i]of this.transitions)i.update(),e[t]=i.value,i.inProgress||this.remove(t);return e}clear(){for(const e of this.transitions.keys())this.remove(e)}}function xO(n){const e=n[Zt];for(const t in e){const i=e[t],{validate:r}=i;if(r&&!r(n[t],i))throw new Error(`Invalid prop ${t}: ${n[t]}`)}}function wO(n,e){const t=F_({newProps:n,oldProps:e,propTypes:n[Zt],ignoreProps:{data:null,updateTriggers:null,extensions:null,transitions:null}}),i=SO(n,e);let r=!1;return i||(r=EO(n,e)),{dataChanged:i,propsChanged:t,updateTriggersChanged:r,extensionsChanged:AO(n,e),transitionsChanged:TO(n,e)}}function TO(n,e){if(!n.transitions)return!1;const t={},i=n[Zt];let r=!1;for(const s in n.transitions){const o=i[s],a=o&&o.type;(a==="number"||a==="color"||a==="array")&&Bl(n[s],e[s],o)&&(t[s]=!0,r=!0)}return r?t:!1}function F_({newProps:n,oldProps:e,ignoreProps:t={},propTypes:i={},triggerName:r="props"}){if(e===n)return!1;if(typeof n!="object"||n===null)return`${r} changed shallowly`;if(typeof e!="object"||e===null)return`${r} changed shallowly`;for(const s of Object.keys(n))if(!(s in t)){if(!(s in e))return`${r}.${s} added`;const o=Bl(n[s],e[s],i[s]);if(o)return`${r}.${s} ${o}`}for(const s of Object.keys(e))if(!(s in t)){if(!(s in n))return`${r}.${s} dropped`;if(!Object.hasOwnProperty.call(n,s)){const o=Bl(n[s],e[s],i[s]);if(o)return`${r}.${s} ${o}`}}return!1}function Bl(n,e,t){let i=t&&t.equal;return i&&!i(n,e,t)||!i&&(i=n&&e&&n.equals,i&&!i.call(n,e))?"changed deeply":!i&&e!==n?"changed shallowly":null}function SO(n,e){if(e===null)return"oldProps is null, initial diff";let t=!1;const{dataComparator:i,_dataDiff:r}=n;return i?i(n.data,e.data)||(t="Data comparator detected a change"):n.data!==e.data&&(t="A new data container was supplied"),t&&r&&(t=r(n.data,e.data)||t),t}function EO(n,e){if(e===null)return{all:!0};if("all"in n.updateTriggers&&hf(n,e,"all"))return{all:!0};const t={};let i=!1;for(const r in n.updateTriggers)r!=="all"&&hf(n,e,r)&&(t[r]=!0,i=!0);return i?t:!1}function AO(n,e){if(e===null)return!0;const t=e.extensions,{extensions:i}=n;if(i===t)return!1;if(!t||!i||i.length!==t.length)return!0;for(let r=0;r<i.length;r++)if(!i[r].equals(t[r]))return!0;return!1}function hf(n,e,t){let i=n.updateTriggers[t];i=i??{};let r=e.updateTriggers[t];return r=r??{},F_({oldProps:r,newProps:i,triggerName:t})}const CO="count(): argument not an object",IO="count(): argument not a container";function RO(n){if(!MO(n))throw new Error(CO);if(typeof n.count=="function")return n.count();if(Number.isFinite(n.size))return n.size;if(Number.isFinite(n.length))return n.length;if(PO(n))return Object.keys(n).length;throw new Error(IO)}function PO(n){return n!==null&&typeof n=="object"&&n.constructor===Object}function MO(n){return n!==null&&typeof n=="object"}function ff(n,e){if(!e)return n;const t={...n,...e};if("defines"in e&&(t.defines={...n.defines,...e.defines}),"modules"in e&&(t.modules=(n.modules||[]).concat(e.modules),e.modules.some(i=>i.name==="project64"))){const i=t.modules.findIndex(r=>r.name==="project32");i>=0&&t.modules.splice(i,1)}if("inject"in e)if(!n.inject)t.inject=e.inject;else{const i={...n.inject};for(const r in e.inject)i[r]=(i[r]||"")+e.inject[r];t.inject=i}return t}const kO={minFilter:"linear",mipmapFilter:"linear",magFilter:"linear",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge"},Ll={};function OO(n,e,t,i){if(t instanceof fe)return t;t.constructor&&t.constructor.name!=="Object"&&(t={data:t});let r=null;t.compressed&&(r={minFilter:"linear",mipmapFilter:t.data.length>1?"nearest":"linear"});const s=e.createTexture({...t,sampler:{...kO,...r,...i},mipmaps:!0});return Ll[s.id]=n,s}function NO(n,e){!e||!(e instanceof fe)||Ll[e.id]===n&&(e.delete(),delete Ll[e.id])}const FO={boolean:{validate(n,e){return!0},equal(n,e,t){return!!n==!!e}},number:{validate(n,e){return Number.isFinite(n)&&(!("max"in e)||n<=e.max)&&(!("min"in e)||n>=e.min)}},color:{validate(n,e){return e.optional&&!n||Ul(n)&&(n.length===3||n.length===4)},equal(n,e,t){return dt(n,e,1)}},accessor:{validate(n,e){const t=Ys(n);return t==="function"||t===Ys(e.value)},equal(n,e,t){return typeof e=="function"?!0:dt(n,e,1)}},array:{validate(n,e){return e.optional&&!n||Ul(n)},equal(n,e,t){const{compare:i}=t,r=Number.isInteger(i)?i:i?1:0;return i?dt(n,e,r):n===e}},object:{equal(n,e,t){if(t.ignore)return!0;const{compare:i}=t,r=Number.isInteger(i)?i:i?1:0;return i?dt(n,e,r):n===e}},function:{validate(n,e){return e.optional&&!n||typeof n=="function"},equal(n,e,t){return!t.compare&&t.ignore!==!1||n===e}},data:{transform:(n,e,t)=>{if(!n)return n;const{dataTransform:i}=t.props;return i?i(n):typeof n.shape=="string"&&n.shape.endsWith("-table")&&Array.isArray(n.data)?n.data:n}},image:{transform:(n,e,t)=>{const i=t.context;return!i||!i.device?null:OO(t.id,i.device,n,{...e.parameters,...t.props.textureParameters})},release:(n,e,t)=>{NO(t.id,n)}}};function DO(n){const e={},t={},i={};for(const[r,s]of Object.entries(n)){const o=s==null?void 0:s.deprecatedFor;if(o)i[r]=Array.isArray(o)?o:[o];else{const a=BO(r,s);e[r]=a,t[r]=a.value}}return{propTypes:e,defaultProps:t,deprecatedProps:i}}function BO(n,e){switch(Ys(e)){case"object":return gi(n,e);case"array":return gi(n,{type:"array",value:e,compare:!1});case"boolean":return gi(n,{type:"boolean",value:e});case"number":return gi(n,{type:"number",value:e});case"function":return gi(n,{type:"function",value:e,compare:!0});default:return{name:n,type:"unknown",value:e}}}function gi(n,e){return"type"in e?{name:n,...FO[e.type],...e}:"value"in e?{name:n,type:Ys(e.value),...e}:{name:n,type:"object",value:e}}function Ul(n){return Array.isArray(n)||ArrayBuffer.isView(n)}function Ys(n){return Ul(n)?"array":n===null?"null":typeof n}function LO(n,e){let t;for(let s=e.length-1;s>=0;s--){const o=e[s];"extensions"in o&&(t=o.extensions)}const i=$l(n.constructor,t),r=Object.create(i);r[js]=n,r[vn]={},r[Xt]={};for(let s=0;s<e.length;++s){const o=e[s];for(const a in o)r[a]=o[a]}return Object.freeze(r),r}const UO="_mergedDefaultProps";function $l(n,e){if(!(n instanceof B_.constructor))return{};let t=UO;if(e)for(const r of e){const s=r.constructor;s&&(t+=`:${s.extensionName||s.name}`)}const i=D_(n,t);return i||(n[t]=$O(n,e||[]))}function $O(n,e){if(!n.prototype)return null;const i=Object.getPrototypeOf(n),r=$l(i),s=D_(n,"defaultProps")||{},o=DO(s),a=Object.assign(Object.create(null),r,o.defaultProps),l=Object.assign(Object.create(null),r==null?void 0:r[Zt],o.propTypes),c=Object.assign(Object.create(null),r==null?void 0:r[ha],o.deprecatedProps);for(const u of e){const d=$l(u.constructor);d&&(Object.assign(a,d),Object.assign(l,d[Zt]),Object.assign(c,d[ha]))}return zO(a,n),WO(a,l),VO(a,c),a[Zt]=l,a[ha]=c,e.length===0&&!au(n,"_propTypes")&&(n._propTypes=l),a}function zO(n,e){const t=jO(e);Object.defineProperties(n,{id:{writable:!0,value:t}})}function VO(n,e){for(const t in e)Object.defineProperty(n,t,{enumerable:!1,set(i){const r=`${this.id}: ${t}`;for(const s of e[t])au(this,s)||(this[s]=i);Q.deprecated(r,e[t].join("/"))()}})}function WO(n,e){const t={},i={};for(const r in e){const s=e[r],{name:o,value:a}=s;s.async&&(t[o]=a,i[o]=HO(o))}n[Yn]=t,n[vn]={},Object.defineProperties(n,i)}function HO(n){return{enumerable:!0,set(e){typeof e=="string"||e instanceof Promise||S_(e)?this[vn][n]=e:this[Xt][n]=e},get(){if(this[Xt]){if(n in this[Xt])return this[Xt][n]||this[Yn][n];if(n in this[vn]){const e=this[js]&&this[js].internalState;if(e&&e.hasAsyncProp(n))return e.getAsyncProp(n)||this[Yn][n]}}return this[Yn][n]}}}function au(n,e){return Object.prototype.hasOwnProperty.call(n,e)}function D_(n,e){return au(n,e)&&n[e]}function jO(n){const e=n.componentName;return e||Q.warn(`${n.name}.componentName not specified`)(),e||n.name}let XO=0;class lu{constructor(...e){this.props=LO(this,e),this.id=this.props.id,this.count=XO++}clone(e){const{props:t}=this,i={};for(const r in t[Yn])r in t[Xt]?i[r]=t[Xt][r]:r in t[vn]&&(i[r]=t[vn][r]);return new this.constructor({...t,...i,...e})}}lu.componentName="Component";lu.defaultProps={};const B_=lu,YO=Object.freeze({});class qO{constructor(e){this.component=e,this.asyncProps={},this.onAsyncPropUpdated=()=>{},this.oldProps=null,this.oldAsyncProps=null}finalize(){for(const e in this.asyncProps){const t=this.asyncProps[e];t&&t.type&&t.type.release&&t.type.release(t.resolvedValue,t.type,this.component)}this.asyncProps={},this.component=null,this.resetOldProps()}getOldProps(){return this.oldAsyncProps||this.oldProps||YO}resetOldProps(){this.oldAsyncProps=null,this.oldProps=this.component?this.component.props:null}hasAsyncProp(e){return e in this.asyncProps}getAsyncProp(e){const t=this.asyncProps[e];return t&&t.resolvedValue}isAsyncPropLoading(e){if(e){const t=this.asyncProps[e];return!!(t&&t.pendingLoadCount>0&&t.pendingLoadCount!==t.resolvedLoadCount)}for(const t in this.asyncProps)if(this.isAsyncPropLoading(t))return!0;return!1}reloadAsyncProp(e,t){this._watchPromise(e,Promise.resolve(t))}setAsyncProps(e){this.component=e[js]||this.component;const t=e[Xt]||{},i=e[vn]||e,r=e[Yn]||{};for(const s in t){const o=t[s];this._createAsyncPropData(s,r[s]),this._updateAsyncProp(s,o),t[s]=this.getAsyncProp(s)}for(const s in i){const o=i[s];this._createAsyncPropData(s,r[s]),this._updateAsyncProp(s,o)}}_fetch(e,t){return null}_onResolve(e,t){}_onError(e,t){}_updateAsyncProp(e,t){if(this._didAsyncInputValueChange(e,t)){if(typeof t=="string"&&(t=this._fetch(e,t)),t instanceof Promise){this._watchPromise(e,t);return}if(S_(t)){this._resolveAsyncIterable(e,t);return}this._setPropValue(e,t)}}_freezeAsyncOldProps(){if(!this.oldAsyncProps&&this.oldProps){this.oldAsyncProps=Object.create(this.oldProps);for(const e in this.asyncProps)Object.defineProperty(this.oldAsyncProps,e,{enumerable:!0,value:this.oldProps[e]})}}_didAsyncInputValueChange(e,t){const i=this.asyncProps[e];return t===i.resolvedValue||t===i.lastValue?!1:(i.lastValue=t,!0)}_setPropValue(e,t){this._freezeAsyncOldProps();const i=this.asyncProps[e];i&&(t=this._postProcessValue(i,t),i.resolvedValue=t,i.pendingLoadCount++,i.resolvedLoadCount=i.pendingLoadCount)}_setAsyncPropValue(e,t,i){const r=this.asyncProps[e];r&&i>=r.resolvedLoadCount&&t!==void 0&&(this._freezeAsyncOldProps(),r.resolvedValue=t,r.resolvedLoadCount=i,this.onAsyncPropUpdated(e,t))}_watchPromise(e,t){const i=this.asyncProps[e];if(i){i.pendingLoadCount++;const r=i.pendingLoadCount;t.then(s=>{this.component&&(s=this._postProcessValue(i,s),this._setAsyncPropValue(e,s,r),this._onResolve(e,s))}).catch(s=>{this._onError(e,s)})}}async _resolveAsyncIterable(e,t){if(e!=="data"){this._setPropValue(e,t);return}const i=this.asyncProps[e];if(!i)return;i.pendingLoadCount++;const r=i.pendingLoadCount;let s=[],o=0;for await(const a of t){if(!this.component)return;const{dataTransform:l}=this.component.props;l?s=l(a,s):s=s.concat(a),Object.defineProperty(s,"__diff",{enumerable:!1,value:[{startRow:o,endRow:s.length}]}),o=s.length,this._setAsyncPropValue(e,s,r)}this._onResolve(e,s)}_postProcessValue(e,t){const i=e.type;return i&&this.component&&(i.release&&i.release(e.resolvedValue,i,this.component),i.transform)?i.transform(t,i,this.component):t}_createAsyncPropData(e,t){if(!this.asyncProps[e]){const r=this.component&&this.component.props[Zt];this.asyncProps[e]={type:r&&r[e],lastValue:null,resolvedValue:t,pendingLoadCount:0,resolvedLoadCount:0}}}}class KO extends qO{constructor({attributeManager:e,layer:t}){super(t),this.attributeManager=e,this.needsRedraw=!0,this.needsUpdate=!0,this.subLayers=null,this.usesPickingColorCache=!1}get layer(){return this.component}_fetch(e,t){const i=this.layer,r=i==null?void 0:i.props.fetch;return r?r(t,{propName:e,layer:i}):super._fetch(e,t)}_onResolve(e,t){const i=this.layer;if(i){const r=i.props.onDataLoad;e==="data"&&r&&r(t,{propName:e,layer:i})}}_onError(e,t){const i=this.layer;i&&i.raiseError(t,`loading ${e} of ${this.layer}`)}}const ZO="layer.changeFlag",GO="layer.initialize",QO="layer.update",JO="layer.finalize",eN="layer.matched",pf=2**24-1,tN=Object.freeze([]),nN=lr(({oldViewport:n,viewport:e})=>n.equals(e));let rt=new Uint8ClampedArray(0);const iN={data:{type:"data",value:tN,async:!0},dataComparator:{type:"function",value:null,optional:!0},_dataDiff:{type:"function",value:n=>n&&n.__diff,optional:!0},dataTransform:{type:"function",value:null,optional:!0},onDataLoad:{type:"function",value:null,optional:!0},onError:{type:"function",value:null,optional:!0},fetch:{type:"function",value:(n,{propName:e,layer:t,loaders:i,loadOptions:r,signal:s})=>{const{resourceManager:o}=t.context;r=r||t.getLoadOptions(),i=i||t.props.loaders,s&&(r={...r,fetch:{...r==null?void 0:r.fetch,signal:s}});let a=o.contains(n);return!a&&!r&&(o.add({resourceId:n,data:Ts(n,i),persistent:!1}),a=!0),a?o.subscribe({resourceId:n,onChange:l=>{var c;return(c=t.internalState)==null?void 0:c.reloadAsyncProp(e,l)},consumerId:t.id,requestId:e}):Ts(n,i,r)}},updateTriggers:{},visible:!0,pickable:!1,opacity:{type:"number",min:0,max:1,value:1},operation:"draw",onHover:{type:"function",value:null,optional:!0},onClick:{type:"function",value:null,optional:!0},onDragStart:{type:"function",value:null,optional:!0},onDrag:{type:"function",value:null,optional:!0},onDragEnd:{type:"function",value:null,optional:!0},coordinateSystem:Z.DEFAULT,coordinateOrigin:{type:"array",value:[0,0,0],compare:!0},modelMatrix:{type:"array",value:null,compare:!0,optional:!0},wrapLongitude:!1,positionFormat:"XYZ",colorFormat:"RGBA",parameters:{type:"object",value:{},optional:!0,compare:2},loadOptions:{type:"object",value:null,optional:!0,ignore:!0},transitions:null,extensions:[],loaders:{type:"array",value:[],optional:!0,ignore:!0},getPolygonOffset:{type:"function",value:({layerIndex:n})=>[0,-n*100]},highlightedObjectIndex:null,autoHighlight:!1,highlightColor:{type:"accessor",value:[0,0,128,128]}};class cu extends B_{constructor(){super(...arguments),this.internalState=null,this.lifecycle=Dn.NO_STATE,this.parent=null}static get componentName(){return Object.prototype.hasOwnProperty.call(this,"layerName")?this.layerName:""}get root(){let e=this;for(;e.parent;)e=e.parent;return e}toString(){return`${this.constructor.layerName||this.constructor.name}({id: '${this.props.id}'})`}project(e){Me(this.internalState);const t=this.internalState.viewport||this.context.viewport,i=Qm(e,{viewport:t,modelMatrix:this.props.modelMatrix,coordinateOrigin:this.props.coordinateOrigin,coordinateSystem:this.props.coordinateSystem}),[r,s,o]=Ym(i,t.pixelProjectionMatrix);return e.length===2?[r,s]:[r,s,o]}unproject(e){return Me(this.internalState),(this.internalState.viewport||this.context.viewport).unproject(e)}projectPosition(e,t){Me(this.internalState);const i=this.internalState.viewport||this.context.viewport;return NR(e,{viewport:i,modelMatrix:this.props.modelMatrix,coordinateOrigin:this.props.coordinateOrigin,coordinateSystem:this.props.coordinateSystem,...t})}get isComposite(){return!1}get isDrawable(){return!0}setState(e){this.setChangeFlags({stateChanged:!0}),Object.assign(this.state,e),this.setNeedsRedraw()}setNeedsRedraw(){this.internalState&&(this.internalState.needsRedraw=!0)}setNeedsUpdate(){this.internalState&&(this.context.layerManager.setNeedsUpdate(String(this)),this.internalState.needsUpdate=!0)}get isLoaded(){return this.internalState?!this.internalState.isAsyncPropLoading():!1}get wrapLongitude(){return this.props.wrapLongitude}isPickable(){return this.props.pickable&&this.props.visible}getModels(){const e=this.state;return e&&(e.models||e.model&&[e.model])||[]}setShaderModuleProps(...e){for(const t of this.getModels())t.shaderInputs.setProps(...e)}getAttributeManager(){return this.internalState&&this.internalState.attributeManager}getCurrentLayer(){return this.internalState&&this.internalState.layer}getLoadOptions(){return this.props.loadOptions}use64bitPositions(){const{coordinateSystem:e}=this.props;return e===Z.DEFAULT||e===Z.LNGLAT||e===Z.CARTESIAN}onHover(e,t){return this.props.onHover&&this.props.onHover(e,t)||!1}onClick(e,t){return this.props.onClick&&this.props.onClick(e,t)||!1}nullPickingColor(){return[0,0,0]}encodePickingColor(e,t=[]){return t[0]=e+1&255,t[1]=e+1>>8&255,t[2]=e+1>>8>>8&255,t}decodePickingColor(e){Me(e instanceof Uint8Array);const[t,i,r]=e;return t+i*256+r*65536-1}getNumInstances(){return Number.isFinite(this.props.numInstances)?this.props.numInstances:this.state&&this.state.numInstances!==void 0?this.state.numInstances:RO(this.props.data)}getStartIndices(){return this.props.startIndices?this.props.startIndices:this.state&&this.state.startIndices?this.state.startIndices:null}getBounds(){var e;return(e=this.getAttributeManager())==null?void 0:e.getBounds(["positions","instancePositions"])}getShaders(e){e=ff(e,{disableWarnings:!0,modules:this.context.defaultShaderModules});for(const t of this.props.extensions)e=ff(e,t.getShaders.call(this,t));return e}shouldUpdateState(e){return e.changeFlags.propsOrDataChanged}updateState(e){const t=this.getAttributeManager(),{dataChanged:i}=e.changeFlags;if(i&&t)if(Array.isArray(i))for(const r of i)t.invalidateAll(r);else t.invalidateAll();if(t){const{props:r}=e,s=this.internalState.hasPickingBuffer,o=Number.isInteger(r.highlightedObjectIndex)||r.pickable||r.extensions.some(a=>a.getNeedsPickingBuffer.call(this,a));if(s!==o){this.internalState.hasPickingBuffer=o;const{pickingColors:a,instancePickingColors:l}=t.attributes,c=a||l;c&&(o&&c.constant&&(c.constant=!1,t.invalidate(c.id)),!c.value&&!o&&(c.constant=!0,c.value=[0,0,0]))}}}finalizeState(e){for(const i of this.getModels())i.destroy();const t=this.getAttributeManager();t&&t.finalize(),this.context&&this.context.resourceManager.unsubscribe({consumerId:this.id}),this.internalState&&(this.internalState.uniformTransitions.clear(),this.internalState.finalize())}draw(e){for(const t of this.getModels())t.draw(e.renderPass)}getPickingInfo({info:e,mode:t,sourceLayer:i}){const{index:r}=e;return r>=0&&Array.isArray(this.props.data)&&(e.object=this.props.data[r]),e}raiseError(e,t){var i,r,s,o;t&&(e=new Error(`${t}: ${e.message}`,{cause:e})),(r=(i=this.props).onError)!=null&&r.call(i,e)||(o=(s=this.context)==null?void 0:s.onError)==null||o.call(s,e,this)}getNeedsRedraw(e={clearRedrawFlags:!1}){return this._getNeedsRedraw(e)}needsUpdate(){return this.internalState?this.internalState.needsUpdate||this.hasUniformTransition()||this.shouldUpdateState(this._getUpdateParams()):!1}hasUniformTransition(){var e;return((e=this.internalState)==null?void 0:e.uniformTransitions.active)||!1}activateViewport(e){if(!this.internalState)return;const t=this.internalState.viewport;this.internalState.viewport=e,(!t||!nN({oldViewport:t,viewport:e}))&&(this.setChangeFlags({viewportChanged:!0}),this.isComposite?this.needsUpdate()&&this.setNeedsUpdate():this._update())}invalidateAttribute(e="all"){const t=this.getAttributeManager();t&&(e==="all"?t.invalidateAll():t.invalidate(e))}updateAttributes(e){let t=!1;for(const i in e)e[i].layoutChanged()&&(t=!0);for(const i of this.getModels())this._setModelAttributes(i,e,t)}_updateAttributes(){const e=this.getAttributeManager();if(!e)return;const t=this.props,i=this.getNumInstances(),r=this.getStartIndices();e.update({data:t.data,numInstances:i,startIndices:r,props:t,transitions:t.transitions,buffers:t.data.attributes,context:this});const s=e.getChangedAttributes({clearChangedFlags:!0});this.updateAttributes(s)}_updateAttributeTransition(){const e=this.getAttributeManager();e&&e.updateTransition()}_updateUniformTransition(){const{uniformTransitions:e}=this.internalState;if(e.active){const t=e.update(),i=Object.create(this.props);for(const r in t)Object.defineProperty(i,r,{value:t[r]});return i}return this.props}calculateInstancePickingColors(e,{numInstances:t}){if(e.constant)return;const i=Math.floor(rt.length/4);if(this.internalState.usesPickingColorCache=!0,i<t){t>pf&&Q.warn("Layer has too many data objects. Picking might not be able to distinguish all objects.")(),rt=ri.allocate(rt,t,{size:4,copy:!0,maxCount:Math.max(t,pf)});const r=Math.floor(rt.length/4),s=[0,0,0];for(let o=i;o<r;o++)this.encodePickingColor(o,s),rt[o*4+0]=s[0],rt[o*4+1]=s[1],rt[o*4+2]=s[2],rt[o*4+3]=0}e.value=rt.subarray(0,t*4)}_setModelAttributes(e,t,i=!1){var a;if(!Object.keys(t).length)return;if(i){const l=this.getAttributeManager();e.setBufferLayout(l.getBufferLayouts(e)),t=l.getAttributes()}const r=((a=e.userData)==null?void 0:a.excludeAttributes)||{},s={},o={};for(const l in t){if(r[l])continue;const c=t[l].getValue();for(const u in c){const d=c[u];d instanceof le?t[l].settings.isIndexed?e.setIndexBuffer(d):s[u]=d:d&&(o[u]=d)}}e.setAttributes(s),e.setConstantAttributes(o)}disablePickingIndex(e){const t=this.props.data;if(!("attributes"in t)){this._disablePickingIndex(e);return}const{pickingColors:i,instancePickingColors:r}=this.getAttributeManager().attributes,s=i||r,o=s&&t.attributes&&t.attributes[s.id];if(o&&o.value){const a=o.value,l=this.encodePickingColor(e);for(let c=0;c<t.length;c++){const u=s.getVertexOffset(c);a[u]===l[0]&&a[u+1]===l[1]&&a[u+2]===l[2]&&this._disablePickingIndex(c)}}else this._disablePickingIndex(e)}_disablePickingIndex(e){const{pickingColors:t,instancePickingColors:i}=this.getAttributeManager().attributes,r=t||i;if(!r)return;const s=r.getVertexOffset(e),o=r.getVertexOffset(e+1);r.buffer.write(new Uint8Array(o-s),s)}restorePickingColors(){const{pickingColors:e,instancePickingColors:t}=this.getAttributeManager().attributes,i=e||t;i&&(this.internalState.usesPickingColorCache&&i.value.buffer!==rt.buffer&&(i.value=rt.subarray(0,i.value.length)),i.updateSubBuffer({startOffset:0}))}_initialize(){Me(!this.internalState),Me(Number.isFinite(this.props.coordinateSystem)),De(GO,this);const e=this._getAttributeManager();e&&e.addInstanced({instancePickingColors:{type:"uint8",size:4,noAlloc:!0,update:this.calculateInstancePickingColors}}),this.internalState=new KO({attributeManager:e,layer:this}),this._clearChangeFlags(),this.state={},Object.defineProperty(this.state,"attributeManager",{get:()=>(Q.deprecated("layer.state.attributeManager","layer.getAttributeManager()")(),e)}),this.internalState.uniformTransitions=new vO(this.context.timeline),this.internalState.onAsyncPropUpdated=this._onAsyncPropUpdated.bind(this),this.internalState.setAsyncProps(this.props),this.initializeState(this.context);for(const t of this.props.extensions)t.initializeState.call(this,this.context,t);this.setChangeFlags({dataChanged:"init",propsChanged:"init",viewportChanged:!0,extensionsChanged:!0}),this._update()}_transferState(e){De(eN,this,this===e);const{state:t,internalState:i}=e;this!==e&&(this.internalState=i,this.state=t,this.internalState.setAsyncProps(this.props),this._diffProps(this.props,this.internalState.getOldProps()))}_update(){const e=this.needsUpdate();if(De(QO,this,e),!e)return;const t=this.props,i=this.context,r=this.internalState,s=i.viewport,o=this._updateUniformTransition();r.propsInTransition=o,i.viewport=r.viewport||s,this.props=o;try{const a=this._getUpdateParams(),l=this.getModels();if(i.device)this.updateState(a);else try{this.updateState(a)}catch{}for(const u of this.props.extensions)u.updateState.call(this,a,u);this.setNeedsRedraw(),this._updateAttributes();const c=this.getModels()[0]!==l[0];this._postUpdate(a,c)}finally{i.viewport=s,this.props=t,this._clearChangeFlags(),r.needsUpdate=!1,r.resetOldProps()}}_finalize(){De(JO,this),this.finalizeState(this.context);for(const e of this.props.extensions)e.finalizeState.call(this,this.context,e)}_drawLayer({renderPass:e,shaderModuleProps:t=null,uniforms:i={},parameters:r={}}){this._updateAttributeTransition();const s=this.props,o=this.context;this.props=this.internalState.propsInTransition||s;try{t&&this.setShaderModuleProps(t);const{getPolygonOffset:a}=this.props,l=a&&a(i)||[0,0];o.device instanceof Wn&&o.device.setParametersWebGL({polygonOffset:l});for(const c of this.getModels())c.device.type==="webgpu"?c.setParameters({...c.parameters,...r}):c.setParameters(r);if(o.device instanceof Wn)o.device.withParametersWebGL(r,()=>{const c={renderPass:e,shaderModuleProps:t,uniforms:i,parameters:r,context:o};for(const u of this.props.extensions)u.draw.call(this,c,u);this.draw(c)});else{const c={renderPass:e,shaderModuleProps:t,uniforms:i,parameters:r,context:o};for(const u of this.props.extensions)u.draw.call(this,c,u);this.draw(c)}}finally{this.props=s}}getChangeFlags(){var e;return(e=this.internalState)==null?void 0:e.changeFlags}setChangeFlags(e){if(!this.internalState)return;const{changeFlags:t}=this.internalState;for(const r in e)if(e[r]){let s=!1;switch(r){case"dataChanged":const o=e[r],a=t[r];o&&Array.isArray(a)&&(t.dataChanged=Array.isArray(o)?a.concat(o):o,s=!0);default:t[r]||(t[r]=e[r],s=!0)}s&&De(ZO,this,r,e)}const i=!!(t.dataChanged||t.updateTriggersChanged||t.propsChanged||t.extensionsChanged);t.propsOrDataChanged=i,t.somethingChanged=i||t.viewportChanged||t.stateChanged}_clearChangeFlags(){this.internalState.changeFlags={dataChanged:!1,propsChanged:!1,updateTriggersChanged:!1,viewportChanged:!1,stateChanged:!1,extensionsChanged:!1,propsOrDataChanged:!1,somethingChanged:!1}}_diffProps(e,t){var r;const i=wO(e,t);if(i.updateTriggersChanged)for(const s in i.updateTriggersChanged)i.updateTriggersChanged[s]&&this.invalidateAttribute(s);if(i.transitionsChanged)for(const s in i.transitionsChanged)this.internalState.uniformTransitions.add(s,t[s],e[s],(r=e.transitions)==null?void 0:r[s]);return this.setChangeFlags(i)}validateProps(){xO(this.props)}updateAutoHighlight(e){this.props.autoHighlight&&!Number.isInteger(this.props.highlightedObjectIndex)&&this._updateAutoHighlight(e)}_updateAutoHighlight(e){const t={highlightedObjectColor:e.picked?e.color:null},{highlightColor:i}=this.props;e.picked&&typeof i=="function"&&(t.highlightColor=i(e)),this.setShaderModuleProps({picking:t}),this.setNeedsRedraw()}_getAttributeManager(){const e=this.context;return new gO(e.device,{id:this.props.id,stats:e.stats,timeline:e.timeline})}_postUpdate(e,t){const{props:i,oldProps:r}=e,s=this.state.model;s!=null&&s.isInstanced&&s.setInstanceCount(this.getNumInstances());const{autoHighlight:o,highlightedObjectIndex:a,highlightColor:l}=i;if(t||r.autoHighlight!==o||r.highlightedObjectIndex!==a||r.highlightColor!==l){const c={};Array.isArray(l)&&(c.highlightColor=l),(t||r.autoHighlight!==o||a!==r.highlightedObjectIndex)&&(c.highlightedObjectColor=Number.isFinite(a)&&a>=0?this.encodePickingColor(a):null),this.setShaderModuleProps({picking:c})}}_getUpdateParams(){return{props:this.props,oldProps:this.internalState.getOldProps(),context:this.context,changeFlags:this.internalState.changeFlags}}_getNeedsRedraw(e){if(!this.internalState)return!1;let t=!1;t=t||this.internalState.needsRedraw&&this.id;const i=this.getAttributeManager(),r=i?i.getNeedsRedraw(e):!1;if(t=t||r,t)for(const s of this.props.extensions)s.onNeedsRedraw.call(this,s);return this.internalState.needsRedraw=this.internalState.needsRedraw&&!e.clearRedrawFlags,t}_onAsyncPropUpdated(){this._diffProps(this.props,this.internalState.getOldProps()),this.setNeedsUpdate()}}cu.defaultProps=iN;cu.layerName="Layer";const ur=cu,rN="compositeLayer.renderLayers";class L_ extends ur{get isComposite(){return!0}get isDrawable(){return!1}get isLoaded(){return super.isLoaded&&this.getSubLayers().every(e=>e.isLoaded)}getSubLayers(){return this.internalState&&this.internalState.subLayers||[]}initializeState(e){}setState(e){super.setState(e),this.setNeedsUpdate()}getPickingInfo({info:e}){const{object:t}=e;return t&&t.__source&&t.__source.parent&&t.__source.parent.id===this.id&&(e.object=t.__source.object,e.index=t.__source.index),e}filterSubLayer(e){return!0}shouldRenderSubLayer(e,t){return t&&t.length}getSubLayerClass(e,t){const{_subLayerProps:i}=this.props;return i&&i[e]&&i[e].type||t}getSubLayerRow(e,t,i){return e.__source={parent:this,object:t,index:i},e}getSubLayerAccessor(e){if(typeof e=="function"){const t={index:-1,data:this.props.data,target:[]};return(i,r)=>i&&i.__source?(t.index=i.__source.index,e(i.__source.object,t)):e(i,r)}return e}getSubLayerProps(e={}){var F;const{opacity:t,pickable:i,visible:r,parameters:s,getPolygonOffset:o,highlightedObjectIndex:a,autoHighlight:l,highlightColor:c,coordinateSystem:u,coordinateOrigin:d,wrapLongitude:h,positionFormat:f,modelMatrix:p,extensions:g,fetch:_,operation:b,_subLayerProps:w}=this.props,x={id:"",updateTriggers:{},opacity:t,pickable:i,visible:r,parameters:s,getPolygonOffset:o,highlightedObjectIndex:a,autoHighlight:l,highlightColor:c,coordinateSystem:u,coordinateOrigin:d,wrapLongitude:h,positionFormat:f,modelMatrix:p,extensions:g,fetch:_,operation:b},y=w&&e.id&&w[e.id],S=y&&y.updateTriggers,I=e.id||"sublayer";if(y){const D=this.props[Zt],B=e.type?e.type._propTypes:{};for(const U in y){const O=B[U]||D[U];O&&O.type==="accessor"&&(y[U]=this.getSubLayerAccessor(y[U]))}}Object.assign(x,e,y),x.id=`${this.props.id}-${I}`,x.updateTriggers={all:(F=this.props.updateTriggers)==null?void 0:F.all,...e.updateTriggers,...S};for(const D of g){const B=D.getSubLayerProps.call(this,D);B&&Object.assign(x,B,{updateTriggers:Object.assign(x.updateTriggers,B.updateTriggers)})}return x}_updateAutoHighlight(e){for(const t of this.getSubLayers())t.updateAutoHighlight(e)}_getAttributeManager(){return null}_postUpdate(e,t){let i=this.internalState.subLayers;const r=!i||this.needsUpdate();if(r){const s=this.renderLayers();i=Qc(s,Boolean),this.internalState.subLayers=i}De(rN,this,r,i);for(const s of i)s.parent=this}}L_.layerName="CompositeLayer";const sN=L_,ya=Math.PI/180;function oN({height:n,focalDistance:e,orbitAxis:t,rotationX:i,rotationOrbit:r,zoom:s}){const o=t==="Z"?[0,0,1]:[0,1,0],a=t==="Z"?[0,-e,0]:[0,0,e],l=new qe().lookAt({eye:a,up:o});l.rotateX(i*ya),t==="Z"?l.rotateZ(r*ya):l.rotateY(r*ya);const c=Math.pow(2,s)/n;return l.scale(c),l}class aN extends Eo{constructor(e){const{height:t,projectionMatrix:i,fovy:r=50,orbitAxis:s="Z",target:o=[0,0,0],rotationX:a=0,rotationOrbit:l=0,zoom:c=0}=e,u=i?i[5]/2:Zc(r);super({...e,longitude:void 0,viewMatrix:oN({height:t||1,focalDistance:u,orbitAxis:s,rotationX:a,rotationOrbit:l,zoom:c}),fovy:r,focalDistance:u,position:o,zoom:c}),this.projectedCenter=this.project(this.center)}unproject(e,{topLeft:t=!0}={}){const[i,r,s=this.projectedCenter[2]]=e,o=t?r:this.height-r,[a,l,c]=cr([i,o,s],this.pixelUnprojectionMatrix);return[a,l,c]}panByPosition(e,t){const i=this.project(e),r=[this.width/2+i[0]-t[0],this.height/2+i[1]-t[1],this.projectedCenter[2]];return{target:this.unproject(r)}}}const lN=new qe().lookAt({eye:[0,0,1]});function cN({width:n,height:e,near:t,far:i,padding:r}){let s=-n/2,o=n/2,a=-e/2,l=e/2;if(r){const{left:c=0,right:u=0,top:d=0,bottom:h=0}=r,f=Ce((c+n-u)/2,0,n)-n/2,p=Ce((d+e-h)/2,0,e)-e/2;s-=f,o-=f,a+=p,l+=p}return new qe().ortho({left:s,right:o,bottom:a,top:l,near:t,far:i})}class uN extends Eo{constructor(e){const{width:t,height:i,near:r=.1,far:s=1e3,zoom:o=0,target:a=[0,0,0],padding:l=null,flipY:c=!0}=e,u=Array.isArray(o)?o[0]:o,d=Array.isArray(o)?o[1]:o,h=Math.min(u,d),f=Math.pow(2,h);let p;if(u!==d){const g=Math.pow(2,u),_=Math.pow(2,d);p={unitsPerMeter:[g/f,_/f,1],metersPerUnit:[f/g,f/_,1]}}super({...e,longitude:void 0,position:a,viewMatrix:lN.clone().scale([f,f*(c?-1:1),f]),projectionMatrix:cN({width:t||1,height:i||1,padding:l,near:r,far:s}),zoom:h,distanceScales:p})}projectFlat([e,t]){const{unitsPerMeter:i}=this.distanceScales;return[e*i[0],t*i[1]]}unprojectFlat([e,t]){const{metersPerUnit:i}=this.distanceScales;return[e*i[0],t*i[1]]}panByPosition(e,t){const i=cr(t,this.pixelUnprojectionMatrix),r=this.projectFlat(e),s=Us([],r,Cm([],i)),o=Us([],this.center,s);return{target:this.unprojectFlat(o)}}}class U_ extends s_{constructor(e){const{width:t,height:i,rotationX:r=0,rotationOrbit:s=0,target:o=[0,0,0],zoom:a=0,minRotationX:l=-90,maxRotationX:c=90,minZoom:u=-1/0,maxZoom:d=1/0,startPanPosition:h,startRotatePos:f,startRotationX:p,startRotationOrbit:g,startZoomPosition:_,startZoom:b}=e;super({width:t,height:i,rotationX:r,rotationOrbit:s,target:o,zoom:a,minRotationX:l,maxRotationX:c,minZoom:u,maxZoom:d},{startPanPosition:h,startRotatePos:f,startRotationX:p,startRotationOrbit:g,startZoomPosition:_,startZoom:b}),this.makeViewport=e.makeViewport}panStart({pos:e}){return this._getUpdatedState({startPanPosition:this._unproject(e)})}pan({pos:e,startPosition:t}){const i=this.getState().startPanPosition||t;if(!i)return this;const s=this.makeViewport(this.getViewportProps()).panByPosition(i,e);return this._getUpdatedState(s)}panEnd(){return this._getUpdatedState({startPanPosition:null})}rotateStart({pos:e}){return this._getUpdatedState({startRotatePos:e,startRotationX:this.getViewportProps().rotationX,startRotationOrbit:this.getViewportProps().rotationOrbit})}rotate({pos:e,deltaAngleX:t=0,deltaAngleY:i=0}){const{startRotatePos:r,startRotationX:s,startRotationOrbit:o}=this.getState(),{width:a,height:l}=this.getViewportProps();if(!r||s===void 0||o===void 0)return this;let c;if(e){let u=(e[0]-r[0])/a;const d=(e[1]-r[1])/l;(s<-90||s>90)&&(u*=-1),c={rotationX:s+d*180,rotationOrbit:o+u*180}}else c={rotationX:s+i,rotationOrbit:o+t};return this._getUpdatedState(c)}rotateEnd(){return this._getUpdatedState({startRotationX:null,startRotationOrbit:null})}shortestPathFrom(e){const t=e.getViewportProps(),i={...this.getViewportProps()},{rotationOrbit:r}=i;return Math.abs(r-t.rotationOrbit)>180&&(i.rotationOrbit=r<0?r+360:r-360),i}zoomStart({pos:e}){return this._getUpdatedState({startZoomPosition:this._unproject(e),startZoom:this.getViewportProps().zoom})}zoom({pos:e,startPos:t,scale:i}){let{startZoom:r,startZoomPosition:s}=this.getState();if(s||(r=this.getViewportProps().zoom,s=this._unproject(t)||this._unproject(e)),!s)return this;const o=this._calculateNewZoom({scale:i,startZoom:r}),a=this.makeViewport({...this.getViewportProps(),zoom:o});return this._getUpdatedState({zoom:o,...a.panByPosition(s,e)})}zoomEnd(){return this._getUpdatedState({startZoomPosition:null,startZoom:null})}zoomIn(e=2){return this._getUpdatedState({zoom:this._calculateNewZoom({scale:e})})}zoomOut(e=2){return this._getUpdatedState({zoom:this._calculateNewZoom({scale:1/e})})}moveLeft(e=50){return this._panFromCenter([-e,0])}moveRight(e=50){return this._panFromCenter([e,0])}moveUp(e=50){return this._panFromCenter([0,-e])}moveDown(e=50){return this._panFromCenter([0,e])}rotateLeft(e=15){return this._getUpdatedState({rotationOrbit:this.getViewportProps().rotationOrbit-e})}rotateRight(e=15){return this._getUpdatedState({rotationOrbit:this.getViewportProps().rotationOrbit+e})}rotateUp(e=10){return this._getUpdatedState({rotationX:this.getViewportProps().rotationX-e})}rotateDown(e=10){return this._getUpdatedState({rotationX:this.getViewportProps().rotationX+e})}_unproject(e){const t=this.makeViewport(this.getViewportProps());return e&&t.unproject(e)}_calculateNewZoom({scale:e,startZoom:t}){const{maxZoom:i,minZoom:r}=this.getViewportProps();t===void 0&&(t=this.getViewportProps().zoom);const s=t+Math.log2(e);return Ce(s,r,i)}_panFromCenter(e){const{width:t,height:i,target:r}=this.getViewportProps();return this.pan({startPosition:r,pos:[t/2+e[0],i/2+e[1]]})}_getUpdatedState(e){return new this.constructor({makeViewport:this.makeViewport,...this.getViewportProps(),...this.getState(),...e})}applyConstraints(e){const{maxZoom:t,minZoom:i,zoom:r,maxRotationX:s,minRotationX:o,rotationOrbit:a}=e;return e.zoom=Array.isArray(r)?[Ce(r[0],i,t),Ce(r[1],i,t)]:Ce(r,i,t),e.rotationX=Ce(e.rotationX,o,s),(a<-180||a>180)&&(e.rotationOrbit=SR(a+180,360)-180),e}}class dN extends eu{constructor(){super(...arguments),this.ControllerState=U_,this.transition={transitionDuration:300,transitionInterpolator:new si({transitionProps:{compare:["target","zoom","rotationX","rotationOrbit"],required:["target","zoom"]}})}}}class $_ extends Jc{constructor(e={}){super(e),this.props.orbitAxis=e.orbitAxis||"Z"}getViewportType(){return aN}get ControllerType(){return dN}}$_.displayName="OrbitView";const hN=$_;class fN extends U_{constructor(e){super(e),this.zoomAxis=e.zoomAxis||"all"}_calculateNewZoom({scale:e,startZoom:t}){const{maxZoom:i,minZoom:r}=this.getViewportProps();t===void 0&&(t=this.getViewportProps().zoom);let s=Math.log2(e);if(Array.isArray(t)){let[o,a]=t;switch(this.zoomAxis){case"X":o=Ce(o+s,r,i);break;case"Y":a=Ce(a+s,r,i);break;default:let l=Math.min(o+s,a+s);l<r&&(s+=r-l),l=Math.max(o+s,a+s),l>i&&(s+=i-l),o+=s,a+=s}return[o,a]}return Ce(t+s,r,i)}}class pN extends eu{constructor(){super(...arguments),this.ControllerState=fN,this.transition={transitionDuration:300,transitionInterpolator:new si(["target","zoom"])},this.dragMode="pan"}_onPanRotate(){return!1}}class z_ extends Jc{constructor(e={}){super(e)}getViewportType(){return uN}get ControllerType(){return pN}}z_.displayName="OrthographicView";const V_=z_;class gN{constructor(e){this.indexStarts=[0],this.vertexStarts=[0],this.vertexCount=0,this.instanceCount=0;const{attributes:t={}}=e;this.typedArrayManager=ri,this.attributes={},this._attributeDefs=t,this.opts=e,this.updateGeometry(e)}updateGeometry(e){Object.assign(this.opts,e);const{data:t,buffers:i={},getGeometry:r,geometryBuffer:s,positionFormat:o,dataChanged:a,normalize:l=!0}=this.opts;if(this.data=t,this.getGeometry=r,this.positionSize=s&&s.size||(o==="XY"?2:3),this.buffers=i,this.normalize=l,s&&(Me(t.startIndices),this.getGeometry=this.getGeometryFromBuffer(s),l||(i.vertexPositions=s)),this.geometryBuffer=i.vertexPositions,Array.isArray(a))for(const c of a)this._rebuildGeometry(c);else this._rebuildGeometry()}updatePartialGeometry({startRow:e,endRow:t}){this._rebuildGeometry({startRow:e,endRow:t})}getGeometryFromBuffer(e){const t=e.value||e;return ArrayBuffer.isView(t)?E_(t,{size:this.positionSize,offset:e.offset,stride:e.stride,startIndices:this.data.startIndices}):null}_allocate(e,t){const{attributes:i,buffers:r,_attributeDefs:s,typedArrayManager:o}=this;for(const a in s)if(a in r)o.release(i[a]),i[a]=null;else{const l=s[a];l.copy=t,i[a]=o.allocate(i[a],e,l)}}_forEachGeometry(e,t,i){const{data:r,getGeometry:s}=this,{iterable:o,objectInfo:a}=Ro(r,t,i);for(const l of o){a.index++;const c=s?s(l,a):null;e(c,a.index)}}_rebuildGeometry(e){if(!this.data)return;let{indexStarts:t,vertexStarts:i,instanceCount:r}=this;const{data:s,geometryBuffer:o}=this,{startRow:a=0,endRow:l=1/0}=e||{},c={};if(e||(t=[0],i=[0]),this.normalize||!o)this._forEachGeometry((d,h)=>{const f=d&&this.normalizeGeometry(d);c[h]=f,i[h+1]=i[h]+(f?this.getGeometrySize(f):0)},a,l),r=i[i.length-1];else if(i=s.startIndices,r=i[s.length]||0,ArrayBuffer.isView(o))r=r||o.length/this.positionSize;else if(o instanceof le){const d=this.positionSize*4;r=r||o.byteLength/d}else if(o.buffer){const d=o.stride||this.positionSize*4;r=r||o.buffer.byteLength/d}else if(o.value){const d=o.value,h=o.stride/d.BYTES_PER_ELEMENT||this.positionSize;r=r||d.length/h}this._allocate(r,!!e),this.indexStarts=t,this.vertexStarts=i,this.instanceCount=r;const u={};this._forEachGeometry((d,h)=>{const f=c[h]||d;u.vertexStart=i[h],u.indexStart=t[h];const p=h<i.length-1?i[h+1]:r;u.geometrySize=p-i[h],u.geometryIndex=h,this.updateGeometryAttributes(f,u)},a,l),this.vertexCount=t[t.length-1]}}function W_(n,e){if(n._isScrubbing)return;const t=n.container.getBoundingClientRect(),i=e.clientX-t.left,r=n._xToMs(i),s=n._timeToSegmentIndex(r),o=s>=0?s+1:null;o!==n._lastHoverId&&(n._lastHoverId!=null&&n._emit("itemout",{}),o!=null&&n._emit("itemover",{item:o,event:e}),n._lastHoverId=o,n._scheduleUpdate()),n._emit("mouseMove",{event:e})}function H_(n,e){const t=n.container.getBoundingClientRect(),i=e.clientX-t.left,r=Math.max(0,Math.min(n._xToMs(i),n._totalDuration));n._scrubberMs=r,n._emit("timechange",{id:"scrubber",time:new Date(n._scrubberMs)}),n._scheduleUpdate()}function mN(n,e){n._isScrubbing?H_(n,e):W_(n,e)}function _N(n,e){const t=n.container.getBoundingClientRect(),i=e.clientX-t.left;n._xToMs(i);const r=n._msToX(n._scrubberMs);Math.abs(i-r)<n._scrubThresholdPx&&n.setScrubbing(!0)}function yN(n){n._isScrubbing&&(n.setScrubbing(!1),n._emit("timechanged",{id:"scrubber",time:new Date(n._scrubberMs)}))}function bN(n,e){const t=n.container.getBoundingClientRect(),i=e.clientX-t.left,r=n._xToMs(i),s=n._rangeEnd-n._rangeStart,o=Math.sign(e.deltaY)<0?-.2:.2,a=Math.max(1,Math.min(n._totalDuration,s*(1+o)));n._rangeStart=Math.max(0,r-a/2),n._rangeEnd=Math.min(n._totalDuration,r+a/2),n._scheduleUpdate(),e.preventDefault()}function vN(n){n._lastHoverId!=null&&(n._emit("itemout",{}),n._lastHoverId=null,n._scheduleUpdate())}const gf=`uniform iconUniforms {
  float sizeScale;
  vec2 iconsTextureDim;
  float sizeMinPixels;
  float sizeMaxPixels;
  bool billboard;
  highp int sizeUnits;
  float alphaCutoff;
} icon;
`,xN={name:"icon",vs:gf,fs:gf,uniformTypes:{sizeScale:"f32",iconsTextureDim:"vec2<f32>",sizeMinPixels:"f32",sizeMaxPixels:"f32",billboard:"f32",sizeUnits:"i32",alphaCutoff:"f32"}},wN=`#version 300 es
#define SHADER_NAME icon-layer-vertex-shader
in vec2 positions;
in vec3 instancePositions;
in vec3 instancePositions64Low;
in float instanceSizes;
in float instanceAngles;
in vec4 instanceColors;
in vec3 instancePickingColors;
in vec4 instanceIconFrames;
in float instanceColorModes;
in vec2 instanceOffsets;
in vec2 instancePixelOffset;
out float vColorMode;
out vec4 vColor;
out vec2 vTextureCoords;
out vec2 uv;
vec2 rotate_by_angle(vec2 vertex, float angle) {
float angle_radian = angle * PI / 180.0;
float cos_angle = cos(angle_radian);
float sin_angle = sin(angle_radian);
mat2 rotationMatrix = mat2(cos_angle, -sin_angle, sin_angle, cos_angle);
return rotationMatrix * vertex;
}
void main(void) {
geometry.worldPosition = instancePositions;
geometry.uv = positions;
geometry.pickingColor = instancePickingColors;
uv = positions;
vec2 iconSize = instanceIconFrames.zw;
float sizePixels = clamp(
project_size_to_pixel(instanceSizes * icon.sizeScale, icon.sizeUnits),
icon.sizeMinPixels, icon.sizeMaxPixels
);
float instanceScale = iconSize.y == 0.0 ? 0.0 : sizePixels / iconSize.y;
vec2 pixelOffset = positions / 2.0 * iconSize + instanceOffsets;
pixelOffset = rotate_by_angle(pixelOffset, instanceAngles) * instanceScale;
pixelOffset += instancePixelOffset;
pixelOffset.y *= -1.0;
if (icon.billboard)  {
gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, vec3(0.0), geometry.position);
DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
vec3 offset = vec3(pixelOffset, 0.0);
DECKGL_FILTER_SIZE(offset, geometry);
gl_Position.xy += project_pixel_size_to_clipspace(offset.xy);
} else {
vec3 offset_common = vec3(project_pixel_size(pixelOffset), 0.0);
DECKGL_FILTER_SIZE(offset_common, geometry);
gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, offset_common, geometry.position);
DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
}
vTextureCoords = mix(
instanceIconFrames.xy,
instanceIconFrames.xy + iconSize,
(positions.xy + 1.0) / 2.0
) / icon.iconsTextureDim;
vColor = instanceColors;
DECKGL_FILTER_COLOR(vColor, geometry);
vColorMode = instanceColorModes;
}
`,TN=`#version 300 es
#define SHADER_NAME icon-layer-fragment-shader
precision highp float;
uniform sampler2D iconsTexture;
in float vColorMode;
in vec4 vColor;
in vec2 vTextureCoords;
in vec2 uv;
out vec4 fragColor;
void main(void) {
geometry.uv = uv;
vec4 texColor = texture(iconsTexture, vTextureCoords);
vec3 color = mix(texColor.rgb, vColor.rgb, vColorMode);
float a = texColor.a * layer.opacity * vColor.a;
if (a < icon.alphaCutoff) {
discard;
}
fragColor = vec4(color, a);
DECKGL_FILTER_COLOR(fragColor, geometry);
}
`,SN=1024,EN=4,mf=()=>{},_f={minFilter:"linear",mipmapFilter:"linear",magFilter:"linear",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge"},AN={x:0,y:0,width:0,height:0};function CN(n){return Math.pow(2,Math.ceil(Math.log2(n)))}function IN(n,e,t,i){const r=Math.min(t/e.width,i/e.height),s=Math.floor(e.width*r),o=Math.floor(e.height*r);return r===1?{image:e,width:s,height:o}:(n.canvas.height=o,n.canvas.width=s,n.clearRect(0,0,s,o),n.drawImage(e,0,0,e.width,e.height,0,0,s,o),{image:n.canvas,width:s,height:o})}function Gi(n){return n&&(n.id||n.url)}function RN(n,e,t,i){const{width:r,height:s,device:o}=n,a=o.createTexture({format:"rgba8unorm",width:e,height:t,sampler:i,mipmaps:!0}),l=o.createCommandEncoder();return l.copyTextureToTexture({sourceTexture:n,destinationTexture:a,width:r,height:s}),l.finish(),n.destroy(),a}function yf(n,e,t){for(let i=0;i<e.length;i++){const{icon:r,xOffset:s}=e[i],o=Gi(r);n[o]={...r,x:s,y:t}}}function PN({icons:n,buffer:e,mapping:t={},xOffset:i=0,yOffset:r=0,rowHeight:s=0,canvasWidth:o}){let a=[];for(let l=0;l<n.length;l++){const c=n[l],u=Gi(c);if(!t[u]){const{height:d,width:h}=c;i+h+e>o&&(yf(t,a,r),i=0,r=s+r+e,s=0,a=[]),a.push({icon:c,xOffset:i}),i=i+h+e,s=Math.max(s,d)}}return a.length>0&&yf(t,a,r),{mapping:t,rowHeight:s,xOffset:i,yOffset:r,canvasWidth:o,canvasHeight:CN(s+r+e)}}function MN(n,e,t){if(!n||!e)return null;t=t||{};const i={},{iterable:r,objectInfo:s}=Ro(n);for(const o of r){s.index++;const a=e(o,s),l=Gi(a);if(!a)throw new Error("Icon is missing.");if(!a.url)throw new Error("Icon url is missing.");!i[l]&&(!t[l]||a.url!==t[l].url)&&(i[l]={...a,source:o,sourceIndex:s.index})}return i}class kN{constructor(e,{onUpdate:t=mf,onError:i=mf}){this._loadOptions=null,this._texture=null,this._externalTexture=null,this._mapping={},this._samplerParameters=null,this._pendingCount=0,this._autoPacking=!1,this._xOffset=0,this._yOffset=0,this._rowHeight=0,this._buffer=EN,this._canvasWidth=SN,this._canvasHeight=0,this._canvas=null,this.device=e,this.onUpdate=t,this.onError=i}finalize(){var e;(e=this._texture)==null||e.delete()}getTexture(){return this._texture||this._externalTexture}getIconMapping(e){const t=this._autoPacking?Gi(e):e;return this._mapping[t]||AN}setProps({loadOptions:e,autoPacking:t,iconAtlas:i,iconMapping:r,textureParameters:s}){var o;e&&(this._loadOptions=e),t!==void 0&&(this._autoPacking=t),r&&(this._mapping=r),i&&((o=this._texture)==null||o.delete(),this._texture=null,this._externalTexture=i),s&&(this._samplerParameters=s)}get isLoaded(){return this._pendingCount===0}packIcons(e,t){if(!this._autoPacking||typeof document>"u")return;const i=Object.values(MN(e,t,this._mapping)||{});if(i.length>0){const{mapping:r,xOffset:s,yOffset:o,rowHeight:a,canvasHeight:l}=PN({icons:i,buffer:this._buffer,canvasWidth:this._canvasWidth,mapping:this._mapping,rowHeight:this._rowHeight,xOffset:this._xOffset,yOffset:this._yOffset});this._rowHeight=a,this._mapping=r,this._xOffset=s,this._yOffset=o,this._canvasHeight=l,this._texture||(this._texture=this.device.createTexture({format:"rgba8unorm",width:this._canvasWidth,height:this._canvasHeight,sampler:this._samplerParameters||_f,mipmaps:!0})),this._texture.height!==this._canvasHeight&&(this._texture=RN(this._texture,this._canvasWidth,this._canvasHeight,this._samplerParameters||_f)),this.onUpdate(),this._canvas=this._canvas||document.createElement("canvas"),this._loadIcons(i)}}_loadIcons(e){const t=this._canvas.getContext("2d",{willReadFrequently:!0});for(const i of e)this._pendingCount++,Ts(i.url,this._loadOptions).then(r=>{var p;const s=Gi(i),o=this._mapping[s],{x:a,y:l,width:c,height:u}=o,{image:d,width:h,height:f}=IN(t,r,c,u);(p=this._texture)==null||p.copyExternalImage({image:d,x:a+(c-h)/2,y:l+(u-f)/2,width:h,height:f}),o.width=h,o.height=f,this._texture.generateMipmap(),this.onUpdate()}).catch(r=>{this.onError({url:i.url,source:i.source,sourceIndex:i.sourceIndex,loadOptions:this._loadOptions,error:r})}).finally(()=>{this._pendingCount--})}}const j_=[0,0,0,255],ON={iconAtlas:{type:"image",value:null,async:!0},iconMapping:{type:"object",value:{},async:!0},sizeScale:{type:"number",value:1,min:0},billboard:!0,sizeUnits:"pixels",sizeMinPixels:{type:"number",min:0,value:0},sizeMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},alphaCutoff:{type:"number",value:.05,min:0,max:1},getPosition:{type:"accessor",value:n=>n.position},getIcon:{type:"accessor",value:n=>n.icon},getColor:{type:"accessor",value:j_},getSize:{type:"accessor",value:1},getAngle:{type:"accessor",value:0},getPixelOffset:{type:"accessor",value:[0,0]},onIconError:{type:"function",value:null,optional:!0},textureParameters:{type:"object",ignore:!0,value:null}};class uu extends ur{getShaders(){return super.getShaders({vs:wN,fs:TN,modules:[wo,To,xN]})}initializeState(){this.state={iconManager:new kN(this.context.device,{onUpdate:this._onUpdate.bind(this),onError:this._onError.bind(this)})},this.getAttributeManager().addInstanced({instancePositions:{size:3,type:"float64",fp64:this.use64bitPositions(),transition:!0,accessor:"getPosition"},instanceSizes:{size:1,transition:!0,accessor:"getSize",defaultValue:1},instanceOffsets:{size:2,accessor:"getIcon",transform:this.getInstanceOffset},instanceIconFrames:{size:4,accessor:"getIcon",transform:this.getInstanceIconFrame},instanceColorModes:{size:1,type:"uint8",accessor:"getIcon",transform:this.getInstanceColorMode},instanceColors:{size:this.props.colorFormat.length,type:"unorm8",transition:!0,accessor:"getColor",defaultValue:j_},instanceAngles:{size:1,transition:!0,accessor:"getAngle"},instancePixelOffset:{size:2,transition:!0,accessor:"getPixelOffset"}})}updateState(e){var f;super.updateState(e);const{props:t,oldProps:i,changeFlags:r}=e,s=this.getAttributeManager(),{iconAtlas:o,iconMapping:a,data:l,getIcon:c,textureParameters:u}=t,{iconManager:d}=this.state;if(typeof o=="string")return;const h=o||this.internalState.isAsyncPropLoading("iconAtlas");d.setProps({loadOptions:t.loadOptions,autoPacking:!h,iconAtlas:o,iconMapping:h?a:null,textureParameters:u}),h?i.iconMapping!==t.iconMapping&&s.invalidate("getIcon"):(r.dataChanged||r.updateTriggersChanged&&(r.updateTriggersChanged.all||r.updateTriggersChanged.getIcon))&&d.packIcons(l,c),r.extensionsChanged&&((f=this.state.model)==null||f.destroy(),this.state.model=this._getModel(),s.invalidateAll())}get isLoaded(){return super.isLoaded&&this.state.iconManager.isLoaded}finalizeState(e){super.finalizeState(e),this.state.iconManager.finalize()}draw({uniforms:e}){const{sizeScale:t,sizeMinPixels:i,sizeMaxPixels:r,sizeUnits:s,billboard:o,alphaCutoff:a}=this.props,{iconManager:l}=this.state,c=l.getTexture();if(c){const u=this.state.model,d={iconsTexture:c,iconsTextureDim:[c.width,c.height],sizeUnits:Ot[s],sizeScale:t,sizeMinPixels:i,sizeMaxPixels:r,billboard:o,alphaCutoff:a};u.shaderInputs.setProps({icon:d}),u.draw(this.context.renderPass)}}_getModel(){const e=[-1,-1,1,-1,-1,1,1,1];return new Qt(this.context.device,{...this.getShaders(),id:this.props.id,bufferLayout:this.getAttributeManager().getBufferLayouts(),geometry:new Co({topology:"triangle-strip",attributes:{positions:{size:2,value:new Float32Array(e)}}}),isInstanced:!0})}_onUpdate(){this.setNeedsRedraw()}_onError(e){var i;const t=(i=this.getCurrentLayer())==null?void 0:i.props.onIconError;t?t(e):Q.error(e.error.message)()}getInstanceOffset(e){const{width:t,height:i,anchorX:r=t/2,anchorY:s=i/2}=this.state.iconManager.getIconMapping(e);return[t/2-r,i/2-s]}getInstanceColorMode(e){return this.state.iconManager.getIconMapping(e).mask?1:0}getInstanceIconFrame(e){const{x:t,y:i,width:r,height:s}=this.state.iconManager.getIconMapping(e);return[t,i,r,s]}}uu.defaultProps=ON;uu.layerName="IconLayer";const NN=uu,bf=`uniform scatterplotUniforms {
  float radiusScale;
  float radiusMinPixels;
  float radiusMaxPixels;
  float lineWidthScale;
  float lineWidthMinPixels;
  float lineWidthMaxPixels;
  float stroked;
  float filled;
  bool antialiasing;
  bool billboard;
  highp int radiusUnits;
  highp int lineWidthUnits;
} scatterplot;
`,FN={name:"scatterplot",vs:bf,fs:bf,source:"",uniformTypes:{radiusScale:"f32",radiusMinPixels:"f32",radiusMaxPixels:"f32",lineWidthScale:"f32",lineWidthMinPixels:"f32",lineWidthMaxPixels:"f32",stroked:"f32",filled:"f32",antialiasing:"f32",billboard:"f32",radiusUnits:"i32",lineWidthUnits:"i32"}},DN=`#version 300 es
#define SHADER_NAME scatterplot-layer-vertex-shader
in vec3 positions;
in vec3 instancePositions;
in vec3 instancePositions64Low;
in float instanceRadius;
in float instanceLineWidths;
in vec4 instanceFillColors;
in vec4 instanceLineColors;
in vec3 instancePickingColors;
out vec4 vFillColor;
out vec4 vLineColor;
out vec2 unitPosition;
out float innerUnitRadius;
out float outerRadiusPixels;
void main(void) {
geometry.worldPosition = instancePositions;
outerRadiusPixels = clamp(
project_size_to_pixel(scatterplot.radiusScale * instanceRadius, scatterplot.radiusUnits),
scatterplot.radiusMinPixels, scatterplot.radiusMaxPixels
);
float lineWidthPixels = clamp(
project_size_to_pixel(scatterplot.lineWidthScale * instanceLineWidths, scatterplot.lineWidthUnits),
scatterplot.lineWidthMinPixels, scatterplot.lineWidthMaxPixels
);
outerRadiusPixels += scatterplot.stroked * lineWidthPixels / 2.0;
float edgePadding = scatterplot.antialiasing ? (outerRadiusPixels + SMOOTH_EDGE_RADIUS) / outerRadiusPixels : 1.0;
unitPosition = edgePadding * positions.xy;
geometry.uv = unitPosition;
geometry.pickingColor = instancePickingColors;
innerUnitRadius = 1.0 - scatterplot.stroked * lineWidthPixels / outerRadiusPixels;
if (scatterplot.billboard) {
gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, vec3(0.0), geometry.position);
DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
vec3 offset = edgePadding * positions * outerRadiusPixels;
DECKGL_FILTER_SIZE(offset, geometry);
gl_Position.xy += project_pixel_size_to_clipspace(offset.xy);
} else {
vec3 offset = edgePadding * positions * project_pixel_size(outerRadiusPixels);
DECKGL_FILTER_SIZE(offset, geometry);
gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, offset, geometry.position);
DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
}
vFillColor = vec4(instanceFillColors.rgb, instanceFillColors.a * layer.opacity);
DECKGL_FILTER_COLOR(vFillColor, geometry);
vLineColor = vec4(instanceLineColors.rgb, instanceLineColors.a * layer.opacity);
DECKGL_FILTER_COLOR(vLineColor, geometry);
}
`,BN=`#version 300 es
#define SHADER_NAME scatterplot-layer-fragment-shader
precision highp float;
in vec4 vFillColor;
in vec4 vLineColor;
in vec2 unitPosition;
in float innerUnitRadius;
in float outerRadiusPixels;
out vec4 fragColor;
void main(void) {
geometry.uv = unitPosition;
float distToCenter = length(unitPosition) * outerRadiusPixels;
float inCircle = scatterplot.antialiasing ?
smoothedge(distToCenter, outerRadiusPixels) :
step(distToCenter, outerRadiusPixels);
if (inCircle == 0.0) {
discard;
}
if (scatterplot.stroked > 0.5) {
float isLine = scatterplot.antialiasing ?
smoothedge(innerUnitRadius * outerRadiusPixels, distToCenter) :
step(innerUnitRadius * outerRadiusPixels, distToCenter);
if (scatterplot.filled > 0.5) {
fragColor = mix(vFillColor, vLineColor, isLine);
} else {
if (isLine == 0.0) {
discard;
}
fragColor = vec4(vLineColor.rgb, vLineColor.a * isLine);
}
} else if (scatterplot.filled < 0.5) {
discard;
} else {
fragColor = vFillColor;
}
fragColor.a *= inCircle;
DECKGL_FILTER_COLOR(fragColor, geometry);
}
`,LN=`// TODO(ibgreen): Hack for Layer uniforms (move to new "color" module?)

struct LayerUniforms {
  opacity: f32,
};

var<private> layer: LayerUniforms = LayerUniforms(1.0);
// @group(0) @binding(1) var<uniform> layer: LayerUniforms;

// Main shaders

struct ScatterplotUniforms {
  radiusScale: f32,
  radiusMinPixels: f32,
  radiusMaxPixels: f32,
  lineWidthScale: f32,
  lineWidthMinPixels: f32,
  lineWidthMaxPixels: f32,
  stroked: f32,
  filled: i32,
  antialiasing: i32,
  billboard: i32,
  radiusUnits: i32,
  lineWidthUnits: i32,
};

struct ConstantAttributeUniforms {
 instancePositions: vec3<f32>,
 instancePositions64Low: vec3<f32>,
 instanceRadius: f32,
 instanceLineWidths: f32,
 instanceFillColors: vec4<f32>,
 instanceLineColors: vec4<f32>,
 instancePickingColors: vec3<f32>,

 instancePositionsConstant: i32,
 instancePositions64LowConstant: i32,
 instanceRadiusConstant: i32,
 instanceLineWidthsConstant: i32,
 instanceFillColorsConstant: i32,
 instanceLineColorsConstant: i32,
 instancePickingColorsConstant: i32
};

@group(0) @binding(2) var<uniform> scatterplot: ScatterplotUniforms;

struct ConstantAttributes {
  instancePositions: vec3<f32>,
  instancePositions64Low: vec3<f32>,
  instanceRadius: f32,
  instanceLineWidths: f32,
  instanceFillColors: vec4<f32>,
  instanceLineColors: vec4<f32>,
  instancePickingColors: vec3<f32>
};

const constants = ConstantAttributes(
  vec3<f32>(0.0),
  vec3<f32>(0.0),
  0.0,
  0.0,
  vec4<f32>(0.0, 0.0, 0.0, 1.0),
  vec4<f32>(0.0, 0.0, 0.0, 1.0),
  vec3<f32>(0.0)
);

struct Attributes {
  @builtin(instance_index) instanceIndex : u32,
  @builtin(vertex_index) vertexIndex : u32,
  @location(0) positions: vec3<f32>,
  @location(1) instancePositions: vec3<f32>,
  @location(2) instancePositions64Low: vec3<f32>,
  @location(3) instanceRadius: f32,
  @location(4) instanceLineWidths: f32,
  @location(5) instanceFillColors: vec4<f32>,
  @location(6) instanceLineColors: vec4<f32>,
  @location(7) instancePickingColors: vec3<f32>
};

struct Varyings {
  @builtin(position) position: vec4<f32>,
  @location(0) vFillColor: vec4<f32>,
  @location(1) vLineColor: vec4<f32>,
  @location(2) unitPosition: vec2<f32>,
  @location(3) innerUnitRadius: f32,
  @location(4) outerRadiusPixels: f32,
};

@vertex
fn vertexMain(attributes: Attributes) -> Varyings {
  var varyings: Varyings;

  // Draw an inline geometry constant array clip space triangle to verify that rendering works.
  // var positions = array<vec2<f32>, 3>(vec2(0.0, 0.5), vec2(-0.5, -0.5), vec2(0.5, -0.5));
  // if (attributes.instanceIndex == 0) {
  //   varyings.position = vec4<f32>(positions[attributes.vertexIndex], 0.0, 1.0);
  //   return varyings;
  // }

  // var geometry: Geometry;
  // geometry.worldPosition = instancePositions;

  // Multiply out radius and clamp to limits
  varyings.outerRadiusPixels = clamp(
    project_unit_size_to_pixel(scatterplot.radiusScale * attributes.instanceRadius, scatterplot.radiusUnits),
    scatterplot.radiusMinPixels, scatterplot.radiusMaxPixels
  );

  // Multiply out line width and clamp to limits
  let lineWidthPixels = clamp(
    project_unit_size_to_pixel(scatterplot.lineWidthScale * attributes.instanceLineWidths, scatterplot.lineWidthUnits),
    scatterplot.lineWidthMinPixels, scatterplot.lineWidthMaxPixels
  );

  // outer radius needs to offset by half stroke width
  varyings.outerRadiusPixels += scatterplot.stroked * lineWidthPixels / 2.0;
  // Expand geometry to accommodate edge smoothing
  let edgePadding = select(
    (varyings.outerRadiusPixels + SMOOTH_EDGE_RADIUS) / varyings.outerRadiusPixels,
    1.0,
    scatterplot.antialiasing != 0
  );

  // position on the containing square in [-1, 1] space
  varyings.unitPosition = edgePadding * attributes.positions.xy;
  geometry.uv = varyings.unitPosition;
  geometry.pickingColor = attributes.instancePickingColors;

  varyings.innerUnitRadius = 1.0 - scatterplot.stroked * lineWidthPixels / varyings.outerRadiusPixels;

  if (scatterplot.billboard != 0) {
    varyings.position = project_position_to_clipspace(attributes.instancePositions, attributes.instancePositions64Low, vec3<f32>(0.0)); // TODO , geometry.position);
    // DECKGL_FILTER_GL_POSITION(varyings.position, geometry);
    let offset = attributes.positions; // * edgePadding * varyings.outerRadiusPixels;
    // DECKGL_FILTER_SIZE(offset, geometry);
    let clipPixels = project_pixel_size_to_clipspace(offset.xy);
    varyings.position.x = clipPixels.x;
    varyings.position.y = clipPixels.y;
  } else {
    let offset = edgePadding * attributes.positions * project_pixel_size_float(varyings.outerRadiusPixels);
    // DECKGL_FILTER_SIZE(offset, geometry);
    varyings.position = project_position_to_clipspace(attributes.instancePositions, attributes.instancePositions64Low, offset); // TODO , geometry.position);
    // DECKGL_FILTER_GL_POSITION(varyings.position, geometry);
  }

  // Apply opacity to instance color, or return instance picking color
  varyings.vFillColor = vec4<f32>(attributes.instanceFillColors.rgb, attributes.instanceFillColors.a * layer.opacity);
  // DECKGL_FILTER_COLOR(varyings.vFillColor, geometry);
  varyings.vLineColor = vec4<f32>(attributes.instanceLineColors.rgb, attributes.instanceLineColors.a * layer.opacity);
  // DECKGL_FILTER_COLOR(varyings.vLineColor, geometry);

  return varyings;
}

@fragment
fn fragmentMain(varyings: Varyings) -> @location(0) vec4<f32> {
  // var geometry: Geometry;
  // geometry.uv = unitPosition;

  let distToCenter = length(varyings.unitPosition) * varyings.outerRadiusPixels;
  let inCircle = select(
    smoothedge(distToCenter, varyings.outerRadiusPixels),
    step(distToCenter, varyings.outerRadiusPixels),
    scatterplot.antialiasing != 0
  );

  if (inCircle == 0.0) {
    // discard;
  }

  var fragColor: vec4<f32>;

  if (scatterplot.stroked != 0) {
    let isLine = select(
      smoothedge(varyings.innerUnitRadius * varyings.outerRadiusPixels, distToCenter),
      step(varyings.innerUnitRadius * varyings.outerRadiusPixels, distToCenter),
      scatterplot.antialiasing != 0
    );

    if (scatterplot.filled != 0) {
      fragColor = mix(varyings.vFillColor, varyings.vLineColor, isLine);
    } else {
      if (isLine == 0.0) {
        // discard;
      }
      fragColor = vec4<f32>(varyings.vLineColor.rgb, varyings.vLineColor.a * isLine);
    }
  } else if (scatterplot.filled == 0) {
    // discard;
  } else {
    fragColor = varyings.vFillColor;
  }

  fragColor.a *= inCircle;
  // DECKGL_FILTER_COLOR(fragColor, geometry);

  return fragColor;
  // return vec4<f32>(0, 0, 1, 1);
}
`,vf=[0,0,0,255],UN={radiusUnits:"meters",radiusScale:{type:"number",min:0,value:1},radiusMinPixels:{type:"number",min:0,value:0},radiusMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},lineWidthUnits:"meters",lineWidthScale:{type:"number",min:0,value:1},lineWidthMinPixels:{type:"number",min:0,value:0},lineWidthMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},stroked:!1,filled:!0,billboard:!1,antialiasing:!0,getPosition:{type:"accessor",value:n=>n.position},getRadius:{type:"accessor",value:1},getFillColor:{type:"accessor",value:vf},getLineColor:{type:"accessor",value:vf},getLineWidth:{type:"accessor",value:1},strokeWidth:{deprecatedFor:"getLineWidth"},outline:{deprecatedFor:"stroked"},getColor:{deprecatedFor:["getFillColor","getLineColor"]}};class du extends ur{getShaders(){return super.getShaders({vs:DN,fs:BN,source:LN,modules:[wo,To,FN]})}initializeState(){this.getAttributeManager().addInstanced({instancePositions:{size:3,type:"float64",fp64:this.use64bitPositions(),transition:!0,accessor:"getPosition"},instanceRadius:{size:1,transition:!0,accessor:"getRadius",defaultValue:1},instanceFillColors:{size:this.props.colorFormat.length,transition:!0,type:"unorm8",accessor:"getFillColor",defaultValue:[0,0,0,255]},instanceLineColors:{size:this.props.colorFormat.length,transition:!0,type:"unorm8",accessor:"getLineColor",defaultValue:[0,0,0,255]},instanceLineWidths:{size:1,transition:!0,accessor:"getLineWidth",defaultValue:1}})}updateState(e){var t;super.updateState(e),e.changeFlags.extensionsChanged&&((t=this.state.model)==null||t.destroy(),this.state.model=this._getModel(),this.getAttributeManager().invalidateAll())}draw({uniforms:e}){const{radiusUnits:t,radiusScale:i,radiusMinPixels:r,radiusMaxPixels:s,stroked:o,filled:a,billboard:l,antialiasing:c,lineWidthUnits:u,lineWidthScale:d,lineWidthMinPixels:h,lineWidthMaxPixels:f}=this.props,p={stroked:o,filled:a,billboard:l,antialiasing:c,radiusUnits:Ot[t],radiusScale:i,radiusMinPixels:r,radiusMaxPixels:s,lineWidthUnits:Ot[u],lineWidthScale:d,lineWidthMinPixels:h,lineWidthMaxPixels:f},g=this.state.model;g.shaderInputs.setProps({scatterplot:p}),g.draw(this.context.renderPass)}_getModel(){const e=[-1,-1,0,1,-1,0,-1,1,0,1,1,0];return new Qt(this.context.device,{...this.getShaders(),id:this.props.id,bufferLayout:this.getAttributeManager().getBufferLayouts(),geometry:new Co({topology:"triangle-strip",attributes:{positions:{size:3,value:new Float32Array(e)}}}),isInstanced:!0})}}du.defaultProps=UN;du.layerName="ScatterplotLayer";const X_=du;function ht(n,e){const t=e.length,i=n.length;if(i>0){let r=!0;for(let s=0;s<t;s++)if(n[i-t+s]!==e[s]){r=!1;break}if(r)return!1}for(let r=0;r<t;r++)n[i+r]=e[r];return!0}function zl(n,e){const t=e.length;for(let i=0;i<t;i++)n[i]=e[i]}function Qi(n,e,t,i,r=[]){const s=i+e*t;for(let o=0;o<t;o++)r[o]=n[s+o];return r}function Vl(n,e,t,i,r=[]){let s,o;if(t&8)s=(i[3]-n[1])/(e[1]-n[1]),o=3;else if(t&4)s=(i[1]-n[1])/(e[1]-n[1]),o=1;else if(t&2)s=(i[2]-n[0])/(e[0]-n[0]),o=2;else if(t&1)s=(i[0]-n[0])/(e[0]-n[0]),o=0;else return null;for(let a=0;a<n.length;a++)r[a]=(o&1)===a?i[o]:s*(e[a]-n[a])+n[a];return r}function Jr(n,e){let t=0;return n[0]<e[0]?t|=1:n[0]>e[2]&&(t|=2),n[1]<e[1]?t|=4:n[1]>e[3]&&(t|=8),t}function Y_(n,e){const{size:t=2,broken:i=!1,gridResolution:r=10,gridOffset:s=[0,0],startIndex:o=0,endIndex:a=n.length}=e||{},l=(a-o)/t;let c=[];const u=[c],d=Qi(n,0,t,o);let h,f;const p=q_(d,r,s,[]),g=[];ht(c,d);for(let _=1;_<l;_++){for(h=Qi(n,_,t,o,h),f=Jr(h,p);f;){Vl(d,h,f,p,g);const b=Jr(g,p);b&&(Vl(d,g,b,p,g),f=b),ht(c,g),zl(d,g),VN(p,r,f),i&&c.length>t&&(c=[],u.push(c),ht(c,d)),f=Jr(h,p)}ht(c,h),zl(d,h)}return i?u:u[0]}const xf=0,$N=1;function zN(n,e=null,t){if(!n.length)return[];const{size:i=2,gridResolution:r=10,gridOffset:s=[0,0],edgeTypes:o=!1}=t||{},a=[],l=[{pos:n,types:o?new Array(n.length/i).fill($N):null,holes:e||[]}],c=[[],[]];let u=[];for(;l.length;){const{pos:d,types:h,holes:f}=l.shift();WN(d,i,f[0]||d.length,c),u=q_(c[0],r,s,u);const p=Jr(c[1],u);if(p){let g=wf(d,h,i,0,f[0]||d.length,u,p);const _={pos:g[0].pos,types:g[0].types,holes:[]},b={pos:g[1].pos,types:g[1].types,holes:[]};l.push(_,b);for(let w=0;w<f.length;w++)g=wf(d,h,i,f[w],f[w+1]||d.length,u,p),g[0]&&(_.holes.push(_.pos.length),_.pos=Ur(_.pos,g[0].pos),o&&(_.types=Ur(_.types,g[0].types))),g[1]&&(b.holes.push(b.pos.length),b.pos=Ur(b.pos,g[1].pos),o&&(b.types=Ur(b.types,g[1].types)))}else{const g={positions:d};o&&(g.edgeTypes=h),f.length&&(g.holeIndices=f),a.push(g)}}return a}function wf(n,e,t,i,r,s,o){const a=(r-i)/t,l=[],c=[],u=[],d=[],h=[];let f,p,g;const _=Qi(n,a-1,t,i);let b=Math.sign(o&8?_[1]-s[3]:_[0]-s[2]),w=e&&e[a-1],x=0,y=0;for(let S=0;S<a;S++)f=Qi(n,S,t,i,f),p=Math.sign(o&8?f[1]-s[3]:f[0]-s[2]),g=e&&e[i/t+S],p&&b&&b!==p&&(Vl(_,f,o,s,h),ht(l,h)&&u.push(w),ht(c,h)&&d.push(w)),p<=0?(ht(l,f)&&u.push(g),x-=p):u.length&&(u[u.length-1]=xf),p>=0?(ht(c,f)&&d.push(g),y+=p):d.length&&(d[d.length-1]=xf),zl(_,f),b=p,w=g;return[x?{pos:l,types:e&&u}:null,y?{pos:c,types:e&&d}:null]}function q_(n,e,t,i){const r=Math.floor((n[0]-t[0])/e)*e+t[0],s=Math.floor((n[1]-t[1])/e)*e+t[1];return i[0]=r,i[1]=s,i[2]=r+e,i[3]=s+e,i}function VN(n,e,t){t&8?(n[1]+=e,n[3]+=e):t&4?(n[1]-=e,n[3]-=e):t&2?(n[0]+=e,n[2]+=e):t&1&&(n[0]-=e,n[2]-=e)}function WN(n,e,t,i){let r=1/0,s=-1/0,o=1/0,a=-1/0;for(let l=0;l<t;l+=e){const c=n[l],u=n[l+1];r=c<r?c:r,s=c>s?c:s,o=u<o?u:o,a=u>a?u:a}return i[0][0]=r,i[0][1]=o,i[1][0]=s,i[1][1]=a,i}function Ur(n,e){for(let t=0;t<e.length;t++)n.push(e[t]);return n}const HN=85.051129;function jN(n,e){const{size:t=2,startIndex:i=0,endIndex:r=n.length,normalize:s=!0}=e||{},o=n.slice(i,r);K_(o,t,0,r-i);const a=Y_(o,{size:t,broken:!0,gridResolution:360,gridOffset:[-180,-180]});if(s)for(const l of a)Z_(l,t);return a}function kB(n,e=null,t){const{size:i=2,normalize:r=!0,edgeTypes:s=!1}=t||{};e=e||[];const o=[],a=[];let l=0,c=0;for(let d=0;d<=e.length;d++){const h=e[d]||n.length,f=c,p=XN(n,i,l,h);for(let g=p;g<h;g++)o[c++]=n[g];for(let g=l;g<p;g++)o[c++]=n[g];K_(o,i,f,c),YN(o,i,f,c,t==null?void 0:t.maxLatitude),l=h,a[d]=c}a.pop();const u=zN(o,a,{size:i,gridResolution:360,gridOffset:[-180,-180],edgeTypes:s});if(r)for(const d of u)Z_(d.positions,i);return u}function XN(n,e,t,i){let r=-1,s=-1;for(let o=t+1;o<i;o+=e){const a=Math.abs(n[o]);a>r&&(r=a,s=o-1)}return s}function YN(n,e,t,i,r=HN){const s=n[t],o=n[i-e];if(Math.abs(s-o)>180){const a=Qi(n,0,e,t);a[0]+=Math.round((o-s)/360)*360,ht(n,a),a[1]=Math.sign(a[1])*r,ht(n,a),a[0]=s,ht(n,a)}}function K_(n,e,t,i){let r=n[0],s;for(let o=t;o<i;o+=e){s=n[o];const a=s-r;(a>180||a<-180)&&(s-=Math.round(a/360)*360),n[o]=r=s}}function Z_(n,e){let t;const i=n.length/e;for(let s=0;s<i&&(t=n[s*e],(t+180)%360===0);s++);const r=-Math.round(t/360)*360;if(r!==0)for(let s=0;s<i;s++)n[s*e]+=r}function qN(n,e,t,i){let r;if(Array.isArray(n[0])){const s=n.length*e;r=new Array(s);for(let o=0;o<n.length;o++)for(let a=0;a<e;a++)r[o*e+a]=n[o][a]||0}else r=n;return t?Y_(r,{size:e,gridResolution:t}):i?jN(r,{size:e}):r}const KN=1,ZN=2,ba=4;class GN extends gN{constructor(e){super({...e,attributes:{positions:{size:3,padding:18,initialize:!0,type:e.fp64?Float64Array:Float32Array},segmentTypes:{size:1,type:Uint8ClampedArray}}})}get(e){return this.attributes[e]}getGeometryFromBuffer(e){return this.normalize?super.getGeometryFromBuffer(e):null}normalizeGeometry(e){return this.normalize?qN(e,this.positionSize,this.opts.resolution,this.opts.wrapLongitude):e}getGeometrySize(e){if(Tf(e)){let i=0;for(const r of e)i+=this.getGeometrySize(r);return i}const t=this.getPathLength(e);return t<2?0:this.isClosed(e)?t<3?0:t+2:t}updateGeometryAttributes(e,t){if(t.geometrySize!==0)if(e&&Tf(e))for(const i of e){const r=this.getGeometrySize(i);t.geometrySize=r,this.updateGeometryAttributes(i,t),t.vertexStart+=r}else this._updateSegmentTypes(e,t),this._updatePositions(e,t)}_updateSegmentTypes(e,t){const i=this.attributes.segmentTypes,r=e?this.isClosed(e):!1,{vertexStart:s,geometrySize:o}=t;i.fill(0,s,s+o),r?(i[s]=ba,i[s+o-2]=ba):(i[s]+=KN,i[s+o-2]+=ZN),i[s+o-1]=ba}_updatePositions(e,t){const{positions:i}=this.attributes;if(!i||!e)return;const{vertexStart:r,geometrySize:s}=t,o=new Array(3);for(let a=r,l=0;l<s;a++,l++)this.getPointOnPath(e,l,o),i[a*3]=o[0],i[a*3+1]=o[1],i[a*3+2]=o[2]}getPathLength(e){return e.length/this.positionSize}getPointOnPath(e,t,i=[]){const{positionSize:r}=this;t*r>=e.length&&(t+=1-e.length/r);const s=t*r;return i[0]=e[s],i[1]=e[s+1],i[2]=r===3&&e[s+2]||0,i}isClosed(e){if(!this.normalize)return!!this.opts.loop;const{positionSize:t}=this,i=e.length-t;return e[0]===e[i]&&e[1]===e[i+1]&&(t===2||e[2]===e[i+2])}}function Tf(n){return Array.isArray(n[0])}const Sf=`uniform pathUniforms {
  float widthScale;
  float widthMinPixels;
  float widthMaxPixels;
  float jointType;
  float capType;
  float miterLimit;
  bool billboard;
  highp int widthUnits;
} path;
`,QN={name:"path",vs:Sf,fs:Sf,uniformTypes:{widthScale:"f32",widthMinPixels:"f32",widthMaxPixels:"f32",jointType:"f32",capType:"f32",miterLimit:"f32",billboard:"f32",widthUnits:"i32"}},JN=`#version 300 es
#define SHADER_NAME path-layer-vertex-shader
in vec2 positions;
in float instanceTypes;
in vec3 instanceStartPositions;
in vec3 instanceEndPositions;
in vec3 instanceLeftPositions;
in vec3 instanceRightPositions;
in vec3 instanceLeftPositions64Low;
in vec3 instanceStartPositions64Low;
in vec3 instanceEndPositions64Low;
in vec3 instanceRightPositions64Low;
in float instanceStrokeWidths;
in vec4 instanceColors;
in vec3 instancePickingColors;
uniform float opacity;
out vec4 vColor;
out vec2 vCornerOffset;
out float vMiterLength;
out vec2 vPathPosition;
out float vPathLength;
out float vJointType;
const float EPSILON = 0.001;
const vec3 ZERO_OFFSET = vec3(0.0);
float flipIfTrue(bool flag) {
return -(float(flag) * 2. - 1.);
}
vec3 getLineJoinOffset(
vec3 prevPoint, vec3 currPoint, vec3 nextPoint,
vec2 width
) {
bool isEnd = positions.x > 0.0;
float sideOfPath = positions.y;
float isJoint = float(sideOfPath == 0.0);
vec3 deltaA3 = (currPoint - prevPoint);
vec3 deltaB3 = (nextPoint - currPoint);
mat3 rotationMatrix;
bool needsRotation = !path.billboard && project_needs_rotation(currPoint, rotationMatrix);
if (needsRotation) {
deltaA3 = deltaA3 * rotationMatrix;
deltaB3 = deltaB3 * rotationMatrix;
}
vec2 deltaA = deltaA3.xy / width;
vec2 deltaB = deltaB3.xy / width;
float lenA = length(deltaA);
float lenB = length(deltaB);
vec2 dirA = lenA > 0. ? normalize(deltaA) : vec2(0.0, 0.0);
vec2 dirB = lenB > 0. ? normalize(deltaB) : vec2(0.0, 0.0);
vec2 perpA = vec2(-dirA.y, dirA.x);
vec2 perpB = vec2(-dirB.y, dirB.x);
vec2 tangent = dirA + dirB;
tangent = length(tangent) > 0. ? normalize(tangent) : perpA;
vec2 miterVec = vec2(-tangent.y, tangent.x);
vec2 dir = isEnd ? dirA : dirB;
vec2 perp = isEnd ? perpA : perpB;
float L = isEnd ? lenA : lenB;
float sinHalfA = abs(dot(miterVec, perp));
float cosHalfA = abs(dot(dirA, miterVec));
float turnDirection = flipIfTrue(dirA.x * dirB.y >= dirA.y * dirB.x);
float cornerPosition = sideOfPath * turnDirection;
float miterSize = 1.0 / max(sinHalfA, EPSILON);
miterSize = mix(
min(miterSize, max(lenA, lenB) / max(cosHalfA, EPSILON)),
miterSize,
step(0.0, cornerPosition)
);
vec2 offsetVec = mix(miterVec * miterSize, perp, step(0.5, cornerPosition))
* (sideOfPath + isJoint * turnDirection);
bool isStartCap = lenA == 0.0 || (!isEnd && (instanceTypes == 1.0 || instanceTypes == 3.0));
bool isEndCap = lenB == 0.0 || (isEnd && (instanceTypes == 2.0 || instanceTypes == 3.0));
bool isCap = isStartCap || isEndCap;
if (isCap) {
offsetVec = mix(perp * sideOfPath, dir * path.capType * 4.0 * flipIfTrue(isStartCap), isJoint);
vJointType = path.capType;
} else {
vJointType = path.jointType;
}
vPathLength = L;
vCornerOffset = offsetVec;
vMiterLength = dot(vCornerOffset, miterVec * turnDirection);
vMiterLength = isCap ? isJoint : vMiterLength;
vec2 offsetFromStartOfPath = vCornerOffset + deltaA * float(isEnd);
vPathPosition = vec2(
dot(offsetFromStartOfPath, perp),
dot(offsetFromStartOfPath, dir)
);
geometry.uv = vPathPosition;
float isValid = step(instanceTypes, 3.5);
vec3 offset = vec3(offsetVec * width * isValid, 0.0);
if (needsRotation) {
offset = rotationMatrix * offset;
}
return offset;
}
void clipLine(inout vec4 position, vec4 refPosition) {
if (position.w < EPSILON) {
float r = (EPSILON - refPosition.w) / (position.w - refPosition.w);
position = refPosition + (position - refPosition) * r;
}
}
void main() {
geometry.pickingColor = instancePickingColors;
vColor = vec4(instanceColors.rgb, instanceColors.a * layer.opacity);
float isEnd = positions.x;
vec3 prevPosition = mix(instanceLeftPositions, instanceStartPositions, isEnd);
vec3 prevPosition64Low = mix(instanceLeftPositions64Low, instanceStartPositions64Low, isEnd);
vec3 currPosition = mix(instanceStartPositions, instanceEndPositions, isEnd);
vec3 currPosition64Low = mix(instanceStartPositions64Low, instanceEndPositions64Low, isEnd);
vec3 nextPosition = mix(instanceEndPositions, instanceRightPositions, isEnd);
vec3 nextPosition64Low = mix(instanceEndPositions64Low, instanceRightPositions64Low, isEnd);
geometry.worldPosition = currPosition;
vec2 widthPixels = vec2(clamp(
project_size_to_pixel(instanceStrokeWidths * path.widthScale, path.widthUnits),
path.widthMinPixels, path.widthMaxPixels) / 2.0);
vec3 width;
if (path.billboard) {
vec4 prevPositionScreen = project_position_to_clipspace(prevPosition, prevPosition64Low, ZERO_OFFSET);
vec4 currPositionScreen = project_position_to_clipspace(currPosition, currPosition64Low, ZERO_OFFSET, geometry.position);
vec4 nextPositionScreen = project_position_to_clipspace(nextPosition, nextPosition64Low, ZERO_OFFSET);
clipLine(prevPositionScreen, currPositionScreen);
clipLine(nextPositionScreen, currPositionScreen);
clipLine(currPositionScreen, mix(nextPositionScreen, prevPositionScreen, isEnd));
width = vec3(widthPixels, 0.0);
DECKGL_FILTER_SIZE(width, geometry);
vec3 offset = getLineJoinOffset(
prevPositionScreen.xyz / prevPositionScreen.w,
currPositionScreen.xyz / currPositionScreen.w,
nextPositionScreen.xyz / nextPositionScreen.w,
project_pixel_size_to_clipspace(width.xy)
);
DECKGL_FILTER_GL_POSITION(currPositionScreen, geometry);
gl_Position = vec4(currPositionScreen.xyz + offset * currPositionScreen.w, currPositionScreen.w);
} else {
prevPosition = project_position(prevPosition, prevPosition64Low);
currPosition = project_position(currPosition, currPosition64Low);
nextPosition = project_position(nextPosition, nextPosition64Low);
width = vec3(project_pixel_size(widthPixels), 0.0);
DECKGL_FILTER_SIZE(width, geometry);
vec3 offset = getLineJoinOffset(prevPosition, currPosition, nextPosition, width.xy);
geometry.position = vec4(currPosition + offset, 1.0);
gl_Position = project_common_position_to_clipspace(geometry.position);
DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
}
DECKGL_FILTER_COLOR(vColor, geometry);
}
`,e4=`#version 300 es
#define SHADER_NAME path-layer-fragment-shader
precision highp float;
in vec4 vColor;
in vec2 vCornerOffset;
in float vMiterLength;
in vec2 vPathPosition;
in float vPathLength;
in float vJointType;
out vec4 fragColor;
void main(void) {
geometry.uv = vPathPosition;
if (vPathPosition.y < 0.0 || vPathPosition.y > vPathLength) {
if (vJointType > 0.5 && length(vCornerOffset) > 1.0) {
discard;
}
if (vJointType < 0.5 && vMiterLength > path.miterLimit + 1.0) {
discard;
}
}
fragColor = vColor;
DECKGL_FILTER_COLOR(fragColor, geometry);
}
`,G_=[0,0,0,255],t4={widthUnits:"meters",widthScale:{type:"number",min:0,value:1},widthMinPixels:{type:"number",min:0,value:0},widthMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},jointRounded:!1,capRounded:!1,miterLimit:{type:"number",min:0,value:4},billboard:!1,_pathType:null,getPath:{type:"accessor",value:n=>n.path},getColor:{type:"accessor",value:G_},getWidth:{type:"accessor",value:1},rounded:{deprecatedFor:["jointRounded","capRounded"]}},va={enter:(n,e)=>e.length?e.subarray(e.length-n.length):n};class hu extends ur{getShaders(){return super.getShaders({vs:JN,fs:e4,modules:[wo,To,QN]})}get wrapLongitude(){return!1}getBounds(){var e;return(e=this.getAttributeManager())==null?void 0:e.getBounds(["vertexPositions"])}initializeState(){this.getAttributeManager().addInstanced({vertexPositions:{size:3,vertexOffset:1,type:"float64",fp64:this.use64bitPositions(),transition:va,accessor:"getPath",update:this.calculatePositions,noAlloc:!0,shaderAttributes:{instanceLeftPositions:{vertexOffset:0},instanceStartPositions:{vertexOffset:1},instanceEndPositions:{vertexOffset:2},instanceRightPositions:{vertexOffset:3}}},instanceTypes:{size:1,type:"uint8",update:this.calculateSegmentTypes,noAlloc:!0},instanceStrokeWidths:{size:1,accessor:"getWidth",transition:va,defaultValue:1},instanceColors:{size:this.props.colorFormat.length,type:"unorm8",accessor:"getColor",transition:va,defaultValue:G_},instancePickingColors:{size:4,type:"uint8",accessor:(i,{index:r,target:s})=>this.encodePickingColor(i&&i.__source?i.__source.index:r,s)}}),this.setState({pathTesselator:new GN({fp64:this.use64bitPositions()})})}updateState(e){var o;super.updateState(e);const{props:t,changeFlags:i}=e,r=this.getAttributeManager();if(i.dataChanged||i.updateTriggersChanged&&(i.updateTriggersChanged.all||i.updateTriggersChanged.getPath)){const{pathTesselator:a}=this.state,l=t.data.attributes||{};a.updateGeometry({data:t.data,geometryBuffer:l.getPath,buffers:l,normalize:!t._pathType,loop:t._pathType==="loop",getGeometry:t.getPath,positionFormat:t.positionFormat,wrapLongitude:t.wrapLongitude,resolution:this.context.viewport.resolution,dataChanged:i.dataChanged}),this.setState({numInstances:a.instanceCount,startIndices:a.vertexStarts}),i.dataChanged||r.invalidateAll()}i.extensionsChanged&&((o=this.state.model)==null||o.destroy(),this.state.model=this._getModel(),r.invalidateAll())}getPickingInfo(e){const t=super.getPickingInfo(e),{index:i}=t,r=this.props.data;return r[0]&&r[0].__source&&(t.object=r.find(s=>s.__source.index===i)),t}disablePickingIndex(e){const t=this.props.data;if(t[0]&&t[0].__source)for(let i=0;i<t.length;i++)t[i].__source.index===e&&this._disablePickingIndex(i);else super.disablePickingIndex(e)}draw({uniforms:e}){const{jointRounded:t,capRounded:i,billboard:r,miterLimit:s,widthUnits:o,widthScale:a,widthMinPixels:l,widthMaxPixels:c}=this.props,u=this.state.model,d={jointType:Number(t),capType:Number(i),billboard:r,widthUnits:Ot[o],widthScale:a,miterLimit:s,widthMinPixels:l,widthMaxPixels:c};u.shaderInputs.setProps({path:d}),u.draw(this.context.renderPass)}_getModel(){const e=[0,1,2,1,4,2,1,3,4,3,5,4],t=[0,0,0,-1,0,1,1,-1,1,1,1,0];return new Qt(this.context.device,{...this.getShaders(),id:this.props.id,bufferLayout:this.getAttributeManager().getBufferLayouts(),geometry:new Co({topology:"triangle-list",attributes:{indices:new Uint16Array(e),positions:{value:new Float32Array(t),size:2}}}),isInstanced:!0})}calculatePositions(e){const{pathTesselator:t}=this.state;e.startIndices=t.vertexStarts,e.value=t.get("positions")}calculateSegmentTypes(e){const{pathTesselator:t}=this.state;e.startIndices=t.vertexStarts,e.value=t.get("segmentTypes")}}hu.defaultProps=t4;hu.layerName="PathLayer";const Ei=hu,Ef=`uniform sdfUniforms {
  float gamma;
  bool enabled;
  float buffer;
  float outlineBuffer;
  vec4 outlineColor;
} sdf;
`,n4={name:"sdf",vs:Ef,fs:Ef,uniformTypes:{gamma:"f32",enabled:"f32",buffer:"f32",outlineBuffer:"f32",outlineColor:"vec4<f32>"}},i4=`#version 300 es
#define SHADER_NAME multi-icon-layer-fragment-shader
precision highp float;
uniform sampler2D iconsTexture;
in vec4 vColor;
in vec2 vTextureCoords;
in vec2 uv;
out vec4 fragColor;
void main(void) {
geometry.uv = uv;
if (!bool(picking.isActive)) {
float alpha = texture(iconsTexture, vTextureCoords).a;
vec4 color = vColor;
if (sdf.enabled) {
float distance = alpha;
alpha = smoothstep(sdf.buffer - sdf.gamma, sdf.buffer + sdf.gamma, distance);
if (sdf.outlineBuffer > 0.0) {
float inFill = alpha;
float inBorder = smoothstep(sdf.outlineBuffer - sdf.gamma, sdf.outlineBuffer + sdf.gamma, distance);
color = mix(sdf.outlineColor, vColor, inFill);
alpha = inBorder;
}
}
float a = alpha * color.a;
if (a < icon.alphaCutoff) {
discard;
}
fragColor = vec4(color.rgb, a * layer.opacity);
}
DECKGL_FILTER_COLOR(fragColor, geometry);
}
`,xa=192/256,Af=[],r4={getIconOffsets:{type:"accessor",value:n=>n.offsets},alphaCutoff:.001,smoothing:.1,outlineWidth:0,outlineColor:{type:"color",value:[0,0,0,255]}};class fu extends NN{getShaders(){const e=super.getShaders();return{...e,modules:[...e.modules,n4],fs:i4}}initializeState(){super.initializeState(),this.getAttributeManager().addInstanced({instanceOffsets:{size:2,accessor:"getIconOffsets"},instancePickingColors:{type:"uint8",size:3,accessor:(t,{index:i,target:r})=>this.encodePickingColor(i,r)}})}updateState(e){super.updateState(e);const{props:t,oldProps:i}=e;let{outlineColor:r}=t;r!==i.outlineColor&&(r=r.map(s=>s/255),r[3]=Number.isFinite(r[3])?r[3]:1,this.setState({outlineColor:r})),!t.sdf&&t.outlineWidth&&Q.warn(`${this.id}: fontSettings.sdf is required to render outline`)()}draw(e){const{sdf:t,smoothing:i,outlineWidth:r}=this.props,{outlineColor:s}=this.state,o=r?Math.max(i,xa*(1-r)):-1,a=this.state.model,l={buffer:xa,outlineBuffer:o,gamma:i,enabled:!!t,outlineColor:s};if(a.shaderInputs.setProps({sdf:l}),super.draw(e),t&&r){const{iconManager:c}=this.state;c.getTexture()&&(a.shaderInputs.setProps({sdf:{...l,outlineBuffer:xa}}),a.draw(this.context.renderPass))}}getInstanceOffset(e){return e?Array.from(e).flatMap(t=>super.getInstanceOffset(t)):Af}getInstanceColorMode(e){return 1}getInstanceIconFrame(e){return e?Array.from(e).flatMap(t=>super.getInstanceIconFrame(t)):Af}}fu.defaultProps=r4;fu.layerName="MultiIconLayer";const s4=fu,Di=1e20;class o4{constructor({fontSize:e=24,buffer:t=3,radius:i=8,cutoff:r=.25,fontFamily:s="sans-serif",fontWeight:o="normal",fontStyle:a="normal",lang:l=null}={}){this.buffer=t,this.cutoff=r,this.radius=i,this.lang=l;const c=this.size=e+t*4,u=this._createCanvas(c),d=this.ctx=u.getContext("2d",{willReadFrequently:!0});d.font=`${a} ${o} ${e}px ${s}`,d.textBaseline="alphabetic",d.textAlign="left",d.fillStyle="black",this.gridOuter=new Float64Array(c*c),this.gridInner=new Float64Array(c*c),this.f=new Float64Array(c),this.z=new Float64Array(c+1),this.v=new Uint16Array(c)}_createCanvas(e){const t=document.createElement("canvas");return t.width=t.height=e,t}draw(e){const{width:t,actualBoundingBoxAscent:i,actualBoundingBoxDescent:r,actualBoundingBoxLeft:s,actualBoundingBoxRight:o}=this.ctx.measureText(e),a=Math.ceil(i),l=0,c=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(o-s))),u=Math.min(this.size-this.buffer,a+Math.ceil(r)),d=c+2*this.buffer,h=u+2*this.buffer,f=Math.max(d*h,0),p=new Uint8ClampedArray(f),g={data:p,width:d,height:h,glyphWidth:c,glyphHeight:u,glyphTop:a,glyphLeft:l,glyphAdvance:t};if(c===0||u===0)return g;const{ctx:_,buffer:b,gridInner:w,gridOuter:x}=this;this.lang&&(_.lang=this.lang),_.clearRect(b,b,c,u),_.fillText(e,b,b+a);const y=_.getImageData(b,b,c,u);x.fill(Di,0,f),w.fill(0,0,f);for(let S=0;S<u;S++)for(let I=0;I<c;I++){const F=y.data[4*(S*c+I)+3]/255;if(F===0)continue;const D=(S+b)*d+I+b;if(F===1)x[D]=0,w[D]=Di;else{const B=.5-F;x[D]=B>0?B*B:0,w[D]=B<0?B*B:0}}Cf(x,0,0,d,h,d,this.f,this.v,this.z),Cf(w,b,b,c,u,d,this.f,this.v,this.z);for(let S=0;S<f;S++){const I=Math.sqrt(x[S])-Math.sqrt(w[S]);p[S]=Math.round(255-255*(I/this.radius+this.cutoff))}return g}}function Cf(n,e,t,i,r,s,o,a,l){for(let c=e;c<e+i;c++)If(n,t*s+c,s,r,o,a,l);for(let c=t;c<t+r;c++)If(n,c*s+e,1,i,o,a,l)}function If(n,e,t,i,r,s,o){s[0]=0,o[0]=-Di,o[1]=Di,r[0]=n[e];for(let a=1,l=0,c=0;a<i;a++){r[a]=n[e+a*t];const u=a*a;do{const d=s[l];c=(r[a]-r[d]+u-d*d)/(a-d)/2}while(c<=o[l]&&--l>-1);l++,s[l]=a,o[l]=c,o[l+1]=Di}for(let a=0,l=0;a<i;a++){for(;o[l+1]<a;)l++;const c=s[l],u=a-c;n[e+a*t]=r[c]+u*u}}const a4=32,l4=[];function c4(n){return Math.pow(2,Math.ceil(Math.log2(n)))}function u4({characterSet:n,getFontWidth:e,fontHeight:t,buffer:i,maxCanvasWidth:r,mapping:s={},xOffset:o=0,yOffset:a=0}){let l=0,c=o;const u=t+i*2;for(const d of n)if(!s[d]){const h=e(d);c+h+i*2>r&&(c=0,l++),s[d]={x:c+i,y:a+l*u+i,width:h,height:u,layoutWidth:h,layoutHeight:t},c+=h+i*2}return{mapping:s,xOffset:c,yOffset:a+l*u,canvasHeight:c4(a+(l+1)*u)}}function Q_(n,e,t,i){var s;let r=0;for(let o=e;o<t;o++){const a=n[o];r+=((s=i[a])==null?void 0:s.layoutWidth)||0}return r}function J_(n,e,t,i,r,s){let o=e,a=0;for(let l=e;l<t;l++){const c=Q_(n,l,l+1,r);a+c>i&&(o<l&&s.push(l),o=l,a=0),a+=c}return a}function d4(n,e,t,i,r,s){let o=e,a=e,l=e,c=0;for(let u=e;u<t;u++)if((n[u]===" "||n[u+1]===" "||u+1===t)&&(l=u+1),l>a){let d=Q_(n,a,l,r);c+d>i&&(o<a&&(s.push(a),o=a,c=0),d>i&&(d=J_(n,a,l,i,r,s),o=s[s.length-1])),a=l,c+=d}return c}function h4(n,e,t,i,r=0,s){s===void 0&&(s=n.length);const o=[];return e==="break-all"?J_(n,r,s,t,i,o):d4(n,r,s,t,i,o),o}function f4(n,e,t,i,r,s){let o=0,a=0;for(let l=e;l<t;l++){const c=n[l],u=i[c];u?(a||(a=u.layoutHeight),r[l]=o+u.layoutWidth/2,o+=u.layoutWidth):(Q.warn(`Missing character: ${c} (${c.codePointAt(0)})`)(),r[l]=o,o+=a4)}s[0]=o,s[1]=a}function p4(n,e,t,i,r){var _;const s=Array.from(n),o=s.length,a=new Array(o),l=new Array(o),c=new Array(o),u=(t==="break-word"||t==="break-all")&&isFinite(i)&&i>0,d=[0,0],h=[0,0];let f=0,p=0,g=0;for(let b=0;b<=o;b++){const w=s[b];if((w===`
`||b===o)&&(g=b),g>p){const x=u?h4(s,t,i,r,p,g):l4;for(let y=0;y<=x.length;y++){const S=y===0?p:x[y-1],I=y<x.length?x[y]:g;f4(s,S,I,r,a,h);for(let F=S;F<I;F++){a[F]-h[0]/2;const D=s[F],B=((_=r[D])==null?void 0:_.layoutOffsetY)||0;l[F]=f+h[1]/2+B,c[F]=h[0]}f=f+h[1]*e,d[0]=Math.max(d[0],h[0])}p=g}w===`
`&&(a[p]=0,l[p]=0,c[p]=0,p++)}return d[1]=f,{x:a,y:l,rowWidth:c,size:d}}function g4({value:n,length:e,stride:t,offset:i,startIndices:r,characterSet:s}){const o=n.BYTES_PER_ELEMENT,a=t?t/o:1,l=i?i/o:0,c=r[e]||Math.ceil((n.length-l)/a),u=s&&new Set,d=new Array(e);let h=n;if(a>1||l>0){const f=n.constructor;h=new f(c);for(let p=0;p<c;p++)h[p]=n[p*a+l]}for(let f=0;f<e;f++){const p=r[f],g=r[f+1]||c,_=h.subarray(p,g);d[f]=String.fromCodePoint.apply(null,_),u&&_.forEach(u.add,u)}if(u)for(const f of u)s.add(String.fromCodePoint(f));return{texts:d,characterCount:c}}class ey{constructor(e=5){this._cache={},this._order=[],this.limit=e}get(e){const t=this._cache[e];return t&&(this._deleteOrder(e),this._appendOrder(e)),t}set(e,t){this._cache[e]?(this.delete(e),this._cache[e]=t,this._appendOrder(e)):(Object.keys(this._cache).length===this.limit&&this.delete(this._order[0]),this._cache[e]=t,this._appendOrder(e))}delete(e){this._cache[e]&&(delete this._cache[e],this._deleteOrder(e))}_deleteOrder(e){const t=this._order.indexOf(e);t>=0&&this._order.splice(t,1)}_appendOrder(e){this._order.push(e)}}function m4(){const n=[];for(let e=32;e<128;e++)n.push(String.fromCharCode(e));return n}const qn={fontFamily:"Monaco, monospace",fontWeight:"normal",characterSet:m4(),fontSize:64,buffer:4,sdf:!1,cutoff:.25,radius:12,smoothing:.1},Rf=1024,Pf=.9,Mf=1.2,ty=3;let qs=new ey(ty);function _4(n,e){let t;typeof e=="string"?t=new Set(Array.from(e)):t=new Set(e);const i=qs.get(n);if(!i)return t;for(const r in i.mapping)t.has(r)&&t.delete(r);return t}function y4(n,e){for(let t=0;t<n.length;t++)e.data[4*t+3]=n[t]}function kf(n,e,t,i){n.font=`${i} ${t}px ${e}`,n.fillStyle="#000",n.textBaseline="alphabetic",n.textAlign="left"}function b4(n){Q.assert(Number.isFinite(n)&&n>=ty,"Invalid cache limit"),qs=new ey(n)}class v4{constructor(){this.props={...qn}}get atlas(){return this._atlas}get mapping(){return this._atlas&&this._atlas.mapping}get scale(){const{fontSize:e,buffer:t}=this.props;return(e*Mf+t*2)/e}setProps(e={}){Object.assign(this.props,e),this._key=this._getKey();const t=_4(this._key,this.props.characterSet),i=qs.get(this._key);if(i&&t.size===0){this._atlas!==i&&(this._atlas=i);return}const r=this._generateFontAtlas(t,i);this._atlas=r,qs.set(this._key,r)}_generateFontAtlas(e,t){const{fontFamily:i,fontWeight:r,fontSize:s,buffer:o,sdf:a,radius:l,cutoff:c}=this.props;let u=t&&t.data;u||(u=document.createElement("canvas"),u.width=Rf);const d=u.getContext("2d",{willReadFrequently:!0});kf(d,i,s,r);const{mapping:h,canvasHeight:f,xOffset:p,yOffset:g}=u4({getFontWidth:_=>d.measureText(_).width,fontHeight:s*Mf,buffer:o,characterSet:e,maxCanvasWidth:Rf,...t&&{mapping:t.mapping,xOffset:t.xOffset,yOffset:t.yOffset}});if(u.height!==f){const _=d.getImageData(0,0,u.width,u.height);u.height=f,d.putImageData(_,0,0)}if(kf(d,i,s,r),a){const _=new o4({fontSize:s,buffer:o,radius:l,cutoff:c,fontFamily:i,fontWeight:`${r}`});for(const b of e){const{data:w,width:x,height:y,glyphTop:S}=_.draw(b);h[b].width=x,h[b].layoutOffsetY=s*Pf-S;const I=d.createImageData(x,y);y4(w,I),d.putImageData(I,h[b].x,h[b].y)}}else for(const _ of e)d.fillText(_,h[_].x,h[_].y+o+s*Pf);return{xOffset:p,yOffset:g,mapping:h,data:u,width:u.width,height:u.height}}_getKey(){const{fontFamily:e,fontWeight:t,fontSize:i,buffer:r,sdf:s,radius:o,cutoff:a}=this.props;return s?`${e} ${t} ${i} ${r} ${o} ${a}`:`${e} ${t} ${i} ${r}`}}const Of=`uniform textBackgroundUniforms {
  bool billboard;
  float sizeScale;
  float sizeMinPixels;
  float sizeMaxPixels;
  vec4 borderRadius;
  vec4 padding;
  highp int sizeUnits;
  bool stroked;
} textBackground;
`,x4={name:"textBackground",vs:Of,fs:Of,uniformTypes:{billboard:"f32",sizeScale:"f32",sizeMinPixels:"f32",sizeMaxPixels:"f32",borderRadius:"vec4<f32>",padding:"vec4<f32>",sizeUnits:"i32",stroked:"f32"}},w4=`#version 300 es
#define SHADER_NAME text-background-layer-vertex-shader
in vec2 positions;
in vec3 instancePositions;
in vec3 instancePositions64Low;
in vec4 instanceRects;
in float instanceSizes;
in float instanceAngles;
in vec2 instancePixelOffsets;
in float instanceLineWidths;
in vec4 instanceFillColors;
in vec4 instanceLineColors;
in vec3 instancePickingColors;
out vec4 vFillColor;
out vec4 vLineColor;
out float vLineWidth;
out vec2 uv;
out vec2 dimensions;
vec2 rotate_by_angle(vec2 vertex, float angle) {
float angle_radian = radians(angle);
float cos_angle = cos(angle_radian);
float sin_angle = sin(angle_radian);
mat2 rotationMatrix = mat2(cos_angle, -sin_angle, sin_angle, cos_angle);
return rotationMatrix * vertex;
}
void main(void) {
geometry.worldPosition = instancePositions;
geometry.uv = positions;
geometry.pickingColor = instancePickingColors;
uv = positions;
vLineWidth = instanceLineWidths;
float sizePixels = clamp(
project_size_to_pixel(instanceSizes * textBackground.sizeScale, textBackground.sizeUnits),
textBackground.sizeMinPixels, textBackground.sizeMaxPixels
);
dimensions = instanceRects.zw * sizePixels + textBackground.padding.xy + textBackground.padding.zw;
vec2 pixelOffset = (positions * instanceRects.zw + instanceRects.xy) * sizePixels + mix(-textBackground.padding.xy, textBackground.padding.zw, positions);
pixelOffset = rotate_by_angle(pixelOffset, instanceAngles);
pixelOffset += instancePixelOffsets;
pixelOffset.y *= -1.0;
if (textBackground.billboard)  {
gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, vec3(0.0), geometry.position);
DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
vec3 offset = vec3(pixelOffset, 0.0);
DECKGL_FILTER_SIZE(offset, geometry);
gl_Position.xy += project_pixel_size_to_clipspace(offset.xy);
} else {
vec3 offset_common = vec3(project_pixel_size(pixelOffset), 0.0);
DECKGL_FILTER_SIZE(offset_common, geometry);
gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, offset_common, geometry.position);
DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
}
vFillColor = vec4(instanceFillColors.rgb, instanceFillColors.a * layer.opacity);
DECKGL_FILTER_COLOR(vFillColor, geometry);
vLineColor = vec4(instanceLineColors.rgb, instanceLineColors.a * layer.opacity);
DECKGL_FILTER_COLOR(vLineColor, geometry);
}
`,T4=`#version 300 es
#define SHADER_NAME text-background-layer-fragment-shader
precision highp float;
in vec4 vFillColor;
in vec4 vLineColor;
in float vLineWidth;
in vec2 uv;
in vec2 dimensions;
out vec4 fragColor;
float round_rect(vec2 p, vec2 size, vec4 radii) {
vec2 pixelPositionCB = (p - 0.5) * size;
vec2 sizeCB = size * 0.5;
float maxBorderRadius = min(size.x, size.y) * 0.5;
vec4 borderRadius = vec4(min(radii, maxBorderRadius));
borderRadius.xy =
(pixelPositionCB.x > 0.0) ? borderRadius.xy : borderRadius.zw;
borderRadius.x = (pixelPositionCB.y > 0.0) ? borderRadius.x : borderRadius.y;
vec2 q = abs(pixelPositionCB) - sizeCB + borderRadius.x;
return -(min(max(q.x, q.y), 0.0) + length(max(q, 0.0)) - borderRadius.x);
}
float rect(vec2 p, vec2 size) {
vec2 pixelPosition = p * size;
return min(min(pixelPosition.x, size.x - pixelPosition.x),
min(pixelPosition.y, size.y - pixelPosition.y));
}
vec4 get_stroked_fragColor(float dist) {
float isBorder = smoothedge(dist, vLineWidth);
return mix(vFillColor, vLineColor, isBorder);
}
void main(void) {
geometry.uv = uv;
if (textBackground.borderRadius != vec4(0.0)) {
float distToEdge = round_rect(uv, dimensions, textBackground.borderRadius);
if (textBackground.stroked) {
fragColor = get_stroked_fragColor(distToEdge);
} else {
fragColor = vFillColor;
}
float shapeAlpha = smoothedge(-distToEdge, 0.0);
fragColor.a *= shapeAlpha;
} else {
if (textBackground.stroked) {
float distToEdge = rect(uv, dimensions);
fragColor = get_stroked_fragColor(distToEdge);
} else {
fragColor = vFillColor;
}
}
DECKGL_FILTER_COLOR(fragColor, geometry);
}
`,S4={billboard:!0,sizeScale:1,sizeUnits:"pixels",sizeMinPixels:0,sizeMaxPixels:Number.MAX_SAFE_INTEGER,borderRadius:{type:"object",value:0},padding:{type:"array",value:[0,0,0,0]},getPosition:{type:"accessor",value:n=>n.position},getSize:{type:"accessor",value:1},getAngle:{type:"accessor",value:0},getPixelOffset:{type:"accessor",value:[0,0]},getBoundingRect:{type:"accessor",value:[0,0,0,0]},getFillColor:{type:"accessor",value:[0,0,0,255]},getLineColor:{type:"accessor",value:[0,0,0,255]},getLineWidth:{type:"accessor",value:1}};class pu extends ur{getShaders(){return super.getShaders({vs:w4,fs:T4,modules:[wo,To,x4]})}initializeState(){this.getAttributeManager().addInstanced({instancePositions:{size:3,type:"float64",fp64:this.use64bitPositions(),transition:!0,accessor:"getPosition"},instanceSizes:{size:1,transition:!0,accessor:"getSize",defaultValue:1},instanceAngles:{size:1,transition:!0,accessor:"getAngle"},instanceRects:{size:4,accessor:"getBoundingRect"},instancePixelOffsets:{size:2,transition:!0,accessor:"getPixelOffset"},instanceFillColors:{size:4,transition:!0,type:"unorm8",accessor:"getFillColor",defaultValue:[0,0,0,255]},instanceLineColors:{size:4,transition:!0,type:"unorm8",accessor:"getLineColor",defaultValue:[0,0,0,255]},instanceLineWidths:{size:1,transition:!0,accessor:"getLineWidth",defaultValue:1}})}updateState(e){var i;super.updateState(e);const{changeFlags:t}=e;t.extensionsChanged&&((i=this.state.model)==null||i.destroy(),this.state.model=this._getModel(),this.getAttributeManager().invalidateAll())}draw({uniforms:e}){const{billboard:t,sizeScale:i,sizeUnits:r,sizeMinPixels:s,sizeMaxPixels:o,getLineWidth:a}=this.props;let{padding:l,borderRadius:c}=this.props;l.length<4&&(l=[l[0],l[1],l[0],l[1]]),Array.isArray(c)||(c=[c,c,c,c]);const u=this.state.model,d={billboard:t,stroked:!!a,borderRadius:c,padding:l,sizeUnits:Ot[r],sizeScale:i,sizeMinPixels:s,sizeMaxPixels:o};u.shaderInputs.setProps({textBackground:d}),u.draw(this.context.renderPass)}_getModel(){const e=[0,0,1,0,0,1,1,1];return new Qt(this.context.device,{...this.getShaders(),id:this.props.id,bufferLayout:this.getAttributeManager().getBufferLayouts(),geometry:new Co({topology:"triangle-strip",vertexCount:4,attributes:{positions:{size:2,value:new Float32Array(e)}}}),isInstanced:!0})}}pu.defaultProps=S4;pu.layerName="TextBackgroundLayer";const E4=pu,Nf={start:1,middle:0,end:-1},Ff={top:1,center:0,bottom:-1},wa=[0,0,0,255],A4=1,C4={billboard:!0,sizeScale:1,sizeUnits:"pixels",sizeMinPixels:0,sizeMaxPixels:Number.MAX_SAFE_INTEGER,background:!1,getBackgroundColor:{type:"accessor",value:[255,255,255,255]},getBorderColor:{type:"accessor",value:wa},getBorderWidth:{type:"accessor",value:0},backgroundBorderRadius:{type:"object",value:0},backgroundPadding:{type:"array",value:[0,0,0,0]},characterSet:{type:"object",value:qn.characterSet},fontFamily:qn.fontFamily,fontWeight:qn.fontWeight,lineHeight:A4,outlineWidth:{type:"number",value:0,min:0},outlineColor:{type:"color",value:wa},fontSettings:{type:"object",value:{},compare:1},wordBreak:"break-word",maxWidth:{type:"number",value:-1},getText:{type:"accessor",value:n=>n.text},getPosition:{type:"accessor",value:n=>n.position},getColor:{type:"accessor",value:wa},getSize:{type:"accessor",value:32},getAngle:{type:"accessor",value:0},getTextAnchor:{type:"accessor",value:"middle"},getAlignmentBaseline:{type:"accessor",value:"center"},getPixelOffset:{type:"accessor",value:[0,0]},backgroundColor:{deprecatedFor:["background","getBackgroundColor"]}};class gu extends sN{constructor(){super(...arguments),this.getBoundingRect=(e,t)=>{let{size:[i,r]}=this.transformParagraph(e,t);const{fontSize:s}=this.state.fontAtlasManager.props;i/=s,r/=s;const{getTextAnchor:o,getAlignmentBaseline:a}=this.props,l=Nf[typeof o=="function"?o(e,t):o],c=Ff[typeof a=="function"?a(e,t):a];return[(l-1)*i/2,(c-1)*r/2,i,r]},this.getIconOffsets=(e,t)=>{const{getTextAnchor:i,getAlignmentBaseline:r}=this.props,{x:s,y:o,rowWidth:a,size:[l,c]}=this.transformParagraph(e,t),u=Nf[typeof i=="function"?i(e,t):i],d=Ff[typeof r=="function"?r(e,t):r],h=s.length,f=new Array(h*2);let p=0;for(let g=0;g<h;g++){const _=(1-u)*(l-a[g])/2;f[p++]=(u-1)*l/2+_+s[g],f[p++]=(d-1)*c/2+o[g]}return f}}initializeState(){this.state={styleVersion:0,fontAtlasManager:new v4},this.props.maxWidth>0&&Q.once(1,"v8.9 breaking change: TextLayer maxWidth is now relative to text size")()}updateState(e){const{props:t,oldProps:i,changeFlags:r}=e;(r.dataChanged||r.updateTriggersChanged&&(r.updateTriggersChanged.all||r.updateTriggersChanged.getText))&&this._updateText(),(this._updateFontAtlas()||t.lineHeight!==i.lineHeight||t.wordBreak!==i.wordBreak||t.maxWidth!==i.maxWidth)&&this.setState({styleVersion:this.state.styleVersion+1})}getPickingInfo({info:e}){return e.object=e.index>=0?this.props.data[e.index]:null,e}_updateFontAtlas(){const{fontSettings:e,fontFamily:t,fontWeight:i}=this.props,{fontAtlasManager:r,characterSet:s}=this.state,o={...e,characterSet:s,fontFamily:t,fontWeight:i};if(!r.mapping)return r.setProps(o),!0;for(const a in o)if(o[a]!==r.props[a])return r.setProps(o),!0;return!1}_updateText(){var l;const{data:e,characterSet:t}=this.props,i=(l=e.attributes)==null?void 0:l.getText;let{getText:r}=this.props,s=e.startIndices,o;const a=t==="auto"&&new Set;if(i&&s){const{texts:c,characterCount:u}=g4({...ArrayBuffer.isView(i)?{value:i}:i,length:e.length,startIndices:s,characterSet:a});o=u,r=(d,{index:h})=>c[h]}else{const{iterable:c,objectInfo:u}=Ro(e);s=[0],o=0;for(const d of c){u.index++;const h=Array.from(r(d,u)||"");a&&h.forEach(a.add,a),o+=h.length,s.push(o)}}this.setState({getText:r,startIndices:s,numInstances:o,characterSet:a||t})}transformParagraph(e,t){const{fontAtlasManager:i}=this.state,r=i.mapping,s=this.state.getText,{wordBreak:o,lineHeight:a,maxWidth:l}=this.props,c=s(e,t)||"";return p4(c,a,o,l*i.props.fontSize,r)}renderLayers(){const{startIndices:e,numInstances:t,getText:i,fontAtlasManager:{scale:r,atlas:s,mapping:o},styleVersion:a}=this.state,{data:l,_dataDiff:c,getPosition:u,getColor:d,getSize:h,getAngle:f,getPixelOffset:p,getBackgroundColor:g,getBorderColor:_,getBorderWidth:b,backgroundBorderRadius:w,backgroundPadding:x,background:y,billboard:S,fontSettings:I,outlineWidth:F,outlineColor:D,sizeScale:B,sizeUnits:U,sizeMinPixels:O,sizeMaxPixels:H,transitions:$,updateTriggers:z}=this.props,te=this.getSubLayerClass("characters",s4),de=this.getSubLayerClass("background",E4);return[y&&new de({getFillColor:g,getLineColor:_,getLineWidth:b,borderRadius:w,padding:x,getPosition:u,getSize:h,getAngle:f,getPixelOffset:p,billboard:S,sizeScale:B,sizeUnits:U,sizeMinPixels:O,sizeMaxPixels:H,transitions:$&&{getPosition:$.getPosition,getAngle:$.getAngle,getSize:$.getSize,getFillColor:$.getBackgroundColor,getLineColor:$.getBorderColor,getLineWidth:$.getBorderWidth,getPixelOffset:$.getPixelOffset}},this.getSubLayerProps({id:"background",updateTriggers:{getPosition:z.getPosition,getAngle:z.getAngle,getSize:z.getSize,getFillColor:z.getBackgroundColor,getLineColor:z.getBorderColor,getLineWidth:z.getBorderWidth,getPixelOffset:z.getPixelOffset,getBoundingRect:{getText:z.getText,getTextAnchor:z.getTextAnchor,getAlignmentBaseline:z.getAlignmentBaseline,styleVersion:a}}}),{data:l.attributes&&l.attributes.background?{length:l.length,attributes:l.attributes.background}:l,_dataDiff:c,autoHighlight:!1,getBoundingRect:this.getBoundingRect}),new te({sdf:I.sdf,smoothing:Number.isFinite(I.smoothing)?I.smoothing:qn.smoothing,outlineWidth:F/(I.radius||qn.radius),outlineColor:D,iconAtlas:s,iconMapping:o,getPosition:u,getColor:d,getSize:h,getAngle:f,getPixelOffset:p,billboard:S,sizeScale:B*r,sizeUnits:U,sizeMinPixels:O*r,sizeMaxPixels:H*r,transitions:$&&{getPosition:$.getPosition,getAngle:$.getAngle,getColor:$.getColor,getSize:$.getSize,getPixelOffset:$.getPixelOffset}},this.getSubLayerProps({id:"characters",updateTriggers:{all:z.getText,getPosition:z.getPosition,getAngle:z.getAngle,getColor:z.getColor,getSize:z.getSize,getPixelOffset:z.getPixelOffset,getIconOffsets:{getTextAnchor:z.getTextAnchor,getAlignmentBaseline:z.getAlignmentBaseline,styleVersion:a}}}),{data:l,_dataDiff:c,startIndices:e,numInstances:t,getIconOffsets:this.getIconOffsets,getIcon:i})]}static set fontAtlasCacheLimit(e){b4(e)}}gu.defaultProps=C4;gu.layerName="TextLayer";const I4=gu;function dr(n,e,t,i,r={}){const s={id:n,data:e,getPath:o=>o.path,widthMinPixels:i,coordinateSystem:Z.CARTESIAN,parameters:{depthTest:!1},...r};return s.getColor=Array.isArray(t)?t:o=>o.color,new Ei(s)}function mu(n,e,t={}){return new X_({id:n,data:e,coordinateSystem:Z.CARTESIAN,parameters:{depthTest:!1},...t})}function R4(n,e){return mu("anchor-layer",n,{getPosition:t=>t.position,getFillColor:t=>t.fillColor,getLineColor:t=>t.borderColor,stroked:!0,filled:!0,getRadius:t=>t.radius,lineWidthMinPixels:e,radiusUnits:"pixels"})}function P4(n,e){return dr("connection-layer",n,null,e,{capRounded:!0,jointRounded:!0})}function M4(n,e){return mu("anchor-hover-layer",n,{getPosition:t=>t.position,getFillColor:t=>t.fillColor,getLineColor:[e[0],e[1],e[2],160],stroked:!0,filled:!0,getRadius:t=>t.radius+1,lineWidthMinPixels:2,radiusUnits:"pixels"})}function k4(n,e,t){return dr("connection-hover-layer",n,[e[0],e[1],e[2],160],t,{capRounded:!0,jointRounded:!0})}function O4(n,e){return mu("anchor-selection-layer",n,{getPosition:t=>t.position,getFillColor:t=>t.fillColor,getLineColor:[e.connectionSelectionRGB[0],e.connectionSelectionRGB[1],e.connectionSelectionRGB[2],230],stroked:!0,filled:!0,getRadius:t=>t.radius+1,lineWidthMinPixels:2,radiusUnits:"pixels"})}function N4(n,e){return dr("separator-layer",n,[e.separatorRGB[0],e.separatorRGB[1],e.separatorRGB[2],120],e.separatorWidth)}function F4(n,e){return dr("connection-selection-layer",n,[e.connectionSelectionRGB[0],e.connectionSelectionRGB[1],e.connectionSelectionRGB[2],230],e.connectionSelectionWidth,{capRounded:!0,jointRounded:!0})}function rn(n,e){try{const t=n||document.documentElement,r=window.getComputedStyle(t).getPropertyValue(e).trim();return r?D4(r):null}catch{return null}}function At(n,e,t){try{const i=n||document.documentElement,r=window.getComputedStyle(i),s=parseFloat(r.getPropertyValue(e));return Number.isFinite(s)?s:t}catch{return t}}function D4(n){if(!n)return null;const e=n.match(/rgba?\(([^)]+)\)/i);if(e){const i=e[1].trim(),r=i.includes(",")?i.split(",").map(l=>l.trim()):i.split(/\s+/),s=parseInt(r[0],10)||0,o=parseInt(r[1],10)||0,a=parseInt(r[2],10)||0;return[s,o,a]}const t=n.match(/^#([0-9a-f]{6})$/i);if(t){const i=t[1],r=parseInt(i.slice(0,2),16),s=parseInt(i.slice(2,4),16),o=parseInt(i.slice(4,6),16);return[r,s,o]}return null}function Df(n){return{connectionWidth:At(n,"--timeline-connection-width",4),connectionHoverWidth:At(n,"--timeline-connection-hover-width",5),connectionSelectionWidth:At(n,"--timeline-connection-selection-width",6),connectionSelectionRGB:rn(n,"--timeline-connection-selection-color")||[64,128,255],connectionHoverRGB:rn(n,"--timeline-connection-hover-color")||[64,128,255],connectionNeutralRGB:rn(n,"--timeline-connection-color-neutral")||[160,160,160],anchorStrokeWidth:At(n,"--timeline-anchor-stroke-width",3),anchorFillRGB:rn(n,"--timeline-anchor-fill-color")||[60,60,80],anchorStrokeRGB:rn(n,"--timeline-anchor-stroke-color")||[255,255,255],anchorRadiusVar:At(n,"--timeline-anchor-radius",NaN),separatorRGB:rn(n,"--timeline-separator-color")||[190,195,210],separatorWidth:At(n,"--timeline-separator-width",2),scrubberCoreRGB:rn(n,"--timeline-scrubber-core-color")||[255,255,255],gapDefault:At(n,"--timeline-gap-default",6),paddingX:At(n,"--timeline-padding-x",0),paddingY:At(n,"--timeline-padding-y",0)}}function Ks(n,e,t,i){return(n-e)/Math.max(1,t-e)*i}function B4(n,e,t,i){const r=n/Math.max(1,i);return e+r*(t-e)}function L4(n,e,t){const i=Math.max(1,e-n),s=Math.max(1,t)/i;return Math.max(.5,Math.min(1.3,Math.sqrt(s)))}function Ta(n,e){if(!(e!=null&&e.length))return-1;let t=0,i=e.length-1,r=-1;for(;t<=i;){const s=t+i>>1;n<e[s]?(r=s,i=s-1):t=s+1}return r}function U4(n,e,t,i){var a,l,c;const r=t[n];if(!(r!=null&&r.isFullTree))return n;const s=i[n];let o=n;if(n>0&&!((a=t[n-1])!=null&&a.isFullTree)){const u=n>1?i[n-2]:0,d=Math.abs(e-(i[n-1]+u)/2);if(o=n-1,n<t.length-1&&!((l=t[n+1])!=null&&l.isFullTree)){const h=i[n+1];Math.abs(e-(s+h)/2)<d&&(o=n+1)}}else n<t.length-1&&!((c=t[n+1])!=null&&c.isFullTree)&&(o=n+1);return o}function _u(){return typeof window<"u"&&window.devicePixelRatio?window.devicePixelRatio:1}function ny(n){return e=>Math.round(e*n)/n}function $4(n,e,t,i,r,s,o){const a=_u(),c=ny(a)(Ks(n,e,t,i)),u=[[c-i/2,-r/2],[c-i/2,r/2]],d=s.scrubberCoreRGB,h=[d[0],d[1],d[2],255];return{id:"scrubber-layer",data:[{path:u}],getColor:h,widthMinPixels:o?10:7,getLineColor:[255,255,255,180],lineWidthMinPixels:1}}const z4={getRadius(n,e,t){const i=Number.isFinite(n)?n:Math.max(3,Math.min(6,Math.floor(e*.18))),r=Math.floor(e*.25);return Math.max(1,Math.min(r,i*t))}},V4={getGaps({index:n,segments:e,anchorRadius:t,gapDefault:i}){var c,u;const r=n>0&&!!((c=e[n-1])!=null&&c.isFullTree),s=n<e.length-1&&!!((u=e[n+1])!=null&&u.isFullTree),o=t;return{leftGap:r?o:i,rightGap:s?o:i}}};function iy(n,e,t,i=null){if(i&&typeof i.getRadius=="function")return i.getRadius(n,e,t);const r=Number.isFinite(n)?n:Math.max(3,Math.min(6,Math.floor(e*.18))),s=Math.floor(e*.25);return Math.max(1,Math.min(s,r*t))}function W4(n,e,t,i,r,s,o,a,l,c,{radiusStrategy:u}={}){const d=(e+t)/2,h=iy(a,r,l,u),f=d-i/2,p=-i/2+h,g=i/2-h,_=Math.max(p,Math.min(g,f)),b=[c(_),0],w=[s[0],s[1],s[2],255],x=[o[0],o[1],o[2],255];return{id:n,position:b,fillColor:w,borderColor:x,radius:h}}function H4(n,e,t,i,r,s,o,a,l,c,u,d,{radiusStrategy:h,gapStrategy:f}={}){var S,I;const p=iy(o,s,a,h);let g,_;if(f&&typeof f.getGaps=="function"){const F=f.getGaps({index:n,segments:d,anchorRadius:p,gapDefault:l});g=F.leftGap,_=F.rightGap}else{const F=p,D=l,B=n>0&&!!((S=d[n-1])!=null&&S.isFullTree),U=n<d.length-1&&!!((I=d[n+1])!=null&&I.isFullTree);g=B?F:D,_=U?F:D}const b=u(t-r/2+g),w=u(i-r/2-_);if(w<=b)return null;const x=[[b,0],[w,0]],y=[c[0],c[1],c[2],220];return{id:e,path:x,color:y}}function j4({startIdx:n,endIdx:e,width:t,height:i,visStart:r,visEnd:s,zoomScale:o,theme:a,timelineData:l,segments:c,selectedId:u,lastHoverId:d,rangeStart:h,rangeEnd:f},{radiusStrategy:p,gapStrategy:g}){var te;const _=_u(),b=ny(_),{anchorFillRGB:w,anchorStrokeRGB:x,anchorRadiusVar:y,gapDefault:S,connectionNeutralRGB:I}=a,{cumulativeDurations:F}=l,D=[],B=[],U=[],O=[],H=[],$=[],z=[];for(let de=n;de<=e;de++){const Ue=de===0?0:F[de-1],xe=F[de];if(xe<r||Ue>s)continue;const ke=Ks(Ue,h,f,t),En=Ks(xe,h,f,t),An=de+1,Fy=!!((te=c[de])!=null&&te.isFullTree),xu=b(ke-t/2),wu=Math.max(6,Math.floor(i*.6));if(z.push({path:[[xu,-wu/2],[xu,wu/2]]}),Fy){const Bt=W4(An,ke,En,t,i,w,x,y,o,b,{radiusStrategy:p});D.push(Bt),u===An?B.push(Bt):d===An&&U.push(Bt)}else{const Bt=H4(de,An,ke,En,t,i,y,o,S,I,b,c,{radiusStrategy:p,gapStrategy:g});if(!Bt)continue;O.push(Bt),u===An?H.push(Bt):d===An&&$.push(Bt)}}return{separators:z,anchorPoints:D,selectionAnchors:B,hoverAnchors:U,connections:O,selectionConnections:H,hoverConnections:$}}class X4{constructor(e,t){this.timelineData=e,this.segments=t||[],this.deck=null,this.container=null,this.canvas=null,this._handlers=new Map,this._selectedId=null,this._lastHoverId=null,this._isScrubbing=!1,this._scrubThresholdPx=10,this._onResize=()=>this._scheduleUpdate(),this._totalDuration=e.totalDuration||1,this._rangeStart=0,this._rangeEnd=this._totalDuration,this._scrubberMs=0,this._viewState={target:[0,0,0],zoom:0},this._updateScheduled=!1,this._handleScrubMove=this._handleScrubMove.bind(this),this._handleMouseUp=this._handleMouseUp.bind(this),this.separatorLayer=null,this.connectionLayer=null,this.anchorLayer=null,this.connectionHoverLayer=null,this.anchorHoverLayer=null,this.connectionSelectionLayer=null,this.anchorSelectionLayer=null,this.scrubberLayer=null,this.radiusStrategy=z4,this.gapStrategy=V4}init(e){(!window.getComputedStyle(e).position||window.getComputedStyle(e).position==="static")&&(e.style.position="relative"),this.container=e,this.canvas=document.createElement("div"),this.canvas.style.position="absolute",this.canvas.style.left="0",this.canvas.style.right="0",this.canvas.style.top="0",this.canvas.style.bottom="0",this.canvas.style.zIndex="2",this.canvas.style.pointerEvents="auto",e.appendChild(this.canvas);const t=Df(this.container);this.separatorLayer=N4([],t),this.connectionLayer=P4([],t.connectionWidth),this.anchorLayer=R4([],t.anchorStrokeWidth),this.connectionHoverLayer=k4([],t.connectionHoverRGB,t.connectionHoverWidth),this.anchorHoverLayer=M4([],t.connectionHoverRGB),this.connectionSelectionLayer=F4([],t),this.anchorSelectionLayer=O4([],t),this.scrubberLayer=dr("scrubber-layer",[],[0,0,0,0],1);const i=e.getBoundingClientRect(),r=Math.max(1,i.width),s=Math.max(1,i.height);return this.deck=new T_({parent:this.canvas,views:[new V_({id:"ortho",flipY:!1,near:.1,far:1e3})],controller:!1,viewState:this._viewState,width:r,height:s,useDevicePixels:_u(),layers:[],onViewStateChange:()=>{},glOptions:{alpha:!0,preserveDrawingBuffer:!0}}),this.addCustomTime(K.DEFAULT_PROGRESS,"scrubber"),this._updateLayers(),window.addEventListener("resize",this._onResize),window.ResizeObserver&&(this._resizeObserver=new ResizeObserver(()=>this._scheduleUpdate()),this._resizeObserver.observe(this.container)),this._bindMouseEvents(),this}setScrubbing(e){this._isScrubbing=!!e,this._scheduleUpdate()}on(e,t){this._handlers.has(e)||this._handlers.set(e,new Set),this._handlers.get(e).add(t)}off(e,t){const i=this._handlers.get(e);i&&i.delete(t)}addCustomTime(e,t){const i=typeof e=="number"?e:K.DEFAULT_PROGRESS;this._scrubberMs=Math.max(0,Math.min(i,this._totalDuration)),this._scheduleUpdate()}setCustomTime(e,t){this._scrubberMs=Math.max(0,Math.min(e,this._totalDuration)),this._scheduleUpdate()}setSelection(e){this._selectedId=Array.isArray(e)&&e.length?e[0]:null,this._updateLayers()}zoomIn(e){const t=this._rangeEnd-this._rangeStart,i=Math.max(1,t*(1-e)),r=(this._rangeStart+this._rangeEnd)/2;this._rangeStart=Math.max(0,r-i/2),this._rangeEnd=Math.min(this._totalDuration,r+i/2),this._scheduleUpdate()}zoomOut(e){const t=this._rangeEnd-this._rangeStart,i=Math.min(this._totalDuration,t*(1+e)),r=(this._rangeStart+this._rangeEnd)/2;this._rangeStart=Math.max(0,r-i/2),this._rangeEnd=Math.min(this._totalDuration,r+i/2),this._scheduleUpdate()}fit(){this._rangeStart=0,this._rangeEnd=this._totalDuration,this._scheduleUpdate()}getTotalDuration(){return this._totalDuration}getVisibleTimeRange(){return{min:this._rangeStart,max:this._rangeEnd}}moveTo(e){const t=this._rangeEnd-this._rangeStart,i=Math.max(0,Math.min(e,this._totalDuration-t)),r=i+t;this._rangeStart=i,this._rangeEnd=r,this._scheduleUpdate()}destroy(){var e;if(this.deck&&this.deck.finalize(),(e=this.canvas)!=null&&e.parentNode&&this.canvas.parentNode.removeChild(this.canvas),window.removeEventListener("resize",this._onResize),this._resizeObserver){try{this._resizeObserver.disconnect()}catch{}this._resizeObserver=null}this.deck=null,this.container=null,this._handlers.clear()}_updateLayers(){if(!this.deck)return;const e=this.container.getBoundingClientRect(),t=Math.max(1,Math.round(e.width)),i=Math.max(1,Math.round(e.height));this._width=t;const r=Df(this.container),s=this._rangeStart,o=this._rangeEnd,a=(o-s)*.1,l=s-a,c=o+a,u=Math.max(0,Ta(Math.max(0,l),this.timelineData.cumulativeDurations)-1),d=Math.min(this.segments.length-1,Ta(Math.min(this._totalDuration-1,c),this.timelineData.cumulativeDurations)+1),h=L4(s,o,this._totalDuration),{separators:f,anchorPoints:p,selectionAnchors:g,hoverAnchors:_,connections:b,selectionConnections:w,hoverConnections:x}=j4({startIdx:u,endIdx:d,width:t,height:i,visStart:l,visEnd:c,zoomScale:h,theme:r,timelineData:this.timelineData,segments:this.segments,selectedId:this._selectedId,lastHoverId:this._lastHoverId,rangeStart:this._rangeStart,rangeEnd:this._rangeEnd},{radiusStrategy:this.radiusStrategy,gapStrategy:this.gapStrategy}),y=[this.separatorLayer.clone({data:f,getColor:[r.separatorRGB[0],r.separatorRGB[1],r.separatorRGB[2],120],widthMinPixels:r.separatorWidth}),this.connectionLayer.clone({data:b,widthMinPixels:r.connectionWidth}),this.connectionHoverLayer.clone({data:x,getColor:[r.connectionHoverRGB[0],r.connectionHoverRGB[1],r.connectionHoverRGB[2],160],widthMinPixels:r.connectionHoverWidth}),this.connectionSelectionLayer.clone({data:w,getColor:[r.connectionSelectionRGB[0],r.connectionSelectionRGB[1],r.connectionSelectionRGB[2],230],widthMinPixels:r.connectionSelectionWidth}),this.scrubberLayer.clone($4(this._scrubberMs,this._rangeStart,this._rangeEnd,t,i,r,this._isScrubbing)),this.anchorLayer.clone({data:p,lineWidthMinPixels:r.anchorStrokeWidth}),this.anchorHoverLayer.clone({data:_,getLineColor:[r.connectionHoverRGB[0],r.connectionHoverRGB[1],r.connectionHoverRGB[2],160]}),this.anchorSelectionLayer.clone({data:g,getLineColor:[r.connectionSelectionRGB[0],r.connectionSelectionRGB[1],r.connectionSelectionRGB[2],230]})];this.deck.setProps({width:t,height:i,layers:y,viewState:this._viewState}),this._updateScheduled=!1}_handleMouseMove(e){W_(this,e)}_handleClick(e){const t=this.container.getBoundingClientRect(),i=e.clientX-t.left,r=this._xToMs(i),s=this._timeToSegmentIndex(r);if(s===-1){this.setSelection(null),this._emit("select",{id:null});return}const o=U4(s,r,this.segments,this.timelineData.cumulativeDurations),a=o+1;this.setSelection([a]),this._emit("select",{id:a,ms:r,segment:this.segments[o]})}_handleScrubMove(e){H_(this,e)}_handleMouseUp(){yN(this)}_timeToSegmentIndex(e){return Ta(e,this.timelineData.cumulativeDurations)}_xToMs(e){return B4(e,this._rangeStart,this._rangeEnd,this._width)}_msToX(e){return Ks(e,this._rangeStart,this._rangeEnd,this._width)}_emit(e,t){const i=this._handlers.get(e);if(i)for(const r of i)try{r(t)}catch(s){console.error(`Error in timeline event handler for '${e}':`,s)}}_bindMouseEvents(){const e=[{event:"mousemove",handler:t=>mN(this,t),target:this.canvas},{event:"mousedown",handler:t=>_N(this,t),target:this.canvas},{event:"mouseup",handler:()=>this._handleMouseUp(),target:window},{event:"click",handler:t=>this._handleClick(t),target:this.canvas},{event:"wheel",handler:t=>bN(this,t),target:this.canvas,options:{passive:!1}},{event:"mouseleave",handler:()=>vN(this),target:this.canvas}];e.forEach(({event:t,handler:i,target:r,options:s})=>{r.addEventListener(t,i,s)}),this._unbindMouseEvents=()=>{e.forEach(({event:t,handler:i,target:r,options:s})=>{r.removeEventListener(t,i,s)})}}_scheduleUpdate(){this._updateScheduled||(this._updateScheduled=!0,requestAnimationFrame(()=>this._updateLayers()))}}function Y4(n,e){return new X4(n,e)}class q4{constructor(e,t){this.movieData=e,this.transitionResolver=t,this.isTimelinePlaying=!1,this.isScrubbing=!1,this.uiManager=null,this.scrubberAPI=null,this.tooltip=null,this.timeline=null,this.segments=_d.createSegments(e),this.timelineData=_d.createTimelineData(this.segments),this.lastScrubTime=0,this.scrubRequestId=null,this._initialize()}_initialize(){const{totalSequenceLength:e}=_o(),{playing:t}=M.getState();if(this.isTimelinePlaying=t,this._createTimeline(),!this.timeline){console.error("[Timeline] Failed to create timeline renderer");return}this.uiManager=new $S(this.movieData,this.timeline),this.uiManager.updateMetrics(e,this.segments.length),this._setupEvents(),this.uiManager.setupControls(),this._initializeScrubberAPI(),this.tooltip=new VS,this.unsubscribeFromStore=M.subscribe((i,r)=>{this.isScrubbing||(i.currentTreeIndex!==r.currentTreeIndex&&requestAnimationFrame(()=>this.updateCurrentPosition()),i.playing!==r.playing&&(this.isTimelinePlaying=i.playing))}),requestAnimationFrame(()=>this.updateCurrentPosition())}_initializeScrubberAPI(){try{const{treeController:e}=M.getState();if(!e){console.warn("[Timeline] TreeController not available for ScrubberAPI");return}this.scrubberAPI=new zS(e,this.transitionResolver,this)}catch(e){console.error("[Timeline] Failed to initialize ScrubberAPI:",e)}}_createTimeline(){let e=document.getElementById("timelineContainer");const t=document.querySelector(".interpolation-timeline-container");e=document.createElement("div"),e.id="timelineContainer",e.className="timeline-visual-layer",t.insertAdjacentElement("beforeend",e),this.timeline=Y4(this.timelineData,this.segments).init(e)}_setupEvents(){this.timeline&&(this.timeline.on("timechange",this._onTimeChange.bind(this)),this.timeline.on("timechanged",this._onTimeChanged.bind(this)),this.timeline.on("click",this._onTimelineClick.bind(this)),this.timeline.on("itemover",this._onItemOver.bind(this)),this.timeline.on("itemout",this._onItemOut.bind(this)),this.timeline.on("mouseMove",this._onMouseMove.bind(this)))}_onTimeChange(e){if(e.id==="scrubber"&&!this.isTimelinePlaying){const t=this._getTimeFromProperties(e);this._handleScrubbing(t)}}_onTimeChanged(e){if(e.id==="scrubber"){const t=this._getTimeFromProperties(e);this._endScrubbing(t)}}_onTimelineClick(e){e.item&&this._handleSegmentClick(e.item-K.INDEX_OFFSET_UI)}_onItemOver(e){const t=(e.item??1)-K.INDEX_OFFSET_UI,i=this.segments[t];if(!i)return;const{clientX:r,clientY:s}=e.event||{clientX:0,clientY:0},o=WS(i,t,this.segments.length,M.getState(),this._getLeafNamesByIndices.bind(this));this.tooltip.show(o,r,s)}_onItemOut(){this.tooltip.hide()}_onMouseMove(e){const{clientX:t,clientY:i}=e.event||{clientX:0,clientY:0};this.tooltip.updatePosition(t,i)}async _handleScrubbing(e){this.isScrubbing?await this._updateScrubbing(e):await this._startScrubbing(e)}async _startScrubbing(e){var t;if(this.isScrubbing=!0,this.scrubStartTimeMs=e,(t=this.timeline)==null||t.setScrubbing(!0),this.scrubberAPI){const i=this._timeToProgress(e);await this.scrubberAPI.startScrubbing(i)}}async _updateScrubbing(e){if(!this.scrubberAPI||!this.isScrubbing)return;const t=performance.now();if(t-this.lastScrubTime<K.SCRUB_THROTTLE_MS){this.scrubRequestId&&cancelAnimationFrame(this.scrubRequestId),this.scrubRequestId=requestAnimationFrame(async()=>{this.isScrubbing&&await this._updateScrubbing(e)});return}const i=this._timeToProgress(e);try{await this.scrubberAPI.updatePosition(i),this.lastScrubTime=t}catch(r){console.error("[Timeline] Error updating scrubber position:",r)}}async _endScrubbing(e){var s;if(!this.isScrubbing)return;const t=this._timeToProgress(e);this.scrubberAPI&&await this.scrubberAPI.endScrubbing(t);const i=e>=(this.scrubStartTimeMs??e)?"forward":"backward",{treeIndex:r}=$e.getTargetTreeForTime(this.segments,e,this.timelineData.segmentDurations,i);this._navigateToTree(r),this.isScrubbing=!1,(s=this.timeline)==null||s.setScrubbing(!1),this.scrubRequestId&&(cancelAnimationFrame(this.scrubRequestId),this.scrubRequestId=null),this.scrubStartTimeMs=null}_handleSegmentClick(e){var r,s;const t=this._validateSegment(e);if(!t)return;const i=((s=(r=t.interpolationData)==null?void 0:r[0])==null?void 0:s.originalIndex)??t.index;this._navigateToTree(i)}updateCurrentPosition(){var c,u,d;if(this.isScrubbing)return;const{currentTreeIndex:e}=M.getState(),{segmentIndex:t,timeInSegment:i}=$e.findSegmentForTreeIndex(this.segments,e),r=this._validateSegment(t);if(!r)return;const s=this.timelineData.segmentDurations[t]||0,o=s>0?i/s:0,a=Math.min(1,Math.max(0,o)),l=this._calculateTimeForSegment(t,i);(c=this.timeline)==null||c.setCustomTime(l,"scrubber"),(u=this.timeline)==null||u.setSelection([t+K.INDEX_OFFSET_UI]),this._updateStoreTimelineState(l,r,e),M.getState().setSegmentProgress(a),(d=this.uiManager)==null||d.updateDisplay(r,a,e)}_calculateTimeForSegment(e,t=0){return $e.calculateTimeForSegment(this.segments,e,t,this.timelineData.segmentDurations)}_validateSegment(e){return e<0||e>=this.segments.length?null:this.segments[e]}_timeToProgress(e){return $e.timeToProgress(e,this.timelineData.totalDuration)}_updateStoreTimelineState(e,t,i){var l;const r=this._timeToProgress(e),s=this.segments.indexOf(t);if(s===-1)return;let o,a;t.hasInterpolation&&((l=t.interpolationData)==null?void 0:l.length)>1?(a=t.interpolationData.length,o=$e.calculateTreePositionInSegment(t,i).treeInSegment):(o=K.DEFAULT_TREE_IN_SEGMENT,a=K.DEFAULT_TREES_IN_SEGMENT),M.getState().updateTimelineState({currentSegmentIndex:s,totalSegments:this.segments.length,treeInSegment:o,treesInSegment:a,timelineProgress:r})}_getLeafNamesByIndices(e){var i;const t=(i=this.movieData)==null?void 0:i.sorted_leaves;return!t||!Array.isArray(e)?[]:e.filter(r=>Number.isInteger(r)&&r>=0&&r<t.length).map(r=>t[r])}_navigateToTree(e){const{currentTreeIndex:t,goToPosition:i}=M.getState(),r=e===t?"jump":e>t?"forward":"backward";i(e,r)}_getTimeFromProperties(e){const{time:t}=e;return t instanceof Date?t.getTime():t}destroy(){var e,t,i,r;this.scrubRequestId&&cancelAnimationFrame(this.scrubRequestId),this.unsubscribeFromStore&&this.unsubscribeFromStore(),(e=this.timeline)==null||e.destroy(),(t=this.uiManager)==null||t.destroy(),(i=this.scrubberAPI)==null||i.destroy(),(r=this.tooltip)==null||r.destroy(),this.timeline=null,this.segments=null,this.timelineData=null,this.uiManager=null,this.scrubberAPI=null,this.tooltip=null,this.scrubRequestId=null}}class K4{constructor(e,t={}){this.options=t,this.movie_data=e,M.getState().initialize(e),this.navigationController=new SS(this),this.uiController=new BS(this),this.chartController=new DS(this,this.navigationController),this.movieTimelineManager=null,this.unsubscribeStore=M.subscribe(i=>({currentTreeIndex:i.currentTreeIndex,playing:i.playing,subscriptionPaused:i.subscriptionPaused}),(i,r)=>{i.playing!==(r==null?void 0:r.playing)&&this._updatePlayButtonState(),!i.playing&&i.currentTreeIndex!==(r==null?void 0:r.currentTreeIndex)&&this.updateMain(),this.syncMSAIfOpen()})}initializeMovie(){const{gui:e}=M.getState();e.resize(),e.update(),this._initializeMovieTimelineManager()}_updatePlayButtonState(){const{playing:e}=M.getState(),t=document.getElementById("play-button");if(!t)return;const i=t.querySelector(".material-icons"),r=t.querySelector(".sr-only");e?(i&&(i.textContent="pause"),r&&(r.textContent="Pause"),t.setAttribute("title","Pause animation"),t.setAttribute("aria-label","Pause animation"),t.classList.add("playing")):(i&&(i.textContent="play_arrow"),r&&(r.textContent="Play"),t.setAttribute("title","Play animation from current position"),t.setAttribute("aria-label","Play animation"),t.classList.remove("playing"))}async play(){let{playing:e,treeController:t}=M.getState();e||(t||(await this.updateMain(),t=M.getState().treeController),t&&typeof t.startAnimation=="function"?t.startAnimation():console.warn("[GUI] Cannot start animation - no valid tree controller"))}stop(){const{treeController:e,stop:t}=M.getState();e&&typeof e.stopAnimation=="function"&&e.stopAnimation(),t()}_syncMSAIfOpenThrottled(){this._lastSyncTime||(this._lastSyncTime=0);const e=Date.now();e-this._lastSyncTime<100||(this._lastSyncTime=e,this.syncMSAIfOpen())}isMSAViewerOpen(){return!0}syncMSAIfOpen(){const{transitionResolver:e,msaWindowSize:t,msaStepSize:i,syncMSAEnabled:r,msaColumnCount:s}=M.getState();if(!r||!e||!s)return;const o=Ii();if(o<0)return;const a=ys(o,i,t,s);is(()=>import("./index-97936cc6.js"),["assets/index-97936cc6.js","assets/dataService-18a31086.js","assets/dataService-1f0e10ab.css"]).then(({setMSARegion:l})=>{l(a.startPosition,a.endPosition)}).catch(()=>{})}async update(e=!1){this.resize(e),await this.updateMain(),await this.chartController.updateChart(),this.uiController.update(),this._syncMSAIfOpenThrottled()}getCurrentWindow(){const{msaWindowSize:e,msaStepSize:t,msaColumnCount:i}=M.getState(),r=Ii();return ys(r,t,e,i||0)}_validateRenderState(){const{currentTreeIndex:e,movieData:t,renderInProgress:i}=M.getState();if(i)return null;const r=t.interpolated_trees[e];return r?{currentTreeIndex:e,movieData:t,tree:r}:null}_ensureTreeController(){const{setTreeController:e,treeController:t}=M.getState();if(t)return t;let i;return this.options.TreeController?i=new this.options.TreeController:i=new gg,e(i),i}async _performTreeRender(e){const{setRenderInProgress:t}=M.getState();t(!0);try{await e.renderAllElements()}catch(i){throw console.error("Error during tree rendering:",i),i}finally{t(!1)}}_updatePostRenderComponents(){this.movieTimelineManager&&this.movieTimelineManager.updateCurrentPosition()}async updateMain(){if(!this._validateRenderState())return;const t=this._ensureTreeController();try{await this._performTreeRender(t)}catch{return}this._updatePostRenderComponents()}resize(e=!1){}async backward(){const{backward:e}=M.getState();e()}async forward(){const{forward:e}=M.getState();e()}async goToPosition(e){const{goToPosition:t}=M.getState();t(e)}async saveImage(){let{treeController:e}=M.getState();e||(await this.updateMain(),e=M.getState().treeController);const t=document.getElementById("save-button");t&&(t.disabled=!0);try{if(!e||!e.deckManager||!e.deckManager.canvas){console.error("Deck.gl canvas not available for saving PNG.");return}const r=e.deckManager.canvas.toDataURL("image/png"),s=document.createElement("a"),o=`phylo-movie-export-${M.getState().currentTreeIndex+1}.png`;s.href=r,s.download=o,document.body.appendChild(s),s.click(),document.body.removeChild(s)}catch(i){console.error("Error saving image:",i)}finally{t&&(t.disabled=!1)}}displayCurrentChartInModal(){return this.chartController.displayCurrentChartInModal()}getCurrentTreeLabel(){var h;const e=M.getState(),{currentTreeIndex:t,movieData:i,transitionResolver:r}=e,s=(h=i.tree_metadata)==null?void 0:h[t];if(!s)return`Tree ${t+1}`;const o=s.phase||"UNKNOWN",a=s.tree_pair_key||null,l=s.step_in_pair||null;if(!a||o==="ORIGINAL"){const p=((r==null?void 0:r.fullTreeIndices)||[]).indexOf(t);return p>=0?`Anchor Tree ${p+1}`:"Anchor Tree"}const c=typeof a=="string"?a.match(/pair_(\d+)_/):null,u=c?`S-edge ${parseInt(c[1],10)}`:a,d=l?`, Step ${l}`:"";return`${u}${d} â€” Transition ${a}`}openTaxaColoringWindow(){var i;const{movieData:e}=M.getState();if(!((i=e.sorted_leaves)!=null&&i.length)){alert("No taxa names available for coloring.");return}const t={...re};e.sorted_leaves.forEach(r=>{re[r]?t[r]=re[r]:t[r]=re.defaultColor||"#000000"}),new Ba(e.sorted_leaves,t,r=>this._handleTaxaColoringComplete(r))}async _handleTaxaColoringComplete(e){const{movieData:t,updateTaxaColors:i,setTaxaGrouping:r}=M.getState(),s=dv(e,t.sorted_leaves,re);i(s);try{const o={mode:(e==null?void 0:e.mode)||"taxa",separator:(e==null?void 0:e.separator)||null,strategyType:(e==null?void 0:e.strategyType)||null,csvTaxaMap:e!=null&&e.csvTaxaMap?Object.fromEntries(e.csvTaxaMap):null,groupColorMap:e!=null&&e.groupColorMap?Object.fromEntries(e.groupColorMap):null};r(o)}catch{}}calculateMSAPosition(){const{currentTreeIndex:e,msaStepSize:t}=M.getState(),i=Ii();return{position:e+1,stepSize:t,steps:i*t,treeIndex:e}}_initializeMovieTimelineManager(){try{const{movieData:e,transitionResolver:t}=M.getState();this.movieTimelineManager=new q4(e,t)}catch(e){console.error("[GUI] Failed to initialize MovieTimelineManager:",e),this.movieTimelineManager=null}}destroy(){const{treeController:e,setTreeController:t}=M.getState();e&&(this.stop(),t(null)),this.unsubscribeStore&&(this.unsubscribeStore(),this.unsubscribeStore=null),this.uiController&&(this.uiController.destroy(),this.uiController=null),this.chartController&&(this.chartController=null),this.navigationController&&(this.navigationController=null),this.movieTimelineManager&&(this.movieTimelineManager.destroy(),this.movieTimelineManager=null)}}function Z4(n,e,t){var i;return function(...s){const o=this,a=function(){i=null,t||n.apply(o,s)},l=t&&!i;clearTimeout(i),i=setTimeout(a,e),l&&n.apply(o,s)}}function Ji(n,e){const t=Math.PI*2;let i=(e-n)%t;return i>Math.PI&&(i-=t),i<=-Math.PI&&(i+=t),i}function es(n,e,t={x:0,y:0,z:0}){return{x:t.x+n*Math.cos(e),y:t.y+n*Math.sin(e),z:t.z||0}}function Bf(n,e,t,i){const r=Mu?Mu(n,t):Ji(n,t),s=i-e;return function(o){return{angle:n+r*o,radius:e+s*o}}}function G4(n,e={x:0,y:0,z:0}){ry(n,"[calculateBranchCoordinates]");const t=n.source,i=n.target,r={x:t.x,y:t.y,z:0},s={x:i.x,y:i.y,z:0},o=.001;if(Math.abs(Ji(t.angle,i.angle))<o)return{movePoint:r,arcEndPoint:null,lineEndPoint:s,arcProperties:null};const l=es(t.radius,i.angle,e),c=Ji(t.angle,i.angle),u=Math.abs(c)>Math.PI?1:0,d=c>=0?1:0;return{movePoint:r,arcEndPoint:l,lineEndPoint:s,arcProperties:{radius:t.radius,startAngle:t.angle,endAngle:i.angle,angleDiff:c,largeArcFlag:u,sweepFlag:d,center:e}}}function Q4(n,e,t,i,r,s,o={x:0,y:0,z:0}){ry(n,"[calculateInterpolatedBranchCoordinates]");const a=t!==void 0?t:n.source.angle,l=i!==void 0?i:n.source.radius,c=r!==void 0?r:n.target.angle,u=s!==void 0?s:n.target.radius,d=n.source.angle,h=n.source.radius,f=n.target.angle,p=n.target.radius,g=Bf(a,l,d,h),_=Bf(c,u,f,p),{angle:b,radius:w}=g(e),{angle:x,radius:y}=_(e),S=es(w,b,o),I=es(y,x,o),F=.001;if(Math.abs(Ji(b,x))<F)return{movePoint:S,arcEndPoint:null,lineEndPoint:I,arcProperties:null};const B=es(w,x,o),U=Ji(b,x),O=Math.abs(U)>Math.PI?1:0,H=U>=0?1:0;return{movePoint:S,arcEndPoint:B,lineEndPoint:I,arcProperties:{radius:w,startAngle:b,endAngle:x,angleDiff:U,largeArcFlag:O,sweepFlag:H,center:o}}}function ry(n,e){if(!n||!n.source||!n.target)throw console.error(`${e} Invalid link data:`,n),new Error("Invalid link data: missing source or target");if(n.source===n.target)throw console.error(`${e} Self-referencing link:`,n),new Error("Invalid link data: source equals target");const t=["x","y","angle","radius"];for(const i of t)if(typeof n.source[i]>"u"||typeof n.target[i]>"u")throw console.error(`${e} Missing property ${i}:`,n),new Error(`Invalid link data: missing ${i} property`)}class J4{constructor(){this.arcCache=new Map}convertLinks(e){return e.links().map(t=>this.createLinkData(t))}createLinkData(e){if(this._hasInvalidLinkCoordinates(e))return console.warn("[LinkConverter] Found NaN link coordinates:",e),this._createInvalidLinkData(e);const t=this._extractLinkCoordinates(e),i=this.createLinkPath(t);return{id:gd(e),sourcePosition:[e.source.x,e.source.y,0],targetPosition:[e.target.x,e.target.y,0],path:i,source:e.source,target:e.target,polarData:this._extractPolarData(e)}}_extractLinkCoordinates(e){return{source:{x:e.source.x,y:e.source.y,angle:e.source.angle,radius:e.source.radius},target:{x:e.target.x,y:e.target.y,angle:e.target.angle,radius:e.target.radius}}}_extractPolarData(e){return{source:{angle:e.source.angle,radius:e.source.radius},target:{angle:e.target.angle,radius:e.target.radius}}}_createInvalidLinkData(e){return{id:gd(e),sourcePosition:[0,0,0],targetPosition:[0,0,0],path:[[0,0,0],[0,0,0]],source:e.source,target:e.target,hasInvalidPosition:!0}}_hasInvalidLinkCoordinates(e){return isNaN(e.source.x)||isNaN(e.source.y)||isNaN(e.target.x)||isNaN(e.target.y)}createLinkPath(e,t=16){const i=G4(e);return i.arcProperties===null?this._createStraightPath(i):this._createCurvedPath(i,t)}_createStraightPath(e){return[[e.movePoint.x,e.movePoint.y,0],[e.lineEndPoint.x,e.lineEndPoint.y,0]]}_createCurvedPath(e,t){const i=[],{radius:r,startAngle:s,endAngle:o,center:a}=e.arcProperties;return i.push([e.movePoint.x,e.movePoint.y,0]),i.push(...this._generateArcPoints(r,s,o,a,t)),i.push([e.lineEndPoint.x,e.lineEndPoint.y,0]),i}_generateArcPoints(e,t,i,r,s){const o=[];for(let a=0;a<=s;a++){const l=a/s,c=t+(i-t)*l,u=r.x+e*Math.cos(c),d=r.y+e*Math.sin(c);o.push([u,d,0])}return o}}class eF{constructor(){}convertNodes(e,t){return e.descendants().map(i=>this.createNodeData(i,t))}createNodeData(e,t){if(this._hasInvalidCoordinates(e))return console.warn("[NodeConverter] Found NaN coordinates:",e),this._createInvalidNodeData(e,t);const i=_s(e),r=(t==null?void 0:t.get(i))||2;return{id:i,position:[e.x||0,e.y||0,0],radius:r,isLeaf:!e.children,isInternal:!!e.children,data:e.data,depth:e.depth,height:e.height,angle:e.angle,polarRadius:e.radius,originalNode:e}}_createInvalidNodeData(e,t){const i=_s(e),r=(t==null?void 0:t.get(i))||2;return{id:i,position:[0,0,0],radius:r,isLeaf:!e.children,isInternal:!!e.children,data:e.data,depth:e.depth,height:e.height,hasInvalidPosition:!0,angle:e.angle||0,polarRadius:e.radius||0,originalNode:e}}_hasInvalidCoordinates(e){return isNaN(e.x)||isNaN(e.y)}}class tF{constructor(){}convertLabels(e,t){return e.leaves().map(i=>this.createLabelData(i,t))}createLabelData(e,t){const i=e.angle,r=Math.sqrt(e.x*e.x+e.y*e.y),s=this._shouldFlipLabel(i),o=this._calculateTextAnchor(s),a=this._calculateLabelRotation(i),l=this._calculateLabelPosition(e,t),u=t+25;return{id:xS(e),position:l,text:e.data.name||"",data:e.data,angle:i,distance:r,polarRadius:u,textAnchor:o,rotation:a,leaf:e}}_shouldFlipLabel(e){return e>Math.PI/2&&e<Math.PI*1.5}_calculateTextAnchor(e){return e?"end":"start"}_calculateLabelRotation(e){let t=0-e;return e>Math.PI/2&&e<Math.PI*1.5&&(t+=Math.PI),t}_calculateLabelPosition(e,t){const r=t+25,s=r*Math.cos(e.angle),o=r*Math.sin(e.angle);return[s,o,0]}}class nF{constructor(){this.arcCache=new Map,this.linkConverter=new J4,this.nodeConverter=new eF,this.labelConverter=new tF}convertTreeToLayerData(e,t={}){const{extensionRadius:i=null,labelRadius:r=null,canvasWidth:s=null,canvasHeight:o=null,radiusConfig:a={}}=t,l=this._calculateAdaptiveNodeRadii(e,{canvasWidth:s,canvasHeight:o,radiusConfig:a}),c=this.nodeConverter.convertNodes(e,l),u=this.linkConverter.convertLinks(e),d=this.labelConverter.convertLabels(e,r||i),h=this._convertExtensions(e,i);return{nodes:c,links:u,labels:d,extensions:h}}_convertExtensions(e,t){return e.leaves().map(i=>this._createExtensionData(i,t)).filter(Boolean)}_createExtensionData(e,t){const i=Math.cos(e.angle)*t,r=Math.sin(e.angle)*t;return{id:wS(e),sourcePosition:[e.x,e.y,0],targetPosition:[i,r,0],path:[[e.x,e.y,0],[i,r,0]],leaf:e,polarData:{source:{angle:e.angle,radius:e.radius},target:{angle:e.angle,radius:t}}}}_calculateAdaptiveNodeRadii(e,t={}){const i=e.descendants(),r=new Map,{canvasWidth:s,canvasHeight:o,radiusConfig:a={}}=t,l=Number.isFinite(s)?s:800,c=Number.isFinite(o)?o:600,u=Math.max(1,Math.min(l,c)),d={leafSizeFactor:.01,leafMinPx:1,leafMaxPx:7,ratio:.5,...a},h=Math.max(d.leafMinPx,Math.min(d.leafMaxPx,Math.round(u*d.leafSizeFactor))),f=Math.max(1,Math.round(h*d.ratio));return i.forEach(p=>{const g=_s(p),_=f;r.set(g,_)}),r}}const _t={ORTHO:"ortho",ORBIT:"orbit"},iF={id:_t.ORTHO,target:[0,0,0],zoom:0,minZoom:-10,maxZoom:10},rF={id:_t.ORBIT,target:[0,0,0],zoom:0,minZoom:-10,maxZoom:10,rotationX:30,rotationOrbit:-30};class sF{constructor(e,t={}){this.container=e,this.deck=null,this.canvas=null,this._onWebGLInitialized=null,this._onError=null,this._onNodeClick=null,this._onNodeHover=null,this.cameraMode="orthographic",this.views={orthographic:new V_({id:_t.ORTHO,controller:!0}),orbit:new hN({id:_t.ORBIT,fov:50,near:.1,far:1e4,controller:!0})},this.viewStates={[_t.ORTHO]:{...iF,...t.initialOrthoState||{}},[_t.ORBIT]:{...rF,...t.initialOrbitState||{}}},this.interpolatorOrtho=new si({transitionProps:["target","zoom"]}),this.interpolatorOrbit=new si({transitionProps:["target","zoom","rotationOrbit","rotationX"]}),this._defaultEasing=_p,this._durations={fit:700,pan:550,zoom:500,orbit:600,fly:700}}initialize(){this.container.selectAll("*").remove(),this.canvas=document.createElement("canvas"),this.canvas.style.width="100%",this.canvas.style.height="100%",this.canvas.style.display="block",this.container.node().appendChild(this.canvas),this.canvas.addEventListener("click",i=>{console.log("[DeckManager] Raw canvas click detected:",i)});const e=this._activeViewId(),t=this.viewStates[e];return this.deck=new T_({canvas:this.canvas,views:[this.views[this.cameraMode]],controller:{doubleClickZoom:!1,touchZoom:!0,touchRotate:!0,scrollZoom:!0,dragPan:!0,dragRotate:!0,keyboard:!0},viewState:t,onViewStateChange:({viewState:i,viewId:r})=>{const s=r||e;this.viewStates[s]={...this.viewStates[s],...i},this.deck.setProps({viewState:this.viewStates[s]})},onClick:(i,r)=>{var s,o,a;return((s=i.layer)==null?void 0:s.id)==="phylo-nodes"&&this._onNodeClick?(console.log("[DeckManager] Node click detected, calling handler"),r&&r.stopPropagation&&r.stopPropagation(),r&&r.preventDefault&&r.preventDefault(),this._onNodeClick(i,r),!0):(((o=i.layer)==null?void 0:o.id)!=="phylo-nodes"?console.log("[DeckManager] Click on layer:",(a=i.layer)==null?void 0:a.id,"but not phylo-nodes"):console.log("[DeckManager] Click with no layer info"),!1)},onHover:(i,r)=>{var s;((s=i.layer)==null?void 0:s.id)==="phylo-nodes"&&this._onNodeHover&&this._onNodeHover(i,r)},getCursor:({isDragging:i,isHovering:r})=>i?"grabbing":r?"pointer":"default",onWebGLInitialized:i=>{this._onWebGLInitialized&&this._onWebGLInitialized(i),console.log("[DeckManager] WebGL context initialized")},onError:i=>{this._onError&&this._onError(i),console.error("[DeckManager] Deck.gl error:",i)}}),this.deck}onWebGLInitialized(e){this._onWebGLInitialized=e}onError(e){this._onError=e}onNodeClick(e){this._onNodeClick=e}onNodeHover(e){this._onNodeHover=e}setProps(e){if(!this.deck){console.warn("[DeckManager] Deck not initialized, cannot set props");return}this.deck.setProps(e)}setLayers(e){this.setProps({layers:e})}getDeck(){return this.deck}getCameraMode(){return this.cameraMode}setCameraMode(e,{preserveTarget:t=!0}={}){if(e!=="orthographic"&&e!=="orbit"){console.warn(`[DeckManager] Invalid camera mode: ${e}. Must be 'orthographic' or 'orbit'.`);return}if(e===this.cameraMode)return;const i=this._activeViewId();this.cameraMode=e;const r=this._activeViewId();t&&(this.viewStates[r].target=[...this.viewStates[i].target||[0,0,0]]),this.setProps({views:[this.views[this.cameraMode]],viewState:this.viewStates[r]}),console.log(`[DeckManager] Switching camera mode to: ${this.cameraMode}`)}getCanvasDimensions(){if(this.canvas){const e=this.canvas.clientWidth||this.canvas.width||800,t=this.canvas.clientHeight||this.canvas.height||600;return{width:e,height:t}}return{width:800,height:600}}panTo(e=[0,0,0],{duration:t=this._durations.pan,easing:i=this._defaultEasing,interpolator:r}={}){const s=this._activeViewId(),o=r||this._interpolatorFor(s);this._applyViewState(s,{target:e},{transitionDuration:t,transitionEasing:i,transitionInterpolator:o})}zoomTo(e,{duration:t=this._durations.zoom,easing:i=this._defaultEasing,interpolator:r}={}){const s=this._activeViewId(),o=this._clampZoom(s,e),a=r||this._interpolatorFor(s);this._applyViewState(s,{zoom:o},{transitionDuration:t,transitionEasing:i,transitionInterpolator:a})}zoomBy(e,t={}){const i=this._activeViewId(),r=this.viewStates[i].zoom??0;this.zoomTo(r+e,t)}orbitRotateTo({rotationOrbit:e,rotationX:t},{duration:i=this._durations.orbit,easing:r=this._defaultEasing,interpolator:s}={}){const o=this._activeViewId();if(o!==_t.ORBIT)return;const a={};e!==void 0&&(a.rotationOrbit=e),t!==void 0&&(a.rotationX=t);const l=s||this._interpolatorFor(o);this._applyViewState(o,a,{transitionDuration:i,transitionEasing:r,transitionInterpolator:l})}fitToBounds(e,{padding:t=1.2,duration:i=this._durations.fit,easing:r=this._defaultEasing,interpolator:s,labels:o=null,labelSizePx:a=null,getLabelSize:l=null}={}){const c=this._activeViewId(),{width:u,height:d}=this.getCanvasDimensions();if(o&&o.length)try{const w=a||(typeof l=="function"?l():16),x=o.reduce((F,D)=>Math.max(F,(D.text||"").length),0),y=.6*w,S=Math.min(2e3,x*y),I=1.2*w;e={minX:e.minX-S,maxX:e.maxX+S,minY:e.minY-I,maxY:e.maxY+I}}catch{}const h=(e.minX+e.maxX)/2,f=(e.minY+e.maxY)/2,p=Math.max(1e-6,e.maxX-e.minX),g=Math.max(1e-6,e.maxY-e.minY);let _=Math.log2(Math.min(u/(p*t),d/(g*t)));_=this._clampZoom(c,_);const b=s||this._interpolatorFor(c);this._applyViewState(c,{target:[h,f,0],zoom:_},{transitionDuration:i,transitionEasing:r,transitionInterpolator:b})}flyTo(e,{duration:t=this._durations.fly,easing:i=this._defaultEasing,interpolator:r}={}){const s=this._activeViewId(),o=r||this._interpolatorFor(s);this._applyViewState(s,e,{transitionDuration:t,transitionEasing:i,transitionInterpolator:o})}getViewState(){const e=this._activeViewId();return{...this.viewStates[e]}}setViewState(e){const t=this._activeViewId();this.viewStates[t]={...this.viewStates[t],...e},this.deck&&this.deck.setProps({viewState:this.viewStates[t]})}getContainer(){return this.container}destroy(){this.deck&&(this.deck.finalize(),this.deck=null),this.canvas&&this.canvas.parentNode&&(this.canvas.parentNode.removeChild(this.canvas),this.canvas=null),this._onWebGLInitialized=null,this._onError=null,this._onNodeClick=null,this._onNodeHover=null}_activeViewId(){return this.cameraMode==="orthographic"?_t.ORTHO:_t.ORBIT}_interpolatorFor(e){return e===_t.ORTHO?this.interpolatorOrtho:this.interpolatorOrbit}_clampZoom(e,t){const i=this.viewStates[e],r=i.minZoom??-1/0,s=i.maxZoom??1/0;return Math.max(r,Math.min(s,t))}_applyViewState(e,t,i){const r={...this.viewStates[e],...t,...i};this.viewStates[e]=r,this.setProps({viewState:r})}}class oF{constructor(){this._cache={strokeWidth:null,fontSize:null},this._setupStoreSubscription()}_setupStoreSubscription(){this.unsubscribe=M.subscribe((e,t)=>{let i=!1;e.strokeWidth!==t.strokeWidth&&(this._cache.strokeWidth=e.strokeWidth,i=!0),e.fontSize!==t.fontSize&&(this._cache.fontSize=e.fontSize,i=!0),i&&this.onStyleChange&&this.onStyleChange()})}getLinkColor(e){const t=M.getState().getColorManager(),i=t.getBranchColor(e),r=this._hexToRgb(i);let s=e.opacity!==void 0?Math.round(e.opacity*255):255;const{dimmingEnabled:o}=M.getState();return o&&t.hasActiveChangeEdges()&&!t.isDownstreamOfAnyActiveChangeEdge(e)&&(s=Math.round(s*.3)),[...r,s]}getLinkWidth(e){var a,l,c;const t=this._cache.strokeWidth||M.getState().strokeWidth||3,i=(l=(a=M.getState()).getColorManager)==null?void 0:l.call(a);if(!i)return Math.max(t,3);const r=(c=i.getBranchColor)==null?void 0:c.call(i,e),s=i.getBranchColorWithHighlights(e);return r!==s?t*2:Math.max(t,3)}getLinkOutlineColor(e){var l,c,u;const t=(c=(l=M.getState()).getColorManager)==null?void 0:c.call(l);if(!t)return[0,0,0,0];const i=(u=t.getBranchColor)==null?void 0:u.call(t,e),r=t.getBranchColorWithHighlights(e);if(i===r)return[0,0,0,0];const s=this._hexToRgb(r),o=e.opacity!==void 0?e.opacity:1,a=Math.round(o*100);return[s[0],s[1],s[2],a]}getLinkOutlineWidth(e){var a,l,c;const t=(l=(a=M.getState()).getColorManager)==null?void 0:l.call(a);if(!t)return 0;const i=(c=t.getBranchColor)==null?void 0:c.call(t,e),r=t.getBranchColorWithHighlights(e);return i===r?0:(this._cache.strokeWidth||M.getState().strokeWidth||3)*2+8}getNodeColor(e){var l,c;const t=(c=(l=M.getState()).getColorManager)==null?void 0:c.call(l),i=this._convertNodeToColorManagerFormat(e),r=t.getNodeColor(i),s=this._hexToRgb(r);let o=e.opacity!==void 0?Math.round(e.opacity*255):255;const{dimmingEnabled:a}=M.getState();return a&&t.hasActiveChangeEdges()&&!t.isNodeDownstreamOfAnyActiveChangeEdge(i)&&(o=Math.round(o*.3)),[...s,o]}getNodeBorderColor(e){return[20,20,20,e.opacity!==void 0?Math.round(e.opacity*255):255]}getLabelColor(e){var l,c;const t=(c=(l=M.getState()).getColorManager)==null?void 0:c.call(l),i=this._convertNodeToColorManagerFormat(e),r=t.getNodeColor(i),s=this._hexToRgb(r);let o=e.opacity!==void 0?Math.round(e.opacity*255):255;const{dimmingEnabled:a}=M.getState();return a&&t.hasActiveChangeEdges()&&!t.isNodeDownstreamOfAnyActiveChangeEdge(i)&&(o=Math.round(o*.3)),[s[0],s[1],s[2],o]}getExtensionColor(e){var l,c,u;const t=(c=(l=M.getState()).getColorManager)==null?void 0:c.call(l),i=this._convertNodeToColorManagerFormat(e),r=(u=t.getNodeColor)==null?void 0:u.call(t,i),s=this._hexToRgb(r);let o=e.opacity!==void 0?Math.round(e.opacity*255):255;const{dimmingEnabled:a}=M.getState();return a&&t.hasActiveChangeEdges()&&!t.isNodeDownstreamOfAnyActiveChangeEdge(i)&&(o=Math.round(o*.3)),[...s,o]}getExtensionWidth(e){const t=this._cache.strokeWidth||M.getState().strokeWidth||3;return Math.max(t*.5,1)}getLabelSize(){const e=this._cache.fontSize||M.getState().fontSize||"2.6em";return parseFloat(e)*10||16}_convertNodeToColorManagerFormat(e){return e.originalNode?e.originalNode:e}invalidateCache(){this._cache.strokeWidth=null,this._cache.fontSize=null,this._cache.highlightEdges=null,this.onStyleChange&&this.onStyleChange()}setStyleChangeCallback(e){this.onStyleChange=e}_hexToRgb(e){if(e.startsWith("hsl("))return this._hslToRgb(e);let t=e.replace("#","");const i=parseInt(t.substring(0,2),16),r=parseInt(t.substring(2,4),16),s=parseInt(t.substring(4,6),16);return[i,r,s]}_hslToRgb(e){const t=e.match(/hsl\((\d+),\s*(\d+)%,\s*(\d+)%\)/);if(!t)return[0,0,0];const i=parseInt(t[1])/360,r=parseInt(t[2])/100,s=parseInt(t[3])/100;let o,a,l;if(r===0)o=a=l=s;else{const c=(h,f,p)=>(p<0&&(p+=1),p>1&&(p-=1),p<.16666666666666666?h+(f-h)*6*p:p<.5?f:p<.6666666666666666?h+(f-h)*(.6666666666666666-p)*6:h),u=s<.5?s*(1+r):s+r-s*r,d=2*s-u;o=c(d,u,i+1/3),a=c(d,u,i),l=c(d,u,i-1/3)}return[Math.round(o*255),Math.round(a*255),Math.round(l*255)]}destroy(){this.unsubscribe&&(this.unsubscribe(),this.unsubscribe=null)}}class aF{constructor(){this.MIN_NODE_RADIUS=3,this._layerConfigs={linkOutlines:{id:"phylo-link-outlines",LayerClass:Ei,defaultProps:{widthUnits:"pixels",widthMinPixels:4,jointRounded:!0,capRounded:!0}},links:{id:"phylo-links",LayerClass:Ei,defaultProps:{widthUnits:"pixels",widthMinPixels:3,jointRounded:!0,capRounded:!0}},extensions:{id:"phylo-extensions",LayerClass:Ei,defaultProps:{widthUnits:"pixels",widthMinPixels:2,jointRounded:!0,capRounded:!0}},nodes:{id:"phylo-nodes",LayerClass:X_,defaultProps:{lineWidthUnits:"pixels",radiusUnits:"pixels",radiusMinPixels:3,getLineWidth:3}},labels:{id:"phylo-labels",LayerClass:I4,defaultProps:{getAlignmentBaseline:"center"}},trails:{id:"phylo-motion-trails",LayerClass:Ei,defaultProps:{widthUnits:"pixels",widthMinPixels:1,jointRounded:!0,capRounded:!0,pickable:!1}}},this.layerStyles=new oF}createTreeLayers(e){const{nodes:t,links:i,labels:r,extensions:s=[],trails:o=[]}=e;return[this.createLinkOutlinesLayer(i),this.createLinksLayer(i),this.createExtensionsLayer(s),this.createNodesLayer(t),this.createFlowTrailsLayer(o),this.createLabelsLayer(r)].filter(Boolean)}createLinkOutlinesLayer(e){const t=this._layerConfigs.linkOutlines;return new t.LayerClass({...t.defaultProps,id:t.id,data:e,pickable:!1,getPath:i=>i.path,getColor:i=>this.layerStyles.getLinkOutlineColor(i),getWidth:i=>this.layerStyles.getLinkOutlineWidth(i),updateTriggers:{getColor:[e,this.layerStyles._cache.highlightEdges],getWidth:[e,this.layerStyles._cache.strokeWidth],getPath:[e]}})}createLinksLayer(e){const t=this._layerConfigs.links;return new t.LayerClass({...t.defaultProps,id:t.id,data:e,pickable:!0,getPath:i=>i.path,getColor:i=>this.layerStyles.getLinkColor(i),getWidth:i=>this.layerStyles.getLinkWidth(i),getDashArray:i=>this.layerStyles.getLinkDashArray(i),dashJustified:!0,updateTriggers:{getColor:[e,this.layerStyles._cache.highlightEdges],getWidth:[e,this.layerStyles._cache.strokeWidth],getDashArray:[e,this.layerStyles._cache.strokeWidth],getPath:[e]}})}createExtensionsLayer(e){const t=this._layerConfigs.extensions;return new t.LayerClass({...t.defaultProps,id:t.id,data:e,getPath:i=>i.path,getColor:i=>this.layerStyles.getExtensionColor(i.leaf),getWidth:i=>this.layerStyles.getExtensionWidth(i),updateTriggers:{getColor:[e],getPath:[e],getWidth:[e,this.layerStyles._cache.strokeWidth]}})}createNodesLayer(e){const t=this._layerConfigs.nodes;return new t.LayerClass({...t.defaultProps,id:t.id,data:e,pickable:!0,getPosition:r=>r.position,getRadius:r=>Math.max(r.radius,this.MIN_NODE_RADIUS),getFillColor:r=>this.layerStyles.getNodeColor(r),getLineColor:r=>this.layerStyles.getNodeBorderColor(r),updateTriggers:{getFillColor:[e,this.layerStyles._cache.highlightEdges],getLineColor:[e],getPosition:[e],getRadius:[e]}})}createLabelsLayer(e){const t=this._layerConfigs.labels;return new t.LayerClass({...t.defaultProps,id:t.id,data:e,getPosition:i=>i.position,getText:i=>i.text,getSize:()=>this.layerStyles.getLabelSize(),getColor:i=>this.layerStyles.getLabelColor(i.leaf),getAngle:i=>i.rotation*(180/Math.PI),getTextAnchor:i=>i.textAnchor,updateTriggers:{getColor:[e],getSize:[this.layerStyles._cache.fontSize],getAngle:[e],getTextAnchor:[e],getPosition:[e]}})}createFlowTrailsLayer(e){if(!e||e.length===0)return null;const t=this._layerConfigs.trails,{trailThickness:i}=M.getState();return new t.LayerClass({...t.defaultProps,id:t.id,data:e,getPath:r=>r.path,getWidth:r=>Math.max(1,(this.layerStyles._cache.strokeWidth||3)*(i||.5)),getColor:r=>{let s;r.kind==="label"?s=this.layerStyles.getLabelColor(r.leaf):s=this.layerStyles.getNodeColor(r.node);const o=r.alphaFactor??.5,a=Math.max(0,Math.min(255,Math.round((s[3]??255)*o)));return[s[0],s[1],s[2],a]},updateTriggers:{getPath:[e],getColor:[e,this.layerStyles._cache.strokeWidth]}})}updateLayersWithData(e){return this.createTreeLayers(e)}destroy(){this.layerStyles&&(this.layerStyles.destroy(),this.layerStyles=null)}}class lF{interpolateElements(e,t,i,r,s=null){const o=this._createElementMap(e),a=this._createElementMap(t),l=[],c=new Set;for(const[u,d]of a){const h=o.get(u);h?(c.add(u),l.push(r(h,d,i,h,d))):l.push(this._createEnteringElement(d,i))}for(const[u,d]of o)c.has(u)||l.push(this._createExitingElement(d,i));return l}_createElementMap(e){return new Map(e.map(t=>[t.id,t]))}_createEnteringElement(e,t){return{...e,opacity:t,isEntering:!0}}_createExitingElement(e,t){return{...e,opacity:1-t,isExiting:!0}}classifyElements(e,t){const i=this._createElementMap(e),r=this._createElementMap(t),s=[],o=[],a=[];for(const[l,c]of r)i.has(l)?o.push({from:i.get(l),to:c}):s.push(c);for(const[l,c]of i)r.has(l)||a.push(c);return{enter:s,update:o,exit:a}}}class cF{constructor(){this.segmentCount=16}interpolatePath(e,t,i,r=null,s=null){if(this._canUsePolarInterpolation(r,s))try{return this._polarInterpolatePath(r,s,i)}catch(o){console.warn("[PathInterpolator] Polar interpolation failed, falling back to linear:",o)}return this.linearInterpolatePath(e,t,i)}_canUsePolarInterpolation(e,t){return e&&t&&e.polarData&&t.polarData&&e.polarData.source&&e.polarData.target&&t.polarData.source&&t.polarData.target}_polarInterpolatePath(e,t,i){const r={source:{angle:t.polarData.source.angle,radius:t.polarData.source.radius,x:t.sourcePosition[0],y:t.sourcePosition[1]},target:{angle:t.polarData.target.angle,radius:t.polarData.target.radius,x:t.targetPosition[0],y:t.targetPosition[1]}},s=Q4(r,i,e.polarData.source.angle,e.polarData.source.radius,e.polarData.target.angle,e.polarData.target.radius);return this._coordinatesToPath(s)}_coordinatesToPath(e){const{movePoint:t,arcEndPoint:i,lineEndPoint:r,arcProperties:s}=e;if(!s)return[[t.x,t.y,0],[r.x,r.y,0]];const o=[],{radius:a,startAngle:l,endAngle:c,center:u}=s;o.push([t.x,t.y,0]);for(let d=0;d<=this.segmentCount;d++){const h=d/this.segmentCount,f=this._shortestAngleDifference(l,c),p=l+f*h,g=u.x+a*Math.cos(p),_=u.y+a*Math.sin(p);o.push([g,_,0])}return o.push([r.x,r.y,0]),o}linearInterpolatePath(e,t,i){if(!e||!t)return t||e||[];const r=Math.max(e.length,t.length),s=this._normalizePath(e,r),o=this._normalizePath(t,r);return s.map((a,l)=>{const c=o[l];return this._interpolatePoint(a,c,i)})}_normalizePath(e,t){if(e.length===t)return e;if(e.length===0)return Array(t).fill([0,0,0]);if(e.length===1)return Array(t).fill(e[0]);const i=[],r=(e.length-1)/(t-1);for(let s=0;s<t;s++){const o=s*r,a=Math.floor(o),l=Math.ceil(o),c=o-a;if(l>=e.length)i.push(e[e.length-1]);else if(c===0)i.push(e[a]);else{const u=e[a],d=e[l];i.push(this._interpolatePoint(u,d,c))}}return i}_interpolatePoint(e,t,i){return[e[0]+(t[0]-e[0])*i,e[1]+(t[1]-e[1])*i,e[2]+(t[2]-e[2])*i]}setSegmentCount(e){this.segmentCount=Math.max(4,e)}_shortestAngleDifference(e,t){const i=Math.PI*2;let r=(t-e)%i;return r>Math.PI&&(r-=i),r<=-Math.PI&&(r+=i),r}}class uF{constructor(){this.elementMatcher=new lF,this.pathInterpolator=new cF}interpolateTreeData(e,t,i){const r=Math.max(0,Math.min(1,i)),s=this._interpolateNodes(e.nodes,t.nodes,r),o=this._interpolateLinks(e.links,t.links,r),a=this._interpolateLabels(e.labels,t.labels,r),l=this._interpolateExtensions(e.extensions,t.extensions,r);return{nodes:s,links:o,labels:a,extensions:l}}_interpolateNodes(e,t,i){return this.elementMatcher.interpolateElements(e,t,i,(r,s,o,a,l)=>({...s,position:this._interpolatePosition(r.position,s.position,o,a,l),radius:this._interpolateScalar(r.radius,s.radius,o),name:s.name,isLeaf:s.isLeaf,split_indices:s.split_indices}),"nodes")}_interpolateLinks(e,t,i){return this.elementMatcher.interpolateElements(e,t,i,(r,s,o,a,l)=>({...s,path:this.pathInterpolator.interpolatePath(r.path,s.path,o,a,l),sourcePosition:this._interpolatePosition(r.sourcePosition,s.sourcePosition,o),targetPosition:this._interpolatePosition(r.targetPosition,s.targetPosition,o),polarData:s.polarData,split_indices:s.split_indices,children:s.children,targetName:s.targetName}),"links")}_interpolateLabels(e,t,i){return this.elementMatcher.interpolateElements(e,t,i,(r,s,o,a,l)=>{const c=this._interpolatePosition(r.position,s.position,o,a,l);return{...s,position:c,rotation:this._interpolateRotation(r.rotation,s.rotation,o),text:s.text,textAnchor:s.textAnchor,leaf:s.leaf}},"labels")}_interpolateExtensions(e,t,i){return this.elementMatcher.interpolateElements(e,t,i,(r,s,o,a,l)=>{const c=this.pathInterpolator.interpolatePath(r.path,s.path,o,a,l);return{...s,path:c,leaf:s.leaf}},"extensions")}_interpolatePosition(e,t,i,r=null,s=null){return this._canUsePolarInterpolation(r,s)?this._interpolatePositionPolar(r,s,i):[e[0]+(t[0]-e[0])*i,e[1]+(t[1]-e[1])*i,e[2]+(t[2]-e[2])*i]}_canUsePolarInterpolation(e,t){if(!e||!t)return!1;const i=e.angle,r=t.angle,s=typeof e.polarRadius=="number"?e.polarRadius:e.radius,o=typeof t.polarRadius=="number"?t.polarRadius:t.radius;return typeof i=="number"&&typeof r=="number"&&typeof s=="number"&&typeof o=="number"&&!isNaN(i)&&!isNaN(r)&&!isNaN(s)&&!isNaN(o)}_interpolatePositionPolar(e,t,i){const r=typeof e.polarRadius=="number"?e.polarRadius:e.radius,s=typeof t.polarRadius=="number"?t.polarRadius:t.radius,o=this._interpolateScalar(r,s,i),a=this._interpolateRotation(e.angle,t.angle,i),l=o*Math.cos(a),c=o*Math.sin(a);return[l,c,0]}_interpolateScalar(e,t,i){return e+(t-e)*i}_interpolateRotation(e,t,i){const r=Math.PI*2;let s=(t-e)%r;return s>Math.PI&&(s-=r),s<=-Math.PI&&(s+=r),e+s*i}}var dF=function(){},Lf=function(){};const Wl=(n,e,t)=>Math.min(Math.max(t,n),e),Sa=.001,hF=.01,Uf=10,fF=.05,pF=1;function gF({duration:n=800,bounce:e=.25,velocity:t=0,mass:i=1}){let r,s;dF(n<=Uf*1e3);let o=1-e;o=Wl(fF,pF,o),n=Wl(hF,Uf,n/1e3),o<1?(r=c=>{const u=c*o,d=u*n,h=u-t,f=Hl(c,o),p=Math.exp(-d);return Sa-h/f*p},s=c=>{const d=c*o*n,h=d*t+t,f=Math.pow(o,2)*Math.pow(c,2)*n,p=Math.exp(-d),g=Hl(Math.pow(c,2),o);return(-r(c)+Sa>0?-1:1)*((h-f)*p)/g}):(r=c=>{const u=Math.exp(-c*n),d=(c-t)*n+1;return-Sa+u*d},s=c=>{const u=Math.exp(-c*n),d=(t-c)*(n*n);return u*d});const a=5/n,l=_F(r,s,a);if(n=n*1e3,isNaN(l))return{stiffness:100,damping:10,duration:n};{const c=Math.pow(l,2)*i;return{stiffness:c,damping:o*2*Math.sqrt(i*c),duration:n}}}const mF=12;function _F(n,e,t){let i=t;for(let r=1;r<mF;r++)i=i-n(i)/e(i);return i}function Hl(n,e){return n*Math.sqrt(1-e*e)}const yF=["duration","bounce"],bF=["stiffness","damping","mass"];function $f(n,e){return e.some(t=>n[t]!==void 0)}function vF(n){let e=Object.assign({velocity:0,stiffness:100,damping:10,mass:1,isResolvedFromDuration:!1},n);if(!$f(n,bF)&&$f(n,yF)){const t=gF(n);e=Object.assign(Object.assign(Object.assign({},e),t),{velocity:0,mass:1}),e.isResolvedFromDuration=!0}return e}function yu(n){var{from:e=0,to:t=1,restSpeed:i=2,restDelta:r}=n,s=ip(n,["from","to","restSpeed","restDelta"]);const o={done:!1,value:e};let{stiffness:a,damping:l,mass:c,velocity:u,duration:d,isResolvedFromDuration:h}=vF(s),f=zf,p=zf;function g(){const _=u?-(u/1e3):0,b=t-e,w=l/(2*Math.sqrt(a*c)),x=Math.sqrt(a/c)/1e3;if(r===void 0&&(r=Math.min(Math.abs(t-e)/100,.4)),w<1){const y=Hl(x,w);f=S=>{const I=Math.exp(-w*x*S);return t-I*((_+w*x*b)/y*Math.sin(y*S)+b*Math.cos(y*S))},p=S=>{const I=Math.exp(-w*x*S);return w*x*I*(Math.sin(y*S)*(_+w*x*b)/y+b*Math.cos(y*S))-I*(Math.cos(y*S)*(_+w*x*b)-y*b*Math.sin(y*S))}}else if(w===1)f=y=>t-Math.exp(-x*y)*(b+(_+x*b)*y);else{const y=x*Math.sqrt(w*w-1);f=S=>{const I=Math.exp(-w*x*S),F=Math.min(y*S,300);return t-I*((_+w*x*b)*Math.sinh(F)+y*b*Math.cosh(F))/y}}}return g(),{next:_=>{const b=f(_);if(h)o.done=_>=d;else{const w=p(_)*1e3,x=Math.abs(w)<=i,y=Math.abs(t-b)<=r;o.done=x&&y}return o.value=o.done?t:b,o},flipTarget:()=>{u=-u,[e,t]=[t,e],g()}}}yu.needsInterpolation=(n,e)=>typeof n=="string"||typeof e=="string";const zf=n=>0,sy=(n,e,t)=>{const i=e-n;return i===0?1:(t-n)/i},bu=(n,e,t)=>-t*n+t*e+n,oy=(n,e)=>t=>Math.max(Math.min(t,e),n),Bi=n=>n%1?Number(n.toFixed(5)):n,Zs=/(-)?([\d]*\.?[\d])+/g,jl=/(#[0-9a-f]{6}|#[0-9a-f]{3}|#(?:[0-9a-f]{2}){2,4}|(rgb|hsl)a?\((-?[\d\.]+%?[,\s]+){2}(-?[\d\.]+%?)\s*[\,\/]?\s*[\d\.]*%?\))/gi,xF=/^(#[0-9a-f]{3}|#(?:[0-9a-f]{2}){2,4}|(rgb|hsl)a?\((-?[\d\.]+%?[,\s]+){2}(-?[\d\.]+%?)\s*[\,\/]?\s*[\d\.]*%?\))$/i;function hr(n){return typeof n=="string"}const Po={test:n=>typeof n=="number",parse:parseFloat,transform:n=>n},ay=Object.assign(Object.assign({},Po),{transform:oy(0,1)});Object.assign(Object.assign({},Po),{default:1});const wF=n=>({test:e=>hr(e)&&e.endsWith(n)&&e.split(" ").length===1,parse:parseFloat,transform:e=>`${e}${n}`}),Li=wF("%");Object.assign(Object.assign({},Li),{parse:n=>Li.parse(n)/100,transform:n=>Li.transform(n*100)});const vu=(n,e)=>t=>!!(hr(t)&&xF.test(t)&&t.startsWith(n)||e&&Object.prototype.hasOwnProperty.call(t,e)),ly=(n,e,t)=>i=>{if(!hr(i))return i;const[r,s,o,a]=i.match(Zs);return{[n]:parseFloat(r),[e]:parseFloat(s),[t]:parseFloat(o),alpha:a!==void 0?parseFloat(a):1}},un={test:vu("hsl","hue"),parse:ly("hue","saturation","lightness"),transform:({hue:n,saturation:e,lightness:t,alpha:i=1})=>"hsla("+Math.round(n)+", "+Li.transform(Bi(e))+", "+Li.transform(Bi(t))+", "+Bi(ay.transform(i))+")"},TF=oy(0,255),Ea=Object.assign(Object.assign({},Po),{transform:n=>Math.round(TF(n))}),Yt={test:vu("rgb","red"),parse:ly("red","green","blue"),transform:({red:n,green:e,blue:t,alpha:i=1})=>"rgba("+Ea.transform(n)+", "+Ea.transform(e)+", "+Ea.transform(t)+", "+Bi(ay.transform(i))+")"};function SF(n){let e="",t="",i="",r="";return n.length>5?(e=n.substr(1,2),t=n.substr(3,2),i=n.substr(5,2),r=n.substr(7,2)):(e=n.substr(1,1),t=n.substr(2,1),i=n.substr(3,1),r=n.substr(4,1),e+=e,t+=t,i+=i,r+=r),{red:parseInt(e,16),green:parseInt(t,16),blue:parseInt(i,16),alpha:r?parseInt(r,16)/255:1}}const Xl={test:vu("#"),parse:SF,transform:Yt.transform},Mo={test:n=>Yt.test(n)||Xl.test(n)||un.test(n),parse:n=>Yt.test(n)?Yt.parse(n):un.test(n)?un.parse(n):Xl.parse(n),transform:n=>hr(n)?n:n.hasOwnProperty("red")?Yt.transform(n):un.transform(n)},cy="${c}",uy="${n}";function EF(n){var e,t,i,r;return isNaN(n)&&hr(n)&&((t=(e=n.match(Zs))===null||e===void 0?void 0:e.length)!==null&&t!==void 0?t:0)+((r=(i=n.match(jl))===null||i===void 0?void 0:i.length)!==null&&r!==void 0?r:0)>0}function dy(n){typeof n=="number"&&(n=`${n}`);const e=[];let t=0;const i=n.match(jl);i&&(t=i.length,n=n.replace(jl,cy),e.push(...i.map(Mo.parse)));const r=n.match(Zs);return r&&(n=n.replace(Zs,uy),e.push(...r.map(Po.parse))),{values:e,numColors:t,tokenised:n}}function hy(n){return dy(n).values}function fy(n){const{values:e,numColors:t,tokenised:i}=dy(n),r=e.length;return s=>{let o=i;for(let a=0;a<r;a++)o=o.replace(a<t?cy:uy,a<t?Mo.transform(s[a]):Bi(s[a]));return o}}const AF=n=>typeof n=="number"?0:n;function CF(n){const e=hy(n);return fy(n)(e.map(AF))}const py={test:EF,parse:hy,createTransformer:fy,getAnimatableNone:CF};function Aa(n,e,t){return t<0&&(t+=1),t>1&&(t-=1),t<1/6?n+(e-n)*6*t:t<1/2?e:t<2/3?n+(e-n)*(2/3-t)*6:n}function Vf({hue:n,saturation:e,lightness:t,alpha:i}){n/=360,e/=100,t/=100;let r=0,s=0,o=0;if(!e)r=s=o=t;else{const a=t<.5?t*(1+e):t+e-t*e,l=2*t-a;r=Aa(l,a,n+1/3),s=Aa(l,a,n),o=Aa(l,a,n-1/3)}return{red:Math.round(r*255),green:Math.round(s*255),blue:Math.round(o*255),alpha:i}}const IF=(n,e,t)=>{const i=n*n,r=e*e;return Math.sqrt(Math.max(0,t*(r-i)+i))},RF=[Xl,Yt,un],Wf=n=>RF.find(e=>e.test(n)),gy=(n,e)=>{let t=Wf(n),i=Wf(e),r=t.parse(n),s=i.parse(e);t===un&&(r=Vf(r),t=Yt),i===un&&(s=Vf(s),i=Yt);const o=Object.assign({},r);return a=>{for(const l in o)l!=="alpha"&&(o[l]=IF(r[l],s[l],a));return o.alpha=bu(r.alpha,s.alpha,a),t.transform(o)}},PF=n=>typeof n=="number",MF=(n,e)=>t=>e(n(t)),my=(...n)=>n.reduce(MF);function _y(n,e){return PF(n)?t=>bu(n,e,t):Mo.test(n)?gy(n,e):by(n,e)}const yy=(n,e)=>{const t=[...n],i=t.length,r=n.map((s,o)=>_y(s,e[o]));return s=>{for(let o=0;o<i;o++)t[o]=r[o](s);return t}},kF=(n,e)=>{const t=Object.assign(Object.assign({},n),e),i={};for(const r in t)n[r]!==void 0&&e[r]!==void 0&&(i[r]=_y(n[r],e[r]));return r=>{for(const s in i)t[s]=i[s](r);return t}};function Hf(n){const e=py.parse(n),t=e.length;let i=0,r=0,s=0;for(let o=0;o<t;o++)i||typeof e[o]=="number"?i++:e[o].hue!==void 0?s++:r++;return{parsed:e,numNumbers:i,numRGB:r,numHSL:s}}const by=(n,e)=>{const t=py.createTransformer(e),i=Hf(n),r=Hf(e);return i.numHSL===r.numHSL&&i.numRGB===r.numRGB&&i.numNumbers>=r.numNumbers?my(yy(i.parsed,r.parsed),t):o=>`${o>0?e:n}`},OF=(n,e)=>t=>bu(n,e,t);function NF(n){if(typeof n=="number")return OF;if(typeof n=="string")return Mo.test(n)?gy:by;if(Array.isArray(n))return yy;if(typeof n=="object")return kF}function FF(n,e,t){const i=[],r=t||NF(n[0]),s=n.length-1;for(let o=0;o<s;o++){let a=r(n[o],n[o+1]);if(e){const l=Array.isArray(e)?e[o]:e;a=my(l,a)}i.push(a)}return i}function DF([n,e],[t]){return i=>t(sy(n,e,i))}function BF(n,e){const t=n.length,i=t-1;return r=>{let s=0,o=!1;if(r<=n[0]?o=!0:r>=n[i]&&(s=i-1,o=!0),!o){let l=1;for(;l<t&&!(n[l]>r||l===i);l++);s=l-1}const a=sy(n[s],n[s+1],r);return e[s](a)}}function vy(n,e,{clamp:t=!0,ease:i,mixer:r}={}){const s=n.length;Lf(s===e.length),Lf(!i||!Array.isArray(i)||i.length===s-1),n[0]>n[s-1]&&(n=[].concat(n),e=[].concat(e),n.reverse(),e.reverse());const o=FF(e,i,r),a=s===2?DF(n,o):BF(n,o);return t?l=>a(Wl(n[0],n[s-1],l)):a}const LF=n=>e=>e<=.5?n(2*e)/2:(2-n(2*(1-e)))/2,UF=n=>e=>Math.pow(e,n),$F=n=>e=>e*e*((n+1)*e-n),zF=n=>{const e=$F(n);return t=>(t*=2)<1?.5*e(t):.5*(2-Math.pow(2,-10*(t-1)))},VF=1.525,WF=UF(2),xy=LF(WF);zF(VF);function HF(n,e){return n.map(()=>e||xy).splice(0,n.length-1)}function jF(n){const e=n.length;return n.map((t,i)=>i!==0?i/(e-1):0)}function XF(n,e){return n.map(t=>t*e)}function ts({from:n=0,to:e=1,ease:t,offset:i,duration:r=300}){const s={done:!1,value:n},o=Array.isArray(e)?e:[n,e],a=XF(i&&i.length===o.length?i:jF(o),r);function l(){return vy(a,o,{ease:Array.isArray(t)?t:HF(o,t)})}let c=l();return{next:u=>(s.value=c(u),s.done=u>=r,s),flipTarget:()=>{o.reverse(),c=l()}}}function YF({velocity:n=0,from:e=0,power:t=.8,timeConstant:i=350,restDelta:r=.5,modifyTarget:s}){const o={done:!1,value:e};let a=t*n;const l=e+a,c=s===void 0?l:s(l);return c!==l&&(a=c-e),{next:u=>{const d=-a*Math.exp(-u/i);return o.done=!(d>r||d<-r),o.value=o.done?c:c+d,o},flipTarget:()=>{}}}const jf={keyframes:ts,spring:yu,decay:YF};function qF(n){if(Array.isArray(n.to))return ts;if(jf[n.type])return jf[n.type];const e=new Set(Object.keys(n));return e.has("ease")||e.has("duration")&&!e.has("dampingRatio")?ts:e.has("dampingRatio")||e.has("stiffness")||e.has("mass")||e.has("damping")||e.has("restSpeed")||e.has("restDelta")?yu:ts}const wy=1/60*1e3,KF=typeof performance<"u"?()=>performance.now():()=>Date.now(),Ty=typeof window<"u"?n=>window.requestAnimationFrame(n):n=>setTimeout(()=>n(KF()),wy);function ZF(n){let e=[],t=[],i=0,r=!1,s=!1;const o=new WeakSet,a={schedule:(l,c=!1,u=!1)=>{const d=u&&r,h=d?e:t;return c&&o.add(l),h.indexOf(l)===-1&&(h.push(l),d&&r&&(i=e.length)),l},cancel:l=>{const c=t.indexOf(l);c!==-1&&t.splice(c,1),o.delete(l)},process:l=>{if(r){s=!0;return}if(r=!0,[e,t]=[t,e],t.length=0,i=e.length,i)for(let c=0;c<i;c++){const u=e[c];u(l),o.has(u)&&(a.schedule(u),n())}r=!1,s&&(s=!1,a.process(l))}};return a}const GF=40;let Yl=!0,er=!1,ql=!1;const Ui={delta:0,timestamp:0},fr=["read","update","preRender","render","postRender"],ko=fr.reduce((n,e)=>(n[e]=ZF(()=>er=!0),n),{}),QF=fr.reduce((n,e)=>{const t=ko[e];return n[e]=(i,r=!1,s=!1)=>(er||tD(),t.schedule(i,r,s)),n},{}),JF=fr.reduce((n,e)=>(n[e]=ko[e].cancel,n),{});fr.reduce((n,e)=>(n[e]=()=>ko[e].process(Ui),n),{});const eD=n=>ko[n].process(Ui),Sy=n=>{er=!1,Ui.delta=Yl?wy:Math.max(Math.min(n-Ui.timestamp,GF),1),Ui.timestamp=n,ql=!0,fr.forEach(eD),ql=!1,er&&(Yl=!1,Ty(Sy))},tD=()=>{er=!0,Yl=!0,ql||Ty(Sy)},nD=QF;function Ey(n,e,t=0){return n-e-t}function iD(n,e,t=0,i=!0){return i?Ey(e+-n,e,t):e-(n-e)+t}function rD(n,e,t,i){return i?n>=e+t:n<=-t}const sD=n=>{const e=({delta:t})=>n(t);return{start:()=>nD.update(e,!0),stop:()=>JF.update(e)}};function oD(n){var e,t,{from:i,autoplay:r=!0,driver:s=sD,elapsed:o=0,repeat:a=0,repeatType:l="loop",repeatDelay:c=0,onPlay:u,onStop:d,onComplete:h,onRepeat:f,onUpdate:p}=n,g=ip(n,["from","autoplay","driver","elapsed","repeat","repeatType","repeatDelay","onPlay","onStop","onComplete","onRepeat","onUpdate"]);let{to:_}=g,b,w=0,x=g.duration,y,S=!1,I=!0,F;const D=qF(g);!((t=(e=D).needsInterpolation)===null||t===void 0)&&t.call(e,i,_)&&(F=vy([0,100],[i,_],{clamp:!1}),i=0,_=100);const B=D(Object.assign(Object.assign({},g),{from:i,to:_}));function U(){w++,l==="reverse"?(I=w%2===0,o=iD(o,x,c,I)):(o=Ey(o,x,c),l==="mirror"&&B.flipTarget()),S=!1,f&&f()}function O(){b.stop(),h&&h()}function H(z){if(I||(z=-z),o+=z,!S){const te=B.next(Math.max(0,o));y=te.value,F&&(y=F(y)),S=I?te.done:o<=0}p==null||p(y),S&&(w===0&&(x??(x=o)),w<a?rD(o,x,c,I)&&U():O())}function $(){u==null||u(),b=s(H),b.start()}return r&&$(),{stop:()=>{d==null||d(),b.stop()}}}class Nn{static extractSubtree(e,t){if(!e)throw new Error("Node is required for subtree extraction");const i=this._cloneNode(e),r={...t,name:t.name?`${t.name}_subtree_${e.data.name||"node"}`:`subtree_${e.data.name||"node"}`,originalTreeName:t.name,isSubtree:!0,subtreeRoot:e.data.name||"unnamed_node",parentTreeData:t};return r.newick=this._nodeToNewick(i),r}static _cloneNode(e){const i={data:{...e.data},depth:0,height:e.height,parent:null,children:null};return e.children&&e.children.length>0&&(i.children=e.children.map(r=>{const s=this._cloneNode(r);return s.parent=i,s.depth=i.depth+1,s})),i}static _nodeToNewick(e){if(!e.children||e.children.length===0){const o=e.data.name||"",a=e.data.branch_length||e.data.branchLength||"";return a?`${o}:${a}`:o}const t=e.children.map(o=>this._nodeToNewick(o)).join(","),i=e.data.name||"",r=e.data.branch_length||e.data.branchLength||"",s=`(${t})${i}`;return r?`${s}:${r}`:s}static getDescendants(e){const t=[e];return e.children&&e.children.forEach(i=>{t.push(...this.getDescendants(i))}),t}static getLeaves(e){if(!e.children||e.children.length===0)return[e];const t=[];return e.children.forEach(i=>{t.push(...this.getLeaves(i))}),t}static getSubtreeStats(e){const t=this.getDescendants(e),i=this.getLeaves(e);return{totalNodes:t.length,leafCount:i.length,internalNodes:t.length-i.length,maxDepth:Math.max(...t.map(r=>r.depth||0)),rootName:e.data.name||"unnamed"}}static isValidSubtreeRoot(e,t=3){return!e.children||e.children.length===0?!1:this.getDescendants(e).length>=t}static nodeToNewick(e){return this._nodeToNewick(e)}static getNodePath(e){const t=[];let i=e;for(;i;)t.unshift(i.data.name||`depth_${i.depth}`),i=i.parent;return t}static createBreadcrumb(e,t=" > "){return this.getNodePath(e).join(t)}}class aD{constructor(){this.menu=null,this.currentNode=null,this.currentTreeData=null,this.isVisible=!1,this._createMenuElement(),this._attachEventListeners()}_createMenuElement(){this.menu=document.createElement("div"),this.menu.id="node-context-menu",this.menu.className="node-context-menu md-elevation-2",this.menu.style.cssText=`
      position: fixed;
      background: var(--md-sys-color-surface-container, #fff);
      border-radius: var(--md-sys-shape-corner-medium, 12px);
      padding: 8px 0;
      z-index: 99999;
      display: none;
      min-width: 240px;
      font-family: var(--md-sys-typescale-body-medium-font, Roboto, sans-serif);
      font-size: var(--md-sys-typescale-body-medium-size, 14px);
      max-width: 320px;
      overflow: hidden;
      box-shadow: var(--md-sys-elevation-level2, 0 2px 6px rgba(0, 0, 0, 0.15));
    `,this.menu.innerHTML=`
      <div class="context-menu-header">
        <span class="node-name"></span>
        <span class="node-stats"></span>
      </div>
      <div class="context-menu-separator"></div>
      <div class="context-menu-item" data-action="extract-subtree">
        <span class="menu-icon material-icons">content_copy</span>
        <span class="menu-text">Copy Subtree (Newick)</span>
      </div>
      <div class="context-menu-item" data-action="highlight-descendants">
        <span class="menu-icon material-icons">highlight</span>
        <span class="menu-text">Highlight Descendants</span>
      </div>
      <div class="context-menu-item" data-action="focus-node">
        <span class="menu-icon material-icons">center_focus_strong</span>
        <span class="menu-text">Focus on Node</span>
      </div>
      <div class="context-menu-item" data-action="copy-info">
        <span class="menu-icon material-icons">info</span>
        <span class="menu-text">Copy Node Info</span>
      </div>
    `;const e=document.createElement("style");e.textContent=`
      .node-context-menu .context-menu-header {
        padding: 12px 16px;
        font-weight: var(--md-sys-typescale-title-small-weight, 500);
        color: var(--md-sys-color-on-surface-variant);
        font-size: var(--md-sys-typescale-label-large-size, 0.875rem);
        border-bottom: 1px solid var(--md-sys-color-outline-variant, #CAC4D0);
        margin-bottom: 4px;
        background: var(--md-sys-color-surface-container-low, #F7F2FA);
      }

      .node-context-menu .node-name {
        display: block;
        font-weight: var(--md-sys-typescale-title-small-weight, 600);
        color: var(--md-sys-color-on-surface);
        margin-bottom: 4px;
        font-size: var(--md-sys-typescale-title-small-size, 1rem);
      }

      .node-context-menu .node-stats {
        font-size: var(--md-sys-typescale-label-small-size, 0.75rem);
        color: var(--md-sys-color-on-surface-variant);
        opacity: 0.8;
      }

      .node-context-menu .context-menu-separator {
        height: 1px;
        background: var(--md-sys-color-outline-variant, #CAC4D0);
        margin: 0;
      }

      .node-context-menu .context-menu-item {
        display: flex;
        align-items: center;
        padding: 12px 16px;
        cursor: pointer;
        transition: all 0.2s var(--md-sys-motion-easing-standard, cubic-bezier(0.4, 0, 0.2, 1));
        color: var(--md-sys-color-on-surface);
        position: relative;
        min-height: 48px;
      }

      .node-context-menu .context-menu-item::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: var(--md-sys-color-on-surface);
        opacity: 0;
        transition: opacity 0.2s var(--md-sys-motion-easing-standard, cubic-bezier(0.4, 0, 0.2, 1));
        pointer-events: none;
      }

      .node-context-menu .context-menu-item:hover::before {
        opacity: var(--md-sys-state-hover-state-layer-opacity, 0.08);
      }

      .node-context-menu .context-menu-item:active::before {
        opacity: var(--md-sys-state-pressed-state-layer-opacity, 0.12);
      }

      .node-context-menu .context-menu-item.disabled {
        opacity: 0.38;
        cursor: not-allowed;
      }

      .node-context-menu .context-menu-item.disabled::before {
        display: none;
      }

      .node-context-menu .menu-icon {
        margin-right: 16px;
        font-size: 20px;
        color: var(--md-sys-color-on-surface-variant);
        position: relative;
        z-index: 1;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .node-context-menu .menu-text {
        flex: 1;
        color: var(--md-sys-color-on-surface);
        font-size: var(--md-sys-typescale-body-large-size, 1rem);
        line-height: var(--md-sys-typescale-body-large-line-height, 1.5);
        letter-spacing: var(--md-sys-typescale-body-large-tracking, 0.5px);
        position: relative;
        z-index: 1;
      }

      /* Make sure the menu is always visible */
      .node-context-menu {
        visibility: visible !important;
        opacity: 1 !important;
      }
    `,document.head.appendChild(e),document.body.appendChild(this.menu)}_attachEventListeners(){this.menu.addEventListener("click",e=>{console.log("[NodeContextMenu] Menu click event:",e),console.log("[NodeContextMenu] Event target:",e.target);const t=e.target.closest(".context-menu-item");if(console.log("[NodeContextMenu] Closest menu item:",t),!t){console.log("[NodeContextMenu] No menu item found");return}if(t.classList.contains("disabled")){console.log("[NodeContextMenu] Menu item is disabled");return}const i=t.dataset.action;console.log("[NodeContextMenu] Action:",i),this._handleAction(i),this.hide()}),document.addEventListener("click",e=>{this.isVisible&&!this.menu.contains(e.target)&&this.hide()}),document.addEventListener("keydown",e=>{e.key==="Escape"&&this.isVisible&&this.hide()})}show(e,t,i,r){this.currentNode=e,this.currentTreeData=t,this.isVisible=!0,this._updateMenuContent(),this.menu.style.left=`${i}px`,this.menu.style.top=`${r}px`,this.menu.style.display="block",this._adjustPosition(),setTimeout(()=>{console.log("[NodeContextMenu] Menu display after delay:",this.menu.style.display),this.menu.style.display==="none"&&(console.log("[NodeContextMenu] Menu was hidden, showing again"),this.menu.style.display="block")},10)}hide(){this.menu.style.display="none",this.isVisible=!1}_updateMenuContent(){var s;if(!this.currentNode)return;const e=this.menu.querySelector(".node-name"),t=this.menu.querySelector(".node-stats"),i=this.menu.querySelector('[data-action="extract-subtree"]'),r=((s=this.currentNode.data)==null?void 0:s.name)||`Node (depth ${this.currentNode.depth})`;e&&(e.textContent=r);try{const o=Nn.getSubtreeStats(this.currentNode),a=`${o.totalNodes} nodes, ${o.leafCount} leaves`;t&&(t.textContent=a)}catch(o){console.error("[NodeContextMenu] Error getting subtree stats:",o)}try{const o=Nn.isValidSubtreeRoot(this.currentNode);i&&(o?i.classList.remove("disabled"):i.classList.add("disabled"))}catch(o){console.error("[NodeContextMenu] Error checking subtree validity:",o)}}_adjustPosition(){const e=this.menu.getBoundingClientRect(),t=window.innerWidth,i=window.innerHeight;let r=parseInt(this.menu.style.left),s=parseInt(this.menu.style.top);e.right>t&&(r=t-e.width-10),r<10&&(r=10),e.bottom>i&&(s=i-e.height-10),s<10&&(s=10),this.menu.style.left=`${r}px`,this.menu.style.top=`${s}px`}_handleAction(e){if(!(!this.currentNode||!this.currentTreeData))switch(M.getState(),e){case"extract-subtree":console.log("[NodeContextMenu] Calling _extractSubtree"),this._extractSubtree();break;case"highlight-descendants":console.log("[NodeContextMenu] Calling _highlightDescendants"),this._highlightDescendants();break;case"focus-node":console.log("[NodeContextMenu] Calling _focusOnNode"),this._focusOnNode();break;case"copy-info":console.log("[NodeContextMenu] Calling _copyNodeInfo"),this._copyNodeInfo();break;default:console.warn(`Unknown action: ${e}`)}}_extractSubtree(){try{console.log("[NodeContextMenu] _extractSubtree called"),console.log("[NodeContextMenu] Current node:",this.currentNode);const e=Nn.nodeToNewick(this.currentNode);console.log("[NodeContextMenu] Generated newick:",e),navigator.clipboard.writeText(e).then(()=>{var i;const t=((i=this.currentNode.data)==null?void 0:i.name)||`Node (depth ${this.currentNode.depth})`;this._showNotification(`Subtree newick copied to clipboard from ${t}`,"success")}).catch(t=>{var o;const i=document.createElement("textarea");i.value=e,document.body.appendChild(i),i.select();const r=document.execCommand("copy");document.body.removeChild(i);const s=((o=this.currentNode.data)==null?void 0:o.name)||`Node (depth ${this.currentNode.depth})`;this._showNotification(`Subtree newick copied to clipboard (fallback) from ${s}`,"success")})}catch(e){console.error("Failed to extract subtree:",e),this._showNotification("Failed to extract subtree","error")}}_highlightDescendants(){const e=Nn.getDescendants(this.currentNode),t=e.map(r=>r.data.name||`node_${r.depth}_${r.x}_${r.y}`),{setHighlightedNodes:i}=M.getState();i&&i(t),this._showNotification(`Highlighted ${e.length} nodes`,"success")}_focusOnNode(){const{treeController:e}=M.getState();e&&typeof e.focusOnNode=="function"&&e.focusOnNode(this.currentNode)}_copyNodeInfo(){const e=Nn.getSubtreeStats(this.currentNode),t=Nn.createBreadcrumb(this.currentNode),i=`Node: ${this.currentNode.data.name||"unnamed"}
Path: ${t}
Descendants: ${e.totalNodes}
Leaves: ${e.leafCount}
Max Depth: ${e.maxDepth}`;navigator.clipboard.writeText(i).then(()=>{this._showNotification("Node info copied to clipboard","success")}).catch(()=>{console.warn("Failed to copy to clipboard");const r=document.createElement("textarea");r.value=i,document.body.appendChild(r),r.select(),document.execCommand("copy"),document.body.removeChild(r),this._showNotification("Node info copied (fallback)","success")})}_showNotification(e,t="info"){if(window.notifications&&window.notifications.show){window.notifications.show(e,t);return}const i=document.createElement("div");i.textContent=e,i.style.cssText=`
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--md-sys-color-inverse-surface);
      color: var(--md-sys-color-inverse-on-surface);
      padding: 12px 16px;
      border-radius: 8px;
      z-index: 10001;
      font-family: var(--md-sys-typescale-body-medium-font);
    `,document.body.appendChild(i),setTimeout(()=>{i.parentNode&&i.parentNode.removeChild(i)},3e3)}destroy(){this.menu&&this.menu.parentNode&&this.menu.parentNode.removeChild(this.menu),this.menu=null,this.currentNode=null,this.currentTreeData=null,this.isVisible=!1}}class lD{constructor(e,t){this.layoutCalculator=e,this.contextMenu=t}handleNodeClick(e,t,i){const{currentTreeIndex:r,treeList:s}=M.getState(),o=s[r],a=this._findTreeNodeFromLayerData(e.object,o),l=i.getBoundingClientRect(),c=t.center?t.center.x:l.left+(e.x||0),u=t.center?t.center.y:l.top+(e.y||0);this.contextMenu.show(a,o,c,u)}handleNodeHover(e,t){}_findTreeNodeFromLayerData(e,t){const{currentTreeIndex:i}=M.getState(),s=this.layoutCalculator.calculateLayout(t,{treeIndex:i,updateController:!1}).tree.descendants(),[o,a]=e.position,l=.001;return s.find(c=>Math.abs(c.x-o)<l&&Math.abs(c.y-a)<l)||null}}class cD extends gg{constructor(){super(),this.dataConverter=new nF,this.layerManager=new aF,this.treeInterpolator=new uF,this.contextMenu=new aD,this.currentTreeData=null,this.interactionHandler=new lD(this,this.contextMenu),this.deckManager=new sF(this.webglContainer),this.deckManager.onWebGLInitialized(e=>{this.gl=e}),this.deckManager.onError(e=>console.error("[DeckGL Controller] Deck.gl error:",e)),this.deckManager.onNodeClick((e,t)=>this.interactionHandler.handleNodeClick(e,t,this.deckManager.canvas)),this.deckManager.onNodeHover((e,t)=>this.interactionHandler.handleNodeHover(e,t)),this.deckManager.initialize(),this.layerManager.layerStyles.setStyleChangeCallback(()=>this._handleStyleChange()),this._trailHistory=new Map,this._lastInterpolationFromIndex=null,this._lastFocusedTreeIndex=null}startAnimation(){const{play:e}=M.getState();e(),this._animationLoop()}stopAnimation(){this.animationFrameId&&(this.animationFrameId.stop(),this.animationFrameId=null)}_handleStyleChange(){this.renderAllElements()}setCameraMode(e){this.deckManager.setCameraMode(e,{preserveTarget:!0}),this.renderAllElements()}async renderAllElements(e={}){const{currentTreeIndex:t,treeList:i}=M.getState(),r=i[t];this.currentTreeData=r;const s=this.calculateLayout(r,{treeIndex:t,updateController:!0}),o=s.tree.leaves(),{extensionRadius:a,labelRadius:l}=this._getConsistentRadii(s,null,null,o),c=this.dataConverter.convertTreeToLayerData(s.tree,{extensionRadius:a,labelRadius:l,canvasWidth:s.width,canvasHeight:s.height});c.trails=this._buildFlowTrails(c.nodes,c.labels),this._updateLayersEfficiently(c);const{playing:u,autoFitOnTreeChange:d}=M.getState();!u&&d&&this._lastFocusedTreeIndex!==t&&(this.focusOnTree(c.nodes,c.labels),this._lastFocusedTreeIndex=t)}focusOnTree(e,t){var s;const r=[...e,...t||[]].reduce((o,a)=>{const[l,c]=a.position;return o.minX=Math.min(o.minX,l),o.maxX=Math.max(o.maxX,l),o.minY=Math.min(o.minY,c),o.maxY=Math.max(o.maxY,c),o},{minX:1/0,maxX:-1/0,minY:1/0,maxY:-1/0});this.deckManager.fitToBounds(r,{padding:1.25,duration:550,labels:t,getLabelSize:(s=this.layerManager.layerStyles.getLabelSize)==null?void 0:s.bind(this.layerManager.layerStyles)})}applyInterpolationEasing(e,t="linear"){return t==="easeInOut"?xy(e):e}_calculateLayout(e,t){return this.calculateLayout(e,{treeIndex:t,updateController:!1})}async renderInterpolatedFrame(e,t,i,r={}){const{fromTreeIndex:s,toTreeIndex:o}=r;let a=Math.max(0,Math.min(1,i));e===t&&(a=0),this._lastInterpolationFromIndex!==s&&(this._trailHistory.clear(),this._lastInterpolationFromIndex=s),a=this.applyInterpolationEasing(a,"easeInOut");const l=this._calculateLayout(e,s),c=this._calculateLayout(t,o),u=c.tree.leaves(),{extensionRadius:d,labelRadius:h}=this._getConsistentRadii(l,c,null,u),f=this.dataConverter.convertTreeToLayerData(l.tree,{extensionRadius:d,labelRadius:h,canvasWidth:l.width,canvasHeight:l.height}),p=this.dataConverter.convertTreeToLayerData(c.tree,{extensionRadius:d,labelRadius:h,canvasWidth:c.width,canvasHeight:c.height}),g=this.treeInterpolator.interpolateTreeData(f,p,a);g.trails=this._buildFlowTrails(g.nodes,g.labels),this._updateLayersEfficiently(g)}async _updateLayersEfficiently(e){const t=this.layerManager.updateLayersWithData(e);this.deckManager.setLayers(t)}async _updateSmoothAnimation(e){const{movieData:t,updateAnimationProgress:i,getAnimationInterpolationData:r,stop:s}=M.getState();if(!t||i(e)){s();return}const{fromTreeIndex:o,toTreeIndex:a,easedProgress:l}=r(),c=t.interpolated_trees[o],u=t.interpolated_trees[a];await this.renderInterpolatedFrame(c,u,l,{toTreeIndex:a,fromTreeIndex:o})}destroy(){var e,t,i,r;(e=this.animationFrameId)==null||e.stop(),(t=this.contextMenu)==null||t.destroy(),(i=this.deckManager)==null||i.destroy(),(r=this.layerManager)==null||r.destroy()}async _animationLoop(){M.getState().playing&&(this.animationFrameId=oD({from:0,to:1,duration:16.67,repeat:1/0,onUpdate:async()=>{var t;const{playing:e}=M.getState();e?await this._updateSmoothAnimation(performance.now()):((t=this.animationFrameId)==null||t.stop(),this.animationFrameId=null)}}))}async renderScrubFrame(e,t,i,r={}){await this.renderInterpolatedFrame(e,t,i,r)}refreshAllColors(e=!0){var t,i;(i=(t=this.layerManager)==null?void 0:t.layerStyles)==null||i.invalidateCache(),e&&this.renderAllElements()}_buildFlowTrails(e,t){const{trailsEnabled:i,trailLength:r,trailOpacity:s}=M.getState();if(!i)return[];const o=.25,a=u=>{const d=u.id,[h,f]=u.position;let p=this._trailHistory.get(d);p||(p=[]);const g=p[p.length-1];(!g||(h-g.x)*(h-g.x)+(f-g.y)*(f-g.y)>o)&&(p.push({x:h,y:f}),p.length>r&&p.shift(),this._trailHistory.set(d,p))};(e||[]).forEach(a),(t||[]).forEach(a);const l=[],c=(u,d)=>{const h=u.id,f=this._trailHistory.get(h)||[];for(let p=0;p<f.length-1;p++){const g=f[p],_=f[p+1],b=(p+1)/Math.max(1,f.length),w=s*(1-b),x={id:`${h}-seg-${p}`,path:[[g.x,g.y,0],[_.x,_.y,0]],alphaFactor:w,kind:d};d==="label"&&(x.leaf=u.leaf),d==="node"&&(x.node=u),l.push(x)}};return(e||[]).forEach(u=>c(u,"node")),(t||[]).forEach(u=>c(u,"label")),l}}/**
 * @license
 * Copyright 2021 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */class uD extends Uy{renderElevationOrOutline(){return X`<md-elevation part="elevation"></md-elevation>`}}/**
 * @license
 * Copyright 2024 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const dD=me`:host{--_container-color: var(--md-elevated-button-container-color, var(--md-sys-color-surface-container-low, #f7f2fa));--_container-elevation: var(--md-elevated-button-container-elevation, 1);--_container-height: var(--md-elevated-button-container-height, 40px);--_container-shadow-color: var(--md-elevated-button-container-shadow-color, var(--md-sys-color-shadow, #000));--_disabled-container-color: var(--md-elevated-button-disabled-container-color, var(--md-sys-color-on-surface, #1d1b20));--_disabled-container-elevation: var(--md-elevated-button-disabled-container-elevation, 0);--_disabled-container-opacity: var(--md-elevated-button-disabled-container-opacity, 0.12);--_disabled-label-text-color: var(--md-elevated-button-disabled-label-text-color, var(--md-sys-color-on-surface, #1d1b20));--_disabled-label-text-opacity: var(--md-elevated-button-disabled-label-text-opacity, 0.38);--_focus-container-elevation: var(--md-elevated-button-focus-container-elevation, 1);--_focus-label-text-color: var(--md-elevated-button-focus-label-text-color, var(--md-sys-color-primary, #6750a4));--_hover-container-elevation: var(--md-elevated-button-hover-container-elevation, 2);--_hover-label-text-color: var(--md-elevated-button-hover-label-text-color, var(--md-sys-color-primary, #6750a4));--_hover-state-layer-color: var(--md-elevated-button-hover-state-layer-color, var(--md-sys-color-primary, #6750a4));--_hover-state-layer-opacity: var(--md-elevated-button-hover-state-layer-opacity, 0.08);--_label-text-color: var(--md-elevated-button-label-text-color, var(--md-sys-color-primary, #6750a4));--_label-text-font: var(--md-elevated-button-label-text-font, var(--md-sys-typescale-label-large-font, var(--md-ref-typeface-plain, Roboto)));--_label-text-line-height: var(--md-elevated-button-label-text-line-height, var(--md-sys-typescale-label-large-line-height, 1.25rem));--_label-text-size: var(--md-elevated-button-label-text-size, var(--md-sys-typescale-label-large-size, 0.875rem));--_label-text-weight: var(--md-elevated-button-label-text-weight, var(--md-sys-typescale-label-large-weight, var(--md-ref-typeface-weight-medium, 500)));--_pressed-container-elevation: var(--md-elevated-button-pressed-container-elevation, 1);--_pressed-label-text-color: var(--md-elevated-button-pressed-label-text-color, var(--md-sys-color-primary, #6750a4));--_pressed-state-layer-color: var(--md-elevated-button-pressed-state-layer-color, var(--md-sys-color-primary, #6750a4));--_pressed-state-layer-opacity: var(--md-elevated-button-pressed-state-layer-opacity, 0.12);--_disabled-icon-color: var(--md-elevated-button-disabled-icon-color, var(--md-sys-color-on-surface, #1d1b20));--_disabled-icon-opacity: var(--md-elevated-button-disabled-icon-opacity, 0.38);--_focus-icon-color: var(--md-elevated-button-focus-icon-color, var(--md-sys-color-primary, #6750a4));--_hover-icon-color: var(--md-elevated-button-hover-icon-color, var(--md-sys-color-primary, #6750a4));--_icon-color: var(--md-elevated-button-icon-color, var(--md-sys-color-primary, #6750a4));--_icon-size: var(--md-elevated-button-icon-size, 18px);--_pressed-icon-color: var(--md-elevated-button-pressed-icon-color, var(--md-sys-color-primary, #6750a4));--_container-shape-start-start: var(--md-elevated-button-container-shape-start-start, var(--md-elevated-button-container-shape, var(--md-sys-shape-corner-full, 9999px)));--_container-shape-start-end: var(--md-elevated-button-container-shape-start-end, var(--md-elevated-button-container-shape, var(--md-sys-shape-corner-full, 9999px)));--_container-shape-end-end: var(--md-elevated-button-container-shape-end-end, var(--md-elevated-button-container-shape, var(--md-sys-shape-corner-full, 9999px)));--_container-shape-end-start: var(--md-elevated-button-container-shape-end-start, var(--md-elevated-button-container-shape, var(--md-sys-shape-corner-full, 9999px)));--_leading-space: var(--md-elevated-button-leading-space, 24px);--_trailing-space: var(--md-elevated-button-trailing-space, 24px);--_with-leading-icon-leading-space: var(--md-elevated-button-with-leading-icon-leading-space, 16px);--_with-leading-icon-trailing-space: var(--md-elevated-button-with-leading-icon-trailing-space, 24px);--_with-trailing-icon-leading-space: var(--md-elevated-button-with-trailing-icon-leading-space, 24px);--_with-trailing-icon-trailing-space: var(--md-elevated-button-with-trailing-icon-trailing-space, 16px)}
`;/**
 * @license
 * Copyright 2021 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */let Kl=class extends uD{};Kl.styles=[$y,zy,dD];Kl=k([Ve("md-elevated-button")],Kl);/**
 * @license
 * Copyright 2024 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const hD=me`@media(forced-colors: active){:host{--md-slider-active-track-color: CanvasText;--md-slider-disabled-active-track-color: GrayText;--md-slider-disabled-active-track-opacity: 1;--md-slider-disabled-handle-color: GrayText;--md-slider-disabled-inactive-track-color: GrayText;--md-slider-disabled-inactive-track-opacity: 1;--md-slider-focus-handle-color: CanvasText;--md-slider-handle-color: CanvasText;--md-slider-handle-shadow-color: Canvas;--md-slider-hover-handle-color: CanvasText;--md-slider-hover-state-layer-color: Canvas;--md-slider-hover-state-layer-opacity: 1;--md-slider-inactive-track-color: Canvas;--md-slider-label-container-color: Canvas;--md-slider-label-text-color: CanvasText;--md-slider-pressed-handle-color: CanvasText;--md-slider-pressed-state-layer-color: Canvas;--md-slider-pressed-state-layer-opacity: 1;--md-slider-with-overlap-handle-outline-color: CanvasText}.label,.label::before{border:var(--_with-overlap-handle-outline-color) solid var(--_with-overlap-handle-outline-width)}:host(:not([disabled])) .track::before{border:1px solid var(--_active-track-color)}.tickmarks::before{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='CanvasText'%3E%3Ccircle cx='2' cy='2'  r='1'/%3E%3C/svg%3E")}.tickmarks::after{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='Canvas'%3E%3Ccircle cx='2' cy='2' r='1'/%3E%3C/svg%3E")}:host([disabled]) .tickmarks::before{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='Canvas'%3E%3Ccircle cx='2' cy='2'  r='1'/%3E%3C/svg%3E")}}
`;/**
 * @license
 * Copyright 2021 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */function Ca(n,e,t){return n?e(n):t==null?void 0:t(n)}/**
 * @license
 * Copyright 2023 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const fD=tr(rp(op(Le)));class ee extends fD{get nameStart(){return this.getAttribute("name-start")??this.name}set nameStart(e){this.setAttribute("name-start",e)}get nameEnd(){return this.getAttribute("name-end")??this.nameStart}set nameEnd(e){this.setAttribute("name-end",e)}get renderAriaLabelStart(){const{ariaLabel:e}=this;return this.ariaLabelStart||e&&`${e} start`||this.valueLabelStart||String(this.valueStart)}get renderAriaValueTextStart(){return this.ariaValueTextStart||this.valueLabelStart||String(this.valueStart)}get renderAriaLabelEnd(){const{ariaLabel:e}=this;return this.range?this.ariaLabelEnd||e&&`${e} end`||this.valueLabelEnd||String(this.valueEnd):e||this.valueLabel||String(this.value)}get renderAriaValueTextEnd(){if(this.range)return this.ariaValueTextEnd||this.valueLabelEnd||String(this.valueEnd);const{ariaValueText:e}=this;return e||this.valueLabel||String(this.value)}constructor(){super(),this.min=0,this.max=100,this.valueLabel="",this.valueLabelStart="",this.valueLabelEnd="",this.ariaLabelStart="",this.ariaValueTextStart="",this.ariaLabelEnd="",this.ariaValueTextEnd="",this.step=1,this.ticks=!1,this.labeled=!1,this.range=!1,this.handleStartHover=!1,this.handleEndHover=!1,this.startOnTop=!1,this.handlesOverlapping=!1,this.ripplePointerId=1,this.isRedispatchingEvent=!1,this.addEventListener("click",e=>{!Vy(e)||!this.inputEnd||(this.focus(),Wy(this.inputEnd))})}focus(){var e;(e=this.inputEnd)==null||e.focus()}willUpdate(e){var i,r;this.renderValueStart=e.has("valueStart")?this.valueStart:(i=this.inputStart)==null?void 0:i.valueAsNumber;const t=e.has("valueEnd")&&this.range||e.has("value");this.renderValueEnd=t?this.range?this.valueEnd:this.value:(r=this.inputEnd)==null?void 0:r.valueAsNumber,e.get("handleStartHover")!==void 0?this.toggleRippleHover(this.rippleStart,this.handleStartHover):e.get("handleEndHover")!==void 0&&this.toggleRippleHover(this.rippleEnd,this.handleEndHover)}updated(e){var t,i;if(this.range&&(this.renderValueStart=this.inputStart.valueAsNumber),this.renderValueEnd=this.inputEnd.valueAsNumber,this.range){const r=(this.max-this.min)/3;if(this.valueStart===void 0){this.inputStart.valueAsNumber=this.min+r;const s=this.inputStart.valueAsNumber;this.valueStart=this.renderValueStart=s}if(this.valueEnd===void 0){this.inputEnd.valueAsNumber=this.min+2*r;const s=this.inputEnd.valueAsNumber;this.valueEnd=this.renderValueEnd=s}}else this.value??(this.value=this.renderValueEnd);if(e.has("range")||e.has("renderValueStart")||e.has("renderValueEnd")||this.isUpdatePending){const r=(t=this.handleStart)==null?void 0:t.querySelector(".handleNub"),s=(i=this.handleEnd)==null?void 0:i.querySelector(".handleNub");this.handlesOverlapping=pD(r,s)}this.performUpdate()}render(){const e=this.step===0?1:this.step,t=Math.max(this.max-this.min,e),i=this.range?((this.renderValueStart??this.min)-this.min)/t:0,r=((this.renderValueEnd??this.min)-this.min)/t,s={"--_start-fraction":String(i),"--_end-fraction":String(r),"--_tick-count":String(t/e)},o={ranged:this.range},a=this.valueLabelStart||String(this.renderValueStart),l=(this.range?this.valueLabelEnd:this.valueLabel)||String(this.renderValueEnd),c={start:!0,value:this.renderValueStart,ariaLabel:this.renderAriaLabelStart,ariaValueText:this.renderAriaValueTextStart,ariaMin:this.min,ariaMax:this.valueEnd??this.max},u={start:!1,value:this.renderValueEnd,ariaLabel:this.renderAriaLabelEnd,ariaValueText:this.renderAriaValueTextEnd,ariaMin:this.range?this.valueStart??this.min:this.min,ariaMax:this.max},d={start:!0,hover:this.handleStartHover,label:a},h={start:!1,hover:this.handleEndHover,label:l},f={hover:this.handleStartHover||this.handleEndHover};return X` <div
      class="container ${Mt(o)}"
      style=${Vi(s)}>
      ${Ca(this.range,()=>this.renderInput(c))}
      ${this.renderInput(u)} ${this.renderTrack()}
      <div class="handleContainerPadded">
        <div class="handleContainerBlock">
          <div class="handleContainer ${Mt(f)}">
            ${Ca(this.range,()=>this.renderHandle(d))}
            ${this.renderHandle(h)}
          </div>
        </div>
      </div>
    </div>`}renderTrack(){return X`
      <div class="track"></div>
      ${this.ticks?X`<div class="tickmarks"></div>`:ne}
    `}renderLabel(e){return X`<div class="label" aria-hidden="true">
      <span class="labelContent" part="label">${e}</span>
    </div>`}renderHandle({start:e,hover:t,label:i}){const r=!this.disabled&&e===this.startOnTop,s=!this.disabled&&this.handlesOverlapping,o=e?"start":"end";return X`<div
      class="handle ${Mt({[o]:!0,hover:t,onTop:r,isOverlapping:s})}">
      <md-focus-ring part="focus-ring" for=${o}></md-focus-ring>
      <md-ripple
        for=${o}
        class=${o}
        ?disabled=${this.disabled}></md-ripple>
      <div class="handleNub">
        <md-elevation part="elevation"></md-elevation>
      </div>
      ${Ca(this.labeled,()=>this.renderLabel(i))}
    </div>`}renderInput({start:e,value:t,ariaLabel:i,ariaValueText:r,ariaMin:s,ariaMax:o}){const a=e?"start":"end";return X`<input
      type="range"
      class="${Mt({start:e,end:!e})}"
      @focus=${this.handleFocus}
      @pointerdown=${this.handleDown}
      @pointerup=${this.handleUp}
      @pointerenter=${this.handleEnter}
      @pointermove=${this.handleMove}
      @pointerleave=${this.handleLeave}
      @keydown=${this.handleKeydown}
      @keyup=${this.handleKeyup}
      @input=${this.handleInput}
      @change=${this.handleChange}
      id=${a}
      .disabled=${this.disabled}
      .min=${String(this.min)}
      aria-valuemin=${s}
      .max=${String(this.max)}
      aria-valuemax=${o}
      .step=${String(this.step)}
      .value=${String(t)}
      .tabIndex=${e?1:0}
      aria-label=${i||ne}
      aria-valuetext=${r} />`}async toggleRippleHover(e,t){const i=await e;i&&(t?i.handlePointerenter(new PointerEvent("pointerenter",{isPrimary:!0,pointerId:this.ripplePointerId})):i.handlePointerleave(new PointerEvent("pointerleave",{isPrimary:!0,pointerId:this.ripplePointerId})))}handleFocus(e){this.updateOnTop(e.target)}startAction(e){const t=e.target,i=t===this.inputStart?this.inputEnd:this.inputStart;this.action={canFlip:e.type==="pointerdown",flipped:!1,target:t,fixed:i,values:new Map([[t,t.valueAsNumber],[i,i==null?void 0:i.valueAsNumber]])}}finishAction(e){this.action=void 0}handleKeydown(e){this.startAction(e)}handleKeyup(e){this.finishAction(e)}handleDown(e){this.startAction(e),this.ripplePointerId=e.pointerId;const t=e.target===this.inputStart;this.handleStartHover=!this.disabled&&t&&!!this.handleStart,this.handleEndHover=!this.disabled&&!t&&!!this.handleEnd}async handleUp(e){if(!this.action)return;const{target:t,values:i,flipped:r}=this.action;await new Promise(requestAnimationFrame),t!==void 0&&(t.focus(),r&&t.valueAsNumber!==i.get(t)&&t.dispatchEvent(new Event("change",{bubbles:!0}))),this.finishAction(e)}handleMove(e){this.handleStartHover=!this.disabled&&Xf(e,this.handleStart),this.handleEndHover=!this.disabled&&Xf(e,this.handleEnd)}handleEnter(e){this.handleMove(e)}handleLeave(){this.handleStartHover=!1,this.handleEndHover=!1}updateOnTop(e){this.startOnTop=e.classList.contains("start")}needsClamping(){if(!this.action)return!1;const{target:e,fixed:t}=this.action;return e===this.inputStart?e.valueAsNumber>t.valueAsNumber:e.valueAsNumber<t.valueAsNumber}isActionFlipped(){const{action:e}=this;if(!e)return!1;const{target:t,fixed:i,values:r}=e;return e.canFlip&&r.get(t)===r.get(i)&&this.needsClamping()&&(e.canFlip=!1,e.flipped=!0,e.target=i,e.fixed=t),e.flipped}flipAction(){if(!this.action)return!1;const{target:e,fixed:t,values:i}=this.action,r=e.valueAsNumber!==t.valueAsNumber;return e.valueAsNumber=t.valueAsNumber,t.valueAsNumber=i.get(t),r}clampAction(){if(!this.needsClamping()||!this.action)return!1;const{target:e,fixed:t}=this.action;return e.valueAsNumber=t.valueAsNumber,!0}handleInput(e){if(this.isRedispatchingEvent)return;let t=!1,i=!1;this.range&&(this.isActionFlipped()&&(t=!0,i=this.flipAction()),this.clampAction()&&(t=!0,i=!1));const r=e.target;this.updateOnTop(r),this.range?(this.valueStart=this.inputStart.valueAsNumber,this.valueEnd=this.inputEnd.valueAsNumber):this.value=this.inputEnd.valueAsNumber,t&&e.stopPropagation(),i&&(this.isRedispatchingEvent=!0,ns(r,e),this.isRedispatchingEvent=!1)}handleChange(e){const t=e.target,{target:i,values:r}=this.action??{};i&&i.valueAsNumber===r.get(t)||ns(this,e),this.finishAction(e)}[sp](){if(this.range){const e=new FormData;return e.append(this.nameStart,String(this.valueStart)),e.append(this.nameEnd,String(this.valueEnd)),e}return String(this.value)}formResetCallback(){if(this.range){const t=this.getAttribute("value-start");this.valueStart=t!==null?Number(t):void 0;const i=this.getAttribute("value-end");this.valueEnd=i!==null?Number(i):void 0;return}const e=this.getAttribute("value");this.value=e!==null?Number(e):void 0}formStateRestoreCallback(e){if(Array.isArray(e)){const[[,t],[,i]]=e;this.valueStart=Number(t),this.valueEnd=Number(i),this.range=!0;return}this.value=Number(e),this.range=!1}}ee.shadowRootOptions={...Le.shadowRootOptions,delegatesFocus:!0};k([W({type:Number})],ee.prototype,"min",void 0);k([W({type:Number})],ee.prototype,"max",void 0);k([W({type:Number})],ee.prototype,"value",void 0);k([W({type:Number,attribute:"value-start"})],ee.prototype,"valueStart",void 0);k([W({type:Number,attribute:"value-end"})],ee.prototype,"valueEnd",void 0);k([W({attribute:"value-label"})],ee.prototype,"valueLabel",void 0);k([W({attribute:"value-label-start"})],ee.prototype,"valueLabelStart",void 0);k([W({attribute:"value-label-end"})],ee.prototype,"valueLabelEnd",void 0);k([W({attribute:"aria-label-start"})],ee.prototype,"ariaLabelStart",void 0);k([W({attribute:"aria-valuetext-start"})],ee.prototype,"ariaValueTextStart",void 0);k([W({attribute:"aria-label-end"})],ee.prototype,"ariaLabelEnd",void 0);k([W({attribute:"aria-valuetext-end"})],ee.prototype,"ariaValueTextEnd",void 0);k([W({type:Number})],ee.prototype,"step",void 0);k([W({type:Boolean})],ee.prototype,"ticks",void 0);k([W({type:Boolean})],ee.prototype,"labeled",void 0);k([W({type:Boolean})],ee.prototype,"range",void 0);k([Ke("input.start")],ee.prototype,"inputStart",void 0);k([Ke(".handle.start")],ee.prototype,"handleStart",void 0);k([ap("md-ripple.start")],ee.prototype,"rippleStart",void 0);k([Ke("input.end")],ee.prototype,"inputEnd",void 0);k([Ke(".handle.end")],ee.prototype,"handleEnd",void 0);k([ap("md-ripple.end")],ee.prototype,"rippleEnd",void 0);k([tt()],ee.prototype,"handleStartHover",void 0);k([tt()],ee.prototype,"handleEndHover",void 0);k([tt()],ee.prototype,"startOnTop",void 0);k([tt()],ee.prototype,"handlesOverlapping",void 0);k([tt()],ee.prototype,"renderValueStart",void 0);k([tt()],ee.prototype,"renderValueEnd",void 0);function Xf({x:n,y:e},t){if(!t)return!1;const{top:i,left:r,bottom:s,right:o}=t.getBoundingClientRect();return n>=r&&n<=o&&e>=i&&e<=s}function pD(n,e){if(!(n&&e))return!1;const t=n.getBoundingClientRect(),i=e.getBoundingClientRect();return!(t.top>i.bottom||t.right<i.left||t.bottom<i.top||t.left>i.right)}/**
 * @license
 * Copyright 2024 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const gD=me`:host{--_active-track-color: var(--md-slider-active-track-color, var(--md-sys-color-primary, #6750a4));--_active-track-height: var(--md-slider-active-track-height, 4px);--_active-track-shape: var(--md-slider-active-track-shape, var(--md-sys-shape-corner-full, 9999px));--_disabled-active-track-color: var(--md-slider-disabled-active-track-color, var(--md-sys-color-on-surface, #1d1b20));--_disabled-active-track-opacity: var(--md-slider-disabled-active-track-opacity, 0.38);--_disabled-handle-color: var(--md-slider-disabled-handle-color, var(--md-sys-color-on-surface, #1d1b20));--_disabled-handle-elevation: var(--md-slider-disabled-handle-elevation, 0);--_disabled-inactive-track-color: var(--md-slider-disabled-inactive-track-color, var(--md-sys-color-on-surface, #1d1b20));--_disabled-inactive-track-opacity: var(--md-slider-disabled-inactive-track-opacity, 0.12);--_focus-handle-color: var(--md-slider-focus-handle-color, var(--md-sys-color-primary, #6750a4));--_handle-color: var(--md-slider-handle-color, var(--md-sys-color-primary, #6750a4));--_handle-elevation: var(--md-slider-handle-elevation, 1);--_handle-height: var(--md-slider-handle-height, 20px);--_handle-shadow-color: var(--md-slider-handle-shadow-color, var(--md-sys-color-shadow, #000));--_handle-shape: var(--md-slider-handle-shape, var(--md-sys-shape-corner-full, 9999px));--_handle-width: var(--md-slider-handle-width, 20px);--_hover-handle-color: var(--md-slider-hover-handle-color, var(--md-sys-color-primary, #6750a4));--_hover-state-layer-color: var(--md-slider-hover-state-layer-color, var(--md-sys-color-primary, #6750a4));--_hover-state-layer-opacity: var(--md-slider-hover-state-layer-opacity, 0.08);--_inactive-track-color: var(--md-slider-inactive-track-color, var(--md-sys-color-surface-container-highest, #e6e0e9));--_inactive-track-height: var(--md-slider-inactive-track-height, 4px);--_inactive-track-shape: var(--md-slider-inactive-track-shape, var(--md-sys-shape-corner-full, 9999px));--_label-container-color: var(--md-slider-label-container-color, var(--md-sys-color-primary, #6750a4));--_label-container-height: var(--md-slider-label-container-height, 28px);--_pressed-handle-color: var(--md-slider-pressed-handle-color, var(--md-sys-color-primary, #6750a4));--_pressed-state-layer-color: var(--md-slider-pressed-state-layer-color, var(--md-sys-color-primary, #6750a4));--_pressed-state-layer-opacity: var(--md-slider-pressed-state-layer-opacity, 0.12);--_state-layer-size: var(--md-slider-state-layer-size, 40px);--_with-overlap-handle-outline-color: var(--md-slider-with-overlap-handle-outline-color, var(--md-sys-color-on-primary, #fff));--_with-overlap-handle-outline-width: var(--md-slider-with-overlap-handle-outline-width, 1px);--_with-tick-marks-active-container-color: var(--md-slider-with-tick-marks-active-container-color, var(--md-sys-color-on-primary, #fff));--_with-tick-marks-container-size: var(--md-slider-with-tick-marks-container-size, 2px);--_with-tick-marks-disabled-container-color: var(--md-slider-with-tick-marks-disabled-container-color, var(--md-sys-color-on-surface, #1d1b20));--_with-tick-marks-inactive-container-color: var(--md-slider-with-tick-marks-inactive-container-color, var(--md-sys-color-on-surface-variant, #49454f));--_label-text-color: var(--md-slider-label-text-color, var(--md-sys-color-on-primary, #fff));--_label-text-font: var(--md-slider-label-text-font, var(--md-sys-typescale-label-medium-font, var(--md-ref-typeface-plain, Roboto)));--_label-text-line-height: var(--md-slider-label-text-line-height, var(--md-sys-typescale-label-medium-line-height, 1rem));--_label-text-size: var(--md-slider-label-text-size, var(--md-sys-typescale-label-medium-size, 0.75rem));--_label-text-weight: var(--md-slider-label-text-weight, var(--md-sys-typescale-label-medium-weight, var(--md-ref-typeface-weight-medium, 500)));--_start-fraction: 0;--_end-fraction: 0;--_tick-count: 0;display:inline-flex;vertical-align:middle;min-inline-size:200px;--md-elevation-level: var(--_handle-elevation);--md-elevation-shadow-color: var(--_handle-shadow-color)}md-focus-ring{height:48px;inset:unset;width:48px}md-elevation{transition-duration:250ms}@media(prefers-reduced-motion){.label{transition-duration:0}}:host([disabled]){opacity:var(--_disabled-active-track-opacity);--md-elevation-level: var(--_disabled-handle-elevation)}.container{flex:1;display:flex;align-items:center;position:relative;block-size:var(--_state-layer-size);pointer-events:none;touch-action:none}.track,.tickmarks{position:absolute;inset:0;display:flex;align-items:center}.track::before,.tickmarks::before,.track::after,.tickmarks::after{position:absolute;content:"";inset-inline-start:calc(var(--_state-layer-size)/2 - var(--_with-tick-marks-container-size));inset-inline-end:calc(var(--_state-layer-size)/2 - var(--_with-tick-marks-container-size));background-size:calc((100% - var(--_with-tick-marks-container-size)*2)/var(--_tick-count)) 100%}.track::before,.tickmarks::before{block-size:var(--_inactive-track-height);border-radius:var(--_inactive-track-shape)}.track::before{background:var(--_inactive-track-color)}.tickmarks::before{background-image:radial-gradient(circle at var(--_with-tick-marks-container-size) center, var(--_with-tick-marks-inactive-container-color) 0, var(--_with-tick-marks-inactive-container-color) calc(var(--_with-tick-marks-container-size) / 2), transparent calc(var(--_with-tick-marks-container-size) / 2))}:host([disabled]) .track::before{opacity:calc(1/var(--_disabled-active-track-opacity)*var(--_disabled-inactive-track-opacity));background:var(--_disabled-inactive-track-color)}.track::after,.tickmarks::after{block-size:var(--_active-track-height);border-radius:var(--_active-track-shape);clip-path:inset(0 calc(var(--_with-tick-marks-container-size) * min((1 - var(--_end-fraction)) * 1000000000, 1) + (100% - var(--_with-tick-marks-container-size) * 2) * (1 - var(--_end-fraction))) 0 calc(var(--_with-tick-marks-container-size) * min(var(--_start-fraction) * 1000000000, 1) + (100% - var(--_with-tick-marks-container-size) * 2) * var(--_start-fraction)))}.track::after{background:var(--_active-track-color)}.tickmarks::after{background-image:radial-gradient(circle at var(--_with-tick-marks-container-size) center, var(--_with-tick-marks-active-container-color) 0, var(--_with-tick-marks-active-container-color) calc(var(--_with-tick-marks-container-size) / 2), transparent calc(var(--_with-tick-marks-container-size) / 2))}.track:dir(rtl)::after{clip-path:inset(0 calc(var(--_with-tick-marks-container-size) * min(var(--_start-fraction) * 1000000000, 1) + (100% - var(--_with-tick-marks-container-size) * 2) * var(--_start-fraction)) 0 calc(var(--_with-tick-marks-container-size) * min((1 - var(--_end-fraction)) * 1000000000, 1) + (100% - var(--_with-tick-marks-container-size) * 2) * (1 - var(--_end-fraction))))}.tickmarks:dir(rtl)::after{clip-path:inset(0 calc(var(--_with-tick-marks-container-size) * min(var(--_start-fraction) * 1000000000, 1) + (100% - var(--_with-tick-marks-container-size) * 2) * var(--_start-fraction)) 0 calc(var(--_with-tick-marks-container-size) * min((1 - var(--_end-fraction)) * 1000000000, 1) + (100% - var(--_with-tick-marks-container-size) * 2) * (1 - var(--_end-fraction))))}:host([disabled]) .track::after{background:var(--_disabled-active-track-color)}:host([disabled]) .tickmarks::before{background-image:radial-gradient(circle at var(--_with-tick-marks-container-size) center, var(--_with-tick-marks-disabled-container-color) 0, var(--_with-tick-marks-disabled-container-color) calc(var(--_with-tick-marks-container-size) / 2), transparent calc(var(--_with-tick-marks-container-size) / 2))}.handleContainerPadded{position:relative;block-size:100%;inline-size:100%;padding-inline:calc(var(--_state-layer-size)/2)}.handleContainerBlock{position:relative;block-size:100%;inline-size:100%}.handleContainer{position:absolute;inset-block-start:0;inset-block-end:0;inset-inline-start:calc(100%*var(--_start-fraction));inline-size:calc(100%*(var(--_end-fraction) - var(--_start-fraction)))}.handle{position:absolute;block-size:var(--_state-layer-size);inline-size:var(--_state-layer-size);border-radius:var(--_handle-shape);display:flex;place-content:center;place-items:center}.handleNub{position:absolute;height:var(--_handle-height);width:var(--_handle-width);border-radius:var(--_handle-shape);background:var(--_handle-color)}:host([disabled]) .handleNub{background:var(--_disabled-handle-color)}input.end:focus~.handleContainerPadded .handle.end>.handleNub,input.start:focus~.handleContainerPadded .handle.start>.handleNub{background:var(--_focus-handle-color)}.container>.handleContainerPadded .handle.hover>.handleNub{background:var(--_hover-handle-color)}:host(:not([disabled])) input.end:active~.handleContainerPadded .handle.end>.handleNub,:host(:not([disabled])) input.start:active~.handleContainerPadded .handle.start>.handleNub{background:var(--_pressed-handle-color)}.onTop.isOverlapping .label,.onTop.isOverlapping .label::before{outline:var(--_with-overlap-handle-outline-color) solid var(--_with-overlap-handle-outline-width)}.onTop.isOverlapping .handleNub{border:var(--_with-overlap-handle-outline-color) solid var(--_with-overlap-handle-outline-width)}.handle.start{inset-inline-start:calc(0px - var(--_state-layer-size)/2)}.handle.end{inset-inline-end:calc(0px - var(--_state-layer-size)/2)}.label{position:absolute;box-sizing:border-box;display:flex;padding:4px;place-content:center;place-items:center;border-radius:var(--md-sys-shape-corner-full, 9999px);color:var(--_label-text-color);font-family:var(--_label-text-font);font-size:var(--_label-text-size);line-height:var(--_label-text-line-height);font-weight:var(--_label-text-weight);inset-block-end:100%;min-inline-size:var(--_label-container-height);min-block-size:var(--_label-container-height);background:var(--_label-container-color);transition:transform 100ms cubic-bezier(0.2, 0, 0, 1);transform-origin:center bottom;transform:scale(0)}:host(:focus-within) .label,.handleContainer.hover .label,:where(:has(input:active)) .label{transform:scale(1)}.label::before,.label::after{position:absolute;display:block;content:"";background:inherit}.label::before{inline-size:calc(var(--_label-container-height)/2);block-size:calc(var(--_label-container-height)/2);bottom:calc(var(--_label-container-height)/-10);transform:rotate(45deg)}.label::after{inset:0px;border-radius:inherit}.labelContent{z-index:1}input[type=range]{opacity:0;-webkit-tap-highlight-color:rgba(0,0,0,0);position:absolute;box-sizing:border-box;height:100%;width:100%;margin:0;background:rgba(0,0,0,0);cursor:pointer;pointer-events:auto;appearance:none}input[type=range]:focus{outline:none}::-webkit-slider-runnable-track{-webkit-appearance:none}::-moz-range-track{appearance:none}::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;block-size:var(--_handle-height);inline-size:var(--_handle-width);opacity:0;z-index:2}input.end::-webkit-slider-thumb{--_track-and-knob-padding: calc( (var(--_state-layer-size) - var(--_handle-width)) / 2 );--_x-translate: calc( var(--_track-and-knob-padding) - 2 * var(--_end-fraction) * var(--_track-and-knob-padding) );transform:translateX(var(--_x-translate))}input.end:dir(rtl)::-webkit-slider-thumb{transform:translateX(calc(-1 * var(--_x-translate)))}input.start::-webkit-slider-thumb{--_track-and-knob-padding: calc( (var(--_state-layer-size) - var(--_handle-width)) / 2 );--_x-translate: calc( var(--_track-and-knob-padding) - 2 * var(--_start-fraction) * var(--_track-and-knob-padding) );transform:translateX(var(--_x-translate))}input.start:dir(rtl)::-webkit-slider-thumb{transform:translateX(calc(-1 * var(--_x-translate)))}::-moz-range-thumb{appearance:none;block-size:var(--_state-layer-size);inline-size:var(--_state-layer-size);transform:scaleX(0);opacity:0;z-index:2}.ranged input.start{clip-path:inset(0 calc(100% - (var(--_state-layer-size) / 2 + (100% - var(--_state-layer-size)) * (var(--_start-fraction) + (var(--_end-fraction) - var(--_start-fraction)) / 2))) 0 0)}.ranged input.start:dir(rtl){clip-path:inset(0 0 0 calc(100% - (var(--_state-layer-size) / 2 + (100% - var(--_state-layer-size)) * (var(--_start-fraction) + (var(--_end-fraction) - var(--_start-fraction)) / 2))))}.ranged input.end{clip-path:inset(0 0 0 calc(var(--_state-layer-size) / 2 + (100% - var(--_state-layer-size)) * (var(--_start-fraction) + (var(--_end-fraction) - var(--_start-fraction)) / 2)))}.ranged input.end:dir(rtl){clip-path:inset(0 calc(var(--_state-layer-size) / 2 + (100% - var(--_state-layer-size)) * (var(--_start-fraction) + (var(--_end-fraction) - var(--_start-fraction)) / 2)) 0 0)}.onTop{z-index:1}.handle{--md-ripple-hover-color: var(--_hover-state-layer-color);--md-ripple-hover-opacity: var(--_hover-state-layer-opacity);--md-ripple-pressed-color: var(--_pressed-state-layer-color);--md-ripple-pressed-opacity: var(--_pressed-state-layer-opacity)}md-ripple{border-radius:50%;height:var(--_state-layer-size);width:var(--_state-layer-size)}
`;/**
 * @license
 * Copyright 2023 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */let Zl=class extends ee{};Zl.styles=[gD,hD];Zl=k([Ve("md-slider")],Zl);/**
 * @license
 * Copyright 2023 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */function mD(n,e){return new CustomEvent("close-menu",{bubbles:!0,composed:!0,detail:{initiator:n,reason:e,itemPath:[n]}})}const Yf=mD,Gl={SPACE:"Space",ENTER:"Enter"},qf={CLICK_SELECTION:"click-selection",KEYDOWN:"keydown"},_D={ESCAPE:"Escape",SPACE:Gl.SPACE,ENTER:Gl.ENTER};function Ay(n){return Object.values(_D).some(e=>e===n)}function yD(n){return Object.values(Gl).some(e=>e===n)}function Ql(n,e){const t=new Event("md-contains",{bubbles:!0,composed:!0});let i=[];const r=o=>{i=o.composedPath()};return e.addEventListener("md-contains",r),n.dispatchEvent(t),e.removeEventListener("md-contains",r),i.length>0}const lt={NONE:"none",LIST_ROOT:"list-root",FIRST_ITEM:"first-item",LAST_ITEM:"last-item"};/**
 * @license
 * Copyright 2023 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const Kf={END_START:"end-start",END_END:"end-end",START_START:"start-start",START_END:"start-end"};class bD{constructor(e,t){this.host=e,this.getProperties=t,this.surfaceStylesInternal={display:"none"},this.lastValues={isOpen:!1},this.host.addController(this)}get surfaceStyles(){return this.surfaceStylesInternal}async position(){const{surfaceEl:e,anchorEl:t,anchorCorner:i,surfaceCorner:r,positioning:s,xOffset:o,yOffset:a,disableBlockFlip:l,disableInlineFlip:c,repositionStrategy:u}=this.getProperties(),d=i.toLowerCase().trim(),h=r.toLowerCase().trim();if(!e||!t)return;const f=window.innerWidth,p=window.innerHeight,g=document.createElement("div");g.style.opacity="0",g.style.position="fixed",g.style.display="block",g.style.inset="0",document.body.appendChild(g);const _=g.getBoundingClientRect();g.remove();const b=window.innerHeight-_.bottom,w=window.innerWidth-_.right;this.surfaceStylesInternal={display:"block",opacity:"0"},this.host.requestUpdate(),await this.host.updateComplete,e.popover&&e.isConnected&&e.showPopover();const x=e.getSurfacePositionClientRect?e.getSurfacePositionClientRect():e.getBoundingClientRect(),y=t.getSurfacePositionClientRect?t.getSurfacePositionClientRect():t.getBoundingClientRect(),[S,I]=h.split("-"),[F,D]=d.split("-"),B=getComputedStyle(e).direction==="ltr";let{blockInset:U,blockOutOfBoundsCorrection:O,surfaceBlockProperty:H}=this.calculateBlock({surfaceRect:x,anchorRect:y,anchorBlock:F,surfaceBlock:S,yOffset:a,positioning:s,windowInnerHeight:p,blockScrollbarHeight:b});if(O&&!l){const de=S==="start"?"end":"start",Ue=F==="start"?"end":"start",xe=this.calculateBlock({surfaceRect:x,anchorRect:y,anchorBlock:Ue,surfaceBlock:de,yOffset:a,positioning:s,windowInnerHeight:p,blockScrollbarHeight:b});O>xe.blockOutOfBoundsCorrection&&(U=xe.blockInset,O=xe.blockOutOfBoundsCorrection,H=xe.surfaceBlockProperty)}let{inlineInset:$,inlineOutOfBoundsCorrection:z,surfaceInlineProperty:te}=this.calculateInline({surfaceRect:x,anchorRect:y,anchorInline:D,surfaceInline:I,xOffset:o,positioning:s,isLTR:B,windowInnerWidth:f,inlineScrollbarWidth:w});if(z&&!c){const de=I==="start"?"end":"start",Ue=D==="start"?"end":"start",xe=this.calculateInline({surfaceRect:x,anchorRect:y,anchorInline:Ue,surfaceInline:de,xOffset:o,positioning:s,isLTR:B,windowInnerWidth:f,inlineScrollbarWidth:w});Math.abs(z)>Math.abs(xe.inlineOutOfBoundsCorrection)&&($=xe.inlineInset,z=xe.inlineOutOfBoundsCorrection,te=xe.surfaceInlineProperty)}u==="move"&&(U=U-O,$=$-z),this.surfaceStylesInternal={display:"block",opacity:"1",[H]:`${U}px`,[te]:`${$}px`},u==="resize"&&(O&&(this.surfaceStylesInternal.height=`${x.height-O}px`),z&&(this.surfaceStylesInternal.width=`${x.width-z}px`)),this.host.requestUpdate()}calculateBlock(e){const{surfaceRect:t,anchorRect:i,anchorBlock:r,surfaceBlock:s,yOffset:o,positioning:a,windowInnerHeight:l,blockScrollbarHeight:c}=e,u=a==="fixed"||a==="document"?1:0,d=a==="document"?1:0,h=s==="start"?1:0,f=s==="end"?1:0,g=(r!==s?1:0)*i.height+o,_=h*i.top+f*(l-i.bottom-c),b=h*window.scrollY-f*window.scrollY,w=Math.abs(Math.min(0,l-_-g-t.height));return{blockInset:u*_+d*b+g,blockOutOfBoundsCorrection:w,surfaceBlockProperty:s==="start"?"inset-block-start":"inset-block-end"}}calculateInline(e){const{isLTR:t,surfaceInline:i,anchorInline:r,anchorRect:s,surfaceRect:o,xOffset:a,positioning:l,windowInnerWidth:c,inlineScrollbarWidth:u}=e,d=l==="fixed"||l==="document"?1:0,h=l==="document"?1:0,f=t?1:0,p=t?0:1,g=i==="start"?1:0,_=i==="end"?1:0,w=(r!==i?1:0)*s.width+a,x=g*s.left+_*(c-s.right-u),y=g*(c-s.right-u)+_*s.left,S=f*x+p*y,I=g*window.scrollX-_*window.scrollX,F=_*window.scrollX-g*window.scrollX,D=f*I+p*F,B=Math.abs(Math.min(0,c-S-w-o.width)),U=d*S+w+h*D;let O=i==="start"?"inset-inline-start":"inset-inline-end";return(l==="document"||l==="fixed")&&(i==="start"&&t||i==="end"&&!t?O="left":O="right"),{inlineInset:U,inlineOutOfBoundsCorrection:B,surfaceInlineProperty:O}}hostUpdate(){this.onUpdate()}hostUpdated(){this.onUpdate()}async onUpdate(){const e=this.getProperties();let t=!1;for(const[o,a]of Object.entries(e))if(t=t||a!==this.lastValues[o],t)break;const i=this.lastValues.isOpen!==e.isOpen,r=!!e.anchorEl,s=!!e.surfaceEl;t&&r&&s&&(this.lastValues.isOpen=e.isOpen,e.isOpen?(this.lastValues=e,await this.position(),e.onOpen()):i&&(await e.beforeClose(),this.close(),e.onClose()))}close(){this.surfaceStylesInternal={display:"none"},this.host.requestUpdate();const e=this.getProperties().surfaceEl;e!=null&&e.popover&&(e!=null&&e.isConnected)&&e.hidePopover()}}/**
 * @license
 * Copyright 2023 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const Ze={INDEX:0,ITEM:1,TEXT:2};class vD{constructor(e){this.getProperties=e,this.typeaheadRecords=[],this.typaheadBuffer="",this.cancelTypeaheadTimeout=0,this.isTypingAhead=!1,this.lastActiveRecord=null,this.onKeydown=t=>{this.isTypingAhead?this.typeahead(t):this.beginTypeahead(t)},this.endTypeahead=()=>{this.isTypingAhead=!1,this.typaheadBuffer="",this.typeaheadRecords=[]}}get items(){return this.getProperties().getItems()}get active(){return this.getProperties().active}beginTypeahead(e){this.active&&(e.code==="Space"||e.code==="Enter"||e.code.startsWith("Arrow")||e.code==="Escape"||(this.isTypingAhead=!0,this.typeaheadRecords=this.items.map((t,i)=>[i,t,t.typeaheadText.trim().toLowerCase()]),this.lastActiveRecord=this.typeaheadRecords.find(t=>t[Ze.ITEM].tabIndex===0)??null,this.lastActiveRecord&&(this.lastActiveRecord[Ze.ITEM].tabIndex=-1),this.typeahead(e)))}typeahead(e){if(e.defaultPrevented)return;if(clearTimeout(this.cancelTypeaheadTimeout),e.code==="Enter"||e.code.startsWith("Arrow")||e.code==="Escape"){this.endTypeahead(),this.lastActiveRecord&&(this.lastActiveRecord[Ze.ITEM].tabIndex=-1);return}e.code==="Space"&&e.preventDefault(),this.cancelTypeaheadTimeout=setTimeout(this.endTypeahead,this.getProperties().typeaheadBufferTime),this.typaheadBuffer+=e.key.toLowerCase();const t=this.lastActiveRecord?this.lastActiveRecord[Ze.INDEX]:-1,i=this.typeaheadRecords.length,r=l=>(l[Ze.INDEX]+i-t)%i,s=this.typeaheadRecords.filter(l=>!l[Ze.ITEM].disabled&&l[Ze.TEXT].startsWith(this.typaheadBuffer)).sort((l,c)=>r(l)-r(c));if(s.length===0){clearTimeout(this.cancelTypeaheadTimeout),this.lastActiveRecord&&(this.lastActiveRecord[Ze.ITEM].tabIndex=-1),this.endTypeahead();return}const o=this.typaheadBuffer.length===1;let a;this.lastActiveRecord===s[0]&&o?a=s[1]??s[0]:a=s[0],this.lastActiveRecord&&(this.lastActiveRecord[Ze.ITEM].tabIndex=-1),this.lastActiveRecord=a,a[Ze.ITEM].tabIndex=0,a[Ze.ITEM].focus()}}/**
 * @license
 * Copyright 2023 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const Cy=200,Iy=new Set([Pe.ArrowDown,Pe.ArrowUp,Pe.Home,Pe.End]),xD=new Set([Pe.ArrowLeft,Pe.ArrowRight,...Iy]);function wD(n=document){var t;let e=n.activeElement;for(;e&&((t=e==null?void 0:e.shadowRoot)!=null&&t.activeElement);)e=e.shadowRoot.activeElement;return e}class ge extends Le{get openDirection(){return this.menuCorner.split("-")[0]==="start"?"DOWN":"UP"}get anchorElement(){return this.anchor?this.getRootNode().querySelector(`#${this.anchor}`):this.currentAnchorElement}set anchorElement(e){this.currentAnchorElement=e,this.requestUpdate("anchorElement")}constructor(){super(),this.anchor="",this.positioning="absolute",this.quick=!1,this.hasOverflow=!1,this.open=!1,this.xOffset=0,this.yOffset=0,this.noHorizontalFlip=!1,this.noVerticalFlip=!1,this.typeaheadDelay=Cy,this.anchorCorner=Kf.END_START,this.menuCorner=Kf.START_START,this.stayOpenOnOutsideClick=!1,this.stayOpenOnFocusout=!1,this.skipRestoreFocus=!1,this.defaultFocus=lt.FIRST_ITEM,this.noNavigationWrap=!1,this.typeaheadActive=!0,this.isSubmenu=!1,this.pointerPath=[],this.isRepositioning=!1,this.openCloseAnimationSignal=Hy(),this.listController=new Cp({isItem:e=>e.hasAttribute("md-menu-item"),getPossibleItems:()=>this.slotItems,isRtl:()=>getComputedStyle(this).direction==="rtl",deactivateItem:e=>{e.selected=!1,e.tabIndex=-1},activateItem:e=>{e.selected=!0,e.tabIndex=0},isNavigableKey:e=>{if(!this.isSubmenu)return xD.has(e);const i=getComputedStyle(this).direction==="rtl"?Pe.ArrowLeft:Pe.ArrowRight;return e===i?!0:Iy.has(e)},wrapNavigation:()=>!this.noNavigationWrap}),this.lastFocusedElement=null,this.typeaheadController=new vD(()=>({getItems:()=>this.items,typeaheadBufferTime:this.typeaheadDelay,active:this.typeaheadActive})),this.currentAnchorElement=null,this.internals=this.attachInternals(),this.menuPositionController=new bD(this,()=>({anchorCorner:this.anchorCorner,surfaceCorner:this.menuCorner,surfaceEl:this.surfaceEl,anchorEl:this.anchorElement,positioning:this.positioning==="popover"?"document":this.positioning,isOpen:this.open,xOffset:this.xOffset,yOffset:this.yOffset,disableBlockFlip:this.noVerticalFlip,disableInlineFlip:this.noHorizontalFlip,onOpen:this.onOpened,beforeClose:this.beforeClose,onClose:this.onClosed,repositionStrategy:this.hasOverflow&&this.positioning!=="popover"?"move":"resize"})),this.onWindowResize=()=>{this.isRepositioning||this.positioning!=="document"&&this.positioning!=="fixed"&&this.positioning!=="popover"||(this.isRepositioning=!0,this.reposition(),this.isRepositioning=!1)},this.handleFocusout=async e=>{const t=this.anchorElement;if(this.stayOpenOnFocusout||!this.open||this.pointerPath.includes(t))return;if(e.relatedTarget){if(Ql(e.relatedTarget,this)||this.pointerPath.length!==0&&Ql(e.relatedTarget,t))return}else if(this.pointerPath.includes(this))return;const i=this.skipRestoreFocus;this.skipRestoreFocus=!0,this.close(),await this.updateComplete,this.skipRestoreFocus=i},this.onOpened=async()=>{this.lastFocusedElement=wD();const e=this.items,t=Ai(e);t&&this.defaultFocus!==lt.NONE&&(t.item.tabIndex=-1);let i=!this.quick;switch(this.quick?this.dispatchEvent(new Event("opening")):i=!!await this.animateOpen(),this.defaultFocus){case lt.FIRST_ITEM:const r=gc(e);r&&(r.tabIndex=0,r.focus(),await r.updateComplete);break;case lt.LAST_ITEM:const s=Ap(e);s&&(s.tabIndex=0,s.focus(),await s.updateComplete);break;case lt.LIST_ROOT:this.focus();break;default:case lt.NONE:break}i||this.dispatchEvent(new Event("opened"))},this.beforeClose=async()=>{var e,t;this.open=!1,this.skipRestoreFocus||(t=(e=this.lastFocusedElement)==null?void 0:e.focus)==null||t.call(e),this.quick||await this.animateClose()},this.onClosed=()=>{this.quick&&(this.dispatchEvent(new Event("closing")),this.dispatchEvent(new Event("closed")))},this.onWindowPointerdown=e=>{this.pointerPath=e.composedPath()},this.onDocumentClick=e=>{if(!this.open)return;const t=e.composedPath();!this.stayOpenOnOutsideClick&&!t.includes(this)&&!t.includes(this.anchorElement)&&(this.open=!1)},this.internals.role="menu",this.addEventListener("keydown",this.handleKeydown),this.addEventListener("keydown",this.captureKeydown,{capture:!0}),this.addEventListener("focusout",this.handleFocusout)}get items(){return this.listController.items}willUpdate(e){if(e.has("open")){if(this.open){this.removeAttribute("aria-hidden");return}this.setAttribute("aria-hidden","true")}}update(e){e.has("open")&&(this.open?this.setUpGlobalEventListeners():this.cleanUpGlobalEventListeners()),e.has("positioning")&&this.positioning==="popover"&&!this.showPopover&&(this.positioning="fixed"),super.update(e)}connectedCallback(){super.connectedCallback(),this.open&&this.setUpGlobalEventListeners()}disconnectedCallback(){super.disconnectedCallback(),this.cleanUpGlobalEventListeners()}getBoundingClientRect(){return this.surfaceEl?this.surfaceEl.getBoundingClientRect():super.getBoundingClientRect()}getClientRects(){return this.surfaceEl?this.surfaceEl.getClientRects():super.getClientRects()}render(){return this.renderSurface()}renderSurface(){return X`
      <div
        class="menu ${Mt(this.getSurfaceClasses())}"
        style=${Vi(this.menuPositionController.surfaceStyles)}
        popover=${this.positioning==="popover"?"manual":ne}>
        ${this.renderElevation()}
        <div class="items">
          <div class="item-padding"> ${this.renderMenuItems()} </div>
        </div>
      </div>
    `}renderMenuItems(){return X`<slot
      @close-menu=${this.onCloseMenu}
      @deactivate-items=${this.onDeactivateItems}
      @request-activation=${this.onRequestActivation}
      @deactivate-typeahead=${this.handleDeactivateTypeahead}
      @activate-typeahead=${this.handleActivateTypeahead}
      @stay-open-on-focusout=${this.handleStayOpenOnFocusout}
      @close-on-focusout=${this.handleCloseOnFocusout}
      @slotchange=${this.listController.onSlotchange}></slot>`}renderElevation(){return X`<md-elevation part="elevation"></md-elevation>`}getSurfaceClasses(){return{open:this.open,fixed:this.positioning==="fixed","has-overflow":this.hasOverflow}}captureKeydown(e){e.target===this&&!e.defaultPrevented&&Ay(e.code)&&(e.preventDefault(),this.close()),this.typeaheadController.onKeydown(e)}async animateOpen(){const e=this.surfaceEl,t=this.slotEl;if(!e||!t)return!0;const i=this.openDirection;this.dispatchEvent(new Event("opening")),e.classList.toggle("animating",!0);const r=this.openCloseAnimationSignal.start(),s=e.offsetHeight,o=i==="UP",a=this.items,l=500,c=50,u=250,d=(l-u)/a.length,h=e.animate([{height:"0px"},{height:`${s}px`}],{duration:l,easing:pr.EMPHASIZED}),f=t.animate([{transform:o?`translateY(-${s}px)`:""},{transform:""}],{duration:l,easing:pr.EMPHASIZED}),p=e.animate([{opacity:0},{opacity:1}],c),g=[];for(let w=0;w<a.length;w++){const x=o?a.length-1-w:w,y=a[x],S=y.animate([{opacity:0},{opacity:1}],{duration:u,delay:d*w});y.classList.toggle("md-menu-hidden",!0),S.addEventListener("finish",()=>{y.classList.toggle("md-menu-hidden",!1)}),g.push([y,S])}let _=w=>{};const b=new Promise(w=>{_=w});return r.addEventListener("abort",()=>{h.cancel(),f.cancel(),p.cancel(),g.forEach(([w,x])=>{w.classList.toggle("md-menu-hidden",!1),x.cancel()}),_(!0)}),h.addEventListener("finish",()=>{e.classList.toggle("animating",!1),this.openCloseAnimationSignal.finish(),_(!1)}),await b}animateClose(){let e;const t=new Promise(S=>{e=S}),i=this.surfaceEl,r=this.slotEl;if(!i||!r)return e(!1),t;const o=this.openDirection==="UP";this.dispatchEvent(new Event("closing")),i.classList.toggle("animating",!0);const a=this.openCloseAnimationSignal.start(),l=i.offsetHeight,c=this.items,u=150,d=50,h=u-d,f=50,p=50,g=.35,_=(u-p-f)/c.length,b=i.animate([{height:`${l}px`},{height:`${l*g}px`}],{duration:u,easing:pr.EMPHASIZED_ACCELERATE}),w=r.animate([{transform:""},{transform:o?`translateY(-${l*(1-g)}px)`:""}],{duration:u,easing:pr.EMPHASIZED_ACCELERATE}),x=i.animate([{opacity:1},{opacity:0}],{duration:d,delay:h}),y=[];for(let S=0;S<c.length;S++){const I=o?S:c.length-1-S,F=c[I],D=F.animate([{opacity:1},{opacity:0}],{duration:f,delay:p+_*S});D.addEventListener("finish",()=>{F.classList.toggle("md-menu-hidden",!0)}),y.push([F,D])}return a.addEventListener("abort",()=>{b.cancel(),w.cancel(),x.cancel(),y.forEach(([S,I])=>{I.cancel(),S.classList.toggle("md-menu-hidden",!1)}),e(!1)}),b.addEventListener("finish",()=>{i.classList.toggle("animating",!1),y.forEach(([S])=>{S.classList.toggle("md-menu-hidden",!1)}),this.openCloseAnimationSignal.finish(),this.dispatchEvent(new Event("closed")),e(!0)}),t}handleKeydown(e){this.pointerPath=[],this.listController.handleKeydown(e)}setUpGlobalEventListeners(){document.addEventListener("click",this.onDocumentClick,{capture:!0}),window.addEventListener("pointerdown",this.onWindowPointerdown),document.addEventListener("resize",this.onWindowResize,{passive:!0}),window.addEventListener("resize",this.onWindowResize,{passive:!0})}cleanUpGlobalEventListeners(){document.removeEventListener("click",this.onDocumentClick,{capture:!0}),window.removeEventListener("pointerdown",this.onWindowPointerdown),document.removeEventListener("resize",this.onWindowResize),window.removeEventListener("resize",this.onWindowResize)}onCloseMenu(){this.close()}onDeactivateItems(e){e.stopPropagation(),this.listController.onDeactivateItems()}onRequestActivation(e){e.stopPropagation(),this.listController.onRequestActivation(e)}handleDeactivateTypeahead(e){e.stopPropagation(),this.typeaheadActive=!1}handleActivateTypeahead(e){e.stopPropagation(),this.typeaheadActive=!0}handleStayOpenOnFocusout(e){e.stopPropagation(),this.stayOpenOnFocusout=!0}handleCloseOnFocusout(e){e.stopPropagation(),this.stayOpenOnFocusout=!1}close(){this.open=!1,this.slotItems.forEach(t=>{var i;(i=t.close)==null||i.call(t)})}show(){this.open=!0}activateNextItem(){return this.listController.activateNextItem()??null}activatePreviousItem(){return this.listController.activatePreviousItem()??null}reposition(){this.open&&this.menuPositionController.position()}}k([Ke(".menu")],ge.prototype,"surfaceEl",void 0);k([Ke("slot")],ge.prototype,"slotEl",void 0);k([W()],ge.prototype,"anchor",void 0);k([W()],ge.prototype,"positioning",void 0);k([W({type:Boolean})],ge.prototype,"quick",void 0);k([W({type:Boolean,attribute:"has-overflow"})],ge.prototype,"hasOverflow",void 0);k([W({type:Boolean,reflect:!0})],ge.prototype,"open",void 0);k([W({type:Number,attribute:"x-offset"})],ge.prototype,"xOffset",void 0);k([W({type:Number,attribute:"y-offset"})],ge.prototype,"yOffset",void 0);k([W({type:Boolean,attribute:"no-horizontal-flip"})],ge.prototype,"noHorizontalFlip",void 0);k([W({type:Boolean,attribute:"no-vertical-flip"})],ge.prototype,"noVerticalFlip",void 0);k([W({type:Number,attribute:"typeahead-delay"})],ge.prototype,"typeaheadDelay",void 0);k([W({attribute:"anchor-corner"})],ge.prototype,"anchorCorner",void 0);k([W({attribute:"menu-corner"})],ge.prototype,"menuCorner",void 0);k([W({type:Boolean,attribute:"stay-open-on-outside-click"})],ge.prototype,"stayOpenOnOutsideClick",void 0);k([W({type:Boolean,attribute:"stay-open-on-focusout"})],ge.prototype,"stayOpenOnFocusout",void 0);k([W({type:Boolean,attribute:"skip-restore-focus"})],ge.prototype,"skipRestoreFocus",void 0);k([W({attribute:"default-focus"})],ge.prototype,"defaultFocus",void 0);k([W({type:Boolean,attribute:"no-navigation-wrap"})],ge.prototype,"noNavigationWrap",void 0);k([ai({flatten:!0})],ge.prototype,"slotItems",void 0);k([tt()],ge.prototype,"typeaheadActive",void 0);/**
 * @license
 * Copyright 2024 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const TD=me`:host{--md-elevation-level: var(--md-menu-container-elevation, 2);--md-elevation-shadow-color: var(--md-menu-container-shadow-color, var(--md-sys-color-shadow, #000));min-width:112px;color:unset;display:contents}md-focus-ring{--md-focus-ring-shape: var(--md-menu-container-shape, var(--md-sys-shape-corner-extra-small, 4px))}.menu{border-radius:var(--md-menu-container-shape, var(--md-sys-shape-corner-extra-small, 4px));display:none;inset:auto;border:none;padding:0px;overflow:visible;background-color:rgba(0,0,0,0);color:inherit;opacity:0;z-index:20;position:absolute;user-select:none;max-height:inherit;height:inherit;min-width:inherit;max-width:inherit;scrollbar-width:inherit}.menu::backdrop{display:none}.fixed{position:fixed}.items{display:block;list-style-type:none;margin:0;outline:none;box-sizing:border-box;background-color:var(--md-menu-container-color, var(--md-sys-color-surface-container, #f3edf7));height:inherit;max-height:inherit;overflow:auto;min-width:inherit;max-width:inherit;border-radius:inherit;scrollbar-width:inherit}.item-padding{padding-block:var(--md-menu-top-space, 8px) var(--md-menu-bottom-space, 8px)}.has-overflow:not([popover]) .items{overflow:visible}.has-overflow.animating .items,.animating .items{overflow:hidden}.has-overflow.animating .items{pointer-events:none}.animating ::slotted(.md-menu-hidden){opacity:0}slot{display:block;height:inherit;max-height:inherit}::slotted(:is(md-divider,[role=separator])){margin:8px 0}@media(forced-colors: active){.menu{border-style:solid;border-color:CanvasText;border-width:1px}}
`;/**
 * @license
 * Copyright 2022 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */let Jl=class extends ge{};Jl.styles=[TD];Jl=k([Ve("md-menu")],Jl);/**
 * @license
 * Copyright 2023 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */class SD extends jy{computeValidity(e){return this.selectControl||(this.selectControl=document.createElement("select")),Xy(X`<option value=${e.value}></option>`,this.selectControl),this.selectControl.value=e.value,this.selectControl.required=e.required,{validity:this.selectControl.validity,validationMessage:this.selectControl.validationMessage}}equals(e,t){return e.value===t.value&&e.required===t.required}copy({value:e,required:t}){return{value:e,required:t}}}/**
 * @license
 * Copyright 2023 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */function ED(n){const e=[];for(let t=0;t<n.length;t++){const i=n[t];i.selected&&e.push([i,t])}return e}/**
 * @license
 * Copyright 2023 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */var Zf;const $r=Symbol("value"),AD=tr(Yy(qy(rp(op(Le)))));class ae extends AD{get value(){return this[$r]}set value(e){this.lastUserSetValue=e,this.select(e)}get options(){var e;return((e=this.menu)==null?void 0:e.items)??[]}get selectedIndex(){const[e,t]=(this.getSelectedOptions()??[])[0]??[];return t??-1}set selectedIndex(e){this.lastUserSetSelectedIndex=e,this.selectIndex(e)}get selectedOptions(){return(this.getSelectedOptions()??[]).map(([e])=>e)}get hasError(){return this.error||this.nativeError}constructor(){super(),this.quick=!1,this.required=!1,this.errorText="",this.label="",this.noAsterisk=!1,this.supportingText="",this.error=!1,this.menuPositioning="popover",this.clampMenuWidth=!1,this.typeaheadDelay=Cy,this.hasLeadingIcon=!1,this.displayText="",this.menuAlign="start",this[Zf]="",this.lastUserSetValue=null,this.lastUserSetSelectedIndex=null,this.lastSelectedOption=null,this.lastSelectedOptionRecords=[],this.nativeError=!1,this.nativeErrorText="",this.focused=!1,this.open=!1,this.defaultFocus=lt.NONE,this.prevOpen=this.open,this.selectWidth=0,this.addEventListener("focus",this.handleFocus.bind(this)),this.addEventListener("blur",this.handleBlur.bind(this))}select(e){const t=this.options.find(i=>i.value===e);t&&this.selectItem(t)}selectIndex(e){const t=this.options[e];t&&this.selectItem(t)}reset(){for(const e of this.options)e.selected=e.hasAttribute("selected");this.updateValueAndDisplayText(),this.nativeError=!1,this.nativeErrorText=""}[(Zf=$r,Ky)](e){var i;e==null||e.preventDefault();const t=this.getErrorText();this.nativeError=!!e,this.nativeErrorText=this.validationMessage,t===this.getErrorText()&&((i=this.field)==null||i.reannounceError())}update(e){if(this.hasUpdated||this.initUserSelection(),this.prevOpen!==this.open&&this.open){const t=this.getBoundingClientRect();this.selectWidth=t.width}this.prevOpen=this.open,super.update(e)}render(){return X`
      <span
        class="select ${Mt(this.getRenderClasses())}"
        @focusout=${this.handleFocusout}>
        ${this.renderField()} ${this.renderMenu()}
      </span>
    `}async firstUpdated(e){var t;await((t=this.menu)==null?void 0:t.updateComplete),this.lastSelectedOptionRecords.length||this.initUserSelection(),!this.lastSelectedOptionRecords.length&&!nb&&!this.options.length&&setTimeout(()=>{this.updateValueAndDisplayText()}),super.firstUpdated(e)}getRenderClasses(){return{disabled:this.disabled,error:this.error,open:this.open}}renderField(){const e=this.ariaLabel||this.label;return np`
      <${this.fieldTag}
          aria-haspopup="listbox"
          role="combobox"
          part="field"
          id="field"
          tabindex=${this.disabled?"-1":"0"}
          aria-label=${e||ne}
          aria-describedby="description"
          aria-expanded=${this.open?"true":"false"}
          aria-controls="listbox"
          class="field"
          label=${this.label}
          ?no-asterisk=${this.noAsterisk}
          .focused=${this.focused||this.open}
          .populated=${!!this.displayText}
          .disabled=${this.disabled}
          .required=${this.required}
          .error=${this.hasError}
          ?has-start=${this.hasLeadingIcon}
          has-end
          supporting-text=${this.supportingText}
          error-text=${this.getErrorText()}
          @keydown=${this.handleKeydown}
          @click=${this.handleClick}>
         ${this.renderFieldContent()}
         <div id="description" slot="aria-describedby"></div>
      </${this.fieldTag}>`}renderFieldContent(){return[this.renderLeadingIcon(),this.renderLabel(),this.renderTrailingIcon()]}renderLeadingIcon(){return X`
      <span class="icon leading" slot="start">
        <slot name="leading-icon" @slotchange=${this.handleIconChange}></slot>
      </span>
    `}renderTrailingIcon(){return X`
      <span class="icon trailing" slot="end">
        <slot name="trailing-icon" @slotchange=${this.handleIconChange}>
          <svg height="5" viewBox="7 10 10 5" focusable="false">
            <polygon
              class="down"
              stroke="none"
              fill-rule="evenodd"
              points="7 10 12 15 17 10"></polygon>
            <polygon
              class="up"
              stroke="none"
              fill-rule="evenodd"
              points="7 15 12 10 17 15"></polygon>
          </svg>
        </slot>
      </span>
    `}renderLabel(){return X`<div id="label">${this.displayText||X`&nbsp;`}</div>`}renderMenu(){const e=this.label||this.ariaLabel;return X`<div class="menu-wrapper">
      <md-menu
        id="listbox"
        .defaultFocus=${this.defaultFocus}
        role="listbox"
        tabindex="-1"
        aria-label=${e||ne}
        stay-open-on-focusout
        part="menu"
        exportparts="focus-ring: menu-focus-ring"
        anchor="field"
        style=${Vi({"--__menu-min-width":`${this.selectWidth}px`,"--__menu-max-width":this.clampMenuWidth?`${this.selectWidth}px`:void 0})}
        no-navigation-wrap
        .open=${this.open}
        .quick=${this.quick}
        .positioning=${this.menuPositioning}
        .typeaheadDelay=${this.typeaheadDelay}
        .anchorCorner=${this.menuAlign==="start"?"end-start":"end-end"}
        .menuCorner=${this.menuAlign==="start"?"start-start":"start-end"}
        @opening=${this.handleOpening}
        @opened=${this.redispatchEvent}
        @closing=${this.redispatchEvent}
        @closed=${this.handleClosed}
        @close-menu=${this.handleCloseMenu}
        @request-selection=${this.handleRequestSelection}
        @request-deselection=${this.handleRequestDeselection}>
        ${this.renderMenuContent()}
      </md-menu>
    </div>`}renderMenuContent(){return X`<slot></slot>`}handleKeydown(e){var s,o;if(this.open||this.disabled||!this.menu)return;const t=this.menu.typeaheadController,i=e.code==="Space"||e.code==="ArrowDown"||e.code==="ArrowUp"||e.code==="End"||e.code==="Home"||e.code==="Enter";if(!t.isTypingAhead&&i){switch(e.preventDefault(),this.open=!0,e.code){case"Space":case"ArrowDown":case"Enter":this.defaultFocus=lt.NONE;break;case"End":this.defaultFocus=lt.LAST_ITEM;break;case"ArrowUp":case"Home":this.defaultFocus=lt.FIRST_ITEM;break}return}if(e.key.length===1){t.onKeydown(e),e.preventDefault();const{lastActiveRecord:a}=t;if(!a)return;(o=(s=this.labelEl)==null?void 0:s.setAttribute)==null||o.call(s,"aria-live","polite"),this.selectItem(a[Ze.ITEM])&&this.dispatchInteractionEvents()}}handleClick(){this.open=!this.open}handleFocus(){this.focused=!0}handleBlur(){this.focused=!1}handleFocusout(e){e.relatedTarget&&Ql(e.relatedTarget,this)||(this.open=!1)}getSelectedOptions(){if(!this.menu)return this.lastSelectedOptionRecords=[],null;const e=this.menu.items;return this.lastSelectedOptionRecords=ED(e),this.lastSelectedOptionRecords}async getUpdateComplete(){var e;return await((e=this.menu)==null?void 0:e.updateComplete),super.getUpdateComplete()}updateValueAndDisplayText(){const e=this.getSelectedOptions()??[];let t=!1;if(e.length){const[i]=e[0];t=this.lastSelectedOption!==i,this.lastSelectedOption=i,this[$r]=i.value,this.displayText=i.displayText}else t=this.lastSelectedOption!==null,this.lastSelectedOption=null,this[$r]="",this.displayText="";return t}async handleOpening(e){var s,o,a;if((o=(s=this.labelEl)==null?void 0:s.removeAttribute)==null||o.call(s,"aria-live"),this.redispatchEvent(e),this.defaultFocus!==lt.NONE)return;const t=this.menu.items,i=(a=Ai(t))==null?void 0:a.item;let[r]=this.lastSelectedOptionRecords[0]??[null];i&&i!==r&&(i.tabIndex=-1),r=r??t[0],r&&(r.tabIndex=0,r.focus())}redispatchEvent(e){ns(this,e)}handleClosed(e){this.open=!1,this.redispatchEvent(e)}handleCloseMenu(e){const t=e.detail.reason,i=e.detail.itemPath[0];this.open=!1;let r=!1;t.kind==="click-selection"?r=this.selectItem(i):t.kind==="keydown"&&yD(t.key)?r=this.selectItem(i):(i.tabIndex=-1,i.blur()),r&&this.dispatchInteractionEvents()}selectItem(e){return(this.getSelectedOptions()??[]).forEach(([i])=>{e!==i&&(i.selected=!1)}),e.selected=!0,this.updateValueAndDisplayText()}handleRequestSelection(e){const t=e.target;this.lastSelectedOptionRecords.some(([i])=>i===t)||this.selectItem(t)}handleRequestDeselection(e){const t=e.target;this.lastSelectedOptionRecords.some(([i])=>i===t)&&this.updateValueAndDisplayText()}initUserSelection(){this.lastUserSetValue&&!this.lastSelectedOptionRecords.length?this.select(this.lastUserSetValue):this.lastUserSetSelectedIndex!==null&&!this.lastSelectedOptionRecords.length?this.selectIndex(this.lastUserSetSelectedIndex):this.updateValueAndDisplayText()}handleIconChange(){this.hasLeadingIcon=this.leadingIcons.length>0}dispatchInteractionEvents(){this.dispatchEvent(new Event("input",{bubbles:!0,composed:!0})),this.dispatchEvent(new Event("change",{bubbles:!0}))}getErrorText(){return this.error?this.errorText:this.nativeErrorText}[sp](){return this.value}formResetCallback(){this.reset()}formStateRestoreCallback(e){this.value=e}click(){var e;(e=this.field)==null||e.click()}[Zy](){return new SD(()=>this)}[Gy](){return this.field}}ae.shadowRootOptions={...Le.shadowRootOptions,delegatesFocus:!0};k([W({type:Boolean})],ae.prototype,"quick",void 0);k([W({type:Boolean})],ae.prototype,"required",void 0);k([W({type:String,attribute:"error-text"})],ae.prototype,"errorText",void 0);k([W()],ae.prototype,"label",void 0);k([W({type:Boolean,attribute:"no-asterisk"})],ae.prototype,"noAsterisk",void 0);k([W({type:String,attribute:"supporting-text"})],ae.prototype,"supportingText",void 0);k([W({type:Boolean,reflect:!0})],ae.prototype,"error",void 0);k([W({attribute:"menu-positioning"})],ae.prototype,"menuPositioning",void 0);k([W({type:Boolean,attribute:"clamp-menu-width"})],ae.prototype,"clampMenuWidth",void 0);k([W({type:Number,attribute:"typeahead-delay"})],ae.prototype,"typeaheadDelay",void 0);k([W({type:Boolean,attribute:"has-leading-icon"})],ae.prototype,"hasLeadingIcon",void 0);k([W({attribute:"display-text"})],ae.prototype,"displayText",void 0);k([W({attribute:"menu-align"})],ae.prototype,"menuAlign",void 0);k([W()],ae.prototype,"value",null);k([W({type:Number,attribute:"selected-index"})],ae.prototype,"selectedIndex",null);k([tt()],ae.prototype,"nativeError",void 0);k([tt()],ae.prototype,"nativeErrorText",void 0);k([tt()],ae.prototype,"focused",void 0);k([tt()],ae.prototype,"open",void 0);k([tt()],ae.prototype,"defaultFocus",void 0);k([Ke(".field")],ae.prototype,"field",void 0);k([Ke("md-menu")],ae.prototype,"menu",void 0);k([Ke("#label")],ae.prototype,"labelEl",void 0);k([ai({slot:"leading-icon",flatten:!0})],ae.prototype,"leadingIcons",void 0);/**
 * @license
 * Copyright 2023 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */class CD extends ae{constructor(){super(...arguments),this.fieldTag=zr`md-outlined-field`}}/**
 * @license
 * Copyright 2024 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const ID=me`:host{--_text-field-disabled-input-text-color: var(--md-outlined-select-text-field-disabled-input-text-color, var(--md-sys-color-on-surface, #1d1b20));--_text-field-disabled-input-text-opacity: var(--md-outlined-select-text-field-disabled-input-text-opacity, 0.38);--_text-field-disabled-label-text-color: var(--md-outlined-select-text-field-disabled-label-text-color, var(--md-sys-color-on-surface, #1d1b20));--_text-field-disabled-label-text-opacity: var(--md-outlined-select-text-field-disabled-label-text-opacity, 0.38);--_text-field-disabled-leading-icon-color: var(--md-outlined-select-text-field-disabled-leading-icon-color, var(--md-sys-color-on-surface, #1d1b20));--_text-field-disabled-leading-icon-opacity: var(--md-outlined-select-text-field-disabled-leading-icon-opacity, 0.38);--_text-field-disabled-outline-color: var(--md-outlined-select-text-field-disabled-outline-color, var(--md-sys-color-on-surface, #1d1b20));--_text-field-disabled-outline-opacity: var(--md-outlined-select-text-field-disabled-outline-opacity, 0.12);--_text-field-disabled-outline-width: var(--md-outlined-select-text-field-disabled-outline-width, 1px);--_text-field-disabled-supporting-text-color: var(--md-outlined-select-text-field-disabled-supporting-text-color, var(--md-sys-color-on-surface, #1d1b20));--_text-field-disabled-supporting-text-opacity: var(--md-outlined-select-text-field-disabled-supporting-text-opacity, 0.38);--_text-field-disabled-trailing-icon-color: var(--md-outlined-select-text-field-disabled-trailing-icon-color, var(--md-sys-color-on-surface, #1d1b20));--_text-field-disabled-trailing-icon-opacity: var(--md-outlined-select-text-field-disabled-trailing-icon-opacity, 0.38);--_text-field-error-focus-input-text-color: var(--md-outlined-select-text-field-error-focus-input-text-color, var(--md-sys-color-on-surface, #1d1b20));--_text-field-error-focus-label-text-color: var(--md-outlined-select-text-field-error-focus-label-text-color, var(--md-sys-color-error, #b3261e));--_text-field-error-focus-leading-icon-color: var(--md-outlined-select-text-field-error-focus-leading-icon-color, var(--md-sys-color-on-surface-variant, #49454f));--_text-field-error-focus-outline-color: var(--md-outlined-select-text-field-error-focus-outline-color, var(--md-sys-color-error, #b3261e));--_text-field-error-focus-supporting-text-color: var(--md-outlined-select-text-field-error-focus-supporting-text-color, var(--md-sys-color-error, #b3261e));--_text-field-error-focus-trailing-icon-color: var(--md-outlined-select-text-field-error-focus-trailing-icon-color, var(--md-sys-color-error, #b3261e));--_text-field-error-hover-input-text-color: var(--md-outlined-select-text-field-error-hover-input-text-color, var(--md-sys-color-on-surface, #1d1b20));--_text-field-error-hover-label-text-color: var(--md-outlined-select-text-field-error-hover-label-text-color, var(--md-sys-color-on-error-container, #410e0b));--_text-field-error-hover-leading-icon-color: var(--md-outlined-select-text-field-error-hover-leading-icon-color, var(--md-sys-color-on-surface-variant, #49454f));--_text-field-error-hover-outline-color: var(--md-outlined-select-text-field-error-hover-outline-color, var(--md-sys-color-on-error-container, #410e0b));--_text-field-error-hover-supporting-text-color: var(--md-outlined-select-text-field-error-hover-supporting-text-color, var(--md-sys-color-error, #b3261e));--_text-field-error-hover-trailing-icon-color: var(--md-outlined-select-text-field-error-hover-trailing-icon-color, var(--md-sys-color-on-error-container, #410e0b));--_text-field-error-input-text-color: var(--md-outlined-select-text-field-error-input-text-color, var(--md-sys-color-on-surface, #1d1b20));--_text-field-error-label-text-color: var(--md-outlined-select-text-field-error-label-text-color, var(--md-sys-color-error, #b3261e));--_text-field-error-leading-icon-color: var(--md-outlined-select-text-field-error-leading-icon-color, var(--md-sys-color-on-surface-variant, #49454f));--_text-field-error-outline-color: var(--md-outlined-select-text-field-error-outline-color, var(--md-sys-color-error, #b3261e));--_text-field-error-supporting-text-color: var(--md-outlined-select-text-field-error-supporting-text-color, var(--md-sys-color-error, #b3261e));--_text-field-error-trailing-icon-color: var(--md-outlined-select-text-field-error-trailing-icon-color, var(--md-sys-color-error, #b3261e));--_text-field-focus-input-text-color: var(--md-outlined-select-text-field-focus-input-text-color, var(--md-sys-color-on-surface, #1d1b20));--_text-field-focus-label-text-color: var(--md-outlined-select-text-field-focus-label-text-color, var(--md-sys-color-primary, #6750a4));--_text-field-focus-leading-icon-color: var(--md-outlined-select-text-field-focus-leading-icon-color, var(--md-sys-color-on-surface-variant, #49454f));--_text-field-focus-outline-color: var(--md-outlined-select-text-field-focus-outline-color, var(--md-sys-color-primary, #6750a4));--_text-field-focus-outline-width: var(--md-outlined-select-text-field-focus-outline-width, 3px);--_text-field-focus-supporting-text-color: var(--md-outlined-select-text-field-focus-supporting-text-color, var(--md-sys-color-on-surface-variant, #49454f));--_text-field-focus-trailing-icon-color: var(--md-outlined-select-text-field-focus-trailing-icon-color, var(--md-sys-color-primary, #6750a4));--_text-field-hover-input-text-color: var(--md-outlined-select-text-field-hover-input-text-color, var(--md-sys-color-on-surface, #1d1b20));--_text-field-hover-label-text-color: var(--md-outlined-select-text-field-hover-label-text-color, var(--md-sys-color-on-surface, #1d1b20));--_text-field-hover-leading-icon-color: var(--md-outlined-select-text-field-hover-leading-icon-color, var(--md-sys-color-on-surface-variant, #49454f));--_text-field-hover-outline-color: var(--md-outlined-select-text-field-hover-outline-color, var(--md-sys-color-on-surface, #1d1b20));--_text-field-hover-outline-width: var(--md-outlined-select-text-field-hover-outline-width, 1px);--_text-field-hover-supporting-text-color: var(--md-outlined-select-text-field-hover-supporting-text-color, var(--md-sys-color-on-surface-variant, #49454f));--_text-field-hover-trailing-icon-color: var(--md-outlined-select-text-field-hover-trailing-icon-color, var(--md-sys-color-on-surface-variant, #49454f));--_text-field-input-text-color: var(--md-outlined-select-text-field-input-text-color, var(--md-sys-color-on-surface, #1d1b20));--_text-field-input-text-font: var(--md-outlined-select-text-field-input-text-font, var(--md-sys-typescale-body-large-font, var(--md-ref-typeface-plain, Roboto)));--_text-field-input-text-line-height: var(--md-outlined-select-text-field-input-text-line-height, var(--md-sys-typescale-body-large-line-height, 1.5rem));--_text-field-input-text-size: var(--md-outlined-select-text-field-input-text-size, var(--md-sys-typescale-body-large-size, 1rem));--_text-field-input-text-weight: var(--md-outlined-select-text-field-input-text-weight, var(--md-sys-typescale-body-large-weight, var(--md-ref-typeface-weight-regular, 400)));--_text-field-label-text-color: var(--md-outlined-select-text-field-label-text-color, var(--md-sys-color-on-surface-variant, #49454f));--_text-field-label-text-font: var(--md-outlined-select-text-field-label-text-font, var(--md-sys-typescale-body-large-font, var(--md-ref-typeface-plain, Roboto)));--_text-field-label-text-line-height: var(--md-outlined-select-text-field-label-text-line-height, var(--md-sys-typescale-body-large-line-height, 1.5rem));--_text-field-label-text-populated-line-height: var(--md-outlined-select-text-field-label-text-populated-line-height, var(--md-sys-typescale-body-small-line-height, 1rem));--_text-field-label-text-populated-size: var(--md-outlined-select-text-field-label-text-populated-size, var(--md-sys-typescale-body-small-size, 0.75rem));--_text-field-label-text-size: var(--md-outlined-select-text-field-label-text-size, var(--md-sys-typescale-body-large-size, 1rem));--_text-field-label-text-weight: var(--md-outlined-select-text-field-label-text-weight, var(--md-sys-typescale-body-large-weight, var(--md-ref-typeface-weight-regular, 400)));--_text-field-leading-icon-color: var(--md-outlined-select-text-field-leading-icon-color, var(--md-sys-color-on-surface-variant, #49454f));--_text-field-leading-icon-size: var(--md-outlined-select-text-field-leading-icon-size, 24px);--_text-field-outline-color: var(--md-outlined-select-text-field-outline-color, var(--md-sys-color-outline, #79747e));--_text-field-outline-width: var(--md-outlined-select-text-field-outline-width, 1px);--_text-field-supporting-text-color: var(--md-outlined-select-text-field-supporting-text-color, var(--md-sys-color-on-surface-variant, #49454f));--_text-field-supporting-text-font: var(--md-outlined-select-text-field-supporting-text-font, var(--md-sys-typescale-body-small-font, var(--md-ref-typeface-plain, Roboto)));--_text-field-supporting-text-line-height: var(--md-outlined-select-text-field-supporting-text-line-height, var(--md-sys-typescale-body-small-line-height, 1rem));--_text-field-supporting-text-size: var(--md-outlined-select-text-field-supporting-text-size, var(--md-sys-typescale-body-small-size, 0.75rem));--_text-field-supporting-text-weight: var(--md-outlined-select-text-field-supporting-text-weight, var(--md-sys-typescale-body-small-weight, var(--md-ref-typeface-weight-regular, 400)));--_text-field-trailing-icon-color: var(--md-outlined-select-text-field-trailing-icon-color, var(--md-sys-color-on-surface-variant, #49454f));--_text-field-trailing-icon-size: var(--md-outlined-select-text-field-trailing-icon-size, 24px);--_text-field-container-shape-start-start: var(--md-outlined-select-text-field-container-shape-start-start, var(--md-outlined-select-text-field-container-shape, var(--md-sys-shape-corner-extra-small, 4px)));--_text-field-container-shape-start-end: var(--md-outlined-select-text-field-container-shape-start-end, var(--md-outlined-select-text-field-container-shape, var(--md-sys-shape-corner-extra-small, 4px)));--_text-field-container-shape-end-end: var(--md-outlined-select-text-field-container-shape-end-end, var(--md-outlined-select-text-field-container-shape, var(--md-sys-shape-corner-extra-small, 4px)));--_text-field-container-shape-end-start: var(--md-outlined-select-text-field-container-shape-end-start, var(--md-outlined-select-text-field-container-shape, var(--md-sys-shape-corner-extra-small, 4px)));--md-outlined-field-container-shape-end-end: var(--_text-field-container-shape-end-end);--md-outlined-field-container-shape-end-start: var(--_text-field-container-shape-end-start);--md-outlined-field-container-shape-start-end: var(--_text-field-container-shape-start-end);--md-outlined-field-container-shape-start-start: var(--_text-field-container-shape-start-start);--md-outlined-field-content-color: var(--_text-field-input-text-color);--md-outlined-field-content-font: var(--_text-field-input-text-font);--md-outlined-field-content-line-height: var(--_text-field-input-text-line-height);--md-outlined-field-content-size: var(--_text-field-input-text-size);--md-outlined-field-content-weight: var(--_text-field-input-text-weight);--md-outlined-field-disabled-content-color: var(--_text-field-disabled-input-text-color);--md-outlined-field-disabled-content-opacity: var(--_text-field-disabled-input-text-opacity);--md-outlined-field-disabled-label-text-color: var(--_text-field-disabled-label-text-color);--md-outlined-field-disabled-label-text-opacity: var(--_text-field-disabled-label-text-opacity);--md-outlined-field-disabled-leading-content-color: var(--_text-field-disabled-leading-icon-color);--md-outlined-field-disabled-leading-content-opacity: var(--_text-field-disabled-leading-icon-opacity);--md-outlined-field-disabled-outline-color: var(--_text-field-disabled-outline-color);--md-outlined-field-disabled-outline-opacity: var(--_text-field-disabled-outline-opacity);--md-outlined-field-disabled-outline-width: var(--_text-field-disabled-outline-width);--md-outlined-field-disabled-supporting-text-color: var(--_text-field-disabled-supporting-text-color);--md-outlined-field-disabled-supporting-text-opacity: var(--_text-field-disabled-supporting-text-opacity);--md-outlined-field-disabled-trailing-content-color: var(--_text-field-disabled-trailing-icon-color);--md-outlined-field-disabled-trailing-content-opacity: var(--_text-field-disabled-trailing-icon-opacity);--md-outlined-field-error-content-color: var(--_text-field-error-input-text-color);--md-outlined-field-error-focus-content-color: var(--_text-field-error-focus-input-text-color);--md-outlined-field-error-focus-label-text-color: var(--_text-field-error-focus-label-text-color);--md-outlined-field-error-focus-leading-content-color: var(--_text-field-error-focus-leading-icon-color);--md-outlined-field-error-focus-outline-color: var(--_text-field-error-focus-outline-color);--md-outlined-field-error-focus-supporting-text-color: var(--_text-field-error-focus-supporting-text-color);--md-outlined-field-error-focus-trailing-content-color: var(--_text-field-error-focus-trailing-icon-color);--md-outlined-field-error-hover-content-color: var(--_text-field-error-hover-input-text-color);--md-outlined-field-error-hover-label-text-color: var(--_text-field-error-hover-label-text-color);--md-outlined-field-error-hover-leading-content-color: var(--_text-field-error-hover-leading-icon-color);--md-outlined-field-error-hover-outline-color: var(--_text-field-error-hover-outline-color);--md-outlined-field-error-hover-supporting-text-color: var(--_text-field-error-hover-supporting-text-color);--md-outlined-field-error-hover-trailing-content-color: var(--_text-field-error-hover-trailing-icon-color);--md-outlined-field-error-label-text-color: var(--_text-field-error-label-text-color);--md-outlined-field-error-leading-content-color: var(--_text-field-error-leading-icon-color);--md-outlined-field-error-outline-color: var(--_text-field-error-outline-color);--md-outlined-field-error-supporting-text-color: var(--_text-field-error-supporting-text-color);--md-outlined-field-error-trailing-content-color: var(--_text-field-error-trailing-icon-color);--md-outlined-field-focus-content-color: var(--_text-field-focus-input-text-color);--md-outlined-field-focus-label-text-color: var(--_text-field-focus-label-text-color);--md-outlined-field-focus-leading-content-color: var(--_text-field-focus-leading-icon-color);--md-outlined-field-focus-outline-color: var(--_text-field-focus-outline-color);--md-outlined-field-focus-outline-width: var(--_text-field-focus-outline-width);--md-outlined-field-focus-supporting-text-color: var(--_text-field-focus-supporting-text-color);--md-outlined-field-focus-trailing-content-color: var(--_text-field-focus-trailing-icon-color);--md-outlined-field-hover-content-color: var(--_text-field-hover-input-text-color);--md-outlined-field-hover-label-text-color: var(--_text-field-hover-label-text-color);--md-outlined-field-hover-leading-content-color: var(--_text-field-hover-leading-icon-color);--md-outlined-field-hover-outline-color: var(--_text-field-hover-outline-color);--md-outlined-field-hover-outline-width: var(--_text-field-hover-outline-width);--md-outlined-field-hover-supporting-text-color: var(--_text-field-hover-supporting-text-color);--md-outlined-field-hover-trailing-content-color: var(--_text-field-hover-trailing-icon-color);--md-outlined-field-label-text-color: var(--_text-field-label-text-color);--md-outlined-field-label-text-font: var(--_text-field-label-text-font);--md-outlined-field-label-text-line-height: var(--_text-field-label-text-line-height);--md-outlined-field-label-text-populated-line-height: var(--_text-field-label-text-populated-line-height);--md-outlined-field-label-text-populated-size: var(--_text-field-label-text-populated-size);--md-outlined-field-label-text-size: var(--_text-field-label-text-size);--md-outlined-field-label-text-weight: var(--_text-field-label-text-weight);--md-outlined-field-leading-content-color: var(--_text-field-leading-icon-color);--md-outlined-field-outline-color: var(--_text-field-outline-color);--md-outlined-field-outline-width: var(--_text-field-outline-width);--md-outlined-field-supporting-text-color: var(--_text-field-supporting-text-color);--md-outlined-field-supporting-text-font: var(--_text-field-supporting-text-font);--md-outlined-field-supporting-text-line-height: var(--_text-field-supporting-text-line-height);--md-outlined-field-supporting-text-size: var(--_text-field-supporting-text-size);--md-outlined-field-supporting-text-weight: var(--_text-field-supporting-text-weight);--md-outlined-field-trailing-content-color: var(--_text-field-trailing-icon-color)}[has-start] .icon.leading{font-size:var(--_text-field-leading-icon-size);height:var(--_text-field-leading-icon-size);width:var(--_text-field-leading-icon-size)}.icon.trailing{font-size:var(--_text-field-trailing-icon-size);height:var(--_text-field-trailing-icon-size);width:var(--_text-field-trailing-icon-size)}
`;/**
 * @license
 * Copyright 2024 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const RD=me`:host{color:unset;min-width:210px;display:flex}.field{cursor:default;outline:none}.select{position:relative;flex-direction:column}.icon.trailing svg,.icon ::slotted(*){fill:currentColor}.icon ::slotted(*){width:inherit;height:inherit;font-size:inherit}.icon slot{display:flex;height:100%;width:100%;align-items:center;justify-content:center}.icon.trailing :is(.up,.down){opacity:0;transition:opacity 75ms linear 75ms}.select:not(.open) .down,.select.open .up{opacity:1}.field,.select,md-menu{min-width:inherit;width:inherit;max-width:inherit;display:flex}md-menu{min-width:var(--__menu-min-width);max-width:var(--__menu-max-width, inherit)}.menu-wrapper{width:0px;height:0px;max-width:inherit}md-menu ::slotted(:not[disabled]){cursor:pointer}.field,.select{width:100%}:host{display:inline-flex}:host([disabled]){pointer-events:none}
`;/**
 * @license
 * Copyright 2023 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */let ec=class extends CD{};ec.styles=[RD,ID];ec=k([Ve("md-outlined-select")],ec);/**
 * @license
 * Copyright 2024 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const PD=me`:host{display:flex;--md-ripple-hover-color: var(--md-menu-item-hover-state-layer-color, var(--md-sys-color-on-surface, #1d1b20));--md-ripple-hover-opacity: var(--md-menu-item-hover-state-layer-opacity, 0.08);--md-ripple-pressed-color: var(--md-menu-item-pressed-state-layer-color, var(--md-sys-color-on-surface, #1d1b20));--md-ripple-pressed-opacity: var(--md-menu-item-pressed-state-layer-opacity, 0.12)}:host([disabled]){opacity:var(--md-menu-item-disabled-opacity, 0.3);pointer-events:none}md-focus-ring{z-index:1;--md-focus-ring-shape: 8px}a,button,li{background:none;border:none;padding:0;margin:0;text-align:unset;text-decoration:none}.list-item{border-radius:inherit;display:flex;flex:1;max-width:inherit;min-width:inherit;outline:none;-webkit-tap-highlight-color:rgba(0,0,0,0)}.list-item:not(.disabled){cursor:pointer}[slot=container]{pointer-events:none}md-ripple{border-radius:inherit}md-item{border-radius:inherit;flex:1;color:var(--md-menu-item-label-text-color, var(--md-sys-color-on-surface, #1d1b20));font-family:var(--md-menu-item-label-text-font, var(--md-sys-typescale-body-large-font, var(--md-ref-typeface-plain, Roboto)));font-size:var(--md-menu-item-label-text-size, var(--md-sys-typescale-body-large-size, 1rem));line-height:var(--md-menu-item-label-text-line-height, var(--md-sys-typescale-body-large-line-height, 1.5rem));font-weight:var(--md-menu-item-label-text-weight, var(--md-sys-typescale-body-large-weight, var(--md-ref-typeface-weight-regular, 400)));min-height:var(--md-menu-item-one-line-container-height, 56px);padding-top:var(--md-menu-item-top-space, 12px);padding-bottom:var(--md-menu-item-bottom-space, 12px);padding-inline-start:var(--md-menu-item-leading-space, 16px);padding-inline-end:var(--md-menu-item-trailing-space, 16px)}md-item[multiline]{min-height:var(--md-menu-item-two-line-container-height, 72px)}[slot=supporting-text]{color:var(--md-menu-item-supporting-text-color, var(--md-sys-color-on-surface-variant, #49454f));font-family:var(--md-menu-item-supporting-text-font, var(--md-sys-typescale-body-medium-font, var(--md-ref-typeface-plain, Roboto)));font-size:var(--md-menu-item-supporting-text-size, var(--md-sys-typescale-body-medium-size, 0.875rem));line-height:var(--md-menu-item-supporting-text-line-height, var(--md-sys-typescale-body-medium-line-height, 1.25rem));font-weight:var(--md-menu-item-supporting-text-weight, var(--md-sys-typescale-body-medium-weight, var(--md-ref-typeface-weight-regular, 400)))}[slot=trailing-supporting-text]{color:var(--md-menu-item-trailing-supporting-text-color, var(--md-sys-color-on-surface-variant, #49454f));font-family:var(--md-menu-item-trailing-supporting-text-font, var(--md-sys-typescale-label-small-font, var(--md-ref-typeface-plain, Roboto)));font-size:var(--md-menu-item-trailing-supporting-text-size, var(--md-sys-typescale-label-small-size, 0.6875rem));line-height:var(--md-menu-item-trailing-supporting-text-line-height, var(--md-sys-typescale-label-small-line-height, 1rem));font-weight:var(--md-menu-item-trailing-supporting-text-weight, var(--md-sys-typescale-label-small-weight, var(--md-ref-typeface-weight-medium, 500)))}:is([slot=start],[slot=end])::slotted(*){fill:currentColor}[slot=start]{color:var(--md-menu-item-leading-icon-color, var(--md-sys-color-on-surface-variant, #49454f))}[slot=end]{color:var(--md-menu-item-trailing-icon-color, var(--md-sys-color-on-surface-variant, #49454f))}.list-item{background-color:var(--md-menu-item-container-color, transparent)}.list-item.selected{background-color:var(--md-menu-item-selected-container-color, var(--md-sys-color-secondary-container, #e8def8))}.selected:not(.disabled) ::slotted(*){color:var(--md-menu-item-selected-label-text-color, var(--md-sys-color-on-secondary-container, #1d192b))}@media(forced-colors: active){:host([disabled]),:host([disabled]) slot{color:GrayText;opacity:1}.list-item{position:relative}.list-item.selected::before{content:"";position:absolute;inset:0;box-sizing:border-box;border-radius:inherit;pointer-events:none;border:3px double CanvasText}}
`;/**
 * @license
 * Copyright 2023 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */class MD{constructor(e,t){this.host=e,this.internalTypeaheadText=null,this.onClick=()=>{this.host.keepOpen||this.host.dispatchEvent(Yf(this.host,{kind:qf.CLICK_SELECTION}))},this.onKeydown=i=>{if(this.host.href&&i.code==="Enter"){const s=this.getInteractiveElement();s instanceof HTMLAnchorElement&&s.click()}if(i.defaultPrevented)return;const r=i.code;this.host.keepOpen&&r!=="Escape"||Ay(r)&&(i.preventDefault(),this.host.dispatchEvent(Yf(this.host,{kind:qf.KEYDOWN,key:r})))},this.getHeadlineElements=t.getHeadlineElements,this.getSupportingTextElements=t.getSupportingTextElements,this.getDefaultElements=t.getDefaultElements,this.getInteractiveElement=t.getInteractiveElement,this.host.addController(this)}get typeaheadText(){if(this.internalTypeaheadText!==null)return this.internalTypeaheadText;const e=this.getHeadlineElements(),t=[];return e.forEach(i=>{i.textContent&&i.textContent.trim()&&t.push(i.textContent.trim())}),t.length===0&&this.getDefaultElements().forEach(i=>{i.textContent&&i.textContent.trim()&&t.push(i.textContent.trim())}),t.length===0&&this.getSupportingTextElements().forEach(i=>{i.textContent&&i.textContent.trim()&&t.push(i.textContent.trim())}),t.join(" ")}get tagName(){switch(this.host.type){case"link":return"a";case"button":return"button";default:case"menuitem":case"option":return"li"}}get role(){return this.host.type==="option"?"option":"menuitem"}hostConnected(){this.host.toggleAttribute("md-menu-item",!0)}hostUpdate(){this.host.href&&(this.host.type="link")}setTypeaheadText(e){this.internalTypeaheadText=e}}/**
 * @license
 * Copyright 2023 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */function kD(){return new Event("request-selection",{bubbles:!0,composed:!0})}function OD(){return new Event("request-deselection",{bubbles:!0,composed:!0})}class ND{get role(){return this.menuItemController.role}get typeaheadText(){return this.menuItemController.typeaheadText}setTypeaheadText(e){this.menuItemController.setTypeaheadText(e)}get displayText(){return this.internalDisplayText!==null?this.internalDisplayText:this.menuItemController.typeaheadText}setDisplayText(e){this.internalDisplayText=e}constructor(e,t){this.host=e,this.internalDisplayText=null,this.firstUpdate=!0,this.onClick=()=>{this.menuItemController.onClick()},this.onKeydown=i=>{this.menuItemController.onKeydown(i)},this.lastSelected=this.host.selected,this.menuItemController=new MD(e,t),e.addController(this)}hostUpdate(){this.lastSelected!==this.host.selected&&(this.host.ariaSelected=this.host.selected?"true":"false")}hostUpdated(){this.lastSelected!==this.host.selected&&!this.firstUpdate&&(this.host.selected?this.host.dispatchEvent(kD()):this.host.dispatchEvent(OD())),this.lastSelected=this.host.selected,this.firstUpdate=!1}}/**
 * @license
 * Copyright 2023 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const FD=tr(Le);class it extends FD{constructor(){super(...arguments),this.disabled=!1,this.isMenuItem=!0,this.selected=!1,this.value="",this.type="option",this.selectOptionController=new ND(this,{getHeadlineElements:()=>this.headlineElements,getSupportingTextElements:()=>this.supportingTextElements,getDefaultElements:()=>this.defaultElements,getInteractiveElement:()=>this.listItemRoot})}get typeaheadText(){return this.selectOptionController.typeaheadText}set typeaheadText(e){this.selectOptionController.setTypeaheadText(e)}get displayText(){return this.selectOptionController.displayText}set displayText(e){this.selectOptionController.setDisplayText(e)}render(){return this.renderListItem(X`
      <md-item>
        <div slot="container">
          ${this.renderRipple()} ${this.renderFocusRing()}
        </div>
        <slot name="start" slot="start"></slot>
        <slot name="end" slot="end"></slot>
        ${this.renderBody()}
      </md-item>
    `)}renderListItem(e){return X`
      <li
        id="item"
        tabindex=${this.disabled?-1:0}
        role=${this.selectOptionController.role}
        aria-label=${this.ariaLabel||ne}
        aria-selected=${this.ariaSelected||ne}
        aria-checked=${this.ariaChecked||ne}
        aria-expanded=${this.ariaExpanded||ne}
        aria-haspopup=${this.ariaHasPopup||ne}
        class="list-item ${Mt(this.getRenderClasses())}"
        @click=${this.selectOptionController.onClick}
        @keydown=${this.selectOptionController.onKeydown}
        >${e}</li
      >
    `}renderRipple(){return X` <md-ripple
      part="ripple"
      for="item"
      ?disabled=${this.disabled}></md-ripple>`}renderFocusRing(){return X` <md-focus-ring
      part="focus-ring"
      for="item"
      inward></md-focus-ring>`}getRenderClasses(){return{disabled:this.disabled,selected:this.selected}}renderBody(){return X`
      <slot></slot>
      <slot name="overline" slot="overline"></slot>
      <slot name="headline" slot="headline"></slot>
      <slot name="supporting-text" slot="supporting-text"></slot>
      <slot
        name="trailing-supporting-text"
        slot="trailing-supporting-text"></slot>
    `}focus(){var e;(e=this.listItemRoot)==null||e.focus()}}it.shadowRootOptions={...Le.shadowRootOptions,delegatesFocus:!0};k([W({type:Boolean,reflect:!0})],it.prototype,"disabled",void 0);k([W({type:Boolean,attribute:"md-menu-item",reflect:!0})],it.prototype,"isMenuItem",void 0);k([W({type:Boolean})],it.prototype,"selected",void 0);k([W()],it.prototype,"value",void 0);k([Ke(".list-item")],it.prototype,"listItemRoot",void 0);k([ai({slot:"headline"})],it.prototype,"headlineElements",void 0);k([ai({slot:"supporting-text"})],it.prototype,"supportingTextElements",void 0);k([tb({slot:""})],it.prototype,"defaultElements",void 0);k([W({attribute:"typeahead-text"})],it.prototype,"typeaheadText",null);k([W({attribute:"display-text"})],it.prototype,"displayText",null);/**
 * @license
 * Copyright 2023 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */let tc=class extends it{};tc.styles=[PD];tc=k([Ve("md-select-option")],tc);/**
 * @license
 * Copyright 2023 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */class ui extends Ft{constructor(){super(...arguments),this.elevated=!1,this.href="",this.download="",this.target=""}get primaryId(){return this.href?"link":"button"}get rippleDisabled(){return!this.href&&(this.disabled||this.softDisabled)}getContainerClasses(){return{...super.getContainerClasses(),disabled:!this.href&&(this.disabled||this.softDisabled),elevated:this.elevated,link:!!this.href}}renderPrimaryAction(e){const{ariaLabel:t}=this;return this.href?X`
        <a
          class="primary action"
          id="link"
          aria-label=${t||ne}
          href=${this.href}
          download=${this.download||ne}
          target=${this.target||ne}
          >${e}</a
        >
      `:X`
      <button
        class="primary action"
        id="button"
        aria-label=${t||ne}
        aria-disabled=${this.softDisabled||ne}
        ?disabled=${this.disabled&&!this.alwaysFocusable}
        type="button"
        >${e}</button
      >
    `}renderOutline(){return this.elevated?X`<md-elevation part="elevation"></md-elevation>`:super.renderOutline()}}k([W({type:Boolean})],ui.prototype,"elevated",void 0);k([W()],ui.prototype,"href",void 0);k([W()],ui.prototype,"download",void 0);k([W()],ui.prototype,"target",void 0);/**
 * @license
 * Copyright 2024 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const DD=me`:host{--_container-height: var(--md-assist-chip-container-height, 32px);--_disabled-label-text-color: var(--md-assist-chip-disabled-label-text-color, var(--md-sys-color-on-surface, #1d1b20));--_disabled-label-text-opacity: var(--md-assist-chip-disabled-label-text-opacity, 0.38);--_elevated-container-color: var(--md-assist-chip-elevated-container-color, var(--md-sys-color-surface-container-low, #f7f2fa));--_elevated-container-elevation: var(--md-assist-chip-elevated-container-elevation, 1);--_elevated-container-shadow-color: var(--md-assist-chip-elevated-container-shadow-color, var(--md-sys-color-shadow, #000));--_elevated-disabled-container-color: var(--md-assist-chip-elevated-disabled-container-color, var(--md-sys-color-on-surface, #1d1b20));--_elevated-disabled-container-elevation: var(--md-assist-chip-elevated-disabled-container-elevation, 0);--_elevated-disabled-container-opacity: var(--md-assist-chip-elevated-disabled-container-opacity, 0.12);--_elevated-focus-container-elevation: var(--md-assist-chip-elevated-focus-container-elevation, 1);--_elevated-hover-container-elevation: var(--md-assist-chip-elevated-hover-container-elevation, 2);--_elevated-pressed-container-elevation: var(--md-assist-chip-elevated-pressed-container-elevation, 1);--_focus-label-text-color: var(--md-assist-chip-focus-label-text-color, var(--md-sys-color-on-surface, #1d1b20));--_hover-label-text-color: var(--md-assist-chip-hover-label-text-color, var(--md-sys-color-on-surface, #1d1b20));--_hover-state-layer-color: var(--md-assist-chip-hover-state-layer-color, var(--md-sys-color-on-surface, #1d1b20));--_hover-state-layer-opacity: var(--md-assist-chip-hover-state-layer-opacity, 0.08);--_label-text-color: var(--md-assist-chip-label-text-color, var(--md-sys-color-on-surface, #1d1b20));--_label-text-font: var(--md-assist-chip-label-text-font, var(--md-sys-typescale-label-large-font, var(--md-ref-typeface-plain, Roboto)));--_label-text-line-height: var(--md-assist-chip-label-text-line-height, var(--md-sys-typescale-label-large-line-height, 1.25rem));--_label-text-size: var(--md-assist-chip-label-text-size, var(--md-sys-typescale-label-large-size, 0.875rem));--_label-text-weight: var(--md-assist-chip-label-text-weight, var(--md-sys-typescale-label-large-weight, var(--md-ref-typeface-weight-medium, 500)));--_pressed-label-text-color: var(--md-assist-chip-pressed-label-text-color, var(--md-sys-color-on-surface, #1d1b20));--_pressed-state-layer-color: var(--md-assist-chip-pressed-state-layer-color, var(--md-sys-color-on-surface, #1d1b20));--_pressed-state-layer-opacity: var(--md-assist-chip-pressed-state-layer-opacity, 0.12);--_disabled-outline-color: var(--md-assist-chip-disabled-outline-color, var(--md-sys-color-on-surface, #1d1b20));--_disabled-outline-opacity: var(--md-assist-chip-disabled-outline-opacity, 0.12);--_focus-outline-color: var(--md-assist-chip-focus-outline-color, var(--md-sys-color-on-surface, #1d1b20));--_outline-color: var(--md-assist-chip-outline-color, var(--md-sys-color-outline, #79747e));--_outline-width: var(--md-assist-chip-outline-width, 1px);--_disabled-leading-icon-color: var(--md-assist-chip-disabled-leading-icon-color, var(--md-sys-color-on-surface, #1d1b20));--_disabled-leading-icon-opacity: var(--md-assist-chip-disabled-leading-icon-opacity, 0.38);--_focus-leading-icon-color: var(--md-assist-chip-focus-leading-icon-color, var(--md-sys-color-primary, #6750a4));--_hover-leading-icon-color: var(--md-assist-chip-hover-leading-icon-color, var(--md-sys-color-primary, #6750a4));--_leading-icon-color: var(--md-assist-chip-leading-icon-color, var(--md-sys-color-primary, #6750a4));--_icon-size: var(--md-assist-chip-icon-size, 18px);--_pressed-leading-icon-color: var(--md-assist-chip-pressed-leading-icon-color, var(--md-sys-color-primary, #6750a4));--_container-shape-start-start: var(--md-assist-chip-container-shape-start-start, var(--md-assist-chip-container-shape, var(--md-sys-shape-corner-small, 8px)));--_container-shape-start-end: var(--md-assist-chip-container-shape-start-end, var(--md-assist-chip-container-shape, var(--md-sys-shape-corner-small, 8px)));--_container-shape-end-end: var(--md-assist-chip-container-shape-end-end, var(--md-assist-chip-container-shape, var(--md-sys-shape-corner-small, 8px)));--_container-shape-end-start: var(--md-assist-chip-container-shape-end-start, var(--md-assist-chip-container-shape, var(--md-sys-shape-corner-small, 8px)));--_leading-space: var(--md-assist-chip-leading-space, 16px);--_trailing-space: var(--md-assist-chip-trailing-space, 16px);--_icon-label-space: var(--md-assist-chip-icon-label-space, 8px);--_with-leading-icon-leading-space: var(--md-assist-chip-with-leading-icon-leading-space, 8px)}@media(forced-colors: active){.link .outline{border-color:ActiveText}}
`;/**
 * @license
 * Copyright 2023 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */let nc=class extends ui{};nc.styles=[pc,fc,DD];nc=k([Ve("md-assist-chip")],nc);/**
 * @license
 * Copyright 2023 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */class BD extends ui{}/**
 * @license
 * Copyright 2024 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const LD=me`:host{--_container-height: var(--md-suggestion-chip-container-height, 32px);--_disabled-label-text-color: var(--md-suggestion-chip-disabled-label-text-color, var(--md-sys-color-on-surface, #1d1b20));--_disabled-label-text-opacity: var(--md-suggestion-chip-disabled-label-text-opacity, 0.38);--_elevated-container-color: var(--md-suggestion-chip-elevated-container-color, var(--md-sys-color-surface-container-low, #f7f2fa));--_elevated-container-elevation: var(--md-suggestion-chip-elevated-container-elevation, 1);--_elevated-container-shadow-color: var(--md-suggestion-chip-elevated-container-shadow-color, var(--md-sys-color-shadow, #000));--_elevated-disabled-container-color: var(--md-suggestion-chip-elevated-disabled-container-color, var(--md-sys-color-on-surface, #1d1b20));--_elevated-disabled-container-elevation: var(--md-suggestion-chip-elevated-disabled-container-elevation, 0);--_elevated-disabled-container-opacity: var(--md-suggestion-chip-elevated-disabled-container-opacity, 0.12);--_elevated-focus-container-elevation: var(--md-suggestion-chip-elevated-focus-container-elevation, 1);--_elevated-hover-container-elevation: var(--md-suggestion-chip-elevated-hover-container-elevation, 2);--_elevated-pressed-container-elevation: var(--md-suggestion-chip-elevated-pressed-container-elevation, 1);--_focus-label-text-color: var(--md-suggestion-chip-focus-label-text-color, var(--md-sys-color-on-surface-variant, #49454f));--_hover-label-text-color: var(--md-suggestion-chip-hover-label-text-color, var(--md-sys-color-on-surface-variant, #49454f));--_hover-state-layer-color: var(--md-suggestion-chip-hover-state-layer-color, var(--md-sys-color-on-surface-variant, #49454f));--_hover-state-layer-opacity: var(--md-suggestion-chip-hover-state-layer-opacity, 0.08);--_label-text-color: var(--md-suggestion-chip-label-text-color, var(--md-sys-color-on-surface-variant, #49454f));--_label-text-font: var(--md-suggestion-chip-label-text-font, var(--md-sys-typescale-label-large-font, var(--md-ref-typeface-plain, Roboto)));--_label-text-line-height: var(--md-suggestion-chip-label-text-line-height, var(--md-sys-typescale-label-large-line-height, 1.25rem));--_label-text-size: var(--md-suggestion-chip-label-text-size, var(--md-sys-typescale-label-large-size, 0.875rem));--_label-text-weight: var(--md-suggestion-chip-label-text-weight, var(--md-sys-typescale-label-large-weight, var(--md-ref-typeface-weight-medium, 500)));--_pressed-label-text-color: var(--md-suggestion-chip-pressed-label-text-color, var(--md-sys-color-on-surface-variant, #49454f));--_pressed-state-layer-color: var(--md-suggestion-chip-pressed-state-layer-color, var(--md-sys-color-on-surface-variant, #49454f));--_pressed-state-layer-opacity: var(--md-suggestion-chip-pressed-state-layer-opacity, 0.12);--_disabled-outline-color: var(--md-suggestion-chip-disabled-outline-color, var(--md-sys-color-on-surface, #1d1b20));--_disabled-outline-opacity: var(--md-suggestion-chip-disabled-outline-opacity, 0.12);--_focus-outline-color: var(--md-suggestion-chip-focus-outline-color, var(--md-sys-color-on-surface-variant, #49454f));--_outline-color: var(--md-suggestion-chip-outline-color, var(--md-sys-color-outline, #79747e));--_outline-width: var(--md-suggestion-chip-outline-width, 1px);--_disabled-leading-icon-color: var(--md-suggestion-chip-disabled-leading-icon-color, var(--md-sys-color-on-surface, #1d1b20));--_disabled-leading-icon-opacity: var(--md-suggestion-chip-disabled-leading-icon-opacity, 0.38);--_focus-leading-icon-color: var(--md-suggestion-chip-focus-leading-icon-color, var(--md-sys-color-primary, #6750a4));--_hover-leading-icon-color: var(--md-suggestion-chip-hover-leading-icon-color, var(--md-sys-color-primary, #6750a4));--_leading-icon-color: var(--md-suggestion-chip-leading-icon-color, var(--md-sys-color-primary, #6750a4));--_pressed-leading-icon-color: var(--md-suggestion-chip-pressed-leading-icon-color, var(--md-sys-color-primary, #6750a4));--_icon-size: var(--md-suggestion-chip-icon-size, 18px);--_container-shape-start-start: var(--md-suggestion-chip-container-shape-start-start, var(--md-suggestion-chip-container-shape, var(--md-sys-shape-corner-small, 8px)));--_container-shape-start-end: var(--md-suggestion-chip-container-shape-start-end, var(--md-suggestion-chip-container-shape, var(--md-sys-shape-corner-small, 8px)));--_container-shape-end-end: var(--md-suggestion-chip-container-shape-end-end, var(--md-suggestion-chip-container-shape, var(--md-sys-shape-corner-small, 8px)));--_container-shape-end-start: var(--md-suggestion-chip-container-shape-end-start, var(--md-suggestion-chip-container-shape, var(--md-sys-shape-corner-small, 8px)));--_leading-space: var(--md-suggestion-chip-leading-space, 16px);--_trailing-space: var(--md-suggestion-chip-trailing-space, 16px);--_icon-label-space: var(--md-suggestion-chip-icon-label-space, 8px);--_with-leading-icon-leading-space: var(--md-suggestion-chip-with-leading-icon-leading-space, 8px)}@media(forced-colors: active){.link .outline{border-color:ActiveText}}
`;/**
 * @license
 * Copyright 2023 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */let ic=class extends BD{};ic.styles=[pc,fc,LD];ic=k([Ve("md-suggestion-chip")],ic);/**
 * @license
 * Copyright 2023 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */class Ry extends Qy{constructor(){super(...arguments),this.buffer=0}renderIndicator(){const e={transform:`scaleX(${(this.indeterminate?1:this.value/this.max)*100}%)`},t=this.buffer??0,i=t>0,s={transform:`scaleX(${(this.indeterminate||!i?1:t/this.max)*100}%)`},o=this.indeterminate||!i||t>=this.max||this.value>=this.max;return X`
      <div class="dots" ?hidden=${o}></div>
      <div class="inactive-track" style=${Vi(s)}></div>
      <div class="bar primary-bar" style=${Vi(e)}>
        <div class="bar-inner"></div>
      </div>
      <div class="bar secondary-bar">
        <div class="bar-inner"></div>
      </div>
    `}}k([W({type:Number})],Ry.prototype,"buffer",void 0);/**
 * @license
 * Copyright 2024 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const UD=me`:host{--_active-indicator-color: var(--md-linear-progress-active-indicator-color, var(--md-sys-color-primary, #6750a4));--_active-indicator-height: var(--md-linear-progress-active-indicator-height, 4px);--_four-color-active-indicator-four-color: var(--md-linear-progress-four-color-active-indicator-four-color, var(--md-sys-color-tertiary-container, #ffd8e4));--_four-color-active-indicator-one-color: var(--md-linear-progress-four-color-active-indicator-one-color, var(--md-sys-color-primary, #6750a4));--_four-color-active-indicator-three-color: var(--md-linear-progress-four-color-active-indicator-three-color, var(--md-sys-color-tertiary, #7d5260));--_four-color-active-indicator-two-color: var(--md-linear-progress-four-color-active-indicator-two-color, var(--md-sys-color-primary-container, #eaddff));--_track-color: var(--md-linear-progress-track-color, var(--md-sys-color-surface-container-highest, #e6e0e9));--_track-height: var(--md-linear-progress-track-height, 4px);--_track-shape: var(--md-linear-progress-track-shape, var(--md-sys-shape-corner-none, 0px));border-radius:var(--_track-shape);display:flex;position:relative;min-width:80px;height:var(--_track-height);content-visibility:auto;contain:strict}.progress,.dots,.inactive-track,.bar,.bar-inner{position:absolute}.progress{direction:ltr;inset:0;border-radius:inherit;overflow:hidden;display:flex;align-items:center}.bar{animation:none;width:100%;height:var(--_active-indicator-height);transform-origin:left center;transition:transform 250ms cubic-bezier(0.4, 0, 0.6, 1)}.secondary-bar{display:none}.bar-inner{inset:0;animation:none;background:var(--_active-indicator-color)}.inactive-track{background:var(--_track-color);inset:0;transition:transform 250ms cubic-bezier(0.4, 0, 0.6, 1);transform-origin:left center}.dots{inset:0;animation:linear infinite 250ms;animation-name:buffering;background-color:var(--_track-color);background-repeat:repeat-x;-webkit-mask-image:url("data:image/svg+xml,%3Csvg version='1.1' xmlns='http://www.w3.org/2000/svg' viewBox='0 0 5 2' preserveAspectRatio='xMinYMin slice'%3E%3Ccircle cx='1' cy='1' r='1'/%3E%3C/svg%3E");mask-image:url("data:image/svg+xml,%3Csvg version='1.1' xmlns='http://www.w3.org/2000/svg' viewBox='0 0 5 2' preserveAspectRatio='xMinYMin slice'%3E%3Ccircle cx='1' cy='1' r='1'/%3E%3C/svg%3E");z-index:-1}.dots[hidden]{display:none}.indeterminate .bar{transition:none}.indeterminate .primary-bar{inset-inline-start:-145.167%}.indeterminate .secondary-bar{inset-inline-start:-54.8889%;display:block}.indeterminate .primary-bar{animation:linear infinite 2s;animation-name:primary-indeterminate-translate}.indeterminate .primary-bar>.bar-inner{animation:linear infinite 2s primary-indeterminate-scale}.indeterminate.four-color .primary-bar>.bar-inner{animation-name:primary-indeterminate-scale,four-color;animation-duration:2s,4s}.indeterminate .secondary-bar{animation:linear infinite 2s;animation-name:secondary-indeterminate-translate}.indeterminate .secondary-bar>.bar-inner{animation:linear infinite 2s secondary-indeterminate-scale}.indeterminate.four-color .secondary-bar>.bar-inner{animation-name:secondary-indeterminate-scale,four-color;animation-duration:2s,4s}:host(:dir(rtl)){transform:scale(-1)}@keyframes primary-indeterminate-scale{0%{transform:scaleX(0.08)}36.65%{animation-timing-function:cubic-bezier(0.334731, 0.12482, 0.785844, 1);transform:scaleX(0.08)}69.15%{animation-timing-function:cubic-bezier(0.06, 0.11, 0.6, 1);transform:scaleX(0.661479)}100%{transform:scaleX(0.08)}}@keyframes secondary-indeterminate-scale{0%{animation-timing-function:cubic-bezier(0.205028, 0.057051, 0.57661, 0.453971);transform:scaleX(0.08)}19.15%{animation-timing-function:cubic-bezier(0.152313, 0.196432, 0.648374, 1.00432);transform:scaleX(0.457104)}44.15%{animation-timing-function:cubic-bezier(0.257759, -0.003163, 0.211762, 1.38179);transform:scaleX(0.72796)}100%{transform:scaleX(0.08)}}@keyframes buffering{0%{transform:translateX(calc(var(--_track-height) / 2 * 5))}}@keyframes primary-indeterminate-translate{0%{transform:translateX(0px)}20%{animation-timing-function:cubic-bezier(0.5, 0, 0.701732, 0.495819);transform:translateX(0px)}59.15%{animation-timing-function:cubic-bezier(0.302435, 0.381352, 0.55, 0.956352);transform:translateX(83.6714%)}100%{transform:translateX(200.611%)}}@keyframes secondary-indeterminate-translate{0%{animation-timing-function:cubic-bezier(0.15, 0, 0.515058, 0.409685);transform:translateX(0px)}25%{animation-timing-function:cubic-bezier(0.31033, 0.284058, 0.8, 0.733712);transform:translateX(37.6519%)}48.35%{animation-timing-function:cubic-bezier(0.4, 0.627035, 0.6, 0.902026);transform:translateX(84.3862%)}100%{transform:translateX(160.278%)}}@keyframes four-color{0%{background:var(--_four-color-active-indicator-one-color)}15%{background:var(--_four-color-active-indicator-one-color)}25%{background:var(--_four-color-active-indicator-two-color)}40%{background:var(--_four-color-active-indicator-two-color)}50%{background:var(--_four-color-active-indicator-three-color)}65%{background:var(--_four-color-active-indicator-three-color)}75%{background:var(--_four-color-active-indicator-four-color)}90%{background:var(--_four-color-active-indicator-four-color)}100%{background:var(--_four-color-active-indicator-one-color)}}@media(forced-colors: active){:host{outline:1px solid CanvasText}.bar-inner,.dots{background-color:CanvasText}}
`;/**
 * @license
 * Copyright 2023 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */let rc=class extends Ry{};rc.styles=[UD];rc=k([Ve("md-linear-progress")],rc);/**
 * @license
 * Copyright 2024 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const $D=me`@layer{.md-typescale-display-small,.md-typescale-display-small-prominent{font:var(--md-sys-typescale-display-small-weight, var(--md-ref-typeface-weight-regular, 400)) var(--md-sys-typescale-display-small-size, 2.25rem)/var(--md-sys-typescale-display-small-line-height, 2.75rem) var(--md-sys-typescale-display-small-font, var(--md-ref-typeface-brand, Roboto))}.md-typescale-display-medium,.md-typescale-display-medium-prominent{font:var(--md-sys-typescale-display-medium-weight, var(--md-ref-typeface-weight-regular, 400)) var(--md-sys-typescale-display-medium-size, 2.8125rem)/var(--md-sys-typescale-display-medium-line-height, 3.25rem) var(--md-sys-typescale-display-medium-font, var(--md-ref-typeface-brand, Roboto))}.md-typescale-display-large,.md-typescale-display-large-prominent{font:var(--md-sys-typescale-display-large-weight, var(--md-ref-typeface-weight-regular, 400)) var(--md-sys-typescale-display-large-size, 3.5625rem)/var(--md-sys-typescale-display-large-line-height, 4rem) var(--md-sys-typescale-display-large-font, var(--md-ref-typeface-brand, Roboto))}.md-typescale-headline-small,.md-typescale-headline-small-prominent{font:var(--md-sys-typescale-headline-small-weight, var(--md-ref-typeface-weight-regular, 400)) var(--md-sys-typescale-headline-small-size, 1.5rem)/var(--md-sys-typescale-headline-small-line-height, 2rem) var(--md-sys-typescale-headline-small-font, var(--md-ref-typeface-brand, Roboto))}.md-typescale-headline-medium,.md-typescale-headline-medium-prominent{font:var(--md-sys-typescale-headline-medium-weight, var(--md-ref-typeface-weight-regular, 400)) var(--md-sys-typescale-headline-medium-size, 1.75rem)/var(--md-sys-typescale-headline-medium-line-height, 2.25rem) var(--md-sys-typescale-headline-medium-font, var(--md-ref-typeface-brand, Roboto))}.md-typescale-headline-large,.md-typescale-headline-large-prominent{font:var(--md-sys-typescale-headline-large-weight, var(--md-ref-typeface-weight-regular, 400)) var(--md-sys-typescale-headline-large-size, 2rem)/var(--md-sys-typescale-headline-large-line-height, 2.5rem) var(--md-sys-typescale-headline-large-font, var(--md-ref-typeface-brand, Roboto))}.md-typescale-title-small,.md-typescale-title-small-prominent{font:var(--md-sys-typescale-title-small-weight, var(--md-ref-typeface-weight-medium, 500)) var(--md-sys-typescale-title-small-size, 0.875rem)/var(--md-sys-typescale-title-small-line-height, 1.25rem) var(--md-sys-typescale-title-small-font, var(--md-ref-typeface-plain, Roboto))}.md-typescale-title-medium,.md-typescale-title-medium-prominent{font:var(--md-sys-typescale-title-medium-weight, var(--md-ref-typeface-weight-medium, 500)) var(--md-sys-typescale-title-medium-size, 1rem)/var(--md-sys-typescale-title-medium-line-height, 1.5rem) var(--md-sys-typescale-title-medium-font, var(--md-ref-typeface-plain, Roboto))}.md-typescale-title-large,.md-typescale-title-large-prominent{font:var(--md-sys-typescale-title-large-weight, var(--md-ref-typeface-weight-regular, 400)) var(--md-sys-typescale-title-large-size, 1.375rem)/var(--md-sys-typescale-title-large-line-height, 1.75rem) var(--md-sys-typescale-title-large-font, var(--md-ref-typeface-brand, Roboto))}.md-typescale-body-small,.md-typescale-body-small-prominent{font:var(--md-sys-typescale-body-small-weight, var(--md-ref-typeface-weight-regular, 400)) var(--md-sys-typescale-body-small-size, 0.75rem)/var(--md-sys-typescale-body-small-line-height, 1rem) var(--md-sys-typescale-body-small-font, var(--md-ref-typeface-plain, Roboto))}.md-typescale-body-medium,.md-typescale-body-medium-prominent{font:var(--md-sys-typescale-body-medium-weight, var(--md-ref-typeface-weight-regular, 400)) var(--md-sys-typescale-body-medium-size, 0.875rem)/var(--md-sys-typescale-body-medium-line-height, 1.25rem) var(--md-sys-typescale-body-medium-font, var(--md-ref-typeface-plain, Roboto))}.md-typescale-body-large,.md-typescale-body-large-prominent{font:var(--md-sys-typescale-body-large-weight, var(--md-ref-typeface-weight-regular, 400)) var(--md-sys-typescale-body-large-size, 1rem)/var(--md-sys-typescale-body-large-line-height, 1.5rem) var(--md-sys-typescale-body-large-font, var(--md-ref-typeface-plain, Roboto))}.md-typescale-label-small,.md-typescale-label-small-prominent{font:var(--md-sys-typescale-label-small-weight, var(--md-ref-typeface-weight-medium, 500)) var(--md-sys-typescale-label-small-size, 0.6875rem)/var(--md-sys-typescale-label-small-line-height, 1rem) var(--md-sys-typescale-label-small-font, var(--md-ref-typeface-plain, Roboto))}.md-typescale-label-medium,.md-typescale-label-medium-prominent{font:var(--md-sys-typescale-label-medium-weight, var(--md-ref-typeface-weight-medium, 500)) var(--md-sys-typescale-label-medium-size, 0.75rem)/var(--md-sys-typescale-label-medium-line-height, 1rem) var(--md-sys-typescale-label-medium-font, var(--md-ref-typeface-plain, Roboto))}.md-typescale-label-medium-prominent{font-weight:var(--md-sys-typescale-label-medium-weight-prominent, var(--md-ref-typeface-weight-bold, 700))}.md-typescale-label-large,.md-typescale-label-large-prominent{font:var(--md-sys-typescale-label-large-weight, var(--md-ref-typeface-weight-medium, 500)) var(--md-sys-typescale-label-large-size, 0.875rem)/var(--md-sys-typescale-label-large-line-height, 1.25rem) var(--md-sys-typescale-label-large-font, var(--md-ref-typeface-plain, Roboto))}.md-typescale-label-large-prominent{font-weight:var(--md-sys-typescale-label-large-weight-prominent, var(--md-ref-typeface-weight-bold, 700))}}
`;class zD{constructor(){this.addStyles()}show(e,t="info",i=5e3){const r=document.createElement("div");return r.className=`notification ${t}`,r.innerHTML=`
      <div class="notification-content">
        <i class="fa fa-${this.getIcon(t)}"></i>
        <span>${e}</span>
        <button class="notification-close">&times;</button>
      </div>
    `,r.querySelector(".notification-close").addEventListener("click",()=>this.remove(r)),document.body.appendChild(r),i>0&&setTimeout(()=>this.remove(r),i),r}remove(e){e&&e.parentNode&&(e.style.animation="slideOut 0.3s ease-in forwards",setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},300))}getIcon(e){const t={error:"exclamation-triangle",warning:"exclamation-circle",success:"check-circle",info:"info-circle"};return t[e]||t.info}addStyles(){if(document.getElementById("notification-styles"))return;const e=document.createElement("style");e.id="notification-styles",e.textContent=`
      .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        background: white;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        border-radius: 4px;
        z-index: 10000;
        animation: slideIn 0.3s ease-out;
        max-width: 300px;
      }

      .notification.error { border-left: 4px solid #e53935; }
      .notification.warning { border-left: 4px solid #ff9800; }
      .notification.success { border-left: 4px solid #4caf50; }
      .notification.info { border-left: 4px solid #2196f3; }

      .notification-content {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .notification-content i {
        color: #666;
        flex-shrink: 0;
      }

      .notification-close {
        background: none;
        border: none;
        font-size: 18px;
        cursor: pointer;
        color: #999;
        margin-left: auto;
        padding: 0;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .notification-close:hover {
        color: #333;
      }

      @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }

      @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
      }
    `,document.head.appendChild(e)}}const wt=new zD;async function VD(n,e){console.log("[EventHandler] Start button clicked");const{playing:t}=M.getState();t?n.stop():await n.play(),typeof e=="function"&&e(t)}function WD(n){const{setAnimationSpeed:e}=M.getState(),t=parseFloat(n.target.value);if(!isNaN(t)&&t>=.1&&t<=5){e(t);const i=document.querySelector(".speed-value");i&&(i.textContent=`${t.toFixed(1)}Ã—`)}}async function HD(){const{showMSAViewer:n}=await is(()=>import("./index-97936cc6.js"),["assets/index-97936cc6.js","assets/dataService-18a31086.js","assets/dataService-1f0e10ab.css"]),{phyloData:e}=await is(()=>import("./dataService-18a31086.js").then(i=>i.L),["assets/dataService-18a31086.js","assets/dataService-1f0e10ab.css"]),t=await e.get();if(!t||!t.msa||!t.msa.sequences){console.warn("[EventHandler] No MSA data available"),wt.show("No alignment data available. Please upload an MSA file.","warning");return}n(t),console.log("[EventHandler] MSA viewer window opened with data")}async function jD(){const{toggleCameraMode:n,treeController:e}=M.getState(),t=n(),i=document.getElementById("camera-mode-text");i&&(i.textContent=t==="orthographic"?"2D View":"3D View"),e.setCameraMode(t)}async function XD(){const n=document.getElementById("trails-toggle"),e=!!(n!=null&&n.selected),t=document.getElementById("trail-length"),i=document.getElementById("trail-opacity"),r=document.getElementById("trail-thickness");t&&(t.disabled=!e),i&&(i.disabled=!e),r&&(r.disabled=!e);const{setTrailsEnabled:s,treeController:o}=M.getState();s(e),await o.renderAllElements()}async function YD(n){var s;const e=parseInt((s=n==null?void 0:n.target)==null?void 0:s.value,10)||12,t=document.getElementById("trail-length-value");t&&(t.textContent=String(e));const{setTrailLength:i,treeController:r}=M.getState();i(e),await r.renderAllElements()}async function qD(n){var s;const e=parseFloat((s=n==null?void 0:n.target)==null?void 0:s.value),t=document.getElementById("trail-opacity-value");t&&(t.textContent=String(e));const{setTrailOpacity:i,treeController:r}=M.getState();i(e),await r.renderAllElements()}async function KD(n){var s;const e=parseFloat((s=n==null?void 0:n.target)==null?void 0:s.value),t=document.getElementById("trail-thickness-value");t&&(t.textContent=String(e));const{setTrailThickness:i,treeController:r}=M.getState();i(e),await r.renderAllElements()}async function Py(n,e,t){const{id:i,event:r,type:s=t.type,action:o,fallbackCreation:a,description:l}=e;try{let c=null;const u=s==="window"||i==="window";if(i&&!u?(c=document.getElementById(i),!c&&a&&(c=a())):u&&(c=window),c){const d=r||s||"click",h=async f=>{try{const p=o(f);p&&typeof p.then=="function"&&await p}catch(p){n.handleError(p,t,e)}};return c.addEventListener(d,h),n.attachedHandlers.push({elementId:i||"window",element:c,type:d,handler:h,description:l||`Handler for ${i||"window"} on ${d}`}),!0}else return!1}catch(c){return n.handleError(c,t,e),!1}}async function My(n,e){const t=await Promise.allSettled(e.handlers.map(s=>Py(n,s,e))),i=t.filter(s=>s.status==="fulfilled"&&s.value).length,r=e.handlers.length;return{successful:i,total:r,results:t}}async function ZD(n){const e=n.getEventHandlerConfigs(),t={totalGroups:0,successfulGroups:0,totalHandlers:0,successfulHandlers:0};for(const[,i]of Object.entries(e)){t.totalGroups++;const r=await My(n,i);t.totalHandlers+=r.total,t.successfulHandlers+=r.successful,r.successful===r.total&&t.successfulGroups++}return t}function GD(n){n.attachedHandlers.forEach(e=>{try{e.element.removeEventListener(e.type,e.handler)}catch(t){console.error(`Error detaching handler ${e.description}:`,t)}}),n.attachedHandlers=[]}function QD(){const n=document.getElementById("navigation-drawer"),e=document.querySelector(".movie-player-bar"),t=document.querySelector(".container"),i=document.getElementById("nav-toggle-button"),r=i==null?void 0:i.querySelector("md-icon"),s=document.querySelector(".phylo-hud");n&&e&&t&&(n.style.transform==="translateX(-100%)"?(n.style.transform="translateX(0)",e.classList.remove("nav-hidden"),t.style.marginLeft="var(--navigation-drawer-width)",r&&(r.textContent="menu_open"),s&&s.classList.add("nav-visible")):(n.style.transform="translateX(-100%)",e.classList.add("nav-hidden"),t.style.marginLeft="0",r&&(r.textContent="menu"),s&&s.classList.remove("nav-visible")))}function JD(n,e,t,i){const r=`Error in ${i.description}: ${e.message}`;switch(t.errorHandling){case"notify":console.error(r,e),wt.show(r,"error");break;case"log":console.error(r,e);break;case"silent":break;default:console.error(r,e)}}async function eB(){const{setDimmingEnabled:n,treeController:e}=M.getState(),t=document.getElementById("dim-non-descendants-toggle");if(t){const i=t.selected;n(i)}else console.error("[EventHandler] Could not find #dim-non-descendants-toggle");await e.renderAllElements()}async function tB(n){const{setBranchTransformation:e,treeController:t,treeList:i,currentTreeIndex:r}=M.getState(),s=n.target.value;e(s),t.updateLayout(i[r]),await t.renderAllElements()}async function nB(){const{setMonophyleticColoring:n,treeController:e}=M.getState(),t=document.getElementById("monophyletic-coloring"),i=t?t.selected:!1;n(i),await e.renderAllElements()}async function iB(n){const{setStrokeWidth:e,treeController:t}=M.getState();e(n.target.value),document.getElementById("stroke-width-value").textContent=n.target.value,await t.renderAllElements()}async function rB(n){const{setFontSize:e,treeController:t}=M.getState();e(n.target.value),document.getElementById("font-size-value").textContent=n.target.value+"em"}async function sB(){const n=document.getElementById("marked-components-toggle");if(n){const e=n.selected,{setMarkedComponentsEnabled:t,treeController:i}=M.getState();t(e),await i.renderAllElements()}}async function oB(){const n=document.getElementById("active-change-edges-toggle");if(n){const e=n.selected,{setActiveChangeEdgesEnabled:t,treeController:i}=M.getState();t(e),await i.renderAllElements()}}async function aB(n,e){var r,s;const t=((r=n==null?void 0:n.target)==null?void 0:r.selected)??!0,{setSyncMSAEnabled:i}=M.getState();if(i(t),t)try{e.syncMSAIfOpen(),(s=e.movieTimelineManager)==null||s.updateCurrentPosition();const{transitionResolver:o,msaWindowSize:a,msaStepSize:l,msaColumnCount:c}=M.getState();if(o&&c>0){const u=Ii();if(u>=0){const{startPosition:d,endPosition:h}=ys(u,l,a,c);is(()=>import("./index-97936cc6.js"),["assets/index-97936cc6.js","assets/dataService-18a31086.js","assets/dataService-1f0e10ab.css"]).then(({setMSARegion:f})=>{f(d,h)}).catch(()=>{})}}wt.show("MSA sync enabled and updated","success")}catch{wt.show("MSA sync enabled","info")}else wt.show("MSA sync disabled","info")}class lB{constructor(e){this.gui=e,this.attachedHandlers=[],this.recorder=null}getEventHandlerConfigs(){return{basicButtons:{type:"click",errorHandling:"log",async:!0,handlers:[{id:"play-button",action:async()=>{await VD(this.gui,this.updatePlayButton.bind(this))},description:"Toggle play/pause"},{id:"forward-button",action:async()=>{const{forward:e}=M.getState();e()},description:"Step forward"},{id:"backward-button",action:async()=>{const{backward:e}=M.getState();e()},description:"Step backward"},{id:"save-button",action:()=>this.gui.saveImage(),description:"Save Image"},{id:"forwardStepButton",action:async()=>{const{currentTreeIndex:e,movieData:t,goToPosition:i}=M.getState();e<t.interpolated_trees.length-1&&i(e+1)},description:"Next tree"},{id:"backwardStepButton",action:async()=>{const{currentTreeIndex:e,goToPosition:t}=M.getState();e>0&&t(e-1)},description:"Previous tree"},{id:"nav-toggle-button",action:()=>QD(),description:"Toggle navigation panel visibility"}]},navigationControls:{type:"mixed",errorHandling:"notify",async:!0,handlers:[{id:"animation-speed-range",type:"input",action:e=>WD(e),description:"Animation speed change (range input)"}]},appearanceControls:{type:"mixed",errorHandling:"log",async:!0,handlers:[{id:"branch-length-options",type:"change",action:async e=>await tB(e),description:"Branch length options selector"},{id:"font-size",type:"input",action:async e=>{M.getState(),await rB(e)},description:"Font size adjustment - optimized"},{id:"stroke-width",type:"input",action:async e=>await iB(e),description:"Stroke width adjustment"},{id:"monophyletic-coloring",type:"change",action:async()=>await nB(),description:"Monophyletic group coloring toggle"},{id:"camera-mode-button",type:"click",action:async()=>await jD(),description:"Toggle camera mode between orthographic and orbit"},{id:"active-change-edges-toggle",type:"change",action:async()=>await oB(),description:"Toggle active change edges highlighting"},{id:"active-change-edges-color",type:"input",action:async e=>{const{setActiveChangeEdgeColor:t}=M.getState(),i=e.target.value;t(i)},description:"Active change edges highlighting color picker"},{id:"marked-components-toggle",type:"change",action:async()=>await sB(),description:"Toggle subtrees highlighting"},{id:"marked-color",type:"input",action:async e=>{const{setMarkedColor:t}=M.getState(),i=e.target.value;t(i)},description:"Subtrees highlighting color picker"},{id:"dimmed-color",type:"input",action:async e=>{const{setDimmedColor:t}=M.getState(),i=e.target.value;t(i)},description:"Dimmed elements color picker"},{id:"dim-non-descendants-toggle",type:"change",action:async()=>await eB(),description:"Toggle dimming for non-descendant elements"},{id:"trails-toggle",type:"change",action:async()=>await XD(),description:"Toggle motion trails"},{id:"trail-length",type:"input",action:async e=>await YD(e),description:"Adjust trail length"},{id:"trail-opacity",type:"input",action:async e=>await qD(e),description:"Adjust trail opacity"},{id:"trail-thickness",type:"input",action:async e=>await KD(e),description:"Adjust trail thickness"}]},recordingControls:{type:"click",errorHandling:"notify",async:!0,handlers:[{id:"start-record",action:async()=>await this.handleStartRecording(),description:"Start screen recording"},{id:"stop-record",action:()=>this.handleStopRecording(),description:"Stop screen recording"}]},modalControls:{type:"click",errorHandling:"notify",async:!0,handlers:[{id:"chart-modal",action:()=>{const{stop:e}=M.getState();e(),this.gui.displayCurrentChartInModal()},description:"Open chart modal"},{id:"compare-sequence-button",action:async()=>await this.gui.openComparisonModal(),description:"Open tree comparison"},{id:"taxa-coloring-button",action:()=>this.gui.openTaxaColoringWindow(),description:"Open taxa coloring"},{id:"open-scatter-plot",action:async()=>await this.gui.openScatterplotModal(),description:"Open scatter plot visualization"},{id:"msa-viewer-btn",action:async()=>await HD(),description:"Open MSA viewer window"}]},buttonsToggles:{type:"change",errorHandling:"notify",async:!0,handlers:[{id:"enable-msa-sync-btn",action:async e=>await aB(e,this.gui),description:"Toggle MSA window synchronization"}]}}}handleError(e,t,i){return JD(this,e,t,i)}async attachSingleHandler(e,t){return Py(this,e,t)}async attachHandlerGroup(e){return My(this,e)}async attachAll(){return ZD(this)}detachAll(){return GD(this)}setRecorder(e){this.recorder=e}async handleStartRecording(){if(!this.recorder){console.error("No recorder instance available"),wt.show("Recording not available","error");return}if(this.recorder.isRecording){console.warn("Already recording");return}try{await this.recorder.start()}catch(e){console.error("Failed to start recording:",e),wt.show("Failed to start recording. Please check your permissions.","error")}}handleStopRecording(){if(console.log("[EventHandler] Stop recording button clicked"),!this.recorder){console.error("No recorder instance available");return}if(!this.recorder.isRecording){console.warn("Not currently recording");return}this.recorder.stop()}updatePlayButton(e){const t=document.getElementById("play-button");t&&(t.selected=e,t.setAttribute("title",e?"Pause animation":"Play animation"),t.setAttribute("aria-label",e?"Pause animation":"Play/Pause animation"))}}let on=null;async function cB(n){if(!n){console.error("GUI instance is required for event handlers");return}try{on&&typeof on.detachAll=="function"&&on.detachAll(),on=new lB(n),await on.attachAll()}catch(e){console.error("Error attaching GUI event handlers:",e),wt.show("Error setting up interface controls: "+e.message,"error")}}function uB(n){if(!n){console.error("Recorder instance is required for event handlers");return}try{on?(on.setRecorder(n),console.log("Recorder instance set on EventHandlerRegistry successfully")):console.warn("EventHandlerRegistry not initialized yet. Recording buttons may not work.")}catch(e){console.error("Error setting up recorder:",e),wt.show("Error setting up recording controls: "+e.message,"error")}}function Ia(n){const e=document.getElementById("aria-partial-status");e&&(e.textContent=n)}async function dB({url:n,containerId:e,callback:t,errorCallback:i}){const r=document.getElementById(e);if(!r){const s=new Error(`Container not found: ${e}`);return console.error(s.message),setTimeout(()=>{i&&i(s)},0),Ia(`Failed to load content: ${e}`),!1}try{const s=await fetch(n,{method:"GET",headers:{Accept:"text/html"},cache:"no-cache"});if(!s.ok)throw new Error(`HTTP ${s.status}: ${s.statusText}`);const o=await s.text();return r.innerHTML=o,console.log(`âœ… Loaded partial: ${n}`),setTimeout(()=>{t&&t()},0),Ia(`Loaded content: ${e}`),!0}catch(s){return console.error(`âŒ Failed to load partial ${n}:`,s),r.innerHTML=`<!-- Failed to load ${e} -->`,setTimeout(()=>{i&&i(s)},0),Ia(`Failed to load content: ${e}`),!1}}async function hB(n){if(!Array.isArray(n)||n.length===0)return console.warn("No partials to load"),!0;console.log(`Loading ${n.length} partials...`);const e=await Promise.allSettled(n.map(r=>dB(r))),t=e.filter(r=>r.status==="fulfilled"&&r.value===!0).length,i=e.length-t;return console.log(`Partials loaded: ${t}/${e.length} successful`),i>0&&console.warn(`${i} partials failed to load`),!0}class fB{constructor({autoSave:e=!1,filename:t=null,notifications:i=null}={}){this.mediaRecorder=null,this.recordedChunks=[],this.autoSave=e,this.filename=t,this.isRecording=!1,this.notifications=i}async start(){try{const e=await navigator.mediaDevices.getDisplayMedia({audio:!0,video:{mediaSource:"screen"}});this.recordedChunks=[],this.mediaRecorder=new MediaRecorder(e),this.mediaRecorder.ondataavailable=t=>{t.data.size>0&&this.recordedChunks.push(t.data)},this.mediaRecorder.onstop=()=>{this.isRecording=!1,this.onRecordingStop()},this.mediaRecorder.onerror=t=>{this.isRecording=!1,this.onRecordingError(t.error||t)},this.mediaRecorder.start(200),this.isRecording=!0,this.onRecordingStart()}catch(e){this.isRecording=!1,this.onRecordingError(e)}}stop(){this.mediaRecorder&&this.mediaRecorder.state!=="inactive"&&(this.mediaRecorder.stop(),this.autoSave&&setTimeout(()=>{this.performAutoSave(this.filename)},100))}getBlob(){return new Blob(this.recordedChunks,{type:"video/webm"})}createDownloadLink(){const e=this.getBlob(),t=window.prompt("Enter file name")||"recording",i=document.createElement("a");return i.href=URL.createObjectURL(e),i.download=`${t}.webm`,i.textContent=`Download ${t}.webm`,i.style.display="block",i}performAutoSave(e=null){const t=this.getBlob(),i=`phylo-movie-recording-${new Date().toISOString().slice(0,19).replace(/:/g,"-")}`,r=e||i,s=document.createElement("a");return s.href=URL.createObjectURL(t),s.download=`${r}.webm`,document.body.appendChild(s),s.click(),document.body.removeChild(s),setTimeout(()=>{URL.revokeObjectURL(s.href)},1e3),r}autoSave(e=null){return this.performAutoSave(e)}updateStartButton(e,t,i){const r=document.getElementById("start-record");r&&(r.disabled=e,t&&(r.textContent=t),i?r.style.backgroundColor=i:r.style.backgroundColor="")}updateStopButton(e,t){const i=document.getElementById("stop-record");i&&(i.disabled=e,t?i.style.backgroundColor=t:i.style.backgroundColor="")}onRecordingStart(){this.updateStartButton(!0,"Recording...","#e14390"),this.updateStopButton(!1,"#ff4444"),console.log("Recording started")}onRecordingStop(){this.updateStartButton(!1,"Start Recording",""),this.updateStopButton(!0,""),console.log("Recording stopped"),this.autoSave||this.promptManualSave()}onRecordingError(e){this.updateStartButton(!1,"Start Recording",""),this.updateStopButton(!0,""),console.error("Recording error:",e),this.notifications&&this.notifications.show(`Recording error: ${e.message||e}`,"error")}promptManualSave(){if(confirm("Recording complete! Would you like to save it now?"))try{const t=this.performAutoSave(this.filename);console.log(`Recording saved as: ${t}.webm`),this.notifications&&this.notifications.show(`Recording saved as: ${t}.webm`,"success")}catch(t){console.error("Failed to save recording:",t),this.notifications&&this.notifications.show("Failed to save recording. Please try again.","error")}}}async function pB(){return await rs.get()}const ky="app-theme-preference";function Oy(n){const e=document.documentElement;n==="light"?e.setAttribute("data-theme","light"):n==="dark"?e.setAttribute("data-theme","dark"):e.removeAttribute("data-theme");try{M.getState().applyThemeColors(n)}catch{}Ny(n)}function sc(){const n=localStorage.getItem(ky);return n==="light"||n==="dark"||n==="system"?n:"system"}function gB(n){localStorage.setItem(ky,n)}function mB(n){return n==="system"?"dark":n==="dark"?"light":"system"}function Ny(n){const e=document.getElementById("theme-toggle-icon");e&&(e.textContent=n==="dark"?"dark_mode":n==="light"?"light_mode":"computer")}function Gf(){const n=document.getElementById("theme-toggle");n&&n.addEventListener("click",()=>{const e=sc(),t=mB(e);gB(t),Oy(t)}),requestAnimationFrame(()=>Ny(sc()))}function _B(){const n=sc();Oy(n),document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Gf):Gf()}let Qf=!1;_B();async function yB(n=!0){try{document.adoptedStyleSheets.push($D.styleSheet);const e=[{url:"/src/partials/buttons-file-ops.html",containerId:"buttons-file-container"},{url:"/src/partials/appearance.html",containerId:"appearance-container"},{url:"/src/partials/top_scale_bar.html",containerId:"top-scale-bar-container"},{url:"/src/partials/movie-player-bar.html",containerId:"movie-player-container"}];n&&e.splice(1,0,{url:"/src/partials/buttons-msa.html",containerId:"buttons-msa-container"}),await hB(e);const i=["play-button","forward-button","backward-button","save-button","forwardStepButton","backwardStepButton","compare-sequence-button","chart-modal","taxa-coloring-button","animation-speed-range","branch-length-options","font-size","stroke-width","barPlotOption","lineChart"].filter(r=>!document.getElementById(r));return i.length>0?(console.warn(`[phylo-movies] Critical UI elements are missing after attempting to load partials.
        The application may not function correctly. Missing elements: ${i.join(", ")}.
        Please check the HTML partial files and their container IDs.`,i),!1):!0}catch(e){return console.error("[phylo-movies] Failed to load partials:",e),!1}}function Jf(){try{const n=document.querySelector(".movie-player-bar");if(!n)return;const e=n.getBoundingClientRect(),t=Math.max(64,Math.round(e.height));document.documentElement.style.setProperty("--movie-player-bar-height",`${t}px`)}catch(n){console.warn("[layout] Failed to update --movie-player-bar-height:",n)}}async function bB(n){try{console.log("[Main] parsedData has window_size:",n==null?void 0:n.window_size,"window_step_size:",n==null?void 0:n.window_step_size);const e=await rs.get();console.log("[Main] movieData from phyloData.get() has window_size:",e==null?void 0:e.window_size,"window_step_size:",e==null?void 0:e.window_step_size);const t=e||n;console.log("[Main] dataToUse has window_size:",t==null?void 0:t.window_size,"window_step_size:",t==null?void 0:t.window_step_size);const i=document.getElementById("webgl-container");i&&(i.style.display="block");const r=cD;console.log("[Main] Using TreeController:","DeckGLTreeAnimationController");const s=new K4(t,{TreeController:r});M.getState().setGui(s);const o=new fB({notifications:wt,autoSave:!1}),a=Z4(async()=>{s.resize(),await s.update()},200);window.addEventListener("resize",a),Qf||(await cB(s),uB(o),Qf=!0,s.initializeMovie())}catch(e){throw console.error("[initializeGuiAndEvents] Error:",e),alert(`Error creating visualization or attaching events: ${e.message}`),e}}async function ep(n){var e;try{const t=!!(n!=null&&n.msa&&n.msa.sequences&&Object.keys(n.msa.sequences).length>0);try{document.documentElement.setAttribute("data-has-msa",t?"true":"false")}catch{}if(!await yB(t)){alert("Error: Failed to load essential interface components. Please refresh the page or check the console.");return}try{if(!t){const r=document.getElementById("msa-controls");if(r){r.hidden=!0;const a=r.previousElementSibling;a&&((e=a.classList)!=null&&e.contains("msa-header"))&&(a.hidden=!0)}const s=document.getElementById("msa-status-chips");s&&(s.hidden=!0);const o=document.getElementById("msa-window-chip");o&&(o.hidden=!0)}}catch{}await bB(n),Jf(),window.addEventListener("resize",Jf)}catch(t){console.error("[initializeAppFromParsedData] Error:",t),alert(`Critical application initialization error: ${t.message}. Please try refreshing the page.`)}}(async()=>{try{const n=await pB();if(!n)try{let t=null;const r=[`${typeof import.meta<"u"&&{BASE_URL:"/phylo-movies/",MODE:"production",DEV:!1,PROD:!0,SSR:!1}?"/phylo-movies/":"/"}example.json`,"/example.json","example.json"];for(const o of r)try{const a=await fetch(o);if(a.ok){t=await a.json();break}}catch{}if(!t)throw new Error("Example data not available");t.file_name||(t.file_name="example.json"),await rs.set(t);const s=document.getElementById("compactFileName");s&&(s.textContent=t.file_name),await ep(t);return}catch(t){console.error("[phylo-movies] Failed to load example data fallback:",t),alert(`Error: No visualization data found and example could not be loaded.

Redirecting to the upload form.`);{const i=typeof import.meta<"u"&&{BASE_URL:"/phylo-movies/",MODE:"production",DEV:!1,PROD:!0,SSR:!1}?"/phylo-movies/":"/";window.location.href=`${i}index.html`}return}const e=document.getElementById("compactFileName");e&&(e.textContent=n.file_name||"Unknown File"),await ep(n)}catch(n){console.error("[phylo-movies] Critical error during page load and data initialization:",n),alert(`Error during application startup: ${n.message}

Attempting to redirect to the upload form.`);try{await rs.remove()}catch(e){console.error("[phylo-movies] Failed to remove phyloMovieData:",e)}{const e=typeof import.meta<"u"&&{BASE_URL:"/phylo-movies/",MODE:"production",DEV:!1,PROD:!0,SSR:!1}?"/phylo-movies/":"/";window.location.href=`${e}index.html`}}})();export{Z as C,T_ as D,Co as G,ur as L,Qt as M,V_ as O,Ei as P,gN as T,kB as a,To as b,zN as c,sN as d,Q as e,Ro as f,I4 as g,L as l,wo as p};
