name: Build & Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            platform: darwin
            build_target: mac
          - os: macos-14
            platform: darwin-x64
            build_target: mac
          - os: windows-latest
            platform: win32
            build_target: win
          - os: ubuntu-latest
            platform: linux
            build_target: linux
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: 1.7.1
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Cache Poetry dependencies
        uses: actions/cache@v4
        with:
          path: |
            engine/BranchArchitect/.venv
            ~/.cache/pypoetry
          key: ${{ runner.os }}-poetry-${{ hashFiles('engine/BranchArchitect/poetry.lock') }}
          restore-keys: |
            ${{ runner.os }}-poetry-

      - name: Install C compiler (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: sudo apt-get update && sudo apt-get install -y build-essential

      - name: Build FastTree from source
        shell: bash
        run: |
          cd engine/BranchArchitect
          chmod +x scripts/build_fasttree.sh
          ./scripts/build_fasttree.sh build
          ./scripts/build_fasttree.sh --check

      - name: Install Root Dependencies
        run: npm ci

      - name: Install Electron App Dependencies
        run: |
          cd electron-app
          npm ci

      - name: Install Python Backend Dependencies
        shell: bash
        run: |
          cd engine/BranchArchitect
          poetry install --with build

      - name: Build and Publish
        shell: bash
        run: |
          cd electron-app
          bash build.sh ${{ matrix.build_target }} -p always
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # macOS: ad-hoc signing is configured via identity:"-" in package.json.
          # Users will see "unidentified developer" (with "Open Anyway") instead of "damaged".
          # To eliminate the warning entirely, add these secrets:
          #   CSC_LINK, CSC_KEY_PASSWORD, APPLE_ID, APPLE_APP_SPECIFIC_PASSWORD, APPLE_TEAM_ID
          # and change mac.identity in electron-app/package.json from "-" to null.

