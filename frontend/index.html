<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Phylo-Movies</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css?family=Heebo"
    />
    
    <!-- Custom CSS -->
    <link rel="stylesheet" type="text/css" href="/css/index.css" />
    <!-- Only load specific modules needed for the landing page -->
    
    <!-- Bootstrap JS Bundle (optional, for modal/popover support) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js"></script>
  </head>

  <body class="light-mode">
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <div class="container-fluid">
        <a class="navbar-brand" href="/">Phylo-Movies</a>
      </div>
    </nav>
    <div class="container">
      <div class="card-container">
        <h1 class="mb-4 text-center">
          Phylo-Movies <i class="fa fa-film"></i>
        </h1>
        <div id="form-alert" class="alert d-none" role="alert"></div>
        <form id="phylo-form" enctype="multipart/form-data">
          <div class="mb-3">
            <label for="trees" class="form-label">Tree File</label>
            <input
              id="trees"
              type="file"
              class="filepond form-control"
              required
            />
          </div>
          <div class="mb-3">
            <label for="order" class="form-label">Order File</label>
            <input
              type="file"
              class="filepond form-control"
              id="order"
            />
          </div>
          
          <!-- Add MSA file upload field -->
          <div class="mb-3">
            <label for="msa" class="form-label">Multiple Sequence Alignment (Optional)</label>
            <input
              type="file"
              class="filepond form-control"
              id="msa"
              accept=".fas,.fasta,.aln,.clustal,.msa,.phylip,.phy"
            />
            <div class="form-text text-light">
              Supported formats: FASTA, CLUSTAL, PHYLIP
            </div>
          </div>
          
          <div class="mb-3">
            <label for="windowSize" class="form-label">Window Size</label>
            <input
              type="number"
              class="form-control"
              id="windowSize"
              name="windowSize"
              placeholder="1"
              value="1"
            />
          </div>
          <div class="mb-3">
            <label for="window-step-size" class="form-label"
              >Window Step Size</label
            >
            <input
              type="number"
              class="form-control"
              id="window-step-size"
              name="windowStepSize"
              placeholder="1"
              value="1"
            />
          </div>
          <div class="form-check form-switch mb-3">
            <input
              class="form-check-input"
              type="checkbox"
              id="midpointRooting"
              name="midpointRooting"
            />
            <label class="form-check-label" for="midpointRooting"
              >Enable Midpoint Rooting</label
            >
          </div>
          <div class="text-center">
            <button type="submit" class="btn btn-primary btn-lg">
              <i class="fa fa-play"></i> Play
            </button>
          </div>
        </form>
      </div>
    </div>

    <script type="module">
      import 'filepond/dist/filepond.css';
      import * as FilePond from 'filepond';

      // FilePond setup
      const treesInput = document.getElementById("trees");
      const orderInput = document.getElementById("order");
      const msaInput = document.getElementById("msa");
      const treesPond = FilePond.create(treesInput, { allowMultiple: false });
      const orderPond = FilePond.create(orderInput, { allowMultiple: false });
      const msaPond = FilePond.create(msaInput, { allowMultiple: false });

      // Prevent double submission
      let isSubmitting = false;

      // Helper to show feedback in the alert div
      function showFormAlert(message, type = 'danger') {
        const alertDiv = document.getElementById('form-alert');
        alertDiv.textContent = message;
        alertDiv.className = `alert alert-${type}`;
        alertDiv.classList.remove('d-none');
      }
      function hideFormAlert() {
        const alertDiv = document.getElementById('form-alert');
        alertDiv.textContent = '';
        alertDiv.className = 'alert d-none';
      }

      document.getElementById("phylo-form").addEventListener("submit", async function (e) {
        e.preventDefault();
        hideFormAlert();
        if (isSubmitting) return;
        isSubmitting = true;
        const submitButton = this.querySelector("button[type='submit']");
        if (submitButton) submitButton.disabled = true;

        // Show loading overlay
        let overlay = document.getElementById("loading-overlay");
        if (!overlay) {
          overlay = document.createElement("div");
          overlay.id = "loading-overlay";
          overlay.innerHTML = '<div class="loading-spinner"></div><div class="loading-message">Loading, please wait...</div>';
          document.body.appendChild(overlay);
        }
        overlay.style.display = "flex";

        const treeFiles = treesPond.getFiles();
        if (treeFiles.length === 0) {
          showFormAlert("Please select a tree file.", 'danger');
          isSubmitting = false;
          if (submitButton) submitButton.disabled = false;
          overlay.style.display = "none";
          return;
        }
        const formData = new FormData();
        formData.append("treeFile", treeFiles[0].file);

        const orderFiles = orderPond.getFiles();
        if (orderFiles.length > 0) {
          formData.append("orderFile", orderFiles[0].file);
        }
        
        // Add MSA file if provided
        const msaFiles = msaPond.getFiles();
        if (msaFiles.length > 0) {
          formData.append("msaFile", msaFiles[0].file);
        }

        formData.append("windowSize", document.getElementById("windowSize").value);
        formData.append("windowStepSize", document.getElementById("window-step-size").value);
        formData.append("midpointRooting", document.getElementById("midpointRooting").checked ? "on" : "");

        try {
          const response = await fetch("/treedata", {
            method: "POST",
            body: formData,
          });
          if (!response.ok) {
            let errorMsg = "Upload failed!";
            try {
              const errorData = await response.json();
              if (errorData && errorData.error) {
                errorMsg = errorData.error;
              }
            } catch (e) {
              try {
                errorMsg = await response.text();
              } catch {}
            }
            showFormAlert(errorMsg, 'danger');
            isSubmitting = false;
            if (submitButton) submitButton.disabled = false;
            overlay.style.display = "none";
            return;
          }
          const data = await response.json();
          localStorage.setItem("phyloMovieData", JSON.stringify(data));
          
          // Handle MSA data saving and notification (like in fetch.js)
          const msaFiles = msaPond.getFiles();
          if (msaFiles.length > 0) {
            try {
              const msaFile = msaFiles[0].file;
              const msaText = await msaFile.text();
              
              // Import parseMSA function dynamically
              const { parseMSA } = await import('./js/msaViewer/parsers.js');
              const msaData = parseMSA(msaText);
              
              if (msaData) {
                localStorage.setItem("phyloMovieMSAData", JSON.stringify(msaData));
                console.log("[index.html] MSA data saved to localStorage");
                
                // Dispatch custom event to notify MSA viewer of data update
                window.dispatchEvent(new CustomEvent('msa-data-updated'));
              }
            } catch (msaErr) {
              console.error("[index.html] Error parsing MSA file:", msaErr);
              // Continue with tree data even if MSA parsing fails
            }
          } else if (data.msa_id) {
            // If no file uploaded but backend has MSA data, fetch it
            try {
              const msaResponse = await fetch(`/msa?msa_id=${data.msa_id}`);
              if (msaResponse.ok) {
                const msaRaw = await msaResponse.json();
                const { parseMSA } = await import('./js/msaViewer/parsers.js');
                const msaData = parseMSA(msaRaw.content);
                if (msaData) {
                  localStorage.setItem("phyloMovieMSAData", JSON.stringify(msaData));
                  console.log("[index.html] MSA data fetched and saved to localStorage");
                  window.dispatchEvent(new CustomEvent('msa-data-updated'));
                }
              }
            } catch (fetchErr) {
              console.error("[index.html] Error fetching MSA data:", fetchErr);
            }
          }
          
          window.location.href = "/vis.html";
        } catch (err) {
          showFormAlert("Network error: " + err, 'danger');
          isSubmitting = false;
          if (submitButton) submitButton.disabled = false;
          overlay.style.display = "none";
        }
      });
    </script>
  </body>
</html>